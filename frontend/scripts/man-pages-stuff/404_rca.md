# Root Cause Analysis: Man Pages 404 Errors

## Summary
Eight URLs are returning 404 errors when accessing man pages subcategory pages. The root cause is that these URLs are accessing subcategory-level pages that either don't exist in the database or have zero man pages associated with them.

## Affected URLs

1. `/freedevtools/man-pages/games/wolfenstein/` - 404
2. `/freedevtools/man-pages/games/beating/` - 404
3. `/freedevtools/man-pages/library-functions/aléatoire/` - 404
4. `/freedevtools/man-pages/kernel-routines/semiconductor/` - 404
5. `/freedevtools/man-pages/games/mj/` - 404
6. `/freedevtools/man-pages/library-functions/staleness/` - 404
7. `/freedevtools/man-pages/kernel-routines/deadband/` - 404
8. `/freedevtools/man-pages/kernel-routines/subordinate/` - 404

## URL Structure Analysis

The routing system expects URLs in the format:
- `/man-pages/{category}/` - Category listing page
- `/man-pages/{category}/{subcategory}/` - Subcategory listing page
- `/man-pages/{category}/{subcategory}/{slug}/` - Individual man page

All 8 failing URLs follow the pattern `/man-pages/{category}/{subcategory}/`, which should display a subcategory listing page.

## Root Cause

### 1. Subcategory Pages with Zero Man Pages

When a subcategory page is accessed, the system:
1. Calls `GetManPagesCountBySubcategory(category, subcategory)` to check if the subcategory has any pages
2. If count is 0 or subcategory doesn't exist, it attempts fallback logic
3. If fallbacks fail, returns 404

### 2. Data Migration Issues

Comparing `old_urls.csv` and `new_urls.csv`:

**Old URLs Structure:**
- `/games/wolfenstein/wolfded/` - `wolfenstein` is a subcategory with slug `wolfded`
- `/games/beating/beats/` - `beating` is a subcategory with slug `beats`
- `/games/mj/mj_player/` and `/games/mj/mj_server/` - `mj` is a subcategory with multiple slugs
- `/library-functions/aléatoire/mlv_random_h/` - `aléatoire` is a subcategory
- `/library-functions/staleness/mongoc_read_prefs_get_max_staleness_seconds/` - `staleness` is a subcategory
- `/kernel-routines/semiconductor/own/` - `semiconductor` is a subcategory
- `/kernel-routines/deadband/joyhandle/` - `deadband` is a subcategory
- `/kernel-routines/subordinate/vm_map_submap/` - `subordinate` is a subcategory

**New URLs Structure:**
- No direct matches found for these subcategory paths in `new_urls.csv`
- The new structure appears to have consolidated or reorganized categories

### 3. Routing Logic Behavior

From `cmd/server/man_pages_routes.go` (lines 338-402):

```go
func handleManPagesSubcategory(...) {
    count, err := db.GetManPagesCountBySubcategory(category, subcategory)
    // ...
    if totalCount == 0 || page > totalPages || page < 1 {
        // Fallback logic attempts to find by slug
        // If fallbacks fail, returns 404
        http.NotFound(w, r)
    }
}
```

The fallback logic tries to match the subcategory name as a slug, but this fails because:
- `wolfenstein`, `beating`, `mj`, `aléatoire`, `semiconductor`, `deadband`, `subordinate`, `staleness` are subcategory names, not page slugs
- The actual slugs are different (e.g., `wolfded`, `beats`, `mj_player`, `mj_server`, etc.)

## Detailed Analysis Per URL

### 1. `/games/wolfenstein/`
- **Expected:** Subcategory page listing all man pages in `games/wolfenstein`
- **Actual in old_urls.csv:** `/games/wolfenstein/wolfded/` exists
- **Issue:** Subcategory may not exist in database or has 0 pages

### 2. `/games/beating/`
- **Expected:** Subcategory page listing all man pages in `games/beating`
- **Actual in old_urls.csv:** `/games/beating/beats/` exists
- **Issue:** Subcategory may not exist in database or has 0 pages

### 3. `/games/mj/`
- **Expected:** Subcategory page listing all man pages in `games/mj`
- **Actual in old_urls.csv:** `/games/mj/mj_player/` and `/games/mj/mj_server/` exist
- **Issue:** Subcategory may not exist in database or has 0 pages

### 4. `/library-functions/aléatoire/`
- **Expected:** Subcategory page listing all man pages in `library-functions/aléatoire`
- **Actual in old_urls.csv:** `/library-functions/aléatoire/mlv_random_h/` exists
- **Issue:** Subcategory may not exist in database or has 0 pages

### 5. `/library-functions/staleness/`
- **Expected:** Subcategory page listing all man pages in `library-functions/staleness`
- **Actual in old_urls.csv:** `/library-functions/staleness/mongoc_read_prefs_get_max_staleness_seconds/` and `/library-functions/staleness/mongoc_read_prefs_set_max_staleness_seconds/` exist
- **Issue:** Subcategory may not exist in database or has 0 pages

### 6. `/kernel-routines/semiconductor/`
- **Expected:** Subcategory page listing all man pages in `kernel-routines/semiconductor`
- **Actual in old_urls.csv:** `/kernel-routines/semiconductor/own/` exists
- **Issue:** Subcategory may not exist in database or has 0 pages

### 7. `/kernel-routines/deadband/`
- **Expected:** Subcategory page listing all man pages in `kernel-routines/deadband`
- **Actual in old_urls.csv:** `/kernel-routines/deadband/joyhandle/` exists
- **Issue:** Subcategory may not exist in database or has 0 pages

### 8. `/kernel-routines/subordinate/`
- **Expected:** Subcategory page listing all man pages in `kernel-routines/subordinate`
- **Actual in old_urls.csv:** `/kernel-routines/subordinate/vm_map_submap/` exists
- **Issue:** Subcategory may not exist in database or has 0 pages

## Possible Causes

1. **Database Migration Gap:** Subcategories exist in `old_urls.csv` but were not migrated to the database
2. **Data Loss:** Subcategories were lost during migration from old to new URL structure
3. **Schema Mismatch:** Subcategories exist but `GetManPagesCountBySubcategory` returns 0 due to data inconsistency
4. **URL Structure Change:** The new URL structure may have consolidated these subcategories into different categories

## Recommendations

1. **Verify Database State:**
   - Check if these subcategories exist in the database
   - Verify if man pages exist for these subcategories
   - Query: `SELECT COUNT(*) FROM man_pages WHERE main_category = ? AND sub_category = ?`

2. **Implement Redirects:**
   - If subcategories exist but have only one page, redirect to that page
   - Example: `/games/wolfenstein/` → `/games/wolfenstein/wolfded/`

3. **Fix Fallback Logic:**
   - Enhance fallback to check if subcategory name matches any slug in that category
   - If single match found, redirect to that page

4. **Data Reconciliation:**
   - Compare `old_urls.csv` with current database state
   - Identify missing subcategories and man pages
   - Re-run migration if needed

5. **Add Monitoring:**
   - Log when subcategory lookups fail
   - Track which subcategories are frequently accessed but return 404

## Next Steps

1. Query database to verify existence of these subcategories
2. Check if man pages exist for these subcategories
3. Implement appropriate fixes (redirects, data migration, or fallback improvements)
4. Monitor for similar issues with other subcategories

