---
const { code, index } = Astro.props;
// index is guaranteed safe for attribute selectors
const id = `codeblock-${index}`;
---
<div
  class="
    relative group my-3
    border rounded-lg overflow-hidden
    bg-gray-100 dark:bg-gray-800
    border-gray-300 dark:border-gray-700
  "
>
  <button
    type="button"
    class="
      copy-btn absolute top-2 right-2 z-10
      text-xs px-2 py-1 rounded-md
      bg-gray-200 dark:bg-gray-700
      text-gray-700 dark:text-gray-200
      hover:bg-gray-300 dark:hover:bg-gray-600
      transition
    "
    data-target={id}
    data-code={encodeURIComponent(code)}
  >
    Copy
  </button>

  <pre class="p-4 overflow-x-auto text-sm text-gray-900 dark:text-gray-100">
<code id={id}>{code}</code>
  </pre>
</div>

<script is:client>
  function fallbackCopy(text) {
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
  }

  async function copyToClipboard(btn) {
    const text = decodeURIComponent(btn.dataset.code);

    try {
      await navigator.clipboard.writeText(text);
    } catch {
      fallbackCopy(text);
    }

    const original = btn.textContent;
    btn.textContent = "Copied!";
    setTimeout(() => (btn.textContent = original), 1500);
  }

  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".copy-btn");
    if (!btn) return;
    copyToClipboard(btn);
  });
</script>
