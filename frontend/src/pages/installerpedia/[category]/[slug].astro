---
import AdBanner from '@/components/banner/AdBanner.astro';
import CreditsButton from '@/components/buttons/CreditsButton';
import ToolContainer from '@/components/tool/ToolContainer';
import ToolHead from '@/components/tool/ToolHead';
import BaseLayout from '@/layouts/BaseLayout.astro';

import { getRepoBySlug, db } from 'db/installerpedia/installerpedia-utils'; // named imports
import type { RepoData } from 'db/installerpedia/installerpedia-schema';
import CodeBlock from '@/components/CodeBlock.astro';
import RequireAuth from '@/components/auth/RequireAuth.astro';

export async function getStaticPaths() {
  const stmt = db.prepare('SELECT repo_slug, repo_type FROM ipm_data');
  const rows = stmt.all();

  return rows.map((r: { repo_slug: string; repo_type: string }) => ({
    params: {
      category: r.repo_type,     // matches folder [category]
      slug: r.repo_slug,         // matches file [slug].astro
    },
  }));
}




// Destructure both category and slug
const { category, slug } = Astro.params;
if (!category || !slug) {
  throw new Error('Both category and slug parameters are required');
}

// Fetch repo data
const repo: RepoData | null = getRepoBySlug(slug);
if (!repo) {
  throw new Error(`Repository ${slug} not found`);
}

console.log("===> Repo is",repo)

// Breadcrumbs
const breadcrumbItems = [
  { label: 'Free DevTools', href: '/freedevtools/' },
  { label: 'Installerpedia', href: '/freedevtools/installerpedia/' },
  { label: category, href: `/freedevtools/installerpedia/${category}/` },
  { label: repo.repo },
];
---
<RequireAuth/>
<BaseLayout
  name={`${repo.repo} Installation`}
  title={`${repo.repo} Installation Guide | Installerpedia`}
  path={`/freedevtools/installerpedia/${category}/${repo.repo}/`}
  description={repo.description}
  canonical={`https://hexmos.com/freedevtools/installerpedia/${category}/${repo.repo}/`}
  keywords={[repo.repo, 'installation', 'guide', 'setup']}
  ogImage="https://hexmos.com/freedevtools/tool-banners/installerpedia-banner.png"
  twitterImage="https://hexmos.com/freedevtools/tool-banners/installerpedia-banner.png"
  datePublished="2025-01-30"
  softwareVersion="1.0.0"
>
  <ToolContainer>
    <div class="mb-16 mt-[74px]">
      <AdBanner />
    </div>

    <ToolHead
      name={`${repo.repo} Installation`}
      description={repo.description}
      breadcrumbItems={breadcrumbItems}
    />


    <!-- Installerpedia CLI Quick Install -->
    <div
      class="
        mt-10 p-6 rounded-2xl shadow-sm
        bg-gray-50 border-gray-300
        dark:bg-gray-900 dark:border-gray-700
        border border-blue-200 dark:border-gray-700
      "
    >

      <!-- Header -->
      <div class="flex items-center gap-3 mb-4">
        <div
          class="
            h-9 w-9 flex items-center justify-center rounded-xl
            bg-blue-600 text-white text-lg font-bold
            dark:bg-blue-500
          "
        >
          ⚡
        </div>

        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
          Quick Install (Recommended)
        </h2>
      </div>

      <p class="text-gray-700 dark:text-gray-300 mb-6">
        The fastest way to install
        <strong>{repo.repo}</strong> is using the InstallerPedia Manager
        <strong>ipm</strong>
        CLI tool. It automatically handles the installation for you.
      </p>

      <!-- Step Card Container -->
      <div class="space-y-8">

        <!-- Step 1 -->
        <div>
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">
            1. Install Installerpedia CLI
          </h3>

          <CodeBlock
            code={`curl -fsSL https://raw.githubusercontent.com/HexmosTech/Installerpedia/main/install.sh | bash`}
            index={-1}
          />

          <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">
            This installs <strong>ipm</strong> globally, making it available anywhere.
          </p>
        </div>

        <!-- Step 2 -->
        <div>
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">
            2. Install {repo.repo} using ipm
          </h3>

          <CodeBlock
            code={`ipm install ${repo.repo}`}
            index={-2}
          />

          <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">
            Automatically runs the recommended installation method for
            <strong>{repo.repo}</strong>.
          </p>
        </div>

      </div>
    </div>

    <!-- Prerequisites -->
    {repo.prerequisites.length > 0 && (
      <div class="mt-8">
        <h2 class="text-xl font-bold mb-4">Prerequisites</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {repo.prerequisites.map((p) => (
            <div
              class="
                p-4 
                border rounded-lg 
                bg-gray-50 border-gray-300 
                dark:bg-gray-800 dark:border-gray-700
              "
            >
              <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold text-lg text-gray-900 dark:text-gray-100">
                  {p.name}
                </h3>

                <span
                  class="
                    text-xs px-2 py-1 rounded
                    bg-blue-600 text-white
                    dark:bg-blue-500 dark:text-white
                  "
                >
                  {p.type.replace(/_/g, " ")}
                </span>
              </div>

              {p.version && (
                <p class="text-sm mb-1 text-gray-800 dark:text-gray-200">
                  <span class="font-medium">Version:</span> {p.version}
                </p>
              )}

              <p class="text-sm text-gray-700 dark:text-gray-300">
                {p.description}
              </p>

              {p.optional && (
                <p
                  class="
                    text-xs mt-2 inline-block px-2 py-1 rounded
                    bg-yellow-200 text-yellow-900 
                    dark:bg-yellow-500 dark:text-gray-900
                  "
                >
                  Optional
                </p>
              )}
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Installation Methods -->
    {repo.installation_methods.length > 0 && (
      <div class="mt-8">
        <h2 class="text-xl font-bold mb-4">Installation Methods</h2>

        <div class="space-y-6">
          {repo.installation_methods.map((method) => {
            const combinedCommands = method.instructions
              .map((i) => i.command)
              .join("\n\n");

            return (
              <div
                class="
                  border rounded-xl p-5
                  bg-gray-50 border-gray-300
                  dark:bg-gray-900 dark:border-gray-700
                  shadow-sm
                "
              >
                <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-gray-100">
                  {method.title}
                </h3>

                <!-- Optional descriptions listed nicely -->
                {method.instructions.some((i) => i.desc) && (
                  <ul class="list-disc pl-5 mb-4 space-y-1">
                    {method.instructions.map((instr) =>
                      instr.desc ? (
                        <li class="text-sm text-gray-700 dark:text-gray-300">
                          {instr.desc}
                        </li>
                      ) : null
                    )}
                  </ul>
                )}

                <!-- COMBINED CODE BLOCK -->
                <CodeBlock code={combinedCommands} />
              </div>
            );
          })}
        </div>
      </div>
    )}



    <!-- Post Installation Steps -->
    {repo.post_installation.length > 0 && (
      <div class="mt-8">
        <h2 class="text-xl font-bold mb-4">Post Installation Steps</h2>
        <ul class="list-disc pl-6">
          {repo.post_installation.map((step) => (
            <li>{step}</li>
          ))}
        </ul>
      </div>
    )}

{repo.resources_of_interest.length > 0 && (
  <section class="mt-10">
    <h2 class="text-xl font-semibold mb-4">Useful Links</h2>

    <ul class="space-y-3">
      {repo.resources_of_interest.map((res) => (
        <li>
          <a
            href={res.url_or_path}
            target="_blank"
            class="
              block rounded-lg border border-gray-200 dark:border-gray-700
              p-4 transition-colors
              hover:bg-gray-50 dark:hover:bg-gray-800
            "
          >
            <p class="font-medium text-blue-600 dark:text-blue-400 hover:underline">
              {res.title}
            </p>

            {res.reason && (
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 leading-relaxed">
                {res.reason}
              </p>
            )}
          </a>
        </li>
      ))}
    </ul>
  </section>
)}


    <!-- Credits Section -->
    <div class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700">
      <div class="flex flex-wrap gap-4">
        <a
          href={`/freedevtools/installerpedia/${category}/`}
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
        >
          ← Back to {category}
        </a>
        <CreditsButton href="/freedevtools/installerpedia/credits/" />
      </div>
    </div>
  </ToolContainer>
</BaseLayout>
