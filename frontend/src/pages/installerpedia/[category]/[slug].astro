---
import AdBanner from '@/components/banner/AdBanner.astro';
import CreditsButton from '@/components/buttons/CreditsButton';
import ToolContainer from '@/components/tool/ToolContainer';
import ToolHead from '@/components/tool/ToolHead';
import BaseLayout from '@/layouts/BaseLayout.astro';

import { getRepoBySlug, db } from 'db/installerpedia/installerpedia-utils'; // named imports
import type { RepoData } from 'db/installerpedia/installerpedia-schema';

export async function getStaticPaths() {
  // fetch all repos with their repo_type
  const stmt = db.prepare('SELECT repo, repo_type FROM ipm_data');
  const rows: { repo: string; repo_type: string }[] = stmt.all();

  // map to Astro params for [category]/[slug].astro
  return rows.map(r => ({
    params: {
      category: r.repo_type, // maps to [category]
      slug: r.repo,          // maps to [slug]
    },
  }));
}



// Destructure both category and slug
const { category, slug } = Astro.params;
if (!category || !slug) {
  throw new Error('Both category and slug parameters are required');
}

// Fetch repo data
const repo: RepoData | null = getRepoBySlug(slug);
if (!repo) {
  throw new Error(`Repository ${slug} not found`);
}

// Breadcrumbs
const breadcrumbItems = [
  { label: 'Free DevTools', href: '/freedevtools/' },
  { label: 'Installerpedia', href: '/freedevtools/installerpedia/' },
  { label: category, href: `/freedevtools/installerpedia/${category}/` },
  { label: repo.repo },
];
---

<BaseLayout
  name={`${repo.repo} Installation`}
  title={`${repo.repo} Installation Guide | Installerpedia`}
  path={`/freedevtools/installerpedia/${category}/${repo.repo}/`}
  description={repo.description}
  canonical={`https://hexmos.com/freedevtools/installerpedia/${category}/${repo.repo}/`}
  keywords={[repo.repo, 'installation', 'guide', 'setup']}
  ogImage="https://hexmos.com/freedevtools/tool-banners/installerpedia-banner.png"
  twitterImage="https://hexmos.com/freedevtools/tool-banners/installerpedia-banner.png"
  datePublished="2025-01-30"
  softwareVersion="1.0.0"
>
  <ToolContainer>
    <div class="mb-16 mt-[74px]">
      <AdBanner />
    </div>

    <ToolHead
      name={`${repo.repo} Installation`}
      description={repo.description}
      breadcrumbItems={breadcrumbItems}
    />

    <!-- Prerequisites -->
    {repo.prerequisites.length > 0 && (
      <div class="mt-8">
        <h2 class="text-xl font-bold mb-4">Prerequisites</h2>
        <ul class="list-disc pl-6">
          {repo.prerequisites.map((p) => (
            <li>
              <strong>{p.name}</strong>
              {p.version ? ` (version: ${p.version})` : ''} — {p.description}
              {p.optional ? ' (optional)' : ''}
            </li>
          ))}
        </ul>
      </div>
    )}

    <!-- Installation Methods -->
    {repo.installation_methods.length > 0 && (
      <div class="mt-8">
        <h2 class="text-xl font-bold mb-4">Installation Methods</h2>
        {repo.installation_methods.map((method) => (
          <div class="mb-6 border rounded-lg p-4 bg-slate-50 dark:bg-slate-900">
            <h3 class="font-semibold mb-2">{method.title}</h3>
            {method.instructions.map((instr) => (
              <pre class="bg-slate-100 dark:bg-slate-800 p-2 rounded mb-2 overflow-x-auto">
                <code>{instr.command}</code>
              </pre>
            ))}
          </div>
        ))}
      </div>
    )}

    <!-- Post Installation Steps -->
    {repo.post_installation.length > 0 && (
      <div class="mt-8">
        <h2 class="text-xl font-bold mb-4">Post Installation Steps</h2>
        <ul class="list-disc pl-6">
          {repo.post_installation.map((step) => (
            <li>{step}</li>
          ))}
        </ul>
      </div>
    )}

    <!-- Resources of Interest -->
    {repo.resources_of_interest.length > 0 && (
      <div class="mt-8">
        <h2 class="text-xl font-bold mb-4">Resources of Interest</h2>
        <ul class="list-disc pl-6">
          {repo.resources_of_interest.map((res) => (
            <li>
              <a href={res.url_or_path} target="_blank" class="text-blue-600 dark:text-blue-400 underline">
                {res.title}
              </a>{' '}
              — {res.reason}
            </li>
          ))}
        </ul>
      </div>
    )}

    <!-- Credits Section -->
    <div class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700">
      <div class="flex flex-wrap gap-4">
        <a
          href={`/freedevtools/installerpedia/${category}/`}
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
        >
          ← Back to {category}
        </a>
        <CreditsButton href="/freedevtools/installerpedia/credits/" />
      </div>
    </div>
  </ToolContainer>
</BaseLayout>
