---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ToolContainer from '@/components/tool/ToolContainer';
import AdBanner from '@/components/banner/AdBanner.astro';
import ToolHead from '@/components/tool/ToolHead';
import RepositoryCard from '../_McpRepoCard.astro';
import Pagination from '@/components/PaginationComponent.astro';
import CreditsButton from '@/components/buttons/CreditsButton';
import { formatName } from '@/lib/utils';
import { 
  getMcpCategory, 
  getMcpPagesByCategory, 
} from 'db/mcp/mcp-utils';

const requestStartTime = Date.now();
console.log(`[${new Date().toISOString()}] Request reached server: /freedevtools/mcp/${Astro.props.category}/${Astro.props.page}/`);

const { category, page } = Astro.props;
const pageNumber = parseInt(page, 10);

// Get category data
const categoryData = await getMcpCategory(category);
if (!categoryData) {
  return new Response(null, { status: 404 });
}

const categoryName = categoryData.name;
const categoryDescription = categoryData.description || '';

const itemsPerPage = 30;
const totalRepositories = categoryData.count;
const totalPages = Math.ceil(totalRepositories / itemsPerPage);

// Validate page number
if (pageNumber > totalPages || pageNumber < 1) {
  return new Response(null, { status: 404 });
}

// Get repositories for current page
const dbRepositories = await getMcpPagesByCategory(category, pageNumber, itemsPerPage);
console.log(dbRepositories.length);

// SEO data
const title = `${categoryName} MCP Servers & Repositories – ${totalRepositories} Model Context Protocol Tools (Page ${pageNumber} of ${totalPages}) | Free DevTools by Hexmos`;
const description = `Discover ${totalRepositories} ${categoryName} MCP servers and repositories for Model Context Protocol integrations. Browse tools compatible with Claude, Cursor, and Windsurf — free, open source, and easy to explore.`;
const keywords = [
  'MCP',
  'Model Context Protocol',
  categoryName,
  'MCP servers',
  'AI tools',
  'developer tools',
  'open source',
  'repositories',
  'pagination',
];

// Breadcrumb data
const breadcrumbItems = [
  { label: 'Free DevTools', href: '/freedevtools/' },
  { label: 'MCP Directory', href: '/freedevtools/mcp/1/' },
  { label: categoryName, href: `/freedevtools/mcp/${category}/1/` },
];

const pageData = {
  category,
  categoryName,
  categoryDescription,
  currentPage: pageNumber,
  totalPages,
  totalRepositories,
  repositories: dbRepositories,
  breadcrumbItems,
  title,
  description,
  keywords,
};

console.log(`[${new Date().toISOString()}] Total request time for /freedevtools/mcp/${category}/${page}/: ${Date.now() - requestStartTime}ms`);
---

<BaseLayout
  name={`${pageData.categoryName} MCP Repositories`}
  title={pageData.title}
  path={`/freedevtools/mcp/${pageData.category}/1/`}
  description={pageData.description}
  canonical={`https://hexmos.com/freedevtools/mcp/${pageData.category}/${pageData.currentPage}/`}
  keywords={pageData.keywords}
  ogImage="https://hexmos.com/freedevtools/tool-banners/mcp-directory-banner.png"
  twitterImage="https://hexmos.com/freedevtools/tool-banners/mcp-directory-banner.png"
  datePublished="2025-01-30"
  softwareVersion="1.0.0"
  features={[
    `Browse ${pageData.totalRepositories} MCP repositories in ${pageData.categoryName}`,
    'Filter by license and quality scores',
    'Search and sort functionality',
    'Detailed repository information',
    'Pagination support',
  ]}
>
  <ToolContainer>
    <div class="mb-16 mt-[74px]">
      <AdBanner />
    </div>
    <ToolHead
      name={`${pageData.categoryName} MCP Repositories`}
      description={`${pageData.totalRepositories} repositories in this category. ${pageData.categoryDescription}`}
      breadcrumbItems={pageData.breadcrumbItems}
    />

    <!-- Pagination Info - Top -->
    <div class="bg-slate-50 dark:bg-slate-800 rounded-lg p-4 mb-6 mt-6">
      <div class="text-sm text-slate-600 dark:text-slate-400 text-center">
        Showing {pageData.repositories.length} of {pageData.totalRepositories}{' '}
        repositories (Page {pageData.currentPage} of {pageData.totalPages})
      </div>
    </div>

    <!-- Repositories List -->
    <div
      id="repositories-grid"
      class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4"
    >
      {pageData.repositories.map((server: any) => {
        const formattedName = formatName(server.name);
        return (
          <RepositoryCard
            name={formattedName}
            category={category}
            description={server.description}
            owner={server.owner}
            stars={server.stars}
            updated_at={server.updated_at}
            license={server.license}
            category={pageData.category}
            repositoryId={server.key}
            imageUrl={server.image_url}
            npm_downloads={server.npm_downloads}
          />
        );
      })}
    </div>

    <!-- Pagination -->
    <Pagination
      currentPage={pageData.currentPage}
      totalPages={pageData.totalPages}
      baseUrl={`/freedevtools/mcp/${pageData.category}/`}
      alwaysIncludePageNumber={true}
    />

    <!-- Credits Section -->
    <div
      class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700"
    >
      <div class="flex flex-wrap gap-4">
        <a
          href="/freedevtools/mcp/1/"
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
        >
          ← Back to MCP Directory
        </a>
        <CreditsButton href="/freedevtools/mcp/credits/" client:load />
      </div>
    </div>
  </ToolContainer>
</BaseLayout>
