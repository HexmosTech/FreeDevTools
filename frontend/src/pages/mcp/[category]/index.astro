---
import { 
  getAllMcpCategories, 
  getMcpCategory,
  getOverview
} from 'db/mcp/mcp-utils';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Mcp from '../_Mcp.astro';

export const prerender = false;

const { category } = Astro.params;

if (!category) {
  return new Response(null, { status: 404 });
}

let paginationData: any = null;
let shouldRedirect = false;
let redirectUrl = '';

// If category is numeric, this is actually a pagination route
// Render pagination content directly (workaround for route priority)
if (/^\d+$/.test(category)) {
  const currentPage = parseInt(category, 10);

  const itemsPerPage = 30;
  // Calculate totals
  const { totalMcpCount: totalServers, totalCategoryCount } = await getOverview();
  const totalTools = 0; // We don't track tool count separately in DB yet
  const totalClients = 0;
  
  const totalPages = Math.ceil(totalCategoryCount / itemsPerPage);

  // Validate page number
  if (currentPage > totalPages || currentPage < 1) {
    return new Response(null, { status: 404 });
  }

  // Fetch categories data directly
  const allCategories = await getAllMcpCategories(currentPage, itemsPerPage);
  
  // Map DB categories to the format expected by the component
  const mappedCategories = allCategories.map(cat => ({
    id: cat.slug,
    name: cat.name,
    description: cat.description,
    icon: cat.slug,
    serverCount: cat.count,
    url: `/freedevtools/mcp/${cat.slug}/1/`
  }));

  const currentPageCategories = mappedCategories;

  // SEO data
  const title = `Awesome MCP Servers Directory – Discover ${allCategories.length} Model Context Protocol Tools & Categories (Page ${currentPage} of ${totalPages}) | Free DevTools by Hexmos`;
  const description = `Explore ${totalServers}+ verified MCP servers, tools, and clients used by Claude, Cursor, and Windsurf. Find Model Context Protocol integrations for your AI apps — free, open source, and easy to use.`;
  const keywords = [
    'MCP',
    'Model Context Protocol',
    'MCP servers',
    'MCP tools',
    'MCP clients',
    'AI tools',
    'developer tools',
    'open source',
    'repositories',
    'directory',
    'pagination',
  ];

  // Breadcrumb data
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'MCP Directory', href: '/freedevtools/mcp/1/' },
  ];
  paginationData = {
    currentPage,
    totalPages,
    totalCategories: totalCategoryCount,
    categories: currentPageCategories,
    totalServers,
    totalTools,
    totalClients,
    breadcrumbItems,
    title,
    description,
    keywords,
  };
} else {
  // Validate category exists
  const categoryData = await getMcpCategory(category);
  if (!categoryData) {
    return new Response(null, { status: 404 });
  }

  // Redirect to the first page
  shouldRedirect = true;
  redirectUrl = `/freedevtools/mcp/${category}/1/`;
}

if (shouldRedirect) {
  return Astro.redirect(redirectUrl, 301);
}
---

{paginationData ? (
  <BaseLayout
    name="MCP Directory"
    title={paginationData.title}
    path="/freedevtools/mcp/1/"
    description={paginationData.description}
    canonical={`https://hexmos.com/freedevtools/mcp/${paginationData.currentPage === 1 ? '' : paginationData.currentPage + '/'}`}
    keywords={paginationData.keywords}
    ogImage="https://hexmos.com/freedevtools/tool-banners/mcp-directory-banner.png"
    twitterImage="https://hexmos.com/freedevtools/tool-banners/mcp-directory-banner.png"
    datePublished="2025-01-30"
    softwareVersion="1.0.0"
    features={[
      `Browse ${paginationData.totalCategories} MCP categories`,
      `Page ${paginationData.currentPage} of ${paginationData.totalPages}`,
      'Filter by category and license',
      'Search and sort functionality',
    ]}
  >
    <Mcp
      serversCount={paginationData.totalServers}
      toolsCount={paginationData.totalTools}
      clientsCount={paginationData.totalClients}
      categoriesCount={paginationData.totalCategories}
      categories={paginationData.categories}
      breadcrumbItems={paginationData.breadcrumbItems}
      currentPage={paginationData.currentPage}
      lastPage={paginationData.totalPages}
      totalPages={paginationData.totalPages}
      pageUrl={paginationData.currentPage === 1 ? '/freedevtools/mcp/1/' : `/freedevtools/mcp/${paginationData.currentPage}/`}
    />
  </BaseLayout>
) : null}
