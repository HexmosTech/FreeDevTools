---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getAllMcpCategories, getAllMcpCategoryIds, getMcpMetadata } from '@/lib/mcp-utils';
import { getCollection } from 'astro:content';
import Mcp from './_Mcp.astro';

export const prerender = false;

const { page } = Astro.params;
const urlPath = Astro.url.pathname;

// Early return if no page param
if (!page) {
  return new Response(null, { status: 404 });
}

let categoryData: any = null;
let paginationData: any = null;

// Check if page param is numeric
if (!/^\d+$/.test(page)) {
  // If not numeric, it might be a category name
  // Redirect to add trailing slash if missing (BEFORE checking category)
  if (!urlPath.endsWith('/')) {
    return Astro.redirect(`${urlPath}/`, 301);
  }

  const allCategoryIds = await getAllMcpCategoryIds();
  const isCategory = allCategoryIds.includes(page);

  if (isCategory) {
    // This is a category index route - redirect to page 1
    return Astro.redirect(`/freedevtools/mcp/${page}/1/`, 301);
  } else {
    // Not a valid category or page number - 404
    return new Response(null, { status: 404 });
  }
} else {
  // Handle pagination route
  const currentPage = parseInt(page, 10);

  // Redirect /mcp/1 to /mcp (if you have an index.astro)
  // For now, keep /mcp/1/ as valid

  // Fetch categories data directly (SSR mode)
  const allCategories = await getAllMcpCategories();
  const itemsPerPage = 30;
  const totalPages = Math.ceil(allCategories.length / itemsPerPage);

  // Validate page number
  if (currentPage > totalPages || currentPage < 1) {
    return new Response(null, { status: 404 });
  }

  // Get categories for current page
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentPageCategories = allCategories.slice(startIndex, endIndex);

  // Load MCP metadata
  const metadata = await getMcpMetadata();

  if (!metadata) {
    throw new Error('MCP metadata not found');
  }

  // Calculate totals
  const totalServers = metadata.totalRepositories;
  const totalTools = Object.values(metadata.categories).reduce(
    (sum, cat) => sum + cat.npmPackages,
    0
  );
  const totalClients = 0; // This would need to be calculated from actual data

  // SEO data
  const title = `Awesome MCP Servers Directory – Discover ${allCategories.length} Model Context Protocol Tools & Categories (Page ${currentPage} of ${totalPages}) | Free DevTools by Hexmos`;
  const description = `Explore ${totalServers}+ verified MCP servers, tools, and clients used by Claude, Cursor, and Windsurf. Find Model Context Protocol integrations for your AI apps — free, open source, and easy to use.`;
  const keywords = [
    'MCP',
    'Model Context Protocol',
    'MCP servers',
    'MCP tools',
    'MCP clients',
    'AI tools',
    'developer tools',
    'open source',
    'repositories',
    'directory',
    'pagination',
  ];

  // Breadcrumb data
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'MCP Directory', href: '/freedevtools/mcp/1/' },
  ];

  paginationData = {
    currentPage,
    totalPages,
    totalCategories: allCategories.length,
    categories: currentPageCategories,
    totalServers,
    totalTools,
    totalClients,
    breadcrumbItems,
    title,
    description,
    keywords,
  };
}
---

{paginationData ? (
  <BaseLayout
    name="MCP Directory"
    title={paginationData.title}
    path="/freedevtools/mcp/1/"
    description={paginationData.description}
    canonical={`https://hexmos.com/freedevtools/mcp/${paginationData.currentPage === 1 ? '' : paginationData.currentPage + '/'}`}
    keywords={paginationData.keywords}
    ogImage="https://hexmos.com/freedevtools/tool-banners/mcp-directory-banner.png"
    twitterImage="https://hexmos.com/freedevtools/tool-banners/mcp-directory-banner.png"
    datePublished="2025-01-30"
    softwareVersion="1.0.0"
    features={[
      `Browse ${paginationData.totalCategories} MCP categories`,
      `Page ${paginationData.currentPage} of ${paginationData.totalPages}`,
      'Filter by category and license',
      'Search and sort functionality',
    ]}
  >
    <Mcp
      serversCount={paginationData.totalServers}
      toolsCount={paginationData.totalTools}
      clientsCount={paginationData.totalClients}
      categoriesCount={paginationData.totalCategories}
      categories={paginationData.categories}
      breadcrumbItems={paginationData.breadcrumbItems}
      currentPage={paginationData.currentPage}
      lastPage={paginationData.totalPages}
      totalPages={paginationData.totalPages}
      pageUrl={paginationData.currentPage === 1 ? '/freedevtools/mcp/1/' : `/freedevtools/mcp/${paginationData.currentPage}/`}
    />
  </BaseLayout>
) : null}
