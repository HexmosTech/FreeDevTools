---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getAllCheatsheetCategories } from '../../lib/cheatsheets-utils';
import CheatsheetPage from './_CheatsheetPage.astro';

export const prerender = false;

const { page } = Astro.params;
const urlPath = Astro.url.pathname;

// Early return if no page param
if (!page) {
  return new Response(null, { status: 404 });
}

let categoryData: any = null;
let paginationData: any = null;

// Check if page param is numeric
if (!/^\d+$/.test(page)) {
  // If not numeric, it might be a category name
  // Redirect to add trailing slash if missing (BEFORE checking category)
  if (!urlPath.endsWith('/')) {
    return Astro.redirect(`${urlPath}/`, 301);
  }

  // Check if it's a valid category
  const allCategories = await getAllCheatsheetCategories();
  const categoryIds = allCategories.map((c) => c.id);
  const isCategory = categoryIds.includes(page);

  if (isCategory) {
    // This is a category route - redirect to category page
    return Astro.redirect(`/freedevtools/c/${page}/`, 301);
  } else {
    // Not a valid category or page number - 404
    return new Response(null, { status: 404 });
  }
} else {
  // Handle pagination route
  const currentPage = parseInt(page, 10);

  // Redirect /c/1 to /c
  if (currentPage === 1) {
    return Astro.redirect('/freedevtools/c/');
  }

  // Fetch categories data directly (SSR mode)
  const allCategories = await getAllCheatsheetCategories();

  const itemsPerPage = 30;
  const totalPages = Math.ceil(allCategories.length / itemsPerPage);

  // Validate page number
  if (currentPage > totalPages || currentPage < 1) {
    return new Response(null, { status: 404 });
  }

  const totalCategories = allCategories.length;

  // Calculate total cheatsheets
  const totalCheatsheets = allCategories.reduce((total, category) => total + category.cheatsheetCount, 0);

  // Get categories for current page
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const categories = allCategories.slice(startIndex, endIndex);

  // Breadcrumb data
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'Cheatsheets', href: '/freedevtools/c/' },
  ];

  // SEO data
  const seoTitle = `Cheatsheets - Page ${currentPage} | Online Free DevTools by Hexmos`;
  const seoDescription = `Browse page ${currentPage} of our cheatsheets collection. Quick reference for commands, syntax, and programming concepts.`;
  const canonical = `https://hexmos.com/freedevtools/c/${currentPage}/`;

  // Enhanced keywords for main page
  const mainKeywords = [
    'cheatsheets',
    'reference',
    'commands',
    'syntax',
    'programming',
    'documentation',
    'quick reference',
    'command line',
    'cli',
    'terminal',
  ];

  paginationData = {
    currentPage,
    totalPages,
    totalCategories,
    totalCheatsheets,
    categories,
    breadcrumbItems,
    seoTitle,
    seoDescription,
    canonical,
    mainKeywords,
    itemsPerPage,
  };
}
---

{
  paginationData ? (
    <BaseLayout 
      name="Cheatsheets"
      path={`/freedevtools/c/${paginationData.currentPage}/`}
      title={paginationData.seoTitle}
      description={paginationData.seoDescription}
      canonical={paginationData.canonical}
      showHeader={true}
      totalItems={paginationData.totalCategories}
      itemsPerPage={paginationData.itemsPerPage}
      currentPage={paginationData.currentPage}
      category="Cheatsheets"
      partOf="Free DevTools"
      partOfUrl="https://hexmos.com/freedevtools/"
      keywords={paginationData.mainKeywords}
      features={["Quick reference", "Command syntax", "Easy to scan", "Fast learning", "Free access"]}
      commandCategory="Reference"
    >
      <CheatsheetPage 
        categories={paginationData.categories}
        currentPage={paginationData.currentPage}
        totalPages={paginationData.totalPages}
        totalCategories={paginationData.totalCategories}
        totalCheatsheets={paginationData.totalCheatsheets}
        breadcrumbItems={paginationData.breadcrumbItems}
      />
    </BaseLayout>
  ) : null
}
