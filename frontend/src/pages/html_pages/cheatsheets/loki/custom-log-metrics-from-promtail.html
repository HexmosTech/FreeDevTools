<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promtail Custom Log Metrics - Create & Query Metrics</title>
    <meta name="description" content="Learn how to create custom log metrics from Promtail with PromQL. Configure Promtail, expose metrics, and query them in Prometheus for effective log analysis and alerting.">
    <meta name="keywords" content="promtail, loki, log metrics, custom metrics, prometheus, promql, log analysis, alerting, nginx metrics, pipeline stages, metrics stage">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://yourdomain.com/loki/custom-log-metrics-from-promtail.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourdomain.com/loki/custom-log-metrics-from-promtail.html">
    <meta property="og:title" content="Promtail Custom Log Metrics - Create & Query Metrics">
    <meta property="og:description" content="Learn how to create custom log metrics from Promtail with PromQL. Configure Promtail, expose metrics, and query them in Prometheus for effective log analysis and alerting.">
    <meta property="og:image" content="https://yourdomain.com/path/to/your/og-image.jpg">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://yourdomain.com/loki/custom-log-metrics-from-promtail.html">
    <meta name="twitter:title" content="Promtail Custom Log Metrics - Create & Query Metrics">
    <meta name="twitter:description" content="Learn how to create custom log metrics from Promtail with PromQL. Configure Promtail, expose metrics, and query them in Prometheus for effective log analysis and alerting.">
    <meta name="twitter:image" content="https://yourdomain.com/path/to/your/twitter-image.jpg">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
            margin-top: 24px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Promtail Custom Log Metrics</h1>
        </div>
        <div class="content">
            <div class="markdown-content">
                <p>This guide demonstrates how to create and utilize custom log metrics from Promtail, enabling you to extract valuable insights from your logs and expose them for Prometheus to scrape and analyze. By leveraging Promtail's pipeline stages, specifically the `metrics` stage, you can transform log lines into Prometheus-compatible metrics.</p>

                <h2>Setting Up Promtail for Custom Metrics</h2>
                <p>First, configure your Promtail agent to process logs and define custom metrics. This involves specifying the log source, labels, and the pipeline stages for metric extraction. Below is an example of a <code>promtail-config.yml</code> file:</p>
                <pre class="codehilite"><code>$ cat /etc/promtail/promtail-config.yml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /var/lib/promtail/positions.yaml

clients:
  - url: https://x:x@loki.domain.com/loki/api/v1/push

scrape_configs:
  - job_name: prod/logs
    static_configs:
    - targets:
        - localhost
      labels:
        job: prod/logs
        service: nginx-test
        logtype: info
        __path__: /var/log/nginx/access.log
    pipeline_stages:
    - match:
        selector: '{job=&quot;prod/logs&quot;, service=&quot;nginx-test&quot;}'
        stages:
        - regex:
            expression: '.*(?P&lt;hits&gt;GET /.*)'
        - metrics:
            nginx_get_hits:
              type: Counter
              description: &quot;Total GET requests&quot;
              source: hits
              config:
                action: inc
</code></pre>

                <h2>Verifying Metrics Endpoint</h2>
                <p>After configuring Promtail, verify that the metrics are being exposed correctly by accessing the <code>/metrics</code> endpoint. This endpoint provides the metrics in Prometheus exposition format.</p>
                <pre class="codehilite"><code>$ curl http://localhost:9080/metrics
# HELP promtail_custom_nginx_get_hits Total GET requests
# TYPE promtail_custom_nginx_get_hits counter
promtail_custom_nginx_get_hits{filename=&quot;/var/log/nginx/access.log&quot;,job=&quot;prod/logs&quot;,logtype=&quot;info&quot;,service=&quot;nginx-test&quot;} 801
</code></pre>

                <h2>Configuring Prometheus to Scrape Promtail Metrics</h2>
                <p>Next, configure Prometheus to scrape the metrics exposed by Promtail. This example uses <code>ec2_sd_configs</code> for service discovery, assuming your Promtail instances are running on EC2 instances tagged appropriately.</p>
                <pre class="codehilite"><code>scrape_configs:
  # promtail-exporter
  - job_name: promtail-exporter
    scrape_interval: 15s
    ec2_sd_configs:
    - region: eu-west-1
      port: 9100
      filters:
        - name: tag:PromtailScrape
          values:
            - Enabled
    relabel_configs:
    - source_labels: [__meta_ec2_private_ip]
      replacement: '${1}:9080'
      target_label: __address__
    - source_labels: [__meta_ec2_tag_Name]
      target_label: instance
</code></pre>
                <p>Ensure your EC2 instances are tagged with <code>PromtailScrape=Enabled</code> for Prometheus to discover and scrape them. You can verify this in Prometheus by querying <code>up{job="promtail-exporter"}</code>.</p>

                <h2>Querying Custom Metrics with PromQL</h2>
                <p>Once Prometheus is scraping the metrics, you can query them using PromQL. For instance, to see the increase in GET requests over a 5-minute interval:</p>
                <pre class="codehilite"><code>increase(promtail_custom_nginx_get_hits{service=&quot;nginx-test&quot;}[5m])
</code></pre>

                <h2>Setting Up Alerts Based on Custom Metrics</h2>
                <p>Custom log metrics are invaluable for setting up alerts. You can define alerting rules in Prometheus to notify you when certain thresholds are breached. For example, to alert if the number of GET requests exceeds 5000 within a 5-minute window:</p>
                <pre class="codehilite"><code>  - name: loki-metric-alert
    groups:
      - name: loki_metric_alert
        rules:
        - alert: nginx_get_hits
          expr: sum(increase(promtail_custom_nginx_get_hits{service=&quot;nginx-test&quot;}[5m])) &gt; 5000
          for: 2m
</code></pre>

                <h3>Further Exploration</h3>
                <p>For more advanced metric configurations and troubleshooting, refer to the official Promtail documentation on <a href="https://grafana.com/docs/loki/latest/clients/promtail/pipeline-stages/#metrics-stage">pipeline stages</a> and Prometheus documentation on <a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#increase">PromQL functions</a>.</p>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>