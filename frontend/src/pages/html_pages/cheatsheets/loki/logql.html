<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Readme</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Readme</h1>
        </div>
        <div class="content">
            <div class="markdown-content"><h1>LogQL</h1>
<h2>Other Examples</h2>
<ul>
<li>https://github.com/grafana/loki/blob/master/docs/logql.md#filter-expression</li>
<li>https://medium.com/grafana-tutorials/logql-in-grafana-loki-ffc822a65f59</li>
<li>https://megamorf.gitlab.io/cheat-sheets/loki/</li>
</ul>
<h2>logql examples</h2>
<p>View all logs for dev/logs:</p>
<pre class="codehilite"><code>{job=&quot;dev/logs&quot;}
</code></pre>

<p>View loglines for a specific filename for dev/logs:</p>
<pre class="codehilite"><code>{job=&quot;dev/logs&quot;, filename=&quot;/var/log/app.log&quot;}
</code></pre>

<p>Search for logs that has the exact match "This is a test":</p>
<pre class="codehilite"><code>{job=&quot;dev/logs&quot;} |= &quot;This is a test&quot;
</code></pre>

<p>Similar, but search with case insensitive:</p>
<pre class="codehilite"><code>{job=&quot;dev/logs&quot;} |= &quot;(?i)this is a test&quot;
</code></pre>

<p>Similar as above, but dont include exact match "testerId=123":</p>
<pre class="codehilite"><code>{job=&quot;dev/logs&quot;} |= &quot;This is a test&quot; != &quot;testerId=123&quot;
</code></pre>

<p>Similar as above, and include a contains match for anything starting with "accountId=000":</p>
<pre class="codehilite"><code>{job=&quot;dev/logs&quot;} |= &quot;This is a test&quot; != &quot;testerId=123&quot; |~ &quot;accountId=000&quot;
</code></pre>

<p>Similar as above, but exclude test with deviceId=001 and deviceId=209:</p>
<pre class="codehilite"><code>{job=&quot;dev/logs&quot;} |= &quot;This is a test&quot; |= &quot;accountId=000&quot; !~ &quot;deviceId=(001|209)&quot;
</code></pre>

<p>Log events per container_name:</p>
<pre class="codehilite"><code>sum by(container_name) (rate({job=&quot;prod/dockerlogs&quot;}[1m]))
</code></pre>

<h2>logql-parser</h2>
<p>From <a href="https://hub.docker.com/layers/ctovena/loki/logql-parser-5e0238e/images/sha256-a326d3329c25729b111216bdb0bddb4b8e976a40954c8be4c5396f36a5fb4f23?context=explore">ctovena/loki:logql-parser-5e0238e</a></p>
<pre class="codehilite"><code>{job=&quot;adsb&quot;} | json | gs &gt; 500
</code></pre>

<pre class="codehilite"><code>sum by (query) (avg_over_time({job=&quot;dev/app&quot;} |= &quot;caller=metrics.go&quot; | logfmt | duration &gt; 100ms | unwrap througput_mb[1m]))
</code></pre>

<pre class="codehilite"><code>{job=&quot;dev/app&quot;} |= &quot;caller=metrics.go&quot; | logfmt | throughput_mb &lt; 100 and duration &gt;= 200ms | line_format &quot;{{.duration}}{{.query}}&quot;
</code></pre>

<pre class="codehilite"><code>{compose_service=&quot;loki&quot;, job=&quot;dockerlogs&quot;} | logfmt | read &gt;= 0
</code></pre>

<pre class="codehilite"><code>{compose_service=&quot;loki&quot;,job=&quot;dockerlogs&quot;} | logfmt | read &gt;= 0 | line_format &quot;{{.level}}&quot;
</code></pre>

<pre class="codehilite"><code>{container_name=~&quot;ecs-.*-nginx-.*&quot;} 
| json 
| status=~&quot;(200|4..)&quot; and request_length&gt;250 and request_method!=&quot;POST&quot; and xff=~&quot;(54.*|34.*)&quot; 
| line_format &quot;ReqMethod: {{.request_method}}, Status: {{.status}}, UserAgent: {{.http_user_agent}} Args: {{.args}} , ResponseTime: {{.responsetime}}&quot;
</code></pre>

<h2>Regex</h2>
<p>Using regex, this line:</p>
<pre class="codehilite"><code>1.2.3.4 - - [23/Nov/2020:17:31:00 +0200] &quot;POST /foo/bar?token=x.x HTTP/1.1&quot; 201 83 &quot;http://localhost/&quot; &quot;Mozilla/5.0 (Linux; Android 10; Nokia 6.1 Build/x.x.x; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/x.0.x.110 Mobile Safari/537.36&quot; &quot;1.2.3.4&quot;
</code></pre>

<p>With regex:</p>
<pre class="codehilite"><code>{job=&quot;prod/logs&quot;} |~ &quot;foo&quot; | regexp &quot;(?P&lt;ip&gt;\\d+.\\d+.\\d+.\\d+) (.*) (.*) (?P&lt;date&gt;\\[(.*)\\]) (\&quot;)(?P&lt;verb&gt;(\\w+)) (?P&lt;request_path&gt;([^\&quot;]*)) (?P&lt;http_ver&gt;([^\&quot;]*))(\&quot;) (?P&lt;status_code&gt;\\d+) (?P&lt;bytes&gt;\\d+) (\&quot;)(?P&lt;referrer&gt;(([^\&quot;]*)))(\&quot;) (\&quot;)(?P&lt;user_agent&gt;(([^\&quot;]*)))(\&quot;)&quot;
</code></pre>

<p>And filtering on <code>status_code=201</code>:</p>
<pre class="codehilite"><code>{job=&quot;prod/logs&quot;} |~ &quot;doAPICall&quot; | regexp &quot;(?P&lt;ip&gt;\\d+.\\d+.\\d+.\\d+) (.*) (.*) (?P&lt;date&gt;\\[(.*)\\]) (\&quot;)(?P&lt;verb&gt;(\\w+)) (?P&lt;request_path&gt;([^\&quot;]*)) (?P&lt;http_ver&gt;([^\&quot;]*))(\&quot;) (?P&lt;status_code&gt;\\d+) (?P&lt;bytes&gt;\\d+) (\&quot;)(?P&lt;referrer&gt;(([^\&quot;]*)))(\&quot;) (\&quot;)(?P&lt;user_agent&gt;(([^\&quot;]*)))(\&quot;)&quot; | status_code=201
</code></pre>

<p>Metrix on a regex and sum by ip:</p>
<pre class="codehilite"><code>sum by (ip) (count_over_time({job=&quot;dev/nginx&quot;, host=&quot;localhost&quot;}
| regexp `(?P&lt;ip&gt;\S+) (?P&lt;identd&gt;\S+) (?P&lt;user&gt;\S+) \[(?P&lt;timestamp&gt;[\w:\/]+\s[+\\-]\d{4})\] &quot;(?P&lt;action&gt;\S+)\s?(?P&lt;path&gt;\S+)\s?(?P&lt;protocol&gt;\S+)?&quot; (?P&lt;status&gt;\d{3}|-) (?P&lt;size&gt;\d+|-)\s?&quot;?(?P&lt;referrer&gt;[^\&quot;]*)&quot;?\s?&quot;?(?P&lt;useragent&gt;[^\&quot;]*)?&quot;?`  
| referrer=~&quot;(http|https)://10.21.2.42:(80|443)/(.+)&quot;[60s]))
</code></pre>

<p>More Regex examples:</p>
<pre class="codehilite"><code># logline
172.10.10.2 - - [10/Jun/2022:09:44:03 +0000] &quot;GET /en/home HTTP/1.1&quot; 200 5434 &quot;https://example.com/en/direct/gohome&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.61 Safari/537.36&quot;

# regex
{job=&quot;prod/nginx&quot;}
| regexp `(?P&lt;ip&gt;\S+) (?P&lt;identd&gt;\S+) (?P&lt;user&gt;\S+) \[(?P&lt;timestamp&gt;[\w:\/]+\s[+\\-]\d{4})\] &quot;(?P&lt;action&gt;\S+)\s?(?P&lt;path&gt;\S+)\s?(?P&lt;protocol&gt;\S+)?&quot; (?P&lt;status&gt;\d{3}|-) (?P&lt;size&gt;\d+|-)\s?&quot;?(?P&lt;referrer&gt;[^\&quot;]*)&quot;?\s?&quot;?(?P&lt;useragent&gt;[^\&quot;]*)?&quot;?`
</code></pre>

<p>And another one:</p>
<pre class="codehilite"><code># logline
[2022-06-10 10:44:45] dev.INFO: {&quot;logType&quot;:&quot;Event&quot;,&quot;logTag&quot;:&quot;SomeResponse&quot;,&quot;description&quot;:&quot;SomeClientResponse: handleSomeRequest&quot;,&quot;attributes&quot;:{&quot;foo&quot;:&quot;bar&quot;}}

# regex
{job=&quot;prod/logs&quot;} | regexp `\[(?P&lt;timestamps&gt;(.*))\] (?P&lt;environment&gt;(prod|dev)).(?P&lt;loglevel&gt;(INFO|DEBUG|ERROR|WARN)): (?P&lt;jsonstring&gt;(.*))`
</code></pre>

<p>Extracting <code>json</code> and mixing with <code>line_format</code> and <code>regexp</code>:</p>
<pre class="codehilite"><code># message: EventID:12345678-1234-1234-1234-123456789abv - Some troubleshooting needed - runbookId:123456, categoryCode:DB, cpuValue:92.000000000000000000, serverName:Server01, versionId:1

{job=&quot;serverlogs&quot;} |= &quot;logTag:event&quot; | json | line_format &quot;{{.message}}&quot; | regexp &quot;EventID:(?P&lt;event_id&gt;[a-f0-9\\-]+) - Some troubleshooting needed - runbookId:(?P&lt;runbook_id&gt;\\d+), categoryCode:(?P&lt;category_code&gt;\\w+), cpuValue:(?P&lt;cpu_value&gt;[\\d\\.]+), serverName:(?P&lt;server_name&gt;[^,]+), versionId:(?P&lt;version_id&gt;\\d+)&quot;
</code></pre>

<ul>
<li>https://grafana.com/docs/loki/latest/logql/log_queries/</li>
<li>https://grafana.com/docs/loki/latest/logql/#label-filter-expression</li>
<li>https://gist.github.com/ruanbekker/cb4ebdc24331661ca120f20b4445ad75</li>
</ul>
<h2>Access Json Data</h2>
<p>If your log looks like this:</p>
<pre class="codehilite"><code>[2022-06-10 10:44:45] dev.INFO: {&quot;logType&quot;:&quot;Event&quot;,&quot;logTag&quot;:&quot;SomeResponse&quot;,&quot;description&quot;:&quot;SomeClientResponse: handleSomeRequest&quot;,&quot;attributes&quot;:{&quot;foo&quot;:&quot;bar&quot;}}
</code></pre>

<p>And you want to parse the json after "dev.INFO:" you can do:</p>
<pre class="codehilite"><code>{job=&quot;dev/logs&quot;} | regexp `\[(?P&lt;timestamps&gt;(.*))\] (?P&lt;environment&gt;(prod|dev)).(?P&lt;loglevel&gt;(INFO|DEBUG|ERROR|WARN)): (?P&lt;jsonstring&gt;(.*))` | line_format &quot;{{.jsonstring}}&quot; | json | __error__ != &quot;JSONParserErr&quot;
</code></pre>

<p>If your json has specific data that you want to access, lets say a key {"logTag": "BalanceCheck", "balance": 9}, you can do:</p>
<pre class="codehilite"><code>{job=&quot;dev/logs&quot;} | regexp `\[(?P&lt;timestamps&gt;(.*))\] (?P&lt;environment&gt;(prod|dev)).(?P&lt;loglevel&gt;(INFO|DEBUG|ERROR|WARN)): (?P&lt;jsonstring&gt;(.*))` | line_format &quot;{{.jsonstring}}&quot; | json | __error__ != &quot;JSONParserErr&quot; | logTag=&quot;BalanceCheck&quot;
</code></pre>

<p>And to see logs for balances more than 8:</p>
<pre class="codehilite"><code>{job=&quot;dev/logs&quot;} | regexp `\[(?P&lt;timestamps&gt;(.*))\] (?P&lt;environment&gt;(prod|dev)).(?P&lt;loglevel&gt;(INFO|DEBUG|ERROR|WARN)): (?P&lt;jsonstring&gt;(.*))` | line_format &quot;{{.jsonstring}}&quot; | json | __error__ != &quot;JSONParserErr&quot; | logTag=&quot;BalanceCheck&quot; | balance &gt; 100
</code></pre>

<p>Line format:</p>
<pre class="codehilite"><code>{job=&quot;containerlogs&quot;} | json | line_format &quot;timestamp={{ .time }} source_ip={{ .req_headers_x_real_ip }} method={{ .req_method }} path={{ .req_url }} status_code={{ .res_statusCode }}&quot;
</code></pre>

<p>Sum by:</p>
<pre class="codehilite"><code>sum by (res_statusCode) (rate({job=&quot;containerlogs&quot;} | json | line_format &quot;timestamp={{ .time }} source_ip={{ .req_headers_x_real_ip }} method={{ .req_method }} path={{ .req_url }} status_code={{ .res_statusCode }}&quot;[60s])) 
</code></pre>

<p>Access nested json:</p>
<pre class="codehilite"><code>{namespace=~&quot;$namespace&quot;, app=~&quot;$app&quot;, pod=~&quot;$pod&quot;} | json  | line_format &quot;{{.log}}&quot; | json raw_body=&quot;message&quot; | line_format &quot;m: {{.raw_body}}&quot; | __error__!=&quot;JSONParserErr&quot;
</code></pre>

<p>Filter out JSONParserErr:</p>
<pre class="codehilite"><code>{container=&quot;my-service&quot;} |= `` | json | __error__!=&quot;JSONParserErr&quot; | line_format &quot;{{.message}} {{.stacktrace}}&quot;
</code></pre>

<p>Access nested json and return k/v pairs:</p>
<pre class="codehilite"><code>{container=&quot;my-service&quot;} 
| pattern `&lt;_entry&gt;` 
| json
| line_format &quot;{{ .message }}\n{{ range $k, $v := (fromJson ._entry)}}{{if ne $k \&quot;message\&quot;}}{{$k}}: {{$v}} {{ end }}{{ end }}&quot;
</code></pre>

<ul>
<li>https://grafana.com/docs/loki/latest/logql/log_queries/</li>
<li>https://stackoverflow.com/questions/69761162/loki-display-log-message-and-extra-fields-separately/70000941#70000941</li>
</ul>
<h2>Line Format</h2>
<p>Include the stacktrace if the key is present</p>
<pre class="codehilite"><code>{container=&quot;my-service&quot;} |= `` | json | line_format `{{.message}} {{if .stacktrace }} {{- .stacktrace -}} {{else}} {{- &quot;-&quot; -}} {{end}}`
</code></pre>

<ul>
<li>https://stackoverflow.com/a/69976898</li>
</ul>
<h2>Metric Queries</h2>
<p>Count log events over the given grafana timefilter and sum by pod:</p>
<pre class="codehilite"><code>sum by (app)(count_over_time({app=~&quot;my-service&quot;} | json | line_format &quot;{{.log}}&quot; |~ &quot;Unable to acquire&quot;[$__interval]))
</code></pre></div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>