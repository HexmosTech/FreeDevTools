<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Readme</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Readme</h1>
        </div>
        <div class="content">
            <div class="markdown-content"><h2>Examples</h2>
<ul>
<li>https://gist.github.com/ruanbekker/c6fa9bc6882e6f324b4319c5e3622460</li>
<li>https://sbcode.net/grafana/install-promtail-service/</li>
<li>https://www.bookstack.cn/read/loki/clients-promtail-pipelines.md</li>
<li>https://github.com/grafana/loki/issues/333#issuecomment-570651075 (parsing labels from log tag)</li>
<li>https://docs.docker.com/config/containers/logging/configure/      (^ related) </li>
<li>https://github.com/grafana/loki/issues/775#issuecomment-568814165 (create labels from filename)</li>
<li>https://www.gitmemory.com/issue/grafana/loki/748/534945463 (drop logs from something)</li>
<li>https://github.com/cyriltovena/loki/blob/master/docs/clients/promtail/stages/match.md#example (drop logs from match)</li>
<li>https://www.youtube.com/watch?v=bIAC0uQee0k (using promtail with loki)</li>
<li>https://grafana.com/docs/loki/latest/clients/promtail/scraping/</li>
<li>https://grafana.com/blog/2020/07/13/loki-tutorial-how-to-set-up-promtail-on-aws-ec2-to-find-and-analyze-your-logs/</li>
<li>https://gist.github.com/cspinetta/41db2cc7f03a5af49e1b1cfe68d1fea4 (promtail pipeline templating)</li>
</ul>
<h2>Current Issues</h2>
<ul>
<li>https://github.com/grafana/loki/issues/74 (multi-line)</li>
<li>https://github.com/grafana/loki/issues/1880 (malformed logs with slashes)</li>
</ul>
<h2>LogQL</h2>
<ul>
<li>https://github.com/grafana/loki/blob/master/docs/logql.md</li>
</ul>
<h2>Pipelines</h2>
<p>More Info: 
  - https://github.com/grafana/loki/blob/master/docs/clients/promtail/pipelines.md
  - https://github.com/grafana/loki/blob/master/docs/clients/promtail/stages/template.md</p>
<h3>Transform</h3>
<blockquote>
<p>The pipeline example below, takes the current value of level from the extracted map and converts its value to be all lowercase. For example, if the extracted map contained level with a value of INFO, this pipeline would change its value to info"</p>
</blockquote>
<p>Pipeline Transform example, change uppercase values to lowercase (INFO to info):</p>
<pre class="codehilite"><code>scrape_configs:
  - job_name: app1
    static_configs:
    - targets:
        - localhost
      labels:
        job: app1
        environment: production
        host: app1.mydomain.com
        service: app1
        __path__: /var/log/app1_*.log
    pipeline_stages:
    - match:
        selector: '{service=&quot;app1&quot;}'
        stages:
        - regex:
            expression: &quot;(?P&lt;level&gt;(INFO|WARNING|ERROR))(.*)&quot;
        - template:
            source: level
            template: '{{ ToLower .Value }}'
        - labels:
            level:
</code></pre>

<p>Convert from stdout to info, stderr to error:</p>
<pre class="codehilite"><code>  pipeline_stages:
  - regex:
      expression: '(?P&lt;level&gt;(stdout|stderr))'

  - template:
      source: level
      template: '{{ if eq .Value &quot;stdout&quot; }}{{ Replace .Value &quot;stdout&quot; &quot;info&quot; -1 }}{{ else if eq .Value &quot;stderr&quot; }}{{ Replace .Value &quot;stderr&quot; &quot;error&quot; -1 }}{{ .Value }}{{ end }}'
</code></pre>

<h3>Drop</h3>
<p>In this scenario, we want to drop specific logs to not appear in loki</p>
<p>Ref: https://github.com/cyriltovena/loki/blob/master/docs/clients/promtail/stages/match.md#example</p>
<pre class="codehilite"><code>- job_name: qa/docker
  entry_parser: raw
  static_configs:
  - targets:
      - localhost
    labels:
      job: preprod/docker
      service: app1
      __path__: /var/lib/docker/containers/*/*-json.log

scrape_configs:
  pipeline_stages:
  - match:
      pipeline_name: 'drop_elb_healthchecks'
      selector: '{service=&quot;app1&quot;} |= &quot;ELB-HealthChecker&quot;'
      action: drop

  - match:
      pipeline_name: 'drop_ecs_agent_logs'
      selector: '{service=&quot;app1&quot;} |~ &quot;.*(Managed task|Task engine).*&quot; |~ &quot;arn:aws:ecs:eu-west-1:000000000000:task&quot;'
      #selector: '{service=&quot;app1&quot;} |~ &quot;.*Managed task.*&quot; |= &quot;eu-west-1:000000000000:task&quot;'
      action: drop

  - match:
      pipeline_name: 'drop_blackbox_exporter_checks'
      selector: '{service=&quot;app1&quot;} |~ &quot;.*Go-http-client.*&quot; |= &quot;GET /login&quot;'
      action: drop
</code></pre>

<h3>Docker log opt tag</h3>
<pre class="codehilite"><code>scrape_configs:

- job_name: system
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs
      __path__: /var/log/*log

- job_name: containers
  entry_parser: raw

  static_configs:
  - targets:
      - localhost
    labels:
      job: containerlogs
      __path__: /var/lib/docker/containers/*/*log

  # --log-opt tag=&quot;{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}&quot;
  pipeline_stages:

  - json:
      expressions:
        stream: stream
        attrs: attrs
        tag: attrs.tag

  - regex:
      expression: (?P&lt;image_name&gt;(?:[^|]*[^|])).(?P&lt;container_name&gt;(?:[^|]*[^|])).(?P&lt;image_id&gt;(?:[^|]*[^|])).(?P&lt;container_id&gt;(?:[^|]*[^|]))
      source: &quot;tag&quot;

  - labels:
      tag:
      stream:
      image_name:
      container_name:
      image_id:
      container_id:
</code></pre>

<h3>Containers with File Workaround</h3>
<p>Taken from <a href="https://github.com/grafana/loki/issues/333#issuecomment-637401983">here</a></p>
<pre class="codehilite"><code>docker ps --format '- targets: [&quot;{{.ID}}&quot;]\n  labels:\n    container_name: &quot;{{.Names}}&quot;' &gt; /etc/promtail/promtail-targets.yaml
</code></pre>

<pre class="codehilite"><code>scrape_configs:
- job_name: containers
  entry_parser: docker
  file_sd_configs:
  - files:
    - /etc/promtail/promtail-targets.yaml
  relabel_configs:
  - source_labels: [__address__]
    target_label: container_id
  - source_labels: [container_id]
    target_label: __path__
    replacement: /var/lib/docker/containers/$1*/*.log
</code></pre>

<h3>JSON Nested Pipeline</h3>
<p>We want to extract the <code>info</code> key from the log line:</p>
<pre class="codehilite"><code>{&quot;log&quot;: {\&quot;level\&quot;: \&quot;info\&quot;, \&quot;timestamp\&quot;:\&quot;2023-02-26 21:55:24.702\&quot;}}
</code></pre>

<p>The config:</p>
<pre class="codehilite"><code>    pipelineStages:
      - cri: {}
      - multiline:
          firstline: ^\d{4}-\d{2}-\d{2} \d{1,2}:\d{2}:\d{2},\d{3}
          max_wait_time: 3s
      - json:
          expressions:
            log:
      - json:
          expressions:
            level:
          source: log
      - labels:
          level:
</code></pre>

<p>Referenced from:
- https://grafana.com/docs/loki/latest/clients/promtail/stages/json/#using-extracted-data</p>
<p>Remap json values and set the output source:
- https://stackoverflow.com/a/62228397</p></div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>