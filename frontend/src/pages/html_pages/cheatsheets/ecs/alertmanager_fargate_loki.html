<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alertmanager Fargate Loki Configuration - AWS ECS Deployment</title>
    <meta name="description" content="Configure Alertmanager to run on AWS Fargate with Loki for centralized logging. This guide provides a sample ECS task definition for seamless integration.">
    <meta name="keywords" content="Alertmanager, Fargate, Loki, AWS ECS, container logs, log configuration, fluent-bit, firelens, DevOps tools, monitoring, alerting">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://your-domain.com/ecs/alertmanager_fargate_loki.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-domain.com/ecs/alertmanager_fargate_loki.html">
    <meta property="og:title" content="Alertmanager Fargate Loki Configuration - AWS ECS Deployment">
    <meta property="og:description" content="Configure Alertmanager to run on AWS Fargate with Loki for centralized logging. This guide provides a sample ECS task definition for seamless integration.">
    <meta property="og:image" content="https://your-domain.com/path/to/your/og-image.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://your-domain.com/ecs/alertmanager_fargate_loki.html">
    <meta name="twitter:title" content="Alertmanager Fargate Loki Configuration - AWS ECS Deployment">
    <meta name="twitter:description" content="Configure Alertmanager to run on AWS Fargate with Loki for centralized logging. This guide provides a sample ECS task definition for seamless integration.">
    <meta name="twitter:image" content="https://your-domain.com/path/to/your/twitter-image.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Alertmanager Fargate Loki Deployment Configuration</h1>
        </div>
        <div class="content">
            <div class="markdown-content">
                <p>This document outlines a sample AWS Elastic Container Service (ECS) task definition for deploying Alertmanager on AWS Fargate, integrated with Grafana Loki for centralized log management. This configuration leverages the power of Fargate for serverless container orchestration and Loki for efficient log aggregation.</p>

                <h2>Alertmanager Container Configuration</h2>
                <p>The primary container definition for Alertmanager specifies its image, resource allocation, port mappings, and environment variables. Crucially, it includes secrets for webhook URLs and API keys, ensuring secure communication with external services like Slack and Opsgenie.</p>

                <h2>Log Configuration with AWS FireLens and Fluent Bit</h2>
                <p>A key aspect of this setup is the integration with AWS FireLens and Fluent Bit. The <code>logConfiguration</code> within the Alertmanager container is set to <code>awsfirelens</code>, directing logs to the log router. The <code>log_router</code> container, using the <code>grafana/fluent-bit-plugin-loki</code> image, is configured to send these logs to a specified Loki endpoint. This ensures that all container logs are captured and sent to Loki for analysis and monitoring.</p>

                <h3>Key Log Configuration Options</h3>
                <ul>
                    <li><code>logDriver: awsfirelens</code>: Directs logs to the FireLens log router.</li>
                    <li><code>secretOptions</code>: Securely retrieves the Loki log URL from AWS Systems Manager Parameter Store.</li>
                    <li><code>options</code>: Configures Fluent Bit with specific settings like log driver name, label configuration, and key removal for cleaner log data.</li>
                    <li><code>enable-ecs-log-metadata: "true"</code>: Injects ECS task metadata into logs for better context.</li>
                </ul>

                <h2>AWS Fargate and Network Mode</h2>
                <p>The task definition specifies <code>FARGATE</code> as a required compatibility and uses the <code>awsvpc</code> network mode, which is standard for Fargate deployments. This provides each task with its own elastic network interface and IP address, enhancing security and network isolation.</p>

                <h2>IAM Roles and Permissions</h2>
                <p>Appropriate IAM roles, such as <code>ecsTaskExecutionRole</code> and <code>ecs-taskrole-tooling</code>, are essential for the ECS tasks to pull images from ECR, access SSM parameters, and perform other necessary AWS operations. Ensure these roles have the required permissions.</p>

                <p>This configuration provides a robust foundation for deploying Alertmanager with centralized logging on AWS Fargate, enabling effective monitoring and alerting for your applications.</p>

                <pre><code class="language-json">{
  "family": "alertmanager",
  "executionRoleArn":"arn:aws:iam::xxxxxxxxxxxx:role/ecsTaskExecutionRole",
  "taskRoleArn":"arn:aws:iam::xxxxxxxxxxxx:role/ecs-taskrole-tooling",
  "cpu": "256",
  "memory": "512",
  "networkMode": "awsvpc",
  "requiresCompatibilities": [
    "FARGATE"
  ],
  "containerDefinitions": [
    {
      "name": "alertmanager",
      "image": "xxxxxxxxxxxx.dkr.ecr.eu-west-1.amazonaws.com/alertmanager:0.24.0",
      "memoryReservation": 64,
      "portMappings":[
        {
          "protocol":"tcp",
          "containerPort":9093,
          "hostPort":9093
        }
      ],
      "environment": [
        {
          "name": "SLACK_ICON",
          "value": ":fire:"
        }
      ],
      "secrets": [
        {
          "name": "SLACK_WEBHOOK_URL",
          "valueFrom": "arn:aws:ssm:eu-west-1:xxxxxxxxxxxx:parameter/prometheus/prod/SLACK_WEBHOOK_URL"
        },
        {
          "name": "GENERAL_OPSGENIE_API_KEY",
          "valueFrom": "arn:aws:ssm:eu-west-1:xxxxxxxxxxxx:parameter/prometheus/prod/GENERAL_OPSGENIE_API_KEY"
        },
        {
          "name": "DEVOPS_OPSGENIE_API_KEY",
          "valueFrom": "arn:aws:ssm:eu-west-1:xxxxxxxxxxxx:parameter/prometheus/prod/DEVOPS_OPSGENIE_API_KEY"
        },
        {
          "name": "ALERTMANAGER_URL",
          "valueFrom": "arn:aws:ssm:eu-west-1:xxxxxxxxxxxx:parameter/prometheus/prod/ALERTMANAGER_URL"
        }
      ],
      "essential": true,
      "logConfiguration": {
        "logDriver": "awsfirelens",
        "secretOptions": [
          {
            "name": "Url",
            "valueFrom": "arn:aws:ssm:eu-west-1:xxxxxxxxxxxx:parameter/prometheus/prod/LOKI_LOG_URL"
          }
        ],
        "options": {
          "Name": "grafana-loki",
          "Labels": "{job=\"container-logs\"}",
          "RemoveKeys": "container_id,ecs_task_arn",
          "LabelKeys": "container_name,ecs_task_definition,source,ecs_cluster",
          "LineFormat": "key_value"
        }
      }
    },
    {
      "essential": true,
      "image": "grafana/fluent-bit-plugin-loki:2.5.0-amd64",
      "name": "log_router",
      "firelensConfiguration": {
        "type": "fluentbit",
        "options": {
          "enable-ecs-log-metadata": "true"
        }
      },
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/devops-tools-cluster/sidecars",
          "awslogs-region": "eu-west-1",
          "awslogs-create-group": "true",
          "awslogs-stream-prefix": "alertmanager-firelens"
        }
      },
      "memoryReservation": 50
    }
  ]
}</code></pre>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>