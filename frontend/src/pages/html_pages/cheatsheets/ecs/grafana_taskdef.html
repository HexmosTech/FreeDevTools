<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafana Task Definition - AWS ECS Configuration</title>
    <meta name="description" content="Configure your Grafana Task Definition for AWS ECS. This guide provides a detailed JSON example for setting up Grafana with EFS volumes, environment variables, and secrets.">
    <meta name="keywords" content="Grafana, AWS ECS, Task Definition, Docker, Container, EFS, Provisioning, Dashboards, Configuration, JSON, Cloud">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://your-domain.com/ecs/grafana_taskdef.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-domain.com/ecs/grafana_taskdef.html">
    <meta property="og:title" content="Grafana Task Definition - AWS ECS Configuration">
    <meta property="og:description" content="Configure your Grafana Task Definition for AWS ECS. This guide provides a detailed JSON example for setting up Grafana with EFS volumes, environment variables, and secrets.">
    <meta property="og:image" content="https://your-domain.com/path/to/your/grafana-ecs-og-image.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://your-domain.com/ecs/grafana_taskdef.html">
    <meta name="twitter:title" content="Grafana Task Definition - AWS ECS Configuration">
    <meta name="twitter:description" content="Configure your Grafana Task Definition for AWS ECS. This guide provides a detailed JSON example for setting up Grafana with EFS volumes, environment variables, and secrets.">
    <meta name="twitter:image" content="https://your-domain.com/path/to/your/grafana-ecs-twitter-image.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Grafana Task Definition for AWS ECS</h1>
        </div>
        <div class="content">
            <div class="markdown-content">
                <h2>Understanding the Grafana ECS Task Definition</h2>
                <p>This document outlines a comprehensive AWS Elastic Container Service (ECS) Task Definition for deploying Grafana. The provided JSON configuration is designed for robustness and flexibility, enabling persistent storage for Grafana data, provisioning configurations, and dashboards using Amazon Elastic File System (EFS). It also details essential environment variables for regional settings, AWS integration, plugin installations, and server configurations, along with secure handling of AWS credentials via AWS Systems Manager Parameter Store.</p>

                <h2>Key Configuration Components</h2>
                <p>The Grafana Task Definition is structured to manage the Grafana container effectively within an AWS ECS environment. It specifies the Docker image to use, resource allocations, port mappings, and critical environment variables. The configuration includes:</p>
                <ul>
                    <li><strong>Container Name and Image:</strong> Identifies the Grafana container and its version (e.g., <code>grafana/grafana:7.3.4</code>).</li>
                    <li><strong>Resource Allocation:</strong> Sets memory reservation (e.g., <code>512MB</code>).</li>
                    <li><strong>Port Mapping:</strong> Configures the container port (<code>3000</code>) to be accessible.</li>
                    <li><strong>Environment Variables:</strong> Crucial for setting up Grafana's behavior, including AWS region, profile, provisioning paths, and plugin installations.</li>
                    <li><strong>Secrets Management:</strong> Securely injects AWS access keys and secret access keys from AWS Systems Manager Parameter Store.</li>
                    <li><strong>Volume Mounts:</strong> Connects EFS volumes to specific paths within the container for persistent data storage.</li>
                </ul>

                <h2>EFS Volume Configuration for Grafana</h2>
                <p>Persistent storage is vital for Grafana to retain its data, configurations, and dashboards across container restarts or updates. This Task Definition utilizes EFS volumes for:</p>
                <ul>
                    <li><strong>Grafana Data:</strong> Mounted at <code>/var/lib/grafana</code> for storing databases, sessions, and other runtime data.</li>
                    <li><strong>Grafana Provisioning:</strong> Mounted at <code>/etc/grafana/provisioning</code> for custom configuration files, data sources, and dashboards.</li>
                    <li><strong>Grafana Dashboards:</strong> Mounted at <code>/etc/grafana/dashboards</code> for loading pre-defined dashboard JSON files.</li>
                </ul>
                <p>Each EFS volume is configured with a specific <code>fileSystemId</code> and <code>rootDirectory</code>, ensuring data is correctly mapped.</p>

                <h2>Security and Best Practices</h2>
                <p>This Task Definition incorporates security best practices by using IAM roles for the ECS task execution and the task itself, granting necessary permissions without hardcoding credentials directly into the container image. Sensitive information like AWS access keys and secret access keys are managed through AWS Systems Manager Parameter Store, accessed securely via the <code>secrets</code> block. The use of <code>privileged: true</code> should be reviewed based on specific security requirements, as it grants extended privileges to the container.</p>

                <p>For more information on configuring Grafana with AWS ECS, refer to the official Grafana documentation and AWS ECS documentation.</p>
                <p><a href="https://grafana.com/docs/" target="_blank">Grafana Documentation</a> | <a href="https://docs.aws.amazon.com/ecs/latest/developerguide/task_definitions.html" target="_blank">AWS ECS Task Definitions</a> | <a href="https://docs.aws.amazon.com/efs/latest/ug/mount-fs-nfs-cli.html" target="_blank">AWS EFS Mount Configuration</a></p>

                <pre><code class="language-json">{
  "family": "grafana",
  "executionRoleArn":"arn:aws:iam::000000000000:role/ecs-exec-role",
  "taskRoleArn":"arn:aws:iam::000000000000:role/ecs-task-role",
  "containerDefinitions": [
    {
      "name": "grafana",
      "image": "grafana/grafana:7.3.4",
      "memoryReservation": 512,
      "portMappings":[
        {
          "protocol":"tcp",
          "containerPort":3000,
          "hostPort":0
        }
      ],
      "environment": [
        {
          "name": "AWS_DEFAULT_REGION",
          "value": "eu-west-1"
        },
        {
          "name": "GF_AWS_PROFILES",
          "value": "default"
        },
        {
          "name": "GF_AWS_default_REGION",
          "value": "eu-west-1"
        },
        {
          "name": "GF_PATHS_PROVISIONING",
          "value": "/etc/grafana/provisioning"
        },
        {
          "name": "GF_INSTALL_PLUGINS",
          "value": "grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel,camptocamp-prometheus-alertmanager-datasource"
        },
        {
          "name": "GF_SERVER_ROOT_URL",
          "value": "https://grafana.domain.com"
        },
        {
          "name": "GF_SERVER_DOMAIN",
          "value": "domain.com"
        }
      ],
      "secrets": [
        {
          "valueFrom": "arn:aws:ssm:eu-west-1:000000000000:parameter/grafana/prod/AWS_ACCESS_KEY_ID",
          "name": "GF_AWS_default_ACCESS_KEY_ID"
        },
        {
          "valueFrom": "arn:aws:ssm:eu-west-1:000000000000:parameter/grafana/prod/AWS_SECRET_ACCESS_KEY",
          "name": "GF_AWS_default_SECRET_ACCESS_KEY"
        }
      ],
      "essential": true,
      "privileged": true,
      "mountPoints": [
        {
          "containerPath": "/var/lib/grafana",
          "sourceVolume": "grafana-data",
          "readOnly": false
        },
        {
          "containerPath": "/etc/grafana/provisioning",
          "sourceVolume": "grafana-provisioning",
          "readOnly": false
        },
        {
          "containerPath": "/etc/grafana/dashboards",
          "sourceVolume": "grafana-dashboards",
          "readOnly": false
        }
      ]
    }
  ],
  "volumes": [
    {
      "name": "grafana-data",
      "efsVolumeConfiguration": {
         "fileSystemId": "fs-00000000",
         "rootDirectory": "/grafana/data"
      }
    },
    {
      "name": "grafana-provisioning",
      "efsVolumeConfiguration": {
         "fileSystemId": "fs-00000000",
         "rootDirectory": "/grafana/provisioning"
      }
    },
    {
      "name": "grafana-dashboards",
      "efsVolumeConfiguration": {
         "fileSystemId": "fs-00000000",
         "rootDirectory": "/grafana/dashboards"
      }
    }
  ]
}
</code></pre>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>