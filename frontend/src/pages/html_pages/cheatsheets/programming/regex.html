<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Readme</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Readme</h1>
        </div>
        <div class="content">
            <div class="markdown-content"><h1>regex</h1>
<h2>Tools:</h2>
<ul>
<li>https://regex101.com/</li>
</ul>
<h2>Sources</h2>
<ul>
<li>https://groups.google.com/forum/#!topic/fluentd/arfxLzfU_5c</li>
</ul>
<h2>Patterns</h2>
<p>string:</p>
<pre class="codehilite"><code>10.0.2.2 - - [19/Jul/2019 10:02:48] &quot;GET /?ccnum=1234 HTTP/1.1&quot; 200 -
</code></pre>

<p>match ccnum value:</p>
<pre class="codehilite"><code>ccnum=\d+
</code></pre>

<p>match everything until ccnum=</p>
<pre class="codehilite"><code>\d+.\d+.\d+.\d+ .* \[\d{2}\/\w+\/\d{4}.*\d{2}:\d{2}:\d{2}\].*&quot;\w+.*\/?ccnum=\d+
</code></pre>

<p>Log:</p>
<pre class="codehilite"><code>2020-04-21 08:37:04 172.16.1.1 - - [21/Apr/2020:08:37:04 +0200] &quot;POST /path?foo=bar HTTP/1.1&quot; 200 540 &quot;http://localhost/bar/&quot; &quot;Mozilla/5.0 (Linux; Android 10; One Build/One-Boo; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/81.0.4044.111 Mobile Safari/537.36&quot; &quot;1.1.1.1&quot;
</code></pre>

<p>Date:</p>
<pre class="codehilite"><code>.[0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9] [0-9][0-9]:[0-9][0-9]:[0-9][0-9]
.\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}
</code></pre>

<p>IP Address <code>10.173.4.20</code>:</p>
<pre class="codehilite"><code> \d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}
</code></pre>

<p>Apache / Nginx Log:</p>
<pre class="codehilite"><code>172.128.80.109 - Bins5273 656 [2019-05-03T13:11:48-04:00] &quot;PUT /mesh&quot; 406 10272

^([\w\.]+) - ([\w]+) ([\d]+) \[(.*)\] &quot;([\w]+) (.*)&quot; ([\d]+) ([\d]+)$
</code></pre>

<pre class="codehilite"><code>127.0.0.1 - - [21/Apr/2020:11:47:07 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;http://&quot; &quot;curl/7.58.0&quot;

^([\w\.]+) ([^ ]*) ([^ ]*) \[(.*)\] &quot;(\S+)(?: +([^ ]*) +\S*)?&quot; ([\d]+) ([\d]+) &quot;([^&quot;]*)&quot; &quot;([^\&quot;]*)&quot;?
</code></pre>

<pre class="codehilite"><code>127.0.0.1 - - [21/Apr/2020:11:47:07 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;http://&quot; &quot;curl/7.58.0&quot;

^([\w\.]+) - ([^ ]*) \[(.*)\] &quot;([^ ]*) ([^ ]*) ([^ ]*)&quot; ([\d]+) ([\d]+) &quot;([^&quot;]*)&quot; &quot;([^\&quot;]*)&quot;?
</code></pre>

<pre class="codehilite"><code>127.0.0.1 - - [21/Apr/2020:11:47:07 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;http://&quot; &quot;curl/7.58.0&quot; &quot;10.20.30.1&quot;

^([\w\.]+) - ([^ ]*) \[(.*)\] &quot;([^ ]*) ([^ ]*) ([^ ]*)&quot; ([\d]+) ([\d]+) &quot;([^&quot;]*)&quot; &quot;([^\&quot;]*)&quot; &quot;([\w\.]+)&quot;?
</code></pre>

<p>Assigning it labels with things like vector, promtail:</p>
<pre class="codehilite"><code>^(?P&lt;remote_ip&gt;[\w\.]+) - (?P&lt;user&gt;[^ ]*) \[(?P&lt;timestamp&gt;.*)\] &quot;(?P&lt;method&gt;[^ ]*) (?P&lt;request_url&gt;[^ ]*) (?P&lt;request_http_protocol&gt;[^ ]*)&quot; (?P&lt;status&gt;[\d]+) (?P&lt;bytes_out&gt;[\d]+) &quot;(?P&lt;http_referer&gt;[^&quot;]*)&quot; &quot;(?P&lt;user_agent&gt;[^&quot;]*)&quot; &quot;(?P&lt;client_ip&gt;[\w\.]+)&quot;?
</code></pre>

<p>Full match value between brackets:</p>
<pre class="codehilite"><code>this is [foo] bar
\(?\w+(?=\]):?
</code></pre>

<p>using positive lookbehind:</p>
<pre class="codehilite"><code>this is [foo] bar
(?&lt;=\[)[\w+.-]*
</code></pre>

<p>Match everything up until <code>abc</code> but dont include it:</p>
<pre class="codehilite"><code>/^(.*?)abc/
</code></pre>

<p>Or numbers:</p>
<pre class="codehilite"><code>/^(.*?)[0-9]/
</code></pre>

<p>This example is with Loki using Regex, the line:</p>
<pre class="codehilite"><code>1.2.3.4 - - [23/Nov/2020:17:31:00 +0200] &quot;POST /foo/bar?token=x.x HTTP/1.1&quot; 201 83 &quot;http://localhost/&quot; &quot;Mozilla/5.0 (Linux; Android 10; Nokia 6.1 Build/x.x.x; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/x.0.x.110 Mobile Safari/537.36&quot; &quot;1.2.3.4&quot;
</code></pre>

<p>The regex:</p>
<pre class="codehilite"><code>| regexp &quot;(?P&lt;ip&gt;\\d+.\\d+.\\d+.\\d+) (.*) (.*) (?P&lt;date&gt;\\[(.*)\\]) (\&quot;)(?P&lt;verb&gt;(\\w+)) (?P&lt;request_path&gt;([^\&quot;]*)) (?P&lt;http_ver&gt;([^\&quot;]*))(\&quot;) (?P&lt;status_code&gt;\\d+) (?P&lt;bytes&gt;\\d+) (\&quot;)(?P&lt;referrer&gt;(([^\&quot;]*)))(\&quot;) (\&quot;)(?P&lt;user_agent&gt;(([^\&quot;]*)))(\&quot;)&quot;
</code></pre></div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>