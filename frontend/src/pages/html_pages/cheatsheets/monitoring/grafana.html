<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Readme</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Readme</h1>
        </div>
        <div class="content">
            <div class="markdown-content"><h1>Grafana Cheatsheet</h1>
<ul>
<li><a href="#dashboards">Dashboards</a></li>
<li><a href="#tutorials">Tutorials</a></li>
<li><a href="#datasource-cloudwatch">CloudWatch</a></li>
<li><a href="#datasource-cloudwatch">CloudWatch Datasource</a></li>
<li><a href="#variables-for-cloudWatch">CloudWatch Variables</a></li>
<li><a href="#cloudwatch-queries">CloudWatch Queries</a></li>
<li><a href="">Elasticsearch</a></li>
<li><a href="#datasource-elasticsearch">Elasticsearch Datasource</a></li>
<li><a href="#variables-for-elasticsearch">Elasticsearch Variables</a></li>
<li><a href="">MySQL</a></li>
<li><a href="#datasource-mysql">MySQL Datasource</a></li>
<li><a href="#variables-for-mysql">MySQL Variables</a></li>
<li><a href="#mysql-queries">MySQL Queries</a></li>
<li><a href="#prometheus-datasource">Prometheus</a></li>
<li><a href="#prometheus-datasource">Prometheus Datasource</a></li>
<li><a href="#prometheus-variables">Prometheus Variables</a></li>
<li><a href="#prometheus-queries">Prometheus Queries</a></li>
<li><a href="#tables-for-prometheus">Prometheus Tables</a></li>
<li><a href="">Loki</a></li>
<li><a href="#loki-datasource">Loki Datasource</a></li>
<li><a href="#loki-variables">Loki Variables</a></li>
<li><a href="#loki-queries">Loki Queries</a></li>
</ul>
<h2>Dashboards</h2>
<ul>
<li><a href="https://grafana.com/grafana/dashboards/12019">Loki</a></li>
<li><a href="https://grafana.com/grafana/dashboards/4701">JVM Micrometer</a></li>
</ul>
<h2>Tutorials</h2>
<ul>
<li><a href="https://sbcode.net/grafana/">sbcode</a></li>
</ul>
<h2>Datasource: CloudWatch</h2>
<h3>Variables for CloudWatch</h3>
<p>Docs: </p>
<ul>
<li>https://grafana.com/docs/grafana/latest/features/datasources/cloudwatch/</li>
<li>https://grafana.com/docs/grafana/latest/datasources/aws-cloudwatch/#query-variable</li>
</ul>
<p>Overview:</p>
<p>The <code>Name</code> field allows you to use it as a variable, example:</p>
<pre class="codehilite"><code>Name: region
Type: Query
Label: Region
Query: regions()
</code></pre>

<p>Will show as Region in grafana, and you will be able to use a variable <code>$region</code> to select the value from the <code>Region</code> selector.</p>
<p>AWS Regions:</p>
<pre class="codehilite"><code>Query: regions()
</code></pre>

<p>AutoScaling Group:</p>
<pre class="codehilite"><code>Query: dimension_values($region,AWS/EC2,CPUUtilization,AutoScalingGroupName)
</code></pre>

<p>EC2 Instance Tag Names:</p>
<pre class="codehilite"><code>Name: instancename
Query: ec2_instance_attribute($region, Tags.Name, {})
</code></pre>

<p>EC2 Instance ID from Tag Name:</p>
<pre class="codehilite"><code>Name: instanceid
Query: ec2_instance_attribute($region, InstanceId, {&quot;tag:Name&quot;: [&quot;$instancename&quot;]})
</code></pre>

<p>EC2 InstanceId from Tag Name (filtered):</p>
<pre class="codehilite"><code>Query: ec2_instance_attribute(eu-west-1, Tags.Name, {&quot;tag:Name&quot;:[&quot;prod-*&quot;]}) 
</code></pre>

<p>EC2 InstanceId from Tag Name (filtered):</p>
<pre class="codehilite"><code>Query: ec2_instance_attribute(eu-west-1, InstanceId, {&quot;tag:ASG&quot;:[&quot;my-app-asg&quot;]}) 
</code></pre>

<p>EBS VolumeId from InstanceId:</p>
<pre class="codehilite"><code>Query: ebs_volume_ids($region, $instanceid)
</code></pre>

<p>ECS Cluster Name:</p>
<pre class="codehilite"><code>Query: dimension_values($region,AWS/ECS,CPUUtilization,ClusterName)
</code></pre>

<p>ECS Service Name:</p>
<pre class="codehilite"><code>Query: dimension_values($region,AWS/ECS,CPUUtilization,ServiceName)
</code></pre>

<p>RDS Cluster Name:</p>
<pre class="codehilite"><code>Query: dimension_values($region,AWS/RDS,CPUUtilization,DBClusterIdentifier)
</code></pre>

<p>RDS Instance Name:</p>
<pre class="codehilite"><code>Query: dimension_values($region,AWS/RDS,CPUUtilization,DBInstanceIdentifier)
</code></pre>

<p>CloudWatch Logs, LogGroup Names:</p>
<pre class="codehilite"><code>Query: dimension_values($region,AWS/Logs, IncomingBytes,LogGroupName)
</code></pre>

<h3>CloudWatch Queries</h3>
<p>Using CloudWatch Logs <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html">Query Syntax</a>:</p>
<pre class="codehilite"><code>fields @timestamp, @message, @log, @logStream
| sort @timestamp desc
| limit 30
</code></pre>

<h2>Datasource: Elasticsearch</h2>
<ul>
<li><a href="https://grafana.com/blog/2016/03/09/how-to-effectively-use-the-elasticsearch-data-source-in-grafana-and-solutions-to-common-pitfalls/">how-to-effectively-use-the-elasticsearch-data-source-in-grafana-and-solutions-to-common-pitfalls/</a></li>
</ul>
<h3>Variables for Elasticsearch</h3>
<p>Domain Name:</p>
<pre class="codehilite"><code>{&quot;find&quot;: &quot;terms&quot;, &quot;field&quot;: &quot;domain_name.keyword&quot;}
</code></pre>

<p>Domain Name (Filtered Results):</p>
<pre class="codehilite"><code>{&quot;find&quot;: &quot;terms&quot;, &quot;field&quot;: &quot;domain_name.keyword&quot;, &quot;query&quot;: &quot;domain_name: *.mydomain.com&quot;}
</code></pre>

<p>2 Variables, ALB and Domain Name (domain name results filtered based on the alb that you select / should be in correct order):</p>
<pre class="codehilite"><code>alb_name:
{&quot;find&quot;: &quot;terms&quot;, &quot;field&quot;: &quot;alb_name.keyword&quot;}

domain_name:
{&quot;find&quot;: &quot;terms&quot;, &quot;field&quot;: &quot;domain_name.keyword&quot;, &quot;query&quot;: &quot;domain_name: *.mydomain.com AND alb_name:$alb_name.keyword&quot;}
</code></pre>

<h2>Datasource: MySQL</h2>
<h3>Variables for MySQL</h3>
<p>Name: <code>status</code>
Label: <code>Status</code>
Type: <code>Query</code>
Datasource: <code>MySQL</code>
Query: <code>SELECT status FROM mytable</code></p>
<p>To use a regex to filter out any NULLs:</p>
<pre class="codehilite"><code># this will only return results with letters/numbers
/([a-zA-Z0-9\.]+)/  
</code></pre>

<h3>Queries for MySQL</h3>
<p>Gauge:</p>
<pre class="codehilite"><code>SELECT 
country,
SUM(cnt) AS total,
NOW() AS time
FROM mytable
WHERE status = ${status}
GROUP BY country
</code></pre>

<p>Bar Gauge:</p>
<pre class="codehilite"><code>SELECT NOW() AS time, count(*) as cnt, CONCAT(name,', ',surname,', ',country) AS entity FROM mytable 
WHERE status = &quot;PENDING&quot;
AND name REGEXP '${name:pipe}' 
AND surname REGEXP '${surname:pipe}'
AND country REGEXP '${country:pipe}'
GROUP BY CONCAT(name,', ',surname,', ',country)
</code></pre>

<p>Table Panel:</p>
<pre class="codehilite"><code>SELECT name, surname, country, status, pending_time from mytable
WHERE status = &quot;PENDING&quot;
AND name REGEXP '${name:pipe}' 
AND surname REGEXP '${surname:pipe}'
AND country REGEXP '${country:pipe}'
</code></pre>

<h2>Prometheus: Datasource</h2>
<h3>Variables for Prometheus</h3>
<p><strong>Basics</strong></p>
<p>Lets say you want to have a variable defined <code>jobs</code> and the metric looks like:</p>
<pre class="codehilite"><code>up{cluster_name=&quot;cluster-a&quot;,instance=&quot;1.1.1.1:443&quot;,job=&quot;container-metrics&quot;}
up{cluster_name=&quot;cluster-b=&quot;,instance=&quot;1.1.1.1:443&quot;,job=&quot;node-metrics&quot;}
</code></pre>

<p>Add a variable with the following:</p>
<pre class="codehilite"><code>Name: jobs
Label: Jobs
Query: label_values(up, job)
Datasource: Prometheus
</code></pre>

<p>Which will produce <code>container-metrics</code> and <code>node-metrics</code> and in your dasboard query you can select them using:</p>
<pre class="codehilite"><code>up{job=~&quot;$job&quot;}
</code></pre>

<p><strong>Filtered</strong></p>
<p>Lets say you only want the variable results to display jobs from <code>cluster-b</code> and call it <code>cluster_b_jobs</code>:</p>
<pre class="codehilite"><code>label: cluster_b_jobs
label_values(up{cluster_name=&quot;cluster-b&quot;}, job)
</code></pre>

<p>Now we can also use that variable for something else to filter more, like <code>label_values(metric{jobs=~"$cluster_b_jobs"}, some_label)</code></p>
<p>You can use this to get environments, then filter on resources as example.</p>
<p><strong>Regex</strong></p>
<p>Let's say you have the following results for jobs:</p>
<pre class="codehilite"><code>qa/nginx
qa/app
qa/app-syslog
qa/app-deploy
prod/app
prod/app-syslog
prod/app-deploy
</code></pre>

<p>and you only want to display {env}/app,</p>
<p>The query: </p>
<pre class="codehilite"><code>label_values(labels, job)
</code></pre>

<p>The regex: </p>
<pre class="codehilite"><code>/^(.*app)/
</code></pre>

<p>which results in:</p>
<pre class="codehilite"><code>qa/app
prod/app
</code></pre>

<p>If you wanted everything after the <code>/</code>:</p>
<pre class="codehilite"><code>/.*(.*app.*).*/
</code></pre>

<p>which will result in:</p>
<pre class="codehilite"><code>app
app-syslog 
app-deploy
</code></pre>

<p>For a example where you want to return everything up until the numbers, example:</p>
<pre class="codehilite"><code>ecs-prod-app-10-container-12345
ecs-dev-app-12-container-12345
</code></pre>

<p>you can use:</p>
<pre class="codehilite"><code>/^(.*?)-[0-9]/
</code></pre>

<p>which will result in:</p>
<pre class="codehilite"><code>ecs-prod-app
ecs-dev-app
</code></pre>

<p>For Kubernetes namespaces:</p>
<p>Name: <code>container</code>
Label: <code>container</code>
Query: <code>kube_pod_container_info{namespace="$namespace"}</code>
Regex: <code>/.*container="([^"]*).*/</code>
Datasource: <code>Prometheus</code></p>
<p>For Kubernetes containers:</p>
<p>Name: <code>namespace</code>
Label: <code>namespace</code>
Query: <code>query_result(kube_namespace_labels)</code>
Regex: <code>/.*namespace="([^"]*).*/</code>
Datasource: <code>Prometheus</code></p>
<h3>Queries for Prometheus</h3>
<h3>Tables for Prometheus</h3>
<p>Using datalinks in grafana, to parse values in your url you can use <code>$__cell_0</code> and if you need to do some formatting you can use <code>${__cell_3:raw}</code>, like below:</p>
<pre class="codehilite"><code>https://gitlab.com/${__cell_3:raw}/-/pipelines/$__cell_7
</code></pre>

<p>Resources:
- https://grafana.com/docs/grafana/next/panels/configure-data-links/
- https://grafana.com/docs/grafana/latest/variables/advanced-variable-format-options/</p>
<h2>Loki Datasource</h2>
<h3>Variables for Loki</h3>
<p><strong>Basics: Jobs</strong></p>
<p>Lets say you want to have a variable defined <code>jobs</code> and the metric looks like:</p>
<pre class="codehilite"><code>label_values({job=~&quot;.+&quot;}, job)
</code></pre>

<p>Add a variable with the following:</p>
<pre class="codehilite"><code>Name: job
Label: Jobs
Query: label_values({job=~&quot;.+&quot;}, job)
Datasource: Loki
</code></pre>

<p>Which in my case will produce <code>systemd-logs</code> and <code>server-logs</code> and in your dasboard query you can select them using:</p>
<pre class="codehilite"><code>{job=~&quot;$job&quot;}
</code></pre>

<p><strong>Basics: Name</strong></p>
<p>Lets say you want to have a variable defined <code>name</code> and the metric looks like:</p>
<pre class="codehilite"><code>label_values({job=&quot;server-logs&quot;}, name)
</code></pre>

<p>Add a variable with the following:</p>
<pre class="codehilite"><code>Name: name
Label: Name
Query: label_values({job=&quot;server-logs&quot;}, name)
Datasource: Loki
</code></pre>

<p>Which in my case will produce <code>web-server-01</code> and <code>web-server-02</code> and in your dasboard query you can select them using:</p>
<pre class="codehilite"><code>{name=~&quot;$name&quot;}
</code></pre></div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>