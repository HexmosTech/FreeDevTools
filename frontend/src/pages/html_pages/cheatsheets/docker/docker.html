<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Readme</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Readme</h1>
        </div>
        <div class="content">
            <div class="markdown-content"><h1>Docker Cheatsheet</h1>
<p>If you can't find what you are looking for try my other sources:</p>
<ul>
<li><a href="https://wiki.ruanbekker.com/index.php/Category:Docker">wiki.ruanbekker.com:docker</a></li>
<li><a href="https://blog.ruanbekker.com/blog/categories/docker/">blog.ruanbekker.com:docker</a></li>
<li><a href="https://sysadmins.co.za/tag/docker/">sysadmins.co.za:docker</a></li>
</ul>
<p>Index:</p>
<ul>
<li><a href="#docker">docker</a></li>
<li><a href="#manipulating-output">Manipulating Output</a></li>
<li><a href="#template-variables">Template Variables</a></li>
<li><a href="#permissions">Permissions</a></li>
<li><a href="#update">Update</a></li>
<li><a href="#multi-arch-builds">Multi-Arch Builds</a></li>
<li><a href="#docker-compose">docker-compose</a></li>
<li><a href="#docker-compose-build">build</a></li>
<li><a href="#docker-compose-healthchecks">healthchecks</a></li>
<li><a href="#docker-compose-logging">logging</a></li>
<li><a href="#docker-compose-depends-on">depends-on</a></li>
</ul>
<h2>Docker</h2>
<h3>Manipulating Output</h3>
<p>Filter and specify the name that you are interested in:</p>
<pre class="codehilite"><code>$ docker ps -f name=my-hostname-service
CONTAINER ID        IMAGE                        COMMAND  CREATED              STATUS              PORTS                     NAMES
edb30579c208        ruanbekker/hostname:latest   &quot;/app&quot;   About a minute ago   Up About a minute   0.0.0.0:42177-&gt;8080/tcp   my-hostname-service-1234
</code></pre>

<p>Only output the ID:</p>
<pre class="codehilite"><code>$ docker ps -f name=my-hostname-service --format '{{.ID}}'
edb30579c208

or:

$ docker ps -f name=my-hostname-service -q
edb30579c208
</code></pre>

<p>If you have more than one container with the same prefix, but you are only interested in the most recent one:</p>
<pre class="codehilite"><code>$ docker ps -f name=my-hostname-service -ql
edb30579c208
</code></pre>

<p>ID, string characters and Name:</p>
<pre class="codehilite"><code>$ docker ps  -f name=my-hostname-service --format '{{.ID}} -&gt; {{.Names}}'
edb30579c208 -&gt; my-hostname-service-1234
</code></pre>

<p>Chaining them to exec into the container:</p>
<pre class="codehilite"><code>$ docker exec -it $(docker ps -f name=my-hostname-service -ql) sh
</code></pre>

<p>More examples:</p>
<ul>
<li>https://docs.docker.com/engine/reference/commandline/ps/</li>
</ul>
<h3>Template Variables</h3>
<p>For Docker:</p>
<pre class="codehilite"><code>$ docker run -it --log-driver json-file --log-opt tag=&quot;{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}|{{.ID}}&quot; alpine echo hi
hi
</code></pre>

<p>Get the logfile:</p>
<pre class="codehilite"><code>$ docker inspect $(docker ps -l) | jq '.[].LogPath'
/var/lib/docker/containers/b8e6523c8741d33f778a4f899dc04dab912472cedfba5ab71119a8c9ab1555a8/b8e6523c8741d33f778a4f899dc04dab912472cedfba5ab71119a8c9ab1555a8-json.log
</code></pre>

<p>View the content:</p>
<pre class="codehilite"><code>$ cat /var/lib/docker/containers/b8e6523c8741d33f778a4f899dc04dab912472cedfba5ab71119a8c9ab1555a8/b8e6523c8741d33f778a4f899dc04dab912472cedfba5ab71119a8c9ab1555a8-json.log
{&quot;log&quot;:&quot;hi\r\n&quot;,&quot;stream&quot;:&quot;stdout&quot;,&quot;attrs&quot;:{&quot;tag&quot;:&quot;alpine|festive_bell|sha256:e7d92cdc71feacf90708cb59182d0df1b911f8ae022d29e8e95d75ca6a99776a|b8e6523c8741d33f778a4f899dc04dab912472cedfba5ab71119a8c9ab1555a8|b8e6523c8741&quot;},&quot;time&quot;:&quot;2020-07-07T12:35:12.3938298Z&quot;}
</code></pre>

<ul>
<li>https://docs.docker.com/config/formatting/</li>
</ul>
<p>For Swarm:
- https://forums.docker.com/t/example-usage-of-docker-swarm-template-placeholders/73859</p>
<p>Get a container to report the host's hostname:</p>
<pre class="codehilite"><code>version: '3.7'
services:
  telegraf:
    ..
    hostname: &quot;{{.Node.Hostname}}&quot;
</code></pre>

<p>For Docker Swarm:</p>
<p>Service Name:</p>
<pre class="codehilite"><code>docker service create \
  --env &quot;SERVICE_NAME={{.Service.Name}}&quot; \
  --name helloworld \
  alpine /bin/sh -c 'echo $SERVICE_NAME'
</code></pre>

<pre class="codehilite"><code>docker service create \
  --name=coordinator \
  --env &quot;SERVICE_NAME={{.Service.Name}}&quot; \
  arangodb/arangodb /bin/sh -c 'arangod --server.authentication=false --server.endpoint tcp://0.0.0.0:8529 --cluster.my-address tcp://${SERVICE_NAME}:8529 --cluster.my-local-info ${SERVICE_NAME} --cluster.my-role COORDINATOR --cluster.agency-endpoint tcp://agency:8529 --log.file /var/log/arangodb3/arangod.log'
</code></pre>

<p>Task Slot:</p>
<pre class="codehilite"><code>docker service create --name mariadb-cluster \
    --network default \
    --replicas=1 \
    --mount type=volume,src=mariadb-cluster.&quot;{{.Task.Slot}}&quot;,dst=/var/lib/mysql \
    --env DB_SERVICE_NAME=mariadb-cluster \
    toughiq/mariadb-cluster:10.2
</code></pre>

<p>Others:</p>
<pre class="codehilite"><code>{{.Service.ID}}
{{.Service.Name}}
{{.Service.Labels}}
{{.Node.ID}}
{{.Node.Hostname}}
{{.Task.ID}}
{{.Task.Name}}
{{.Task.Slot}}
</code></pre>

<p>Docker Service PS</p>
<pre class="codehilite"><code>$ docker service ps api --format '{{.Name}} {{.CurrentState}}'
api.1 Running about an hour ago
</code></pre>

<p>Inspect the Service:</p>
<pre class="codehilite"><code>$ docker service inspect my-service
[
    {
        &quot;ID&quot;: &quot;abcdef&quot;,
        &quot;Version&quot;: {
            &quot;Index&quot;: 123
        },
        &quot;CreatedAt&quot;: &quot;2018-05-30T00:00:00.452848973Z&quot;,
        &quot;UpdatedAt&quot;: &quot;2018-05-30T00:00:00.457986437Z&quot;,
        &quot;Spec&quot;: {
            &quot;Name&quot;: &quot;my-service&quot;,
            &quot;TaskTemplate&quot;: {
                &quot;ContainerSpec&quot;: {
                ...
                &quot;LogDriver&quot;: {
                    &quot;Name&quot;: &quot;sumologic&quot;,
                    &quot;Options&quot;: {
                        &quot;sumo-compress&quot;: &quot;false&quot;,
                        &quot;sumo-sending-frequency&quot;: &quot;500ms&quot;,
                        &quot;sumo-url&quot;: &quot;https://endpoint.sumologic.com/receiver/...&quot;
                    }
                    ...
</code></pre>

<p>Inspect the LogDriver:</p>
<pre class="codehilite"><code>$ docker service inspect my-service --format='{{.Spec.TaskTemplate.LogDriver}}'
{sumologic map[sumo-compress:false sumo-sending-frequency:500ms sumo-url:https://endpointsumologic.com/receiver/...]}
</code></pre>

<p>Getting only the sumo-url value:</p>
<pre class="codehilite"><code>$ docker service inspect my-service -f '{{index .Spec.TaskTemplate.LogDriver.Options &quot;sumo-url&quot;}}'
https://endpoint.sumologic.com/receiver/...
</code></pre>

<p>Getting the Swarm Service and Task Name by inspecting the container:</p>
<pre class="codehilite"><code>$ docker inspect abc123def --format '{{index .Config.Labels &quot;com.docker.swarm.task.name&quot;}}'
my-app-ui.1.209jdwldi38jd
</code></pre>

<pre class="codehilite"><code>$ docker inspect abc123def --format '{{index .Config.Labels &quot;com.docker.swarm.node.id&quot;}}'
2093123jahas3d3
</code></pre>

<pre class="codehilite"><code>$ docker inspect abc123def --format '{{index .Config.Labels &quot;com.docker.swarm.service.name&quot;}}'
my-app-ui
</code></pre>

<h3>Permissions</h3>
<p>Copy as User:</p>
<pre class="codehilite"><code>FROM python:2.7
RUN pip install Flask==0.11.1 
RUN useradd -ms /bin/bash admin
COPY --chown=admin:admin app /app
WORKDIR /app
USER admin
CMD [&quot;python&quot;, &quot;app.py&quot;] 
</code></pre>

<h3>Update</h3>
<h4>Service Update</h4>
<p>Add a constraint to move to a worker node:</p>
<pre class="codehilite"><code>$ docker service update --constraint-add 'node.role==worker' my-service-name
</code></pre>

<h3>Multi-Arch Builds</h3>
<p>Install Docker Buildx CLI Plugin:</p>
<pre class="codehilite"><code class="language-bash">docker run --privileged --rm tonistiigi/binfmt --install all
</code></pre>

<p>Create a new builder instance:</p>
<pre class="codehilite"><code class="language-bash">docker buildx create --name multi-arch-builder
docker buildx use multi-arch-builder
docker buildx inspect --bootstrap
</code></pre>

<p>Dockerfile example:</p>
<pre class="codehilite"><code class="language-Dockerfile"># syntax=docker/dockerfile:1
FROM alpine:latest
RUN apk add --no-cache curl
CMD [&quot;curl&quot;, &quot;--version&quot;]
</code></pre>

<p>Build the docker image for multiple architectures:</p>
<pre class="codehilite"><code class="language-bash">docker buildx build --platform linux/amd64,linux/arm64 -t yourusername/yourimage:tag .
</code></pre>

<p>Or; Build and push to a registry:</p>
<pre class="codehilite"><code class="language-bash">docker buildx build --platform linux/amd64,linux/arm64 -t yourusername/yourimage:tag --push .
</code></pre>

<h2>Docker Compose</h2>
<h3>Docker Compose Build</h3>
<p>In our Dockerfile we can specify:</p>
<pre class="codehilite"><code class="language-dockerfile">ARG APP_VERSION=1
ENV APP_VERSION=$APP_VERSION
</code></pre>

<p>Then we can set or overwrite the value by using build arguments:</p>
<pre class="codehilite"><code>services:
  my-app:
    build:
      context: .
      dockerfile: test/Dockerfile
      args:
        APP_VERSION: 1.1
</code></pre>

<h3>Docker Compose Healthchecks</h3>
<p>To see how to use health checks for dependencies / conditions, look at the gist below:</p>
<pre class="codehilite"><code>services:
  php:
    build:
      context: .
      dockerfile: tests/Docker/Dockerfile-PHP
      args:
        version: cli
    depends_on:
      couchbase:
        condition: service_healthy
</code></pre>

<p>Credit to:
- <a href="https://gist.github.com/phuysmans/4f67a7fa1b0c6809a86f014694ac6c3a">@phuysmans gist</a></p>
<p>HTTP Healthcheck:</p>
<pre class="codehilite"><code>version: '2.1'
services:
    depends_on:
      couchbase:
        condition: service_healthy
  http-service:
    image: nginx
    healthcheck:
      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost:80/&quot;]
      interval: 1s
      timeout: 3s
      retries: 60
</code></pre>

<p>MySQL Healthcheck:</p>
<pre class="codehilite"><code>  mysql:
    image: mysql
    environment:
      - MYSQL_ALLOW_EMPTY_PASSWORD=yes
      - MYSQL_ROOT_PASSWORD=
      - MYSQL_DATABASE=test
    healthcheck:
      test: [&quot;CMD&quot;, &quot;mysql&quot; ,&quot;-h&quot;, &quot;mysql&quot;, &quot;-P&quot;, &quot;3306&quot;, &quot;-u&quot;, &quot;root&quot;, &quot;-e&quot;, &quot;SELECT 1&quot;, &quot;test&quot;]
      interval: 1s
      timeout: 3s
      retries: 30
</code></pre>

<p>Postgres Healthcheck:</p>
<pre class="codehilite"><code>  postgresql:
    image: postgres
    environment:
      - POSTGRES_PASSWORD=
      - POSTGRES_DB=test
    healthcheck:
      test: [&quot;CMD&quot;, &quot;pg_isready&quot;]
      interval: 1s
      timeout: 3s
      retries: 30
</code></pre>

<p>Redis Healthcheck:</p>
<pre class="codehilite"><code>  redis:
    image: redis
    healthcheck:
      test: [&quot;CMD&quot;, &quot;redis-cli&quot;, &quot;ping&quot;]
      interval: 1s
      timeout: 3s
      retries: 30
</code></pre>

<p>Docker in Docker Healthcheck:</p>
<pre class="codehilite"><code>  docker:
    image: docker:19.03.12-dind
    container_name: docker
    privileged: true
    environment:
      DOCKER_HOST: tcp://docker:2375/
      DOCKER_DRIVER: overlay2
      DOCKER_TLS_CERTDIR: &quot;&quot;
    networks:
      - docker
    healthcheck:
      test: [&quot;CMD&quot;, &quot;docker&quot; ,&quot;ps&quot;]
      interval: 5s
      timeout: 3s
      retries: 30
</code></pre>

<h3>Docker Compose Logging</h3>
<p>JSON File Logging:</p>
<pre class="codehilite"><code class="language-yaml">service:
  myservice:
    logging:
      driver: &quot;json-file&quot;
      options:
        max-size: &quot;1m&quot;
</code></pre>

<p>Loki Logging:</p>
<pre class="codehilite"><code class="language-yaml">service:
  myservice:
    logging:
      driver: loki
      options:
        loki-url: http://192.168.0.2:3100/loki/api/v1/push
        loki-external-labels: job=dockerlogs
</code></pre>

<h3>Docker Compose Depends On</h3>
<p>Depends-On Defaults, which will be wait for the database to start, before starting the web container:</p>
<pre class="codehilite"><code>version: &quot;3.8&quot;
services:
  web:
    build: .
    depends_on:
      - db
  db:
    image: postgres
</code></pre>

<p>Depends-On Types, where you can specify if it should wait for the service to start or to be healthy before starting the web container:</p>
<pre class="codehilite"><code>version: &quot;3.8&quot;
services:
  web:
    build: .
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
  redis:
    image: redis
  db:
    image: postgres
    healthcheck:
      test: &quot;exit 0&quot;
</code></pre>

<p>Different types of depends on:</p>
<pre class="codehilite"><code>condition: service_started
condition: service_healthy
condition: service_completed_successfully
</code></pre></div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>