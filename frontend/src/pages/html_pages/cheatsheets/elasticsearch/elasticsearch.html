<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Readme</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Readme</h1>
        </div>
        <div class="content">
            <div class="markdown-content"><h1>Elasticsearch Cheatsheet</h1>
<ul>
<li><a href="#using-curl">Using cURL</a></li>
<li><a href="#health-with-curl">Cluster Health</a></li>
<li><a href="#view-indices">View Indices</a></li>
<li><a href="#create-index">Create Index</a></li>
<li><a href="#ingest-data">Ingest</a></li>
<li><a href="#search">Search</a><ul>
<li><a href="#using-the-search-api">Using the Search API</a></li>
</ul>
</li>
<li><a href="#reindex-using-curl">Reindex</a></li>
<li><a href="#update-replicas-curl">Update Replica Shards</a></li>
<li><a href="#delete">Delete</a></li>
<li><a href="#snapshots-with-curl">Snapshots</a></li>
<li><a href="#restore-snapshots-with-curl">Restore Snapshots</a></li>
<li><a href="#tasks">Tasks API</a></li>
<li><a href="python-elasticsearch.md#python-library">using Python</a></li>
<li><a href="python-elasticsearch.md#ingest-using-python">Ingest</a></li>
</ul>
<h2>Using Curl</h2>
<h3>Health with Curl</h3>
<p>View the cluster health on a cluster level:</p>
<pre class="codehilite"><code>$ curl -s -XGET &quot;http://127.0.0.1:9200/_cluster/health?pretty&quot;
</code></pre>

<p>View the cluster health on a index level:</p>
<pre class="codehilite"><code>$ curl -XGET &quot;http://127.0.0.1:9200/_cluster/health?level=indices&amp;pretty&quot;
</code></pre>

<p>Check all indices in yellow status:</p>
<pre class="codehilite"><code>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/indices?v&amp;health=yellow'
</code></pre>

<p>View recovery process:</p>
<pre class="codehilite"><code>curl -s -XGET 'http://127.0.0.1:9200/_cat/recovery?detailed&amp;h=index,stage,time,bytes_percent'
</code></pre>

<h3>View Indices</h3>
<p>View all your indices:</p>
<pre class="codehilite"><code>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/indices?v'
</code></pre>

<p>View all indices from 2019.05:</p>
<pre class="codehilite"><code>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/indices/*2019.05*?v'
</code></pre>

<p>View all your indices, sort by size:</p>
<pre class="codehilite"><code>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/indices?v&amp;s=pri.store.size'
</code></pre>

<p>View all indices, but return only the index.name value:</p>
<pre class="codehilite"><code>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/indices?v&amp;h=index'
</code></pre>

<h3>Create Index</h3>
<p>Create a Index:</p>
<pre class="codehilite"><code>$ curl -XPOST -H &quot;Content-Type: application/json&quot; &quot;http://localhost:9200/my-test-index
</code></pre>

<p>Create a Index with 5 Primary Shards, 1 Replica Shard and Refresh Interval of 30 seconds:</p>
<pre class="codehilite"><code>$ curl -XPUT -H &quot;Content-Type: application/json&quot; \
  http://localhost:9200/my-foobar-index \
  -d '{&quot;index&quot;: {&quot;number_of_shards&quot;:&quot;5&quot;,&quot;number_of_replicas&quot;: 1, &quot;refresh_interval&quot;: &quot;30s&quot;}}'
</code></pre>

<p>If you want to manually refresh your index to see the data:</p>
<pre class="codehilite"><code>$ curl -XPOST -H &quot;Content-Type: application/json&quot; &quot;http://localhost:9200/my-foobar-index/_refresh&quot;
</code></pre>

<h3>Update Index Settings</h3>
<p>Documentation:
- https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-update-settings.html</p>
<p>View the index settings:</p>
<pre class="codehilite"><code>$ curl -XGET -H &quot;Content-Type: application/json&quot; &quot;http://127.0.0.1:9200/my-foobar-index/_settings?pretty&quot;
</code></pre>

<p>Update the settings, disable refresh for example:</p>
<pre class="codehilite"><code>$ curl -XPUT -H &quot;Content-Type: application/json&quot; &quot;http://127.0.0.1:9200/my-foobar-index/_settings&quot; -d '{&quot;index&quot;: {&quot;refresh_interval&quot;: &quot;-1&quot;}}'
</code></pre>

<h3>Ingest Data</h3>
<h3>Search</h3>
<p><strong>Searcing with query parameters:</strong></p>
<p>Name = Kevin</p>
<pre class="codehilite"><code>curl -XGET 'http://localhost:9200/myfirstindex/_search?q=name:kevin&amp;pretty'
</code></pre>

<p>Age &lt; 30</p>
<pre class="codehilite"><code>curl -XGET 'http://localhost:9200/myfirstindex/_search?q=age:&lt;30&amp;pretty'
</code></pre>

<p>Name = Michelle AND age &lt; 30</p>
<pre class="codehilite"><code>curl -XGET 'http://localhost:9200/myfirstindex/_search?q=name:michelle%20AND%20age:&lt;30&amp;pretty'
</code></pre>

<h4>Using the Search API</h4>
<p>Search for the latest ingested document</p>
<pre class="codehilite"><code>curl -H 'content-type: application/json' -XPOST http://localhost:9200/myfirstindex/_search?pretty -d '{&quot;size&quot;: 1, &quot;sort&quot;: { &quot;@timestamp&quot;: &quot;desc&quot;}, &quot;query&quot;: {&quot;match_all&quot;: {} }}'
 ```

### Reindex using Curl

Reindex source index to target index:
</code></pre>

<p>$ curl -XPOST -H 'Content-Type: application/json' 'http://127.0.0.1:9200/_reindex' -d '
  {
    "source": {
      "index": ["my-metrics-2019.01.03"]
    }, 
    "dest": {
      "index": "archived-metrics-2019.01.03", 
    }
}'</p>
<pre class="codehilite"><code>Reindex multiple source indices to one target index:
</code></pre>

<p>$ curl -XPOST -H 'Content-Type: application/json' 'http://127.0.0.1:9200/_reindex' -d '
  {
    "source": {
      "index": ["my-metrics-2019.01.03", "my-metrics-2019.01.04"]
    }, 
    "dest": {
      "index": "archived-metrics-2019.01", 
    }
}'</p>
<pre class="codehilite"><code>Reindex only missing documents from source to target index. You will receive conflicts for existing documents, but the proceed value will ignore the conflicts.
</code></pre>

<p>$ curl -XPOST -H 'Content-Type: application/json' 'http://127.0.0.1:9200/_reindex' -d '
  {
    "conflicts": "proceed", 
    "source": {
      "index": ["my-metrics-2019.01.03"]
    }, 
    "dest": {
      "index": "archived-metrics-2019.01.03", 
      "op_type": "create"
    }
}'</p>
<pre class="codehilite"><code>Reindex filtered data to a target index, by using a query:
</code></pre>

<p>$ curl -XPOST -H 'Content-Type: application/json' 'http://127.0.0.1:9200/_reindex' -d '
  {
    "source": {
      "index": "my-metrics-2019.01.03",
      "type": "log",
      "query": {
        "term": {
          "status": "ERROR"
        }
      }
    },
    "dest": {
      "index": "archived-error-metrics-2019.01.03"
    }
}'</p>
<pre class="codehilite"><code>Reindex the last 500 documents based on timestamp to a target index:
</code></pre>

<p>$ curl -XPOST -H 'Content-Type: application/json' 'http://127.0.0.1:9200/_reindex' -d '
  {
    "size": 500, 
    "source": {
      "index": "my-metrics-2019.01.03",
      "sort": {
        "timestamp": "desc"
      }
    }, 
    "dest": {
      "index": "archived-last500-metrics-2019.01.03", 
      "op_type": "create"
    }
}'</p>
<pre class="codehilite"><code>Reindex only specific fields to a target index:
</code></pre>

<p>$ curl -XPOST -H 'Content-Type: application/json' 'http://127.0.0.1:9200/_reindex' -d '
  {
    "source": {
      "index": "my-metrics-2019.01.03",
      "_source": [
        "response_code",
        "request_method",
        "referral"
      ]
    }, 
    "dest": {
      "index": "archived-subset-metrics-2019.01.03"
    }
}'</p>
<pre class="codehilite"><code>### Update Replicas Curl

Increase/Decrease the number of Replica Shards using the Settings API:
</code></pre>

<p>curl -XPUT -H 'Content-Type: application/json' 'http://127.0.0.1:9200/my-index-2018.12.31/_settings' \
  -d '{"index": {"number_of_replicas": 1, "refresh_interval": "30s"}}'</p>
<pre class="codehilite"><code>### Delete

References:

- [Delete API](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete.html)
- [Delete by Query](https://www.elastic.co/guide/en/elasticsearch/reference/5.6/docs-delete-by-query.html)

### Delete Index:
</code></pre>

<p>$ curl -XDELETE http://127.0.0.1:9200/my-index-2018.12.31</p>
<pre class="codehilite"><code>### Delete Documents on Query:

We would like to delete all documents that has `&quot;os_name&quot;: &quot;Windows 10&quot;`
</code></pre>

<p>curl -XPOST 'http://elasticsearch:9200/weblogs/_delete_by_query?pretty' -d '
{
  "query": {
    "match": {
      "os_name": "Windows 10"
    }
  }
}'</p>
<pre class="codehilite"><code>If routing is provided, then the routing is copied to the scroll query, limiting the process to the shards that match that routing value:
</code></pre>

<p>$ curl -XPOST 'http://elasticsearch:9200/people/_delete_by_query?routing=1
{
  "query": {
    "range" : {
        "age" : {
           "gte" : 10
        }
    }
  }
}</p>
<pre class="codehilite"><code>By default _delete_by_query uses scroll batches of 1000. You can change the batch size with the scroll_size URL parameter:
</code></pre>

<p>$ curl -XPOST 'http://elasticsearch:9200/weblogs/_delete_by_query?scroll_size=5000
{
  "query": {
    "term": {
      "category": "docker"
    }
  }
}</p>
<pre class="codehilite"><code>### Snapshots with Curl

View snapshot repositories:
</code></pre>

<p>curl -s -XGET 'http://127.0.0.1:9200/_snapshot?format=json'
{"cs-automated":{"type":"s3"},"es-index-backups":{"type":"s3"...</p>
<pre class="codehilite"><code>View snapshots under repository (table view):
</code></pre>

<p>curl -s -XGET 'http://127.0.0.1:9200/_cat/snapshots/index-backups?v'</p>
<h1>id, status, start_epoch, start_time, end_epoch, end_time, duration, indices, successful_shards, failed_shards, total_shards</h1>
<p>snapshot_2019.05.23 SUCCESS
..</p>
<pre class="codehilite"><code>View snapshots under repository (json view):
</code></pre>

<p>curl -s -XGET 'http://127.0.0.1:9200/_cat/snapshots/es-index-backups?format=json'
[{"id":"snapshot_2019.05.23","status":"SUCCESS"....</p>
<pre class="codehilite"><code>Create a snapshot with all indices and wait for completion:
</code></pre>

<p>curl -XPUT -H 'Content-Type: application/json' 'http://127.0.0.1:9200/_snapshot/index-backups/my-es-snapshot-latest?wait_for_completion=true'</p>
<pre class="codehilite"><code>View snapshot status:
</code></pre>

<p>curl -s -XGET 'http://127.0.0.1:9200/_cat/tasks?detailed'</p>
<h1>cluster:admin/snapshot/create ..</h1>
<pre class="codehilite"><code>View snapshot info:
</code></pre>

<p>curl -s 'http://127.0.0.1:9200/_snapshot/es-index-backups/my-es-snapshot-latest' | jq .</p>
<pre class="codehilite"><code>### Restore Snapshots with Curl

Restore with original names:
</code></pre>

<p>curl -XPOST -H 'Content-Type: application/json' 'http://127.0.0.1:9200/_snapshot/es-index-backups/test-snapshot-latest/_restore' -d '
{
  "indices": [
    "kibana_sample_data_ecommerce", "kibana_sample_data_logs"
  ], 
  "ignore_unavailable": false, 
  "include_global_state": false 
}'</p>
<pre class="codehilite"><code>
</code></pre>

<p>curl 'http://127.0.0.1:9200/_cat/indices/kibana_sample*?v'
health status index
green  open   kibana_sample_data_logs
green  open   kibana_sample_data_ecommerce</p>
<pre class="codehilite"><code>Restore and rename:
</code></pre>

<p>curl -XPOST -H 'Content-Type: application/json' 'http://127.0.0.1:9200/<em>snapshot/es-index-backups/test-snapshot-latest/_restore' -d '
{
  "indices": [
    "kibana_sample_data_ecommerce", "kibana_sample_data_logs"
  ], 
  "ignore_unavailable": false, 
  "include_global_state": false, 
  "rename_pattern": "(.+)", 
  "rename_replacement": "restored_index</em>$1" 
}'</p>
<pre class="codehilite"><code>
</code></pre>

<p>curl 'http://127.0.0.1:9200/_cat/indices/<em>restored</em>?v'
health status index
green  open   restored_index_kibana_sample_data_ecommerce 
green  open   restored_index_kibana_sample_data_logs</p>
<pre class="codehilite"><code>Restore and rename with a different name pattern:
</code></pre>

<p>curl -XPOST -H 'Content-Type: application/json' 'http://127.0.0.1:9200/<em>snapshot/es-index-backups/test-snapshot-latest/_restore' -d '
{ 
  "indices": [
    "kibana_sample_data_ecommerce", "kibana_sample_data_logs"
  ], 
  "ignore_unavailable": false, 
  "include_global_state": false, 
  "rename_pattern": 
  "kibana_sample_data</em>(.+)", 
  "rename_replacement": "restored_index_$1" 
}'</p>
<pre class="codehilite"><code>
</code></pre>

<p>curl 'http://127.0.0.1:9200/_cat/indices/<em>restored</em>?v'
health status index                                     <br />
green  open   restored_index_ecommerce                  <br />
green  open   restored_index_logs                         </p>
<pre class="codehilite"><code>### Tasks

View tasks in table format:
</code></pre>

<p>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/tasks?v&amp;detailed' 
action                         task_id                          parent_task_id                   type      start_time    timestamp running_time ip            node    description
cluster:monitor/nodes/stats    DzSOmlH3RRaLGA33QJl3Bg:137161492 -                                transport 1566542180463 23:36:20  1.1s         x.x.x.x DzSOmlH 
cluster:monitor/nodes/stats[n] C50akcLqScuJDwLx2nk9UA:95915234  DzSOmlH3RRaLGA33QJl3Bg:137161492 netty     1566542180464 23:36:20  1.1s         x.x.x.x  C50akcL 
indices:data/write/bulk        yZXq8fZWRjiurCvtO7tSpQ:92155276  -                                transport 1566542181565 23:36:21  23ms         x.x.x.x yZXq8fZ requests[83], indices[logstash-logs-2019.08]</p>
<pre class="codehilite"><code>View tasks in json format:
</code></pre>

<p>$ curl -s -XGET 'http://127.0.0.1:9200/_tasks?detailed&amp;format=json' 
{"nodes":{"xx":{"name":"xx","roles":["data","ingest"],"tasks":{"xx:xx":{"node":"xx","id":xx,"type":"transport","action":"cluster:monitor/nodes/stats"</p>
<pre class="codehilite"><code>View tasks in json format and pretty print:
</code></pre>

<p>$ curl -s -XGET 'http://127.0.0.1:9200/_tasks?detailed&amp;pretty&amp;format=json' 
{
  "nodes" : {
    "xx" : {
      "name" : "xx",
      "roles" : [ "data", "ingest" ],</p>
<pre class="codehilite"><code>View all tasks relating to snapshots being created:
</code></pre>

<p>$ curl -s -XGET 'http://127.0.0.1:9200/_tasks?detailed=true&amp;pretty&amp;actions=cluster:admin/snapshot/create'</p>
<pre class="codehilite"><code>View all tasks relating to write actions:
</code></pre>

<p>$ curl -s -XGET "http://127.0.0.1:9200/_tasks?detailed=true&amp;pretty&amp;actions=indices:<em>/write</em>"
{
  "nodes" : {
    "DzSOmlH3RRaLGA33QJl3Bg" : {
      "name" : "xx",
      "roles" : [ "data", "ingest" ],
      "tasks" : {
        "nodeX:idY" : {
          "node" : "nodeX",
          "id" : idY,
          "type" : "netty",
          "action" : "indices:data/write/bulk[s]",
          "status" : {
            "phase" : "waiting_on_primary"
          },
          "description" : "requests[5], index[logstash-logs-2019.08]",
          "start_time_in_millis" : 1566542804806,
          "running_time_in_nanos" : 65730,
          "cancellable" : false,
          "parent_task_id" : "nodeA:idZ",
          "headers" : { }
        }
      }
    },</p>
<pre class="codehilite"><code>Create a Task:
</code></pre>

<p>$ curl -XPOST -H 'Content-Type: application/json' 'http://127.0.0.1:9200/_reindex?wait_for_completion=false' -d '{"source": {"index": "metricbeat-2019.*"}, "dest": {"index": "metricbeat-2019"}}'
{"task":"-thJvCFgQlusd2vVFZGOfg:26962"}</p>
<pre class="codehilite"><code>View Task Status by TaskId:
</code></pre>

<p>$ curl http://localhost:9200/_tasks/-thJvCFgQlusd2vVFZGOfg:26962?pretty
{
  "completed" : true,
  "task" : {
    "node" : "-thJvCFgQlusd2vVFZGOfg",
    "id" : 26962,
    "type" : "transport",
    "action" : "indices:data/write/reindex",
...
  }
}</p>
<pre class="codehilite"><code>Some of the other actions:
</code></pre>

<p>"action" : "cluster:monitor/tasks/lists
"action" : "cluster:monitor/tasks/lists
"action" : "cluster:monitor/nodes/stats"
"action" : "cluster:admin/snapshot/create"
"action" : "internal:cluster/snapshot/update_snapshot_status"
"action" : "indices:data/read/search
 - "description": (context of query)
"action" : "indices:data/read/msearch"
"action" : "indices:data/write/bulk
```</p>
<h3>External Resources</h3>
<ul>
<li>http://elasticsearch-cheatsheet.jolicode.com/</li>
</ul></div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>