<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Elasticsearch</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Python Elasticsearch</h1>
        </div>
        <div class="content">
            <div class="markdown-content"><h1>Elasticsearch Cheatsheet</h1>
<p>My Elasticsearch Cheatsheet using Python</p>
<ul>
<li><a href="python-elasticsearch.md#python-library">Using Python Elasticsearch Library</a></li>
<li><a href="python-elasticsearch.md#authenticate-with-http-basic-auth">Authentication</a></li>
<li><a href="python-elasticsearch.md#elasticsearch-info-response">Info</a></li>
<li><a href="python-elasticsearch.md#ingest">Ingest</a></li>
<li><a href="python-elasticsearch.md#ingest">Bulk Ingest</a></li>
<li><a href="">Using Python Requests</a></li>
<li><a href="">Create a Index</a></li>
<li><a href="README.md#using-curl">Using cURL</a></li>
<li><a href="README.md#health-with-curl">Cluster Health</a></li>
<li><a href="README.md#reindex-using-curl">Reindex</a></li>
<li><a href="README.md#update-replicas-curl">Update Replica Shards</a></li>
<li><a href="README.md#snapshots-with-curl">Snapshots</a></li>
<li><a href="README.md#restore-snapshots-with-curl">Restore Snapshots</a></li>
</ul>
<h2>Python Library</h2>
<h4>Create a Client with Python</h4>
<p>Using IAM Authentication for AWS Elasticsearch</p>
<pre class="codehilite"><code>from elasticsearch import Elasticsearch, RequestsHttpConnection, helpers
from requests_aws4auth import AWS4Auth

aws_auth = AWS4Auth(access_key, secret_key, AWS_REGION, 'es', session_token=token)
es = Elasticsearch(
    hosts = [{'host': ES_ENDPOINT, 'port': 443}], 
    http_auth=aws_credentials, use_ssl=True, verify_certs=True, 
    connection_class=RequestsHttpConnection
)
</code></pre>

<h4>Authenticate with HTTP Basic Auth</h4>
<pre class="codehilite"><code>from elasticsearch import Elasticsearch, RequestsHttpConnection, helpers

es = Elasticsearch(
    hosts = [{'host': ES_ENDPOINT, 'port': 443}], 
    http_auth=('user', 'password'), use_ssl=True, verify_certs=True, 
    connection_class=RequestsHttpConnection
)
</code></pre>

<h4>Elasticsearch Info Response</h4>
<p>Get a response from ES:</p>
<pre class="codehilite"><code>&gt;&gt;&gt; es.info()
{'name': 'elasticsearch-02', 'cluster_name': 'es-cluster', 'cluster_uuid': 'EJDqv5VrQyao07ndQuwhCw', 'version': {'number': '6.8.2', 'build_flavor': 'default', 'build_type': 'deb', 'build_hash': 'b506955', 'build_date': '2019-07-24T15:24:41.545295Z', 'build_snapshot': False, 'lucene_version': '7.7.0', 'minimum_wire_compatibility_version': '5.6.0', 'minimum_index_compatibility_version': '5.0.0'}, 'tagline': 'You Know, for Search'}
</code></pre>

<p>prettify:</p>
<pre class="codehilite"><code>&gt;&gt;&gt; print(json.dumps(es.info(), indent=2))
{
  &quot;name&quot;: &quot;elasticsearch-02&quot;,
  &quot;cluster_name&quot;: &quot;es-cluster&quot;,
  &quot;cluster_uuid&quot;: &quot;EJDqv5VrQyao07ndQuwhCw&quot;,
  &quot;version&quot;: {
    &quot;number&quot;: &quot;6.8.2&quot;,
    &quot;build_flavor&quot;: &quot;default&quot;,
    &quot;build_type&quot;: &quot;deb&quot;,
    &quot;build_hash&quot;: &quot;b506955&quot;,
    &quot;build_date&quot;: &quot;2019-07-24T15:24:41.545295Z&quot;,
    &quot;build_snapshot&quot;: false,
    &quot;lucene_version&quot;: &quot;7.7.0&quot;,
    &quot;minimum_wire_compatibility_version&quot;: &quot;5.6.0&quot;,
    &quot;minimum_index_compatibility_version&quot;: &quot;5.0.0&quot;
  },
  &quot;tagline&quot;: &quot;You Know, for Search&quot;
}
</code></pre>

<h4>Ingest</h4>
<p>Create a document and specify a <code>id</code>:</p>
<pre class="codehilite"><code>res = es.index(index=&quot;test-index&quot;, doc_type='tweet', id=1, body=doc)
</code></pre>

<h4>Bulk Ingest</h4>
<pre class="codehilite"><code>from elasticsearch import Elasticsearch, RequestsHttpConnection, helpers

bulk_docs = []
list_of_dicts = [{&quot;name&quot;: &quot;ruan&quot;, &quot;age&quot;: 32}, {&quot;name&quot;: &quot;stefan&quot;, &quot;age&quot;: 31}]

for doc in list_of_dicts:
    doc['_index'] = 'my-index-2019.06.12'
    doc['_type'] = '_doc'
    bulk_docs.append(doc)
    del doc

helpers.bulk(es, bulk_docs)
</code></pre>

<h3>View Indices</h3>
<pre class="codehilite"><code>&gt;&gt;&gt; es.indices.get_alias(&quot;*&quot;).keys()
dict_keys(['fluentd-2020.02.26', 'metricbeat-2020.02.25', 'filebeat-2020.02.25', 'fluentd-2020.02.25', '.tasks', 'fluentd-2020.02.24', 'metricbeat-2019', 'telegram-bot', '.kibana_1', 'metricbeat-2020.02.26', 'filebeat-2020.02.26', 'metricbeat-2020.02'])
</code></pre>

<h3>Search</h3>
<p>Query: <code>{"query": {"match": {"text": "HI"}}}</code></p>
<pre class="codehilite"><code>&gt;&gt;&gt; es.search(index=&quot;telegram-bot&quot;, doc_type=&quot;_doc&quot;, body={&quot;query&quot;: {&quot;match&quot;: {&quot;text&quot;: &quot;HI&quot;}}})
{'took': 335, 'timed_out': False, '_shards': {'total': 5, 'successful': 5, 'skipped': 0, 'failed': 0}, 'hits': {'total': 1, 'max_score': 0.6931472, 'hits': [{'_index': 'telegram-bot', '_type': '_doc', '_id': 'x', '_score': 0.6931472, '_source': {'message_id': x, 'date': x, 'text': 'HI', 'entities': [], 'caption_entities': [], 'photo': [], 'new_chat_members': [], 'new_chat_photo': [], 'delete_chat_photo': False, 'group_chat_created': False, 'supergroup_chat_created': False, 'channel_chat_created': False}}]}}
</code></pre>

<h2>Using Python Requests</h2>
<h3>Create a Index:</h3>
<pre class="codehilite"><code>&gt;&gt;&gt; response = requests.put(
    'https://es.x.x/xstats', 
    auth=('username', 'pass'), 
    headers={'content-type': 'application/json'}, 
    json={'settings': {'number_of_shards': 2}}
)
</code></pre></div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>