<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Readme</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Readme</h1>
        </div>
        <div class="content">
            <div class="markdown-content"><h2>EC2 AWS CLI Cheatsheet</h2>
<ul>
<li><a href="#ec2">EC2</a></li>
<li><a href="#ami">AMI</a></li>
<li><a href="#query">Query</a></li>
<li><a href="#ebs">EBS</a></li>
<li><a href="#security-groups">Security Groups</a></li>
<li><a href="#subnets">Subnets</a></li>
</ul>
<h3>EC2</h3>
<h4>Run Instances</h4>
<p>Create the EBS Mapping:</p>
<pre class="codehilite"><code>[
    {
        &quot;DeviceName&quot;: &quot;/dev/sda1&quot;,
        &quot;Ebs&quot;: {
            &quot;DeleteOnTermination&quot;: true,
            &quot;VolumeSize&quot;: 50,
            &quot;VolumeType&quot;: &quot;standard&quot;
        }
    }
]
</code></pre>

<p>Get the latest AMI (ecs optimized in this case):</p>
<pre class="codehilite"><code>AWS_AMI_ID=&quot;$(aws --profile prod ssm get-parameter --name '/aws/service/ecs/optimized-ami/amazon-linux-2/recommended/image_id' | jq -r '.Parameter.Value')&quot;
</code></pre>

<p>Create a EC2 instance:</p>
<pre class="codehilite"><code>aws --profile default ec2 run-instances --image-id ${AWS_AMI_ID} --count 1 \
     --instance-type t2.micro --key-name mykey \
     --subnet-id subnet-123456789 --security-group-ids ${AWS_SG_ID} \
     --block-device-mappings file://ebs_mapping.json \
     --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=MyEC2}]' 'ResourceType=volume,Tags=[{Key=Name,Value=MyEC2}]' \
     --iam-instance-profile '{&quot;Name&quot;:&quot;my-instance-role&quot;}' \
     --user-data file://userdata.txt
</code></pre>

<h4>AMI</h4>
<p>Create a AMI:</p>
<pre class="codehilite"><code>$ aws --profile dev ec2 create-image --instance-id $INSTANCE_ID --name &quot;test-ami_$(date +%F)&quot; --description &quot;test ami created on $(date +%F)&quot; --no-reboot
ami-xxxxxxxx
</code></pre>

<p>Describe AMI Creation Status:</p>
<pre class="codehilite"><code>$ aws --profile dev ec2 describe-images --image-ids ami-xxxxxxxx --query &quot;Images[*].{State:State}&quot; --output text
# pending (or available)
</code></pre>

<h4>Query</h4>
<p>Get the EC2 InstanceID by Tag Name:</p>
<pre class="codehilite"><code>$ aws --profile dev ec2 describe-instances --filters &quot;Name=tag:Name,Values=test-instance&quot; --query &quot;Reservations[*].Instances[*].{Instance:InstanceId}&quot; --output text
i-07043caxxxxxxxxxx
</code></pre>

<p>Show InstanceId, State, PrivateDnsName of a given PrivateDnsName:</p>
<pre class="codehilite"><code>$ aws --profile dev ec2 describe-instances --query 'Reservations[*].Instances[?PrivateDnsName==`ip-192-168-42-186.eu-west-1.compute.internal`].[InstanceId,PrivateDnsName,State.Name][][]'
[
    &quot;i-0d016de17a46d5178&quot;,
    &quot;ip-192-168-42-186.eu-west-1.compute.internal&quot;,
    &quot;running&quot;
]
</code></pre>

<p>Show the EC2 Instances Tag:Name value:</p>
<pre class="codehilite"><code>$ aws --region eu-west-1 ec2 describe-tags --filters &quot;Name=resource-id,Values=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)&quot; --query 'Tags[?Key==`Name`].Value' --output text
my-ec2-instance
</code></pre>

<p>Show EC2 instances in table format:</p>
<pre class="codehilite"><code class="language-bash">aws ec2 describe-instances \
  --query &quot;Reservations[*].Instances[*].{Name:Tags[?Key=='Name']|[0].Value,InstanceID:InstanceId,Status:State.Name}&quot; \
  --filters &quot;Name=instance-state-name,Values=running&quot; &quot;Name=tag:Name,Values='*'&quot; \
  --output table
</code></pre>

<p>More Examples:
- https://ripon-banik.medium.com/top-10-examples-of-aws-cli-query-e717524dc346</p>
<h4>EBS</h4>
<p>Modify a EBS volume from GP2 to GP3:</p>
<pre class="codehilite"><code>$ aws ec2 modify-volume --volume-type gp3 --volume-id vol-0xxxxxxxxxxxxxxxx
{
    &quot;VolumeModification&quot;: {
        &quot;VolumeId&quot;: &quot;vol-0xxxxxxxxxxxxxxxx&quot;,
        &quot;ModificationState&quot;: &quot;modifying&quot;,
        &quot;TargetSize&quot;: 8,
        &quot;TargetIops&quot;: 3000,
        &quot;TargetVolumeType&quot;: &quot;gp3&quot;,
        &quot;TargetThroughput&quot;: 125,
        &quot;TargetMultiAttachEnabled&quot;: false,
        &quot;OriginalSize&quot;: 8,
        &quot;OriginalIops&quot;: 100,
        &quot;OriginalVolumeType&quot;: &quot;gp2&quot;,
        &quot;OriginalMultiAttachEnabled&quot;: false,
        &quot;Progress&quot;: 0,
        &quot;StartTime&quot;: &quot;2022-03-28T11:30:52+00:00&quot;
    }
}
</code></pre>

<p>Describe Status of Modication:</p>
<pre class="codehilite"><code>$ aws ec2 describe-volumes --volume-id vol-0xxxxxxxxxxxxxxxx
{
    &quot;Volumes&quot;: [
        {
            &quot;Attachments&quot;: [
                {
                    &quot;AttachTime&quot;: &quot;2021-06-08T16:02:40+00:00&quot;,
                    &quot;Device&quot;: &quot;/dev/sda1&quot;,
                    &quot;InstanceId&quot;: &quot;i-089ef13267c44a4a9&quot;,
                    &quot;State&quot;: &quot;attached&quot;,
                    &quot;VolumeId&quot;: &quot;vol-0xxxxxxxxxxxxxxxx&quot;,
                    &quot;DeleteOnTermination&quot;: true
                }
            ],
            &quot;AvailabilityZone&quot;: &quot;eu-west-1c&quot;,
            &quot;CreateTime&quot;: &quot;2021-06-08T16:02:40.226000+00:00&quot;,
            &quot;Encrypted&quot;: false,
            &quot;Size&quot;: 8,
            &quot;SnapshotId&quot;: &quot;snap-0xxxxxxxxxxxxxxxx&quot;,
            &quot;State&quot;: &quot;in-use&quot;,
            &quot;VolumeId&quot;: &quot;vol-0xxxxxxxxxxxxxxxx&quot;,
            &quot;Iops&quot;: 3000,
            &quot;Tags&quot;: [
                {
                    &quot;Key&quot;: &quot;Name&quot;,
                    &quot;Value&quot;: &quot;my-instance&quot;
                },
                {
                    &quot;Key&quot;: &quot;Environment&quot;,
                    &quot;Value&quot;: &quot;dev&quot;
                }
            ],
            &quot;VolumeType&quot;: &quot;gp3&quot;,
            &quot;MultiAttachEnabled&quot;: false,
            &quot;Throughput&quot;: 125
        }
    ]
}
</code></pre>

<p>To only see the status:</p>
<pre class="codehilite"><code>$ aws ec2 describe-volumes --volume-id vol-0xxxxxxxxxxxxxxxx | jq -r '.Volumes[].State'
in-use
</code></pre>

<h3>Security Groups</h3>
<p>Describe Security Group:</p>
<pre class="codehilite"><code>$ aws --profile dev ec2 describe-security-groups --group-ids &quot;sg-00000000000000000&quot;
{
    &quot;SecurityGroups&quot;: [
        {
            &quot;IpPermissionsEgress&quot;: [],
            &quot;Description&quot;: &quot;&quot;,
             &quot;Tags&quot;: [],
             &quot;IpPermissions&quot;: [],
             &quot;GroupName&quot;: &quot;&quot;,
             &quot;VpcId&quot;: &quot;&quot;,
             &quot;OwnerId&quot;: &quot;&quot;,
             &quot;GroupId&quot;: &quot;&quot;
        }
    ]
}
</code></pre>

<p>View Ingress Rules:</p>
<pre class="codehilite"><code>$ aws --profile dev ec2 describe-security-groups --group-ids &quot;sg-00000000000000000&quot; | jq -r .SecurityGroups[].IpPermissions
[
  {
    &quot;PrefixListIds&quot;: [],
    &quot;FromPort&quot;: 22,
    &quot;IpRanges&quot;: [
      {
        &quot;CidrIp&quot;: &quot;10.1.10.0/24&quot;
      }
    ],
    &quot;ToPort&quot;: 22,
    &quot;IpProtocol&quot;: &quot;tcp&quot;,
    &quot;UserIdGroupPairs&quot;: [],
    &quot;Ipv6Ranges&quot;: []
  }
]
</code></pre>

<p>Allow Ingress Rule:</p>
<pre class="codehilite"><code>$ aws --profile dev ec2 authorize-security-group-ingress --group-id sg-00000000000000000 --protocol tcp --port 3306 --cidr 10.1.10.0/16
</code></pre>

<h3>Subnets</h3>
<p>List the subnets containing "private" in tags:</p>
<pre class="codehilite"><code>$ aws --profile prod ec2 describe-subnets --filters &quot;Name=vpc-id,Values=vpc-xxxxxx&quot; | jq -r '.Subnets[] | select(.Tags[].Value | contains(&quot;private&quot;))'
{
  &quot;AvailabilityZone&quot;: &quot;eu-west-1c&quot;,
  &quot;AvailabilityZoneId&quot;: &quot;euw1-az3&quot;,
  &quot;AvailableIpAddressCount&quot;: 4089,
  &quot;CidrBlock&quot;: &quot;172.31.80.0/20&quot;,
  &quot;DefaultForAz&quot;: false,
  &quot;MapPublicIpOnLaunch&quot;: false,
  &quot;State&quot;: &quot;available&quot;,
  &quot;SubnetId&quot;: &quot;subnet-xxxxxxxx&quot;,
  &quot;VpcId&quot;: &quot;vpc-xxxxxxx&quot;,
  &quot;OwnerId&quot;: &quot;xxxxxxxxxxx&quot;,
  &quot;AssignIpv6AddressOnCreation&quot;: false,
  &quot;Ipv6CidrBlockAssociationSet&quot;: [],
  &quot;Tags&quot;: [
    {
      &quot;Key&quot;: &quot;Name&quot;,
      &quot;Value&quot;: &quot;prod-private-subnet-1c&quot;
    }
  ],
  &quot;SubnetArn&quot;: &quot;arn:aws:ec2:eu-west-1:xxxxxxxxx:subnet/subnet-xxxxxxxx&quot;
}
{
...
</code></pre>

<p>Get only the subnetids:</p>
<pre class="codehilite"><code>$ aws --profile prod ec2 describe-subnets --filters &quot;Name=vpc-id,Values=vpc-xxxxxxxx&quot; | jq -r '.Subnets[] | select(.Tags[].Value | contains(&quot;private&quot;)) .SubnetId'
subnet-xxxxxx
subnet-xxxxxx
subnet-xxxxxx
</code></pre></div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>