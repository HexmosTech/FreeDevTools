<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppSpec After Install Script - CodeDeploy Automation</title>
    <meta name="description" content="Understand and manage your CodeDeploy 'AfterInstall' lifecycle hook script. This guide details the bash script for setting up your application post-deployment, including systemd service configuration, symlinking releases, dependency installation, and permission management.">
    <meta name="keywords" content="CodeDeploy, AppSpec, AfterInstall, lifecycle hook, bash script, deployment automation, systemd, symlink, dependency installation, permissions, server setup, application deployment">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://yourdomain.com/codedeploy/appspec_versioned_after_install.html">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourdomain.com/codedeploy/appspec_versioned_after_install.html">
    <meta property="og:title" content="AppSpec After Install Script - CodeDeploy Automation">
    <meta property="og:description" content="Understand and manage your CodeDeploy 'AfterInstall' lifecycle hook script. This guide details the bash script for setting up your application post-deployment, including systemd service configuration, symlinking releases, dependency installation, and permission management.">
    <meta property="og:image" content="https://yourdomain.com/path/to/your/og-image.jpg">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://yourdomain.com/codedeploy/appspec_versioned_after_install.html">
    <meta name="twitter:title" content="AppSpec After Install Script - CodeDeploy Automation">
    <meta name="twitter:description" content="Understand and manage your CodeDeploy 'AfterInstall' lifecycle hook script. This guide details the bash script for setting up your application post-deployment, including systemd service configuration, symlinking releases, dependency installation, and permission management.">
    <meta name="twitter:image" content="https://yourdomain.com/path/to/your/twitter-image.jpg">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CodeDeploy AppSpec AfterInstall Script</h1>
        </div>
        <div class="content">
            <div class="markdown-content">
                <h2>Understanding the AfterInstall Lifecycle Hook</h2>
                <p>The <code>AfterInstall</code> lifecycle hook in AWS CodeDeploy is a critical stage in your deployment process. It executes after the application revision has been copied to the destination instance but before the application is configured and started. This script is essential for tasks like setting up systemd services, creating symbolic links to the latest release, installing dependencies, and ensuring correct file permissions.</p>

                <h2>Bash Script Breakdown</h2>
                <p>The following bash script outlines a common setup for a Python application deployment. It leverages several functions to modularize the deployment steps, making it easier to understand and maintain.</p>

                <h3>Systemd Unit File Configuration</h3>
                <p>This function ensures that the systemd service file is correctly placed and that systemd is reloaded to recognize the new service definition.</p>
                <pre><code class="language-bash">function systemd_unit_file_check() {
  echo "copying systemd unit file in place"
  sudo cp "${CD_INSTALL_TARGET}/configs/python-app.service" /etc/systemd/system/python-app.service
  sudo systemctl daemon-reload
}</code></pre>

                <h3>Release Versioning and Symlinking</h3>
                <p>To enable rollbacks and manage different versions of your application, it's common practice to version each deployment. This function removes the old <code>current</code> symlink and creates a new one pointing to the latest deployed version. It also copies necessary configuration and source files to the new release directory.</p>
                <pre><code class="language-bash">function remove_symlink(){
  if [ -d /home/snake/app/current ] 
  then
    sudo rm -rf /home/snake/app/current
    sudo mkdir -p /home/snake/app
  fi
}

function symlink_release() {
  sudo mkdir -p "/home/${APP_USER}/app/${DEPLOYMENT_ID}/configs"
  sudo mkdir -p "/home/${APP_USER}/app/${DEPLOYMENT_ID}/dependencies"
  sudo cp ${CD_INSTALL_TARGET}/configs/sample.env /home/${APP_USER}/app/${DEPLOYMENT_ID}/.env
  sudo cp ${CD_INSTALL_TARGET}/configs/hypercorn.toml /home/${APP_USER}/app/${DEPLOYMENT_ID}/configs/hypercorn.toml
  sudo cp ${CD_INSTALL_TARGET}/dependencies/requirements.pip /home/${APP_USER}/app/${DEPLOYMENT_ID}/dependencies/requirements.pip
  sudo cp -r ${CD_INSTALL_TARGET}/src/* /home/${APP_USER}/app/${DEPLOYMENT_ID}/
  sudo ln -s /home/${APP_USER}/app/${DEPLOYMENT_ID} /home/${APP_USER}/app/current
}</code></pre>

                <h3>Dependency Installation</h3>
                <p>After the application files are in place, this function installs the required Python dependencies using pip, ensuring your application has all its necessary libraries.</p>
                <pre><code class="language-bash">function install_dependencies(){
  sudo python3 -m pip install -r /home/${APP_USER}/app/current/dependencies/requirements.pip
}</code></pre>

                <h3>Setting File Permissions</h3>
                <p>Correct file ownership and permissions are crucial for application security and functionality. This function ensures that the application files are owned by the designated application user and group.</p>
                <pre><code class="language-bash">function set_permissions() {
  sudo chown -R ${APP_USER}:${APP_GROUP} /home/${APP_USER}/
}</code></pre>

                <h3>Logging Deployment Status</h3>
                <p>A simple logging function to indicate that the AfterInstall step has completed successfully.</p>
                <pre><code class="language-bash">function log_status(){
  echo "[${DATESTAMP}] after install step completed"
}</code></pre>

                <h2>Execution Flow</h2>
                <p>The script then calls these functions in a logical order to perform the deployment tasks:</p>
                <pre><code class="language-bash"># copy systemd unit file if not in place
systemd_unit_file_check

# remove symlink and version the installed target
remove_symlink
symlink_release

# install the dependencies
install_dependencies

# set permissions
set_permissions

# log status
log_status</code></pre>

                <h2>Further Considerations</h2>
                <p>For more complex deployments, you might need to add steps for database migrations, cache clearing, or other environment-specific configurations within this script. Always ensure your script is idempotent and handles potential errors gracefully.</p>
                <p>Refer to the <a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/reference_appspec_hooks.html" target="_blank" rel="noopener noreferrer">AWS CodeDeploy AppSpec Hooks documentation</a> for more details on lifecycle events.</p>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>