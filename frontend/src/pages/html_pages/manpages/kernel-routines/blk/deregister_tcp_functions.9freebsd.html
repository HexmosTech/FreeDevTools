<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tcp_functions — Alternate TCP Stack Framework</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/freebsd-manpages">freebsd-manpages_12.2-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       tcp_functions — Alternate TCP Stack Framework

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;<a href="file:/usr/include/netinet/tcp.h">netinet/tcp.h</a>&gt;</b>
       <b>#include</b> <b>&lt;netinet/tcp_var.h&gt;</b>

       <u>int</u>
       <b>register_tcp_functions</b>(<u>struct</u> <u>tcp_function_block</u> <u>*blk</u>, <u>int</u> <u>wait</u>);

       <u>int</u>
       <b>register_tcp_functions_as_name</b>(<u>struct</u> <u>tcp_function_block</u> <u>*blk</u>, <u>const</u> <u>char</u> <u>*name</u>, <u>int</u> <u>wait</u>);

       <b>register_tcp_functions_as_names</b>(<u>struct</u>   <u>tcp_function_block</u>   <u>*blk</u>,   <u>int</u>   <u>wait</u>,  <u>const</u>  <u>char</u>  <u>*names[]</u>,
           <u>int</u> <u>*num_names</u>);

       <u>int</u>
       <b>deregister_tcp_functions</b>(<u>struct</u> <u>tcp_function_block</u> <u>*blk</u>);

</pre><h4><b>DESCRIPTION</b></h4><pre>
       The <b>tcp_functions</b> framework allows a kernel developer to implement alternate TCP stacks.   The  alternate
       stacks  can  be  compiled  in  the  kernel  or  can  be  implemented  in  loadable  kernel modules.  This
       functionality is intended to encourage  experimentation  with  the  TCP  stack  and  to  allow  alternate
       behaviors to be deployed for different TCP connections on a single system.

       A  system  administrator  can  set  a system default stack.  By default, all TCP connections will use the
       system default stack.  Additionally, users can specify a particular stack  to  use  on  a  per-connection
       basis.   (See <u><a href="../man4/tcp.4.html">tcp</a></u>(4) for details on setting the system default stack, or selecting a specific stack for a
       given connection.)

       This man page treats "TCP stacks" as synonymous with "function blocks".  This  is  intentional.   A  "TCP
       stack"  is a collection of functions that implement a set of behavior.  Therefore, an alternate "function
       block" defines an alternate "TCP stack".

       The  <b>register_tcp_functions</b>(),  <b>register_tcp_functions_as_name</b>(),  and  <b>register_tcp_functions_as_names</b>()
       functions  request  that  the  system add a specified function block and register it for use with a given
       name.  Modules may register the same function block multiple times with different names.  However,  names
       must  be  globally  unique  among  all registered function blocks.  Also, modules may not ever modify the
       contents of the function block (including the name) after it has been registered, unless the module first
       successfully de-registers the function block.

       The <b>register_tcp_functions</b>() function requests that the system register the function block with the  name
       defined  in  the  function block's <u>tfb_tcp_block_name</u> field.  Note that this is the only one of the three
       registration functions that automatically registers the function block using  the  name  defined  in  the
       function  block's <u>tfb_tcp_block_name</u> field.  If a module uses one of the other registration functions, it
       may request that the system register the function block using the name defined in  the  function  block's
       <u>tfb_tcp_block_name</u> field by explicitly providing that name.

       The  <b>register_tcp_functions_as_name</b>()  function requests that the system register the function block with
       the name provided in the <u>name</u> argument.

       The <b>register_tcp_functions_as_names</b>() function requests that the system register the function block  with
       all the names provided in the <u>names</u> argument.  The <u>num_names</u> argument provides a pointer to the number of
       names.   This  function  will either succeed in registering all of the names in the array, or none of the
       names in the array.  On failure, the <u>num_names</u> argument is updated with the index number of the entry  in
       the <u>names</u> array which the system was processing when it encountered the error.

       The  <b>deregister_tcp_functions</b>()  function requests that the system remove a specified function block from
       the system.  If this call succeeds, it will completely deregister the function block, regardless  of  the
       number  of  names used to register the function block.  If the call fails because sockets are still using
       the specified function block, the system will mark the function block as being in the  process  of  being
       removed.  This will prevent additional sockets from using the specified function block.  However, it will
       not impact sockets that are already using the function block.

       <b>tcp_functions</b>  modules  must  call  one  or  more of the registration functions during initialization and
       successfully call the <b>deregister_tcp_functions</b>() function prior to allowing the module to be unloaded.

       The <u>blk</u> argument is a pointer to a <u>struct</u> <u>tcp_function_block</u>, which is  explained  below  (see  “Function
       Block  Structure”).  The <u>wait</u> argument is used as the <u>flags</u> argument to <u><a href="../man9/malloc.9.html">malloc</a></u>(9), and must be set to one
       of the valid values defined in that man page.

   <b>Function</b> <b>Block</b> <b>Structure</b>
       The <u>blk</u> <u>argument</u> <u>is</u> <u>a</u> <u>pointer</u> <u>to</u> <u>a</u> <u>struct</u> <u>tcp_function_block</u>, which has the following members:

             struct tcp_function_block {
                     char    tfb_tcp_block_name[TCP_FUNCTION_NAME_LEN_MAX];
                     int     (*tfb_tcp_output)(struct tcpcb *);
                     void    (*tfb_tcp_do_segment)(struct mbuf *, struct tcphdr *,
                                         struct socket *, struct tcpcb *,
                                         int, int, uint8_t,
                                         int);
                     int     (*tfb_tcp_ctloutput)(struct socket *so,
                                         struct sockopt *sopt,
                                         struct inpcb *inp, struct tcpcb *tp);
                     /* Optional memory allocation/free routine */
                     void    (*tfb_tcp_fb_init)(struct tcpcb *);
                     void    (*tfb_tcp_fb_fini)(struct tcpcb *, int);
                     /* Optional timers, must define all if you define one */
                     int     (*tfb_tcp_timer_stop_all)(struct tcpcb *);
                     void    (*tfb_tcp_timer_activate)(struct tcpcb *,
                                         uint32_t, u_int);
                     int     (*tfb_tcp_timer_active)(struct tcpcb *, uint32_t);
                     void    (*tfb_tcp_timer_stop)(struct tcpcb *, uint32_t);
                     /* Optional functions */
                     void    (*tfb_tcp_rexmit_tmr)(struct tcpcb *);
                     void    (*tfb_tcp_handoff_ok)(struct tcpcb *);
                     /* System use */
                     volatile uint32_t tfb_refcnt;
                     uint32_t  tfb_flags;
             };

       The <u>tfb_tcp_block_name</u> field identifies the unique name of the TCP stack, and should be  no  longer  than
       TCP_FUNCTION_NAME_LEN_MAX-1 characters in length.

       The  <u>tfb_tcp_output</u>,  <u>tfb_tcp_do_segment</u>,  and  <u>tfb_tcp_ctloutput</u>  fields  are pointers to functions that
       perform the equivalent actions as the default <b>tcp_output</b>(), <b>tcp_do_segment</b>(), and <b>tcp_default_ctloutput</b>()
       functions, respectively.  Each of these function pointers must be non-NULL.

       If a TCP stack needs to initialize data when a socket first selects the TCP stack (or, when the socket is
       first opened), it should set a non-NULL pointer in the <u>tfb_tcp_fb_init</u> field.  Likewise, if a  TCP  stack
       needs  to cleanup data when a socket stops using the TCP stack (or, when the socket is closed), it should
       set a non-NULL pointer in the <u>tfb_tcp_fb_fini</u> field.

       If the <u>tfb_tcp_fb_fini</u> argument is non-NULL, the function to which it points is called when the kernel is
       destroying the TCP control block or when the socket is transitioning to use a different TCP  stack.   The
       function is called with arguments of the TCP control block and an integer flag.  The flag will be zero if
       the socket is transitioning to use another TCP stack or one if the TCP control block is being destroyed.

       If  the  TCP  stack  implements  additional  timers,  the  TCP stack should set a non-NULL pointer in the
       <u>tfb_tcp_timer_stop_all</u>,  <u>tfb_tcp_timer_activate</u>,  <u>tfb_tcp_timer_active</u>,  and  <u>tfb_tcp_timer_stop</u>  fields.
       These fields should all be NULL or should all contain pointers to functions.  The <u>tfb_tcp_timer_activate</u>,
       <u>tfb_tcp_timer_active</u>,  and  <u>tfb_tcp_timer_stop</u>  functions  will  be called when the <b>tcp_timer_activate</b>(),
       <b>tcp_timer_active</b>(), and <b>tcp_timer_stop</b>() functions, respectively, are called with a timer type other than
       the standard types.  The functions defined by the TCP stack have the same semantics (both  for  arguments
       and return values) as the normal timer functions they supplement.

       Additionally,  a  stack  may  define its own actions to take when the retransmit timer fires by setting a
       non-NULL function pointer in the <u>tfb_tcp_rexmit_tmr</u> field.  This function is called  very  early  in  the
       process  of  handling  a  retransmit  timer.   However, care must be taken to ensure the retransmit timer
       leaves the TCP control block in a valid state for the remainder of the retransmit timer logic.

       A user may select a new TCP stack before calling <u><a href="../man2/connect.2.html">connect</a></u>(2) or <u><a href="../man2/listen.2.html">listen</a></u>(2).  Optionally, a  TCP  stack  may
       also  allow  a  user  to begin using the TCP stack for a connection that is in a later state by setting a
       non-NULL function pointer in the <u>tfb_tcp_handoff_ok</u> field.  If this field is non-NULL and a user attempts
       to select that TCP stack after calling <u><a href="../man2/connect.2.html">connect</a></u>(2) or <u><a href="../man2/listen.2.html">listen</a></u>(2) for that socket, the kernel will call  the
       function pointed to by the <u>tfb_tcp_handoff_ok</u> field.  The function should return 0 if the user is allowed
       to  switch  the  socket  to use the TCP stack. Otherwise, the function should return an error code, which
       will be returned to the user.  If the <u>tfb_tcp_handoff_ok</u> field is NULL and a user attempts to select  the
       TCP  stack  after calling <u><a href="../man2/connect.2.html">connect</a></u>(2) or <u><a href="../man2/listen.2.html">listen</a></u>(2) for that socket, the operation will fail and the kernel
       will return EINVAL.

       The <u>tfb_refcnt</u> and <u>tfb_flags</u> fields are used by the kernel's TCP code and will be  initialized  when  the
       TCP stack is registered.

   <b>Requirements</b> <b>for</b> <b>Alternate</b> <b>TCP</b> <b>Stacks</b>
       If  the  TCP  stack  needs  to store data beyond what is stored in the default TCP control block, the TCP
       stack can initialize its own per-connection storage.  The <u>t_fb_ptr</u> field  in  the  <u>struct</u>  <u>tcpcb</u>  control
       block  structure  has  been  reserved to hold a pointer to this per-connection storage.  If the TCP stack
       uses this alternate storage, it should understand that the value of  the  <u>t_fb_ptr</u>  pointer  may  not  be
       initialized  to  NULL.   Therefore,  it  should  use a <u>tfb_tcp_fb_init</u> function to initialize this field.
       Additionally, it should use a <u>tfb_tcp_fb_fini</u> function to deallocate storage when the socket is closed.

       It is understood that alternate TCP stacks may keep different sets of data.  However, in order to  ensure
       that  data  is  available to both the user and the rest of the system in a standardized format, alternate
       TCP stacks must update all fields in the TCP control block to the greatest extent practical.

</pre><h4><b>RETURN</b> <b>VALUES</b></h4><pre>
       The <b>register_tcp_functions</b>(),  <b>register_tcp_functions_as_name</b>(),  <b>register_tcp_functions_as_names</b>(),  and
       <b>deregister_tcp_functions</b>()  functions return zero on success and non-zero on failure.  In particular, the
       <b>deregister_tcp_functions</b>() will return EBUSY until no more connections are using the specified TCP stack.
       A module calling <b>deregister_tcp_functions</b>() must be prepared to wait until all connections  have  stopped
       using the specified TCP stack.

</pre><h4><b>ERRORS</b></h4><pre>
       The <b>register_tcp_functions</b>() function will fail if:

       [EINVAL]           Any of the members of the <u>blk</u> argument are set incorrectly.

       [ENOMEM]           The function could not allocate memory for its internal data.

       [EALREADY]         A function block is already registered with the same name.
       The <b>deregister_tcp_functions</b>() function will fail if:

       [EPERM]            The <u>blk</u> argument references the kernel's compiled-in default function block.

       [EBUSY]            The  function  block  is  still  in  use  by one or more sockets, or is defined as the
                          current default function block.

       [ENOENT]           The <u>blk</u> argument references a function block that is not currently registered.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man2/connect.2.html">connect</a></u>(2), <u><a href="../man2/listen.2.html">listen</a></u>(2), <u><a href="../man4/tcp.4.html">tcp</a></u>(4), <u><a href="../man9/malloc.9.html">malloc</a></u>(9)

</pre><h4><b>HISTORY</b></h4><pre>
       This framework first appeared in FreeBSD 11.0.

</pre><h4><b>AUTHORS</b></h4><pre>
       The <b>tcp_functions</b> framework was written by Randall Stewart &lt;<u><a href="mailto:rrs@FreeBSD.org">rrs@FreeBSD.org</a></u>&gt;.

       This manual page was written by Jonathan Looney &lt;<u><a href="mailto:jtl@FreeBSD.org">jtl@FreeBSD.org</a></u>&gt;.

Debian                                           March 10, 2017                                 <u><a href="../man9/TCP_FUNCTIONS.9.html">TCP_FUNCTIONS</a></u>(9)
</pre>
 </div>
</div></section>
</div>
</body>
</html>