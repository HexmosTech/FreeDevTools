<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>malloc, free, realloc, reallocf, MALLOC_DEFINE, MALLOC_DECLARE — kernel memory management routines</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/freebsd-manpages">freebsd-manpages_12.2-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       malloc, free, realloc, reallocf, MALLOC_DEFINE, MALLOC_DECLARE — kernel memory management routines

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;sys/types.h&gt;</b>
       <b>#include</b> <b>&lt;sys/malloc.h&gt;</b>

       <u>void</u> <u>*</u>
       <b>malloc</b>(<u>size_t</u> <u>size</u>, <u>struct</u> <u>malloc_type</u> <u>*type</u>, <u>int</u> <u>flags</u>);

       <u>void</u> <u>*</u>
       <b>mallocarray</b>(<u>size_t</u> <u>nmemb</u>, <u>size_t</u> <u>size</u>, <u>struct</u> <u>malloc_type</u> <u>*type</u>, <u>int</u> <u>flags</u>);

       <u>void</u>
       <b>free</b>(<u>void</u> <u>*addr</u>, <u>struct</u> <u>malloc_type</u> <u>*type</u>);

       <u>void</u> <u>*</u>
       <b>realloc</b>(<u>void</u> <u>*addr</u>, <u>size_t</u> <u>size</u>, <u>struct</u> <u>malloc_type</u> <u>*type</u>, <u>int</u> <u>flags</u>);

       <u>void</u> <u>*</u>
       <b>reallocf</b>(<u>void</u> <u>*addr</u>, <u>size_t</u> <u>size</u>, <u>struct</u> <u>malloc_type</u> <u>*type</u>, <u>int</u> <u>flags</u>);

       <u>size_t</u>
       <b>malloc_usable_size</b>(<u>const</u> <u>void</u> <u>*addr</u>);

       <b>MALLOC_DECLARE</b>(<u>type</u>);

       <b>#include</b> <b>&lt;sys/param.h&gt;</b>
       <b>#include</b> <b>&lt;sys/malloc.h&gt;</b>
       <b>#include</b> <b>&lt;sys/kernel.h&gt;</b>

       <b>MALLOC_DEFINE</b>(<u>type</u>, <u>shortdesc</u>, <u>longdesc</u>);

       <b>#include</b> <b>&lt;sys/param.h&gt;</b>
       <b>#include</b> <b>&lt;sys/domainset.h&gt;</b>

       <u>void</u> <u>*</u>
       <b>malloc_domainset</b>(<u>size_t</u> <u>size</u>, <u>struct</u> <u>malloc_type</u> <u>*type</u>, <u>struct</u> <u>domainset</u> <u>*ds</u>, <u>int</u> <u>flags</u>);

       <u>void</u>
       <b>free_domain</b>(<u>void</u> <u>*addr</u>, <u>struct</u> <u>malloc_type</u> <u>*type</u>);

</pre><h4><b>DESCRIPTION</b></h4><pre>
       The  <b>malloc</b>() function allocates uninitialized memory in kernel address space for an object whose size is
       specified by <u>size</u>.

       The <b>malloc_domainset</b>() variant allocates memory from a specific <u><a href="../man4/numa.4.html">numa</a></u>(4) domain using the specified domain
       selection policy.  See <u><a href="../man9/domainset.9.html">domainset</a></u>(9) for some example  policies.   Memory  allocated  with  this  function
       should be returned with <b>free_domain</b>().

       The  <b>mallocarray</b>()  function allocates uninitialized memory in kernel address space for an array of <u>nmemb</u>
       entries whose size is specified by <u>size</u>.

       The <b>free</b>() function releases memory at address <u>addr</u> that was previously allocated by <b>malloc</b>() for re-use.
       The memory is not zeroed.  If <u>addr</u> is NULL, then <b>free</b>() does nothing.

       The <b>realloc</b>() function changes the size of the previously allocated memory referenced  by  <u>addr</u>  to  <u>size</u>
       bytes.   The  contents  of the memory are unchanged up to the lesser of the new and old sizes.  Note that
       the returned value may differ from <u>addr</u>.  If the requested memory cannot be allocated, NULL  is  returned
       and  the  memory  referenced  by  <u>addr</u>  is  valid and unchanged.  If <u>addr</u> is NULL, the <b>realloc</b>() function
       behaves identically to <b>malloc</b>() for the specified size.

       The <b>reallocf</b>() function is identical to <b>realloc</b>() except that it will free the passed  pointer  when  the
       requested memory cannot be allocated.

       The  <b>malloc_usable_size</b>()  function  returns  the  usable size of the allocation pointed to by <u>addr</u>.  The
       return value may be larger than the size that was requested during allocation.

       Unlike its standard C library counterpart (<u><a href="../man3/malloc.3.html">malloc</a></u>(3)), the kernel version takes two more arguments.   The
       <u>flags</u> argument further qualifies <b>malloc</b>()'s operational characteristics as follows:

       M_ZERO  Causes the allocated memory to be set to all zeros.

       M_NODUMP
               For  allocations  greater  than page size, causes the allocated memory to be excluded from kernel
               core dumps.

       M_NOWAIT
               Causes <b>malloc</b>(), <b>realloc</b>(), and <b>reallocf</b>() to return NULL if the request  cannot  be  immediately
               fulfilled  due to resource shortage.  Note that M_NOWAIT is required when running in an interrupt
               context.

       M_WAITOK
               Indicates that it is OK to wait for resources.  If the request cannot be  immediately  fulfilled,
               the current process is put to sleep to wait for resources to be released by other processes.  The
               <b>malloc</b>(),  <b>mallocarray</b>(),  <b>realloc</b>(),  and <b>reallocf</b>() functions cannot return NULL if M_WAITOK is
               specified.  If the multiplication of  <u>nmemb</u>  and  <u>size</u>  would  cause  an  integer  overflow,  the
               <b>mallocarray</b>() function induces a panic.

       M_USE_RESERVE
               Indicates  that  the  system  can  use its reserve of memory to satisfy the request.  This option
               should only be used in combination with M_NOWAIT when an allocation failure cannot  be  tolerated
               by the caller without catastrophic effects on the system.

       M_EXEC  Indicates that the system should allocate executable memory.  If this flag is not set, the system
               will  not allocate executable memory.  Not all platforms enforce a distinction between executable
               and non-executable memory.

       Exactly one of either M_WAITOK or M_NOWAIT must be specified.

       The <u>type</u> argument is used to perform statistics on memory usage, and for basic sanity checks.  It can  be
       used to identify multiple allocations.  The statistics can be examined by ‘vmstat -m’.

       A <u>type</u> is defined using <u>struct</u> <u>malloc_type</u> via the <b>MALLOC_DECLARE</b>() and <b>MALLOC_DEFINE</b>() macros.

             /* sys/something/foo_extern.h */

             MALLOC_DECLARE(M_FOOBUF);

             /* sys/something/foo_main.c */

             MALLOC_DEFINE(M_FOOBUF, "foobuffers", "Buffers to foo data into the ether");

             /* sys/something/foo_subr.c */

             ...
             buf = malloc(sizeof(*buf), M_FOOBUF, M_NOWAIT);

       In  order  to  use  <b>MALLOC_DEFINE</b>(),  one  must  include  &lt;<u>sys/param.h</u>&gt;  (instead  of  &lt;<u>sys/types.h</u>&gt;) and
       &lt;<u>sys/kernel.h</u>&gt;.

</pre><h4><b>CONTEXT</b></h4><pre>
       <b>malloc</b>(), <b>realloc</b>() and <b>reallocf</b>() may not be called from fast interrupts  handlers.   When  called  from
       threaded interrupts, <u>flags</u> must contain M_NOWAIT.

       <b>malloc</b>(),  <b>realloc</b>()  and <b>reallocf</b>() may sleep when called with M_WAITOK.  <b>free</b>() never sleeps.  However,
       <b>malloc</b>(), <b>realloc</b>(), <b>reallocf</b>() and <b>free</b>() may not be called in a critical section  or  while  holding  a
       spin lock.

       Any  calls to <b>malloc</b>() (even with M_NOWAIT) or <b>free</b>() when holding a <u><a href="../man9/vnode.9.html">vnode</a></u>(9) interlock, will cause a LOR
       (Lock Order Reversal) due to the intertwining of VM Objects and Vnodes.

</pre><h4><b>IMPLEMENTATION</b> <b>NOTES</b></h4><pre>
       The memory allocator allocates memory in chunks that have size a power of two for requests up to the size
       of a page of memory.  For larger requests, one or more pages is allocated.  While it should not be relied
       upon, this information may be useful for optimizing the efficiency of memory use.

</pre><h4><b>RETURN</b> <b>VALUES</b></h4><pre>
       The <b>malloc</b>(), <b>realloc</b>(), and <b>reallocf</b>() functions return  a  kernel  virtual  address  that  is  suitably
       aligned  for  storage of any type of object, or NULL if the request could not be satisfied (implying that
       M_NOWAIT was set).

</pre><h4><b>DIAGNOSTICS</b></h4><pre>
       A kernel compiled with the INVARIANTS configuration option attempts to detect memory corruption caused by
       such things as writing outside the allocated area  and  imbalanced  calls  to  the  <b>malloc</b>()  and  <b>free</b>()
       functions.  Failing consistency checks will cause a panic or a system console message.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man4/numa.4.html">numa</a></u>(4), <u><a href="../man8/vmstat.8.html">vmstat</a></u>(8), <u><a href="../man9/contigmalloc.9.html">contigmalloc</a></u>(9), <u><a href="../man9/domainset.9.html">domainset</a></u>(9), <u><a href="../man9/memguard.9.html">memguard</a></u>(9), <u><a href="../man9/vnode.9.html">vnode</a></u>(9)

Debian                                           August 28, 2020                                       <u><a href="../man9/MALLOC.9.html">MALLOC</a></u>(9)
</pre>
 </div>
</div></section>
</div>
</body>
</html>