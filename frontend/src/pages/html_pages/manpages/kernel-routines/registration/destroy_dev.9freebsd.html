<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>make_dev,   make_dev_cred,  make_dev_credf,  make_dev_p,  make_dev_s,  make_dev_alias,  make_dev_alias_p,</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/freebsd-manpages">freebsd-manpages_12.2-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       make_dev,   make_dev_cred,  make_dev_credf,  make_dev_p,  make_dev_s,  make_dev_alias,  make_dev_alias_p,
       destroy_dev, destroy_dev_sched, destroy_dev_sched_cb, destroy_dev_drain, dev_depends — manage <u>cdev</u>'s  and
       DEVFS registration for devices

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;sys/param.h&gt;</b>
       <b>#include</b> <b>&lt;sys/conf.h&gt;</b>

       <u>void</u>
       <b>make_dev_args_init</b>(<u>struct</u> <u>make_dev_args</u> <u>*args</u>);

       <u>int</u>
       <b>make_dev_s</b>(<u>struct</u> <u>make_dev_args</u> <u>*args</u>, <u>struct</u> <u>cdev</u> <u>**cdev</u>, <u>const</u> <u>char</u> <u>*fmt</u>, <u>...</u>);

       <u>int</u>
       <b>make_dev_alias_p</b>(<u>int</u> <u>flags</u>, <u>struct</u> <u>cdev</u> <u>**cdev</u>, <u>struct</u> <u>cdev</u> <u>*pdev</u>, <u>const</u> <u>char</u> <u>*fmt</u>, <u>...</u>);

       <u>void</u>
       <b>destroy_dev</b>(<u>struct</u> <u>cdev</u> <u>*dev</u>);

       <u>void</u>
       <b>destroy_dev_sched</b>(<u>struct</u> <u>cdev</u> <u>*dev</u>);

       <u>void</u>
       <b>destroy_dev_sched_cb</b>(<u>struct</u> <u>cdev</u> <u>*dev</u>, <u>void</u> <u>(*cb)(void</u> <u>*)</u>, <u>void</u> <u>*arg</u>);

       <u>void</u>
       <b>destroy_dev_drain</b>(<u>struct</u> <u>cdevsw</u> <u>*csw</u>);

       <u>void</u>
       <b>dev_depends</b>(<u>struct</u> <u>cdev</u> <u>*pdev</u>, <u>struct</u> <u>cdev</u> <u>*cdev</u>);

       LEGACY INTERFACES

       <u>struct</u> <u>cdev</u> <u>*</u>
       <b>make_dev</b>(<u>struct</u> <u>cdevsw</u> <u>*cdevsw</u>, <u>int</u> <u>unit</u>, <u>uid_t</u> <u>uid</u>, <u>gid_t</u> <u>gid</u>, <u>int</u> <u>perms</u>, <u>const</u> <u>char</u> <u>*fmt</u>, <u>...</u>);

       <u>struct</u> <u>cdev</u> <u>*</u>
       <b>make_dev_cred</b>(<u>struct</u>  <u>cdevsw</u>  <u>*cdevsw</u>,  <u>int</u>  <u>unit</u>,  <u>struct</u>  <u>ucred</u>  <u>*cr</u>,  <u>uid_t</u> <u>uid</u>, <u>gid_t</u> <u>gid</u>, <u>int</u> <u>perms</u>,
           <u>const</u> <u>char</u> <u>*fmt</u>, <u>...</u>);

       <u>struct</u> <u>cdev</u> <u>*</u>
       <b>make_dev_credf</b>(<u>int</u> <u>flags</u>, <u>struct</u> <u>cdevsw</u> <u>*cdevsw</u>, <u>int</u> <u>unit</u>,  <u>struct</u>  <u>ucred</u>  <u>*cr</u>,  <u>uid_t</u>  <u>uid</u>,  <u>gid_t</u>  <u>gid</u>,
           <u>int</u> <u>perms</u>, <u>const</u> <u>char</u> <u>*fmt</u>, <u>...</u>);

       <u>int</u>
       <b>make_dev_p</b>(<u>int</u>  <u>flags</u>,  <u>struct</u> <u>cdev</u> <u>**cdev</u>, <u>struct</u> <u>cdevsw</u> <u>*devsw</u>, <u>struct</u> <u>ucred</u> <u>*cr</u>, <u>uid_t</u> <u>uid</u>, <u>gid_t</u> <u>gid</u>,
           <u>int</u> <u>mode</u>, <u>const</u> <u>char</u> <u>*fmt</u>, <u>...</u>);

       <u>struct</u> <u>cdev</u> <u>*</u>
       <b>make_dev_alias</b>(<u>struct</u> <u>cdev</u> <u>*pdev</u>, <u>const</u> <u>char</u> <u>*fmt</u>, <u>...</u>);

</pre><h4><b>DESCRIPTION</b></h4><pre>
       The <b>make_dev_s</b>() function creates a <u>cdev</u> structure for a new device, which  is  returned  into  the  <u>cdev</u>
       argument.   It  also notifies <u><a href="../man5/devfs.5.html">devfs</a></u>(5) of the presence of the new device, that causes corresponding nodes
       to be created.  Besides this, a <u><a href="../man4/devctl.4.html">devctl</a></u>(4) notification is sent.  The function takes the structure  <u>struct</u>
       <u>make_dev_args</u> <u>args</u>, which specifies the parameters for the device creation:

             struct make_dev_args {
                     size_t           mda_size;
                     int              mda_flags;
                     struct cdevsw   *mda_devsw;
                     struct ucred    *mda_cr;
                     uid_t            mda_uid;
                     gid_t            mda_gid;
                     int              mda_mode;
                     int              mda_unit;
                     void            *mda_si_drv1;
                     void            *mda_si_drv2;
             };
       Before   use   and   filling  with  the  desired  values,  the  structure  must  be  initialized  by  the
       <b>make_dev_args_init</b>() function, which ensures that future  kernel  interface  expansion  does  not  affect
       driver source code or binary interface.

       The  created device will be owned by <u>args.mda_uid</u>, with the group ownership as <u>args.mda_gid</u>.  The name is
       the expansion of <u>fmt</u> and following arguments as <u><a href="../man9/printf.9.html">printf</a></u>(9) would print it.  The name determines  its  path
       under  <u><a href="file:/dev">/dev</a></u>  or other <u><a href="../man5/devfs.5.html">devfs</a></u>(5) mount point and may contain slash ‘/’ characters to denote subdirectories.
       The permissions of the file specified in <u>args.mda_mode</u> are defined in &lt;<u>sys/stat.h</u>&gt;:

             #define S_IRWXU 0000700    /* RWX mask for owner */
             #define S_IRUSR 0000400    /* R for owner */
             #define S_IWUSR 0000200    /* W for owner */
             #define S_IXUSR 0000100    /* X for owner */

             #define S_IRWXG 0000070    /* RWX mask for group */
             #define S_IRGRP 0000040    /* R for group */
             #define S_IWGRP 0000020    /* W for group */
             #define S_IXGRP 0000010    /* X for group */

             #define S_IRWXO 0000007    /* RWX mask for other */
             #define S_IROTH 0000004    /* R for other */
             #define S_IWOTH 0000002    /* W for other */
             #define S_IXOTH 0000001    /* X for other */

             #define S_ISUID 0004000    /* set user id on execution */
             #define S_ISGID 0002000    /* set group id on execution */
             #define S_ISVTX 0001000    /* sticky bit */
             #ifndef _POSIX_SOURCE
             #define S_ISTXT 0001000
             #endif

       The <u>args.mda_cr</u> argument specifies credentials  that  will  be  stored  in  the  <u>si_cred</u>  member  of  the
       initialized <u>struct</u> <u>cdev</u>.

       The  <u>args.mda_flags</u>  argument  alters  the  operation of <b>make_dev_s.</b>() The following values are currently
       accepted:

             MAKEDEV_REF              reference the created device
             MAKEDEV_NOWAIT           do not sleep, the call may fail
             MAKEDEV_WAITOK           allow the function to sleep to satisfy malloc
             MAKEDEV_ETERNAL          created device will be never destroyed
             MAKEDEV_CHECKNAME        return an error if the device name is invalid or already exists

       Only MAKEDEV_NOWAIT, MAKEDEV_WAITOK and MAKEDEV_CHECKNAME values are accepted for the  <b>make_dev_alias_p</b>()
       function.

       The MAKEDEV_WAITOK flag is assumed if none of MAKEDEV_WAITOK, MAKEDEV_NOWAIT is specified.

       The  <u><a href="../man9/dev_clone.9.html">dev_clone</a></u>(9)  event  handler  shall  specify  MAKEDEV_REF flag when creating a device in response to
       lookup, to avoid race where the device created is destroyed immediately after <u><a href="../man9/devfs_lookup.9.html">devfs_lookup</a></u>(9)  drops  his
       reference to cdev.

       The  MAKEDEV_ETERNAL  flag allows the kernel to not acquire some locks when translating system calls into
       the cdevsw methods calls.  It is responsibility of the driver author to make sure that  <b>destroy_dev</b>()  is
       never  called  on  the returned cdev.  For the convenience, use the MAKEDEV_ETERNAL_KLD flag for the code
       that can be compiled into kernel or loaded (and unloaded) as loadable module.

       A panic will occur if the MAKEDEV_CHECKNAME flag is not specified and  the  device  name  is  invalid  or
       already exists.

       The <b>make_dev_p</b>() use of the form

             struct cdev *dev;
             int res;
             res = make_dev_p(flags, &amp;dev, cdevsw, cred, uid, gid, perms, name);
       is equivalent to the code

             struct cdev *dev;
             struct make_dev_args args;
             int res;

             make_dev_args_init(&amp;args);
             args.mda_flags = flags;
             args.mda_devsw = cdevsw;
             args.mda_cred = cred;
             args.mda_uid = uid;
             args.mda_gid = gid;
             args.mda_mode = perms;
             res = make_dev_s(&amp;args, &amp;dev, name);

       Similarly, the <b>make_dev_credf</b>() function call is equivalent to

                     (void) make_dev_s(&amp;args, &amp;dev, name);
       In  other  words,  <b>make_dev_credf</b>()  does not allow the caller to obtain the return value, and in kernels
       compiled with the <u>INVARIANTS</u> options, the function asserts that the device creation succeeded.

       The <b>make_dev_cred</b>() function is equivalent to the call

             make_dev_credf(0, cdevsw, unit, cr, uid, gid, perms, fmt, ...);

       The <b>make_dev</b>() function call is the same as

             make_dev_credf(0, cdevsw, unit, NULL, uid, gid, perms, fmt, ...);

       The <b>make_dev_alias_p</b>() function takes the returned <u>cdev</u> from <b>make_dev</b>() and makes another (aliased)  name
       for this device.  It is an error to call <b>make_dev_alias_p</b>() prior to calling <b>make_dev</b>().

       The  <b>make_dev_alias</b>() function is similar to <b>make_dev_alias</b>() but it returns the resulting aliasing <u>*cdev</u>
       and may not return an error.

       The <u>cdev</u> returned by <b>make_dev_s</b>() and <b>make_dev_alias_p</b>() has two fields, <u>si_drv1</u> and  <u>si_drv2</u>,  that  are
       available to store state.  Both fields are of type <u>void</u> <u>*</u>, and can be initialized simultaneously with the
       <u>cdev</u>  allocation  by  filling  <u>args.mda_si_drv1</u> and <u>args.mda_si_drv2</u> members of the <b>make_dev_s</b>() argument
       structure, or filled after the <u>cdev</u> is allocated, if using legacy interfaces.  In the  latter  case,  the
       driver  should handle the race of accessing uninitialized <u>si_drv1</u> and <u>si_drv2</u> itself.  These are designed
       to replace the <u>unit</u> argument to <b>make_dev</b>(), which can be obtained with <b>dev2unit</b>().

       The <b>destroy_dev</b>() function takes the returned <u>cdev</u> from <b>make_dev</b>() and destroys the registration for that
       device.  The notification is sent to <u><a href="../man4/devctl.4.html">devctl</a></u>(4) about the destruction event.  Do not call <b>destroy_dev</b>() on
       devices that were created with <b>make_dev_alias</b>().

       The <b>dev_depends</b>() function establishes a parent-child relationship between two devices.  The  net  effect
       is  that a <b>destroy_dev</b>() of the parent device will also result in the destruction of the child device(s),
       if any exist.  A device may simultaneously be a parent and a child, so it is possible to build a complete
       hierarchy.

       The <b>destroy_dev_sched_cb</b>() function schedules execution of the <b>destroy_dev</b>() for the  specified  <u>cdev</u>  in
       the  safe  context.  After <b>destroy_dev</b>() is finished, and if the supplied <u>cb</u> is not NULL, the callback <u>cb</u>
       is called, with argument <u>arg</u>.  The <b>destroy_dev_sched</b>() function is the same as

             destroy_dev_sched_cb(cdev, NULL, NULL);

       The <b>d_close</b>()  driver  method  cannot  call  <b>destroy_dev</b>()  directly.   Doing  so  causes  deadlock  when
       <b>destroy_dev</b>()  waits for all threads to leave the driver methods.  Also, because <b>destroy_dev</b>() sleeps, no
       non-sleepable locks may be held over the call.  The  <b>destroy_dev_sched</b>()  family  of  functions  overcome
       these issues.

       The  device driver may call the <b>destroy_dev_drain</b>() function to wait until all devices that have supplied
       <u>csw</u> as cdevsw, are destroyed.  This is useful when driver knows that <b>destroy_dev_sched</b>()  is  called  for
       all instantiated devices, but need to postpone module unload until <b>destroy_dev</b>() is actually finished for
       all of them.

</pre><h4><b>RETURN</b> <b>VALUES</b></h4><pre>
       If  successful,  <b>make_dev_s</b>()  and  <b>make_dev_p</b>()  will return 0, otherwise they will return an error.  If
       successful, <b>make_dev_credf</b>() will return a valid <u>cdev</u> pointer, otherwise it will return NULL.

</pre><h4><b>ERRORS</b></h4><pre>
       The <b>make_dev_s</b>(), <b>make_dev_p</b>() and <b>make_dev_alias_p</b>()  calls  will  fail  and  the  device  will  be  not
       registered if:

       [ENOMEM]           The  MAKEDEV_NOWAIT  flag  was  specified and a memory allocation request could not be
                          satisfied.

       [ENAMETOOLONG]     The MAKEDEV_CHECKNAME flag was specified and the provided device name is  longer  than
                          SPECNAMELEN.

       [EINVAL]           The  MAKEDEV_CHECKNAME  flag  was  specified  and  the  provided device name is empty,
                          contains a "." or ".." path component or ends with ‘/’.

       [EINVAL]           The MAKEDEV_CHECKNAME flag was specified and the provided device name contains invalid
                          characters.

       [EEXIST]           The MAKEDEV_CHECKNAME flag was specified and the provided device name already exists.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man4/devctl.4.html">devctl</a></u>(4), <u><a href="../man5/devfs.5.html">devfs</a></u>(5), <u><a href="../man9/dev_clone.9.html">dev_clone</a></u>(9)

</pre><h4><b>HISTORY</b></h4><pre>
       The <b>make_dev</b>() and <b>destroy_dev</b>() functions first appeared in FreeBSD 4.0.  The function  <b>make_dev_alias</b>()
       first  appeared in FreeBSD 4.1.  The function <b>dev_depends</b>() first appeared in FreeBSD 5.0.  The functions
       <b>make_dev_credf</b>(),  <b>destroy_dev_sched</b>(),  <b>destroy_dev_sched_cb</b>()  first  appeared  in  FreeBSD  7.0.   The
       function  <b>make_dev_p</b>()  first  appeared  in  FreeBSD  8.2.   The  function <b>make_dev_s</b>() first appeared in
       FreeBSD 11.0.

Debian                                            March 2, 2016                                      <u><a href="../man9/MAKE_DEV.9.html">MAKE_DEV</a></u>(9)
</pre>
 </div>
</div></section>
</div>
</body>
</html>