<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>osd,  osd_register,  osd_deregister,  osd_set, osd_reserve, osd_set_reserved, osd_free_reserved, osd_get,</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/freebsd-manpages">freebsd-manpages_12.2-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       osd,  osd_register,  osd_deregister,  osd_set, osd_reserve, osd_set_reserved, osd_free_reserved, osd_get,
       osd_del, osd_call, osd_exit â€” Object Specific Data

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;sys/osd.h&gt;</b>

       <u>typedef</u> <u>void</u>
       (<b>*osd_destructor_t</b>)(<u>void</u> <u>*value</u>);

       <u>typedef</u> <u>int</u>
       (<b>*osd_method_t</b>)(<u>void</u> <u>*obj</u>, <u>void</u> <u>*data</u>);

       <u>int</u>
       <b>osd_register</b>(<u>u_int</u> <u>type</u>, <u>osd_destructor_t</u> <u>destructor</u>, <u>osd_method_t</u> <u>*methods</u>);

       <u>void</u>
       <b>osd_deregister</b>(<u>u_int</u> <u>type</u>, <u>u_int</u> <u>slot</u>);

       <u>int</u>
       <b>osd_set</b>(<u>u_int</u> <u>type</u>, <u>struct</u> <u>osd</u> <u>*osd</u>, <u>u_int</u> <u>slot</u>, <u>void</u> <u>*value</u>);

       <u>void</u> <u>**</u>
       <b>osd_reserve</b>(<u>u_int</u> <u>slot</u>);

       <u>int</u>
       <b>osd_set_reserved</b>(<u>u_int</u> <u>type</u>, <u>struct</u> <u>osd</u> <u>*osd</u>, <u>u_int</u> <u>slot</u>, <u>void</u> <u>**rsv</u>, <u>void</u> <u>*value</u>);

       <u>void</u>
       <b>osd_free_reserved</b>(<u>void</u> <u>**rsv</u>);

       <u>void</u> <u>*</u>
       <b>osd_get</b>(<u>u_int</u> <u>type</u>, <u>struct</u> <u>osd</u> <u>*osd</u>, <u>u_int</u> <u>slot</u>);

       <u>void</u>
       <b>osd_del</b>(<u>u_int</u> <u>type</u>, <u>struct</u> <u>osd</u> <u>*osd</u>, <u>u_int</u> <u>slot</u>);

       <u>int</u>
       <b>osd_call</b>(<u>u_int</u> <u>type</u>, <u>u_int</u> <u>method</u>, <u>void</u> <u>*obj</u>, <u>void</u> <u>*data</u>);

       <u>void</u>
       <b>osd_exit</b>(<u>u_int</u> <u>type</u>, <u>struct</u> <u>osd</u> <u>*osd</u>);

</pre><h4><b>DESCRIPTION</b></h4><pre>
       The <b>osd</b> framework provides a mechanism to dynamically associate  arbitrary  data  at  run-time  with  any
       kernel  data  structure  which  has  been  suitably  modified for use with <b>osd</b>.  The one-off modification
       required involves embedding a <u>struct</u> <u>osd</u> inside the kernel data structure.

       An additional benefit is that after the initial change to a structure is made, all subsequent use of  <b>osd</b>
       with the structure involves no changes to the structure's layout.  By extension, if the data structure is
       part of the ABI, <b>osd</b> provides a way of extending the structure in an ABI preserving manner.

       The  details of the embedded <u>struct</u> <u>osd</u> are not relevant to consumers of the <b>osd</b> framework and should not
       be manipulated directly.

       Data associated with a structure is referenced by the <b>osd</b> framework using a  type/slot  identifier  pair.
       Types  are statically defined in &lt;<u>sys/osd.h</u>&gt; and provide a high-level grouping for slots to be registered
       under.  Slot identifiers are dynamically assigned by the framework when a data type is  registered  using
       <b>osd_register</b>() and remains valid until a corresponding call to <b>osd_deregister</b>().

   <b>Functions</b>
       The  <b>osd_register</b>()  function registers a type/slot identifier pair with the <b>osd</b> framework for use with a
       new data type.  The function may sleep and therefore cannot be called from a non-sleepable context.   The
       <u>type</u>  argument  specifies  which  high-level type grouping from &lt;<u>sys/osd.h</u>&gt; the slot identifier should be
       allocated under.  The <u>destructor</u> argument specifies an optional osd_destructor_t  function  pointer  that
       will  be  called  for  objects  of  the  type being registered which are later destroyed by the <b>osd_del</b>()
       function.  NULL may be passed if no destructor is required.  The <u>methods</u> argument specifies  an  optional
       array  of osd_method_t function pointers which can be later invoked by the <b>osd_call</b>() function.  NULL may
       be passed if no methods are required.  The <u>methods</u> argument is currently only useful  with  the  OSD_JAIL
       type identifier.

       The  <b>osd_deregister</b>()  function  deregisters  a  previously  registered  type/slot  identifier pair.  The
       function may sleep and therefore cannot be called  from  a  non-sleepable  context.   The  <u>type</u>  argument
       specifies  which  high-level  type grouping from &lt;<u>sys/osd.h</u>&gt; the slot identifier is allocated under.  The
       <u>slot</u> argument specifies the slot identifier which is being deregistered and should be the value that  was
       returned by <b>osd_register</b>() when the data type was registered.

       The <b>osd_set</b>() function associates a data object pointer with a kernel data structure's <u>struct</u> <u>osd</u> member.
       The  <u>type</u>  argument  specifies  which  high-level  type  grouping from &lt;<u>sys/osd.h</u>&gt; the slot identifier is
       allocated under.  The <u>osd</u> argument is a pointer to the kernel data structure's <u>struct</u> <u>osd</u> which will have
       the <u>value</u> pointer associated with it.  The <u>slot</u> argument specifies the  slot  identifier  to  assign  the
       <u>value</u> pointer to.  The <u>value</u> argument points to a data object to associate with <u>osd</u>.

       The  <b>osd_set_reserved</b>()  function  does  the  same  as  <b>osd_set</b>(), but with an extra argument <u>rsv</u> that is
       internal-use memory previously allocated via <b>osd_reserve</b>().

       The <b>osd_get</b>() function returns the data pointer associated with a  kernel  data  structure's  <u>struct</u>  <u>osd</u>
       member  from  the specified type/slot identifier pair.  The <u>type</u> argument specifies which high-level type
       grouping from &lt;<u>sys/osd.h</u>&gt; the slot identifier is allocated under.  The <u>osd</u> argument is a pointer  to  the
       kernel  data  structure's  <u>struct</u> <u>osd</u> to retrieve the data pointer from.  The <u>slot</u> argument specifies the
       slot identifier to retrieve the data pointer from.

       The <b>osd_del</b>() function removes the data pointer associated with a  kernel  data  structure's  <u>struct</u>  <u>osd</u>
       member  from  the specified type/slot identifier pair.  The <u>type</u> argument specifies which high-level type
       grouping from &lt;<u>sys/osd.h</u>&gt; the slot identifier is allocated under.  The <u>osd</u> argument is a pointer  to  the
       kernel data structure's <u>struct</u> <u>osd</u> to remove the data pointer from.  The <u>slot</u> argument specifies the slot
       identifier  to  remove  the  data pointer from.  If an osd_destructor_t function pointer was specified at
       registration time, the destructor function will be called and passed the data pointer for  the  type/slot
       identifier pair which is being deleted.

       The  <b>osd_call</b>()  function  calls the specified osd_method_t function pointer for all currently registered
       slots of a given type on the specified <u>obj</u> and <u>data</u> pointers.   The  function  may  sleep  and  therefore
       cannot  be  called  from  a  non-sleepable  context.   The  <u>type</u> argument specifies which high-level type
       grouping from &lt;<u>sys/osd.h</u>&gt; to call the method for.  The <u>method</u>  argument  specifies  the  index  into  the
       osd_method_t  array  that  was  passed  to  <b>osd_register</b>().  The <u>obj</u> and <u>data</u> arguments are passed to the
       method function pointer of each slot.

       The <b>osd_exit</b>() function removes all data object pointers from all currently registered slots for a  given
       type  for  the  specified  kernel  data structure's <u>struct</u> <u>osd</u> member.  The <u>type</u> argument specifies which
       high-level type grouping from &lt;<u>sys/osd.h</u>&gt; to remove data pointers from.  The <u>osd</u> argument is a pointer to
       the kernel data structure's <u>struct</u> <u>osd</u> to remove all data object pointers for  all  currently  registered
       slots from.

</pre><h4><b>IMPLEMENTATION</b> <b>NOTES</b></h4><pre>
       <b>osd</b>  uses  a  two  dimensional matrix (array of arrays) as the data structure to manage the external data
       associated with a kernel data structure's <u>struct</u> <u>osd</u> member.  The type identifier is used  as  the  index
       into  the  outer  array,  and  the  slot identifier is used as the index into the inner array.  To set or
       retrieve a data pointer for a given type/slot  identifier  pair,  <b>osd_set</b>()  and  <b>osd_get</b>()  perform  the
       equivalent of array[type][slot], which is both constant time and fast.

       If  <b>osd_set</b>()  is  called  on  a  <u>struct</u>  <u>osd</u>  for the first time, the array for storing data pointers is
       dynamically allocated using <u><a href="../man9/malloc.9.html">malloc</a></u>(9) with M_NOWAIT to a size appropriate for the slot  identifier  being
       set.   If  a  subsequent  call to <b>osd_set</b>() attempts to set a slot identifier which is numerically larger
       than the slot used in the previous  <b>osd_set</b>()  call,  <u><a href="../man9/realloc.9.html">realloc</a></u>(9)  is  used  to  grow  the  array  to  the
       appropriate size such that the slot identifier can be used.  To maximise the efficiency of any code which
       calls  <b>osd_set</b>()  sequentially  on a number of different slot identifiers (e.g., during an initialisation
       phase) one should loop through the slot identifiers in descending order from  highest  to  lowest.   This
       will  result  in  only  a  single  <u><a href="../man9/malloc.9.html">malloc</a></u>(9)  call  to  create  an array of the largest slot size and all
       subsequent calls to <b>osd_set</b>() will proceed without any <u><a href="../man9/realloc.9.html">realloc</a></u>(9) calls.

       It is possible for <b>osd_set</b>() to fail to allocate this array.  To ensure that  such  allocation  succeeds,
       <b>osd_reserve</b>()  may  be  called  (in  a  non-blocking  context),  and  it will pre-allocate the memory via
       <u><a href="../man9/malloc.9.html">malloc</a></u>(9) with M_WAITOK.  Then this pre-allocated memory is passed to <b>osd_set_reserved</b>(), which will  use
       it  if  necessary  or  otherwise  discard  it.   The  memory  may also be explicitly discarded by calling
       <b>osd_free_reserved</b>().  As this method always allocates memory whether or not it is ultimately  needed,  it
       should be used only rarely, such as in the unlikely event that <b>osd_set</b>() fails.

       The  <b>osd</b>  API  is  geared towards slot identifiers storing pointers to the same underlying data structure
       type for a given <b>osd</b> type identifier.  This is  not  a  requirement,  and  <u><a href="../man9/khelp.9.html">khelp</a></u>(9)  for  example  stores
       completely different data types in slots under the OSD_KHELP type identifier.

   <b>Locking</b>
       <b>osd</b>  internally uses a mix of <u><a href="../man9/mutex.9.html">mutex</a></u>(9), <u><a href="../man9/rmlock.9.html">rmlock</a></u>(9) and <u><a href="../man9/sx.9.html">sx</a></u>(9) locks to protect its internal data structures
       and state.

       Responsibility for synchronising access to a kernel data structure's <u>struct</u> <u>osd</u> member  is  left  to  the
       subsystem that uses the data structure and calls the <b>osd</b> API.

       <b>osd_get</b>()  only  acquires  an  <u>rmlock</u>  in  read  mode, therefore making it safe to use in the majority of
       contexts within the kernel including most fast paths.

</pre><h4><b>RETURN</b> <b>VALUES</b></h4><pre>
       <b>osd_register</b>() returns the slot identifier for the newly registered data type.

       <b>osd_set</b>() and <b>osd_set_reserved</b>() return zero on success or ENOMEM if the specified  type/slot  identifier
       pair  triggered  an internal <u><a href="../man9/realloc.9.html">realloc</a></u>(9) which failed ( <b>osd_set_reserved</b>() will always succeed when <u>rsv</u> is
       non-NULL).

       <b>osd_get</b>() returns the data pointer for the specified type/slot identifier pair, or NULL if the  slot  has
       not been initialised yet.

       <b>osd_reserve</b>() returns a pointer suitable for passing to <b>osd_set_reserved</b>() or <b>osd_free_reserved</b>().

       <b>osd_call</b>()  returns  zero if no method is run or the method for each slot runs successfully.  If a method
       for a slot returns non-zero, <b>osd_call</b>() terminates prematurely and returns  the  method's  error  to  the
       caller.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man9/khelp.9.html">khelp</a></u>(9)

</pre><h4><b>HISTORY</b></h4><pre>
       The Object Specific Data (OSD) facility first appeared in FreeBSD 8.0.

</pre><h4><b>AUTHORS</b></h4><pre>
       The <b>osd</b> facility was written by Pawel Jakub Dawidek &lt;<u><a href="mailto:pjd@FreeBSD.org">pjd@FreeBSD.org</a></u>&gt;.

       This manual page was written by Lawrence Stewart &lt;<u><a href="mailto:lstewart@FreeBSD.org">lstewart@FreeBSD.org</a></u>&gt;.

Debian                                           April 26, 2016                                           <u><a href="../man9/OSD.9.html">OSD</a></u>(9)
</pre>
 </div>
</div></section>
</div>
</body>
</html>