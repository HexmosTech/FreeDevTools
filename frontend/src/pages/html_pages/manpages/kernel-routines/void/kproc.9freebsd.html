<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kproc_start, kproc_shutdown, kproc_create, kproc_exit, kproc_resume, kproc_suspend, kproc_suspend_check —</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/freebsd-manpages">freebsd-manpages_12.2-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       kproc_start, kproc_shutdown, kproc_create, kproc_exit, kproc_resume, kproc_suspend, kproc_suspend_check —
       kernel processes

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;sys/kthread.h&gt;</b>

       <u>void</u>
       <b>kproc_start</b>(<u>const</u> <u>void</u> <u>*udata</u>);

       <u>void</u>
       <b>kproc_shutdown</b>(<u>void</u> <u>*arg</u>, <u>int</u> <u>howto</u>);

       <u>int</u>
       <b>kproc_create</b>(<u>void</u> <u>(*func)(void</u> <u>*)</u>, <u>void</u> <u>*arg</u>, <u>struct</u> <u>proc</u> <u>**newpp</u>, <u>int</u> <u>flags</u>, <u>int</u> <u>pages</u>, <u>const</u> <u>char</u> <u>*fmt</u>,
           <u>...</u>);

       <u>void</u>
       <b>kproc_exit</b>(<u>int</u> <u>ecode</u>);

       <u>int</u>
       <b>kproc_resume</b>(<u>struct</u> <u>proc</u> <u>*p</u>);

       <u>int</u>
       <b>kproc_suspend</b>(<u>struct</u> <u>proc</u> <u>*p</u>, <u>int</u> <u>timo</u>);

       <u>void</u>
       <b>kproc_suspend_check</b>(<u>struct</u> <u>proc</u> <u>*p</u>);

       <u>int</u>
       <b>kproc_kthread_add</b>(<u>void</u> <u>(*func)(void</u> <u>*)</u>,    <u>void</u> <u>*arg</u>,    <u>struct</u> <u>proc</u> <u>**procptr</u>,    <u>struct</u> <u>thread</u> <u>**tdptr</u>,
           <u>int</u> <u>flags</u>, <u>int</u> <u>pages</u>, <u>char</u> <u>*</u> <u>procname</u>, <u>const</u> <u>char</u> <u>*fmt</u>, <u>...</u>);

</pre><h4><b>DESCRIPTION</b></h4><pre>
       In FreeBSD 8.0, the <b>kthread*</b>(<u>9</u>) family of functions was renamed to be the <b>kproc*</b>(<u>9</u>) family of  functions,
       as  they  were  misnamed  and actually produced kernel processes.  A new family of <u>different</u> <b>kthread_*</b>(<u>9</u>)
       functions was added to produce <u>real</u> kernel <u>threads</u>.  See the <u><a href="../man9/kthread.9.html">kthread</a></u>(9) man page for more information  on
       those calls.  Also note that the <b>kproc_kthread_add</b>(<u>9</u>) function appears in both pages as its functionality
       is split.

       The  function  <b>kproc_start</b>() is used to start “internal” daemons such as <b>bufdaemon</b>, <b>pagedaemon</b>, <b>vmdaemon</b>,
       and the <b>syncer</b> and is intended to be called from <u><a href="../man9/SYSINIT.9.html">SYSINIT</a></u>(9).  The <u>udata</u> argument is actually a pointer to
       a <u>struct</u> <u>kproc_desc</u> which describes the kernel process that should be created:

             struct kproc_desc {
                     char            *arg0;
                     void            (*func)(void);
                     struct proc     **global_procpp;
             };

       The structure members are used by <b>kproc_start</b>() as follows:

             <u>arg0</u>           String to be used for the name of the process.  This string will be copied into  the
                            <u>p_comm</u> member of the new process' <u>struct</u> <u>proc</u>.

             <u>func</u>           The main function for this kernel process to run.

             <u>global_procpp</u>  A  pointer  to  a  <u>struct</u>  <u>proc</u> pointer that should be updated to point to the newly
                            created process' process structure.  If this variable is NULL, then it is ignored.

       The <b>kproc_create</b>() function is used to create a kernel process.  The new process shares its address space
       with process 0, the <b>swapper</b> process, and runs in kernel mode  only.   The  <u>func</u>  argument  specifies  the
       function  that the process should execute.  The <u>arg</u> argument is an arbitrary pointer that is passed in as
       the only argument to <u>func</u> when it is called by the new process.  The <u>newpp</u> pointer  points  to  a  <u>struct</u>
       <u>proc</u> pointer that is to be updated to point to the newly created process.  If this argument is NULL, then
       it is ignored.  The <u>flags</u> argument specifies a set of flags as described in <u><a href="../man2/rfork.2.html">rfork</a></u>(2).  The <u>pages</u> argument
       specifies  the  size  of the new kernel process's stack in pages.  If 0 is used, the default kernel stack
       size is allocated.  The rest of the arguments form a <u><a href="../man9/printf.9.html">printf</a></u>(9) argument list that is used  to  build  the
       name of the new process and is stored in the <u>p_comm</u> member of the new process's <u>struct</u> <u>proc</u>.

       The  <b>kproc_exit</b>()  function  is  used  to  terminate  kernel  processes.  It should be called by the main
       function of the kernel process rather than letting the main function return to  its  caller.   The  <u>ecode</u>
       argument  specifies the exit status of the process.  While exiting, the function <u><a href="../man9/exit1.9.html">exit1</a></u>(9) will initiate a
       call to <u><a href="../man9/wakeup.9.html">wakeup</a></u>(9) on the process handle.

       The <b>kproc_resume</b>(), <b>kproc_suspend</b>(), and <b>kproc_suspend_check</b>() functions are used to suspend and resume a
       kernel process.  During the main loop of its execution, a kernel process that wishes to allow  itself  to
       be  suspended  should  call <b>kproc_suspend_check</b>() passing in <u>curproc</u> as the only argument.  This function
       checks to see if the kernel process has been asked to suspend.  If it has, it will <u><a href="../man9/tsleep.9.html">tsleep</a></u>(9) until it  is
       told  to resume.  Once it has been told to resume it will return allowing execution of the kernel process
       to continue.  The other two functions are used to notify a kernel process of a suspend or resume request.
       The  <u>p</u>  argument  points  to  the  <u>struct</u>  <u>proc</u>  of  the  kernel  process  to  suspend  or  resume.   For
       <b>kproc_suspend</b>(),  the <u>timo</u> argument specifies a timeout to wait for the kernel process to acknowledge the
       suspend request and suspend itself.

       The <b>kproc_shutdown</b>() function is meant to be registered as a shutdown event  for  kernel  processes  that
       need  to  be  suspended  voluntarily  during  system shutdown so as not to interfere with system shutdown
       activities.  The actual suspension of the kernel process is done with <b>kproc_suspend</b>().

       The <b>kproc_kthread_add</b>() function is much like the <b>kproc_create</b>() function above except that if the  kproc
       already  exists,  then  only  a new thread (see <u><a href="../man9/kthread.9.html">kthread</a></u>(9)) is created on the existing process.  The <u>func</u>
       argument specifies the function that the process should  execute.   The  <u>arg</u>  argument  is  an  arbitrary
       pointer that is passed in as the only argument to <u>func</u> when it is called by the new process.  The <u>procptr</u>
       pointer points to a <u>struct</u> <u>proc</u> pointer that is the location to be updated with the new proc pointer if a
       new  process  is  created,  or  if  not  NULL,  must contain the process pointer for the already existing
       process.  If this argument points to NULL, then a new process is created and the field updated.   If  not
       NULL, the <u>tdptr</u> pointer points to a <u>struct</u> <u>thread</u> pointer that is the location to be updated with the new
       thread  pointer.   The  <u>flags</u>  argument  specifies  a  set  of flags as described in <u><a href="../man2/rfork.2.html">rfork</a></u>(2).  The <u>pages</u>
       argument specifies the size of the new kernel thread's stack in pages.  If 0 is used, the default  kernel
       stack  size  is allocated.  The procname argument is the name the new process should be given if it needs
       to be created.  It is <u>NOT</u> a printf style format specifier but a simple string.  The rest of the arguments
       form a <u><a href="../man9/printf.9.html">printf</a></u>(9) argument list that is used to build the name of the new thread  and  is  stored  in  the
       <u>td_name</u> member of the new thread's <u>struct</u> <u>thread</u>.

</pre><h4><b>RETURN</b> <b>VALUES</b></h4><pre>
       The  <b>kproc_create</b>(), <b>kproc_resume</b>(), and <b>kproc_suspend</b>() functions return zero on success and non-zero on
       failure.

</pre><h4><b>EXAMPLES</b></h4><pre>
       This  example  demonstrates  the  use  of  a  <u>struct</u>  <u>kproc_desc</u>   and   the   functions   <b>kproc_start</b>(),
       <b>kproc_shutdown</b>(), and <b>kproc_suspend_check</b>() to run the <b>bufdaemon</b> process.

             static struct proc *bufdaemonproc;

             static struct kproc_desc buf_kp = {
                     "bufdaemon",
                     buf_daemon,
                     &amp;bufdaemonproc
             };
             SYSINIT(bufdaemon, SI_SUB_KTHREAD_BUF, SI_ORDER_FIRST, kproc_start,
                 &amp;buf_kp)

             static void
             buf_daemon()
             {
                     ...
                     /*
                      * This process needs to be suspended prior to shutdown sync.
                      */
                     EVENTHANDLER_REGISTER(shutdown_pre_sync, kproc_shutdown,
                         bufdaemonproc, SHUTDOWN_PRI_LAST);
                     ...
                     for (;;) {
                             kproc_suspend_check(bufdaemonproc);
                             ...
                     }
             }

</pre><h4><b>ERRORS</b></h4><pre>
       The <b>kproc_resume</b>() and <b>kproc_suspend</b>() functions will fail if:

       [EINVAL]           The <u>p</u> argument does not reference a kernel process.

       The <b>kproc_create</b>() function will fail if:

       [EAGAIN]           The  system-imposed  limit  on  the total number of processes under execution would be
                          exceeded.  The limit is given by the <u><a href="../man3/sysctl.3.html">sysctl</a></u>(3) MIB variable KERN_MAXPROC.

       [EINVAL]           The RFCFDG flag was specified in the <u>flags</u> parameter.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man2/rfork.2.html">rfork</a></u>(2), <u><a href="../man9/exit1.9.html">exit1</a></u>(9), <u><a href="../man9/kthread.9.html">kthread</a></u>(9), <u><a href="../man9/SYSINIT.9.html">SYSINIT</a></u>(9), <u><a href="../man9/wakeup.9.html">wakeup</a></u>(9)

</pre><h4><b>HISTORY</b></h4><pre>
       The <b>kproc_start</b>()  function  first  appeared  in  FreeBSD  2.2.   The  <b>kproc_shutdown</b>(),  <b>kproc_create</b>(),
       <b>kproc_exit</b>(),  <b>kproc_resume</b>(),  <b>kproc_suspend</b>(),  and  <b>kproc_suspend_check</b>() functions were introduced in
       FreeBSD  4.0.   Prior  to  FreeBSD  5.0,  the  <b>kproc_shutdown</b>(),  <b>kproc_resume</b>(),  <b>kproc_suspend</b>(),   and
       <b>kproc_suspend_check</b>()  functions  were  named  <b>shutdown_kproc</b>(),  <b>resume_kproc</b>(),  <b>shutdown_kproc</b>(),  and
       <b>kproc_suspend_loop</b>(), respectively.  Originally they had  the  names  <b>kthread_*</b>()  but  were  changed  to
       <b>kproc_*</b>() when real kthreads became available.

Debian                                          October 19, 2007                                        <u><a href="../man9/KPROC.9.html">KPROC</a></u>(9)
</pre>
 </div>
</div></section>
</div>
</body>
</html>