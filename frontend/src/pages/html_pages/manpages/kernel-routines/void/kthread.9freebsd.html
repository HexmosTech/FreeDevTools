<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kthread_start,    kthread_shutdown,    kthread_add,    kthread_exit,   kthread_resume,   kthread_suspend,</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/freebsd-manpages">freebsd-manpages_12.2-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       kthread_start,    kthread_shutdown,    kthread_add,    kthread_exit,   kthread_resume,   kthread_suspend,
       kthread_suspend_check — kernel threads

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;sys/kthread.h&gt;</b>

       <u>void</u>
       <b>kthread_start</b>(<u>const</u> <u>void</u> <u>*udata</u>);

       <u>void</u>
       <b>kthread_shutdown</b>(<u>void</u> <u>*arg</u>, <u>int</u> <u>howto</u>);

       <u>void</u>
       <b>kthread_exit</b>(<u>void</u>);

       <u>int</u>
       <b>kthread_resume</b>(<u>struct</u> <u>thread</u> <u>*td</u>);

       <u>int</u>
       <b>kthread_suspend</b>(<u>struct</u> <u>thread</u> <u>*td</u>, <u>int</u> <u>timo</u>);

       <u>void</u>
       <b>kthread_suspend_check</b>(<u>void</u>);

       <b>#include</b> <b>&lt;sys/unistd.h&gt;</b>

       <u>int</u>
       <b>kthread_add</b>(<u>void</u> <u>(*func)(void</u> <u>*)</u>,  <u>void</u> <u>*arg</u>,  <u>struct</u> <u>proc</u> <u>*procp</u>,  <u>struct</u> <u>thread</u> <u>**newtdpp</u>,   <u>int</u> <u>flags</u>,
           <u>int</u> <u>pages</u>, <u>const</u> <u>char</u> <u>*fmt</u>, <u>...</u>);

       <u>int</u>
       <b>kproc_kthread_add</b>(<u>void</u> <u>(*func)(void</u> <u>*)</u>,    <u>void</u> <u>*arg</u>,    <u>struct</u> <u>proc</u> <u>**procptr</u>,    <u>struct</u> <u>thread</u> <u>**tdptr</u>,
           <u>int</u> <u>flags</u>, <u>int</u> <u>pages</u>, <u>char</u> <u>*</u> <u>procname</u>, <u>const</u> <u>char</u> <u>*fmt</u>, <u>...</u>);

</pre><h4><b>DESCRIPTION</b></h4><pre>
       In FreeBSD 8.0, the older family of <b>kthread_*</b>(<u>9</u>) functions was renamed to be  the  <b>kproc_*</b>(<u>9</u>)  family  of
       functions,  as  they were previously misnamed and actually produced kernel processes.  This new family of
       <b>kthread_*</b>(<u>9</u>) functions was added to produce <u>real</u> kernel threads.  See the  <u><a href="../man9/kproc.9.html">kproc</a></u>(9)  man  page  for  more
       information on the renamed calls.  Also note that the <b>kproc_kthread_add</b>(<u>9</u>) function appears in both pages
       as its functionality is split.

       The function <b>kthread_start</b>() is used to start “internal” daemons such as <b>bufdaemon</b>, <b>pagedaemon</b>, <b>vmdaemon</b>,
       and the <b>syncer</b> and is intended to be called from <u><a href="../man9/SYSINIT.9.html">SYSINIT</a></u>(9).  The <u>udata</u> argument is actually a pointer to
       a <u>struct</u> <u>kthread_desc</u> which describes the kernel thread that should be created:

             struct kthread_desc {
                     char            *arg0;
                     void            (*func)(void);
                     struct thread   **global_threadpp;
             };

       The structure members are used by <b>kthread_start</b>() as follows:

             <u>arg0</u>             String to be used for the name of the thread.  This string will be copied into the
                              <u>td_name</u> member of the new threads' <u>struct</u> <u>thread</u>.

             <u>func</u>             The main function for this kernel thread to run.

             <u>global_threadpp</u>  A  pointer to a <u>struct</u> <u>thread</u> pointer that should be updated to point to the newly
                              created thread's <u>thread</u> structure.  If this variable is NULL, then it is  ignored.
                              The thread will be a subthread of <u>proc0</u> (PID 0).

       The  <b>kthread_add</b>()  function is used to create a kernel thread.  The new thread runs in kernel mode only.
       It is added to the process specified by the <u>procp</u> argument, or if that  is  NULL,  to  <u>proc0</u>.   The  <u>func</u>
       argument specifies the function that the thread should execute.  The <u>arg</u> argument is an arbitrary pointer
       that  is passed in as the only argument to <u>func</u> when it is called by the new thread.  The <u>newtdpp</u> pointer
       points to a <u>struct</u> <u>thread</u> pointer that is to be updated to point to the newly created  thread.   If  this
       argument  is NULL, then it is ignored.  The <u>flags</u> argument may be set to RFSTOPPED to leave the thread in
       a stopped state.  The caller must call <b>sched_add</b>() to start the thread.  The <u>pages</u> argument specifies the
       size of the new kernel thread's stack in pages.   If  0  is  used,  the  default  kernel  stack  size  is
       allocated.   The  rest  of the arguments form a <u><a href="../man9/printf.9.html">printf</a></u>(9) argument list that is used to build the name of
       the new thread and is stored in the <u>td_name</u> member of the new thread's <u>struct</u> <u>thread</u>.

       The <b>kproc_kthread_add</b>() function is much like the <b>kthread_add</b>() function above except that if  the  kproc
       does not already exist, it is created.  This function is better documented in the <u><a href="../man9/kproc.9.html">kproc</a></u>(9) manual page.

       The  <b>kthread_exit</b>()  function  is  used  to  terminate  kernel  threads.  It should be called by the main
       function of the kernel thread rather than letting the main function return to its caller.

       The <b>kthread_resume</b>(), <b>kthread_suspend</b>(), and <b>kthread_suspend_check</b>() functions are used  to  suspend  and
       resume  a  kernel  thread.   During  the main loop of its execution, a kernel thread that wishes to allow
       itself to be suspended should call <b>kthread_suspend_check</b>() in order to check if the it has been asked  to
       suspend.   If  it  has, it will <u><a href="../man9/msleep.9.html">msleep</a></u>(9) until it is told to resume.  Once it has been told to resume it
       will return allowing execution of the kernel thread to continue.  The other two  functions  are  used  to
       notify  a  kernel  thread of a suspend or resume request.  The <u>td</u> argument points to the <u>struct</u> <u>thread</u> of
       the kernel thread to suspend or resume.  For <b>kthread_suspend</b>(), the <u>timo</u> argument specifies a timeout  to
       wait for the kernel thread to acknowledge the suspend request and suspend itself.

       The  <b>kthread_shutdown</b>()  function  is  meant to be registered as a shutdown event for kernel threads that
       need to be suspended voluntarily during system shutdown so as  not  to  interfere  with  system  shutdown
       activities.  The actual suspension of the kernel thread is done with <b>kthread_suspend</b>().

</pre><h4><b>RETURN</b> <b>VALUES</b></h4><pre>
       The  <b>kthread_add</b>(), <b>kthread_resume</b>(), and <b>kthread_suspend</b>() functions return zero on success and non-zero
       on failure.

</pre><h4><b>EXAMPLES</b></h4><pre>
       This  example  demonstrates  the  use  of  a  <u>struct</u>  <u>kthread_desc</u>  and  the  functions  <b>kthread_start</b>(),
       <b>kthread_shutdown</b>(), and <b>kthread_suspend_check</b>() to run the <b>bufdaemon</b> process.

             static struct thread *bufdaemonthread;

             static struct kthread_desc buf_kp = {
                     "bufdaemon",
                     buf_daemon,
                     &amp;bufdaemonthread
             };
             SYSINIT(bufdaemon, SI_SUB_KTHREAD_BUF, SI_ORDER_FIRST, kthread_start,
                 &amp;buf_kp)

             static void
             buf_daemon()
             {
                     ...
                     /*
                      * This process needs to be suspended prior to shutdown sync.
                      */
                     EVENTHANDLER_REGISTER(shutdown_pre_sync, kthread_shutdown,
                         bufdaemonthread, SHUTDOWN_PRI_LAST);
                     ...
                     for (;;) {
                             kthread_suspend_check();
                             ...
                     }
             }

</pre><h4><b>ERRORS</b></h4><pre>
       The <b>kthread_resume</b>() and <b>kthread_suspend</b>() functions will fail if:

       [EINVAL]           The <u>td</u> argument does not reference a kernel thread.

       The <b>kthread_add</b>() function will fail if:

       [ENOMEM]           Memory for a thread's stack could not be allocated.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man9/kproc.9.html">kproc</a></u>(9), <u><a href="../man9/SYSINIT.9.html">SYSINIT</a></u>(9), <u><a href="../man9/wakeup.9.html">wakeup</a></u>(9)

</pre><h4><b>HISTORY</b></h4><pre>
       The  <b>kthread_start</b>()  function  first  appeared  in FreeBSD 2.2 where it created a whole process.  It was
       converted to create threads in FreeBSD 8.0.  The  <b>kthread_shutdown</b>(),  <b>kthread_exit</b>(),  <b>kthread_resume</b>(),
       <b>kthread_suspend</b>(),  and  <b>kthread_suspend_check</b>()  functions  were  introduced  in  FreeBSD  4.0  and were
       converted to threads in  FreeBSD  8.0.   The  <b>kthread_create</b>()  call  was  renamed  to  <b>kthread_add</b>()  in
       FreeBSD  8.0.   The old functionality of creating a kernel process was renamed to <u><a href="../man9/kproc_create.9.html">kproc_create</a></u>(9).  Prior
       to FreeBSD 5.0, the <b>kthread_shutdown</b>(), <b>kthread_resume</b>(), <b>kthread_suspend</b>(), and  <b>kthread_suspend_check</b>()
       functions  were  named  <b>shutdown_kproc</b>(),  <b>resume_kproc</b>(),  <b>shutdown_kproc</b>(),  and  <b>kproc_suspend_loop</b>(),
       respectively.

Debian                                            July 15, 2014                                       <u><a href="../man9/KTHREAD.9.html">KTHREAD</a></u>(9)
</pre>
 </div>
</div></section>
</div>
</body>
</html>