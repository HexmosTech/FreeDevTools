<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hm2_rpspi - LinuxCNC HAL driver for the Mesa Electronics SPI Anything IO boards, with HostMot2 firmware.</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/linuxcnc-uspace">linuxcnc-uspace_2.9.4-2ubuntu2_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       hm2_rpspi - LinuxCNC HAL driver for the Mesa Electronics SPI Anything IO boards, with HostMot2 firmware.

</pre><h4><b>SYNOPSIS</b></h4><pre>

       <b>loadrt</b> <b>hm2_rpspi</b>

           <b>config</b> [default: ""]
                  HostMot2 config strings, described in the <b><a href="../man9/hostmot2.9.html">hostmot2</a></b>(9) manpage.

           <b>spiclk_rate</b> [default: 31250]
                  Specify the SPI clock rate in kHz. See <b>SPI</b> <b>CLOCK</b> <b>RATES</b> below.

           <b>spiclk_rate_rd</b> [default: -1 (same as <b>spiclk_rate</b>)]
                  Specify the SPI read clock rate in kHz. Usually you read and write at the same speed. However,
                  you  may  want  to reduce the reading speed if the round-trip is too long (see <b>SPI</b> <b>CLOCK</b> <b>RATES</b>
                  below).

           <b>spiclk_base</b> [default: 400000000]
                  This is the SPI clock divider calculation fallback value. Usually, the base rate is read  from
                  <u>/sys/kernel/debug/clk/vpu/clk_rate</u> and used in the divider calculation (for the Rpi3 it should
                  be  250 MHz). The <b>spiclk_base</b> is <u>only</u> used as a fallback if the system's cannot be read. It is
                  normally safe (and recommended) that you leave this parameter as is.
                  You should set this manually to 250000000 if your system does not provide access to the kernel
                  clock settings. Otherwise, your SPI clock frequency will be only 62.5% of the requested value.

           <b>spi_pull_miso</b> [default: 1 (pull-down)]

           <b>spi_pull_mosi</b> [default: 1 (pull-down)]

           <b>spi_pull_sclk</b> [default: 1 (pull-down)]
                  Enable or disable pull-up/pull-down on the SPI lines. A value of 0 disables  any  pull-up/down
                  on  the  pin.  A  value  of 1 means pull-down and 2 means pull-up. The chip enable line(s) are
                  always pull-up enabled.

           <b>spi_probe</b> [default: 1]
                  Probe SPI port and CE lines for a card. This is a bit-field indicating which  combinations  of
                  SPI and CE should be probed:
                   -  1 = SPI0/CE0,
                   -  2 = SPI0/CE1,
                   -  4 = SPI1/CE0,
                   -  8 = SPI1/CE1,
                   - 16 = SPI1/CE2.

                  The  probe is performed exactly in above order. Any boards found will be numbered 0...4 in the
                  order found. See also <b>INTERFACE</b> <b>CONFIGURATION</b> below.

                  It is an error if a probe fails and the driver will  abort.   The  SPI0/SPI1  peripherals  are
                  located at GPIO pins (with 40-pin I/O header pin-number in parentheses):
                   - SPI0: MOSI=<a href="../man19/10.19.html">10</a>(19), MISO=<a href="../man21/9.21.html">9</a>(21), SCLK=<a href="../man23/11.23.html">11</a>(23), CE0=<a href="../man24/8.24.html">8</a>(24), CE1=<a href="../man26/7.26.html">7</a>(26)
                   - SPI1: MOSI=<a href="../man38/20.38.html">20</a>(38), MISO=<a href="../man35/19.35.html">19</a>(35), SCLK=<a href="../man40/21.40.html">21</a>(40), CE0=<a href="../man12/18.12.html">18</a>(12), CE1=<a href="../man11/17.11.html">17</a>(11), CE2=<a href="../man36/16.36.html">16</a>(36)

           <b>spi_debug</b> [default: -1]
                  Set  the message level of the running process. The message level is set if <b>spi_debug</b> is set to
                  a positive value between 0 and 5, where 0 means no messages at all and 5 means  everything.  A
                  value of -1 does not touch the current message level.

                  Caveat  Emptor:  changing the message level is process-wide and all modules within the process
                  will spit out messages at the requested level. This may  cause  quite  some  clutter  in  your
                  terminal.

</pre><h4><b>DESCRIPTION</b></h4><pre>
       hm2_rpspi  is  a  device  driver  for  the Raspberry Pi 2/3 that interfaces Mesa's SPI based Anything I/O
       boards (with the HostMot2 firmware) to the LinuxCNC HAL.  This driver is not based on  the  linux  spidev
       driver, but on a dedicated BCM2835-SPI driver.

       It  is  <b>strongly</b>  recommended  that  you  unload/disable the kernel's spidev driver by disabling it using
       <b>raspi-config</b>.  Please note that having both kernel and user-space SPI drivers  installed  can  result  in
       unexpected interactions and system instabilities.

       The supported boards are: 7I90HD.

       The  board  must  have  a  compatible  firmware  (ie.:  7i90_spi_svst4_8.bit)  loaded on the board by the
       <b><a href="../man1/mesaflash.1.html">mesaflash</a></b>(1) program.

       hm2_rpspi is only available when LinuxCNC is configured with "uspace" realtime.  It  works  with  Raspian
       and PREEMPT_RT kernel.

</pre><h4><b>INTERFACE</b> <b>CONFIGURATION</b></h4><pre>
       Up  to  five  devices (7i90 boards) are supported. Two on SPI0 and three on SPI1.  It is recommended that
       you, at most, use two devices and each device connected to a separate SPI port. You can choose  which  CE
       lines  you  prefer  or  fit  the design and setup the <b>spi_probe</b> parameter to instruct the driver where to
       search for the board(s).

</pre><h4><b>REALTIME</b> <b>PERFORMANCE</b> <b>OF</b> <b>THE</b> <b>BCM2835-SPI</b> <b>DRIVER</b></h4><pre>
       TBD.

</pre><h4><b>SPI</b> <b>CLOCK</b> <b>RATES</b></h4><pre>
       The maximum SPI clock of the BCM2835-SPI driver and the 7i90 is documented over 32MHz. The SPI driver can
       provide frequencies well beyond what is acceptable for the 7i90. A safe value  to  start  with  would  be
       12.5 MHz (spiclk_rate=12500) and then work your way up from there.

       The SPI driver generates (very) discrete clock frequency values, especially in the MHz range because of a
       simple  clock divider structure. The base frequency is 250 MHz and the divider for SPI0/SPI1 scales using
       discrete factors. The following list specifies  the  <b>spiclk_rate</b>  setting  and  the  discrete  SPI  clock
       frequency (250 MHz / (2n) for n &gt; 1):
        - 62500 - 62.500 MHz,
        - 41667 - 41.667 MHz,
        - 31250 - 31.250 MHz,
        - 25000 - 25.000 MHz,
        - 20834 - 20.833 MHz,
        - 17858 - 17.857 MHz,
        - 15625 - 15.625 MHz,
        - 13889 - 13.889 MHz,
        - 12500 - 12.500 MHz,
        - 11364 - 11.364 MHz,
        - 10417 - 10.417 MHz,
        -  9616 -  9.615 MHz,
        - ....

       The  lowest  selectable  SPI clock frequency is 30 kHz (spiclk_rate=30) for SPI0 and SPI1. Theoretically,
       the SPI0 port could go slower, but there is no point in doing so. You should  not  expect  any  real-time
       performance with such slow setting, unless your machine is located next to a black hole.

       The  highest  SPI  clock frequency is, theoretically, 125 MHz. However, you will not be able to build any
       reliable  hardware  interface  at  that  frequency.   The   driver   limits   the   clock   to   62.5 MHz
       (cpiclk_rate=62500).  The  chances  are  rather  slim that you get the interface to work reliably at this
       frequency. The 7i90 interface only supports frequencies up to 50 MHz and that is with perfect cabling and
       impedance matching (in write direction only).

       Writing to the 7i90 may be done faster than reading. This is especially  important  if  you  have  "long"
       wires  or  any  buffers on the SPI-bus path. You can set the read clock frequency to a lower value (using
       <b>spiclk_rate_rd</b>) to counter the effects of the SPI-bus round-trip needed for read  actions.  For  example,
       you can write at 41.67 MHz and read at 25.00 MHz.

       It  should  be noted that the Rpi3 <b>must</b> have an adequate 5V power supply and the power should be properly
       decoupled right on the 40-pin I/O header.  At  high  speeds  and  noise  on  the  supply,  there  is  the
       possibility of noise throwing off the SoC's PLL(s), resulting in strange behaviour.

       For  optimal performance on the Rpi3, you must disable the "ondemand" CPU frequency governor. You may add
       the following to your /etc/rc.local file:
        echo -n 1200000 &gt; /sys/devices/system/cpu/cpufreq/policy0/scaling_min_freq
        echo -n performance &gt; /sys/devices/system/cpu/cpufreq/policy0/scaling_governor

       Be sure to have a proper heatsink mounted on the SoC or it will get too warm and crash.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man9/hostmot2.9.html">hostmot2</a></b>(9)

</pre><h4><b>LICENSE</b></h4><pre>
       GPL

LinuxCNC Documentation                             2017-06-05                                       <u><a href="../man9/HM2_RPSPI.9.html">HM2_RPSPI</a></u>(9)
</pre>
 </div>
</div></section>
</div>
</body>
</html>