<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pfil,   pfil_head_register,   pfil_head_unregister,  pfil_head_get,  pfil_add_hook,  pfil_add_hook_flags,</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/freebsd-manpages">freebsd-manpages_12.2-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       pfil,   pfil_head_register,   pfil_head_unregister,  pfil_head_get,  pfil_add_hook,  pfil_add_hook_flags,
       pfil_remove_hook,   pfil_remove_hook_flags,   pfil_run_hooks,   pfil_rlock,   pfil_runlock,   pfil_wlock,
       pfil_wunlock — packet filter interface

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;sys/param.h&gt;</b>
       <b>#include</b> <b>&lt;sys/mbuf.h&gt;</b>
       <b>#include</b> <b>&lt;<a href="file:/usr/include/net/if.h">net/if.h</a>&gt;</b>
       <b>#include</b> <b>&lt;net/pfil.h&gt;</b>

       typedef int (*pfil_func_t)(void *arg, struct mbuf **mp, struct ifnet *, int dir, struct inpcb);

       typedef int (*pfil_func_flags_t)(void *arg, struct mbuf **mp, struct ifnet *, int dir, int flags, struct inpcb);

       <u>int</u>
       <b>pfil_head_register</b>(<u>struct</u> <u>pfil_head</u> <u>*head</u>);

       <u>int</u>
       <b>pfil_head_unregister</b>(<u>struct</u> <u>pfil_head</u> <u>*head</u>);

       <u>struct</u> <u>pfil_head</u> <u>*</u>
       <b>pfil_head_get</b>(<u>int</u> <u>af</u>, <u>u_long</u> <u>dlt</u>);

       <u>int</u>
       <b>pfil_add_hook</b>(<u>pfil_func_t</u>, <u>void</u> <u>*arg</u>, <u>struct</u> <u>pfil_head</u> <u>*</u>);

       <u>int</u>
       <b>pfil_add_hook_flags</b>(<u>pfil_func_flags_t</u>, <u>void</u> <u>*arg</u>, <u>int</u> <u>flags</u>, <u>struct</u> <u>pfil_head</u> <u>*</u>);

       <u>int</u>
       <b>pfil_remove_hook</b>(<u>pfil_func_t</u>, <u>void</u> <u>*arg</u>, <u>struct</u> <u>pfil_head</u> <u>*</u>);

       <u>int</u>
       <b>pfil_remove_hook_flags</b>(<u>pfil_func_flags_t</u>, <u>void</u> <u>*arg</u>, <u>int</u> <u>flags</u>, <u>struct</u> <u>pfil_head</u> <u>*</u>);

       <u>int</u>
       <b>pfil_run_hooks</b>(<u>struct</u> <u>pfil_head</u> <u>*head</u>, <u>struct</u> <u>mbuf</u> <u>**mp</u>, <u>struct</u> <u>ifnet</u> <u>*</u>, <u>int</u> <u>dir</u>, <u>int</u> <u>flags</u>, <u>struct</u> <u>inpcb</u> <u>*</u>);

       <u>void</u>
       <b>pfil_rlock</b>(<u>struct</u> <u>pfil_head</u> <u>*</u>, <u>struct</u> <u>rm_priotracker</u> <u>*</u>);

       <u>void</u>
       <b>pfil_runlock</b>(<u>struct</u> <u>pfil_head</u> <u>*</u>, <u>struct</u> <u>rm_priotracker</u> <u>*</u>);

       <u>void</u>
       <b>pfil_wlock</b>(<u>struct</u> <u>pfil_head</u> <u>*</u>);

       <u>void</u>
       <b>pfil_wunlock</b>(<u>struct</u> <u>pfil_head</u> <u>*</u>);

</pre><h4><b>DESCRIPTION</b></h4><pre>
       The  <b>pfil</b>  framework  allows for a specified function to be invoked for every incoming or outgoing packet
       for a particular network I/O stream.  These hooks may be used to implement a firewall or  perform  packet
       transformations.

       Packet  filtering  points are registered with <b>pfil_head_register</b>().  Filtering points are identified by a
       key (<u>void</u> <u>*</u>) and a data link type (<u>int</u>) in the <u>pfil_head</u> structure.  Packet filters use the key and  data
       link  type  to look up the filtering point with which they register themselves.  The key is unique to the
       filtering point.  The data link type is a <u><a href="../man4/bpf.4.html">bpf</a></u>(4) DLT constant indicating what kind of header  is  present
       on the packet at the filtering point.  Each filtering point uses common per-VNET rmlock by default.  This
       can be changed by specifying <u>PFIL_FLAG_PRIVATE_LOCK</u> as <u>flags</u> field in the <u>pfil_head</u> structure.  Note that
       specifying  private  lock  can break filters sharing the same ruleset and/or state between different data
       link types.  Filtering points may be unregistered with the <b>pfil_head_unregister</b>() function.

       Packet filters register/unregister themselves  with  a  filtering  point  with  the  <b>pfil_add_hook</b>()  and
       <b>pfil_remove_hook</b>()  functions,  respectively.   The head is looked up using the <b>pfil_head_get</b>() function,
       which takes the key and data link type that the packet filter expects.  Filters may provide  an  argument
       to be passed to the filter when invoked on a packet.

       When  a  filter  is invoked, the packet appears just as if it “came off the wire”.  That is, all protocol
       fields are in network byte order.  The filter is called with its specified argument, the pointer  to  the
       pointer  to  the  <u>mbuf</u>  containing  the  packet,  the pointer to the network interface that the packet is
       traversing, and the direction (PFIL_IN or PFIL_OUT) that the packet is  traveling.   The  <u>flags</u>  argument
       will  indicate  if  an outgoing packet is simply being forwarded with the value PFIL_FWD.  The filter may
       change which mbuf the <u>mbuf</u> <u>**</u> argument references.  The filter returns an error  (errno)  if  the  packet
       processing is to stop, or 0 if the processing is to continue.  If the packet processing is to stop, it is
       the responsibility of the filter to free the packet.

       Every  filter hook is called with <b>pfil</b> read lock held.  All heads uses the same lock within the same VNET
       instance.  Packet filter can use this lock instead of own locking model to  improve  performance.   Since
       <b>pfil</b>  uses  <u><a href="../man9/rmlock.9.html">rmlock</a></u>(9)  <b>pfil_rlock</b>()  and  <b>pfil_runlock</b>()  require  <u>struct</u>  <u>rm_priotracker</u> to be passed as
       argument.  Filter can acquire and release writer lock via <b>pfil_wlock</b>() and <b>pfil_wunlock</b>() functions.  See
       <u><a href="../man9/rmlock.9.html">rmlock</a></u>(9) for more details.

</pre><h4><b>FILTERING</b> <b>POINTS</b></h4><pre>
       Currently, filtering points are implemented for the following link types:

          AF_INET   IPv4 packets.
          AF_INET6  IPv6 packets.
          AF_LINK   Link-layer packets.

</pre><h4><b>RETURN</b> <b>VALUES</b></h4><pre>
       If  successful,  <b>pfil_head_get</b>()  returns  the  <u>pfil_head</u>  structure  for   the   given   key/dlt.    The
       <b>pfil_add_hook</b>()   and  <b>pfil_remove_hook</b>()  functions  return  0  if  successful.   If  called  with  flag
       PFIL_WAITOK, <b>pfil_remove_hook</b>() is expected to always succeed.

       The <b>pfil_head_unregister</b>() function might sleep!

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man4/bpf.4.html">bpf</a></u>(4), <u><a href="../man4/if_bridge.4.html">if_bridge</a></u>(4), <u><a href="../man9/rmlock.9.html">rmlock</a></u>(9)

</pre><h4><b>HISTORY</b></h4><pre>
       The <b>pfil</b> interface first appeared in NetBSD 1.3.   The  <b>pfil</b>  input  and  output  lists  were  originally
       implemented as &lt;<u>sys/queue.h</u>&gt; LIST structures; however this was changed in NetBSD 1.4 to TAILQ structures.
       This change was to allow the input and output filters to be processed in reverse order, to allow the same
       path to be taken, in or out of the kernel.

       The  <b>pfil</b>  interface  was  changed  in  1.4T  to  accept  a  3rd  parameter  to  both <b>pfil_add_hook</b>() and
       <b>pfil_remove_hook</b>(), introducing the capability of per-protocol filtering.  This  was  done  primarily  in
       order to support filtering of IPv6.

       In  1.5K, the <b>pfil</b> framework was changed to work with an arbitrary number of filtering points, as well as
       be less IP-centric.

       Fine-grained locking was added in FreeBSD 5.2.  <b>pfil</b> lock export was added in FreeBSD 10.0.

</pre><h4><b>BUGS</b></h4><pre>
       When a <u>pfil_head</u> is being modified, no traffic is diverted (to avoid deadlock).  This means that  traffic
       may  be  dropped  unconditionally  for  a  short period of time.  <b>pfil_run_hooks</b>() will return ENOBUFS to
       indicate this.

Debian                                           March 10, 2018                                          <u><a href="../man9/PFIL.9.html">PFIL</a></u>(9)
</pre>
 </div>
</div></section>
</div>
</body>
</html>