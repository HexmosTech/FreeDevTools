<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIDEDUPERANGE - share some the data of one file with another file</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/manpages-dev">manpages-dev_6.9.1-1_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       FIDEDUPERANGE - share some the data of one file with another file

</pre><h4><b>LIBRARY</b></h4><pre>
       Standard C library (<u>libc</u>, <u>-lc</u>)

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;<a href="file:/usr/include/linux/fs.h">linux/fs.h</a>&gt;</b>      /* Definition of <b>FIDEDUPERANGE</b> and
                                     <b>FILE_DEDUPE_*</b> constants<b>*/</b>
       <b>#include</b> <b>&lt;sys/ioctl.h&gt;</b>

       <b>int</b> <b>ioctl(int</b> <u>src_fd</u><b>,</b> <b>FIDEDUPERANGE,</b> <b>struct</b> <b>file_dedupe_range</b> <b>*</b><u>arg</u><b>);</b>

</pre><h4><b>DESCRIPTION</b></h4><pre>
       If  a  filesystem supports files sharing physical storage between multiple files, this <b><a href="../man2/ioctl.2.html">ioctl</a></b>(2) operation
       can be used to make some of the data in the <b>src_fd</b> file  appear  in  the  <b>dest_fd</b>  file  by  sharing  the
       underlying  storage  if  the file data is identical ("deduplication").  Both files must reside within the
       same filesystem.  This reduces storage consumption by allowing the filesystem to store one shared copy of
       the data.  If a file write should occur to a shared region, the filesystem must ensure that  the  changes
       remain private to the file being written.  This behavior is commonly referred to as "copy on write".

       This  ioctl  performs  the "compare and share if identical" operation on up to <u>src_length</u> bytes from file
       descriptor <u>src_fd</u> at offset <u>src_offset</u>.  This information is conveyed in a  structure  of  the  following
       form:

           struct file_dedupe_range {
               __u64 src_offset;
               __u64 src_length;
               __u16 dest_count;
               __u16 reserved1;
               __u32 reserved2;
               struct file_dedupe_range_info info[0];
           };

       Deduplication  is  atomic  with  regards  to  concurrent writes, so no locks need to be taken to obtain a
       consistent deduplicated copy.

       The fields <u>reserved1</u> and <u>reserved2</u> must be zero.

       Destinations for the deduplication operation are conveyed in the array at the end of the structure.   The
       number  of  destinations  is  given  in  <u>dest_count</u>,  and  the destination information is conveyed in the
       following form:

           struct file_dedupe_range_info {
               __s64 dest_fd;
               __u64 dest_offset;
               __u64 bytes_deduped;
               __s32 status;
               __u32 reserved;
           };

       Each deduplication operation targets <u>src_length</u> bytes in file descriptor <u>dest_fd</u> at  offset  <u>dest_offset</u>.
       The  field  <u>reserved</u>  must be zero.  During the call, <u>src_fd</u> must be open for reading and <u>dest_fd</u> must be
       open  for  writing.    The   combined   size   of   the   struct   <u>file_dedupe_range</u>   and   the   struct
       <u>file_dedupe_range_info</u>  array  must  not  exceed the system page size.  The maximum size of <u>src_length</u> is
       filesystem dependent and is typically 16 MiB.  This limit will be enforced silently  by  the  filesystem.
       By convention, the storage used by <u>src_fd</u> is mapped into <u>dest_fd</u> and the previous contents in <u>dest_fd</u> are
       freed.

       Upon  successful  completion  of this ioctl, the number of bytes successfully deduplicated is returned in
       <u>bytes_deduped</u> and a status code for the deduplication operation is returned in <u>status</u>.  If even a  single
       byte  in  the range does not match, the deduplication operation request will be ignored and <u>status</u> set to
       <b>FILE_DEDUPE_RANGE_DIFFERS</b>.  The <u>status</u> code is set to  <b>FILE_DEDUPE_RANGE_SAME</b>  for  success,  a  negative
       error code in case of error, or <b>FILE_DEDUPE_RANGE_DIFFERS</b> if the data did not match.

</pre><h4><b>RETURN</b> <b>VALUE</b></h4><pre>
       On error, -1 is returned, and <u>errno</u> is set to indicate the error.

</pre><h4><b>ERRORS</b></h4><pre>
       Possible errors include (but are not limited to) the following:

       <b>EBADF</b>  <u>src_fd</u> is not open for reading; <u>dest_fd</u> is not open for writing or is open for append-only writes;
              or the filesystem which <u>src_fd</u> resides on does not support deduplication.

       <b>EINVAL</b> The  filesystem does not support deduplicating the ranges of the given files.  This error can also
              appear if either file descriptor represents a device, FIFO, or socket.  Disk filesystems generally
              require the offset and length arguments to be aligned to  the  fundamental  block  size.   Neither
              Btrfs nor XFS support overlapping deduplication ranges in the same file.

       <b>EISDIR</b> One of the files is a directory and the filesystem does not support shared regions in directories.

       <b>ENOMEM</b> The  kernel  was unable to allocate sufficient memory to perform the operation or <u>dest_count</u> is so
              large that the input argument description spans more than a single page of memory.

       <b>EOPNOTSUPP</b>
              This can appear if the filesystem does not support deduplicating either  file  descriptor,  or  if
              either file descriptor refers to special inodes.

       <b>EPERM</b>  <u>dest_fd</u> is immutable.

       <b>ETXTBSY</b>
              One of the files is a swap file.  Swap files cannot share storage.

       <b>EXDEV</b>  <u>dest_fd</u> and <u>src_fd</u> are not on the same mounted filesystem.

</pre><h4><b>VERSIONS</b></h4><pre>
       Some filesystems may limit the amount of data that can be deduplicated in a single call.

</pre><h4><b>STANDARDS</b></h4><pre>
       Linux.

</pre><h4><b>HISTORY</b></h4><pre>
       Linux 4.5.

       It was previously known as <b>BTRFS_IOC_FILE_EXTENT_SAME</b> and was private to Btrfs.

</pre><h4><b>NOTES</b></h4><pre>
       Because  a copy-on-write operation requires the allocation of new storage, the <b><a href="../man2/fallocate.2.html">fallocate</a></b>(2) operation may
       unshare shared blocks to guarantee that subsequent writes will not fail because of lack of disk space.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man2/ioctl.2.html">ioctl</a></b>(2)

Linux man-pages 6.9.1                              2024-06-13                              <u><a href="../man2const/FIDEDUPERANGE.2const.html">FIDEDUPERANGE</a></u>(2const)
</pre>
 </div>
</div></section>
</div>
</body>
</html>