<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NS_GET_USERNS, NS_GET_PARENT - discovering namespace relationships</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/manpages-dev">manpages-dev_6.9.1-1_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       NS_GET_USERNS, NS_GET_PARENT - discovering namespace relationships

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;<a href="file:/usr/include/linux/nsfs.h">linux/nsfs.h</a>&gt;</b>  /* Definition of <b>NS_GET_*</b> constants */
       <b>#include</b> <b>&lt;sys/ioctl.h&gt;</b>

       <b>int</b> <b>ioctl(int</b> <u>fd</u><b>,</b> <b>unsigned</b> <b>long</b> <u>op</u><b>);</b>

</pre><h4><b>DESCRIPTION</b></h4><pre>
       The  following  <b><a href="../man2/ioctl.2.html">ioctl</a></b>(2)  operations  are  provided  to  allow  discovery of namespace relationships (see
       <b><a href="../man7/user_namespaces.7.html">user_namespaces</a></b>(7) and <b><a href="../man7/pid_namespaces.7.html">pid_namespaces</a></b>(7)).

       In each case, <u>fd</u> refers to a <u><a href="file:/proc/">/proc/</a></u>pid<u>/ns/*</u> file.  Both  operations  return  a  new  file  descriptor  on
       success.

       <b>NS_GET_USERNS</b>
              Returns  a  file descriptor that refers to the owning user namespace for the namespace referred to
              by <u>fd</u>.

       <b>NS_GET_PARENT</b>
              Returns a file descriptor that refers to the parent namespace of the namespace referred to by  <u>fd</u>.
              This  operation  is  valid  only for hierarchical namespaces (i.e., PID and user namespaces).  For
              user namespaces, <b>NS_GET_PARENT</b> is synonymous with <b>NS_GET_USERNS</b>.

       The new file descriptor returned by these operations is opened with the <b>O_RDONLY</b> and <b>O_CLOEXEC</b> (close-on-
       exec; see <b><a href="../man2/fcntl.2.html">fcntl</a></b>(2)) flags.

       By applying <b><a href="../man2/fstat.2.html">fstat</a></b>(2) to the returned file descriptor, one obtains a <u>stat</u> structure whose <u>st_dev</u> (resident
       device) and <u>st_ino</u> (inode number) fields together  identify  the  owning/parent  namespace.   This  inode
       number  can be matched with the inode number of another <u><a href="file:/proc/">/proc/</a></u>pid<u>/ns/</u>{<u>pid</u>,<u>user</u>} file to determine whether
       that is the owning/parent namespace.

</pre><h4><b>RETURN</b> <b>VALUE</b></h4><pre>
       On success, a file descriptor is returned.  Or error, -1 is returned, and <u>errno</u> is set  to  indicate  the
       error.

</pre><h4><b>ERRORS</b></h4><pre>
       <b>EPERM</b>  The  requested namespace is outside of the caller's namespace scope.  This error can occur if, for
              example, the owning user namespace is an ancestor of the caller's current user namespace.  It  can
              also occur on attempts to obtain the parent of the initial user or PID namespace.

       <b>ENOTTY</b> The operation is not supported by this kernel version.

       Additionally, the <b>NS_GET_PARENT</b> operation can fail with the following error:

       <b>EINVAL</b> <u>fd</u> refers to a nonhierarchical namespace.

</pre><h4><b>STANDARDS</b></h4><pre>
       Linux.

</pre><h4><b>HISTORY</b></h4><pre>
       <b>NS_GET_USERNS</b>
              Linux 4.9.

       <b>NS_GET_PARENT</b>
              Linux 4.9.

</pre><h4><b>EXAMPLES</b></h4><pre>
       The  example  shown  below  uses  the  <b><a href="../man2/ioctl.2.html">ioctl</a></b>(2) operations described above to perform simple discovery of
       namespace relationships.  The following shell sessions show various examples of the use of this program.

       Trying to get the parent of the initial user namespace fails, since it has no parent:

           $ <b>./ns_show</b> <b><a href="file:/proc/self/ns/user">/proc/self/ns/user</a></b> <b>p</b>
           The parent namespace is outside your namespace scope

       Create a process running <b><a href="../man1/sleep.1.html">sleep</a></b>(1) that resides in new user and UTS namespaces, and show that the new  UTS
       namespace is associated with the new user namespace:

           $ <b>unshare</b> <b>-Uu</b> <b>sleep</b> <b>1000</b> <b>&amp;</b>
           [1] 23235
           $ <b>./ns_show</b> <b>/proc/23235/ns/uts</b> <b>u</b>
           Device/Inode of owning user namespace is: [0,3] / 4026532448
           $ <b>readlink</b> <b>/proc/23235/ns/user</b>
           user:[4026532448]

       Then  show  that  the  parent  of  the  new  user  namespace in the preceding example is the initial user
       namespace:

           $ <b>readlink</b> <b><a href="file:/proc/self/ns/user">/proc/self/ns/user</a></b>
           user:[4026531837]
           $ <b>./ns_show</b> <b>/proc/23235/ns/user</b> <b>p</b>
           Device/Inode of parent namespace is: [0,3] / 4026531837

       Start a shell in a new user namespace, and show that from within this shell, the  parent  user  namespace
       can't  be discovered.  Similarly, the UTS namespace (which is associated with the initial user namespace)
       can't be discovered.

           $ <b>PS1="sh2$</b> <b>"</b> <b>unshare</b> <b>-U</b> <b>bash</b>
           sh2$ <b>./ns_show</b> <b><a href="file:/proc/self/ns/user">/proc/self/ns/user</a></b> <b>p</b>
           The parent namespace is outside your namespace scope
           sh2$ <b>./ns_show</b> <b><a href="file:/proc/self/ns/uts">/proc/self/ns/uts</a></b> <b>u</b>
           The owning user namespace is outside your namespace scope

   <b>Program</b> <b>source</b>

       /* ns_show.c

          Licensed under the GNU General Public License v2 or later.
       */
       #include &lt;<a href="file:/usr/include/errno.h">errno.h</a>&gt;
       #include &lt;<a href="file:/usr/include/fcntl.h">fcntl.h</a>&gt;
       #include &lt;<a href="file:/usr/include/linux/nsfs.h">linux/nsfs.h</a>&gt;
       #include &lt;<a href="file:/usr/include/stdint.h">stdint.h</a>&gt;
       #include &lt;<a href="file:/usr/include/stdio.h">stdio.h</a>&gt;
       #include &lt;<a href="file:/usr/include/stdlib.h">stdlib.h</a>&gt;
       #include &lt;<a href="file:/usr/include/string.h">string.h</a>&gt;
       #include &lt;sys/ioctl.h&gt;
       #include &lt;sys/stat.h&gt;
       #include &lt;sys/sysmacros.h&gt;
       #include &lt;<a href="file:/usr/include/unistd.h">unistd.h</a>&gt;

       int
       main(int argc, char *argv[])
       {
           int          fd, userns_fd, parent_fd;
           struct stat  sb;

           if (argc &lt; 2) {
               fprintf(stderr, "Usage: %s <a href="file:/proc/">/proc/</a>[pid]/ns/[file] [p|u]\n",
                       argv[0]);
               fprintf(stderr, "\nDisplay the result of one or both "
                       "of NS_GET_USERNS (u) or NS_GET_PARENT (p)\n"
                       "for the specified <a href="file:/proc/">/proc/</a>[pid]/ns/[file]. If neither "
                       "'p' nor 'u' is specified,\n"
                       "NS_GET_USERNS is the default.\n");
               exit(EXIT_FAILURE);
           }

           /* Obtain a file descriptor for the 'ns' file specified
              in argv[1]. */

           fd = open(argv[1], O_RDONLY);
           if (fd == -1) {
               perror("open");
               exit(EXIT_FAILURE);
           }

           /* Obtain a file descriptor for the owning user namespace and
              then obtain and display the inode number of that namespace. */

           if (argc &lt; 3 || strchr(argv[2], 'u')) {
               userns_fd = ioctl(fd, NS_GET_USERNS);

               if (userns_fd == -1) {
                   if (errno == EPERM)
                       printf("The owning user namespace is outside "
                              "your namespace scope\n");
                   else
                      perror("ioctl-NS_GET_USERNS");
                   exit(EXIT_FAILURE);
                }

               if (fstat(userns_fd, &amp;sb) == -1) {
                   perror("fstat-userns");
                   exit(EXIT_FAILURE);
               }
               printf("Device/Inode of owning user namespace is: "
                      "[%x,%x] / %ju\n",
                      major(sb.st_dev),
                      minor(sb.st_dev),
                      (uintmax_t) sb.st_ino);

               close(userns_fd);
           }

           /* Obtain a file descriptor for the parent namespace and
              then obtain and display the inode number of that namespace. */

           if (argc &gt; 2 &amp;&amp; strchr(argv[2], 'p')) {
               parent_fd = ioctl(fd, NS_GET_PARENT);

               if (parent_fd == -1) {
                   if (errno == EINVAL)
                       printf("Can' get parent namespace of a "
                              "nonhierarchical namespace\n");
                   else if (errno == EPERM)
                       printf("The parent namespace is outside "
                              "your namespace scope\n");
                   else
                       perror("ioctl-NS_GET_PARENT");
                   exit(EXIT_FAILURE);
               }

               if (fstat(parent_fd, &amp;sb) == -1) {
                   perror("fstat-parentns");
                   exit(EXIT_FAILURE);
               }
               printf("Device/Inode of parent namespace is: [%x,%x] / %ju\n",
                      major(sb.st_dev),
                      minor(sb.st_dev),
                      (uintmax_t) sb.st_ino);

               close(parent_fd);
           }

           exit(EXIT_SUCCESS);
       }

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man2/ioctl.2.html">ioctl</a></b>(2), <b><a href="../man2/ioctl_nsfs.2.html">ioctl_nsfs</a></b>(2)

Linux man-pages 6.9.1                              2024-06-15                              <u><a href="../man2const/NS_GET_USERNS.2const.html">NS_GET_USERNS</a></u>(2const)
</pre>
 </div>
</div></section>
</div>
</body>
</html>