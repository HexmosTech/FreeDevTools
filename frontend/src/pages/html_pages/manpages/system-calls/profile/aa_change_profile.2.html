<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aa_change_profile, aa_change_onexec - change a tasks profile</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/libapparmor-dev">libapparmor-dev_4.1.1-0ubuntu6_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       aa_change_profile, aa_change_onexec - change a tasks profile

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;sys/apparmor.h&gt;</b>

       <b>int</b> <b>aa_change_profile(const</b> <b>char</b> <b>*profile);</b>

       <b>int</b> <b>aa_change_onexec(const</b> <b>char</b> <b>*profile);</b>

       Link with <b>-lapparmor</b> when compiling.

</pre><h4><b>DESCRIPTION</b></h4><pre>
       An AppArmor profile applies to an executable program; if a portion of the program needs different access
       permissions than other portions, the program can "change profile" to a different profile. To change into
       a new profile, it can use the <b>aa_change_profile()</b> function to do so. It passes in a pointer to the
       <u>profile</u> to transition to. Confined programs wanting to use <b>aa_change_profile()</b> need to have rules
       permitting changing to the named profile. See <b><a href="../man8/apparmor.d.8.html">apparmor.d</a></b>(8) for details.

       If a program wants to return out of the current profile to the original profile, it may use
       <b><a href="../man2/aa_change_hat.2.html">aa_change_hat</a></b>(2). Otherwise, the two profiles must have rules permitting changing between the two
       profiles.

       Open file descriptors may not be remediated after a call to <b>aa_change_profile()</b> so the calling program
       must <b><a href="../man2/close.2.html">close</a></b>(2) open file descriptors to ensure they are not available after calling <b>aa_change_profile()</b>.
       As <b>aa_change_profile()</b> is typically used just before <b><a href="../man2/execve.2.html">execve</a></b>(2), you may want to use <b><a href="../man2/open.2.html">open</a></b>(2) or <b><a href="../man2/fcntl.2.html">fcntl</a></b>(2)
       with close-on-exec.

       The <b>aa_change_onexec()</b> function is like the <b>aa_change_profile()</b> function except it specifies that the
       profile transition should take place on the next exec instead of immediately.  The delayed profile change
       takes precedence over any exec transition rules within the confining profile.  Delaying the profile
       boundary has a couple of advantages, it removes the need for stub transition profiles and the exec
       boundary is a natural security layer where potentially sensitive memory is unmapped.

</pre><h4><b>RETURN</b> <b>VALUE</b></h4><pre>
       On success zero is returned. On error, -1 is returned, and <b><a href="../man3/errno.3.html">errno</a></b>(3) is set appropriately.

</pre><h4><b>ERRORS</b></h4><pre>
       <b>EINVAL</b>
           The  apparmor  kernel  module  is not loaded, neither a profile nor a namespace was specified, or the
           communication via the <u><a href="file:/proc/">/proc/</a>*/attr/current</u> file did not conform to protocol.

       <b>ENOMEM</b>
           Insufficient kernel memory was available.

       <b>EPERM</b>
           The calling application is confined by apparmor and the no_new_privs bit is set.

       <b>EACCES</b>
           The task does not have sufficient permissions to change its domain.

       <b>ENOENT</b>
           The specified profile does not exist, or is not visible from the current Namespace.

</pre><h4><b>EXAMPLE</b></h4><pre>
       The following example shows a simple,  if  contrived,  use  of  <b>aa_change_profile()</b>;  a  typical  use  of
       <b>aa_change_profile()</b>  will  <b>aa_change_profile()</b>  just before an <b><a href="../man2/execve.2.html">execve</a></b>(2) so that the new child process is
       permanently confined.

        #include &lt;<a href="file:/usr/include/stdlib.h">stdlib.h</a>&gt;
        #include &lt;<a href="file:/usr/include/string.h">string.h</a>&gt;
        #include &lt;sys/apparmor.h&gt;
        #include &lt;sys/types.h&gt;
        #include &lt;sys/stat.h&gt;
        #include &lt;<a href="file:/usr/include/fcntl.h">fcntl.h</a>&gt;
        #include &lt;<a href="file:/usr/include/stdio.h">stdio.h</a>&gt;
        #include &lt;<a href="file:/usr/include/unistd.h">unistd.h</a>&gt;

        int main(int argc, char * argv[])
        {
                int fd;
                char buf[10];
                char *execve_args[4];

                printf("Before aa_change_profile():\n");
                if ((fd=open("<a href="file:/etc/passwd">/etc/passwd</a>", O_RDONLY)) &lt; 0) {
                       perror("Failure opening <a href="file:/etc/passwd">/etc/passwd</a>");
                       return 1;
                }

                /* Confirm for ourselves that we can really read <a href="file:/etc/passwd">/etc/passwd</a> */
                memset(&amp;buf, 0, 10);
                if (read(fd, &amp;buf, 10) == -1) {
                        perror("Failure reading <a href="file:/etc/passwd">/etc/passwd</a>");
                        return 1;
                }
                buf[9] = '\0';
                printf("<a href="file:/etc/passwd">/etc/passwd</a>: %s\n", buf);
                close(fd);

                printf("After aa_change_profile():\n");

                /* change profile to the "i_cant_be_trusted_anymore" profile, which
                 * should not have read access to /etc/passwd. */
                if (aa_change_profile("i_cant_be_trusted_anymore") &lt; 0) {
                    perror("Failure changing profile -- aborting");
                    <a href="../man1/_exit.1.html">_exit</a>(1);
                }

                /* confirm that we cannot read <a href="file:/etc/passwd">/etc/passwd</a> */
                execve_args[0] = "<a href="file:///usr/lib/w3m/cgi-bin/w3mman2html.cgi?head">/usr/bin/head</a>";
                execve_args[1] = "-1";
                execve_args[2] = "<a href="file:/etc/passwd">/etc/passwd</a>";
                execve_args[3] = NULL;
                execve("<a href="file:///usr/lib/w3m/cgi-bin/w3mman2html.cgi?head">/usr/bin/head</a>", execve_args, NULL);
                perror("execve");
                <a href="../man1/_exit.1.html">_exit</a>(1);
        }

       This code example requires a profile similar to the following to be loaded with <b><a href="../man8/apparmor_parser.8.html">apparmor_parser</a></b>(8):

        profile i_cant_be_trusted_anymore {
            <a href="file:/etc/ld.so.cache">/etc/ld.so.cache</a>      mr,
            /lib/ld-*.so*         mrix,
            /lib/libc*.so*        mr,

            <a href="file:///usr/lib/w3m/cgi-bin/w3mman2html.cgi?head">/usr/bin/head</a> ix,
        }

       The output when run:

        $ /tmp/change_p
        Before aa_change_profile():
        <a href="file:/etc/passwd">/etc/passwd</a>: root:x:0:
        After aa_change_profile():
        <a href="file:///usr/lib/w3m/cgi-bin/w3mman2html.cgi?head">/usr/bin/head</a>: cannot open `<a href="file:/etc/passwd">/etc/passwd</a>' for reading: Permission denied
        $

       If /tmp/change_p is to be confined as well, then the following profile can be used (in  addition  to  the
       one for 'i_cant_be_trusted_anymore', above):

        # Confine change_p to be able to read <a href="file:/etc/passwd">/etc/passwd</a> and aa_change_profile()
        # to the 'i_cant_be_trusted_anymore' profile.
        /tmp/change_p {
            <a href="file:/etc/ld.so.cache">/etc/ld.so.cache</a>          mr,
            /lib/ld-*.so*             mrix,
            /lib/libc*.so*            mr,

            <a href="file:/etc/passwd">/etc/passwd</a>               r,

            # Needed for aa_change_profile()
            /usr/lib/libapparmor*.so* mr,
            <a href="file:/proc/">/proc/</a>[0-9]*/attr/current w,
            change_profile -&gt; i_cant_be_trusted_anymore,
        }

</pre><h4><b>BUGS</b></h4><pre>
       None  known. If you find any, please report them at &lt;https://gitlab.com/apparmor/apparmor/-/issues&gt;. Note
       that using <b><a href="../man2/aa_change_profile.2.html">aa_change_profile</a></b>(2) without <b><a href="../man2/execve.2.html">execve</a></b>(2) provides no memory barriers between different areas  of
       a program; if address space separation is required, then separate processes should be used.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man7/apparmor.7.html">apparmor</a></b>(7), <b><a href="../man5/apparmor.d.5.html">apparmor.d</a></b>(5), <b><a href="../man8/apparmor_parser.8.html">apparmor_parser</a></b>(8), <b><a href="../man2/aa_change_hat.2.html">aa_change_hat</a></b>(2) and &lt;https://wiki.apparmor.net&gt;.

AppArmor 4.1.1                                     2025-07-23                               <u><a href="../man2/AA_CHANGE_PROFILE.2.html">AA_CHANGE_PROFILE</a></u>(2)
</pre>
 </div>
</div></section>
</div>
</body>
</html>