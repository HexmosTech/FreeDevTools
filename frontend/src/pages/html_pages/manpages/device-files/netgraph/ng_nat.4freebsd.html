<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ng_nat — NAT netgraph node type</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/freebsd-manpages">freebsd-manpages_12.2-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       ng_nat — NAT netgraph node type

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;netgraph/ng_nat.h&gt;</b>

</pre><h4><b>DESCRIPTION</b></h4><pre>
       An <b>ng_nat</b> node performs network address translation (NAT) of IPv4 packets passing through it.  A <b>nat</b> node
       uses <u><a href="../man3/libalias.3.html">libalias</a></u>(3) engine for packet aliasing.

</pre><h4><b>HOOKS</b></h4><pre>
       This node type has two hooks:

       <u>out</u>  Packets  received  on  this  hook  are  considered  outgoing and will be masqueraded to a configured
            address.

       <u>in</u>   Packets coming on this hook are considered incoming and will be dealiased.

</pre><h4><b>CONTROL</b> <b>MESSAGES</b></h4><pre>
       This node type supports the generic control messages, plus the following:

       NGM_NAT_SET_IPADDR (<b>setaliasaddr</b>)
            Configure aliasing address for a node.  After both hooks have been connected  and  aliasing  address
            was configured, a node is ready for aliasing operation.

       NGM_NAT_SET_MODE (<b>setmode</b>)
            Set node's operation mode using supplied <u>struct</u> <u>ng_nat_mode</u>.

            struct ng_nat_mode {
                    uint32_t        flags;
                    uint32_t        mask;
            };
            /* Supported flags: */
            #define NG_NAT_LOG                      0x01
            #define NG_NAT_DENY_INCOMING            0x02
            #define NG_NAT_SAME_PORTS               0x04
            #define NG_NAT_UNREGISTERED_ONLY        0x10
            #define NG_NAT_RESET_ON_ADDR_CHANGE     0x20
            #define NG_NAT_PROXY_ONLY               0x40
            #define NG_NAT_REVERSE                  0x80

       NGM_NAT_SET_TARGET (<b>settarget</b>)
            Configure  target  address for a node.  When an incoming packet not associated with any pre-existing
            aliasing link arrives at the host machine, it will be sent to the specified address.

       NGM_NAT_REDIRECT_PORT (<b>redirectport</b>)
            Redirect incoming connections arriving to given port(s) to another host and port(s).  The  following
            <u>struct</u> <u>ng_nat_redirect_port</u> must be supplied as argument.

            #define NG_NAT_DESC_LENGTH      64
            struct ng_nat_redirect_port {
                    struct in_addr  local_addr;
                    struct in_addr  alias_addr;
                    struct in_addr  remote_addr;
                    uint16_t        local_port;
                    uint16_t        alias_port;
                    uint16_t        remote_port;
                    uint8_t         proto;
                    char            description[NG_NAT_DESC_LENGTH];
            };

            Redirection  is assigned an unique ID which is returned as response to this message, and information
            about  redirection  added  to  list  of  static  redirects  which  later   can   be   retrieved   by
            NGM_NAT_LIST_REDIRECTS message.

       NGM_NAT_REDIRECT_ADDR (<b>redirectaddr</b>)
            Redirect traffic for public IP address to a machine on the local network.  This function is known as
            <u>static</u> <u>NAT</u>.  The following <u>struct</u> <u>ng_nat_redirect_addr</u> must be supplied as argument.

            struct ng_nat_redirect_addr {
                    struct in_addr  local_addr;
                    struct in_addr  alias_addr;
                    char            description[NG_NAT_DESC_LENGTH];
            };

            Unique ID for this redirection is returned as response to this message.

       NGM_NAT_REDIRECT_PROTO (<b>redirectproto</b>)
            Redirect incoming IP packets of protocol <u>proto</u> (see <u><a href="../man5/protocols.5.html">protocols</a></u>(5)) to a machine on the local network.
            The following <u>struct</u> <u>ng_nat_redirect_proto</u> must be supplied as argument.

            struct ng_nat_redirect_proto {
                    struct in_addr  local_addr;
                    struct in_addr  alias_addr;
                    struct in_addr  remote_addr;
                    uint8_t         proto;
                    char            description[NG_NAT_DESC_LENGTH];
            };

            Unique ID for this redirection is returned as response to this message.

       NGM_NAT_REDIRECT_DYNAMIC (<b>redirectdynamic</b>)
            Mark  redirection  with specified ID as dynamic, i.e., it will serve for exactly one next connection
            and then will be automatically deleted from internal links table.  Only fully specified links can be
            made dynamic.  The redirection with this ID is also immediately deleted from  user-visible  list  of
            static redirects (available through NGM_NAT_LIST_REDIRECTS message).

       NGM_NAT_REDIRECT_DELETE (<b>redirectdelete</b>)
            Delete redirection with specified ID (currently active connections are not affected).

       NGM_NAT_ADD_SERVER (<b>addserver</b>)
            Add another server to a pool.  This is used to transparently offload network load on a single server
            and  distribute  the  load  across a pool of servers, also known as <u>LSNAT</u> (RFC 2391).  The following
            <u>struct</u> <u>ng_nat_add_server</u> must be supplied as argument.

            struct ng_nat_add_server {
                    uint32_t        id;
                    struct in_addr  addr;
                    uint16_t        port;
            };

            First, the redirection is set up by NGM_NAT_REDIRECT_PORT or  NGM_NAT_REDIRECT_ADDR.   Then,  ID  of
            that redirection is used in multiple NGM_NAT_ADD_SERVER messages to add necessary number of servers.
            For  redirections  created  by  NGM_NAT_REDIRECT_ADDR, the <u>port</u> is ignored and could have any value.
            Original   redirection's   parameters   <u>local_addr</u>   and   <u>local_port</u>   are   also   ignored   after
            NGM_NAT_ADD_SERVER was used (they are effectively replaced by server pool).

       NGM_NAT_LIST_REDIRECTS (<b>listredirects</b>)
            Return list of configured static redirects as <u>struct</u> <u>ng_nat_list_redirects</u>.

            struct ng_nat_listrdrs_entry {
                    uint32_t        id;             /* Anything except zero */
                    struct in_addr  local_addr;
                    struct in_addr  alias_addr;
                    struct in_addr  remote_addr;
                    uint16_t        local_port;
                    uint16_t        alias_port;
                    uint16_t        remote_port;
                    uint16_t        proto;          /* Valid proto or NG_NAT_REDIRPROTO_ADDR */
                    uint16_t        lsnat;          /* LSNAT servers count */
                    char            description[NG_NAT_DESC_LENGTH];
            };
            struct ng_nat_list_redirects {
                    uint32_t                total_count;
                    struct ng_nat_listrdrs_entry redirects[];
            };
            #define NG_NAT_REDIRPROTO_ADDR  (IPPROTO_MAX + 3)

            Entries  of  the  <u>redirects</u>  array returned in the unified format for all redirect types.  Ports are
            meaningful only  if  protocol  is  either  TCP  or  UDP  and  <u>static</u>  <u>NAT</u>  redirection  (created  by
            NGM_NAT_REDIRECT_ADDR)  is  indicated  by  <u>proto</u>  set  to  NG_NAT_REDIRPROTO_ADDR.  If <u>lsnat</u> servers
            counter is greater than zero, then <u>local_addr</u> and <u>local_port</u> are also meaningless.

       NGM_NAT_PROXY_RULE (<b>proxyrule</b>)
            Specify a transparent proxying rule (string must be supplied  as  argument).   See  <u><a href="../man3/libalias.3.html">libalias</a></u>(3)  for
            details.

       NGM_NAT_LIBALIAS_INFO (<b>libaliasinfo</b>)
            Return internal statistics of <u><a href="../man3/libalias.3.html">libalias</a></u>(3) instance as <u>struct</u> <u>ng_nat_libalias_info</u>.

            struct ng_nat_libalias_info {
                    uint32_t        icmpLinkCount;
                    uint32_t        udpLinkCount;
                    uint32_t        tcpLinkCount;
                    uint32_t        sctpLinkCount;
                    uint32_t        pptpLinkCount;
                    uint32_t        protoLinkCount;
                    uint32_t        fragmentIdLinkCount;
                    uint32_t        fragmentPtrLinkCount;
                    uint32_t        sockCount;
            };
            In case of <b>ng_nat</b> failed to retrieve a certain counter from its <u>libalias</u> instance, the corresponding
            field is returned as <u>UINT32_MAX</u>.

       NGM_NAT_SET_DLT (<b>setdlt</b>)
            Sets  the  data  link  type on the <u>in</u> and <u>out</u> hooks.  Currently, supported types are <b>DLT_RAW</b> (raw IP
            datagrams , no offset applied, the default) and <b>DLT_EN10MB</b> (Ethernet). DLT_ definitions can be found
            in &lt;<u>net/bpf.h</u>&gt;.  If you want to work on the <u><a href="../man8/ipfw.8.html">ipfw</a></u>(8) level you  must  use  no  additional  offset  by
            specifying  <b>DLT_RAW</b>.   If,  however, you attach <b>ng_nat</b> to a network interface directly and <b>EN10MB</b> is
            specified, then the extra offset will be applied to take into account link-level  header.   In  this
            mode  the  <b>ng_nat</b>  would also inspect appropriate type field in the Ethernet header and pass-through
            any datagrams that are not IP packets.

       NGM_NAT_GET_DLT (<b>getdlt</b>)
            This control message returns the current data link type of the <u>in</u> and <u>out</u> hooks.

       In all redirection messages <u>local_addr</u> and <u>local_port</u> mean address and port  of  target  machine  in  the
       internal  network,  respectively.   If  <u>alias_addr</u>  is  zero,  then  default  aliasing  address  (set  by
       NGM_NAT_SET_IPADDR) is used.  Connections can also be  restricted  to  be  accepted  only  from  specific
       external  machines  by  using  non-zero  <u>remote_addr</u> and/or <u>remote_port</u>.  Each redirection assigned an ID
       which can be later used for redirection manipulation  on  individual  basis  (e.g.,  removal).   This  ID
       guaranteed to be unique until the node shuts down (it will not be reused after deletion), and is returned
       to  user  after  making each new redirection or can be found in the stored list of all redirections.  The
       <u>description</u> passed to and from node unchanged, together with ID providing a way for several  entities  to
       concurrently manipulate redirections in automated way.

</pre><h4><b>SHUTDOWN</b></h4><pre>
       This node shuts down upon receipt of a NGM_SHUTDOWN control message, or when both hooks are disconnected.

</pre><h4><b>EXAMPLES</b></h4><pre>
       In the following example, the packets are injected into a <b>nat</b> node using the <u><a href="../man4/ng_ipfw.4.html">ng_ipfw</a></u>(4) node.

             # Create NAT node
             ngctl mkpeer ipfw: nat 60 out
             ngctl name ipfw:60 nat
             ngctl connect ipfw: nat: 61 in
             ngctl msg nat: setaliasaddr x.y.35.8

             # Divert traffic into NAT node
             ipfw add 300 netgraph 61 all from any to any in via fxp0
             ipfw add 400 netgraph 60 all from any to any out via fxp0

             # Let packets continue with after being (de)aliased
             sysctl net.inet.ip.fw.one_pass=0

       The <b>ng_nat</b> node can be inserted right after the <u><a href="../man4/ng_iface.4.html">ng_iface</a></u>(4) node in the graph.  In the following example,
       we perform masquerading on a serial line with HDLC encapsulation.

             /usr/sbin/ngctl -f- &lt;&lt;-SEQ
                     mkpeer cp0: cisco rawdata downstream
                     name cp0:rawdata hdlc
                     mkpeer hdlc: nat inet in
                     name hdlc:inet nat
                     mkpeer nat: iface out inet
                     msg nat: setaliasaddr x.y.8.35
             SEQ
             ifconfig ng0 x.y.8.35 x.y.8.1

       The  <b>ng_nat</b>  node  can  also  be  attached directly to the physical interface via <u><a href="../man4/ng_ether.4.html">ng_ether</a></u>(4) node in the
       graph.  In the following example, we perform masquerading on a Ethernet interface connected to  a  public
       network.

             ifconfig igb0 inet x.y.8.35 netmask 0xfffff000
             route add default x.y.0.1
             /usr/sbin/ngctl -f- &lt;&lt;-SEQ
                     mkpeer igb0: nat lower in
                     name igb0:lower igb0_NAT
                     connect igb0: igb0_NAT: upper out
                     msg igb0_NAT: setdlt 1
                     msg igb0_NAT: setaliasaddr x.y.8.35
             SEQ

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man3/libalias.3.html">libalias</a></u>(3), <u><a href="../man4/ng_ipfw.4.html">ng_ipfw</a></u>(4), <u><a href="../man8/natd.8.html">natd</a></u>(8), <u><a href="../man8/ngctl.8.html">ngctl</a></u>(8), <u><a href="../man8/ng_ether.8.html">ng_ether</a></u>(8)

</pre><h4><b>HISTORY</b></h4><pre>
       The <b>ng_nat</b> node type was implemented in FreeBSD 6.0.

</pre><h4><b>AUTHORS</b></h4><pre>
       Gleb Smirnoff &lt;<u><a href="mailto:glebius@FreeBSD.org">glebius@FreeBSD.org</a></u>&gt;

Debian                                          December 12, 2018                                      <u><a href="../man4/NG_NAT.4.html">NG_NAT</a></u>(4)
</pre>
 </div>
</div></section>
</div>
</body>
</html>