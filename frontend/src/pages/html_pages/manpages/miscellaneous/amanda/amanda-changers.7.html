<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>amanda-changers - Configuring and Using Amanda Changers</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/amanda-common">amanda-common_3.5.4-2_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       amanda-changers - Configuring and Using Amanda Changers

</pre><h4><b>DESCRIPTION</b></h4><pre>
       Amanda uses changers to arbitrate access to devices (<b><a href="../man7/amanda-devices.7.html">amanda-devices</a></b>(7)) and data volumes. Changers
       provide an abstraction of tape robots, but are used to manage non-tape media, too. Amanda communicates
       with changers through the Changer API. This manpage contains a <u>user-level</u> overview of the API, and does
       not address details that are only of concern to developers. For that purpose, consult the Amanda source
       code and <a href="http://wiki.zmanda.com">http://wiki.zmanda.com</a>.

</pre><h4><b>TRANSITION</b></h4><pre>
       The Amanda Changer API version 1.0 is no longer supported.

       The Amanda Changer API version 2.0, composed of perl objects that can manage parallel access to multiple
       devices and other complexity. At this point, all Amanda programs use the new Changer API directly.

       The Changer API strives to treat all changers identically, so that Amanda's behavior is independent of
       the changer in use. However, some parts of Amanda operate differently depending on whether a changer can
       efficiently search for a volume with a given label. This distinction is really only apparent with tape
       libraries: those with barcode readers can quickly find a desired tape, while those without may fall back
       to an inefficient scan of each volume. The capability to perform quick searches is called "fast-search",
       and each changer is annotated below to indicate its support.

</pre><h4><b>SPECIFYING</b> <b>CHANGERS</b></h4><pre>
       Changer specifications are strings like chg-disk:/my/vtapes. The chg- prefix serves to differentiate
       changers from devices (see <b><a href="../man7/amanda-devices.7.html">amanda-devices</a></b>(7)). The next portion (disk, in this case) identifies the
       particular changer driver to use, and everything that follows the : is interpreted by the driver. Note
       that the : character is required, even when nothing follows it.

       A name which does not match this pattern, is treated as an Amanda device, and is wrapped by the
       single-device changer, e.g., chg-single:tape:/dev/rmt/0.

       Changers which require additional parameters can also be described in <b><a href="../man5/amanda.conf.5.html">amanda.conf</a></b>(5) with "changer"
       sections. Such a changer defininition creates a changer "alias", in this case named <u>hp-robot</u>, which can
       then be named where an application expects a changer - for example, the target of the <b>amvault</b> command or
       in a global <b>tpchanger</b> parameter.

   <b>CONFIGURATION</b>
       The preferred method of specifying configuration for a changer is as a "changer" section in
       <b><a href="../man5/amanda.conf.5.html">amanda.conf</a></b>(5). The <u>tapedev</u> parameter then indicates, by name, the changer that will be used by default
       by most Amanda programs. For example:

       define changer hp-robot {
           tapedev "chg-robot:/dev/sg1"
           property "tape-device" "0=tape:/dev/nst0"
           property append "tape-device" "1=tape:/dev/nst1"
           device-property "BLOCK_SIZE" "512k"
       }
       # ...
       tapedev "hp-robot"

       Several changer drivers accept <u>changer</u> <u>properties</u> which control the behavior of the changer. These
       properties must be specified in a changer definition, as in the <u>hp-robot</u> example, above.

       Devices, too, can take properties to control their behavior (see <b><a href="../man7/amanda-devices.7.html">amanda-devices</a></b>(7)). Device properties
       can come from four places: implicit device properties (from tapetype parameters), global device
       properties (from global <u>device-property</u> parameters), properties in device definitions, and properties in
       changer definitions. Properties are applied in this order, with later properties taking priority.

       There are only three implicit properties: <u>MAX_VOLUME_USAGE</u> is set based on the tapetype <u>length</u> parameter,
       <u>READ_BLOCK_SIZE</u> is set if <u>readblocksize</u> is set, and <u>BLOCK_SIZE</u> is set based on the <u>blocksize</u> parameter.

       Global device properties always apply. If the changer specifies a device by alias, then device properties
       from the definition apply. If the changer is specified by an alias, then properties from that definition
       applied.

</pre><h4><b>CHANGER</b> <b>DRIVERS</b></h4><pre>
       This section lists the changer drivers included with Amanda, and basic instructions for using them. For
       complete How-To information, consult the Amanda wiki at <a href="http://wiki.zmanda.com">http://wiki.zmanda.com</a>.

   <b>chg-aggregate:changer</b>
       define changer robot0 {
         tpchanger "chg-robot:/dev/sg0"
         property "tape-device" "0=tape:/dev/rmt/0" "1=tape:/dev/rmt/1"
       }
       define changer robot1 {
         tpchanger "chg-robot:/dev/sg1"
         property "tape-device" "0=tape:/dev/rmt/2" "1=tape:/dev/rmt/3"
       }
       define changer single {
         tpchanger "chg-single:/dev/rmt/4"
       }
       define changer aggregate {
         tpchanger "chg-aggregate:{robot0,robot1,single}"
         property "state-filename" "/etc/amanda/CONF/aggregate.state"

       }
       tpchanger "aggregate"

       This changer driver allow the use of two or more changers or standalone drives in sequence.

   <b>Properties</b>
       LOCK-TIMEOUT

           The time in seconds amanda wait to lock the statefile (default:1000)

       STATE_FILENAME

           The name of the state file (default: "$CONFIG_DIR/$changer_name.state".

   <b>chg-disk:VTAPEROOT</b>
       tpchanger "chg-disk:/var/mnt/vtapes"
       property "num-slot" "10"
       property "auto-create-slot" "yes"
       property "removable" "yes"
       property "mount" "yes"
       property "umount" "yes"
       property "umount-lockfile" "/etc/amanda/conf/vtapes-lock"
       property "umount-idle" "1"

       This changer driver replaces the old <b>chg-disk</b>, supporting parallel access to vtapes stored in directories
       named slotN in the directory specified after chg-disk:. It does so by creating numbered "drives" so that
       simultaneous processes can access distinct slots. This changer is fast-search capable.

       The current slot can be accessed using the device name file:VTAPEROOT. This is useful for the
       <b><a href="../man8/amrestore.8.html">amrestore</a></b>(8) command line.

   <b>Properties</b>
       AUTO-CREATE-SLOT

           If a slotN directory in the range 1 to NUM-SLOT does not already exist, and this property is true,
           then the changer will create the directory.

       LOCK-TIMEOUT

           The time in seconds amanda wait to lock the statefile (default:1000)

       MOUNT

           If this property is true, the changer try to mount the removable disk if nothing is mounted. The
           system must be configured to allow the amanda user to mount it.

       NUM-SLOT

           The minimum number of slots in the changer, where the first slot is slot1.  If additional slot
           directories exist, they will also be used.

       REMOVABLE

           If this property is true, then the changer will verify that the changer directory (e.g.,
           /var/mnt/vtapes) is on a different filesystem from its parent directory (e.g., /var/mnt).  This is
           useful for removable disks, as it will prevent Amanda from creating slot directories when the
           removable disk is not mounted.

       UMOUNT

           If this property is true, the changer try to umount the removable disk when it exit. The system must
           be configured to allow the amanda user to umount it.

       UMOUNT-LOCKFILE

           If UMOUNT is set, it require a lockfile outside of the mount point to prevent race.

       UMOUNT-IDLE

           If set, the changer try to umount the removable disk when it is not in use. The umount-idle value is
           a delay in second to wait before doing the umount. A value &gt;= 1 is required to prevent useless
           mount/umount.

   <b>chg-diskflat:VTAPEROOT</b>
       tpchanger "chg-diskflat:/var/mnt/vtapes-flat"
       property "num-slot" "10"
       property "auto-create-slot" "yes"
       property "removable" "yes"
       property "mount" "yes"
       property "umount" "yes"
       property "umount-lockfile" "/etc/amanda/conf/vtapes-flat-lock"
       property "umount-idle" "1"

       This changer driver can be used only with the diskflat device, supporting parallel access to vtapes
       stored in files named with the label in the directory specified after chg-diskflat:. It does so by
       creating numbered "drives" so that simultaneous processes can access distinct slots. This changer is
       fast-search capable.

   <b>Properties</b>
       Have the same properties as the chg-disk changers

   <b>chg-multi:DEVICE-LIST</b>
       tpchanger "chg-multi:{/dev/nst0,/dev/nst1,/dev/nst2}"
       changerfile "chg-multi-state"

       This script simply round-robins a number of distinct device names, as specified in the <u>tpchanger</u> setting.
       It is useful when all volumes for a configuration have different device names -- for example, if you have
       many standalone drive. The <u>changerfile</u> must exist; it is used to save the state file.

       The child devices are specified using the same syntax as for the RAIT device (see <b><a href="../man7/amanda-changers.7.html">amanda-changers</a></b>(7)).
       The range specification can be especially useful here:

       tpchanger "chg-multi:s3:mycompany-backups/tape-{001..100}"

       This changer is not fast-search capable.

   <b>Properties</b>
       FIRST-SLOT

           This property gives the number of the first slot. The default value is "1".

       LOCK-TIMEOUT

           The time in seconds amanda wait to lock the statefile (default:1000)

   <b>Special</b> <b>Operations</b>
       A number of special operations are available for <b>chg-multi</b> via <b><a href="../man8/amtape.8.html">amtape</a></b>(8) subcommands.

       The <b>reset</b> subcommand will change the current slot to the first available slot, but does not erase any
       stored state maintained by the changer.

       The <b>eject</b> subcommand will eject the volume in the given drive

       The <b>clean</b> subcommand is not yet implemented.

       The <b>update</b> subcommand instructs the changer to update its state database. Given no arguments, the changer
       will scan all available slots, loading each tape and reading its label. Especially for large libraries,
       this can take a long time. If only a few slots have changed, they can be listed on the command line:

       amtape CONFIG update 1-3,9
       In this case, the changer will only scan the stated slots. Finally, the changer will not scan at all if
       it is given the tape label for the slot:

       amtape CONFIG update 2=DailySet-028
       In this case, the changer updates its state to indicate that DailySet-028 is in slot 2, without trying to
       load the tape.

       amtape CONFIG update 1-3,9=
       In this case, the changer marks the stated slots as an unknown state.

       amtape CONFIG update error=
       In this case, the changer marks all slot in error as an unknown state.

   <b>chg-rait:{CHILD1,CHILD2,..}</b>
       define changer vtape {
           tpchanger "chg-disk:/path/to/vtape"
       }
       define changer robot {
           tpchanger "chg-robot:/dev/sg0"
           tapedev "tape:/dev/nst0"
       }
       tpchanger "chg-rait:{vtape,robot}"

       This changer script constructs RAIT devices out of the devices provided by several "sub-changers". The
       sub-changers are specified using the same shell-like syntax as the RAIT device (see <b><a href="../man7/amanda-devices.7.html">amanda-devices</a></b>(7)).

       Chg-rait does not require that all of the child changers have the same slot names: compound slot names
       are created by combining the slot names supplied by the child changers using the same shell-like syntax.
       For example, if the child changers return slots "top", "strange", and "3", then the RAIT changer will
       return "{top,strange,3}". This makes it possible to, for example, mirror data on tapes in slots 1-10 to
       tapes in slots 11-20 of the same robot, using two <b>chg-zd-mtx</b> child changers (and, naturally, two tape
       drives). In this arrangement, the first slot would be named {1,11}.

       As a convenience to the user, the RAIT changer will also accept un-braced slot names, and supply the same
       name to each child changer. Thus with a 4-device RAIT changer, "17" is equivalent to "{17,17,17,17}".

       Drive names are parsed in a similar fashion, for operations that take drive names (clean and eject).

       This changer is fast-search capable only if all of its child changers are fast-search capable.

   <b>chg-null:</b>
       tpchanger "chg-null:"

       This changer always provides the device "null:". It is sometimes useful in conjunction with <b>chg-rait:</b>.

   <b>chg-robot:DEVICE</b>
       define changer robot {
           tpchanger "chg-robot:/dev/sg0"
           property "tape-device" "0=tape:/dev/rmt/0" "1=tape:/dev/rmt/1"
           property "eject-before-unload" "yes"
           property "use-slots" "1-5,11-20"
       }
       tpchanger "robot"

       This changer drives a robotic tape library using the operating system's <b>mtx</b> command. It replaces the
       ancient <b>chg-zd-mtx</b> script. The changer uses all of the information available to operate as efficiently as
       possible. Even without a barcode reader, the changer can usually load a tape immediately, without
       resorting to a sequential scan of many tapes. It is capable of sharing state across multiple Amanda
       configurations, avoiding conflicts and optimally tracking the contents of the library.

       This changer does not accept a <b>changerdev</b> parameter, but the <b>changerfile</b> parameter can be used to specify
       a filename at which it should store its state. Ordinarily, this state is stored in a file named after the
       changer device under <u>$localstatedir/amanda</u>, e.g., <b>/var/amanda/chg-robot-dev-sg0</b>. There should be a single
       such statefile for each distinct tape library attached to the Amanda server, even if multiple Amanda
       configurations reference that library.

       With a barcode reader present, it is possible for <b>chg-robot</b> to track the state of the library reliably,
       even recognizing tapes that are removed and later re-inserted (by remembering their barcodes). Without
       barcodes, the changer can still remember the slot in which it last saw the tape with a particular label,
       although this information can become stale if the tapes are rearranged by an operator. In any case, the
       changer will never "hunt" for a tape by repeatedly loading slots and checking labels. If the changer's
       state is inaccurate, use the <b><a href="../man8/amtape.8.html">amtape</a></b>(8) subcommand <b>update</b>.

       This changer is fast-search capable even without a barcode reader. For such libraries, it is the
       responsibility of the operator to <b>update</b> the changer when tapes are added to or removed from the library.

       There is a shell script in the contrib/ directory of Amanda's source distribution which can help you
       convert a <b>chg-zd-mtx</b> configuration into a <b>chg-robot</b> configuration. Just give it your Amanda configuration
       name:

         sh contrib/convert-zd-mtx-to-robot.sh $config
       The script can be downloaded at
       <a href="http://github.com/zmanda/amanda/raw/master/contrib/convert-zd-mtx-to-robot.sh">http://github.com/zmanda/amanda/raw/master/contrib/convert-zd-mtx-to-robot.sh</a>

   <b>Special</b> <b>Operations</b>
       A number of special operations are available for <b>chg-robot</b> via <b><a href="../man8/amtape.8.html">amtape</a></b>(8) subcommands.

       The <b>reset</b> subcommand will change the current slot to the first available slot, but does not erase any
       stored state maintained by the changer.

       The <b>eject</b> subcommand will unload the volume in the given drive, ejecting first if the changer properties
       dictate. Note that, despite the subcommand name, the changer attempts to avoid the state where a volume
       has been ejected from the drive but not unloaded back to a storage slot.

       The <b>clean</b> subcommand is not yet implemented.

       The <b>update</b> subcommand instructs the changer to update its state database. Given no arguments, the changer
       will scan all available slots, loading each tape and reading its label. Especially for large libraries,
       this can take a long time. If only a few slots have changed, they can be listed on the command line:

       amtape CONFIG update 1-3,9
       In this case, the changer will only scan the stated slots. Finally, the changer will not scan at all if
       it is given the tape label for the slot:

       amtape CONFIG update 2=DailySet-028
       In this case, the changer updates its state to indicate that DailySet-028 is in slot 2, without trying to
       load the tape.

       amtape CONFIG update 1-3,9=
       In this case, the changer marks the stated slots as an unknown state.

       amtape CONFIG update error=
       In this case, the changer marks all slot in error as an unknown state.

   <b>Properties</b>
       BROKEN-DRIVE-LOADED-SLOT

           Set this boolean property to true if mtx doesn't return correctly which slot is loaded in a drive.

       DRIVE-CHOICE

           This property controls the algorithm used to select a drive in which to load a tape.  If set to the
           default ("lru"), the changer attempts to use the least recently used drive, resulting in a
           round-robin behavior.  The "firstavail" algorithm selects the first available drive, thus preferring
           the first drive specified via the TAPE-DEVICE property.

       EJECT-BEFORE-UNLOAD

           Set this boolean property to true if the library requires an <b>offline</b> operation be performed on the
           tape drive before it can be unloaded.  If set, then <b>mt</b> will be invoked to perform this operation.
           Most libraries do not require this workaround.

       EJECT-DELAY

           This is the time between ejecting a tape and unloading the volume to a storage slot, and defaults to
           0 seconds.  It is only used if EJECT-BEFORE-UNLOAD is true.  See "Timing", below.

       FAST-SEARCH

           This boolean property indicates whether the changer advertises the ability to find volumes without
           sequential scanning.  The traditional taperscan algorithm alters its behavior based on this flag, so
           it is sometimes necessary to adjust it, although the changer will always search for a desired tape
           using the most efficient means available.  The default value is true.

       IGNORE-BARCODES

           If this boolean property is true, then chg-robot will ignore any barcode information that the library
           provides.  This property is probably only useful when the library returns incorrect barcodes, for
           example due to a malfunction in the barcode reader.

       LOAD-POLL
           This property specifies the timing of Amanda's polling for the tape drive to be ready after loading a
           new tape. See "Timing", below.

           The script "polls" by trying to open the tape device repeatedly until no error is encountered. The
           property specifies the time to wait before the first poll (D), the frequency at which to poll and
           retry on errors (P); and the time after which it should give up (U). The format is

           "D [poll P [until U]]"
           For a simple delay with no polling, use e.g.,

           property "load-poll" "13s"
           To delay and then poll, use e.g.,

           property "load-poll" "13s poll 5s"
           and to add a maximum total time, use e.g.,

           property "load-poll" "0s poll 5s until 2m"
           The default value is <b>"0s</b> <b>poll</b> <b>3s</b> <b>until</b> <b>2m"</b>.

       LOCK-TIMEOUT

           The time in seconds amanda wait to lock the statefile (default:1000)

       MTX

           The path to the 'mtx' binary.  The default value is defined at compile time.

       STATUS-INTERVAL

           This is the minimum time between invocations of <b>mtx</b> <b>status</b> to determine the state of the changer
           library.  The default value, 2 seconds, avoids back-to-back status invocations but ensures that the
           metadata is up to date.  For operating systems or libraries where the <b>mtx</b> <b>status</b> takes a considerable
           time to complete, this value should be increased.  See "Timing", below.

       TAPE-DEVICE

           This property describes the correspondence of drive numbers in the library to Amanda devices, in the
           format <u>DRIVE=DEVICE</u>.  The property can be specified multiple times to describe multiple devices.  The
           device will usually be a tape device name starting with <b>tape:</b>, but may also refer to a device alias
           (see <b><a href="../man7/amanda-devices.7.html">amanda-devices</a></b>(7)). As a shortcut, if the <b>tapedev</b> parameter is specified in the changer
           definition, then it is assumed to be the device name for drive 0.

       UNLOAD-DELAY

           This specifies the minimum time between an unload operation any any subsequent operation.  The
           default value is 0 seconds.  See "Timing", below.

       USE-SLOTS

           This property, if specifies, enumerates the slots to which this changer should limit itself.  The
           slots are specified as a comma-separated list of ranges, e.g., "1-5,11-15,19,22".  The property can
           be specified more than once, and the resulting sets will be combined.  The changer will refuse to
           load tapes not found in these slots, except for import/export purposes.

   <b>Timing</b>
       Tape libraries are fickle, and in many cases will report that an operation is complete when it is still
       in progress. Chg-robot takes several timing-related properties to accommodate such behavior.

       A typical sequence of operations performed during a load are: get library status, eject a tape, unload
       the tape back to a storage slot, load a new tape, and read the label on that tape to ensure the drive is
       ready.

       On most systems, the library status check is nearly instantaneous -- the changer library provides its
       cached state to the host without initiating any robot motion. In order to keep its metadata up-to-date,
       chg-robot runs this command very frequently, but this frequency can be reduced (at the cost of
       potentially stale metadata) by setting the STATUS-INTERVAL property to a larger value.

       Some tape libraries do not integrate the eject operation (performed by the embedded tape drive) with the
       unload operation (performed by the library robot), and can actually cause physical damage by attempting
       to remove the tape before the ejection is complete. For such changers, set the EJECT-DELAY property to
       allow enough time for the eject to complete.

       Once a tape is unloaded, if the library needs time to "quiesce" before processing another command, add
       that time to the UNLOAD-DELAY parameter. No other operations will be performed on the library until this
       delay has elapsed.

       Once a tape has been loaded, chg-robot waits until the drive is ready before allowing Amanda to use the
       volume, as described for LOAD-POLL, above.

       Each of the times specified in these properties may be given as integers with the optional suffix <b>s</b> for
       seconds (the default) or <b>m</b> for minutes.

   <b>chg-ndmp:HOST[:PORT]@SCSIDEV</b>
           tpchanger "chg-ndmp:filer.company.com@/dev/sg0"
           property        "tape-device" "0=ndmp:filer.company.com@/dev/rtape0"
           property append "tape-device" "1=ndmp:filer.company.com@/dev/rtape1"
           property "use-slots" "1-12"
           property "ndmp-auth" "text"
           property "ndmp-username" "luke"
           property "ndmp-password" "leia"

       This changer is very similar to <b>chg-robot</b>, but controls a tape changer on an NDMP server instead of a
       local device. The <b>HOST</b> in the <b>tpchanger</b> should be the hostname of the NDMP server. The <b>PORT</b> is optional.
       The <b>SCSIDEV</b> should specify the SCSI device on the NDMP server which controls the changer. The format of
       this parameter is implementation-specific.

       The appropriate authentication properties will be automatically set on any devices created by this
       changer.

   <b>Properties</b>
       This changer supports all of the properties supported by <b>chg-robot</b>, although the value of <b>MTX</b> is ignored.
       The following properties are also recognized:

       NDMP_AUTH

           Authentication method to use to connect to the NDMP server.  One of "md5" (default), "text", "none"
           (for an empty authentication attempt) or "void" (for no authentication attempt at all).

       NDMP-PASSWORD

           The password for the NDMP server.

       NDMP-USERNAME

           The username for the NDMP server.

       VERBOSE

           If true, enables the NDMJOB library's verbose (packet-level) debugging.

   <b>chg-single:DEVICE</b>
       tpchanger "chg-single:tape:/dev/nst0"

       This changer is for use with standalone drive, it can work with any device. The device (<b>tape:/dev/nst0</b>)
       must be set in the tpchanger definition.

       The <b>chg-single</b> changer has no property.

   <b>Unmaintained</b> <b>Changers</b>
       Amanda has many other changer scripts and programs beyond those described here (see the changer-src/ in
       the source directory), but most of these scripts are unmaintained and undocumented, and will be removed
       when the new changer API is fully implemented.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man8/amanda.8.html">amanda</a></b>(8), <b><a href="../man5/amanda.conf.5.html">amanda.conf</a></b>(5), <b><a href="../man7/amanda-devices.7.html">amanda-devices</a></b>(7)

       The Amanda Wiki: : <a href="http://wiki.zmanda.com/">http://wiki.zmanda.com/</a>

</pre><h4><b>AUTHOR</b></h4><pre>
       <b>Dustin</b> <b>J.</b> <b>Mitchell</b> &lt;<a href="mailto:dustin@zmanda.com">dustin@zmanda.com</a>&gt;
           Zmanda, Inc. (<a href="http://www.zmanda.com">http://www.zmanda.com</a>)

Amanda 3.5.4                                       01/25/2025                                 <u><a href="../man7/AMANDA-CHANGERS.7.html">AMANDA-CHANGERS</a></u>(7)
</pre>
 </div>
</div></section>
</div>
</body>
</html>