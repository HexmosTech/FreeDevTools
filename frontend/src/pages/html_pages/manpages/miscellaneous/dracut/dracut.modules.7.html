<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dracut.modules - dracut modules</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/dracut-core">dracut-core_107-1ubuntu5_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       dracut.modules - dracut modules

</pre><h4><b>DESCRIPTION</b></h4><pre>
       dracut uses a modular system to build and extend the initramfs image. All modules are located in
       <u><a href="file:/usr/lib/dracut/modules.d">/usr/lib/dracut/modules.d</a></u> or in <u>&lt;git-src&gt;/modules.d</u>. The most basic dracut module is <u>99base</u>. In <u>99base</u>
       the initial shell script init is defined, which gets run by the kernel after initramfs loading. Although
       you can replace init with your own version of <u>99base</u>, this is not encouraged. Instead you should use, if
       possible, the hooks of dracut. All hooks, and the point of time in which they are executed, are described
       in the section called “BOOT PROCESS STAGES”.

       The main script, which creates the initramfs is dracut itself. It parses all arguments and sets up the
       directory, in which everything is installed. It then executes all check, install, installkernel scripts
       found in the modules, which are to be processed. After everything is installed, the install directory is
       archived and compressed to the final initramfs image. All helper functions used by check, install and
       installkernel are found in the file <u>dracut-functions</u>. These shell functions are available to all module
       installer (install, installkernel) scripts, without the need to source <u>dracut-functions</u>.

       A module can check the preconditions for install and installkernel with the check script. Also
       dependencies can be expressed with check. If a module passed check, install and installkernel will be
       called to install all of the necessary files for the module. To split between kernel and non-kernel parts
       of the installation, all kernel module related parts have to be in installkernel. All other files found
       in a module directory are module specific and mostly are hook scripts and udev rules.

</pre><h4><b>BOOT</b> <b>PROCESS</b> <b>STAGES</b></h4><pre>
       dracut modules can insert custom script at various points, to control the boot process. These hooks are
       plain directories containing shell scripts ending with ".sh", which are sourced by init. Common used
       functions are in <u>dracut-lib.sh</u>, which can be sourced by any script.

   <b>Hook:</b> <b>cmdline</b>
       The <u>cmdline</u> hook is a place to insert scripts to parse the kernel command line and prepare the later
       actions, like setting up udev rules and configuration files.

       In this hook the most important environment variable is defined: root. The second one is rootok, which
       indicates, that a module claimed to be able to parse the root defined. So for example, <b>root=</b><u>iscsi:....</u>
       will be claimed by the iscsi dracut module, which then sets rootok.

   <b>Hook:</b> <b>pre-udev</b>
       This hook is executed right after the cmdline hook and a check if root and rootok were set. Here modules
       can take action with the final root, and before udev has been run.

   <b>Start</b> <b>Udev</b>
       Now udev is started and the logging for udev is setup.

   <b>Hook:</b> <b>pre-trigger</b>
       In this hook, you can set udev environment variables with <b>udevadm</b> <b>control</b> <b>--property=KEY=</b><u>value</u> or control
       the further execution of udev with udevadm.

   <b>Trigger</b> <b>Udev</b>
       udev is triggered by calling udevadm trigger, which sends add events for all devices and subsystems.

   <b>Main</b> <b>Loop</b>
       In the main loop of dracut loops until udev has settled and all scripts in <u>initqueue/finished</u> returned
       true. In this loop there are three hooks, where scripts can be inserted by calling /sbin/initqueue.

       <b>Initqueue</b>

           This hook gets executed every time a script is inserted here, regardless of the udev state.

       <b>Initqueue</b> <b>settled</b>

           This hook (initqueue/settled) gets executed every time udev has settled.

       <b>Initqueue</b> <b>timeout</b>

           This hook (initqueue/timeout) gets executed, when the main loop counter becomes half of the rd.retry
           counter.

       <b>Initqueue</b> <b>online</b>

           This hook (initqueue/online) gets executed whenever a network interface comes online (that is, once
           it is up and configured by the configured network module).

       <b>Initqueue</b> <b>finished</b>

           This hook (initqueue/finished) is called after udev has settled and if all scripts herein return 0
           the main loop will be ended. Arbitrary scripts can be added here, to loop in the initqueue until
           something happens, which a dracut module wants to wait for.

   <b>Hook:</b> <b>pre-mount</b>
       Before the root device is mounted all scripts in the hook pre-mount are executed. In some cases (e.g.
       NFS) the real root device is already mounted, though.

   <b>Hook:</b> <b>mount</b>
       This hook is mainly to mount the real root device.

   <b>Hook:</b> <b>pre-pivot</b>
       This hook is called before cleanup hook, This is a good place for actions other than cleanups which need
       to be called before pivot.

   <b>Hook:</b> <b>cleanup</b>
       This hook is the last hook and is called before init finally switches root to the real root device. This
       is a good place to clean up and kill processes not needed anymore.

   <b>Cleanup</b> <b>and</b> <b>switch_root</b>
       Init (or systemd) kills all udev processes, cleans up the environment, sets up the arguments for the real
       init process and finally calls switch_root. switch_root removes the whole filesystem hierarchy of the
       initramfs, chroot()s to the real root device and calls <a href="file:/sbin/init">/sbin/init</a> with the specified arguments.

       To ensure all files in the initramfs hierarchy can be removed, all processes still running from the
       initramfs should not have any open file descriptors left.

</pre><h4><b>NETWORK</b> <b>INFRASTRUCTURE</b></h4><pre>
       FIXME

</pre><h4><b>WRITING</b> <b>A</b> <b>MODULE</b></h4><pre>
       A simple example module is <u>90kernel-modules</u>, which modprobes a kernel module after udev has settled and
       the basic device drivers have been loaded.

       All module installation information is in the file module-setup.sh.

       First we create a check() function, which just exits with 0 indicating that this module should be
       included by default.

       check():

           return 0

       Then we create the install() function, which installs a cmdline hook with priority number 20 called
       <u>parse-insmodpost.sh</u>. It also installs the <u>insmodpost.sh</u> script in <u><a href="file:/sbin">/sbin</a></u>.

       install():

           inst_hook cmdline 20 "$moddir/parse-insmodpost.sh"
           inst_simple "$moddir/insmodpost.sh" /sbin/insmodpost.sh

       The <u>parse-instmodpost.sh</u> parses the kernel command line for a argument rd.driver.post, blacklists the
       module from being autoloaded and installs the hook <u>insmodpost.sh</u> in the <u>initqueue/settled</u>.

       <u>parse-insmodpost.sh</u>:

           for p in $(getargs rd.driver.post=); do
               echo "blacklist $p" &gt;&gt; /run/modprobe.d/initramfsblacklist.conf
               _do_insmodpost=1
           done

           [ -n "$_do_insmodpost" ] &amp;&amp; /sbin/initqueue --settled --unique --onetime /sbin/insmodpost.sh
           unset _do_insmodpost

       <u>insmodpost.sh</u>, which is called in the <u>initqueue/settled</u> hook will just modprobe the kernel modules
       specified in all rd.driver.post kernel command line parameters. It runs after udev has settled and is
       only called once (--onetime).

       <u>insmodpost.sh</u>:

           . /lib/dracut-lib.sh

           for p in $(getargs rd.driver.post=); do
               modprobe $p
           done

   <b>module-setup.sh:</b> <b>check()</b>
       <u>check()</u> is called by dracut to evaluate the inclusion of a dracut module in the initramfs.

       $hostonly
           If the $hostonly variable is set, then the module check() function should be in "hostonly" mode,
           which means, that the check() should only return 0, if the module is really needed to boot this
           specific host.

       check() should return with:

       0
           Include the dracut module in the initramfs.

       1
           Do not include the dracut module. The requirements are not fulfilled (missing tools, etc.)

       255
           Only include the dracut module, if another module requires it or if explicitly specified in the
           config file or on the argument list.

   <b>module-setup.sh:</b> <b>depends()</b>
       The function depends() should echo all other dracut module names the module depends on.

   <b>module-setup.sh:</b> <b>cmdline()</b>
       This function should print the kernel command line options needed to boot the current machine setup. It
       should start with a space and should not print a newline.

   <b>module-setup.sh:</b> <b>install()</b>
       The install() function is called to install everything non-kernel related. To install binaries, scripts,
       and other files, you can use the functions mentioned in [creation].

       To address a file in the current module directory, use the variable "$moddir".

   <b>module-setup.sh:</b> <b>installkernel()</b>
       In installkernel() all kernel related files should be installed. You can use all of the functions
       mentioned in [creation] to install files.

   <b>Creation</b> <b>Functions</b>
       <b>inst_dir</b> <b>&lt;dir&gt;</b>

           installs a directory &lt;dir&gt; (but not its content) to the same place in the initramfs image.

       <b>inst</b> <b>[-H]</b> <b>&lt;src&gt;</b> <b>[&lt;dst&gt;]</b>

       <b>inst_binary</b> <b>&lt;src&gt;</b> <b>[&lt;dst&gt;]</b>

       <b>inst_script</b> <b>&lt;src&gt;</b> <b>[&lt;dst&gt;]</b>

           installs <u>one</u> file &lt;src&gt; either to the same place in the initramfs or to an optional &lt;dst&gt;, and also
           its dependencies and .hmac file (if it exists). inst with more than two arguments is treated the same
           as inst_multiple, all arguments are treated as files to install and none as install destinations.

           options:

           -H
               log all installed files to <u>/lib/dracut/hostonly-files</u>, so they can be removed if <b>rd.hostonly</b> is
               passed on the kernel command line.

       <b>inst_simple</b> <b>[-H]</b> <b>&lt;src&gt;</b> <b>[&lt;dst&gt;]</b>

           installs <u>one</u> file &lt;src&gt; either to the same place in the initramfs or to an optional &lt;dst&gt;, but
           without installing its dependencies or .hmac file.

           options:

           -H
               log all installed files to <u>/lib/dracut/hostonly-files</u>, so they can be removed if <b>rd.hostonly</b> is
               passed on the kernel command line.

       <b>inst_multiple</b> <b>[-H]</b> <b>[-o]</b> <b>&lt;file&gt;</b> <b>[</b> <b>&lt;file&gt;</b> <b>...]</b>

           installs multiple binaries and files. If executables are specified without a path, dracut will search
           the path PATH=<a href="file:/usr/sbin">/usr/sbin</a>:<a href="file:/sbin">/sbin</a>:<a href="file:/usr/bin">/usr/bin</a>:<a href="file:/bin">/bin</a> for the binary.

           options:

           -H
               log all installed files to <u>/lib/dracut/hostonly-files</u>, so they can be removed if <b>rd.hostonly</b> is
               passed on the kernel command line.

           -o
               optional, a missing file does not lead to an error.

       <b>inst_hook</b> <b>&lt;hookdir&gt;</b> <b>&lt;prio&gt;</b> <b>&lt;src&gt;</b>

           installs an executable/script &lt;src&gt; in the dracut hook &lt;hookdir&gt; with priority &lt;prio&gt;.

       <b>inst_rules</b> <b>&lt;udevrule&gt;</b> <b>[</b> <b>&lt;udevrule&gt;</b> <b>...]</b>

           installs one or more udev rules. Non-existent udev rules are reported, but do not let dracut fail.

       <b>inst_libdir_dir</b> <b>&lt;dir&gt;</b> <b>[&lt;dir&gt;...]</b>

           installs multiple directories (but not their content) located on a library directory to the initramfs
           image.

       <b>inst_libdir_file</b> <b>[-n</b> <b>&lt;pattern&gt;]</b> <b>[-o]</b> <b>&lt;file&gt;</b> <b>[&lt;file&gt;...]</b>

           installs multiple files located on a library directory to the initramfs image.

           options:

           -n &lt;pattern&gt;
               install all library files matching a pattern.

           -o
               optional, a missing library does not lead to an error.

       <b>instmods</b> <b>[-c]</b> <b>[-s]</b> <b>&lt;kernelmodule&gt;</b> <b>[</b> <b>&lt;kernelmodule&gt;</b> <b>...</b> <b>]</b>

           instmods should be used only in the installkernel() function.

           instmods installs one or more kernel modules in the initramfs. &lt;kernelmodule&gt; can also be a whole
           subsystem, if prefixed with a "=", like "=drivers/net/team".

           instmods will not install the kernel module, if $hostonly is set and the kernel module is not
           currently needed by any <a href="file:/sys/">/sys/</a><b>...</b>/uevent MODALIAS. To install a kernel module regardless of the
           hostonly mode use the form:

               hostonly='' instmods &lt;kernelmodule&gt;

           options:

           -c
               check that kernel modules exists and can be installed (i.e., not optional).

           -s
               reduce verbosity.

   <b>Initramfs</b> <b>Functions</b>
       FIXME

   <b>Network</b> <b>Modules</b>
       FIXME

</pre><h4><b>AUTHOR</b></h4><pre>
       Harald Hoyer

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man8/dracut.8.html">dracut</a></b>(8)

dracut 107-1ubuntu5                                07/08/2025                                  <u><a href="../man7/DRACUT.MODULES.7.html">DRACUT.MODULES</a></u>(7)
</pre>
 </div>
</div></section>
</div>
</body>
</html>