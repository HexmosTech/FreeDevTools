<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>syncthing-versioning - Keep automatic backups of deleted files by other nodes</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/syncthing">syncthing_1.29.5~ds1-2_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       syncthing-versioning - Keep automatic backups of deleted files by other nodes

       Syncthing  supports  archiving  the  old  version  of  a file when it is deleted or replaced with a newer
       version from the cluster. This is called “file versioning” and  uses  one  of  the  available  <u>versioning</u>
       <u>strategies</u> described below. File versioning is configured per folder, on a per-device basis, and defaults
       to “no file versioning”, i.e. no old copies of files are kept.

       <b>NOTE:</b>
          Versioning  applies to changes received <u>from</u> <u>other</u> <u>devices</u>. That is, if Alice has versioning turned on
          and Bob changes a file, the old version will be archived on  Alice’s  computer  when  that  change  is
          synced  from  Bob.  If Alice changes a file locally on her own computer Syncthing will not and can not
          archive the old version.

       The applicable configuration options for each versioning strategy are described below.  For most of  them
       it’s  possible  to  specify  where the versions are stored, with the default being the <b>.stversions</b> folder
       inside the shared folder path.  If you set a custom version path, please ensure that  it’s  on  the  same
       partition or filesystem as the regular folder path, as moving files there may otherwise fail.

</pre><h4><b>TRASH</b> <b>CAN</b> <b>FILE</b> <b>VERSIONING</b></h4><pre>
       This versioning strategy emulates the common “trash can” approach. When a file is deleted or replaced due
       to  a  change  on a remote device, it is moved to the trash can in the <b>.stversions</b> folder. If a file with
       the same name was already in the trash can it is replaced.

       A <u>configuration</u> <u>option</u> is available to clean the trash can from files older than a  specified  number  of
       days.   If  this  is  set  to a positive number of days, files will be removed when they have been in the
       trash can that long.  Setting this to zero prevents any files from  being  removed  from  the  trash  can
       automatically.

</pre><h4><b>SIMPLE</b> <b>FILE</b> <b>VERSIONING</b></h4><pre>
       With  “Simple  File  Versioning”  files are moved to the <b>.stversions</b> folder when replaced or deleted on a
       remote device.  In addition to the <u>cleanoutDays</u> option, this strategy also takes  a  value  in  an  input
       titled  “Keep  Versions”  which  tells  Syncthing  how many old versions of the file it should <u>keep</u>.  For
       example, if you set this value to 5, if a file is replaced 5 times on a remote device,  you  will  see  5
       time-stamped  versions  on  that  file  in  the  <b>.stversions</b> folder on the other devices sharing the same
       folder.

</pre><h4><b>STAGGERED</b> <b>FILE</b> <b>VERSIONING</b></h4><pre>
       With “Staggered File Versioning” files are also moved to the <b>.stversions</b> folder when replaced or  deleted
       on  a  remote device (just like “Simple File Versioning”), however, versions are automatically deleted if
       they are older than the maximum age or exceed the number of files allowed in an interval.

       The following intervals are used and they each have a maximum number of files that will be kept for each.

       <b>1</b> <b>Hour</b> For the first hour, the oldest version in every 30-seconds interval is kept.

       <b>1</b> <b>Day</b>  For the first day, the oldest version in every hour is kept.

       <b>30</b> <b>Days</b>
              For the first 30 days, the oldest version in every day is kept.

       <b>Until</b> <b>Maximum</b> <b>Age</b>
              Until maximum age, the oldest version in every week is kept.

       <b>Maximum</b> <b>Age</b>
              The maximum time to keep a version in days. For example, to keep replaced or deleted files in  the
              <b>.stversions</b>  folder  for an entire year, use 365. If only for 10 days, use 10.  Corresponds to the
              <u>maxAge</u> option.  <b>Note:</b> <b>Set</b> <b>to</b> <b>0</b> <b>to</b> <b>keep</b> <b>versions</b> <b>forever.</b>

       This means that there is only one version in each interval and as files age they will be  deleted  unless
       when  the  interval  they  are  entering  is empty. By keeping the oldest versions this versioning scheme
       preserves the file if it is overwritten.

       For          more          info,          check          the           <u>unit</u>           <u>test</u>           <u>file</u>
       &lt;<b>https://github.com/syncthing/syncthing/blob/main/lib/versioner/staggered_test.go#L32</b>&gt;  that  shows which
       versions are deleted for a specific run.

</pre><h4><b>EXTERNAL</b> <b>FILE</b> <b>VERSIONING</b></h4><pre>
       This versioning strategy delegates the decision on what to do to an <u>external</u> <u>command</u> (e.g. a program or a
       command line script).  Just prior to a file being replaced, the command will be executed.  The file needs
       to be removed from the folder in the process, or otherwise Syncthing will report an error.   The  command
       can use the following templated arguments:

       <b>%FOLDER_PATH%</b>
              Path to the folder

       <b>%FILE_PATH%</b>
              Path to the file within the folder

       Note  that  the  former  expands  to  the path of the actual Syncthing folder, and the latter to the path
       inside that folder. For instance, if you use the default <b>Sync</b> folder in Windows, and the full path to the
       file  is  <b>C:\Users\User\Sync\Family</b>   <b>photos\IMG_2021-03-01.jpg</b>,   then   the   <b>%FOLDER_PATH%</b>   will   be
       <b>C:\Users\User\Sync</b>, and the <b>%FILE_PATH%</b> will be <b>Family</b> <b>photos\IMG_2021-03-01.jpg</b>.

   <b>Example</b> <b>for</b> <b>Unixes</b>
       Let’s  say  I want to keep the latest version of each file as they are replaced or removed; essentially I
       want  a  “trash  can”-like  behavior.  For  this,  I  create  the  following  script  and  store  it   as
       <b>/Users/jb/bin/onlylatest.sh</b> (i.e. the <b>bin</b> directory in my home directory):

          #!<a href="file:/bin/sh">/bin/sh</a>
          set -eu

          # Where I want my versions stored
          versionspath=<a href="file:~/.trashcan">~/.trashcan</a>

          # The parameters we get from Syncthing
          folderpath="$1"
          filepath="$2"

          # First ensure the dir where we need to store the file exists
          outpath=$(dirname "$versionspath/$filepath")
          mkdir -p "$outpath"
          # Then move the file there
          mv -f "$folderpath/$filepath" "$versionspath/$filepath"

       I must ensure that the script has execute permissions (<b>chmod</b> <b>755</b> <b>onlylatest.sh</b>), then configure Syncthing
       with command <b>/Users/jb/bin/onlylatest.sh</b> <b>%FOLDER_PATH%</b> <b>%FILE_PATH%</b>

       Let’s  assume  I  have  a  folder  “default”  in  <a href="file:~/Sync">~/Sync</a>,  and  that  within  that folder there is a file
       <b>docs/letter.txt</b> that is being replaced or deleted. The script will be called as if I ran  this  from  the
       command line:

          $ /Users/jb/bin/onlylatest.sh /Users/jb/Sync docs/letter.txt

       The  script  will  then  move the file in question to <b><a href="file:~/.trashcan/docs/letter.txt">~/.trashcan/docs/letter.txt</a></b>, replacing any previous
       version of that letter that may already have been there.

   <b>Examples</b> <b>for</b> <b>Windows</b>
   <b>Move</b> <b>to</b> <b>a</b> <b>given</b> <b>folder</b> <b>using</b> <b>the</b> <b>command</b> <b>prompt</b> <b>(CMD)</b>
       On Windows we can use a batch script to perform the same “trash can”-like behavior as mentioned above.  I
       created the following script and saved it as <b>C:\Users\mfrnd\Scripts\onlylatest.bat</b>.

          @echo off

          rem Enable UTF-8 encoding to deal with multilingual folder and file names
          chcp 65001

          rem We need command extensions for md to create intermediate folders in one go
          setlocal enableextensions

          rem Where I want my versions stored
          set "versions_path=%USERPROFILE%\.trashcan"

          rem The parameters we get from Syncthing, '~' removes quotes if any
          set "folder_path=%~1"
          set "file_path=%~2"

          rem First ensure the dir where we need to store the file exists
          for %%f in ("%versions_path%\%file_path%") do set "output_path=%%~dpf"
          if not exist "%output_path%" md "%output_path%" || exit /b

          rem Finally move the file, overwrite existing file if any
          move /y "%folder_path%\%file_path%" "%versions_path%\%file_path%"

       Finally,  I set <b>"C:\Users\mfrnd\Scripts\onlylatest.bat"</b> <b>"%FOLDER_PATH%"</b> <b>"%FILE_PATH%"</b> as the command name
       in Syncthing.

   <b>Move</b> <b>to</b> <b>the</b> <b>Recycle</b> <b>Bin</b> <b>using</b> <b>PowerShell</b>
       We can use PowerShell to send files directly to the Recycle Bin, which mimics the behaviour  of  deleting
       them  using  the  Windows  Explorer.   Firstly, create the following script and save it in your preferred
       location, e.g. <b>C:\Users\User\Scripts\SendToRecycleBin.ps1</b>.

          # PowerShell has no native method to recycle files, so we use Visual
          # Basic to perform the operation. If succeeded, we also include the
          # recycled file in the Syncthing's DEBUG output.
          Add-Type -AssemblyName Microsoft.VisualBasic
          [Microsoft.VisualBasic.FileIO.FileSystem]::DeleteFile($args,'OnlyErrorDialogs','SendToRecycleBin')
          if ($?) {
            Write-Output ("Recycled " + $args + ".")
          }

       Alternatively, the script can be expanded to send only deleted files to the Recycle Bin, and  permanently
       delete modified ones, which makes it more consistent with how the Explorer works.

          # PowerShell has no native method to recycle files, so we use Visual
          # Basic to perform the operation.
          Add-Type -AssemblyName Microsoft.VisualBasic

          # We need to test if a Syncthing .tmp file exists. If it does, we assume
          # a modification and delete the existing file. If if does not, we assume
          # a deletion and recycle the current file. If succeeded, we also include
          # the deleted/recycled file in the Syncthing's DEBUG output.
          if (Test-Path -LiteralPath ((Split-Path -Path $args) + "\~syncthing~" + (Split-Path -Path $args -Leaf) + ".tmp")) {
            [Microsoft.VisualBasic.FileIO.FileSystem]::DeleteFile($args,'OnlyErrorDialogs','DeletePermanently')
            if ($?) {
              Write-Output ("Deleted " + $args + ".")
            }
          } else {
            [Microsoft.VisualBasic.FileIO.FileSystem]::DeleteFile($args,'OnlyErrorDialogs','SendToRecycleBin')
            if ($?) {
              Write-Output ("Recycled " + $args + ".")
            }
          }

       Finally,  we  set  the  command  name  in  Syncthing  to  <b>powershell.exe</b>  <b>-ExecutionPolicy</b>  <b>Bypass</b>  <b>-File</b>
       <b>"C:\Users\User\Scripts\SendToRecycleBin.ps1"</b> <b>"%FOLDER_PATH%\%FILE_PATH%"</b>.

       The only caveat that you should be aware of is that if your Syncthing folder is  located  on  a  portable
       storage,  such  as  a  USB  stick,  or  if you have the Recycle Bin disabled, then the script will end up
       deleting all files permanently.

</pre><h4><b>CONFIGURATION</b> <b>PARAMETER</b> <b>REFERENCE</b></h4><pre>
       The versioning settings are grouped into their own section of each folder in the <u>configuration</u> <u>file</u>.  The
       following shows an example of such a section in the XML:

          &lt;folder id="..."&gt;
              &lt;versioning type="simple"&gt;
                  &lt;cleanupIntervalS&gt;3600&lt;/cleanupIntervalS&gt;
                  &lt;fsPath&gt;&lt;/fsPath&gt;
                  &lt;fsType&gt;basic&lt;/fsType&gt;
                  &lt;param key="cleanoutDays" val="0"&gt;&lt;/param&gt;
                  &lt;param key="keep" val="5"&gt;&lt;/param&gt;
              &lt;/versioning&gt;
          &lt;/folder&gt;

       <b>versioning.type</b>
              Selects one of the versioning strategies: <b>trashcan</b>, <b>simple</b>, <b>staggered</b>, <b>external</b> or leave empty  to
              disable versioning completely.

       <b>versioning.fsPath</b>
              Overrides  the  path  where  old  versions of files are stored and defaults to <b>.stversions</b> if left
              empty.  An absolute or relative path can be specified.  The latter is interpreted relative to  the
              shared  folder  path,  if  the <u>fsType</u> is configured as <b>basic</b>.  Ignored for the <b>external</b> versioning
              strategy.

              This option used to be stored under the keys <b>fsPath</b> or <b>versionsPath</b> in the <u>params</u> element.

       <b>versioning.fsType</b>
              The internal file system implementation used to access this  versions  folder.   Only  applies  if
              <u>fsPath</u>  is  also  set  non-empty,  otherwise  the  <u>filesystemType</u>  from the folder element is used
              instead.  Refer to that  option  description  for  possible  values.   Ignored  for  the  <b>external</b>
              versioning strategy.

              This option used to be stored under the key <b>fsType</b> in the <u>params</u> element.

       <b>versioning.cleanupIntervalS</b>
              The  interval,  in  seconds, for running cleanup in the versions folder.  Zero to disable periodic
              cleaning.  Limited to one year (31536000 seconds).  Ignored for the <b>external</b> versioning strategy.

              This option used to be stored under the key <b>cleanInterval</b> in the <u>params</u> element.

       <b>versioning.params</b>
              Each versioning strategy can have configuration parameters specific to  its  implementation  under
              this element.

       <b>versioning.params.cleanoutDays</b>
              The  number  of  days  to  keep  files in the versions folder.  Zero means to keep forever.  Older
              elements encountered during cleanup are removed.

       <b>versioning.params.keep</b>
              The number of old versions to keep, per file.

       <b>versioning.params.maxAge</b>
              The maximum time to keep a version, in seconds.  Zero means to keep forever.

       <b>versioning.params.command</b>
              External command to execute for storing a file version about to be replaced or  deleted.   If  the
              path to the application contains spaces, it should be quoted.

</pre><h4><b>AUTHOR</b></h4><pre>
       The Syncthing Authors

</pre><h4><b>COPYRIGHT</b></h4><pre>
       2014-2019, The Syncthing Authors

v1.29.3                                           Mar 19, 2025                           <u><a href="../man7/SYNCTHING-VERSIONING.7.html">SYNCTHING-VERSIONING</a></u>(7)
</pre>
 </div>
</div></section>
</div>
</body>
</html>