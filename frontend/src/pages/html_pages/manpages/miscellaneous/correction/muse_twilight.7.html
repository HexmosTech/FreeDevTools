<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>muse_twilight - Combine several twilight skyflats into one cube, compute correction factors for each IFU,</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/noble/+package/cpl-plugin-muse-doc">cpl-plugin-muse-doc_2.8.7+dfsg-3_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       muse_twilight - Combine several twilight skyflats into one cube, compute correction factors for each IFU,
       and create a smooth 3D illumination correction.

</pre><h4><b>SYNOPSIS</b></h4><pre>
       esorex <b>muse_twilight</b> [OPTIONS] FILE.sof

</pre><h4><b>DESCRIPTION</b></h4><pre>
       Processing  first handles each raw input image separately: it trims the raw data and records the overscan
       statistics, subtracts the bias (taking account of the overscan, if --overscan is  not  "none"),  converts
       the  images  from  adu  to  count,  subtracts  the  dark,  divides by the flat-field and combines all the
       exposures using input parameters. The input calibrations geometry  table,  trace  table,  and  wavelength
       calibration  table  are  used  to assign 3D coordinates to each CCD-based pixel, thereby creating a pixel
       table from the master sky-flat. These pixel tables are then cut in wavelength using the  --lambdamin  and
       --lambdamax  parameters.  The integrated flux in each IFU is computed as the sum of the data in the pixel
       table, and saved in the header, to be used later as estimate for the relative throughput of each IFU.  If
       an  ILLUM  exposure  was given as input, it is then used to correct the relative illumination between all
       slices of one IFU. For this, the data of each slice within the pixel table of each IFU is  multiplied  by
       the  normalized  median  flux  of that slice in the ILLUM exposure. The pixel tables of all IFUs are then
       merged, using the integrated fluxes as inverse scaling factors, and a  cube  is  reconstructed  from  the
       merged  dataset,  using given parameters. A white-light image is created from the cube. This skyflat cube
       is then saved to disk, with the white-light image as one extension. To construct a smooth 3D illumination
       correction, the cube is post-processed in the following way: the white-light image is used  to  create  a
       mask  of  the illuminated area. From this area, the optional vignetting mask is removed. The smoothing is
       then computed for each plane of the cube: the illuminated area is smoothed  (by  a  5x7  median  filter),
       normalized,  fit  with a 2D polynomial (of given polynomial orders), and normalized again. A smooth white
       image is then created by collapsing the smooth cube. If a vignetting  mask  was  given  or  NFM  data  is
       processed,  an  area  close  to  the  edge  of  the MUSE field is used to compute a 2D correction for the
       vignetted area: the original unsmoothed white-light image is  corrected  for  large  scale  gradients  by
       dividing  it with the smooth white image. The residuals in the edge area (as defined by the input mask or
       hardcoded for NFM) are then smoothed using input parameters. This smoothed vignetting correction  is  the
       multiplied  onto  each plane of the smooth cube, normalizing each plane again. This twilight cube is then
       saved to disk.

</pre><h4><b>OPTIONS</b></h4><pre>
       <b>--overscan</b> <u>&lt;str&gt;</u>
              If this is "none", stop when detecting discrepant overscan levels (see ovscsigma), for "offset" it
              assumes that the mean overscan level represents  the  real  offset  in  the  bias  levels  of  the
              exposures  involved,  and  adjusts  the  data accordingly; for "vpoly", a polynomial is fit to the
              vertical overscan and subtracted from the whole quadrant. (str; default: ´vpoly´). The  full  name
              of this option for the EsoRex configuration file is <b>muse.muse_twilight.overscan</b> [default = <u>vpoly</u>].

       <b>--ovscreject</b> <u>&lt;str&gt;</u>
              This influences how values are rejected when computing overscan statistics. Either no rejection at
              all  ("none"), rejection using the DCR algorithm ("dcr"), or rejection using an iterative constant
              fit ("fit"). (str; default: ´dcr´). The full name of this option for the EsoRex configuration file
              is <b>muse.muse_twilight.ovscreject</b> [default = <u>dcr</u>].

       <b>--ovscsigma</b> <u>&lt;float&gt;</u>
              If the deviation of mean overscan levels between a raw input image  and  the  reference  image  is
              higher  than  |ovscsigma x stdev|, stop the processing. If overscan="vpoly", this is used as sigma
              rejection level for the iterative polynomial fit (the level comparison  is  then  done  afterwards
              with  |100 x stdev| to guard against incompatible settings).  Has no effect for overscan="offset".
              (float; default: 30.0). The full name  of  this  option  for  the  EsoRex  configuration  file  is
              <b>muse.muse_twilight.ovscsigma</b> [default = <u>30.0</u>].

       <b>--ovscignore</b> <u>&lt;int&gt;</u>
              The number of pixels of the overscan adjacent to the data section of the CCD that are ignored when
              computing  statistics  or  fits.  (int;  default:  3). The full name of this option for the EsoRex
              configuration file is <b>muse.muse_twilight.ovscignore</b> [default = <u>3</u>].

       <b>--combine</b> <u>&lt;str&gt;</u>
              Type of combination to use (str; default: ´sigclip´). The full name of this option for the  EsoRex
              configuration file is <b>muse.muse_twilight.combine</b> [default = <u>sigclip</u>].

       <b>--nlow</b> <u>&lt;int&gt;</u>
              Number of minimum pixels to reject with minmax (int; default: 1). The full name of this option for
              the EsoRex configuration file is <b>muse.muse_twilight.nlow</b> [default = <u>1</u>].

       <b>--nhigh</b> <u>&lt;int&gt;</u>
              Number of maximum pixels to reject with minmax (int; default: 1). The full name of this option for
              the EsoRex configuration file is <b>muse.muse_twilight.nhigh</b> [default = <u>1</u>].

       <b>--nkeep</b> <u>&lt;int&gt;</u>
              Number  of  pixels  to  keep  with  minmax (int; default: 1). The full name of this option for the
              EsoRex configuration file is <b>muse.muse_twilight.nkeep</b> [default = <u>1</u>].

       <b>--lsigma</b> <u>&lt;float&gt;</u>
              Low sigma for pixel rejection with sigclip (float; default: 3.0). The full name of this option for
              the EsoRex configuration file is <b>muse.muse_twilight.lsigma</b> [default = <u>3.0</u>].

       <b>--hsigma</b> <u>&lt;float&gt;</u>
              High sigma for pixel rejection with sigclip (float; default: 3.0). The full name  of  this  option
              for the EsoRex configuration file is <b>muse.muse_twilight.hsigma</b> [default = <u>3.0</u>].

       <b>--scale</b> <u>&lt;bool&gt;</u>
              Scale  the  individual  images  to  a  common exposure time before combining them. (bool; default:
              False). The full name of this option for the EsoRex configuration file is <b>muse.muse_twilight.scale</b>
              [default = <u>False</u>].

       <b>--resample</b> <u>&lt;str&gt;</u>
              The resampling technique to use for the final output cube. (str;  default:  ´drizzle´).  The  full
              name  of  this  option for the EsoRex configuration file is <b>muse.muse_twilight.resample</b> [default =
              <u>drizzle</u>].

       <b>--crtype</b> <u>&lt;str&gt;</u>
              Type of statistics used for detection of cosmic rays during  final  resampling.  "iraf"  uses  the
              variance  information,  "mean" uses standard (mean/stdev) statistics, "median" uses median and the
              median median of the absolute median deviation. (str; default: ´median´). The full  name  of  this
              option for the EsoRex configuration file is <b>muse.muse_twilight.crtype</b> [default = <u>median</u>].

       <b>--crsigma</b> <u>&lt;float&gt;</u>
              Sigma rejection factor to use for cosmic ray rejection during final resampling. A zero or negative
              value  switches cosmic ray rejection off. (float; default: 50.0). The full name of this option for
              the EsoRex configuration file is <b>muse.muse_twilight.crsigma</b> [default = <u>50.0</u>].

       <b>--lambdamin</b> <u>&lt;float&gt;</u>
              Minimum wavelength for twilight reconstruction. (float; default: 5000.0). The full  name  of  this
              option for the EsoRex configuration file is <b>muse.muse_twilight.lambdamin</b> [default = <u>5000.0</u>].

       <b>--lambdamax</b> <u>&lt;float&gt;</u>
              Maximum  wavelength  for  twilight reconstruction. (float; default: 9000.0). The full name of this
              option for the EsoRex configuration file is <b>muse.muse_twilight.lambdamax</b> [default = <u>9000.0</u>].

       <b>--dlambda</b> <u>&lt;float&gt;</u>
              Sampling for twilight reconstruction, this should result in planes of equal  wavelength  coverage.
              (float;  default:  250.0).  The  full  name  of  this  option for the EsoRex configuration file is
              <b>muse.muse_twilight.dlambda</b> [default = <u>250.0</u>].

       <b>--xorder</b> <u>&lt;int&gt;</u>
              Polynomial order to use in x direction to fit the full field of view.  (int; default: 2). The full
              name of this option for the EsoRex configuration file is <b>muse.muse_twilight.xorder</b> [default = <u>2</u>].

       <b>--yorder</b> <u>&lt;int&gt;</u>
              Polynomial order to use in y direction to fit the full field of view.  (int; default: 2). The full
              name of this option for the EsoRex configuration file is <b>muse.muse_twilight.yorder</b> [default = <u>2</u>].

       <b>--vignmaskedges</b> <u>&lt;float&gt;</u>
              Pixels on edges stronger than this fraction in the normalized image are excluded from the  fit  to
              the  vignetted area. Set to non-positive number to include them in the fit. This has no effect for
              NFM skyflats. (float; default: 0.02). The full name of this option for  the  EsoRex  configuration
              file is <b>muse.muse_twilight.vignmaskedges</b> [default = <u>0.02</u>].

       <b>--vignsmooth</b> <u>&lt;str&gt;</u>
              Type  of  smoothing  to use for the vignetted region given by the VIGNETTING_MASK (for WFM, or the
              internal mask, for NFM); gaussian uses (vignxpar + vignypar)/2 as FWHM. (str; default: ´polyfit´).
              The full name of this option for the EsoRex configuration  file  is  <b>muse.muse_twilight.vignsmooth</b>
              [default = <u>polyfit</u>].

       <b>--vignxpar</b> <u>&lt;int&gt;</u>
              Parameter  used  by  the  vignetting  smoothing:  x  order  for  polyfit (default, recommended 4),
              parameter that influences the FWHM for the gaussian (recommended: 10), or x  dimension  of  median
              filter  (recommended  5). If a negative value is found, the default is taken.  (int; default: -1).
              The full name of this option for the  EsoRex  configuration  file  is  <b>muse.muse_twilight.vignxpar</b>
              [default = <u>-1</u>].

       <b>--vignypar</b> <u>&lt;int&gt;</u>
              Parameter  used  by  the  vignetting  smoothing:  y  order  for  polyfit (default, recommended 4),
              parameter that influences the FWHM for the gaussian (recommended: 10), or y  dimension  of  median
              filter  (recommended  5). If a negative value is found, the default is taken.  (int; default: -1).
              The full name of this option for the  EsoRex  configuration  file  is  <b>muse.muse_twilight.vignypar</b>
              [default = <u>-1</u>].

       <b>--vignnfmmask</b> <u>&lt;int&gt;</u>
              The height of the vignetted region at the top of the MUSE field in NFM. This is the region modeled
              separately  (the  final  vignetting  model might be smaller). (int; default: 22). The full name of
              this option for the EsoRex configuration file is <b>muse.muse_twilight.vignnfmmask</b> [default = <u>22</u>].

       Note that it is possible to create a configuration file containing these  options,  along  with  suitable
       default values. Please refer to the details provided by the 'esorex --help' command.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       The full documentation for the muse pipeline can be downloaded as a PDF file using the following URL:

              <b><a href="ftp://ftp.eso.org/pub/dfs/pipelines/muse/muse-pipeline-cookbook-2.8.7.pdf">ftp://ftp.eso.org/pub/dfs/pipelines/muse/muse-pipeline-cookbook-2.8.7.pdf</a></b>

       An    overview    over    the    existing    ESO    pipelines    can   be   found   on   the   web   page
       <b>https://www.eso.org/sci/software/pipelines/</b>.

       Basic documentation about the EsoRex program can be found at the esorex (1) man page.

       It  is  possible  to  call   the   pipelines   from   python   using   the   python-cpl   package.    See
       <b>https://packages.python.org/python-cpl/index.html</b> for further information.

       The   other   recipes   of   the   muse  pipeline  are  <u><a href="../man7/muse_ampl.7.html">muse_ampl</a></u>(7),  <u><a href="../man7/muse_astrometry.7.html">muse_astrometry</a></u>(7),  <u><a href="../man7/muse_bias.7.html">muse_bias</a></u>(7),
       <u><a href="../man7/muse_create_sky.7.html">muse_create_sky</a></u>(7), <u><a href="../man7/muse_dark.7.html">muse_dark</a></u>(7), <u><a href="../man7/muse_exp_align.7.html">muse_exp_align</a></u>(7), <u><a href="../man7/muse_exp_combine.7.html">muse_exp_combine</a></u>(7), <u><a href="../man7/muse_flat.7.html">muse_flat</a></u>(7), <u><a href="../man7/muse_geometry.7.html">muse_geometry</a></u>(7),
       <u><a href="../man7/muse_illum.7.html">muse_illum</a></u>(7),  <u><a href="../man7/muse_lingain.7.html">muse_lingain</a></u>(7),   <u><a href="../man7/muse_lsf.7.html">muse_lsf</a></u>(7),   <u><a href="../man7/muse_qi_mask.7.html">muse_qi_mask</a></u>(7),   <u><a href="../man7/muse_scibasic.7.html">muse_scibasic</a></u>(7),   <u><a href="../man7/muse_scipost.7.html">muse_scipost</a></u>(7),
       <u><a href="../man7/muse_scipost_apply_astrometry.7.html">muse_scipost_apply_astrometry</a></u>(7),    <u><a href="../man7/muse_scipost_calibrate_flux.7.html">muse_scipost_calibrate_flux</a></u>(7),   <u><a href="../man7/muse_scipost_combine_pixtables.7.html">muse_scipost_combine_pixtables</a></u>(7),
       <u><a href="../man7/muse_scipost_correct_dar.7.html">muse_scipost_correct_dar</a></u>(7),            <u><a href="../man7/muse_scipost_correct_rv.7.html">muse_scipost_correct_rv</a></u>(7),            <u><a href="../man7/muse_scipost_make_cube.7.html">muse_scipost_make_cube</a></u>(7),
       <u><a href="../man7/muse_scipost_raman.7.html">muse_scipost_raman</a></u>(7),         <u><a href="../man7/muse_scipost_subtract_sky.7.html">muse_scipost_subtract_sky</a></u>(7),         <u><a href="../man7/muse_scipost_subtract_sky_simple.7.html">muse_scipost_subtract_sky_simple</a></u>(7),
       <u><a href="../man7/muse_standard.7.html">muse_standard</a></u>(7), <u><a href="../man7/muse_wavecal.7.html">muse_wavecal</a></u>(7)

</pre><h4><b>VERSION</b></h4><pre>
       muse_twilight 2.8.7

</pre><h4><b>AUTHOR</b></h4><pre>
       Peter Weilbacher &lt;https://support.eso.org&gt;

</pre><h4><b>BUG</b> <b>REPORTS</b></h4><pre>
       Please report any problems to https://support.eso.org. Alternatively, you may send a report  to  the  ESO
       User Support Department &lt;<a href="mailto:usd-help@eso.org">usd-help@eso.org</a>&gt;.

</pre><h4><b>LICENSE</b></h4><pre>
       This file is part of the MUSE Instrument Pipeline Copyright (C) 2005, 2019 European Southern Observatory

       This  program  is  free  software;  you  can  redistribute it and/or modify it under the terms of the GNU
       General Public License as published by the Free Software Foundation; either version 2 of the License,  or
       (at your option) any later version.

       This  program  is  distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even
       the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General  Public
       License for more details.

       You  should have received a copy of the GNU General Public License along with this program; if not, write
       to the Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02111-1307  USA

muse_twilight                                         2.8.7                                     <u><a href="../man7/MUSE_TWILIGHT.7.html">MUSE_TWILIGHT</a></u>(7)
</pre>
 </div>
</div></section>
</div>
</body>
</html>