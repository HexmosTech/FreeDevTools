<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ubuntu-image - Generate a bootable disk image</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/jammy/+package/ubuntu-image">ubuntu-image_2.2+22.04ubuntu3.22.04.2_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       ubuntu-image - Generate a bootable disk image

</pre><h4><b>SYNOPSIS</b></h4><pre>
       ubuntu-image snap [options] model.assertion

       ubuntu-image classic [options] GADGET_TREE_URI

</pre><h4><b>DESCRIPTION</b></h4><pre>
       <b>ubuntu-image</b>  is  a  program  for  generating  a  variety of bootable disk images.  It currently supports
       building <u>snap</u> based and classic preinstalled Ubuntu images.

       Snap-based images are built from a <u>model</u>  <u>assertion</u>,  which  is  a  <u>YAML</u>  file  describing  a  particular
       combination  of  core,  kernel,  and  gadget  snaps, along with other declarations, signed with a digital
       signature asserting its authenticity.  The assets defined in the model assertion  uniquely  describe  the
       device for which the image is built.

       As part of the model assertion, a <u>gadget</u> <u>snap</u> is specified.  The gadget contains a <u>gadget.yaml</u> file which
       contains  the  exact  description  of  the  disk  image's contents, in YAML format.  The <b>gadget.yaml</b> file
       describes such things as the names of all the volumes to be produced [1], the structures [2]  within  the
       volume, whether the volume contains a bootloader and if so what kind of bootloader, etc.

       Note  that  <b>ubuntu-image</b>  communicates  with the snap store using the <b>snap</b> <b>prepare-image</b> subcommand.  The
       model assertion file is passed to <b>snap</b> <b>prepare-image</b> which handles downloading the appropriate gadget and
       any extra snaps.  See that command's documentation for additional details.

       Classic images are built from a local <u>gadget</u> <u>tree</u> path.  The <u>gadget</u> <u>tree</u> is nothing more  than  a  primed
       <u>gadget</u>  <u>snap</u>, containing a <u>gadget.yaml</u> file in the meta directory and all the necessary bootloader gadget
       bits built.  For instance a <u>gadget</u> <u>tree</u> can be easily prepared by fetching a  specially  tailored  <u>gadget</u>
       <u>snap</u> source and running <b>snapcraft</b> <b>prime</b> on it, with the resulting tree ending up in the <b>prime/</b> directory.

       The  actual rootfs for a classic image is created by <b>live-build</b> with arguments passed as per the optional
       arguments to <b>ubuntu-image</b>.  The <b>livecd-rootfs</b> configuration from the host system is used.

</pre><h4><b>OPTIONS</b></h4><pre>
       <b>-h</b>, <b>--help</b>
              Show the program's message and exit.

       <b>--version</b>
              Show the program's version number and exit.

   <b>Snap</b> <b>command</b> <b>options</b>
       These are the options for defining the contents  of  snap-based  images.   Can  only  be  used  when  the
       <b>ubuntu-image</b> <b>snap</b> command is used.

       <b>model_assertion</b>
              Path  to  the  model  assertion  file.   This  positional  argument must be given for this mode of
              operation.

       <b>--cloud-init</b> <u>USER-DATA-FILE</u>
              <b>cloud-config</b> data to be copied to the image.

       <b>--disable-console-conf</b>
              Disable console-conf on the resulting image.

       <b>--factory-image</b>
              Hint that the image is meant to boot in a device factory.

       <b>--validation=</b><u>&lt;ignore|enforce&gt;</u>
              Control whether validations should be ignored or enforced.

   <b>Classic</b> <b>command</b> <b>options</b>
       These are the options for defining the contents of classic preinstalled Ubuntu images.  Can only be  used
       when the <b>ubuntu-image</b> <b>classic</b> command is used.

       <b>GADGET_TREE_URI</b>
              An  URI  to the gadget tree to be used to build the image.  This positional argument must be given
              for this mode of operation.  Must be a local path.

       <b>-p</b> <u>PROJECT</u>, <b>--project</b> <u>PROJECT</u>
              Project name to be passed on to <b>livecd-rootfs</b>. Mutually exclusive with --filesystem

       <b>-f</b> <u>FILESYSTEM</u>, <b>--filesystem</b> <u>FILESYSTEM</u>
              Unpacked Ubuntu filesystem to  be  copied  to  the  system  partition.   Mutually  exclusive  with
              --project.

       <b>-s</b> <u>SUITE</u>, <b>--suite</b> <u>SUITE</u>
              Distribution name to be passed on to <b>livecd-rootfs</b>.

       <b>-a</b> <u>CPU-ARCHITECTURE</u>, <b>--arch</b> <u>CPU-ARCHITECTURE</u>
              CPU architecture to be passed on to <b>livecd-rootfs</b>.  Default value is the architecture of the host.

       <b>--subproject</b> <u>SUBPROJECT</u>
              Sub-project name to be passed on <b>livecd-rootfs</b>.

       <b>--subarch</b> <u>SUBARCH</u>
              Sub-architecture to be passed on to <b>livecd-rootfs</b>.

       <b>--with-proposed</b>
              Defines  if  the  image  should  be  built  with  -proposed  enabled.   This  is passed through to
              <b>livecd-rootfs</b>.

       <b>--extra-ppas</b> <u>EXTRA_PPAS</u>
              Extra ppas to install. This is passed through to <b>livecd-rootfs</b>.

   <b>Common</b> <b>options</b>
       There are two general operational modes to <b>ubuntu-image</b>.  The usual mode is to run the script giving  the
       required  model  assertion  file  as a required positional argument, generating a disk image file.  These
       options are useful in this mode of operation.

       The second mode of operation is provided for debugging and testing purposes.  It allows you  to  run  the
       internal state machine step by step, and is described in more detail below.

       <b>-d</b>, <b>--debug</b>
              Enable debugging output.

       <b>-O</b> <u>DIRECTORY</u>, <b>--output-dir</b> <u>DIRECTORY</u>
              Write generated disk image files to this directory.  The files will be named after the <b>gadget.yaml</b>
              volume  names,  with  <b>.img</b>  suffix appended.  If not given, the current working directory is used.
              This option replaces, and cannot be used with, the deprecated <b>--output</b> option.

       <b>-i</b> <u>SIZE</u>, <b>--image-size</b> <u>SIZE</u>
              The size of the generated disk image files.  If this size is smaller than the  minimum  calculated
              size  of  the volume, a warning will be issued and <b>--image-size</b> will be ignored.  The value is the
              size in bytes, with allowable suffixes 'M' for MiB and 'G' for GiB.

              An extended syntax is supported for gadget.yaml files which specify multiple  volumes  (i.e.  disk
              images).   In that case, a single <b>SIZE</b> argument will be used for all the defined volumes, with the
              same rules for ignoring values which are too small.  You can specify the image size for  a  single
              volume  using an indexing prefix on the <b>SIZE</b> parameter, where the index is either a volume name or
              an integer index starting at zero.  For example, to set the image size only on the second  volume,
              which  might  be called <b>sdcard</b> in the gadget.yaml, you could use: <b>--image-size</b> <b>1:8G</b> since the 1-th
              index names the second volume (volumes are 0-indexed).  Or you could use <b>--image-size</b> <b>sdcard:8G</b>.

              You can also specify multiple volume sizes by separating them with commas, and  you  can  mix  and
              match  integer indexes and volume name indexes.  Thus, if the gadget.yaml named three volumes, and
              you wanted to set all three to different sizes, you could use <b>--image-size</b> <b>0:2G,sdcard:8G,eMMC:4G</b>.

              In the case of ambiguities, the size hint is ignored and the calculated size for the  volume  will
              be used instead.

       <b>--image-file-list</b> <u>FILENAME</u>
              Print  to <b>FILENAME</b>, a list of the file system paths to all the disk images created by the command,
              if any.

       <b>--hooks-directory</b> <u>DIRECTORY</u>
              Directories in which scripts for build-time hooks will be located. This  flag  must  be  specified
              once     for     each     hook    directory.    <b>ubuntu-image</b>    will    look    for    hooks    in
              <b>hooks_directory/name_of_hooks_step.d</b>      and       a       script       with       the       name
              <b>hooks_directory/name_of_hooks_step</b>.    Currently    the    only    supported    hooks    step   is
              <b>populate_rootfs_contents</b>.

       <b>--disk-info</b> <u>DISK-INFO-CONTENTS</u>
              File to be used as .disk/info on the image's rootfs.  This file  can  contain  useful  information
              about the target image, like image identification data, system name, build timestamp etc.

       <b>--snap</b> <u>SNAP</u>
              Install  an  extra  snap.   This  is  passed through to <b>snap</b> <b>prepare-image</b>.  The snap argument can
              include  additional  information  about  the  channel  and/or  risk  with  the  following  syntax:
              <b>&lt;snap&gt;=&lt;channel|risk&gt;</b>

       <b>-c</b> <u>CHANNEL</u>, <b>--channel</b> <u>CHANNEL</u>
              The snap channel to use.

       <b>--sector-size</b> <u>SIZE</u>
              When  creating the disk image file, use the given sector size.  This can be either 512 or 4096 (4k
              sector size), defaulting to 512.

   <b>State</b> <b>machine</b> <b>options</b>
       <b>CAUTION!:</b>
          The options described here are primarily  for  debugging  and  testing  purposes  and  should  not  be
          considered  part  of  the stable, public API.  State machine step numbers and names can change between
          releases.

       <b>ubuntu-image</b> internally runs a state machine to create the  disk  image.   These  are  some  options  for
       controlling  this  state  machine.   Other  than  <b>--workdir</b>,  these options are mutually exclusive.  When
       <b>--until</b> or <b>--thru</b> is given, the state machine can be resumed later with <b>--resume</b>, but <b>--workdir</b>  must  be
       given in that case since the state is saved in a <b>.ubuntu-image.pck</b> file in the working directory.

       <b>-w</b> <u>DIRECTORY</u>, <b>--workdir</b> <u>DIRECTORY</u>
              The  working  directory  in which to download and unpack all the source files for the image.  This
              directory can exist or not, and it is not removed after this  program  exits.   If  not  given,  a
              temporary  working  directory  is  used  instead,  which <u>is</u> deleted after this program exits.  Use
              <b>--workdir</b> if you want to be able to resume a partial state machine run.  As an  added  bonus,  the
              <b>gadget.yaml</b> file is copied to the working directory after it's downloaded.

       <b>-u</b> <u>STEP</u>, <b>--until</b> <u>STEP</u>
              Run  the state machine until the given <b>STEP</b>, non-inclusively.  <b>STEP</b> is the name of a state machine
              method. The list of all steps can be found in the STEPS section of this document.

       <b>-t</b> <u>STEP</u>, <b>--thru</b> <u>STEP</u>
              Run the state machine through the given <b>STEP</b>, inclusively.  <b>STEP</b> is the name of  a  state  machine
              method. The list of all steps can be found in the STEPS section of this document.

       <b>-r</b>, <b>--resume</b>
              Continue  the  state  machine  from  the  previously  saved  state.  It is an error if there is no
              previous state.

</pre><h4><b>FILES</b></h4><pre>
       <b>gadget.yaml</b>
              <u>https://github.com/snapcore/snapd/wiki/Gadget-snap#gadget.yaml</u>

       <b>model</b> <b>assertion</b>
              <u>https://developer.ubuntu.com/en/snappy/guides/prepare-image/</u>

       <b>gadget</b> <b>tree</b> <b>(example)</b>
              <u>https://github.com/snapcore/pc-amd64-gadget</u>

       <b>cloud-config</b>
              <u>https://help.ubuntu.com/community/CloudInit</u>

</pre><h4><b>ENVIRONMENT</b></h4><pre>
       The following environment variables are recognized by <b>ubuntu-image</b>.

       <b>UBUNTU_IMAGE_PRESERVE_UNPACK</b>
              When set, this names a directory for preserving a pristine copy of the unpacked  gadget  contents.
              The  directory must exist, and an <b>unpack</b> directory will be created under this directory.  The full
              contents of the <b>&lt;workdir&gt;/unpack</b> directory after the <b>snap</b> <b>prepare-image</b> subcommand has run will be
              copied here.

       <b>UBUNTU_IMAGE_LIVECD_ROOTFS_AUTO_PATH</b>
              <b>ubuntu-image</b> uses <b>livecd-rootfs</b> configuration files for its <b>live-build</b> runs.  If this variable  is
              set,  <b>ubuntu-image</b>  will  use  the  configuration  files  from  the  selected  path  for  its auto
              configuration.  Otherwise it will attempt to localize <b>livecd-rootfs</b> through a call to <b>dpkg</b>.

       <b>UBUNTU_IMAGE_QEMU_USER_STATIC_PATH</b>
              In case of classic image cross-compilation for a different architecture, <b>ubuntu-image</b> will attempt
              to use the qemu-user-static emulator with <b>live-build</b>.  If set, <b>ubuntu-image</b> will use the  selected
              path  for  the cross-compilation.  Otherwise it will attempt to find a matching emulator binary in
              the current <b>$PATH</b>.

       There are a few other environment variables used for building and testing only.

</pre><h4><b>HOOKS</b></h4><pre>
       During image build at certain stages of the build process the user can execute custom  scripts  modifying
       its  contents or otherwise affecting the process itself.  Whenever a hook is to be fired, the directories
       as listed in the <b>--hooks-directory</b> parameter are scanned for matching scripts.   There  can  be  multiple
       scripts  for  a  specific  hook  defined.   The  <b>HookManager</b>  will  first  look  for  executable files in
       <b>&lt;hookdir&gt;/&lt;name-of-the-hook&gt;.d</b>  and   execute   them   in   an   alphanumerical   order.    Finally   the
       <b>&lt;hookdir&gt;/&lt;name-of-the-hook&gt;</b> file is executed if existing.

       Hook scripts can have various additional data passed onto them through environment variables depending on
       the hook being fired.

       Currently supported hooks:

       <b>post-populate-rootfs</b>
              Executed  after  the  rootfs  directory  has  been  populated, allowing custom modification of its
              contents.  Added in version 1.2.  Environment variables present:

                 <b>UBUNTU_IMAGE_HOOK_ROOTFS</b>
                        Includes the absolute path to the rootfs contents.

</pre><h4><b>STEPS</b></h4><pre>
       The names of steps that can be used with --until and --thru for each image type are listed below

   <b>Classic</b> <b>image</b> <b>steps</b>
       1.  make_temporary_directories

       2.  prepare_gadget_tree

       3.  run_live_build

       4.  load_gadget_yaml

       5.  populate_rootfs_contents

       6.  populate_rootfs_contents_hooks

       7.  generate_disk_info

       8.  calculate_rootfs_size

       9.  populate_bootfs_contents

       10. populate_prepare_partitions

       11. make_disk

       12. generate_manifest

       13. finish

   <b>Snap</b> <b>image</b> <b>steps</b>
       1.  make_temporary_directories

       2.  prepare_image

       3.  load_gadget_yaml

       4.  populate_rootfs_contents

       5.  populate_rootfs_contents_hooks

       6.  generate_disk_info

       7.  calculate_rootfs_size

       8.  populate_bootfs_contents

       9.  populate_prepare_partitions

       10. make_disk

       11. generate_manifest

       12. finish

</pre><h4><b>NOTES</b></h4><pre>
       Sometimes, for various reasons, <b>ubuntu-image</b> may perform specific workarounds  that  might  require  some
       explanation to understand the reasoning behind them.

   <b>Classic</b> <b>swapfile</b> <b>manual</b> <b>unsparsing</b>
       When  building  a  classic  image,  if  <b>ubuntu-image</b>  notices the existence of a <b>/swapfile</b> on the image's
       rootfs, it will proactively attempt to unsparse it.  The reason for that  is  that  <b>ubuntu-image</b>  assumes
       that the <b>/swapfile</b> file will be used as a swapfile on the target system, and due to undocumented behavior
       of  <b>mkfs.ext4</b>  <b>-d</b>  large  empty  files  are  converted  into sparse files automatically during filesystem
       population.  This essentially makes such files unusable as swapfiles.  So just in case, <b>ubuntu-image</b> does
       an in-place <b>dd</b> call of the hard-coded path swapfile to ensure it's no longer sparse.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <a href="../man1/snap.1.html">snap</a>(1)

</pre><h4><b>FOOTNOTES</b></h4><pre>
       [1]  Volumes are roughly analogous to disk images.

       [2]  Structures define the layout of the volume, including partitions, Master Boot Records, or any  other
            relevant content.

</pre><h4><b>AUTHOR</b></h4><pre>
       Barry  Warsaw  &lt;<a href="mailto:barry@ubuntu.com">barry@ubuntu.com</a>&gt;,  ≈Åukasz  'sil2100'  Zemczak &lt;<a href="mailto:lukasz.zemczak@ubuntu.com">lukasz.zemczak@ubuntu.com</a>&gt; William 'jawn-
       smith' Wilson &lt;<a href="mailto:william.wilson@canonical.com">william.wilson@canonical.com</a>&gt;

</pre><h4><b>COPYRIGHT</b></h4><pre>
       2016-2021 Canonical Ltd.

2.0                                                2021-10-21                                    <u><a href="../man1/UBUNTU-IMAGE.1.html">UBUNTU-IMAGE</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>