<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>p2v-hacking - extending and contributing to virt-p2v</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/virt-p2v">virt-p2v_1.42.4-1_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       p2v-hacking - extending and contributing to virt-p2v

</pre><h4><b>DESCRIPTION</b></h4><pre>
       This manual page is for hackers who want to extend virt-p2v itself.

       Virt-p2v is a front end on virt-v2v.  ie. All it does is act as a GUI front end, and it calls out to
       virt-v2v to perform the actual conversion.  Therefore most of the C code is Gtk (GUI) code, or supporting
       code for talking to the remote conversion server.  There is no special support for physical machines in
       virt-v2v.  They are converted in the same way as foreign VMs.

</pre><h4><b>THE</b> <b>SOURCE</b> <b>CODE</b></h4><pre>
       Virt-p2v source is located in the github repository https://github.com/libguestfs/virt-p2v

       Virt-p2v uses an autotools-based build system, with the main files being <u>configure.ac</u> and <u>Makefile.am</u>.
       See "THE BUILD SYSTEM".

       To build from source, first read the <b><a href="../man1/p2v-building.1.html">p2v-building</a></b>(1).

   <b>SOURCE</b> <b>CODE</b> <b>SUBDIRECTORIES</b>
       The majority of the source code is directly in the top level directory of the sources.  There are also
       some subdirectories that contain some specific sub-parts of virt-p2v.

       <u>bash</u>
           Bash tab-completion scripts.

       <u>build-aux</u>
           Various build scripts used by autotools.

       <u>miniexpect</u>
           A copy of the miniexpect library from <a href="http://git.annexia.org/">http://git.annexia.org/</a>?p=miniexpect.git;a=summary.

       <u>contrib</u>
           Outside contributions, experimental parts.

       <u>docs</u>
           Miscellaneous manual pages.

       <u>libguestfs</u>
           Some  sources  (mostly with utilities) copied from libguestfs.  Changes to the sources there ought to
           be forwarded to libguestfs as well.

       <u>m4</u>  M4 macros used by autoconf.  See "THE BUILD SYSTEM".

       <u>website</u>
           The virt-p2v files of the <a href="http://libguestfs.org">http://libguestfs.org</a> website.

   <b>THE</b> <b>BUILD</b> <b>SYSTEM</b>
       Virt-p2v uses the GNU autotools build system (autoconf, automake).

       The <u>./configure</u> script is generated from <u>configure.ac</u> and <u>m4/p2v-*.m4</u>.  Most of the configure  script  is
       split  over  many  m4  macro  files  by  topic,  for example <u>m4/p2v-libraries.m4</u> deals with the libraries
       required by virt-p2v.

       <u>subdir-rules.mk</u> is included in every <u>Makefile.am</u> (top level and subdirectories).

   <b>UNDERSTANDING</b> <b>THE</b> <b>CODE</b>
       <u>See</u> <u>also:</u> "HOW VIRT-P2V WORKS" in <b><a href="../man1/virt-p2v.1.html">virt-p2v</a></b>(1)

       There are two paths through the code, GUI or non-GUI (parsing the kernel command line):

        main.c ──────┬─────▶ gui.c ──────┬─────▶ conversion.c
                     │                   │
                     │                   │
                     └────▶ kernel.c ────┘

       but both paths call back to the <u>conversion.c</u> function "start_conversion" to run the remote virt-v2v.

       The main task of <u>gui.c</u>/<u>kernel.c</u> is to populate the virt-v2v configuration (<u>config.c</u>).

       During conversion, we need to establish ssh connections, and that is done using two libraries:

        conversion.c ──────▶ ssh.c ──────▶ miniexpect.c

       where <u>ssh.c</u> is responsible for managing ssh connections overall,  and  <u>miniexpect.c</u>  implements  "expect-
       like" functionality for talking interactively to the remote virt-v2v conversion server.

       (Note  that  miniexpect  is  a separate library with its own upstream, so if you patch miniexpect.c, then
       please    make    sure    the    changes    get    reflected    in     miniexpect’s     upstream     too:
       <u><a href="http://git.annexia.org/">http://git.annexia.org/</a>?p=miniexpect.git;a=summary</u>)

</pre><h4><b>RUNNING</b> <b>VIRT-P2V</b></h4><pre>
       You  can  run the <u>virt-p2v</u> binary directly, but it will try to convert your machine’s real <u>/dev/sda</u> which
       is unlikely to work well.  However virt-p2v also has a test mode in which you can supply a test disk:

        make run-virt-p2v-directly

       This is a wrapper around the <b><a href="../man1/virt-p2v.1.html">virt-p2v</a></b>(1) <u>--test-disk</u> option.  You can control the "physical machine" disk
       by setting "PHYSICAL_MACHINE" to point to a disk image.

       A more realistic test is to run virt-p2v inside a VM on the local machine.  To do that, do:

        make run-virt-p2v-in-a-vm
        make run-virt-p2v-in-an-nvme-vm

       These also run qemu with the "physical machine" disk (which you can set by setting "PHYSICAL_MACHINE"), a
       virtual CD, and a variety of network cards for testing.  The second target exposes the "physical machine"
       disk as an NVMe controller, plus adds two blank disks as distinct namespaces of another NVMe  controller.
       You  can change the qemu binary and add extra qemu options by setting "QEMU" and/or "QEMU_OPTIONS" on the
       make commandline.

       A third way to run virt-p2v simulates fairly accurately the program being downloaded over  PXE  and  then
       doing  an  automatic  conversion  of  the  source  physical machine (the non-GUI path -- see next section
       below):

        make run-virt-p2v-non-gui-conversion

</pre><h4><b>EXTENDING</b> <b>VIRT-P2V</b></h4><pre>
   <b>FORMATTING</b> <b>CODE</b>
       Our C source code generally adheres to some basic code-formatting conventions.  The existing code base is
       not totally consistent on this front, but we do prefer that contributed code be formatted similarly.   In
       short, use spaces-not-TABs for indentation, use 2 spaces for each indentation level, and other than that,
       follow the K&amp;R style.

       If  you  use Emacs, add the following to one of your start-up files (e.g., <a href="file:~/.emacs">~/.emacs</a>), to help ensure that
       you get indentation right:

        ;;; In virt-p2v, indent with spaces everywhere (not TABs).
        ;;; Exceptions: Makefile and ChangeLog modes.
        (add-hook 'find-file-hook
            '(lambda () (if (and buffer-file-name
                                 (string-match "/virt-p2v\\&gt;"
                                     (buffer-file-name))
                                 (not (string-equal mode-name "Change Log"))
                                 (not (string-equal mode-name "Makefile")))
                            (setq indent-tabs-mode nil))))

        ;;; When editing C sources in virt-p2v, use this style.
        (defun virt-p2v-c-mode ()
          "C mode with adjusted defaults for use with virt-p2v."
          (interactive)
          (c-set-style "K&amp;R")
          (setq c-indent-level 2)
          (setq c-basic-offset 2))
        (add-hook 'c-mode-hook
                  '(lambda () (if (string-match "/virt-p2v\\&gt;"
                                      (buffer-file-name))
                                  (virt-p2v-c-mode))))

   <b>TESTING</b> <b>YOUR</b> <b>CHANGES</b>
       Turn warnings into errors when developing to make warnings hard to ignore:

        ./configure --enable-werror

       Useful targets are:

       "make check"
           Runs the regular test suite.

           This is implemented using the regular automake "TESTS" target.  See the  automake  documentation  for
           details.

       "make check-valgrind"
           Runs a subset of the test suite under valgrind.

       "make check-slow"
           Runs some slow/long-running tests which are not run by default.

           To mark a test as slow/long-running:

           •   Add it to the list of "TESTS" in the <u>Makefile.am</u>, just like a normal test.

           •   Modify the test so it checks if the "SLOW=1" environment variable is set, and if <u>not</u> set it skips
               (ie. returns with exit code 77).  If using $TEST_FUNCTIONS, you can call the function "slow_test"
               for this.

           •   Add a variable "SLOW_TESTS" to the <u>Makefile.am</u> listing the slow tests.

           •   Add a rule to the <u>Makefile.am</u>:

                check-slow:
                  $(MAKE) check TESTS="$(SLOW_TESTS)" SLOW=1

   <b>VALGRIND</b>
       When   you  do  "make  check-valgrind",  it  searches  for  any  <u>Makefile.am</u>  in  the  tree  that  has  a
       "check-valgrind:" target and runs it.

       Writing the <u>Makefile.am</u> and tests correctly to use valgrind and working with automake parallel  tests  is
       subtle.

       If your tests are run via a shell script wrapper, then in the wrapper use:

        $VG virt-foo

       and in the <u>Makefile.am</u> use:

        check-valgrind:
            make VG="@VG@" check

       However,  if  your  binaries  run directly from the "TESTS" rule, you have to modify the <u>Makefile.am</u> like
       this:

        LOG_COMPILER = $(VG)

        check-valgrind:
            make VG="@VG@" check

       In either case, check that the right program is  being  tested  by  examining  the  <u>valgrind*</u>  log  files
       carefully.

   <b>SUBMITTING</b> <b>PATCHES</b>
       Submit patches to the mailing list: https://lists.libguestfs.org and CC to <a href="mailto:rjones@redhat.com">rjones@redhat.com</a>.

       You  do not need to subscribe to the mailing list if you don’t want to.  There may be a short delay while
       your message is moderated.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man1/p2v-building.1.html">p2v-building</a></b>(1), <b><a href="../man1/p2v-release-notes.1.html">p2v-release-notes</a></b>(1), <a href="http://libguestfs.org/">http://libguestfs.org/</a>.

</pre><h4><b>AUTHORS</b></h4><pre>
       Richard W.M. Jones ("rjones at redhat dot com")

</pre><h4><b>COPYRIGHT</b></h4><pre>
       Copyright (C) 2009-2019 Red Hat Inc.

</pre><h4><b>LICENSE</b></h4><pre>
       This library is free software; you can redistribute it and/or modify it under the terms of the GNU Lesser
       General Public License as published by the Free Software Foundation; either version 2 of the License,  or
       (at your option) any later version.

       This  library  is  distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even
       the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser  General
       Public License for more details.

       You  should  have  received  a copy of the GNU Lesser General Public License along with this program.  If
       not, see &lt;https://www.gnu.org/licenses/&gt;.

</pre><h4><b>BUGS</b></h4><pre>
       To  get  a   list   of   bugs   against   libguestfs   (which   include   virt-p2v),   use   this   link:
       https://bugzilla.redhat.com/buglist.cgi?component=libguestfs&amp;product=Virtualization+Tools

       To       report       a       new       bug       against       libguestfs,      use      this      link:
       https://bugzilla.redhat.com/enter_bug.cgi?component=libguestfs&amp;product=Virtualization+Tools

       When reporting a bug, please supply:

       •   The version of virt-p2v.

       •   Where you got virt-p2v (eg. which Linux distro, compiled from source, etc)

       •   Describe the bug accurately and give a way to reproduce it.

virt-p2v-1.42.4                                    2024-11-30                                     <u><a href="../man1/p2v-hacking.1.html">p2v-hacking</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>