<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>feed2exec-plugins - feed2exec plugin documentation</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/feed2exec">feed2exec_0.22.0_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       feed2exec-plugins - feed2exec plugin documentation

       This is a quick overview of the available plugins.

</pre><h4><b>OUTPUT</b> <b>PLUGINS</b></h4><pre>
   <b>Archive</b>
       <b>feed2exec.plugins.archive.DEFAULT_ARCHIVE_DIR</b> <b>=</b> <b>'<a href="file:/run/user/1000/">/run/user/1000/</a>'</b>
              default archive directory

       <b>feed2exec.plugins.archive.output(*args,</b> <b>feed=None,</b> <b>item=None,</b> <b>session=None,</b> <b>**kwargs)</b>
              The   archive   plugin   saves   the   feed’s  item.link  URLs  into  a  directory,  specified  by
              DEFAULT_ARCHIVE_DIR or through the output <u>args</u> value.

              Example:

                 [NASA breaking news]
                 url = https://www.nasa.gov/rss/dyn/breaking_news.rss
                 output = archive
                 args = /srv/archive/nasa/

              The above will save the “NASA breaking news” into the  <b>/srv/archive/nasa</b>  directory.  Do  <u>not</u>  use
              interpolation here as the feed’s variable could be used to mount a directory transversal attack.

   <b>Echo</b>
       <b>class</b> <b>feed2exec.plugins.echo.output(*args,</b> <b>feed=None,</b> <b>**kwargs)</b>
              This  plugin outputs, to standard output, the arguments it receives. It can be useful to test your
              configuration. It also creates a side effect for the test suite to determine  if  the  plugin  was
              called.

              This plugin does a similar thing when acting as a filter.

       <b>feed2exec.plugins.echo.filter</b>
              This filter just keeps the feed unmodified. It is just there for testing purposes.

   <b>Error</b>
       <b>feed2exec.plugins.error.output(*args,</b> <b>**kwargs)</b>
              The  error plugin is a simple plugin which raises an exception when called. It is designed for use
              in the test suite and should generally not be used elsewhere.

   <b>Exec</b>
       <b>feed2exec.plugins.exec.output(command,</b> <b>*args,</b> <b>feed=None,</b> <b>**kwargs)</b>
              The exec plugin is the ultimate security disaster. It simply executes whatever you feed it without
              any sort of sanitization. It does avoid to call to the shell and executes  the  command  directly,
              however.  Feed contents are also somewhat sanitized by the feedparser module, see the <u>Sanitization</u>
              documentation for more information in that regard. That is limited to stripping out  hostile  HTML
              tags, however.

              You  should  be careful when sending arbitrary parameters to other programs. Even if we do not use
              the shell to execute the program, an hostile feed could still inject commandline flags  to  change
              the program behavior without injecting shell commands themselves.

              For  example,  if  a  program  can write files with the <b>-o</b> option, a feed could set their title to
              <b>-oevil</b> to overwrite the <b>evil</b> file. The only way to workaround that issue is to carefully craft the
              commandline so that this cannot happen.

              Alternatively, writing a Python plugin is much safer as you can sanitize the arguments yourself.

              Example:

                 [NASA What's up?]
                 url = https://www.nasa.gov/rss/dyn/whats_up.rss
                 output = feed2exec.plugins.exec
                 args = wget -P /srv/archives/nasa/ {item.link}

              The above is the equivalent of the archive plugin: it will save  feed  item  links  to  the  given
              directory.

   <b>Maildir</b>
       <b>class</b> <b>feed2exec.plugins.maildir.output(to_addr=None,</b> <b>feed=None,</b> <b>item=None,</b> <b>lock=None,</b> <b>*args,</b> <b>**kwargs)</b>
              The maildir plugin will save a feed item into a Maildir folder.

              The configuration is a little clunky, but it should be safe against hostile feeds.

              <b>Parameters</b>
                     <b>to_addr</b> (<u>str</u>) – the email to use as “to” (defaults to <u>USER@localdomain</u>)

              Example:

                 [NASA breaking news]
                 url = https://www.nasa.gov/rss/dyn/breaking_news.rss
                 mailbox = <a href="file:~/Maildir/">~/Maildir/</a>
                 folder = nasa
                 args = <a href="mailto:me@example.com">me@example.com</a>

              The above will save new feed items from the NASA feed into the <a href="file:~/Maildir/nasa/">~/Maildir/nasa/</a> maildir folder, and
              will set the <u>To</u> field of the email to <u><a href="mailto:me@example.com">me@example.com</a></u>.

   <b>Mbox</b>
       <b>class</b> <b>feed2exec.plugins.mbox.output(to_addr=None,</b> <b>feed=None,</b> <b>item=None,</b> <b>lock=None,</b> <b>*args,</b> <b>**kwargs)</b>
              The mbox plugin will save a feed item in a Mbox mailbox.

              This  is  mostly  for  testing purposes, but can of course be used in the unlikely event where you
              prefer mbox folders over the <u>feed2exec.plugins.maildir</u> plugin.

              <b>Parameters</b>
                     <b>to_addr</b> (<u>str</u>) – the email to use as “to” (defaults to <u>USER@localdomain</u>)

              <b>Todo</b>   There is some overlap between the code here and the maildir implementation. Refactoring may
                     be in order, particularly if we add another mailbox format, though that is unlikely.

   <b>Null</b>
       <b>feed2exec.plugins.null.output(*args,</b> <b>**kwargs)</b>
              This plugin does nothing. It can be useful in cases where you want to catchup with imported feeds.

       <b>feed2exec.plugins.null.filter(item=None,</b> <b>*args,</b> <b>**kwargs)</b>
              The null filter removes all elements from a feed item

   <b>Transmission</b>
       <b>feed2exec.plugins.transmission.sanitize(text,</b> <b>repl='-')</b>
              like utils.slug, but without lowercase and allow custom replacement

              &gt;&gt;&gt; sanitize('test')
              'test'
              &gt;&gt;&gt; sanitize('../../../etc/password')
              'etc-password'
              &gt;&gt;&gt; sanitize('Foo./.bar', repl='.')
              'Foo.bar'

       <b>feed2exec.plugins.transmission.output(hostname='localhost',</b> <b>*args,</b> <b>feed=None,</b> <b>item=None,</b> <b>**kwargs)</b>
              the transmission plugin will send feed items to a <u>transmission</u> instance

              it assumes the <b>transmission-remote</b> command is  already  installed  and  configured  to  talk  with
              transmission.

              the  hostname  is passed in the <b>args</b> configuration and defaults to localhost. the <b>folder</b> parameter
              is also used to determine where to save the actual torrents files.

              note that this will also append a sanitized version of the item title, if a  folder  is  provided.
              this is to allow saving series in the same folder.

              if  the  title  is  unique  for  each  torrent, you may use a filter to set the title to the right
              location.

   <b>Wayback</b>
       <b>feed2exec.plugins.wayback.output(*args,</b> <b>feed=None,</b> <b>item=None,</b> <b>session=None,</b> <b>**kwargs)</b>
              This plugin saves the feed items <u>link</u> element to the wayback machine.  It  will  retry  URLs  that
              fail, so it may be necessary to manually catchup feeds if they have broken <u>link</u> fields.

              There  are two wayback machine APIs that can be used, the default one archives the full page while
              the other one archives only the page URLs.

              The mechanism for archiving the full page uses a  browser  on  the  server  to  download  all  the
              resources used by the page including img/CSS/JS/etc:

              <u>https://blog.archive.org/2019/10/23/the-wayback-machines-save-page-now-is-new-and-improved/</u>

              Unfortunately  the  SPN2  page is just a HTML form, the response code is always 200 OK, any errors
              are returned in a HTML page and there are no easily machine-readable ways to find  the  errors  on
              the  page so we have to parse the HTML and query it using XPath based heuristics, but if there are
              errors in a form that is not yet known then the unknown errors will not be detected properly.

              Example:

                 [NASA IOTD wayback]
                 url = https://www.nasa.gov/rss/dyn/lg_image_of_the_day.rss
                 output = feed2exec.plugins.wayback
                 args = full

              The above will save the Image of the day updates to the wayback machine. Since the page has images
              and everything is loaded by JS, using the SPN2 API is necessary to capture the useful information.

              Example:

                 [ikiwiki RecentChanges wayback]
                 url = https://ikiwiki.info/recentchanges/index.rss
                 output = feed2exec.plugins.wayback
                 args = page

              The above will save the ikiwiki RecentChanges to the wayback machine.  Since  the  page  is  plain
              text,  saving the full page resources is not really necessary, the CSS does not add information to
              the page.

</pre><h4><b>FILTER</b> <b>PLUGINS</b></h4><pre>
   <b>Droptitle</b>
       <b>feed2exec.plugins.droptitle.filter(*args,</b> <b>feed=None,</b> <b>item=None,</b> <b>**kwargs)</b>
              the droptitle filter will drop any feed item with a title matching the given args.

              Example:

                 [NASA breaking news]
                 url = https://www.nasa.gov/rss/dyn/breaking_news.rss
                 filter = feed2exec.plugins.droptitle
                 filter_args = Trump

              The above will process the feed items according to the global configuration,  but  will  skip  any
              item that has the word “Trump” anywhere in the title field.

              Arguments  are  processed  as a single string. If you need to match more complex patterns, look at
              the droptitleregex plugin instead.

   <b>Droptitleregex</b>
       <b>feed2exec.plugins.droptitleregex.filter(*args,</b> <b>feed=None,</b> <b>item=None,</b> <b>**kwargs)</b>
              the droptitleregex filter will drop any  feed  item  with  a  title  matching  the  given  regular
              expression pattern.

              Example:

                 [NASA breaking news]
                 url = https://www.nasa.gov/rss/dyn/breaking_news.rss
                 filter = feed2exec.plugins.droptitleregex
                 filter_args = ^ham

              The  above  configuration  processes the feed items based on the global configuration, but it will
              skip any item whose title starts with the word “ham”.

   <b>Emptysummary</b>
       <b>feed2exec.plugins.emptysummary.filter(*args,</b> <b>feed=None,</b> <b>item=None,</b> <b>**kwargs)</b>
              example of fixes for a broken feed, in this case, the GitHub release feed which (sometimes)  sends
              empty contents, in which case the item link field is used as a summary instead.

   <b>Html2text</b>
       <b>class</b> <b>feed2exec.plugins.html2text.filter(*args,</b> <b>feed=None,</b> <b>item=None,</b> <b>**kwargs)</b>
              This  filter plugin takes a given feed item and adds a <b>content_plain</b> field with the HTML parsed as
              text.

              <b>IMPORTANT:</b>
                 the html2text plugin is called automatically from the email output plugins and should  normally
                 not be called directly.

              <b>static</b> <b>parse(html=None)</b>
                     parse  html to text according to our preferences. this is where subclasses can override the
                     HTML2Text settings or use a completely different parser

   <b>Ikiwiki</b> <b>Recentchanges</b>
       <b>feed2exec.plugins.ikiwiki_recentchanges.filter(*args,</b> <b>item=None,</b> <b>**kwargs)</b>
              the ikiwiki_recentchanges plugin fixes links in ikiwiki feeds

              Ikiwiki recent changes show all the recent edits to pages, but the <b>&lt;link&gt;</b> element doesn’t point to
              the edit page: it points to the recent changes page itself,  which  make  them  useless  for  link
              checking or archival purposes.

              This parses the recent changes entries and extracts the relevant links from it.

              An alternative to this is to use the following entry to generate a special feed in Ikiwiki:

                 [[!inline pages="*" feeds=yes feedonly=yes feedfile=archive show=10]]

              This generates a feed with proper <b>&lt;link&gt;</b> elements but requires write access to the wiki.

              This  will  also add the date to the URL GUID so that we refresh when a page is updated. Otherwise
              feed2exec would think the entry has already been passed.

   <b>Matchtitleregex</b>
       <b>feed2exec.plugins.matchtitleregex.filter(*args,</b> <b>feed=None,</b> <b>item=None,</b> <b>**kwargs)</b>
              The matchtitleregex filter selects only the  feed  items  whose  title  match  the  given  regular
              expression pattern.

              Example:

                 [NASA breaking news]
                 url = https://www.nasa.gov/rss/dyn/breaking_news.rss
                 filter = feed2exec.plugins.matchtitleregex
                 filter_args = ^spam

              The  above  configuration  processes the feed items based on the global configuration, but it will
              skip any item whose title does not start with the word “spam”.

</pre><h4><b>WRITING</b> <b>NEW</b> <b>PLUGINS</b></h4><pre>
       Most of the actual work in the program is performed by plugins. A plugin is a simple Python  module  that
       has a <b>output</b> or <b>filter</b> “callable” (function or class) with a predefined interface.

   <b>Basic</b> <b>plugin</b> <b>principles</b>
       To  write  a new plugin, you should start by creating a simple Python module, in your <u>PYTHONPATH</u>. You can
       find which directories are in the path by calling:

          $ python3 -c "import sys; print(sys.path)"
          ['', '/usr/lib/python35.zip', '/usr/lib/python3.5', '/usr/lib/python3.5/plat-x86_64-linux-gnu', '/usr/lib/python3.5/lib-dynload', '/usr/local/lib/python3.5/dist-packages', '<a href="file:/usr/lib/python3/dist-packages">/usr/lib/python3/dist-packages</a>']

       In the above example,  a  good  location  would  be  <b>/usr/local/lib/python3.5/dist-packages</b>.  The  naming
       convention is loose: as long as the plugin matches the expected API, it should just work. For the purpose
       of this demonstration, we’ll call our plugin <u>trumpery</u>, so we will create the plugin code like this:

          touch /usr/local/lib/python3.5/dist-packages/trumpery.py

       Naturally, if you are going to write multiple plugins, you may want to regroup your multiple plugins in a
       package, see the <u>module</u> <u>documentation</u> for more information about this concept in Python.

       <b>NOTE:</b>
          There is a rudimentary plugin resolution process that looks for plugins first in the <u>feed2exec.plugins</u>
          namespace  but  then  globally.  This  is done in <u>feed2exec.plugins.resolve()</u>, called from the <b>add</b> and
          <b>parse</b> commands. This means that the absolute path is expected to be used in the configuration file and
          internally.

       You are welcome to distribute plugins separately or send them as merge requests, see  <u>Contribution</u>  <u>guide</u>
       for  more  information  on how to participate in this project. We of course welcome contributions to this
       documentation as well!

   <b>Filters</b>
       Now, you need your plugin to do something. In our case, let’s say we’d like to skip any feed  entry  that
       has  the  word  <u>Trump</u>  in  it.  For  that  purpose, we’ll create a plugin similar to the already existing
       <u>feed2exec.plugins.droptitle</u> plugin, but that operates on the <u>body</u> of the feed, but  that  also  hardcodes
       the  word,  because  this  is just a demonstration and we want to keep it simple. Let’s look at the title
       plugin to see how it works:

          def filter(*args, feed=None, item=None, **kwargs):
              '''the droptitle filter will drop any feed item with a title matching
              the given args.

              Example::

                [NASA breaking news]
                url = https://www.nasa.gov/rss/dyn/breaking_news.rss
                filter = feed2exec.plugins.droptitle
                filter_args = Trump

              The above will process the feed items according to the global
              configuration, but will skip any item that has the word "Trump"
              anywhere in the title field.

              Arguments are processed as a single string. If you need to match
              more complex patterns, look at the droptitleregex plugin instead.
              '''
              item['skip'] = ' '.join(args) in item.get('title', '')

       That may look like complete gibberish to you if you are not familiar  with  programming  or  with  Python
       programming  in  particular.  But let’s take this from the top and copy that in our own plugin. The first
       line declares a <u>function</u> that takes at least a <b>feed</b> and a <b>item</b> argument, but can also  accept  any  other
       arbitrary  argument.  This  is important because we want to have the plugin keep on working if the plugin
       API changes in the future. This is called “forward-compatibility”. So let’s copy that in our  plugin  and
       add a <b>pass</b> statement to make sure the plugin works (even if it does nothing for now):

          def filter(*args, feed=None, item=None, **kwargs):
              pass

       We can already test our plugin by adding it to our configuration, in <b><a href="file:~/.config/feed2exec.ini">~/.config/feed2exec.ini</a></b>:

          [NASA]
          url = https://www.nasa.gov/rss/dyn/breaking_news.rss
          output = feed2exec.plugins.echo
          args = {item.title}
          filter = trumpery

       Notice  how we use the <b>output</b> plugin to show the title of feed items selected, as a debugging tool. Let’s
       fetch this feed in debugging mode to see what happens:

          $ python3 -m feed2exec --verbose fetch --force
          opening local file /home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml
          parsing feed file:///home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml (10355 bytes)
          connecting to database at ./doc/feed2exec.db
          arguments received: ('President Trump Welcomes Home Record-breaking NASA Astronaut Peggy Whitson',)
          arguments received: ('Three International Space Station Crewmates Safely Return to Earth',)
          arguments received: ('NASA Statement on Nomination for Agency Administrator',)
          arguments received: ('NASA Television to Air Return of Three International Space Station Crew Members',)
          arguments received: ('NASA and Iconic Museum Honor Voyager Spacecraft 40th Anniversary',)
          arguments received: ('NASA’s Johnson Space Center Closes Through Labor Day for Tropical Storm Harvey',)
          arguments received: ('NASA Cancels Planned Media Availabilities with Astronauts',)
          arguments received: ('NASA Awards $400,000 to Top Teams at Second Phase of 3D-Printing Competition',)
          arguments received: ('NASA Awards Contract for Center Protective Services for Glenn Research Center',)
          arguments received: ('NASA Announces Cassini End-of-Mission Media Activities',)
          1 feeds processed

       Good! The feed is fetched and items are displayed. It means our filter didn’t  interfere,  but  now  it’s
       time  to make it <u>do</u> something. To skip items, we need to set the <b>skip</b> attribute for the feed item to <u>True</u>
       if we want to skip it and <u>False</u> otherwise. So we’ll use a simple recipe, a bit like <u>droptitle</u>  does,  but
       simpler,  to  look  at  the feed content to look for our evil word. The <b>feedparser</b> documentation tells us
       feed items have a <u>summary</u> field which we can inspect. There’s also a <u>content</u> list, but  that’s  a  little
       more  complicated  so  we’ll skip that for now. So, let’s set the <b>skip</b> parameter to match if there is the
       evil word in our feed item, like this:

          def filter(*args, feed=None, item=None, **kwargs):
              item['skip'] = 'Trump' in item.get('summary', '')

       And let’s see the result (note that we use the <b>--force</b> argument here otherwise we  would  just  skip  all
       items because of the cache):

          $ python3 -m feed2exec --verbose fetch --force
          opening local file /home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml
          parsing feed file:///home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml (10355 bytes)
          connecting to database at ./doc/feed2exec.db
          item President Trump Welcomes Home Record-breaking NASA Astronaut Peggy Whitson of feed NASA filtered out
          arguments received: ('Three International Space Station Crewmates Safely Return to Earth',)
          item NASA Statement on Nomination for Agency Administrator of feed NASA filtered out
          arguments received: ('NASA Television to Air Return of Three International Space Station Crew Members',)
          arguments received: ('NASA and Iconic Museum Honor Voyager Spacecraft 40th Anniversary',)
          arguments received: ('NASA’s Johnson Space Center Closes Through Labor Day for Tropical Storm Harvey',)
          arguments received: ('NASA Cancels Planned Media Availabilities with Astronauts',)
          arguments received: ('NASA Awards $400,000 to Top Teams at Second Phase of 3D-Printing Competition',)
          arguments received: ('NASA Awards Contract for Center Protective Services for Glenn Research Center',)
          arguments received: ('NASA Announces Cassini End-of-Mission Media Activities',)
          1 feeds processed

       Success!  We have skipped the two items that contain the fraud we wanted to remove from the world. Notice
       how we were able to <u>modify</u> the feed item: we can also use that to <u>change</u> the feed content.  Normally,  we
       would use this to fix malformed feeds, but let’s have some fun instead and <u>rename</u> <u>Trump</u> <u>to</u> <u>Drumpf</u>:

          def filter(*args, feed=None, item=None, **kwargs):
              item['title'] = item.get('title', '').replace('Trump', 'Drumpf')

       And the result:

          $ python3 -m feed2exec --verbose fetch --force
          opening local file /home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml
          parsing feed file:///home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml (10355 bytes)
          connecting to database at ./doc/feed2exec.db
          arguments received: ('President Drumpf Welcomes Home Record-breaking NASA Astronaut Peggy Whitson',)
          arguments received: ('Three International Space Station Crewmates Safely Return to Earth',)
          arguments received: ('NASA Statement on Nomination for Agency Administrator',)
          arguments received: ('NASA Television to Air Return of Three International Space Station Crew Members',)
          arguments received: ('NASA and Iconic Museum Honor Voyager Spacecraft 40th Anniversary',)
          arguments received: ('NASA’s Johnson Space Center Closes Through Labor Day for Tropical Storm Harvey',)
          arguments received: ('NASA Cancels Planned Media Availabilities with Astronauts',)
          arguments received: ('NASA Awards $400,000 to Top Teams at Second Phase of 3D-Printing Competition',)
          arguments received: ('NASA Awards Contract for Center Protective Services for Glenn Research Center',)
          arguments received: ('NASA Announces Cassini End-of-Mission Media Activities',)
          1 feeds processed

       I  know,  absolutely  hilarious,  right? More seriously, this is also how the <u>feed2exec.plugins.html2text</u>
       filter works, which is enabled by default and helps the email output plugin do its job  by  turning  HTML
       into text. At this point, the only limit is your knowledge of Python programming and your imagination!

   <b>Output</b> <b>plugins</b>
       Output plugins are another beast entirely. While they operate with the same principle than filter plugins
       (search path and function signature are similar), they are designed to actually output something for each
       new  feed  item  found.  This  can  be  anything:  a  file,  email, HTTP request, whatever. If there is a
       commandline tool that does what you need, it is probably simpler to just call the <b>exec</b> plugin  and  there
       are  numerous examples of this in the sample configuration file. For more complex things, however, it may
       be easier to actually write this as a Python.

   <b>Basic</b> <b>arguments</b>
       For our example, we’ll write an archival plugin which writes each new entry to a file  hierarchy.  First,
       we start with the same simple function signature as filters, except we name it output:

          def output(*args, feed=None, item=None, **kwargs):
              pass

       This  is  the  equivalent  of  the  <b>null</b> plugin and basically outputs nothing at all. To archive the feed
       items, we’ll need to look at the <u>link</u> element feedparser gives us. Let’s see what that looks like for the
       NASA feed:

          def output(*args, feed=None, item=None, **kwargs):
              # only operate on items that actually have a link
              if item.get('link'):
                  print(item.get('link', ''))
              else:
                  logging.info('no link for feed item %s, not archiving', item.get('title'))

       <b>NOTE:</b>
          Note that we try to make plugins silent in general. You can use <u>logging.info()</u> to have things show  up
          in  <b>--verbose</b>  and  <u>logging.debug()</u>  for  <b>--debug</b>  but by default, your plugin should be silent unless
          there’s an error that requires the user’s intervention, in which case you should use <u>logging.warning()</u>
          for transient errors that may be automatically recovered and <u>logging.error()</u> for errors  that  require
          user intervention. This is to allow users to ignore warnings safely.

       Note  that  here  we  first  check  to see if the feed item actually <u>has</u> a link - not all feeds do! After
       adding the above to our <b>trumpery</b> plugin and adding it as an output plugin:

          [NASA]
          url = https://www.nasa.gov/rss/dyn/breaking_news.rss
          output = trumpery
          filter = trumpery

       We can try to see what happens when we call it:

          $ python3 -m feed2exec --verbose fetch --force
          opening local file /home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml
          parsing feed file:///home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml (10355 bytes)
          connecting to database at ./doc/feed2exec.db
          <a href="http://www.nasa.gov/press-release/president-trump-welcomes-home-record-breaking-nasa-astronaut-peggy-whitson">http://www.nasa.gov/press-release/president-trump-welcomes-home-record-breaking-nasa-astronaut-peggy-whitson</a>
          <a href="http://www.nasa.gov/press-release/three-international-space-station-crewmates-safely-return-to-earth">http://www.nasa.gov/press-release/three-international-space-station-crewmates-safely-return-to-earth</a>
          <a href="http://www.nasa.gov/press-release/nasa-statement-on-nomination-for-agency-administrator">http://www.nasa.gov/press-release/nasa-statement-on-nomination-for-agency-administrator</a>
          <a href="http://www.nasa.gov/press-release/nasa-television-to-air-return-of-three-international-space-station-crew-members">http://www.nasa.gov/press-release/nasa-television-to-air-return-of-three-international-space-station-crew-members</a>
          <a href="http://www.nasa.gov/press-release/nasa-and-iconic-museum-honor-voyager-spacecraft-40th-anniversary">http://www.nasa.gov/press-release/nasa-and-iconic-museum-honor-voyager-spacecraft-40th-anniversary</a>
          <a href="http://www.nasa.gov/press-release/nasa-s-johnson-space-center-closes-through-labor-day-for-tropical-storm-harvey">http://www.nasa.gov/press-release/nasa-s-johnson-space-center-closes-through-labor-day-for-tropical-storm-harvey</a>
          <a href="http://www.nasa.gov/press-release/nasa-cancels-planned-media-availabilities-with-astronauts">http://www.nasa.gov/press-release/nasa-cancels-planned-media-availabilities-with-astronauts</a>
          <a href="http://www.nasa.gov/press-release/nasa-awards-400000-to-top-teams-at-second-phase-of-3d-printing-competition">http://www.nasa.gov/press-release/nasa-awards-400000-to-top-teams-at-second-phase-of-3d-printing-competition</a>
          <a href="http://www.nasa.gov/press-release/nasa-awards-contract-for-center-protective-services-for-glenn-research-center">http://www.nasa.gov/press-release/nasa-awards-contract-for-center-protective-services-for-glenn-research-center</a>
          <a href="http://www.nasa.gov/press-release/nasa-announces-cassini-end-of-mission-media-activities">http://www.nasa.gov/press-release/nasa-announces-cassini-end-of-mission-media-activities</a>
          1 feeds processed

   <b>Sanitizing</b> <b>contents</b>
       Good. Those are the URLs we want to save to disk. Let’s start by just writing those to a  file.  We  will
       also  use  a simple <u>slug</u> function to make a filesystem-safe name from the feed title and save those files
       in a pre-determined location:

          import logging
          import os.path
          from feed2exec.utils import slug

          ARCHIVE_DIR='/run/user/1000/feed-archives/'

          def output(*args, feed=None, item=None, session=None, **kwargs):
              # make a safe path from the item name
              path = slug(item.get('title', 'no-name'))
              # put the file in the archive directory
              path = os.path.join(ARCHIVE_DIR, path)
              # only operate on items that actually have a link
              if item.get('link'):
                  # tell the user what's going on, if verbose
                  # otherwise, we try to stay silent if all goes well
                  logging.info('saving feed item %s to %s from %s',
                               item.get('title'), path, item.get('link'))
                  # open the file
                  with open(path, 'w') as archive:
                      # write the response
                      archive.write(item.get('link'))
              else:
                  logging.info('no link for feed item %s, not archiving', item.get('title'))

       Now I know this may look like a <u>huge</u> <u>step</u> <u>from</u> <u>the</u> <u>previous</u> <u>one</u> but I’m sorry, I couldn’t find a  simpler
       second step. :) The output now looks like this:

          $ python3 -m feed2exec --config ./doc/ --verbose fetch --force
          opening local file /home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml
          parsing feed file:///home/anarcat/src/feed2exec/feed2exec/tests/files/breaking_news.xml (10355 bytes)
          connecting to database at ./doc/feed2exec.db
          saving feed item President Drumpf Welcomes Home Record-breaking NASA Astronaut Peggy Whitson to /run/user/1000/president-drumpf-welcomes-home-record-breaking-nasa-astronaut-peggy-whitson from <a href="http://www.nasa.gov/press-release/president-trump-welcomes-home-record-breaking-nasa-astronaut-peggy-whitson">http://www.nasa.gov/press-release/president-trump-welcomes-home-record-breaking-nasa-astronaut-peggy-whitson</a>
          saving feed item Three International Space Station Crewmates Safely Return to Earth to /run/user/1000/three-international-space-station-crewmates-safely-return-to-earth from <a href="http://www.nasa.gov/press-release/three-international-space-station-crewmates-safely-return-to-earth">http://www.nasa.gov/press-release/three-international-space-station-crewmates-safely-return-to-earth</a>
          saving feed item NASA Statement on Nomination for Agency Administrator to /run/user/1000/nasa-statement-on-nomination-for-agency-administrator from <a href="http://www.nasa.gov/press-release/nasa-statement-on-nomination-for-agency-administrator">http://www.nasa.gov/press-release/nasa-statement-on-nomination-for-agency-administrator</a>
          saving feed item NASA Television to Air Return of Three International Space Station Crew Members to /run/user/1000/nasa-television-to-air-return-of-three-international-space-station-crew-members from <a href="http://www.nasa.gov/press-release/nasa-television-to-air-return-of-three-international-space-station-crew-members">http://www.nasa.gov/press-release/nasa-television-to-air-return-of-three-international-space-station-crew-members</a>
          saving feed item NASA and Iconic Museum Honor Voyager Spacecraft 40th Anniversary to /run/user/1000/nasa-and-iconic-museum-honor-voyager-spacecraft-40th-anniversary from <a href="http://www.nasa.gov/press-release/nasa-and-iconic-museum-honor-voyager-spacecraft-40th-anniversary">http://www.nasa.gov/press-release/nasa-and-iconic-museum-honor-voyager-spacecraft-40th-anniversary</a>
          saving feed item NASA’s Johnson Space Center Closes Through Labor Day for Tropical Storm Harvey to /run/user/1000/nasa-s-johnson-space-center-closes-through-labor-day-for-tropical-storm-harvey from <a href="http://www.nasa.gov/press-release/nasa-s-johnson-space-center-closes-through-labor-day-for-tropical-storm-harvey">http://www.nasa.gov/press-release/nasa-s-johnson-space-center-closes-through-labor-day-for-tropical-storm-harvey</a>
          saving feed item NASA Cancels Planned Media Availabilities with Astronauts to /run/user/1000/nasa-cancels-planned-media-availabilities-with-astronauts from <a href="http://www.nasa.gov/press-release/nasa-cancels-planned-media-availabilities-with-astronauts">http://www.nasa.gov/press-release/nasa-cancels-planned-media-availabilities-with-astronauts</a>
          saving feed item NASA Awards $400,000 to Top Teams at Second Phase of 3D-Printing Competition to /run/user/1000/nasa-awards-400-000-to-top-teams-at-second-phase-of-3d-printing-competition from <a href="http://www.nasa.gov/press-release/nasa-awards-400000-to-top-teams-at-second-phase-of-3d-printing-competition">http://www.nasa.gov/press-release/nasa-awards-400000-to-top-teams-at-second-phase-of-3d-printing-competition</a>
          saving feed item NASA Awards Contract for Center Protective Services for Glenn Research Center to /run/user/1000/nasa-awards-contract-for-center-protective-services-for-glenn-research-center from <a href="http://www.nasa.gov/press-release/nasa-awards-contract-for-center-protective-services-for-glenn-research-center">http://www.nasa.gov/press-release/nasa-awards-contract-for-center-protective-services-for-glenn-research-center</a>
          saving feed item NASA Announces Cassini End-of-Mission Media Activities to /run/user/1000/nasa-announces-cassini-end-of-mission-media-activities from <a href="http://www.nasa.gov/press-release/nasa-announces-cassini-end-of-mission-media-activities">http://www.nasa.gov/press-release/nasa-announces-cassini-end-of-mission-media-activities</a>

       Sweet!  Now  it’s  not really nice to save this in <b><a href="file:/run/user/1000">/run/user/1000</a></b>. I just chose this directory because it
       was a safe place to write but it’s not a persistent directory. Best  make  that  configurable,  which  is
       where plugin arguments come in.

   <b>User</b> <b>configuration</b>
       You  see that <b>*args</b> parameter? That comes straight from the configuration file. So you could set the path
       in the configuration file, like this:

          [NASA]
          url = https://www.nasa.gov/rss/dyn/breaking_news.rss
          output = trumpery
          args = /srv/archives/nasa/
          filter = trumpery

       We also need to modify the plugin to fetch that configuration, like this:

          def output(*args, feed=None, item=None, session=None, **kwargs):
              # make a safe path from the item name
              path = slug(item.get('title', 'no-name'))
              # take the archive dir from the user or use the default
              archive_dir = ' '.join(args) if args else DEFAULT_ARCHIVE_DIR
              # put the file in the archive directory
              path = os.path.join(archive_dir, path)
              # [...]
              # rest of the function unchanged

   <b>Making</b> <b>HTTP</b> <b>requests</b>
       And now obviously, we only saved the link itself, not the link <u>content</u>. For that we need some  help  from
       the <b>requests</b> module, and do something like this:

          # fetch the URL in memory
          result = session.get(item.get('link'))
          if result.status_code != requests.codes.ok:
              logging.warning('failed to fetch link %s: %s',
                              item.get('link'), result.status_code)
              # make sure we retry next time
              return False
          # open the file
          with open(path, 'w') as archive:
              # write the response
              archive.write(result.text)

       This will save the actual link content (<b>result.text</b>) to the file. The important statement here is:

          # fetch the URL in memory
          result = session.get(item.get('link'))

       which fetches the URL in memory and checks for errors. The other change in the final plugin is simply:

          archive.write(result.text)

       which writes the article content instead of the link.

       Notice  how  the  <b>session</b>  argument is used here instead of talking directly to the <b>requests</b> module. This
       leverages a caching system we already have, alongside configuration like user-agent and so on.

   <b>Plugin</b> <b>return</b> <b>values</b>
       Notice how we <b>return</b> <b>False</b> here: this makes the plugin system avoid adding the item to the cache,  so  it
       is  retried  on  the  next run. If the plugin returns <b>True</b> or nothing (<b>None</b>), the plugin is considered to
       have   succeeded   and   the   entry   is   added   to   the   cache.   That   logic   is   defined    in
       <u>feed2exec.controller.FeedManager.fetch()</u>.

   <b>Catchup</b>
       A  final  thing  that is missing that is critical in all plugins is to respect the <b>catchup</b> setting. It is
       propagated up from the commandline or configuration all  the  way  down  to  plugins,  through  the  <b>feed</b>
       parameters.  How you handle it varies from plugin to plugin, but the basic idea is to give feedback (when
       verbose) of activity when the plugin is run <u>but</u> to not actually <u>do</u>  anything.  In  our  case,  we  simply
       return success, right before we fetch the URL:

          if feed.get('catchup'):
              return True
          # fetch the URL in memory
          result = session.get(item.get('link'))

       Notice  how we still fetch the actual feed content but stop before doing any permanent operation. That is
       the spirit of the “catchup” operation: we not only skip “write” operation, but also any  operation  which
       could  slow down the “catchup”: fetching stuff over the network takes time and while it can be considered
       a “readonly” operation as far as the local machine is  concerned,  we  are  effectively  <u>writing</u>  to  the
       network so that operation shouldn’t occur.

       Hopefully that should get you going with most of the plugins you are thinking of writing!

   <b>Writing</b> <b>tests</b>
       Writing  tests is essential in ensuring that the code will stay maintainable in the future. It allows for
       easy refactoring and can find bugs that manual testing may not, especially when you get complete coverage
       (although that is no guarantee either).

       We’ll take our <u>archive</u> plugin as an example. The first step is  to  edit  the  <b>tests/test/test_plugins.py</b>
       file, where other plugins are tests as well. We start by creating a function named <b>test_archive</b> so that ‐
       <u>Pytest</u>, our test bed, will find it:

          def test_archive(tmpdir, betamax):  # noqa
              pass

       Notice  the  two  arguments  named  <b>tmpdir</b> and <b>betamax</b>. Both of those are <u>fixtures</u>, a pytest concept that
       allows to simulate an environment. In particular, the <b>tmpdir</b> fixture, shipped with pytest, allows you  to
       easily  manage  (and  automatically  remove)  temporary directories. The <b>betamax</b> fixtures is a uses the ‐
       <u>betamax</u> module to record then replay HTTP requests.

       Then we need to do something. We need to create a feed and a feed item that we can  then  send  into  the
       plugin.  We  could  also directly parse an existing feed and indeed some plugins do exactly that. But our
       plugin is simple and we can afford to skip full feed parsing and just synthesize what we need:

          feed = Feed('test archive', test_sample)
          item = feedparser.FeedParserDict({'link': '<a href="http://example.com/">http://example.com/</a>',
                                           'title': 'example site'})

       This creates a new feed based on the <b>test_sample</b> feed. This is necessary so that the <b>session</b> is  properly
       re-initialized  in  the  feed  item (otherwise the <b>betamax</b> fixture will not work). Then it creates a fake
       feed entry simply with one link and a title. Then we can call our plugin, and verify that  it  saves  the
       file as we expected. The test for the most common case looks like this:

          def test_archive(tmpdir, betamax):  # noqa
              dest = tmpdir.join('archive')
              feed = Feed('test archive', test_sample)
              item = feedparser.FeedParserDict({'link': '<a href="http://example.com/">http://example.com/</a>',
                                                'title': 'example site'})
              assert archive_plugin.output(str(dest), feed=feed, item=item)
              assert dest.join('example-site').check()

       Then we can try to run this with <b>pytest-3</b>:

          [1084]anarcat@curie:feed2exec$ pytest-3
          =============================== test session starts ===============================
          platform linux -- Python 3.5.3, pytest-3.0.6, py-1.4.32, pluggy-0.4.0
          rootdir: /home/anarcat/src/feed2exec, inifile: setup.cfg
          plugins: profiling-1.2.11, cov-2.4.0, betamax-0.8.0
          collected 26 items

          feed2exec/utils.py ..
          feed2exec/plugins/transmission.py .
          feed2exec/tests/test_feeds.py ........
          feed2exec/tests/test_main.py .....
          feed2exec/tests/test_opml.py .
          feed2exec/tests/test_plugins.py .........

          ----------- coverage: platform linux, python 3.5.3-final-0 -----------
          Name                                         Stmts   Miss  Cover
          ----------------------------------------------------------------
          feed2exec/__init__.py                           12      0   100%
          feed2exec/__main__.py                           87      1    99%
          feed2exec/_version.py                            1      0   100%
          feed2exec/email.py                              81      7    91%
          feed2exec/feeds.py                             243      8    97%
          feed2exec/logging.py                            31     11    65%
          feed2exec/plugins/__init__.py                   47      6    87%
          feed2exec/plugins/archive.py                    23      5    78%
          feed2exec/plugins/droptitle.py                   2      0   100%
          feed2exec/plugins/echo.py                        8      0   100%
          feed2exec/plugins/emptysummary.py                5      0   100%
          feed2exec/plugins/error.py                       2      0   100%
          feed2exec/plugins/exec.py                        7      0   100%
          feed2exec/plugins/html2text.py                  20      4    80%
          feed2exec/plugins/ikiwiki_recentchanges.py       9      5    44%
          feed2exec/plugins/maildir.py                    28      0   100%
          feed2exec/plugins/mbox.py                       29      1    97%
          feed2exec/plugins/null.py                        5      1    80%
          feed2exec/plugins/transmission.py               20      0   100%
          feed2exec/plugins/wayback.py                    20      0   100%
          feed2exec/tests/__init__.py                      0      0   100%
          feed2exec/tests/conftest.py                      3      0   100%
          feed2exec/tests/fixtures.py                     19      0   100%
          feed2exec/tests/test_feeds.py                  124      0   100%
          feed2exec/tests/test_main.py                    90      0   100%
          feed2exec/tests/test_opml.py                    17      0   100%
          feed2exec/tests/test_plugins.py                162      0   100%
          feed2exec/utils.py                              41     12    71%
          ----------------------------------------------------------------
          TOTAL                                         1136     61    95%

          =========================== 26 passed in 10.83 seconds ============================

       Notice the test coverage: we only have 78% test coverage for our plugin. This means that some branches of
       the code were not executed at all! Let’s see if we can improve that. Looking at the code, I see there are
       some  conditionals  for  error handling. So let’s simulate an error, and make sure that we don’t create a
       file on error:

          dest.remove()
          item = feedparser.FeedParserDict({'link': '<a href="http://example.com/404">http://example.com/404</a>',
                                          'title': 'example site'})
          assert not archive_plugin.output(str(dest), feed=feed, item=item)
          assert not dest.join('example-site').check()

       There. Let’s see the effect on the test coverage:

          [1085]anarcat@curie:feed2exec2$ pytest-3 feed2exec/tests/test_plugins.py::test_archive
          =============================== test session starts ===============================
          platform linux -- Python 3.5.3, pytest-3.0.6, py-1.4.32, pluggy-0.4.0
          rootdir: /home/anarcat/src/feed2exec, inifile: setup.cfg
          plugins: profiling-1.2.11, cov-2.4.0, betamax-0.8.0
          collected 10 items

          feed2exec/tests/test_plugins.py .

          ----------- coverage: platform linux, python 3.5.3-final-0 -----------
          Name                                         Stmts   Miss  Cover
          ----------------------------------------------------------------
          feed2exec/__init__.py                           12      0   100%
          feed2exec/__main__.py                           87     87     0%
          feed2exec/_version.py                            1      0   100%
          feed2exec/email.py                              81     64    21%
          feed2exec/feeds.py                             243    172    29%
          feed2exec/logging.py                            31     31     0%
          feed2exec/plugins/__init__.py                   47     38    19%
          feed2exec/plugins/archive.py                    23      3    87%
          feed2exec/plugins/droptitle.py                   2      2     0%
          feed2exec/plugins/echo.py                        8      3    62%
          feed2exec/plugins/emptysummary.py                5      5     0%
          feed2exec/plugins/error.py                       2      2     0%
          feed2exec/plugins/exec.py                        7      7     0%
          feed2exec/plugins/html2text.py                  20     13    35%
          feed2exec/plugins/ikiwiki_recentchanges.py       9      9     0%
          feed2exec/plugins/maildir.py                    28     19    32%
          feed2exec/plugins/mbox.py                       29     29     0%
          feed2exec/plugins/null.py                        5      5     0%
          feed2exec/plugins/transmission.py               20     12    40%
          feed2exec/plugins/wayback.py                    20     20     0%
          feed2exec/tests/__init__.py                      0      0   100%
          feed2exec/tests/conftest.py                      3      0   100%
          feed2exec/tests/fixtures.py                     19      6    68%
          feed2exec/tests/test_feeds.py                  124    101    19%
          feed2exec/tests/test_main.py                    90     90     0%
          feed2exec/tests/test_opml.py                    17     17     0%
          feed2exec/tests/test_plugins.py                166    123    26%
          feed2exec/utils.py                              41     16    61%
          ----------------------------------------------------------------
          TOTAL                                         1140    874    23%

          ============================ 1 passed in 2.46 seconds =============================

       Much better! Only 3 lines left to cover!

       <b>NOTE:</b>
          Notice how I explicitly provided a path to my test. This  is  entirely  optional.  You  can  just  run
          <b>pytest-3</b>  and  it  will  run  the  whole  test  suite: this method is just faster. Notice also how the
          coverage ratio is very low: this is normal; we are testing, after all, only <u>one</u> plugin here.

       The only branches left to test in the code is the other possible error (“no link in  the  feed”)  and  to
       test  the  “catchup”  mode.  You  can  see  this in the actual <b>test_plugins.py</b> file distributed with this
       documentation.

       <b>NOTE:</b>
          If you discover a bug associated with a  single  feed,  you  can  use  the  betamax  session  and  the
          <u>feed2exec.model.Feed.parse()</u> function to manually parse a feed and fire your plugin. This is how email
          functionality is tested: see the <b>feed2exec.tests.test_plugins.test_email()</b> function for an example.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man1/feed2exec.1.html">feed2exec</a>(1)</b>

</pre><h4><b>AUTHOR</b></h4><pre>
       Antoine Beaupré

</pre><h4><b>COPYRIGHT</b></h4><pre>
       Copyright (C) 2016-2019  Antoine Beaupré

0.22.0                                            Mar 03, 2025                              <u><a href="../man1/FEED2EXEC-PLUGINS.1.html">FEED2EXEC-PLUGINS</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>