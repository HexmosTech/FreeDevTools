<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pmie_check, pmie_daily - administration of the Performance Co-Pilot inference engine</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/pcp">pcp_6.3.3-1_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       <b>pmie_check</b>, <b>pmie_daily</b> - administration of the Performance Co-Pilot inference engine

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>$PCP_BINADM_DIR/pmie_check</b> [<b>-CNPpsTV?</b>]  [<b>-c</b> <u>control</u>] [<b>-l</b> <u>logfile</u>]
       <b>$PCP_BINADM_DIR/pmie_daily</b>  [<b>-NV?</b>]   [<b>-c</b>  <u>control</u>] [<b>-k</b> <u>discard</u>] [<b>-l</b> <u>logfile</u>] [<b>-m</b> <u>addresses</u>] [<b>-x</b> <u>compress</u>]
       [<b>-X</b> <u>program</u>] [<b>-Y</b> <u>regex</u>]

</pre><h4><b>DESCRIPTION</b></h4><pre>
       This series of shell scripts and associated control files may be used to create a  customized  regime  of
       administration and management for the Performance Co-Pilot (see <b><a href="../man1/PCPIntro.1.html">PCPIntro</a></b>(1)) inference engine, <b><a href="../man1/pmie.1.html">pmie</a></b>(1).

       <b>pmie_check</b>  may  be  run  at  any  time  of  the day and verifies that a desired set of <b>pmie</b> processes is
       running.  If not, it (re-)starts any missing inference engine processes.

       <b>pmie_daily</b> is intended to be run once per day, preferably in the early morning, as soon after midnight as
       practicable.  Its task is to rotate the log files for the running <b>pmie</b> processes - these files  may  grow
       without  bound  if  the  ``print''  action  is used, or any other <b>pmie</b> action writes to its stdout/stderr
       streams.  After some period, old <b>pmie</b> log files are discarded.

</pre><h4><b>OPTIONS</b></h4><pre>
       The available command line options are:

       <b>-c</b> <u>control</u>, <b>--control</b>=<u>control</u>
            Both <b>pmie_check</b> and <b>pmie_daily</b> are controlled by PCP inference engine control file(s)  that  specify
            the  <b>pmie</b>  instances  to  be  managed.   The  default  <u>control</u>  file is <b>$PCP_PMIECONTROL_PATH</b> but an
            alternate may be specified using the <b>-c</b> option.  If the  directory  <b>$PCP_PMLOGGERCONTROL_PATH</b>.d  (or
            <u>control</u>.d from the <b>-c</b> option) exists, then the contents of any additional <u>control</u> files therein will
            be appended to the main control file (which must exist).

       <b>-C</b>   This  option  causes  <b>pmie_check</b>  to query the system service runlevel information for <b>pmie</b>, and use
            that to determine whether to start processes or not.

       <b>-k</b> <u>period</u>, <b>--discard</b>=<u>period</u>
            The log retention <u>period</u> is 14 days by default, but this may be  changed  using  this  option.   Two
            special  values  are  recognized  for  the  discard <u>period</u>, namely <b>0</b> to keep no log files beyond the
            current one, and <b>forever</b> to prevent any log files being discarded.

       <b>-l</b> <u>file</u>, <b>--logfile</b>=<u>file</u>
            In order to ensure that mail is not unintentionally sent when these scripts  are  run  from  <b><a href="../man8/cron.8.html">cron</a></b>(8)
            diagnostics    are    always    sent    to    log    files.     By    default,   these   files   are
            <b>$PCP_LOG_DIR/pmie/pmie_daily.log</b> and <b>$PCP_LOG_DIR/pmie/pmie_check.log</b> but this can be changed  using
            the  <b>-l</b>  option.   If this log <u>file</u> already exists when the script starts, it will be renamed with a
            <u>.prev</u> suffix (overwriting any log file saved earlier) before diagnostics are generated  to  the  new
            log file.

       <b>-m</b> <u>addresses</u>, <b>--mail</b>=<u>addresses</u>
            Use  of  this  option  causes  <b>pmie_daily</b>  to construct a summary of the log files generated for all
            monitored hosts in the last 24 hours (lines matching `` OK '' are culled), and e-mail  that  summary
            to the set of space-separated <u>addresses</u>.

       <b>-N</b>, <b>--showme</b>
            This  option enables a ``show me'' mode, where the programs actions are echoed, but not executed, in
            the style of ``make -n''.  Using <b>-N</b> in conjunction with <b>-V</b> maximizes the diagnostic capabilities for
            debugging.

       <b>-s</b>, <b>--stop</b>
            Use of this option provides the reverse <b>pmie_check</b> functionality, allowing the set of <b>pmie</b> processes
            to be cleanly shutdown.

       <b>-p</b>, <b>--skip-primary</b>
            If this option is specified for <b>pmie_check</b> then any line from the control files for the <u>primary</u> <b>pmie</b>
            will be ignored.   This  option  is  intended  for  environments  where  some  system  daemon,  like
            <b><a href="../man1/systemd.1.html">systemd</a></b>(1), is responsible for controlling (starting, stopping, restarting, etc.) the <u>primary</u> <b>pmie</b>.

       <b>-P</b>, <b>--only-primary</b>
            If  this  option  is  specified for <b>pmie_check</b> then only the primary pmie entry in the control files
            will be processed.  This is the logical opposite of the <b>-p</b> option described above  and  is  intended
            for  use  by RC scripts that start only the primary pmie, such as the <b>pmie.service</b> unit.  The <b>-p</b> and
            <b>-P</b> options to <b>pmie_check</b> are mutually exclusive.

       <b>-T</b>, <b>--terse</b>
            This option to <b>pmie_check</b> produces less verbose output than the default.  This is most suitable  for
            a <u>pmie</u> ``farm'' where many instances of <u>pmie</u> are expected to be running.

       <b>-V</b>, <b>--verbose</b>
            The output from the <b>cron</b> execution of the scripts may be extended using the <b>-V</b> option to the scripts
            which  will  enable  verbose  tracing  of their activity.  By default the scripts generate no output
            unless some error or warning condition is encountered.  Using <b>-N</b> in conjunction  with  <b>-V</b>  maximizes
            the diagnostic capabilities for debugging.

       <b>-x</b> <u>period</u>, <b>--compress-after</b>=<u>period</u>
            Log  files  can  optionally  be  compressed  after  some  <u>period</u>  to  conserve  disk space.  This is
            particularly useful for large numbers of <b>pmie</b> processes under the control  of  <b>pmie_check</b>.   The  <b>-x</b>
            option specifies the number of days after which to compress archive data files.

       <b>-X</b> <u>program</u>, <b>--compressor</b>=<u>program</u>
            This option specifies the program to use for compression - by default this is <b><a href="../man1/xz.1.html">xz</a></b>(1).

       <b>-Y</b> <u>regex</u>, <b>--regex</b>=<u>regex</u>
            This  option  allows  a regular expression to be specified causing files in the set of files matched
            for compression to be omitted - this allows only the data file to be compressed, and  also  prevents
            the program from attempting to compress it more than once.  The default <u>regex</u> is
            "\.(meta|index|Z|gz|bz2|zip|xz|lzma|lzo|lz4|zst)$"
            - such files are filtered using the <b>-v</b> option to <b><a href="../man1/egrep.1.html">egrep</a></b>(1).

       <b>-?</b>, <b>--help</b>
            Display usage message and exit.

</pre><h4><b>CONFIGURATION</b></h4><pre>
       <b>Warning</b>:  The  <b>$PCP_PMIECONTROL_PATH</b>  and  <b>$PCP_PMIECONTROL_PATH</b>.d files must not be writable by any user
       other than root.

       The control file(s) should be customized according to the following rules that  define  for  the  current
       version (1.1) of the control file format.

       1.  Lines beginning with a ``#'' are comments.
       2.  Lines  beginning  with a ``$'' are assumed to be assignments to environment variables in the style of
           <b><a href="../man1/sh.1.html">sh</a></b>(1), and all text following the ``$'' will be <b>eval</b>'ed by the script reading the control  file,  and
           the  corresponding  variable  exported  into the environment.  This is particularly useful to set and
           export variables into the environment of the administrative script, e.g.
               $ PMCD_CONNECT_TIMEOUT=20
       3.  There <b>must</b> be a version line in the initial control file of the form:
               $ version=1.1
       4.  There should be one line in the control file(s) for each <b>pmie</b> instance of the form:

               <u>host</u> <b>y</b>|<b>n</b> <b>y</b>|<b>n</b> <u>logfile</u> <u>args</u>

       5.  Fields within a line of the control file(s) are separated by one or more spaces or tabs.
       6.  The <u>first</u> field is the name of the host that is the default source of  the  performance  metrics  for
           this <b>pmie</b> instance.
       7.  The  <u>second</u>  field  indicates  if  this is a <u>primary</u> <b>pmie</b> instance (<b>y</b>) or not (<b>n</b>).  Since the primary
           inference engine must run on the local host, and there may be at most one primary  for  a  particular
           host, this field can be <b>y</b> for at most one <b>pmie</b> instance, in which case the host name must be the name
           of  the  local  host.   When  generating  <b>pmie</b> configuration files, the primary clause indicates that
           <b><a href="../man1/pmieconf.1.html">pmieconf</a></b>(1) should enable all rules in the primary group, in addition to all other default rules.
       8.  The <u>third</u> field indicates whether this <b>pmie</b> instance  needs  to  be  started  under  the  control  of
           <b><a href="../man1/pmsocks.1.html">pmsocks</a></b>(1) to connect to a <b>pmcd</b> through a firewall (<b>y</b> or <b>n</b>).
       9.  The  <u>fourth</u>  field  is  the  name  of  the  <b>pmie</b> activity log file.  A useful convention is that <b>pmie</b>
           instances  monitoring  the  local  host  with  hostname  <u>myhost</u>  are  maintained  in  the   directory
           <b>$PCP_LOG_DIR/pmie/</b><u>myhost</u>,  while  activity  logs  for  the  remote  host  <u>mumble</u>  are  maintained  in
           <b>$PCP_LOG_DIR/pmie/</b><u>mumble</u>.  This is consistent with the way <b><a href="../man1/pmlogger.1.html">pmlogger</a></b>(1) maintains  its  activity  logs
           and archive files.
       10. All  other fields are interpreted as arguments to be passed to <b><a href="../man1/pmie.1.html">pmie</a></b>(1).  Most typically this would be
           the <b>-c</b> option.

       The following sample control lines specify one <b>pmie</b> instance monitoring  the  local  host  (<u>wobbly</u>),  and
       another monitoring performance metrics from the host <u>splat</u>.

       wobbly  n  PCP_LOG_DIR/pmie/wobbly  -c config.default
       splat   n  PCP_LOG_DIR/pmie/splat   -c splat/cpu.conf

       Typical   <b><a href="../man5/crontab.5.html">crontab</a></b>(5)   entries  for  periodic  execution  of  <b>pmie_daily</b>  and  <b>pmie_check</b>  are  given  in
       <b>$PCP_SYSCONF_DIR/pmie/crontab</b> (unless installed by default in <u><a href="file:/etc/cron.d">/etc/cron.d</a></u> already) and shown below.

       # daily processing of pmie logs
       08      0       *       *       *       $PCP_BINADM_DIR/pmie_daily
       # every 30 minutes, check pmie instances are running
       28,58   *       *       *       *       $PCP_BINADM_DIR/pmie_check
       When using <b><a href="../man1/systemd.1.html">systemd</a></b>(1) on Linux, no <b>crontab</b> entries are needed as the timer mechanism provided by  <b>systemd</b>
       is used instead.

       The  <b><a href="../man1/pmiectl.1.html">pmiectl</a></b>(1)  utility  may  invoke  <b>pmie_check</b> using the <b><a href="../man1/sudo.1.html">sudo</a></b>(1) command to run it under the $PCP_USER
       ``pcp'' account.  If <b>sudo</b> is configured with the non-default <u>requiretty</u> option  (see  below),  <b>pmie_check</b>
       may  fail  to run due to not having a tty configured.  This issue can be resolved by adding a second line
       (expand $PCP_BINADM_DIR according to your platform) to the <u><a href="file:/etc/sudoers">/etc/sudoers</a></u> configuration file as follows:

            Defaults requiretty
            Defaults!$PCP_BINADM_DIR/pmie_check !requiretty

       Note that the unprivileged PCP account under which these commands run uses <u><a href="file:/sbin/nologin">/sbin/nologin</a></u> as the shell, so
       the <u>requiretty</u> option is ineffective here and safe to disable in this way.

</pre><h4><b>FILES</b></h4><pre>
       <u>$PCP_PMIECONTROL_PATH</u>
            the default PCP inference engine control file
            <b>Warning</b>: this file must not be writable by any user other than root.

       <u>$PCP_PMIECONTROL_PATH.d</u>
            optional directory containing additional PCP inference engine control files, typically one per host
            <b>Warning</b>: this files herein must not be writable by any user other than root.

       <u>$PCP_SYSCONF_DIR/pmie/crontab</u>
            sample crontab for automated script execution by $PCP_USER (or root) - exists only if  the  platform
            does not support the <u><a href="file:/etc/cron.d">/etc/cron.d</a></u> mechanism.

       <u>$PCP_VAR_DIR/config/pmie/config.default</u>
            default  <b>pmie</b>  configuration  file  location  for  a localhost inference engine, typically generated
            automatically by <b><a href="../man1/pmieconf.1.html">pmieconf</a></b>(1).

       <u>$PCP_LOG_DIR/pmie/pmie_check.log</u>
            default location for the <b>pmie_check</b> log file.  When run as a daemon service,  if  the  <b>pmie</b>  process
            failed  to  start  or  exited  early,  there may be error messages in this file, particularly if the
            daemon could not open it's own log file.

       <u>$PCP_LOG_DIR/pmie/pmie_daily.log</u>
            default location for error messages generated during the daily <b>pmie</b> service maintenance operations.

       <u>$PCP_LOG_DIR/pmie/&lt;hostname&gt;</u>
            default directory location for the pmie log file for the host <u>hostname</u>

       <u>$PCP_LOG_DIR/pmie/&lt;hostname&gt;/lock</u>
            transient lock file to guarantee mutual exclusion during <b>pmie</b> administration for the host <u>hostname</u> -
            if present, can be safely removed if neither <b>pmie_daily</b> nor <b>pmie_check</b> are running

       <u>$PCP_LOG_DIR/NOTICES</u>
            PCP ``notices'' file used by <b><a href="../man1/pmie.1.html">pmie</a></b>(1) and friends

</pre><h4><b>PCP</b> <b>ENVIRONMENT</b></h4><pre>
       Environment variables with the prefix <b>PCP_</b> are used to parameterize the file and directory names used  by
       PCP.   On  each  installation, the file <u>/etc/pcp.conf</u> contains the local values for these variables.  The
       <b>$PCP_CONF</b> variable may be used to specify an alternative configuration file, as described in <b><a href="../man5/pcp.conf.5.html">pcp.conf</a></b>(5).

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man1/egrep.1.html">egrep</a></b>(1), <b><a href="../man1/PCPIntro.1.html">PCPIntro</a></b>(1), <b><a href="../man1/pmie.1.html">pmie</a></b>(1), <b><a href="../man1/pmieconf.1.html">pmieconf</a></b>(1), <b><a href="../man1/systemd.1.html">systemd</a></b>(1), <b><a href="../man1/xz.1.html">xz</a></b>(1) and <b><a href="../man8/cron.8.html">cron</a></b>(8).

Performance Co-Pilot                                   PCP                                         <u><a href="../man1/PMIE_CHECK.1.html">PMIE_CHECK</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>