<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pkcshsm_mk_change  - utility to manage and control the re-enciphering of secure keys for a concurrent HSM</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/opencryptoki">opencryptoki_3.24.0+git20250128.0462717+dfsg-0ubuntu1_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       pkcshsm_mk_change  - utility to manage and control the re-enciphering of secure keys for a concurrent HSM
       master key change for openCryptoki.

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>pkcshsm_mk_change</b> <u>command</u> [<b>OPTIONS</b>]

       <b>pkcshsm_mk_change</b> <b>--help</b>|<b>-h</b>

</pre><h4><b>DESCRIPTION</b></h4><pre>
       Manages and controls the re-enciphering of secure keys  for  a  concurrent  HSM  master  key  change  for
       openCryptoki.  Secure  keys are encrypted by the HSM master key(s). The HSM master key(s) must be changed
       (rolled) from time to time, dependent on policies defined by the HSM security  officer.  Whenever  a  HSM
       master  key is changed, all secure keys that are encrypted with that HSM master key must be re-enciphered
       with the new to be set master key.

       Changing HSM master keys needs to be coordinated between the HSM security  officer  and  an  openCryptoki
       administrator.  The  HSM  security  officer performs a master key change via the TKE (Trusted Key Entry),
       while the openCryptoki administrator performs administrative steps using the  <b>pkcshsm_mk_change</b>  tool  to
       re-encipher  all openCryptoki token and session key objects, as well as currently active crypto operation
       states with the new master key. Applications using those keys can continue  to  run,  the  re-enciphering
       process  takes  place  transparently  to them.  <b>Important:</b> <b>CCA</b> <b>does</b> <b>not</b> <b>support</b> <b>the</b> <b>concept</b> <b>of</b> <b>APQNs</b> <b>when</b>
       <b>running</b> <b>on</b> <b>AIX,</b> <b>Linux</b> <b>on</b> <b>x64,</b> <b>and</b> <b>Linux</b> <b>on</b> <b>Power;</b> <b>whenever</b> <b>an</b> <b>APQN</b> <b>is</b> <b>being</b> <b>used</b> <b>as</b> <b>input,</b> <b>the</b> <b>user</b>  <b>must</b>
       <b>specify</b> <b>the</b> <b>value</b> <b>0.0.</b>

       A concurrent master key change works as follows:

         1. The HSM security officer loads the new master keys using the TKE into the NEW register of the set of
            APQNs logically belonging together.

         2. The  HSM  security  officer  notifies  the openCryptoki administrator that new master keys have been
            loaded for all the APQNs.

         3. The openCryptoki administrator uses the <b>pkcshsm_mk_change</b>  to  initiate  a  master  key  change  for
            openCryptoki,  specifying  the  set  of  APQNs  (and  master  key types) that are to be changed. The
            <b>pkcshsm_mk_change</b> tool communicates with running applications and performs/controls  re-encipherment
            of the key objects with the new master key.

         4. When  the  <b>pkcshsm_mk_change</b>  tool  has  completed  its re-encipherment processing, the openCryptoki
            administrator notifies the HSM security officer that openCryptoki is ready to set/activate  the  new
            master keys.

         5. The  HSM  security officer coordinates with other (non-openCryptoki) applications and once all users
            of the APQNs are OK, he sets/activates the new master keys on the APQNs.

         6. The HSM security officer notifies the openCyptoki administrator when for all APQNs  the  new  master
            key have been set/activated.

         7. The openCryptoki administrator uses the <b>pkcshsm_mk_change</b> tool to finalize the master key change for
            openCryptoki.  The  tool communicates with running applications and performs/controls finalizing the
            re-encipherment of the key objects with the new master key.

         8. When the <b>pkcshsm_mk_change</b> tool has completed its  finalizing  processing,  the  master  key  change
            operation is complete.

       The whole procedure can take an arbitrary amount of time. Especially the time between the moment when the
       new  master  key  has  been loaded on all APQNs, and the moment the new master keys are set/activated can
       even  last  several  days,  due  to  time  required  for  coordination  with   other   (non-openCryptoki)
       applications/users of the APQNs to prepare for the master key change.

       The  time  to  perform  the  re-encipherment  and finalization (steps 3 and 7) of all key objects as such
       depends on the amount of keys and openCryptoki applications using them, but is usually relatively  short,
       i.e. seconds up to a few minutes.

       The  system  where openCryptoki runs may be restarted while a master key change is ongoing, provided that
       the re-encipherment and finalization steps (steps 3 and 7) are not interrupted.

       An ongoing master key change operation can be canceled using the <b>pkcshsm_mk_change</b> tool, as long  as  for
       none of the APQNs the new master key has been set/activated, that is up to step 5 from above.

</pre><h4><b>COMMANDS</b></h4><pre>
   <b>Initiate</b> <b>a</b> <b>master</b> <b>key</b> <b>change</b> <b>for</b> <b>openCryptoki</b>
       <b>pkcshsm_mk_change</b>   <b>reencipher</b>   [<b>--apqns</b>|<b>-a</b>   <u>APQNS</u>]   [<b>--ep11-wkvp</b>|<b>-e</b>  <u>WKVP</u>]  [<b>--cca-sym-mkvp</b>|<b>-s</b>  <u>MKVP</u>]
       [<b>--cca-asym-mkvp</b>|<b>-S</b> <u>MKVP</u>] [<b>--cca-aes-mkvp</b>|<b>-A</b> <u>MKVP</u>] [<b>--cca-apka-mkvp</b>|<b>-p</b> <u>MKVP</u>] [<b>--verbose</b>|<b>-v</b> <u>LEVEL</u>]

       Use the <b>reencipher</b> command to initiate a master key change operation for the specified APQNs  and  master
       key  types  and re-encipher all session and token key objects of the affected tokens. For each master key
       type that is changed, the verification pattern of the new, to be set master key must be specified.

       A CryptoExpress adapter in <b>CCA</b> coprocessor mode has 4 different master keys: <b>SYM</b>, <b>ASYM</b>,  <b>AES</b>,  and  <b>APKA</b>.
       The  CCA  token  of  openCryptoki  only  uses  SYM,  AES,  and  APKA.  Each master key type can be change
       individually, or together with others. You can use the TKE or the <b>panel.exe</b> tool to query the master  key
       verification patterns: <b>'panel.exe</b> <b>--mk-query</b> <b>--mktype=&lt;type&gt;</b> <b>--mkregister=NEW'.</b>  For master key types <b>SYM</b>
       and  <b>ASYM</b>, use the hex string under <b>[RND]</b>, for types <b>AES</b> and <b>APKA</b> use the hex string under <b>[VER]</b>. For AES
       and   APKA   you   can   also   find   the   master   key   verification   patterns   in   sysfs:    <b>'cat</b>
       <b>/sys/bus/ap/devices/&lt;card&gt;.&lt;domain&gt;/mkvps'.</b>

       A  CryptoExpress  adapter  in <b>EP11</b> coprocessor mode has only one master key, called the EP11 wrapping key
       (WK). You can use the TKE or the <b>ep11info</b> tool to query the current  wrapping  key  verification  pattern
       (WKVP)  of  an  EP11  APQN:  <b>'ep11info</b>  <b>-m</b> <b>&lt;adapter&gt;</b> <b>-d</b> <b>&lt;domain&gt;</b> <b>-D'.</b>  You can also find the wrapping key
       verification pattern for EP11 APQNs in sysfs: <b>'cat</b> <b>/sys/bus/ap/devices/&lt;card&gt;.&lt;domain&gt;/mkvps'.</b>

       the <b>pkcshsm_mk_change</b> <b>reencipher</b> command will query all available slots and determine if the token in the
       slot is affected by the master key change, based on the list of APQNs and  master  key  types.  For  each
       affected slot, it prompts for the <b>USER</b> <b>pin</b>.

       On  successful completion, the id of the master key change operation is displayed.  This id must later be
       specified when finalizing or canceling the operation using the <b>finalize</b> or <b>cancel</b> command.

   <b>Finalize</b> <b>a</b> <b>master</b> <b>key</b> <b>change</b> <b>for</b> <b>openCryptoki</b>
       <b>pkcshsm_mk_change</b> <b>finalize</b> [<b>--id</b>|<b>-i</b> <u>OPERATION-ID</u>] [<b>--verbose</b>|<b>-v</b> <u>LEVEL</u>]

       Use the <b>finalize</b> command to finalize a master key change operation when  the  new  master  key  has  been
       activated on the APQNs. The id of the master key change operation to finalize must be specified.

   <b>Cancel</b> <b>a</b> <b>master</b> <b>key</b> <b>change</b> <b>for</b> <b>openCryptoki</b>
       <b>pkcshsm_mk_change</b> <b>cancel</b> [<b>--id</b>|<b>-i</b> <u>OPERATION-ID</u>] [<b>--verbose</b>|<b>-v</b> <u>LEVEL</u>]

       Use  the  <b>cancel</b>  command  to  finalize  a  master key change operation.  The id of the master key change
       operation to cancel must be specified.  A master key change operation can only be canceled as long as for
       none of the APQNs the new master key have been set/activated.

   <b>List</b> <b>master</b> <b>key</b> <b>change</b> <b>operations</b>
       <b>pkcshsm_mk_change</b> <b>list</b> [<b>--id</b>|<b>-i</b> <u>OPERATION-ID</u>] [<b>--verbose</b>|<b>-v</b> <u>LEVEL</u>]

       Use the <b>list</b> command to list currently active master  key  change  operations.  If  no  operation  ID  is
       specified,  all currently active master key change operations are displayed, otherwise only the specified
       one is displayed.

</pre><h4><b>OPTIONS</b></h4><pre>
       <b>-a</b>, <b>--apqns</b> <u>APQNS</u>
              Specifies a comma separated list of APQNs for which a master key change is to be  performed.  Each
              APQN  must  be  specified  in  the  form   <b>card.domain</b>,  where both <b>card</b> and <b>domain</b> are in hex, as
              displayed by the <b>lszcrypt</b> command. Multiple APQNs are separated by a comma.  This options is  only
              valid with the <b>reencipher</b> command.

       <b>-e</b>, <b>--ep11-wkvp</b> <u>WKVP</u>
              Specifies  the  EP11  wrapping key verification pattern (WKVP) of the new, to be set EP11 wrapping
              key as a 16 bytes hex string.  This options is only valid with the <b>reencipher</b>  command.   You  can
              use  the TKE or the <b>ep11info</b> tool to query the current wrapping key verification pattern (WKVP) of
              an EP11 APQN: <b>'ep11info</b> <b>-m</b> <b>&lt;adapter&gt;</b> <b>-d</b>  <b>&lt;domain&gt;</b>  <b>-D'.</b>   You  can  also  find  the  wrapping  key
              verification pattern for EP11 APQNs in sysfs: <b>'cat</b> <b>/sys/bus/ap/devices/&lt;card&gt;.&lt;domain&gt;/mkvps'.</b>

       <b>-s</b>, <b>--cca-sym-mkvp</b> <u>MKVP</u>
              Specifies  the CCA master key verification pattern (MKVP) of the new, to be set CCA SYM master key
              as a 8 bytes hex string.  This options is only valid with the <b>reencipher</b> command.  You can use the
              TKE or the <b>panel.exe</b> tool to query the master key  verification  patterns:  <b>'panel.exe</b>  <b>--mk-query</b>
              <b>--mktype=SYM</b> <b>--mkregister=NEW'.</b>  Use the hex string under <b>[RND]</b>.

       <b>-S</b>, <b>--cca-asym-mkvp</b> <u>MKVP</u>
              Specifies the CCA master key verification pattern (MKVP) of the new, to be set CCA ASYM master key
              as a 8 bytes hex string.  This options is only valid with the <b>reencipher</b> command.  You can use the
              TKE  or  the  <b>panel.exe</b>  tool to query the master key verification patterns: <b>'panel.exe</b> <b>--mk-query</b>
              <b>--mktype=ASYM</b> <b>--mkregister=NEW'.</b>  Use the hex string under <b>[RND]</b>.

       <b>-A</b>, <b>--cca-aes-mkvp</b> <u>MKVP</u>
              Specifies the CCA master key verification pattern (MKVP) of the new, to be set CCA AES master  key
              as a 8 bytes hex string.  This options is only valid with the <b>reencipher</b> command.  You can use the
              TKE  or  the  <b>panel.exe</b>  tool to query the master key verification patterns: <b>'panel.exe</b> <b>--mk-query</b>
              <b>--mktype=AES</b> <b>--mkregister=NEW'.</b>  Use the hex string under <b>[VER]</b>.  You can also find the AES master
              key verification patterns in sysfs: <b>'cat</b> <b>/sys/bus/ap/devices/&lt;card&gt;.&lt;domain&gt;/mkvps'.</b>

       <b>-p</b>, <b>--cca-apka-mkvp</b> <u>MKVP</u>
              Specifies the CCA master key verification pattern (MKVP) of the new, to be set CCA APKA master key
              as a 8 bytes hex string.  This options is only valid with the <b>reencipher</b> command.  You can use the
              TKE or the <b>panel.exe</b> tool to query the master key  verification  patterns:  <b>'panel.exe</b>  <b>--mk-query</b>
              <b>--mktype=APKA</b>  <b>--mkregister=NEW'.</b>   Use  the  hex  string under <b>[VER]</b>.  You can also find the APKA
              master key verification patterns in sysfs: <b>'cat</b> <b>/sys/bus/ap/devices/&lt;card&gt;.&lt;domain&gt;/mkvps'.</b>

       <b>-i</b>, <b>--id</b> <u>OPERATION-ID</u>
              Specifies the id of the master key change operation for the <b>finalize</b>, <b>cancel</b>, or <b>list</b> command.  On
              successful  completion  of  the  <b>reencipher</b>  command, the id of the master key change operation is
              displayed.

       <b>-v</b>, <b>--verbose</b> <u>LEVEL</u>
              Specifies the verbose level (optional): <b>none</b> (default), <b>error</b>, <b>warn</b>, <b>info</b>, <b>devel</b>, or <b>debug</b>.

       <b>-h</b>, <b>--help</b>
              Displays help text and exits.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man7/opencryptoki.7.html">opencryptoki</a></b>(7)

3.24                                               August 2022                              <u><a href="../man1/PKCSHSM_MK_CHANGE.1.html">PKCSHSM_MK_CHANGE</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>