<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>systemd-measure - Pre-calculate and sign expected TPM2 PCR 11 values for booted unified kernel images</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/systemd">systemd_257.4-1ubuntu3.1_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       systemd-measure - Pre-calculate and sign expected TPM2 PCR 11 values for booted unified kernel images

</pre><h4><b>SYNOPSIS</b></h4><pre>

       <b><a href="file:/usr/lib/systemd/systemd-measure">/usr/lib/systemd/systemd-measure</a></b> [OPTIONS...]

</pre><h4><b>DESCRIPTION</b></h4><pre>
       Note: this command is experimental for now. While it is likely to become a regular component of systemd,
       it might still change in behaviour and interface.

       <b>systemd-measure</b> is a tool that may be used to pre-calculate and sign the expected TPM2 PCR 11 values that
       should be seen when a Linux <b>Unified</b> <b>Kernel</b> <b>Image</b> <b>(UKI)</b>[1] based on <b><a href="../man7/systemd-stub.7.html">systemd-stub</a></b>(7) is booted up. It
       accepts paths to the ELF kernel image file, initrd image file, devicetree file, kernel command line file,
       <b><a href="../man5/os-release.5.html">os-release</a></b>(5) file, boot splash file, and TPM2 PCR PEM public key file that make up the unified kernel
       image, and determines the PCR values expected to be in place after booting the image. Calculation starts
       with a zero-initialized PCR 11, and is executed in a fashion compatible with what systemd-stub does at
       boot. The result may optionally be signed cryptographically, to allow TPM2 policies that can only be
       unlocked if a certain set of kernels is booted, for which such a PCR signature can be provided.

       It usually doesn't make sense to call this tool directly when constructing a UKI. Instead, <b><a href="../man1/ukify.1.html">ukify</a></b>(1)
       should be used; it will invoke <b>systemd-measure</b> and take care of embedding the resulting measurements into
       the UKI.

</pre><h4><b>COMMANDS</b></h4><pre>
       The following commands are understood:

       <b>status</b>
           This is the default command if none is specified. This queries the local system's TPM2 PCR 11 values
           and displays them. The data is written in a similar format as the <b>calculate</b> command below, and may be
           used to quickly compare expectation with reality.

           Added in version 252.

       <b>calculate</b>
           Pre-calculate the expected values seen in PCR register 11 after boot-up of a unified kernel image
           consisting of the components specified with <b>--linux=</b>, <b>--osrel=</b>, <b>--cmdline=</b>, <b>--initrd=</b>, <b>--ucode=</b>,
           <b>--splash=</b>, <b>--dtb=</b>, <b>--uname=</b>, <b>--sbat=</b>, <b>--pcrpkey=</b>, <b>--profile=</b>, <b>--dtbauto=</b>, <b>--hwids=</b>, see below. Only
           <b>--linux=</b> is mandatory. (Alternatively, specify <b>--current</b> to use the current values of PCR register 11
           instead.)

           Added in version 252.

       <b>sign</b>
           As with the <b>calculate</b> command, pre-calculate the expected value seen in TPM2 PCR register 11 after
           boot-up of a unified kernel image. Then, cryptographically sign the resulting values with the
           private/public key pair (RSA) configured via <b>--private-key=</b> and <b>--public-key=</b>. This will write a JSON
           object to standard output that contains signatures for all specified PCR banks (see the <b>--bank=</b>
           option below), which may be used to unlock encrypted credentials (see <b><a href="../man1/systemd-creds.1.html">systemd-creds</a></b>(1)) or LUKS
           volumes (see <b>systemd-cryptsetup@.<a href="../man8/service.8.html">service</a></b>(8)). This allows binding secrets to a set of kernels for
           which such PCR 11 signatures can be provided.

           Note that a TPM2 device must be available for this signing to take place, even though the result is
           not tied to any TPM2 device or its state.

           Added in version 252.

</pre><h4><b>OPTIONS</b></h4><pre>
       The following options are understood:

       <b>--linux=</b><u>PATH</u>, <b>--osrel=</b><u>PATH</u>, <b>--cmdline=</b><u>PATH</u>, <b>--initrd=</b><u>PATH</u>, <b>--ucode=</b><u>PATH</u>, <b>--splash=</b><u>PATH</u>, <b>--dtb=</b><u>PATH</u>,
       <b>--uname=</b><u>PATH</u>, <b>--sbat=</b><u>PATH</u>, <b>--pcrpkey=</b><u>PATH</u>, <b>--profile=</b><u>PATH</u>, <b>--dtbauto=</b><u>PATH</u>, <b>--hwids=</b><u>PATH</u>
           When used with the <b>calculate</b> or <b>sign</b> verb, configures the files to read the unified kernel image
           components from. Each option corresponds with the equally named section in the unified kernel PE
           file. The <b>--linux=</b> switch expects the path to the ELF kernel file that the unified PE kernel will
           wrap. All switches except <b>--linux=</b> are optional. Each option may be used at most once.

           Added in version 252.

           With the exception of <b>--profile=</b>, <b>--dtbauto=</b> and <b>--hwids=</b>, which have been added in version 257.

       <b>--current</b>
           When used with the <b>calculate</b> or <b>sign</b> verb, takes the PCR 11 values currently in effect for the system
           (which should typically reflect the hashes of the currently booted kernel). This can be used in place
           of <b>--linux=</b> and the other switches listed above.

           Added in version 252.

       <b>--bank=</b><u>DIGEST</u>
           Controls the PCR banks to pre-calculate the PCR values for – in case <b>calculate</b> or <b>sign</b> is invoked –,
           or the banks to show in the <b>status</b> output. May be used more then once to specify multiple banks. If
           not specified, defaults to the four banks "sha1", "sha256", "sha384", "sha512".

           Added in version 252.

       <b>--private-key=</b><u>PATH</u>, <b>--public-key=</b><u>PATH</u>, <b>--certificate=</b><u>PATH</u>
           These switches take paths to a pair of PEM encoded RSA key files, for use with the <b>sign</b> command.

           Note the difference between the <b>--pcrpkey=</b> and <b>--public-key=</b> switches. The former selects the data to
           include in the ".pcrpkey" PE section of the unified kernel image, the latter picks the public key of
           the key pair used to sign the resulting PCR 11 values. The former is the key that the booted system
           will likely use to lock disk and credential encryption to, the latter is the key used for unlocking
           such resources again. Hence, typically the same PEM key should be supplied in both cases.

           If the <b>--public-key=</b> is not specified but <b>--private-key=</b> is specified the public key is automatically
           derived from the private key.

           <b>--certificate=</b> can be used to specify an X.509 certificate as an alternative to <b>--public-key=</b> since
           v256.

           Added in version 252.

       <b>--private-key=</b><u>PATH/URI</u>, <b>--private-key-source=</b><u>TYPE</u><b>[:</b><u>NAME</u><b>]</b>, <b>--certificate=</b><u>PATH/URI</u>,
       <b>--certificate-source=</b><u>TYPE</u><b>[:</b><u>NAME</u><b>]</b>
           As an alternative to <b>--public-key=</b> for the <b>sign</b> command, these switches can be used to sign with an
           hardware token. The private key option can take a path or a URI that will be passed to the OpenSSL
           engine or provider, as specified by <b>--private-key-source=</b> as a type:name tuple, such as
           engine:pkcs11. The specified OpenSSL signing engine or provider will be used to sign.

           The <b>--certificate=</b> option also takes a path or a URI that will be passed to the OpenSSL provider, as
           specified by <b>--certificate-source=</b> as a "type:name" tuple, such as "provider:pkcs11". Note that
           unlike <b>--private-key-source=</b> this option only supports providers and not engines.

           Added in version 256.

       <b>--tpm2-device=</b><u>PATH</u>
           Controls which TPM2 device to use. Expects a device node path referring to the TPM2 chip (e.g.
           /dev/tpmrm0). Alternatively the special value "auto" may be specified, in order to automatically
           determine the device node of a suitable TPM2 device (of which there must be exactly one). The special
           value "list" may be used to enumerate all suitable TPM2 devices currently discovered.

           Added in version 252.

       <b>--phase=</b><u>PHASE</u>
           Controls which boot phases to calculate expected PCR 11 values for. This takes a series of
           colon-separated strings that encode boot "paths" for entering a specific phase of the boot process.
           Each of the specified strings is measured by the systemd-pcrphase-initrd.service,
           systemd-pcrphase-sysinit.service, and <b><a href="../man8/systemd-pcrphase.service.8.html">systemd-pcrphase.service</a></b>(8) into PCR 11 during different
           milestones of the boot process. This switch may be specified multiple times to calculate PCR values
           for multiple boot phases at once. If not used defaults to "enter-initrd",
           "enter-initrd:leave-initrd", "enter-initrd:leave-initrd:sysinit",
           "enter-initrd:leave-initrd:sysinit:ready", i.e. calculates expected PCR values for the boot phase in
           the initrd, during early boot, during later boot, and during system runtime, but excluding the phases
           before the initrd or when shutting down. This setting is honoured both by <b>calculate</b> and <b>sign</b>. When
           used with the latter it's particularly useful for generating PCR signatures that can only be used for
           unlocking resources during specific parts of the boot process.

           For further details about PCR boot phases, see <b><a href="../man8/systemd-pcrphase.service.8.html">systemd-pcrphase.service</a></b>(8).

           Added in version 252.

       <b>--append=</b><u>PATH</u>
           When generating a PCR JSON signature (via the <b>sign</b> command), combine it with a previously generated
           PCR JSON signature, and output it as one. The specified path must refer to a regular file that
           contains a valid JSON PCR signature object. The specified file is not modified. It will be read
           first, then the newly generated signature appended to it, and the resulting object is written to
           standard output. Use this to generate a single JSON object consisting from signatures made with a
           number of signing keys (for example, to have one key per boot phase). The command will suppress
           duplicates: if a specific signature is already included in a JSON signature object it is not added a
           second time.

           Added in version 253.

       <b>--json=</b><u>MODE</u>
           Shows output formatted as JSON. Expects one of "short" (for the shortest possible output without any
           redundant whitespace or line breaks), "pretty" (for a pretty version of the same, with indentation
           and line breaks) or "off" (to turn off JSON output, the default).

       <b>--no-pager</b>
           Do not pipe output into a pager.

       <b>-h</b>, <b>--help</b>
           Print a short help text and exit.

       <b>--version</b>
           Print a short version string and exit.

</pre><h4><b>EXAMPLES</b></h4><pre>
       <b>Example</b> <b>1.</b> <b>Generate</b> <b>a</b> <b>unified</b> <b>kernel</b> <b>image,</b> <b>and</b> <b>calculate</b> <b>the</b> <b>expected</b> <b>TPM</b> <b>PCR</b> <b>11</b> <b>value</b>

           $ ukify build \
                --linux=vmlinux \
                --initrd=initrd.cpio \
                --os-release=@os-release.txt \
                --cmdline=@cmdline.txt \
                --splash=splash.bmp \
                --devicetree=devicetree.dtb \
                --measure \
                --output=vmlinux.efi
           11:sha1=d775a7b4482450ac77e03ee19bda90bd792d6ec7
           11:sha256=bc6170f9ce28eb051ab465cd62be8cf63985276766cf9faf527ffefb66f45651
           11:sha384=1cf67dff4757e61e5...7f49ad720be02fd07263e1f93061243aec599d1ee4b4
           11:sha512=8e79acd3ddbbc8282...0c3e8ec0c714821032038f525f744960bcd082d937da

       <b><a href="../man1/ukify.1.html">ukify</a></b>(1) internally calls <b>systemd-measure</b>. The output with hashes is from <b>systemd-measure</b>.

       <b>Example</b> <b>2.</b> <b>Generate</b> <b>a</b> <b>private/public</b> <b>key</b> <b>pair,</b> <b>a</b> <b>unified</b> <b>kernel</b> <b>image,</b> <b>and</b> <b>a</b> <b>TPM</b> <b>PCR</b> <b>11</b> <b>signature</b> <b>for</b> <b>it,</b>
       <b>and</b> <b>embed</b> <b>the</b> <b>signature</b> <b>and</b> <b>the</b> <b>public</b> <b>key</b> <b>in</b> <b>the</b> <b>image</b>

           $ openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048 -out tpm2-pcr-private-key.pem
           ..+.+++++++++......+.........+......+.......+....+.....+.+...+..........
           $ openssl rsa -pubout -in tpm2-pcr-private-key.pem -out tpm2-pcr-public-key.pem
           $ systemd-measure sign \
                --linux=vmlinux \
                --osrel=os-release.txt \
                --cmdline=cmdline.txt \
                --initrd=initrd.cpio \
                --splash=splash.bmp \
                --dtb=devicetree.dtb \
                --pcrpkey=tpm2-pcr-public-key.pem \
                --bank=sha1 \
                --bank=sha256 \
                --private-key=tpm2-pcr-private-key.pem \
                --public-key=tpm2-pcr-public-key.pem &gt;tpm2-pcr-signature.json
           $ ukify build \
                --linux=vmlinux \
                --initrd=initrd.cpio \
                --os-release=@os-release.txt \
                --cmdline=@cmdline.txt \
                --splash=splash.bmp \
                --devicetree=devicetree.dtb \
                --pcr-private-key=tpm2-pcr-private-key.pem \
                --pcr-public-key=tpm2-pcr-public-key.pem \
                --pcr-banks=sha1,sha256 \
                --output=vmlinuz.efi

       Later on, enroll the signed PCR policy on a LUKS volume:

           # systemd-cryptenroll --tpm2-device=auto \
                --tpm2-public-key=tpm2-pcr-public-key.pem \
                --tpm2-signature=tpm2-pcr-signature.json \
                --tpm2-pcrs="" \
                /dev/sda5

       And then unlock the device with the signature:

           # systemd-cryptsetup attach \
                volume5 /dev/sda5 - \
                tpm2-device=auto,tpm2-signature=/path/to/tpm2-pcr-signature.json

       Note that when the generated unified kernel image vmlinux.efi is booted, the signature and public key
       files will be placed at locations <b>systemd-cryptenroll</b> and <b>systemd-cryptsetup</b> will look for anyway, and
       thus these paths do not actually need to be specified.

       <b>Example</b> <b>3.</b> <b>Introduce</b> <b>a</b> <b>second</b> <b>public</b> <b>key,</b> <b>signing</b> <b>the</b> <b>same</b> <b>kernel</b> <b>PCR</b> <b>measurements,</b> <b>but</b> <b>only</b> <b>for</b> <b>the</b>
       <b>initrd</b> <b>boot</b> <b>phase</b>

       This example extends the previous one, but we now introduce a second signing key that is only used to
       sign PCR policies restricted to the initrd boot phase. This can be used to lock down root volumes in a
       way that they can only be unlocked before the transition to the host system. Thus we have two classes of
       secrets or credentials: one that can be unlocked during the entire runtime, and the other that can only
       be used in the initrd.

           $ openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048 -out tpm2-pcr-private-key.pem
           .+........+.+........+.......+...+...+........+....+......+..+..........
           $ openssl rsa -pubout -in tpm2-pcr-private-key.pem -out tpm2-pcr-public-key.pem
           $ openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048 -out tpm2-pcr-private-key-initrd.pem
           ..+.......++........+........+......+........+....+.....+.+..+..........
           $ openssl rsa -pubout -in tpm2-pcr-private-key-initrd.pem -out tpm2-pcr-public-key-initrd.pem
           $ ukify build \
                --linux=vmlinux-1.2.3 \
                --initrd=initrd.cpio \
                --os-release=@os-release.txt \
                --cmdline=@cmdline.txt \
                --splash=splash.bmp \
                --devicetree=devicetree.dtb \
                --pcr-private-key=tpm2-pcr-private-key.pem \
                --pcr-public-key=tpm2-pcr-public-key.pem \
                --phases=enter-initrd,enter-initrd:leave-initrd,enter-initrd:leave-initrd:sysinit,enter-initrd:leave-initrd:sysinit:ready \
                --pcr-banks=sha1,sha256 \
                --pcr-private-key=tpm2-pcr-private-key-initrd.pem \
                --pcr-public-key=tpm2-pcr-public-key-initrd.pem \
                --phases=enter-initrd \
                --uname=1.2.3 \
                --output=vmlinux-1.2.3.efi
           + <a href="file:/usr/lib/systemd/systemd-measure">/usr/lib/systemd/systemd-measure</a> sign --linux=vmlinux-1.2.3 \
           --osrel=os-release.txt --cmdline=cmdline.txt --dtb=devicetree.dtb \
           --splash=splash.bmp --initrd=initrd.cpio --bank=sha1 --bank=sha256 \
           --private-key=tpm2-pcr-private-key.pem --public-key=tpm2-pcr-public-key.pem \
           --phase=enter-initrd --phase=enter-initrd:leave-initrd \
           --phase=enter-initrd:leave-initrd:sysinit \
           --phase=enter-initrd:leave-initrd:sysinit:ready
           + <a href="file:/usr/lib/systemd/systemd-measure">/usr/lib/systemd/systemd-measure</a> sign --linux=vmlinux-1.2.3 \
           --osrel=os-release.txt --cmdline=cmdline.txt --dtb=devicetree.dtb \
           --splash=splash.bmp --initrd=initrd.cpio --bank=sha1 --bank=sha256 \
           --private-key=tpm2-pcr-private-key-initrd.pem \
           --public-key=tpm2-pcr-public-key-initrd.pem \
           --phase=enter-initrd
           Wrote unsigned vmlinux-1.2.3.efi

       <b>ukify</b> prints out both invocations of <b>systemd-measure</b> as informative output (the lines starting with "+");
       this allows us to see how <b>systemd-measure</b> is called. It then merges the output of both invocations into
       the ".pcrsig" section.  <b>systemd-measure</b> may also do this merge itself using the <b>--append=</b> option.

       Note that in this example the ".pcrpkey" PE section contains the key specified by the first
       <b>--pcr-private-key=</b> option, covering all boot phases. The ".pcrpkey" section is used in the default
       policies of <b>systemd-cryptenroll</b> and <b>systemd-creds</b>. To use the stricter policy bound to
       tpm2-pcr-public-key-initrd.pem, specify <b>--tpm2-public-key=</b> on the command line of those tools.

</pre><h4><b>EXIT</b> <b>STATUS</b></h4><pre>
       On success, 0 is returned, a non-zero failure code otherwise.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man1/systemd.1.html">systemd</a></b>(1), <b><a href="../man7/systemd-stub.7.html">systemd-stub</a></b>(7), <b><a href="../man1/ukify.1.html">ukify</a></b>(1), <b><a href="../man1/systemd-creds.1.html">systemd-creds</a></b>(1), <b>systemd-cryptsetup@.<a href="../man8/service.8.html">service</a></b>(8), <b><a href="../man8/systemdpcrphase.service.8.html">systemd-</a></b>
       <b><a href="../man8/systemdpcrphase.service.8.html">pcrphase.service</a></b>(8)

</pre><h4><b>NOTES</b></h4><pre>
        1. Unified Kernel Image (UKI)
           https://uapi-group.org/specifications/specs/unified_kernel_image/

systemd 257.4                                                                                 <u><a href="../man1/SYSTEMD-MEASURE.1.html">SYSTEMD-MEASURE</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>