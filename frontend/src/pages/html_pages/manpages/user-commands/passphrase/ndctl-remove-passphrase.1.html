<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ndctl-remove-passphrase - Stop a DIMM from locking at power-loss and requiring a passphrase to access</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/ndctl">ndctl_77-2.2ubuntu2_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       ndctl-remove-passphrase - Stop a DIMM from locking at power-loss and requiring a passphrase to access
       media

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <u>ndctl</u> <u>remove-passphrase</u> &lt;nmem0&gt; [&lt;nmem1&gt;..&lt;nmemN&gt;] [&lt;options&gt;]

</pre><h4><b>DESCRIPTION</b></h4><pre>
       Search the user keyring for an encrypted passphrase for the NVDIMM in question. If not found, attempt to
       load the passphrase blob. After disabling the passphrase, remove the <u>key-ID</u> from the keyring as well as
       the passphrase blob from the file system.

</pre><h4><b>OPTIONS</b></h4><pre>
       &lt;dimm&gt;
           A <u>nmemX</u> device name, or a dimm id number. Restrict the operation to the specified dimm(s). The
           keyword <u>all</u> can be specified to indicate the lack of any restriction, however this is the same as not
           supplying a --dimm option at all.

       -b, --bus=
           A bus id number, or a provider string (e.g. "ACPI.NFIT"). Restrict the operation to the specified
           bus(es). The keyword <u>all</u> can be specified to indicate the lack of any restriction, however this is
           the same as not supplying a --bus option at all.

       -v, --verbose
           Emit debug messages.

       -m, --master-passphrase
           Indicates that we are managing the master passphrase instead of the user passphrase.

</pre><h4><b>THEORY</b> <b>OF</b> <b>OPERATION</b></h4><pre>
       The Intel Device Specific Methods (DSM) specification v1.7 and v1.8 [1] introduced the following security
       management operations: enable passhprase, update passphrase, unlock DIMM, disable security, freeze
       security, secure (crypto) erase, overwrite, master passphrase enable, master passphrase update, and
       master passphrase secure erase.

       The security management for NVDIMMs is comprised of two parts. The front end uses the Linux key
       management framework (trusted and encrypted keys [2]) to store the encrypted passphrases in the
       kernel-managed keyring. The interface for this is the <u>keyutils</u> utility which uses the key management APIs
       in the Linux kernel. The back end takes the decrypted payload (which is the DIMM passphrase) and passes
       it to the DIMM.

       Unlike other DSMs which are composed by libndctl and sent to the kernel via an ioctl, the security DSMs
       are managed through the <u>security</u> sysfs attribute under the <u>dimm</u> device. A <u>key-ID</u> is written to the
       <u>security</u> attribute and the kernel pulls the associated key material from the user keyring that is
       maintained by the kernel.

       The security process begins with the generation of a <u>master</u> <u>key</u> that is used to seal (encrypt) the
       passphrase for the DIMM. There can either be one common <u>master</u> <u>key</u> that is used to encrypt every DIMM’s
       passphrase, or a separate key can be generated for each DIMM. The <u>master</u> <u>key</u> is also referred to as the
       <u>key-encryption-key</u> (kek). The <u>kek</u> can either be generated by the TPM (Trusted Platform Module) on the
       system, or alternatively, the <u>System</u> <u>Master</u> <u>Key</u> can also be used as the <u>kek</u>

       For testing purposes a user key with randomized payload can also be used as a <u>kek</u>. See [2] for details.
       To perform any security operations, it is expected that the <u>kek</u> has been added to the kernel’s user
       keyring as shown in example below:

           # keyctl show
           Session Keyring
            736023423 --alswrv      0     0  keyring: _ses
            675104189 --alswrv      0 65534   \_ keyring: _uid.0
            680187394 --alswrv      0     0       \_ trusted: nvdimm-master

       Before performing any of the security operations, all the regions associated with the DIMM in question
       need to be disabled. For the <u>overwrite</u> operation, in addition to the <u>regions</u>, the <u>dimm</u> also needs to be
       disabled.

       [1] <a href="http://pmem.io/documents/NVDIMM_DSM_Interface-V1.8.pdf">http://pmem.io/documents/NVDIMM_DSM_Interface-V1.8.pdf</a>
       [2] https://www.kernel.org/doc/Documentation/security/keys/trusted-encrypted.rst

       The following sub-sections describe specifics of each security feature.

   <b>UNLOCK</b>
       Unlock is performed by the kernel, however a preparation step must happen before the unlock DSM can be
       issued by the kernel. It is expected that from the initramfs, a setup command (ndctl <u>load-keys</u>) is
       executed before the libnvdimm module is loaded by modprobe. This command will inject the <u>kek</u> and the
       encrypted passphrases into the kernel’s user keyring. During the <u>probe</u> of the libnvdimm driver, it will:

        1. Check the security state of the device and see if the DIMM is locked

        2. Request the associated encrypted passphrase from the kernel’s user key ring

        3. Use the <u>kek</u> to decrypt the passphrase

        4. Create the unlock DSM, copy the decrypted payload into the DSM

        5. Issue the DSM to unlock the DIMM

       If the DIMM is already unlocked, the kernel will attempt to revalidate the passphrase. If we fail to
       revalidate the passphrase, the kernel will freeze the security and disallow any further security
       configuration changes. A kernel module parameter is available to override this behavior.

   <b>SETUP</b> <b>USER</b> <b>PASSPHRASE</b>
       To setup the passphrase for a DIMM, it is expected that the <u>kek</u> to be used is present in the kernel’s
       user keyring. The <u>kek</u> encrypts the DIMM passphrase using the <u>enc32</u> key format. The plaintext passphrase
       is never provided by or made visible to the user. It is instead randomly generated by the kernel and
       userspace does not have access to it. Upon encryption, a binary blob of the passphrase is written to the
       passphrase blob storage directory (/etc/ndctl/keys). The user is responsible for backing up the
       passphrase blobs to a secure location.

   <b>UPDATE</b> <b>USER</b> <b>PASSPHRASE</b>
       The update user passphrase operation uses the same DSM command as enable user passphrase. Most of the
       work is done on the key management side. The user has the option of providing a new <u>kek</u> for the new
       passphrase, but continuing to use the existing <u>kek</u> is also acceptable. The following operations are
       performed for <u>update-passphrase</u>:

        1. Remove the encrypted passphrase from the kernel’s user keyring.

        2. Rename the passphrase blob to old.

        3. Load this old passphrase blob into the keyring with an "old" name.

        4. Create the new passphrase and encrypt with the  <u>kek</u>.

        5. Send DSM with the old and new decrypted passphrases.

        6. Remove old passphrase and the passphrase blob from the keyring.

   <b>REMOVE</b> <b>USER</b> <b>PASSPHRASE</b>
       The <u>key-ID</u> for the passphrase to be removed is written to sysfs. The kernel then sends the DSM to disable
       security, and the passphrase is then removed from the keyring, and the associated passphrase blob is
       deleted.

   <b>CRYPTO</b> <b>(SECURE)</b> <b>ERASE</b>
       This operation is similar to remove-passphrase. The kernel issues a WBINVD instruction before and after
       the operation to ensure no data corruption from a stale CPU cache. Use ndctl’s sanitize-dimm command with
       the --crypto-erase option to perform this operation.

   <b>OVERWRITE</b>
       This is invoked using --overwrite option for ndctl <u>sanitize-dimm</u>. The overwrite operation wipes the
       entire NVDIMM. The operation can take a significant amount of time. NOTE: When the command returns
       successfully, it just means overwrite has been successfully started, and not that the overwrite is
       complete. Subsequently, 'ndctl wait-overwrite’can be used to wait for the NVDIMMs that are performing
       overwrite. Upon successful completion of an overwrite, the WBINVD instruction is issued by the kernel. If
       both --crypto-erase and --overwrite options are supplied, then crypto-erase is performed before
       overwrite.

   <b>SECURITY</b> <b>FREEZE</b>
       This operation does not require a passphrase. This will cause any security command other than a status
       query to be locked out until the next boot.

   <b>MASTER</b> <b>PASSPHRASE</b> <b>SETUP,</b> <b>UPDATE,</b> <b>and</b> <b>CRYPTO</b> <b>ERASE</b>
       These operations are similar to the user passphrase enable and update. The only difference is that a
       different passphrase is used. The master passphrase has no relation to the master key (<u>kek</u>) which is used
       for encryption of either passphrase.

</pre><h4><b>COPYRIGHT</b></h4><pre>
       Copyright © 2016 - 2022, Intel Corporation. License GPLv2: GNU GPL version 2
       <a href="http://gnu.org/licenses/gpl.html">http://gnu.org/licenses/gpl.html</a>. This is free software: you are free to change and redistribute it.
       There is NO WARRANTY, to the extent permitted by law.

</pre><h4><b>SEE</b> <b>ALSO:</b></h4><pre>
       <a href="../man1/ndctl-setup-passphrase.1.html">ndctl-setup-passphrase</a>(1), <a href="../man1/ndctl-update-passphrase.1.html">ndctl-update-passphrase</a>(1)

ndctl                                              2024-11-01                         <u><a href="../man1/NDCTL-REMOVE-PASSPHRASE.1.html">NDCTL-REMOVE-PASSPHRASE</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>