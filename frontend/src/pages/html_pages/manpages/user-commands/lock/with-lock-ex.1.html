<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>with-lock-ex - file locker</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/chiark-utils-bin">chiark-utils-bin_8.0.0_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       with-lock-ex - file locker

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>with-lock-ex</b> <b>-w</b>|<b>-q</b>|<b>-f</b> <u>lockfile</u> <u>command</u> <u>args</u> ...

</pre><h4><b>DESCRIPTION</b></h4><pre>
       with-lock-ex  will open and lock the lockfile for writing and then feed the remainder of its arguments to
       <b><a href="../man2/exec.2.html">exec</a></b>(2); when that process terminates the fd will be closed and the file unlocked  automatically  by  the
       kernel.

       If the file does not exist it is created, with permissions <b>rw</b> for each user class for which the umask has
       <b>w</b>.

</pre><h4><b>OPTIONS</b></h4><pre>
       <b>-w</b>     Wait for the lock to be available.

       <b>-f</b>     Fail  (printing  a  message  to stderr and exiting 255) if the lock cannot be acquired immediately
              because another process has it.

       <b>-q</b>     Silently do nothing (ie, exit 0 instead of executing the specified process) if the lock cannot  be
              acquired immediately because another process has it.

</pre><h4><b>STALE</b> <b>LOCKS</b></h4><pre>
       The  locking protocol used does not suffer from stale locks.  If the lock cannot be acquired, one or more
       running processes must currently hold the lock; if the lock needs to be freed those processes  should  be
       killed.

       Under  no  circumstances  should  `stale lock cleaner' cron jobs, or the like, be instituted.  In systems
       where a great many locks may exist, old lockfiles may be removed from cron  but  only  if  each  lock  is
       acquired before the lockfile is removed, for example with

              <b>with-lock-ex</b> <b>-q</b> <u>lockfile</u> <b>rm</b> <u>lockfile</u>

</pre><h4><b>DEADLOCKS</b></h4><pre>
       There  is no deadlock detection.  In a system with several locks, a lock hierarchy should be established,
       such that for every pair of locks <u>A</u> and <u>B</u> which a process might lock simultaneously, either  <u>A</u>&gt;<u>B</u>  or  <u>B</u>&gt;<u>A</u>
       where the relation &gt; is transitive and noncyclic.

       Then,  for any two locks <u>X</u> and <u>Y</u> with <u>X</u>&gt;<u>Y</u> it is forbidden to acquire <u>X</u> while holding <u>Y</u>.  Instead, acquire
       <u>X</u> first, or release <u>Y</u> before (re)acquiring <u>X</u> and <u>Y</u> in that order.

       (There are more complicated ways of avoiding deadlocks, but a lock hierarchy is simple to understand  and
       implement.  If it does not meet your needs, consult the literature.)

</pre><h4><b>LOCKING</b> <b>PROTOCOL</b></h4><pre>
       The locking protocol used by <b>with-lock-ex</b> is as follows:

       The  lock  is  held by a process (or group of processes) which holds an fcntl exclusive lock on the first
       byte of the plain file which has the specified name.  A holder of the lock (and  only  a  holder  of  the
       lock)  may  delete  the  file  or change the inode to which the name refers, and as soon as it does so it
       ceases to hold the lock.

       Any process may create the file if it does not exist.  There is no need  for  the  file  to  contain  any
       actual  data.   Indeed, actually using the file for data storage is strongly disrecommended, as this will
       foreclose most strategies for reliable update.  Use a separate lockfile instead.

       Ability to obtain the lock corresponds to write permission on the  file  (and  of  course  permission  to
       create  the   file,  if  it does not already exist).  However, processes with only read permission on the
       file can prevent the lock being acquired at  all;  therefore  lockfiles  should  not  usually  be  world-
       readable.

       When  a  (group of) processes wishes to acquire the lock, it should open the file (with <b>O_CREAT</b>) and lock
       it with <b><a href="../man2/fcntl.2.html">fcntl</a></b>(2) <b>F_RWLCK</b>, operation <b>F_SETLK</b> or <b>F_SETLKW</b>.  If this  succeeds  it  should  fstat  the  file
       descriptor  it  has,  and  the  file  by  its path.  If the device and inode match then the lock has been
       acquired and remains acquired until that group of processes  changes  which  file  the  name  refers  to,
       deletes  the file, or releases the fcntl lock.  If they do not then another process acquired the lock and
       deleted the file in the meantime; you must now close your filedescriptor and start  again.   <b>with-lock-ex</b>
       follows this specification.

       Note that <b><a href="../man2/flock.2.html">flock</a></b>(2) is a different kind of lock to <b><a href="../man2/fcntl.2.html">fcntl</a></b>(2).  <b>with-lock-ex</b> uses <b>fcntl</b>.

</pre><h4><b>AUTHOR</b></h4><pre>
       This  Manual  page  was  written  by  Matthew  Vernon  &lt;<a href="mailto:matthew@debian.org">matthew@debian.org</a>&gt;  and  enhanced by Ian Jackson
       &lt;<a href="mailto:ian@chiark.greenend.org.uk">ian@chiark.greenend.org.uk</a>&gt;, in 2003, but may be used by anyone.

</pre><h4><b>COPYRIGHT</b></h4><pre>
       with-lock-ex was written by Ian Jackson &lt;<a href="mailto:ian@chiark.greenend.org.uk">ian@chiark.greenend.org.uk</a>&gt; in 1993,  1994,  1995,  1996,  1998,
       1999. He has placed it in the public domain.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man2/fcntl.2.html">fcntl</a></b>(2), <b><a href="../man2/flock.2.html">flock</a></b>(2), <b><a href="../man2/chmod.2.html">chmod</a></b>(2)

Debian                                              July 2003                                    <u><a href="../man1/WITH-LOCK-EX.1.html">WITH-LOCK-EX</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>