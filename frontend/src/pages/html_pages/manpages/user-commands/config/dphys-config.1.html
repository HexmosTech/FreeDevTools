<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dphys-config - daily auto-install/update and/or remove config files</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/dphys-config">dphys-config_20130301~current-6_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       dphys-config - daily auto-install/update and/or remove config files

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>dphys-config</b> [<b>-f</b> <u>filter</u>] [<b>-cqvD</b>]

       <b>dphys-config</b> <b>-h</b>

</pre><h4><b>DESCRIPTION</b></h4><pre>
       dphys-config installs/updates and/or removes config files. It also triggers commands after an new/updated
       config  file  is  available or before an existing config file will disappear. It can be run by hand, from
       cron and/or from init.d.

       Get an list of config files from an configuration server. For each file in the list  retrieve  that  file
       from  the same server, and only install it if it is new or changed relative to what is already here. If a
       file is newly installed (or changed) then run an postinstall script, which may trigger actions which  are
       wanted  to  process  the  new  config (such as inserting data from an config file into an database). Also
       remove unwanted files. If doing so first run an preremove script to tidy up stuff.

       This is part of the  D-PHYS  (ETH  Zuerich,  Departement  of  Physics)  automatic  system  operation  and
       maintenance setup.

</pre><h4><b>OPTIONS</b></h4><pre>
       <b>-c</b>     configname:  Use  this  set  of  config  files instead of hostname set. Useful for chroot or vhost
              installs, or for tests.

       <b>-f</b>  <b>filter</b>
              filter: Only process lines which match the filter spec.

       <b>-q</b>     quiet: Don't produce an running report of activities.

       <b>-v</b>     verbose: Give large volume output, where sensible.

       <b>-D</b>     Debug: Activate an debug option. See source for how to use this.

       <b>-h</b>     help: Output help text, and then abort operation.

</pre><h4><b>CONFIG</b></h4><pre>
       The config files <u>/etc/dphys-config</u> (sitewide) and <u><a href="file:~/.dphys-config">~/.dphys-config</a></u> (personal) allow the admin and users to
       set up the working environment for <b>dphys-config</b>.

       These config files are sh script fragments full of assignments, which are sourced, in  above  row,  later
       config files assignments overriding earlier ones.  Standard sh syntax rules apply. Assignments are:

       <b>CONF_TMP_DIR</b>
              Sets  the  base  directory  in  which all temporary files are stored. It defaults to <u><a href="file:/var/tmp">/var/tmp</a></u> (for
              enough size and safe operation). Some users may like to use  <u><a href="file:/tmp">/tmp</a></u>  for  higher  speed  (tmpfs)  or
              automatic deletion at boot time.  Standard sh syntax rules apply. Assignments are:

       <b>CONF_BASEURL</b>
              Sets the base URL to which all */<u>&lt;hostname&gt;</u>/<u>&lt;filename&gt;</u> combinations are added when <b>wget</b>-ing config
              files.  This  can be an <u>http:</u> or <u>ftp:</u> or whatever other type of URL which <b>wget</b> understands and can
              fetch an file from. Additionally it can be an <u>file:</u> (this may be from an NFS server) URL, in which
              case wget is bypassed and the files fetched directly using <b>cp</b>. It defaults to  the  error  message
              generating             and            aborting            invalid            setting            of
              <u><a href="http://not-configured-server.example.net/not/configured/directory">http://not-configured-server.example.net/not/configured/directory</a></u>, as there is no sensible default
              possible. You must set this to where ever your config files should be taken from.

       <b>CONF_CONFNAME</b>
              Selects the name for which set of configuration files shall be used for  this  host.  Defaults  to
              <u>`hostname`</u>.

       <b>CONF_LINEFILTER</b>
              Sets  an  regexp which selects which lines from the config file list are processed. Defaults to <u>.*</u>
              (all).

       <b>CONF_LOG_DONE</b>
              Log to syslog that dphys-config has run. Good to see if cron and/or init.d have  done  their  job.
              Defaults to <u>yes</u>.

       The  config  file  list  <u>dphys-config.list</u>,  which  is  found  via  above  settings, and is downloaded to
       <u>/etc/dphys-config.list</u> or <u><a href="file:~/.dphys-config.list">~/.dphys-config.list</a></u>, then allows the admin to list what config files are to be
       fetched and installed/updated or removed, and what scripts to run for them. These can be each  given  for
       the  entire  site  (=  all  hosts)  and/or  group  and/or  each host, or even merged from site+group+host
       subsections.

</pre><h4><b>FILES</b></h4><pre>
       <b>/etc/dphys-config</b>
              site admin config

       <b><a href="file:~/.dphys-config">~/.dphys-config</a></b>
              users personal config

       <b>/etc/dphys-config.list</b>
              roots config file list gets stored here

       <b><a href="file:~/.dphys-config.list">~/.dphys-config.list</a></b>
              users config file list gets stored here

       <b>$CONF_BASEURL/`hostname`/dphys-config.list</b>
              site-global (all hosts) common (usually, or group-global or host specific) config file list

       <b>$CONF_BASEURL/`hostname`/dphys-config.list.*</b>
              facultative host-specific (usually) or group-specific include-able subsection(s) to  be  added  to
              above config file list dphys-config.list. We often use *.group (one per group of users) and *.host
              (per  host),  sometimes  also  *.base  (all host types) and *.workstation (only workstation hosts)
              subsections <b>$CONF_BASEURL/`hostname`/&lt;file-name&gt;</b> actual config files referred to  in  config  file
              list,   common   section   (usually   the   only  section)  <b>$CONF_BASEURL/`hostname`/&lt;file-name&gt;.*</b>
              facultative host-specific (usually) or group-specific include-able subsection(s) to  be  added  to
              above config file &lt;file-name&gt;

</pre><h4><b>CONFIG</b> <b>FILE</b> <b>LIST</b></h4><pre>
       The  config  file list to be used for checking what files need to be installed/updated or removed and its
       subsections included by #@include lines are merged to one list file, analog to <b>cpp</b> #include.

       These are all fetched via <b>wget</b> (or <b>cp</b> for file:), adding their names to  the  user-defined  base  URL  in
       <u>CONF_BASEURL</u>,  and  then  merged.  So  <u>CONF_BASEURL</u> can be any URL that <b>wget</b> understands http: or ftp: or
       whatever else, or file:.

       The format of the resulting concatenated file must consist of lines, one per config  file,  of  following
       format:

       <b>file-name</b>:<b>place-on-target</b>:<b>command-to-trigger</b>

       Where the 3 fields have following meanings:

              <b>file-name</b>
                     Name of the config file to be installed/updated. Must be only the base part of the filename
                     on  the  server,  without URL and hostname before it, and without any .* subsection endings
                     after it, as these are all auto-added whenever they are needed. If this is  set  to  <u>-</u>  the
                     line specifies an config file to be removed

              <b>place-on-target</b>
                     Full  directory  or full filename (directory+filename) of where the file is to be placed on
                     the target system. If only an directory is given (any name that ends in /), then the  above
                     file-name (inclusive any directories in it) will be automatically added to it. For removing
                     this  must be the full filename (or an directory name (without an /) if an entire directory
                     and its contents shall disappear). An directory name ending with /  is  not  processed,  to
                     prevent  incomplete edits (filename replaced by -, but not added to directory) from killing
                     entire directories (such as say all of <a href="file:/etc/">/etc/</a> :-))

              <b>command-to-trigger</b>
                     Full command (directory+filename, with parameters) of an command  to  be  run,  after  this
                     config  file  has  been  newly  installed or changed/updated, or before this config file is
                     removed. This can also be multiple commands separated by ;  separators.  Useful  for  doing
                     chown/chmod  to  files  that need it. If the marker <u>{}</u> appears in the command, this will be
                     substituted by the filename the config file is going to be installed as. This is analog  to
                     <b>find</b> <b>-exec</b> filename substitution

       Lines  which begin with an <b>#</b> are regarded as comments, and don't have any effect anything (Lines extended
       with one are chopped off at that point). The same applies for empty lines.

</pre><h4><b>PREPROCESSOR</b></h4><pre>
       If the first line of the config file list, or any config file fetched on  its  behalf,  has  the  special
       format  <b>#@dphys-config-preprocess</b>  [<b>action...</b>]  then this line will be stripped, and the rest of the file
       will be preprocessed. Depending on the list of <b>action</b>s present and their order (repeats are allowed)  the
       file will be processed. Valid <b>action</b>s are:

              <b>backtick</b>
                     Anything  inside  backticks (<b>``</b>) will be executed as a command, and its stdout will then be
                     substituted for the `` expression. This is analog to <u>sh</u> backtick substitution

              <b>if</b>     For any line beginning with <b>#@if</b> the stuff between the #@if and the first <b>;</b> character  will
                     be  executed  as command, and if it returns true, everything after the ; will be left, else
                     the entire line will be removed. This is analog to <u>shell</u> <u>if</u> <u>...</u> <u>;</u> conditional execution

              <b>include</b>
                     For any line beginning with <b>#@include</b> the rest of the line is  regarded  as  an  subsection
                     name,  which  will  be  added  to the base filename, and then the resulting subsection file
                     fetched (also by wget or cp) and  substituted  for  the  line.  This  is  analog  to  an  <u>C</u>
                     <u>preprocessor</u> <u>#include</u> oder an <u>shell</u> <u>.</u>  <u>include</u>

</pre><h4><b>EXAMPLES</b></h4><pre>
       The  following  allows  you  to  fetch  all  your  config  file  lists  from  an  HTTP VirtualHost called
       www.admin.example.net under its subdirectory dphys-config.

       In file <u>/etc/dphys-config</u>, on every host, so it can find the config file server:

       # system will use ${CONF_BASEURL}/`hostname`/&lt;file-name&gt;*
       CONF_BASEURL=<a href="http://www.admin.example.net/dphys-config">http://www.admin.example.net/dphys-config</a>

       We advise using an subdirectory  here,  because  other  <u>/<a href="http://www.admin.example.net/">http://www.admin.example.net/</a>*</u>  directories  may
       already  contain other admin stuff you put on the same VirtualHost. Such as software packages, site news,
       etc.

       For dphys-config to be useful you then need to make config file lists for it.   And  provide  the  actual
       config  files  that  can  be  installed,  driven  by the lists.  This is the largest job, as it basically
       amounts to extracting all your relevant config work from your site.  Also  known  as  reengineering  your
       site.

       Assuming  your  VirtualHost  on <u>www.admin.example.net</u> has as its DocumentRoot <u>/vhost/www.admin</u>, you would
       then    begin     with     an     pseudo-host     Directory     for     site-global     common     stuff:
       <u>/vhost/www.admin/dphys-config/SITE/</u>.

       If  your  hosts  are  organised in groups with group-global common configs (such as professors, students,
       staff), make an pseudo-host for each group, such as: <u>/vhost/www.admin/dphys-config/PROFS/</u> and <u>*/STUDENTS/</u>
       and <u>*/STAFF/</u>.

       Then for host specific stuff, assuming systems called prof1.example.com to  prof3.example.com,  stud1  to
       stud20,    staff1    to   staff5,   server1   and   server2,   make   for   each   its   own   directory:
       <u>/vhost/www.admin/dphys-config/prof1/</u> (and so on).

       Note that we suggest using CAPITALS for pseudo-hosts and lowercase for actual  hosts.  This  avoids  name
       space  collisions. You can also use loops like <u>for</u> <u>host</u> <u>in</u> <u>[a-z]*</u> <u>;</u> <u>do</u> <u>...</u> <u>;</u> <u>done</u> to work (say generating
       symlinks to an new config file in all hosts). Well at least you can do this so long no one goes and  sets
       LANGUAGE=  or similar junk, then bash (or libc?) will hapily screw up case sensitivity and produce random
       lossage (yes, it was painfull).

       After this add to <u>/vhost/www.admin/dphys-config/SITE/</u>, the actual config files as far  as  they  are  not
       host specific, or at least have an common section to all hosts. Example this would be <b><a href="file:/etc/hosts">/etc/hosts</a></b> for all,
       an  common  section  for <b>/etc/motd</b>, common or all for <b>sendmail.cf</b>, common for <b>inetd.conf</b>, nothing for the
       ssh hostkeys.

       Then add, to an group, say <u>/vhost/www.admin/dphys-config/STUDENTS/</u>, whatever is specific to  that  group.
       Example  this  may  be  an  entire  special  <b>motd</b>  for  the many changing users, or just an <b>motd.group</b> to
       #@include into the common one.

       Then for each host in its <u>/vhost/www.admin/dphys-config/prof1/</u> (or so) add all that is  specific  to  it.
       Such  as  its  ssh  key  files. And its own <b>motd.host</b>, it it needs one. Same its <b>inetd.conf.host</b> if it is
       going to offer special stuff. An configs for services only this host has such as <b>httpd.conf</b>.

       Then for each host add symlinks to the SITE or group versions that it is to use for common stuff, like on
       <u>/vhost/www.admin/dphys-config/stud1/</u>:

        .../dphys-config/stud1/dphys-config.list -&gt; ../SITE/dphys-config.list
        .../dphys-config/stud1/hosts -&gt; ../SITE/hosts
        .../dphys-config/stud1/inetd.conf -&gt; ../SITE/inetd.conf
        .../dphys-config/stud1/motd -&gt; ../SITE/motd
        .../dphys-config/stud1/motd.group -&gt; GROUP/motd
        .../dphys-config/stud1/GROUP -&gt; ../STUDENTS
        .../dphys-config/stud1/sendmail.cf -&gt; ../SITE/sendmail.cf

       In the <u>/vhost/www.admin/dphys-config/SITE/</u> directory place the site-global common  <b>dphys-config.list</b>  for
       all your hosts, containing stuff like this:

       # SITE dphys-config.list - just example stuff, for our exemplaric site
       # basics
       hosts:<a href="file:/etc/">/etc/</a>                      # simply works, no command
       motd:<a href="file:/etc/">/etc/</a>                       # this will be assembled group specific
       inetd.conf:<a href="file:/etc/">/etc/</a>:/etc/init.d/inetd restart  # needs an command to reload
       sendmail.cf:/etc/mail/:/etc/init.d/sendmail restart  # not in <a href="file:/etc">/etc</a>
       # ssh restart only after last file, and ensure file modes for each file
       ssh_host_key:<a href="file:/etc/ssh/">/etc/ssh/</a>:chown root:root {}; chmod 600 {}
       ssh_host_rsa_key:<a href="file:/etc/ssh/">/etc/ssh/</a>:chown root:root {}; chmod 600 {}
       ssh_host_dsa_key:<a href="file:/etc/ssh/">/etc/ssh/</a>:chown root:root {}; chmod 600 {}; /etc/init.d/sshd restart
       # load stuff into an existing database file
       seed.debconf:<a href="file:/etc/">/etc/</a>:debconf-set-selections {}
       # other stuff
       daemon1-conf:/etc/daemon1/conf   # rename so names can differ on server
       daemon2-conf:/etc/daemon2/conf
       daemon1/conf:<a href="file:/etc/">/etc/</a>               # same as above, but with directories on server
       daemon2/conf:<a href="file:/etc/">/etc/</a>
       testing:<a href="file:/etc/">/etc/</a>                    # put something in there for an test
       # delete some stuff
       -:/etc/testing                   # change to above test to get rid of it again
       -:<a href="file:/etc/">/etc/</a>                          # you will get a warning if you leave this
       #-:<a href="file:/etc">/etc</a>                          # you would reinstall your system after the resulting  rm -rf <a href="file:/etc">/etc</a>  :-)
       # and some errors
       #only-an-name                    # you would get an error: no place on target
       #only-an-name:                   # you would get an error: no place on target
       #:only-an-place                  # you would get an error: no file to install

       For special services add an <b>dphys-config.list.host</b> on each host that has special config files not present
       on others, such as on <u>/vhost/www.admin/dphys-config/server2/</u>:

       # server2 dphys-config.list.host - only used on our web server
       httpd.conf:/etc/apache/httpd.conf:/etc/init.d/apache restart

       You  can  also use dphys-config to run arbitrary commands, whenever config files are installed/updated or
       removed, to modify existing config files, or more likely modify complex config databases which can not be
       provided as files, but where one can provide edit info as files.

       dphys-config can even install scripts to use as above  commands  (or  even  just  to  run  scripts  while
       installing), such as into <u><a href="file:/usr/local/sbin/">/usr/local/sbin/</a></u>.

       For   this   make   an   <u>../SITE/local/sbin/</u>   directory,   place   the   scripts   in   there  (such  as
       <u>../SITE/local/sbin/dphys-config-&lt;whatever&gt;</u>), and symlink <u>local</u> to <u>../SITE/local</u> on each  host,  and  then
       add config lines for the scripts, with the command to trigger them, giving something like this:

       local/sbin/dphys-config-&lt;whatever&gt;:<a href="file:/usr/">/usr/</a>:chmod 755 {}; {}  # chmod and run

       It  this  script  processes an config file your will want it to be run if either the script or the config
       file is updated, so add the script to the laters line as well:

       dphys-config-&lt;whatever&gt;:<a href="file:/etc/">/etc/</a>:if [ -x /usr/local/sbin/dphys-config-&lt;whatever&gt; ] ; then /usr/local/sbin/dphys-config-&lt;whatever&gt; ; fi  # run also here

       Finally, new hosts can then later simply be added, by making the new  hosts  directory  and  copying  all
       files and symlinks from an existing host of the same group. Such as by doing:

       mkdir student21
       tar -cf - -C student1 . | tar xpf - -C student21

       To then run dphys-config by hand (say for tests), type on the host:

       <b>dphys-config</b>

       But usually you will want to run dphys-config automatically, every night (or if a machine was/is switched
       off, at every boot), to keep your configs up to date.

       For  nightly  updates  the  best thing is to use an cron job on every host. 03:00 to 03:59 is most likely
       idle time. Use an line like this one, with the <u>cron</u> option to avoid an  load  peak  on  the  config  file
       server,  by  random  delaying the run by 0..3599 seconds, and with stdout and strerr thrown away to avoid
       getting an mail from every host, as error messages are also allways sent to syslog:

       0 3 * * * root dphys-config cron &gt; /dev/null 2&gt;&amp;1

       To catch machines switched off over night, with no cron run on them, also run an init.d  script.  Use  an
       script  like  this  one,  also  with  stdout and stderr thrown away to avoid cluttering your boot console
       output:

       #!<a href="file:/bin/sh">/bin/sh</a>
       # /etc/init.d/dphys-config - boot time automatic config updates, if no cron
       case "$1" in
         start)
           dphys-config init &gt; /dev/null 2&gt;&amp;1
           ;;
       esac
       exit 0

</pre><h4><b>SECURITY</b></h4><pre>
       If dphys-config is to be used to distribute <u>all</u> config files, this will  also  include  files  which  are
       security relevant, such as ssh private keys (host key or (root) user authentification), SSL certificates,
       passwd and shadow, lilo.conf, software license keys, etc.

       As  all  files  are  most  likely  fetched from an http: URL, measures must be taken to secure the config
       website from other people downloading them. We here use an restriction to only IP addresses registered as
       hosts in our NIS server, and additionally run identd on all allowed hosts, and require the  wget  process
       opening the HTTP connection to be running by user root, and so also require dphys-config to run as root.

       To avoid sniffing it is recommended to give wget an https: URL.

</pre><h4><b>GOTCHAS</b></h4><pre>
       Config  files  are  read  by wget from an webserver, so they lose their owners and modes. So the commands
       triggered on their lines must be used to chown/chmod them to proper values.

       When used together with <u>dphys-admin</u>, dphys-config should run as first (earlier cron and init.d  entries).
       This  is needed to provide configs before new packages are installed, so dphys-admin can pretend that the
       packages were already once installed (and then non-purge removed), and so prevent questions  on  install,
       which  is  required  for  unattended  installs.  [Note that this pretending does not go as far as setting
       debconf up. Broken packages that ignore config files and only look at debconf will still ask questions.]

       As result of this, when installing for the first time on an new system (such as installing Debian by  the
       <u>dphys3</u>  end2stage feature, which installs first dphys-config and then dphys-admin), any scripts installed
       by packages by dphys-admin, to be called on config file install/update will still be missing, and so  not
       runnable. Either ignore the warnings, or better call the scripts by something like this:

       file:place:if [ -x script ]; then script; fi

       Note  that  in  this  case,  trying to run dphys-config for a second time after dphys-admin has installed
       packages and scripts, will <b>not</b> automatically mend this, as the config files  have  not  changed,  and  so
       dphys-config  will  not  (re-)run their scripts. Therefore packages containing such scripts must also, as
       part of their postinst (or init.d which is called by postinst), check for existing config files and  then
       run  their  scripts. This is the normal behaviour of quite a few packages anyway. Of course this requires
       the scripts to be idempotent, which is official Debian policy anyway.

</pre><h4><b>AUTHOR</b></h4><pre>
       <a href="mailto:neil@franklin.ch">neil@franklin.ch</a>, <a href="http://neil.franklin.ch/">http://neil.franklin.ch/</a>

D-PHYS Configuration Tools                         2010.01.21                                    <u><a href="../man1/DPHYS-CONFIG.1.html">DPHYS-CONFIG</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>