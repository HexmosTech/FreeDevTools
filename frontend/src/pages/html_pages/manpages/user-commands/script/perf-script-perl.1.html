<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>perf-script-perl - Process trace data with a Perl script</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/linux-perf">linux-perf_6.14.0-28.28_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       perf-script-perl - Process trace data with a Perl script

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <u>perf</u> <u>script</u> [-s [Perl]:script[.pl] ]

</pre><h4><b>DESCRIPTION</b></h4><pre>
       This perf script option is used to process perf script data using perf’s built-in Perl interpreter. It
       reads and processes the input file and displays the results of the trace analysis implemented in the
       given Perl script, if any.

</pre><h4><b>STARTER</b> <b>SCRIPTS</b></h4><pre>
       You can avoid reading the rest of this document by running <u>perf</u> <u>script</u> <u>-g</u> <u>perl</u> in the same directory as
       an existing perf.data trace file. That will generate a starter script containing a handler for each of
       the event types in the trace file; it simply prints every available field for each event in the trace
       file.

       You can also look at the existing scripts in <a href="file:~/libexec/perf-core/scripts/perl">~/libexec/perf-core/scripts/perl</a> for typical examples
       showing how to do basic things like aggregate event data, print results, etc. Also, the
       check-perf-script.pl script, while not interesting for its results, attempts to exercise all of the main
       scripting features.

</pre><h4><b>EVENT</b> <b>HANDLERS</b></h4><pre>
       When perf script is invoked using a trace script, a user-defined <u>handler</u> <u>function</u> is called for each
       event in the trace. If there’s no handler function defined for a given event type, the event is ignored
       (or passed to a <u>trace_unhandled</u> function, see below) and the next event is processed.

       Most of the event’s field values are passed as arguments to the handler function; some of the less common
       ones aren’t - those are available as calls back into the perf executable (see below).

       As an example, the following perf record command can be used to record all sched_wakeup events in the
       system:

           # perf record -a -e sched:sched_wakeup

       Traces meant to be processed using a script should be recorded with the above option: -a to enable
       system-wide collection.

       The format file for the sched_wakeup event defines the following fields (see
       /sys/kernel/tracing/events/sched/sched_wakeup/format):

           .ft C
            format:
                   field:unsigned short common_type;
                   field:unsigned char common_flags;
                   field:unsigned char common_preempt_count;
                   field:int common_pid;

                   field:char comm[TASK_COMM_LEN];
                   field:pid_t pid;
                   field:int prio;
                   field:int success;
                   field:int target_cpu;
           .ft

       The handler function for this event would be defined as:

           .ft C
           sub sched::sched_wakeup
           {
              my ($event_name, $context, $common_cpu, $common_secs,
                  $common_nsecs, $common_pid, $common_comm,
                  $comm, $pid, $prio, $success, $target_cpu) = @_;
           }
           .ft

       The handler function takes the form subsystem::event_name.

       The $common_* arguments in the handler’s argument list are the set of arguments passed to all event
       handlers; some of the fields correspond to the common_* fields in the format file, but some are
       synthesized, and some of the common_* fields aren’t common enough to to be passed to every event as
       arguments but are available as library functions.

       Here’s a brief description of each of the invariant event args:

           $event_name                the name of the event as text
           $context                   an opaque 'cookie' used in calls back into perf
           $common_cpu                the cpu the event occurred on
           $common_secs               the secs portion of the event timestamp
           $common_nsecs              the nsecs portion of the event timestamp
           $common_pid                the pid of the current task
           $common_comm               the name of the current process

       All of the remaining fields in the event’s format file have counterparts as handler function arguments of
       the same name, as can be seen in the example above.

       The above provides the basics needed to directly access every field of every event in a trace, which
       covers 90% of what you need to know to write a useful trace script. The sections below cover the rest.

</pre><h4><b>SCRIPT</b> <b>LAYOUT</b></h4><pre>
       Every perf script Perl script should start by setting up a Perl module search path and 'use’ing a few
       support modules (see module descriptions below):

           .ft C
            use lib "$ENV{'PERF_EXEC_PATH'}/scripts/perl/Perf-Trace-Util/lib";
            use lib "./Perf-Trace-Util/lib";
            use Perf::Trace::Core;
            use Perf::Trace::Context;
            use Perf::Trace::Util;
           .ft

       The rest of the script can contain handler functions and support functions in any order.

       Aside from the event handler functions discussed above, every script can implement a set of optional
       functions:

       <b>trace_begin</b>, if defined, is called before any event is processed and gives scripts a chance to do setup
       tasks:

           .ft C
            sub trace_begin
            {
            }
           .ft

       <b>trace_end</b>, if defined, is called after all events have been processed and gives scripts a chance to do
       end-of-script tasks, such as display results:

           .ft C
           sub trace_end
           {
           }
           .ft

       <b>trace_unhandled</b>, if defined, is called after for any event that doesn’t have a handler explicitly defined
       for it. The standard set of common arguments are passed into it:

           .ft C
           sub trace_unhandled
           {
               my ($event_name, $context, $common_cpu, $common_secs,
                   $common_nsecs, $common_pid, $common_comm) = @_;
           }
           .ft

       The remaining sections provide descriptions of each of the available built-in perf script Perl modules
       and their associated functions.

</pre><h4><b>AVAILABLE</b> <b>MODULES</b> <b>AND</b> <b>FUNCTIONS</b></h4><pre>
       The following sections describe the functions and variables available via the various Perf::Trace::* Perl
       modules. To use the functions and variables from the given module, add the corresponding <u>use</u>
       <u>Perf::Trace::XXX</u> line to your perf script script.

   <b>Perf::Trace::Core</b> <b>Module</b>
       These functions provide some essential functions to user scripts.

       The <b>flag_str</b> and <b>symbol_str</b> functions provide human-readable strings for flag and symbolic fields. These
       correspond to the strings and values parsed from the <u>print</u> <u>fmt</u> fields of the event format files:

           flag_str($event_name, $field_name, $field_value) - returns the string representation corresponding to $field_value for the flag field $field_name of event $event_name
           symbol_str($event_name, $field_name, $field_value) - returns the string representation corresponding to $field_value for the symbolic field $field_name of event $event_name

   <b>Perf::Trace::Context</b> <b>Module</b>
       Some of the <u>common</u> fields in the event format file aren’t all that common, but need to be made accessible
       to user scripts nonetheless.

       Perf::Trace::Context defines a set of functions that can be used to access this data in the context of
       the current event. Each of these functions expects a $context variable, which is the same as the $context
       variable passed into every event handler as the second argument.

           common_pc($context) - returns common_preempt count for the current event
           common_flags($context) - returns common_flags for the current event
           common_lock_depth($context) - returns common_lock_depth for the current event

   <b>Perf::Trace::Util</b> <b>Module</b>
       Various utility functions for use with perf script:

           nsecs($secs, $nsecs) - returns total nsecs given secs/nsecs pair
           nsecs_secs($nsecs) - returns whole secs portion given nsecs
           nsecs_nsecs($nsecs) - returns nsecs remainder given nsecs
           nsecs_str($nsecs) - returns printable string in the form secs.nsecs
           avg($total, $n) - returns average given a sum and a total number of values

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man1/perf-script.1.html">perf-script</a></b>(1)

perf                                               07/23/2025                                <u><a href="../man1/PERF-SCRIPT-PERL.1.html">PERF-SCRIPT-PERL</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>