<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>varnishncsa - Display Varnish logs in Apache / NCSA combined log format</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/varnish">varnish_7.7.0-1_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       varnishncsa - Display Varnish logs in Apache / NCSA combined log format

</pre><h4><b>SYNOPSIS</b></h4><pre>
       varnishncsa  [-a]  [-b] [-c] [-C] [-d] [-D] [-E] [-F &lt;format&gt;] [-f &lt;formatfile&gt;] [-g &lt;request|vxid&gt;] [-h]
       [-j] [-k &lt;num&gt;] [-L &lt;limit&gt;] [-n &lt;workdir&gt;] [-P &lt;file&gt;] [-Q &lt;file&gt;]  [-q  &lt;query&gt;]  [-r  &lt;filename&gt;]  [-R
       &lt;limit[/duration]&gt;] [-t &lt;seconds|off&gt;] [-V] [-w &lt;filename&gt;]

</pre><h4><b>DESCRIPTION</b></h4><pre>
       The  varnishncsa  utility  reads  <a href="../man1/varnishd.1.html">varnishd</a>(1)  shared  memory logs and presents them in the Apache / NCSA
       "combined" log format.

       Each log line produced is based on a single Request type transaction gathered from the shared memory log.
       The Request transaction is then scanned for the relevant parts in order to output one log line. To filter
       the log lines produced, use the  query  language  to  select  the  applicable  transactions.  Non-request
       transactions are ignored.

       The following options are available:

       <b>-a</b>     When  writing  output  to a file, append to it rather than overwrite it. This option has no effect
              without the -w option.

       <b>-b</b>     Log backend requests. If -c is not specified, then only backend requests will trigger log lines.

       <b>-c</b>     Log client requests. This is the default. If -b is specified, then -c is needed to also log client
              requests

       <b>-C</b>     Do all regular expression and string matching caseless.

       <b>-d</b>     Process log records at the head of the log and exit.

       <b>-D</b>     Daemonize.

       <b>-E</b>     Show ESI requests, implies client mode.

       <b>-F</b> <u>&lt;format&gt;</u>
              Set the output log format string.

       <b>-f</b> <u>&lt;formatfile&gt;</u>
              Read output format from a file. Will read a single line from the specified file, and use that line
              as the format.

       <b>-g</b> <u>&lt;request|vxid&gt;</u>
              The grouping of the log records. The default is to group by vxid.

       <b>-h</b>     Print program usage and exit

       <b>-j</b>     Make format-specifier replacements  JSON-compatible.  When  escaping  characters,  use  JSON-style
              \uXXXX  escape sequences instead of C-style \xXX sequences. Empty strings will be replaced with ""
              instead of "-", and empty integers will be replaced with null. Use -F or -f in combination with -j
              to write JSON logs.

       <b>-k</b> <u>&lt;num&gt;</u>
              Process this number of matching log transactions before exiting.

       <b>-L</b> <u>&lt;limit&gt;</u>
              Sets the upper limit of incomplete transactions  kept  before  the  oldest  transaction  is  force
              completed. A warning record is synthesized when this happens. This setting keeps an upper bound on
              the memory usage of running queries. Defaults to 1000 transactions.

       <b>-n</b> <u>&lt;workdir&gt;</u>
              Specify  the  varnish  working  directory  of the instance to attach to. See <u><a href="../man1/varnishd.1.html">varnishd</a>(1)</u> <b>-n</b> option
              documentation for additional information and defaults.

       <b>-P</b> <u>&lt;file&gt;</u>
              Write the process' PID to the specified file.

       <b>-Q</b> <u>&lt;file&gt;</u>
              Specifies the file containing the VSL query to use. When multiple -Q or -q options are  specified,
              all queries are considered as if the 'or' operator was used to combine them.

       <b>-q</b> <u>&lt;query&gt;</u>
              Specifies  the  VSL  query  to  use. When multiple -q or -Q options are specified, all queries are
              considered as if the 'or' operator was used to combine them.

       <b>-r</b> <u>&lt;filename&gt;</u>
              Read log in binary file format from this  file.  The  file  can  be  created  with  <b>varnishlog</b>  <b>-w</b>
              <b>filename</b>.  If  the  filename  is  -,  logs  are read from the standard input. and cannot work as a
              daemon.

       <b>-R</b> <u>&lt;limit[/duration]&gt;</u>
              Restrict the output to the specified limit. Transactions exceeding the limit will  be  suppressed.
              The  limit is specified as the maximum number of transactions (with respect to the chosen grouping
              method) and an optional time period. If no duration is specified, a default  of  <b>s</b>  is  used.  The
              duration  field  can be formatted as in VCL (e.g. <b>-R</b> <b>10/2m</b>) or as a simple time period without the
              prefix (e.g. <b>-R</b> <b>5/m</b>). When in <b>-g</b> <b>raw</b> grouping mode, this setting can not be used alongside <b>-i</b>, <b>-I</b>,
              <b>-x</b> or <b>-X</b>, and we advise using <b>-q</b> instead.

       <b>-t</b> <u>&lt;seconds|off&gt;</u>
              Timeout before returning error on initial VSM connection. If set the  VSM  connection  is  retried
              every  0.5  seconds  for this many seconds. If zero the connection is attempted only once and will
              fail immediately if unsuccessful. If set to "off", the connection  will  not  fail,  allowing  the
              utility to start and wait indefinitely for the Varnish instance to appear.  Defaults to 5 seconds.

       <b>-V</b>     Print version information and exit.

       <b>-w</b> <u>&lt;filename&gt;</u>
              Redirect  output  to file. The file will be overwritten unless the -a option was specified. If the
              application receives a SIGHUP in daemon mode the file will be reopened allowing the old one to  be
              rotated  away.  This  option  is  required  when  running  in  daemon  mode. If the filename is -,
              varnishncsa writes to the standard output and cannot work as a daemon.

       <b>--optstring</b>
              Print the optstring parameter to <b><a href="../man3/getopt.3.html">getopt</a>(3)</b> to help writing wrapper scripts.

</pre><h4><b>MODES</b></h4><pre>
       The default mode of varnishncsa is "client mode".  In this mode, the log will be similar to  what  a  web
       server would produce in the absence of varnish.  Client mode can be explicitly selected by using -c.

       If  the  -b  switch  is  specified,  varnishncsa  will operate in "backend mode".  In this mode, requests
       generated by varnish to the backends will be logged.   Unless  -c  is  also  specified,  client  requests
       received by varnish will be ignored.

       When  running  varnishncsa  in both backend and client mode, it is strongly advised to include the format
       specifier %{Varnish:side}x to distinguish between backend and client requests.

       Client requests that results in a pipe (ie. return(pipe) in vcl), will not generate  logging  in  backend
       mode. This is because varnish is not generating requests, but blindly passes on bytes in both directions.
       However,  a  varnishncsa  instance  running  in  normal  mode  can  see  this case by using the formatter
       %{Varnish:handling}x, which will be 'pipe'.

       In backend mode, some of the fields in the format string get different meanings.  Most notably, the  byte
       counting formatters (%b, %I, %O) considers varnish to be the client.

       It  is  possible  to keep two varnishncsa instances running, one in backend mode, and one in client mode,
       logging to different files.

</pre><h4><b>FORMAT</b></h4><pre>
       Specify the log format to use. If no format is specified the default log format is used:

          %h %l %u %t "%r" %s %b "%{Referer}i" "%{User-agent}i"

       Escape sequences \n and \t are supported.

       Supported formatters are:

       <b>%b</b>     In client mode, size of response in bytes, excluding HTTP headers.  In backend mode, the number of
              bytes received from the backend, excluding HTTP headers.  In CLF format, i.e. a '-' rather than  a
              0 when no bytes are sent.

       <b>%D</b>     In  client mode, time taken to serve the request, in microseconds.  In backend mode, time from the
              request was sent to the entire body had been received. This is equivalent to %{us}T.

       <b>%H</b>     The request protocol. Defaults to HTTP/1.0 if not known.

       <b>%h</b>     Remote host. Defaults to '-' if not known.  In backend mode this is the IP of the backend server.

       <b>%I</b>     In client mode, total bytes received from client.  In  backend  mode,  total  bytes  sent  to  the
              backend.

       <b>%{X}i</b>  The  contents  of  request header X. If the header appears multiple times in a single transaction,
              the last occurrence is used in backend mode and the first one in client mode.

       <b>%l</b>     Remote logname. Always '-'.

       <b>%m</b>     Request method. Defaults to '-' if not known.

       <b>%{X}o</b>  The contents of response header X. If the header appears multiple times in a  single  transaction,
              the last occurrence is used in client mode and the first one in backend mode.

       <b>%O</b>     In  client  mode,  total  bytes  sent  to  client.  In backend mode, total bytes received from the
              backend.

       <b>%q</b>     The query string. Defaults to an empty string if not present.

       <b>%r</b>     The first line of the request. Synthesized from other  fields,  so  it  may  not  be  the  request
              verbatim. See the NOTES section.

       <b>%s</b>     Status sent to the client.  In backend mode, status received from the backend.

       <b>%t</b>     In  client  mode,  time when the request was received, in HTTP date/time format.  In backend mode,
              time when the request was sent.

       <b>%{X}t</b>  In client mode, time when the request was received, in the format  specified  by  X.   In  backend
              mode,  time  when  the  request  was  sent.   The  time  specification  format  is the same as for
              <a href="../man3/strftime.3.html">strftime</a>(3) with these extensions:

              • <b>%{sec}</b>: number of seconds since the Epoch

              • <b>%{msec}</b>: number of milliseconds since the Epoch

              • <b>%{usec}</b>: number of milliseconds since the Epoch

              • <b>%{msec_frac}</b>: millisecond fraction

              • <b>%{usec_frac}</b>: microsecond fraction

              The extensions cannot be combined with each other or <a href="../man3/strftime.3.html">strftime</a>(3) in the  same  specification.  Use
              multiple <b>%{X}t</b> specifications instead.

       <b>%T</b>     In  client  mode,  time  taken  to  serve the request, in seconds.  In backend mode, time from the
              request was sent to the entire body had been received. This is equivalent to %{s}T.

       <b>%{X}T</b>  In client mode, time taken to serve the request, in the format specified by X.  In  backend  mode,
              time from the request was sent to the entire body had been received. The time specification format
              can be one of the following: s (same as %T), ms or us (same as %D).

       <b>%U</b>     The request URL without the query string. Defaults to '-' if not known.

       <b>%u</b>     Remote user from auth.

       <b>%{X}x</b>  Extended variables.  Supported variables are:

              <b>Varnish:default_format</b>
                     The   log  format  used  when  neither  -f  nor  -F  options  are  specified.   Useful  for
                     appending/prepending with other formatters.

              <b>Varnish:time_firstbyte</b>
                     Time from when the request processing starts until the first byte is sent to the client, in
                     seconds.  For backend mode: Time from the request was sent to the  backend  to  the  entire
                     header had been received.

              <b>Varnish:hitmiss</b>
                     In  client mode, one of the 'hit' or 'miss' strings, depending on whether the request was a
                     cache hit or miss. Pipe, pass and synth are considered misses. In backend mode, this  field
                     is blank.

              <b>Varnish:handling</b>
                     In  client  mode, one of the 'hit', 'hitmiss', 'hitpass', 'miss', 'pass', 'pipe' or 'synth'
                     strings indicating how the request was handled. In backend mode, this field is blank.

              <b>Varnish:side</b>
                     Backend or client side. One of two values, 'b' or 'c', depending on where the  request  was
                     made. In pure backend or client mode, this field will be constant.

              <b>Varnish:vxid</b>
                     The VXID of the varnish transaction.

              <b>VCL_Log:key</b>
                     The value set by std.log("key:value") in VCL.

              <b>VSL:tag:record-prefix[field]</b>
                     The  value  of  the  VSL  entry  for  the given tag-record prefix-field combination. Tag is
                     mandatory, the other components are optional.

                     The record prefix will limit the matches to those records that  have  this  prefix  as  the
                     first part of the record content followed by a colon.

                     The field will, if present, treat the log record as a white space separated list of fields,
                     and only the nth part of the record will be matched against. Fields start counting at 1 and
                     run up to 255.

                     Defaults  to '-' when the tag is not seen, the record prefix does not match or the field is
                     out of bounds. If a  tag  appears  multiple  times  in  a  single  transaction,  the  first
                     occurrence is used.

</pre><h4><b>SIGNALS</b></h4><pre>
       • SIGHUP

         Rotate  the  log file (see -w option) in daemon mode, abort the loop and die gracefully when running in
         the foreground.

       • SIGUSR1

         Flush any outstanding transactions.

</pre><h4><b>NOTES</b></h4><pre>
       The <b>%r</b> formatter is equivalent to <b>%m</b> <b>http://%{Host}i%U%q</b> <b>%H</b>. This differs from the Apache HTTP Server  <b>%r</b>
       behavior, equivalent to <b>%m</b> <b>%U%q</b> <b>%H</b>.

       Note  that  request  fields  are  collected on a first match basis in client mode and last match basis in
       backend mode. Similarly, response fields are collected on a first match basis in backend  mode  and  last
       match basis in client mode.

       In other words, request headers are logged as they were received from the client and as they were sent to
       the  backend, while response headers are logged as they were sent to the client and as they were received
       from the backend.

       Furthermore, these rules also apply to items that appear multiple times in a transaction. For example, if
       a header appears multiple times in a client request, the first occurrence is logged in client mode, while
       in backend mode the last occurrence is logged.

</pre><h4><b>EXAMPLE</b></h4><pre>
       Log the second field of the Begin record, corresponding to the VXID of the parent transaction:

          varnishncsa -F "%{VSL:Begin[2]}x"

       Log the entire Timestamp record associated with the processing length:

          varnishncsa -F "%{VSL:Timestamp:Process}x"

       Log in JSON, using the -j flag to ensure that the output is valid JSON for all inputs:

          varnishncsa -j -F '{"size": %b, "time": "%t", "ua": "%{User-Agent}i"}'

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man1/varnishd.1.html">varnishd</a>(1)</u> <u><a href="../man1/varnishlog.1.html">varnishlog</a>(1)</u> <u><a href="../man1/varnishstat.1.html">varnishstat</a>(1)</u> <u><a href="../man7/vsl-query.7.html">vsl-query</a>(7)</u> <u><a href="../man7/vsl.7.html">vsl</a>(7)</u>

</pre><h4><b>HISTORY</b></h4><pre>
       The varnishncsa utility was developed by Poul-Henning Kamp  in  cooperation  with  Verdens  Gang  AS  and
       Varnish  Software AS. This manual page was initially written by Dag-Erling Smørgrav &lt; &lt;<a href="mailto:des@des.no">des@des.no</a>&gt; &gt;, and
       later updated by Martin Blix Grydeland and Pål Hermunn Johansen.

</pre><h4><b>COPYRIGHT</b></h4><pre>
       This document is licensed under the same licence as Varnish itself. See LICENCE for details.

       • Copyright (c) 2006 Verdens Gang AS

       • Copyright (c) 2006-2016 Varnish Software AS

                                                                                                  <u><a href="../man1/VARNISHNCSA.1.html">VARNISHNCSA</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>