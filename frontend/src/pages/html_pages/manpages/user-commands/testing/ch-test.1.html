<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ch-test - Run some or all of the Charliecloud test suite</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/charliecloud-tests">charliecloud-tests_0.38-2_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       ch-test - Run some or all of the Charliecloud test suite

</pre><h4><b>SYNOPSIS</b></h4><pre>
          $ ch-test [PHASE] [--scope SCOPE] [--pack-fmt FMT] [ARGS]

</pre><h4><b>DESCRIPTION</b></h4><pre>
       Charliecloud  comes  with a comprehensive test suite that exercises the container workflow itself as well
       as a few example applications.  <b>ch-test</b> coordinates running the test suite.

       While the CLI has lots of options, the defaults are reasonable, and bare <b>ch-test</b> will give useful results
       in a few minutes on single-node, internet-connected systems with a few GB available in <b><a href="file:/var/tmp">/var/tmp</a></b>.

       The test suite requires a few GB (standard scope) or  tens  of  GB  (full  scope)  of  storage  for  test
       fixtures:

       ‚Ä¢ <u>Builder</u> <u>storage</u> (e.g., layer cache). This goes wherever the builder puts it.

       ‚Ä¢ <u>Packed</u> <u>images</u> <u>directory</u>: image tarballs or SquashFS files.

       ‚Ä¢ <u>Unpacked</u> <u>images</u> <u>directory</u>. Images are unpacked into and then run from here.

       ‚Ä¢ <u>Filesystem</u>  <u>permissions</u>  directories.  These  are used to test that the kernel is enforcing permissions
         correctly. Note that this exercises the kernel, not Charliecloud,  and  can  be  omitted  from  routine
         Charliecloud testing.

       The  first  three  are created when needed if they don‚Äôt exist, while the filesystem permissions fixtures
       must be created manually, in order to accommodate configurations where sudo is not available via the same
       login path used for running tests.

       The packed and unpacked image directories specified for testing are  volatile.   The  contents  of  these
       directories are deleted before the build and run phases, respectively.

       In  all  four  cases,  when  creating  directories,  only  the  final  path  component is created. Parent
       directories must already exist, i.e., <b>ch-test</b> uses the behavior of <b>mkdir</b> rather than <b>mkdir</b> <b>-p</b>.

       Some of the tests exercise parallel functionality. If <b>ch-test</b> is run on a  single  node,  multiple  cores
       will be used; if in a Slurm allocation, multiple nodes too.

       The  subset  of  tests  to  run  mostly  splits along two key dimensions. The <u>phase</u> is which parts of the
       workflow to run. Different parts of the workflow can be  tested  on  different  systems  by  copying  the
       necessary  artifacts between them, e.g. by building images on one system and running them on another. The
       <u>scope</u> allows trading off thoroughness versus time.

       <b>PHASE</b> must be one of the following:

          <b>build</b>  Image building and associated functionality, with the selected builder.

          <b>run</b>    Running containers and associated  functionality.  This  requires  a  packed  images  directory
                 produced  by  a  successful  <b>build</b> phase, which can be copied from the build system if it‚Äôs not
                 also the run system.

          <b>rootemu</b>
                 Test the root emulation modes (<b>seccomp</b>, <b>fakeroot</b>, and <b>none</b>) on various linux distributions.

          <b>examples</b>
                 Example applications. Requires an unpacked images directory produced by a successful <b>run</b> phase.

          <b>all</b>    Execute phases <b>build</b>, <b>rootemu</b>, <b>run</b>, and <b>examples</b>, in that order.

          <b>mk-perm-dirs</b>
                 Create the filesystem permissions directories. Requires <b>--perm-dirs</b>.

          <b>build-images</b>
                 Build images from <b>build</b> phase, without running the associated tests.

          <b>clean</b>  Delete automatically-generated test files, and packed and unpacked image directories.

          <b>rm-perm-dirs</b>
                 Remove the filesystem permissions directories. Requires <b>--perm-dirs</b>.

          <b>-f,</b> <b>--file</b> <b>FILE[:TEST]</b>
                 Run the tests in the given file only,  which  can  be  an  arbitrary  <b>.bats</b>  file,  except  for
                 <b>test.bats</b>  under  <b>examples</b>,  where  you must specify the corresponding Dockerfile or <b>Build</b> file
                 instead. This is somewhat brittle and typically used for development or debugging. For example,
                 it does not check whether the pre-requisites of whatever is in the file  are  satisfied.  Often
                 running <b>build</b> and <b>run</b> first is sufficient, but this varies.

                 If  <b>TEST</b>  is  also  given,  then  run only tests with name containing that string, skipping the
                 others. The separator is a literal colon. If the string contains shell metacharacters  such  as
                 space, you‚Äôll need to quote the argument to protect it from the shell.

       Scope is specified with:

          <b>-s,</b> <b>--scope</b> <b>SCOPE</b>
                 <b>SCOPE</b> must be one of the following:

                 ‚Ä¢ <b>quick</b>: Most important subset of workflow. Handy for development.

                 ‚Ä¢ <b>standard</b>:  All  tested  workflow  functionality  and  a selection of more important examples.
                   (Default.)

                 ‚Ä¢ <b>full</b>: All available tests, including all examples.

       Image format is specified with:

          <b>--pack-fmt</b> <b>FMT</b>
                 <b>FMT</b> must be one of the following:

                 ‚Ä¢ <b>squash-mount</b> or üêò: SquashFS archive, run directly from the archive using  <b>ch-run</b>‚Äôs  internal
                   SquashFUSE functionality. In this mode, tests that require writing to the image are skipped.

                 ‚Ä¢ <b>tar-unpack</b> or üì†: Tarball, and the images are unpacked before running.

                 ‚Ä¢ <b>squash-unpack</b> or üéÉ: SquashFS, and the images are unpacked before running.

                 Default:  <b>$CH_TEST_PACK_FMT</b>  if  set.  Otherwise,  if <b><a href="../man1/mksquashfs.1.html">mksquashfs</a>(1)</b> is available and <b>ch-run</b> was
                 built with <b>libsquashfuse</b> support, then <b>squash-mount</b>, else <b>tar-unpack</b>.

       Additional arguments:

          <b>-b,</b> <b>--builder</b> <b>BUILDER</b>
                 Image builder to use. Default: <b>$CH_TEST_BUILDER</b> if set, otherwise <b>ch-image</b>.

          <b>--dry-run</b>
                 Print summary of what would be tested and then exit.

          <b>-h,</b> <b>--help</b>
                 Print usage and then exit.

          <b>--img-dir</b> <b>DIR</b>
                 Set unpacked images directory to <b>DIR</b>. In a multi-node allocation, this  directory  may  not  be
                 shared between nodes. Default: <b>$CH_TEST_IMGDIR</b> if set; otherwise <b><a href="file:/var/tmp/">/var/tmp/</a>${USER}.img</b>.

          <b>--lustre</b> <b>DIR</b>
                 Use <b>DIR</b> for run-phase Lustre tests. Default: <b>CH_TEST_LUSTREDIR</b> if set; otherwise skip them.

                 The  tests  will  create, populate, and delete a new subdirectory under <b>DIR</b>, leaving everything
                 else in <b>DIR</b> untouched.

          <b>--pack-dir</b> <b>DIR</b>
                 Set  packed  images  directory   to   <b>DIR</b>.   Default:   <b>$CH_TEST_TARDIR</b>   if   set;   otherwise
                 <b><a href="file:/var/tmp/">/var/tmp/</a>${USER}.pack</b>.

          <b>--pedantic</b> <b>(yes|no)</b>
                 Some  tests require configurations that are very specific (e.g., being a member of at least two
                 groups) or unusual (e.g., sudo to a non-root group). If <b>yes</b>, then fail if  the  requirement  is
                 not  met;  if  <b>no</b>,  then  skip.  The  default  is  <b>yes</b>  for CI environments or people listed in
                 <b>README.md</b>, <b>no</b> otherwise.

                 If <b>yes</b> and sudo seems to be available, implies <b>--sudo</b>.

          <b>--perm-dir</b> <b>DIR</b>
                 Add <b>DIR</b> to filesystem permission fixture directories;  can  be  specified  multiple  times.  We
                 recommend  one such directory per mounted filesystem type whose kernel module you do not trust;
                 e.g., you probably don‚Äôt need to test your <b>tmpfs</b>es, but  out-of-tree  filesystems  very  likely
                 need this.

                 Implies  <b>--sudo</b>.  Default:  <b>CH_TEST_PERMDIRS</b>  if set; otherwise skip the filesystem permissions
                 tests.

          <b>--sudo</b> Enable  things  that  require  sudo,  such  as   certain   privilege   escalation   tests   and
                 creating/removing the filesystem permissions fixtures. Requires generic <b>sudo</b> capabilities. Note
                 that the Docker builder uses <b>sudo</b> <b>docker</b> even without this option.

</pre><h4><b>EXIT</b> <b>STATUS</b></h4><pre>
       Zero  if  all tests passed; non-zero if any failed. For setup and teardown phases, zero if everything was
       created or deleted correctly, non-zero otherwise.

</pre><h4><b>BUGS</b></h4><pre>
       Bats will wait until all descendant processes finish before exiting, so if you get into  a  failure  mode
       where a test sequence doesn‚Äôt clean up all its processes, <b>ch-test</b> will hang.

</pre><h4><b>EXAMPLES</b></h4><pre>
       Many  systems can simply use the defaults. To run the <b>build</b>, <b>run</b>, and <b>examples</b> phases on a single system,
       without the filesystem permissions tests:

          $ ch-test
          ch-test version 0.12

          ch-run: 0.12 /usr/local/bin/ch-run
          bats:   0.4.0 /usr/bin/bats
          tests:  /usr/local/libexec/charliecloud/test

          phase:                build run examples
          scope:                standard (default)
          builder:              docker (default)
          use generic sudo:     no (default)
          unpacked images dir:  /var/tmp/img (default)
          packed images dir:    /var/tmp/tar (default)
          fs permissions dirs:  skip (default)

          checking namespaces ...
          ok

          checking builder ...
          found: /usr/bin/docker 19.03.2

          bats build.bats build_auto.bats build_post.bats
           ‚úì documentation seems sane
           ‚úì version number seems sane
          [...]
          All tests passed.

       The next example is for a more complex setup like you might find in HPC centers:

          ‚Ä¢ Non-default fixture directories.

          ‚Ä¢ Non-default scope.

          ‚Ä¢ Different build and run systems.

          ‚Ä¢ Run the filesystem permissions tests.

       Output has been omitted.

          (mybox)$ ssh hpc-admin
          (hpc-admin)$ ch-test mk-perm-dirs --perm-dir /scratch/$USER/perms \
                                            --perm-dir <a href="file:/home/">/home/</a>$USER/perms
          (hpc-admin)$ exit
          (mybox)$ ch-test build --scope full
          (mybox)$ scp -r /var/tmp/pack hpc:/scratch/$USER/pack
          (mybox)$ ssh hpc
          (hpc)$ salloc -N2
          (cn001)$ export CH_TEST_TARDIR=/scratch/$USER/pack
          (cn001)$ export CH_TEST_IMGDIR=/local/tmp
          (cn001)$ export CH_TEST_PERMDIRS="/scratch/$USER/perms <a href="file:/home/">/home/</a>$USER/perms"
          (cn001)$ export CH_TEST_SCOPE=full
          (cn001)$ ch-test run
          (cn001)$ ch-test examples

</pre><h4><b>REPORTING</b> <b>BUGS</b></h4><pre>
       If Charliecloud was obtained  from  your  Linux  distribution,  use  your  distribution‚Äôs  bug  reporting
       procedures.

       Otherwise, report bugs to: <u>https://github.com/hpc/charliecloud/issues</u>

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <a href="../man7/charliecloud.7.html">charliecloud</a>(7)

       Full documentation at: &lt;<u>https://hpc.github.io/charliecloud</u>&gt;

</pre><h4><b>COPYRIGHT</b></h4><pre>
       2014‚Äì2023, Triad National Security, LLC and others

0.38                                          2024-11-23 16:04 UTC                                    <u><a href="../man1/CH-TEST.1.html">CH-TEST</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>