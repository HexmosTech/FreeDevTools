<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>qemu-storage-daemon - QEMU storage daemon</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/qemu-utils">qemu-utils_9.2.1+ds-1ubuntu5_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       qemu-storage-daemon - QEMU storage daemon

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>qemu-storage-daemon</b> [options]

</pre><h4><b>DESCRIPTION</b></h4><pre>
       <b>qemu-storage-daemon</b> provides disk image functionality from QEMU, <b>qemu-img</b>, and <b>qemu-nbd</b> in a long-running
       process  controlled  via  QMP commands without running a virtual machine.  It can export disk images, run
       block job operations, and perform other disk-related operations. The  daemon  is  controlled  via  a  QMP
       monitor and initial configuration from the command-line.

       The daemon offers the following subset of QEMU features:

       • Block nodes

       • Block jobs

       • Block exports

       • Throttle groups

       • Character devices

       • Crypto and secrets

       • QMP

       • IOThreads

       Commands    can    be    sent    over    a    QEMU   Monitor   Protocol   (QMP)   connection.   See   the
       <b><a href="../man7/qemu-storage-daemon-qmp-ref.7.html">qemu-storage-daemon-qmp-ref</a>(7)</b> manual page for a description of the commands.

       The daemon runs until it is stopped using the <b>quit</b> QMP command or SIGINT/SIGHUP/SIGTERM.

       <b>Warning:</b> Never modify images in use by a running virtual machine or any other process; this  may  destroy
       the  image. Also, be aware that querying an image that is being modified by another process may encounter
       inconsistent state.

</pre><h4><b>OPTIONS</b></h4><pre>
       Standard options:

       <b>-h,</b> <b>--help</b>
              Display help and exit

       <b>-V,</b> <b>--version</b>
              Display version information and exit

       <b>-T,</b> <b>--trace</b> <b>[[enable=]PATTERN][,events=FILE][,file=FILE]</b>
              Specify tracing options.

              <b>[enable=]PATTERN</b>
                 Immediately enable events matching <u>PATTERN</u> (either event name or  a  globbing  pattern).   This
                 option  is  only  available  if  QEMU  has been compiled with the <b>simple</b>, <b>log</b> or <b>ftrace</b> tracing
                 backend.  To specify multiple events or patterns, specify the <b>-trace</b> option multiple times.

                 Use <b>-trace</b> <b>help</b> to print a list of names of trace points.

              <b>events=FILE</b>
                 Immediately enable events listed in <u>FILE</u>.  The file must contain one event name (as  listed  in
                 the  <b>trace-events-all</b>  file) per line; globbing patterns are accepted too.  This option is only
                 available if QEMU has been compiled with the <b>simple</b>, <b>log</b> or <b>ftrace</b> tracing backend.

              <b>file=FILE</b>
                 Log output traces to <u>FILE</u>.  This option is only available if QEMU has been  compiled  with  the
                 <b>simple</b> tracing backend.

       <b>--blockdev</b> <b>BLOCKDEVDEF</b>
              is a block node definition. See the <b><a href="../man1/qemu-system.1.html">qemu-system</a>(1)</b> manual page (in qemu-system-common package) for
              a description of block node properties and the <b><a href="../man7/qemu-block-drivers.7.html">qemu-block-drivers</a>(7)</b> manual page for a description
              of driver-specific parameters.

       <b>--chardev</b> <b>CHARDEVDEF</b>
              is  a  character  device  definition.  See  the  <b><a href="../man1/qemu-system.1.html">qemu-system</a>(1)</b> manual page (in qemu-system-common
              package) for a description of character device properties. A common  character  device  definition
              configures a UNIX domain socket:

                 --chardev socket,id=char1,path=/var/run/qsd-qmp.sock,server=on,wait=off

       <b>--export</b> <b>[type=]nbd,id=&lt;id&gt;,node-name=&lt;node-name&gt;[,name=&lt;export-name&gt;][,writable=on|off][,bitmap=&lt;name&gt;]</b>

       <b>--export</b>
       <b>[type=]vhost-user-blk,id=&lt;id&gt;,node-name=&lt;node-name&gt;,addr.type=unix,addr.path=&lt;socket-path&gt;[,writable=on|off][,logical-block-size=&lt;block-size&gt;][,num-queues=&lt;num-queues&gt;]</b>

       <b>--export</b>
       <b>[type=]vhost-user-blk,id=&lt;id&gt;,node-name=&lt;node-name&gt;,addr.type=fd,addr.str=&lt;fd&gt;[,writable=on|off][,logical-block-size=&lt;block-size&gt;][,num-queues=&lt;num-queues&gt;]</b>

       <b>--export</b>
       <b>[type=]fuse,id=&lt;id&gt;,node-name=&lt;node-name&gt;,mountpoint=&lt;file&gt;[,growable=on|off][,writable=on|off][,allow-other=on|off|auto]</b>

       <b>--export</b>
       <b>[type=]vduse-blk,id=&lt;id&gt;,node-name=&lt;node-name&gt;,name=&lt;vduse-name&gt;[,writable=on|off][,num-queues=&lt;num-queues&gt;][,queue-size=&lt;queue-size&gt;][,logical-block-size=&lt;block-size&gt;][,serial=&lt;serial-number&gt;]</b>
              is  a  block  export  definition.  <b>node-name</b>  is  the block node that should be exported. <b>writable</b>
              determines whether or not the export allows write requests for  modifying  data  (the  default  is
              off).

              The  <b>nbd</b>  export  type  requires  <b>--nbd-server</b>  (see  below).  <b>name</b> is the NBD export name (if not
              specified, it defaults to the given <b>node-name</b>). <b>bitmap</b> is the name of  a  dirty  bitmap  reachable
              from  the block node, so the NBD client can use NBD_OPT_SET_META_CONTEXT with the metadata context
              name "qemu:dirty-bitmap:BITMAP" to inspect the bitmap.

              The <b>vhost-user-blk</b> export type takes a vhost-user socket  address  on  which  it  accept  incoming
              connections.   Both   <b>addr.type=unix,addr.path=&lt;socket-path&gt;</b>   for   UNIX   domain   sockets   and
              <b>addr.type=fd,addr.str=&lt;fd&gt;</b> for file descriptor passing are supported.  <b>logical-block-size</b> sets the
              logical block size in bytes (the default is 512). <b>num-queues</b> sets the number  of  virtqueues  (the
              default is 1).

              The  <b>fuse</b>  export  type  takes a mount point, which must be a regular file, on which to export the
              given block node. That file will not be changed, it will just appear  to  have  the  block  node's
              content  while  the export is active (very much like mounting a filesystem on a directory does not
              change what the directory contains, it only shows a different  content  while  the  filesystem  is
              mounted).  Consequently,  applications  that  have  opened the given file before the export became
              active will continue to see its original content. If <b>growable</b> is set, writes after the end of  the
              exported  file  will  grow  the  block node to fit.  The <b>allow-other</b> option controls whether users
              other than the user running the process will be allowed to access the export.  Note that  enabling
              this  option  as  a  non-root  user  requires  enabling  the user_allow_other option in the global
              fuse.conf configuration file.  Setting <b>allow-other</b> to auto (the default) will  try  enabling  this
              option, and on error fall back to disabling it.

              The  <b>vduse-blk</b>  export  type  takes  a  <b>name</b>  (must be unique across the host) to create the VDUSE
              device.  <b>num-queues</b> sets the number of  virtqueues  (the  default  is  1).   <b>queue-size</b>  sets  the
              virtqueue descriptor table size (the default is 256).

              The  instantiated  VDUSE  device must then be added to the vDPA bus using the <a href="../man8/vdpa.8.html">vdpa</a>(8) command from
              the iproute2 project:

                 # vdpa dev add name &lt;id&gt; mgmtdev vduse

              The device can be removed from the vDPA bus later as follows:

                 # vdpa dev del &lt;id&gt;

              For more information about attaching vDPA devices to the host  with  virtio_vdpa.ko  or  attaching
              them to guests with vhost_vdpa.ko, see <u>https://vdpa-dev.gitlab.io/</u>.

              For more information about VDUSE, see <u>https://docs.kernel.org/userspace-api/vduse.html</u>.

       <b>--monitor</b> <b>MONITORDEF</b>
              is  a  QMP  monitor definition. See the <b><a href="../man1/qemu-system.1.html">qemu-system</a>(1)</b> manual page (in qemu-system-common package)
              for a description of QMP monitor properties. A common QMP monitor definition configures a  monitor
              on character device <b>char1</b>:

                 --monitor chardev=char1

       <b>--nbd-server</b>
       <b>addr.type=inet,addr.host=&lt;host&gt;,addr.port=&lt;port&gt;[,tls-creds=&lt;id&gt;][,tls-authz=&lt;id&gt;][,max-connections=&lt;n&gt;]</b>

       <b>--nbd-server</b> <b>addr.type=unix,addr.path=&lt;path&gt;[,tls-creds=&lt;id&gt;][,tls-authz=&lt;id&gt;][,max-connections=&lt;n&gt;]</b>

       <b>--nbd-server</b> <b>addr.type=fd,addr.str=&lt;fd&gt;[,tls-creds=&lt;id&gt;][,tls-authz=&lt;id&gt;][,max-connections=&lt;n&gt;]</b>
              is  a server for NBD exports. Both TCP and UNIX domain sockets are supported.  A listen socket can
              be provided via file descriptor passing (see Examples below). TLS  encryption  can  be  configured
              using <b>--object</b> tls-creds-* and authz-* secrets (see below).

              To configure an NBD server on UNIX domain socket path <b>/var/run/qsd-nbd.sock</b>:

                 --nbd-server addr.type=unix,addr.path=/var/run/qsd-nbd.sock

       <b>--object</b> <b>help</b>

       <b>--object</b> <b>&lt;type&gt;,help</b>

       <b>--object</b> <b>&lt;type&gt;[,&lt;property&gt;=&lt;value&gt;...]</b>
              is  a  QEMU user creatable object definition. List object types with <b>help</b>.  List object properties
              with <b>&lt;type&gt;,help</b>. See the <b><a href="../man1/qemu.1.html">qemu</a>(1)</b> manual page for a description of the object properties.

       <b>--pidfile</b> <b>PATH</b>
              is the path to a file where the daemon writes its pid. This allows scripts to stop the  daemon  by
              sending a signal:

                 $ kill -SIGTERM $(&lt;path/to/qsd.pid)

              A  file  lock  is  applied to the file so only one instance of the daemon can run with a given pid
              file path. The daemon unlinks its pid file when terminating.

              The pid file is written after chardevs, exports, and NBD servers  have  been  created  but  before
              accepting  connections.  The  daemon  has  started  successfully  when the pid file is written and
              clients may begin connecting.

       <b>--daemonize</b>
              Daemonize the process. The parent process will exit once startup is complete (i.e., after the  pid
              file  has  been  or would have been written) or failure occurs. Its exit code reflects whether the
              child has started up successfully or failed to do so.

</pre><h4><b>EXAMPLES</b></h4><pre>
       Launch the daemon with QMP monitor socket <b>qmp.sock</b> so clients can execute QMP commands:

          $ qemu-storage-daemon \
              --chardev socket,path=qmp.sock,server=on,wait=off,id=char1 \
              --monitor chardev=char1

       Launch the daemon from Python with a QMP monitor socket using file descriptor passing so there is no need
       to busy wait for the QMP monitor to become available:

          #!<a href="file:///usr/lib/w3m/cgi-bin/w3mman2html.cgi?env">/usr/bin/env</a> python3
          import subprocess
          import socket

          sock_path = '/var/run/qmp.sock'

          with socket.socket(socket.AF_UNIX, socket.SOCK_STREAM) as listen_sock:
              listen_sock.bind(sock_path)
              listen_sock.listen()

              fd = listen_sock.fileno()

              subprocess.Popen(
                  ['qemu-storage-daemon',
                   '--chardev', f'socket,fd={fd},server=on,id=char1',
                   '--monitor', 'chardev=char1'],
                  pass_fds=[fd],
              )

          # listen_sock was automatically closed when leaving the 'with' statement
          # body. If the daemon process terminated early then the following connect()
          # will fail with "Connection refused" because no process has the listen
          # socket open anymore. Launch errors can be detected this way.

          qmp_sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
          qmp_sock.connect(sock_path)
          ...QMP interaction...

       The same socket spawning  approach  also  works  with  the  <b>--nbd-server</b>  <b>addr.type=fd,addr.str=&lt;fd&gt;</b>  and
       <b>--export</b> <b>type=vhost-user-blk,addr.type=fd,addr.str=&lt;fd&gt;</b> options.

       Export raw image file <b>disk.img</b> over NBD UNIX domain socket <b>nbd.sock</b>:

          $ qemu-storage-daemon \
              --blockdev driver=file,node-name=disk,filename=disk.img \
              --nbd-server addr.type=unix,addr.path=nbd.sock \
              --export type=nbd,id=export,node-name=disk,writable=on

       Export   a   qcow2   image   file   <b>disk.qcow2</b>  as  a  vhost-user-blk  device  over  UNIX  domain  socket
       <b>vhost-user-blk.sock</b>:

          $ qemu-storage-daemon \
              --blockdev driver=file,node-name=file,filename=disk.qcow2 \
              --blockdev driver=qcow2,node-name=qcow2,file=file \
              --export type=vhost-user-blk,id=export,addr.type=unix,addr.path=vhost-user-blk.sock,node-name=qcow2

       Export a qcow2 image file <b>disk.qcow2</b> via FUSE on itself, so the disk image file will then appear as a raw
       image:

          $ qemu-storage-daemon \
              --blockdev driver=file,node-name=file,filename=disk.qcow2 \
              --blockdev driver=qcow2,node-name=qcow2,file=file \
              --export type=fuse,id=export,node-name=qcow2,mountpoint=disk.qcow2,writable=on

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man1/qemu.1.html">qemu</a>(1)</b>, <b><a href="../man7/qemu-block-drivers.7.html">qemu-block-drivers</a>(7)</b>, <b><a href="../man7/qemu-storage-daemon-qmp-ref.7.html">qemu-storage-daemon-qmp-ref</a>(7)</b>

</pre><h4><b>COPYRIGHT</b></h4><pre>
       2024, The QEMU Project Developers

9.2.1                                             Apr 09, 2025                            <u><a href="../man1/QEMU-STORAGE-DAEMON.1.html">QEMU-STORAGE-DAEMON</a></u>(1)
</pre>
 </div>
</div></section>
</div>
</body>
</html>