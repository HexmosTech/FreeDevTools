<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sni.yaml - Traffic Server sni rules configuration file</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/trafficserver">trafficserver_9.2.5+ds-1ubuntu2_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       sni.yaml - Traffic Server sni rules configuration file

</pre><h4><b>DESCRIPTION</b></h4><pre>
       This  file  is  used  to  configure  aspects  of  TLS  connection  handling for both inbound and outbound
       connections. With the exception of <b>host_sni_policy</b> (see the  description  below),  the  configuration  is
       driven  by the SNI values provided by the inbound connection. The file consists of a set of configuration
       items, each identified by an SNI value (<b>fqdn</b>).  When an inbound TLS connection is  made,  the  SNI  value
       from the TLS negotiation is matched against the items specified by this file and if there is a match, the
       values  specified  in  that  item  override  the  defaults.  This  is  done during the inbound connection
       processing; some outbound properties can be overridden again later, such as via <u>remap.config</u> or plugins.

       By   default   this   is   named    <u>sni.yaml</u>.    The    filename    can    be    changed    by    setting
       <u>proxy.config.ssl.servername.filename</u>. This file is loaded on start up and by <u>traffic_ctl</u> <u>config</u> <u>reload</u> if
       the file has been modified since process start.

       The  configuration  file  is  YAML-based.  After  parsing the configuration, a list of tables will be the
       result.  Each table is a set of key / value pairs that create a configuration  item.  This  configuration
       file  accepts wildcard entries. To apply an SNI based setting on all the server names with a common upper
       level domain name, the user needs to enter the fqdn in the configuration with a <b>*.</b> followed by the common
       domain name. (<b>*.yahoo.com</b> for example).

       For some settings, there is no guarantee that  they  will  be  applied  to  a  connection  under  certain
       conditions.  An established TLS connection may be reused for another server name if it’s used for HTTP/2.
       This  also  means  that  settings for server name A may affects requests for server name B as well. See ‐
       <u>https://daniel.haxx.se/blog/2016/08/18/http2-connection-coalescing/</u> for a more  detailed  description  of
       HTTP/2 connection coalescing.
     ┌────────────────────────────────────────┬───────────┬──────────────────────────────────────────────────────┐
     │ Key                                    │ Direction │ Meaning                                              │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ fqdn                                   │ Both      │ Fully Qualified Domain Name.                         │
     │                                        │           │ This item is used if the SNI                         │
     │                                        │           │ value matches this.                                  │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ ip_allow                               │ Inbound   │ Specify  a list of client IP                         │
     │                                        │           │ address, subnets, or  ranges                         │
     │                                        │           │ what are allowed to complete                         │
     │                                        │           │ the connection. This list is                         │
     │                                        │           │ comma  separated.  IPv4  and                         │
     │                                        │           │ IPv6   addresses   can    be                         │
     │                                        │           │ specified.    Here   is   an                         │
     │                                        │           │ example                list:                         │
     │                                        │           │ 192.168.1.0/24,192.168.10.1-4.                       │
     │                                        │           │ This would allow connections                         │
     │                                        │           │ from    clients    in    the                         │
     │                                        │           │ 19.168.1.0 network or in the                         │
     │                                        │           │ range from  192.168.10.1  to                         │
     │                                        │           │ 192.168.1.4.                                         │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ verify_server_policy                   │ Outbound  │ One  of  the  values <b>DISABLED</b>,                       │
     │                                        │           │ <b>PERMISSIVE</b>, or <b>ENFORCED</b>.                             │
     │                                        │           │                                                      │
     │                                        │           │ By     default     this     is                       │
     │                                        │           │ <u>proxy.config.ssl.client.verify.server.policy</u>.        │
     │                                        │           │ This   controls   how  Traffic                       │
     │                                        │           │ Server  evaluated  the  origin                       │
     │                                        │           │ certificate.                                         │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ verify_server_properties               │ Outbound  │ One  of the values <b>NONE</b>, <b>SIGNATURE</b>, <b>NAME</b>, and        │
     │                                        │           │ <b>ALL</b>                                                  │
     │                                        │           │                                                      │
     │                                        │           │ By          default          this          is        │
     │                                        │           │ <u>proxy.config.ssl.client.verify.server.properties</u>.    │
     │                                        │           │ This controls what Traffic Server checks when        │
     │                                        │           │ evaluating the origin certificate.                   │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ verify_client                          │ Outbound  │ One  of the values <b>NONE</b>, <b>MODERATE</b>, or <b>STRICT</b>.  If    │
     │                                        │           │ <b>NONE</b> is specified,  Traffic  Server  requests  no    │
     │                                        │           │ certificate.   If  <b>MODERATE</b>  is specified Traffic    │
     │                                        │           │ Server  will  verify  a   certificate   that   is    │
     │                                        │           │ presented by the client, but it will not fail the    │
     │                                        │           │ TLS handshake if no certificate is presented.  If    │
     │                                        │           │ <b>STRICT</b>  is  specified  the  client must present a    │
     │                                        │           │ certificate during the TLS handshake.                │
     │                                        │           │                                                      │
     │                                        │           │ By           default           this            is    │
     │                                        │           │ <u>proxy.config.ssl.client.certification_level</u>.         │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ verify_client_ca_certs                 │ Both      │ Specifies   an   alternate   set  of  certificate    │
     │                                        │           │ authority certs to use to verify the client cert.    │
     │                                        │           │ The value must be either a file path, or a nested    │
     │                                        │           │ set of key / value pairs.  If the value is a file    │
     │                                        │           │ path, it must specify a file  containing  the  CA    │
     │                                        │           │ certs.   Otherwise,  there  should  be  up to two    │
     │                                        │           │ nested pairs.  The possible  keys  are  <b>file</b>  and    │
     │                                        │           │ <b>dir</b>.   The value for <b>file</b> must be a file path for    │
     │                                        │           │ a file containing CA certs.  The  value  for  <b>dir</b>    │
     │                                        │           │ must  be  a  file path for an OpenSSL X509 hashed    │
     │                                        │           │ directory containing CA certs.  If a  given  file    │
     │                                        │           │ path  does not being with <b>/</b> , it must be relative    │
     │                                        │           │ to the Traffic  Server  configuration  directory.    │
     │                                        │           │ <b>verify_client_ca_certs</b>  can  only  be  used  with    │
     │                                        │           │ capbilities provided by OpenSSL 1.0.2 or later.      │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ host_sni_policy                        │ Inbound   │ One  of  the  values  <b>DISABLED</b>,  <b>PERMISSIVE</b>,   or    │
     │                                        │           │ <b>ENFORCED</b>.                                            │
     │                                        │           │                                                      │
     │                                        │           │ If     not     specified,     the     value    of    │
     │                                        │           │ <u>proxy.config.http.host_sni_policy</u> is used.   This    │
     │                                        │           │ controls  how policy impacting mismatches between    │
     │                                        │           │ host header and SNI values are dealt  with.   For    │
     │                                        │           │ details about hos this configuration behaves, see    │
     │                                        │           │ the                                 corresponding    │
     │                                        │           │ <u>proxy.config.http.host_sni_policy</u>  <u>records.config</u>    │
     │                                        │           │ documentation.                                       │
     │                                        │           │                                                      │
     │                                        │           │ Note  that  this particular configuration will be    │
     │                                        │           │ inspected at the time the HTTP Host header  field    │
     │                                        │           │ is  processed. Further, this policy check will be    │
     │                                        │           │ keyed off of the Host header field  value  rather    │
     │                                        │           │ than  the SNI in this <u>sni.yaml</u> file. This is done    │
     │                                        │           │ because the Host header field is  ultimately  the    │
     │                                        │           │ resource  that  will be retrieved from the origin    │
     │                                        │           │ and the administrator will intend to  guard  this    │
     │                                        │           │ resource  rather  than the SNI, which a malicious    │
     │                                        │           │ user may alter to some other server  value  whose    │
     │                                        │           │ policies  are  more  lenient  than the host he is    │
     │                                        │           │ trying to access.                                    │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ valid_tls_versions_in                  │ Inbound   │ This specifies the list  of  TLS  protocols  that    │
     │                                        │           │ will  be  offered  to  user agents during the TLS    │
     │                                        │           │ negotiation.  This replaces the  global  settings    │
     │                                        │           │ in                        <u>proxy.config.ssl.TLSv1</u>,    │
     │                                        │           │ <u>proxy.config.ssl.TLSv1_1</u>,                            │
     │                                        │           │ <u>proxy.config.ssl.TLSv1_2</u>,                     and    │
     │                                        │           │ <u>proxy.config.ssl.TLSv1_3</u>.  The  potential  values    │
     │                                        │           │ are TLSv1, TLSv1_1, TLSv1_2,  and  TLSv1_3.   You    │
     │                                        │           │ must  list  all  protocols  that  Traffic  Server    │
     │                                        │           │ should offer to the client when using  this  key.    │
     │                                        │           │ This  key  is  only  valid  for OpenSSL 1.1.0 and    │
     │                                        │           │ later and BoringSSL. Older versions of OpenSSL do    │
     │                                        │           │ not provide a hook early enough to update the SSL    │
     │                                        │           │ object.  It is a syntax error for Traffic  Server    │
     │                                        │           │ built against earlier versions.                      │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ client_cert                            │ Outbound  │ The file containing the client certificate to use    │
     │                                        │           │ for the outbound connection.                         │
     │                                        │           │                                                      │
     │                                        │           │ If  this  is relative, it is relative to the path    │
     │                                        │           │ in <u>proxy.config.ssl.client.cert.path</u>. If not  set    │
     │                                        │           │ <u>proxy.config.ssl.client.cert.filename</u> is used.       │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ client_key                             │ Outbound  │ The  file  containing the client private key that    │
     │                                        │           │ corresponds to the certificate for  the  outbound    │
     │                                        │           │ connection.                                          │
     │                                        │           │                                                      │
     │                                        │           │ If  this  is relative, it is relative to the path    │
     │                                        │           │ in  <u>proxy.config.ssl.client.private_key.path</u>.  If    │
     │                                        │           │ not  set,  Traffic  Server tries to use a private    │
     │                                        │           │ key       in       client_cert.        Otherwise,    │
     │                                        │           │ <u>proxy.config.ssl.client.private_key.filename</u>   is    │
     │                                        │           │ used.                                                │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ client_sni_policy                      │ Outbound  │ Policy of SNI on outbound connection.                │
     │                                        │           │                                                      │
     │                                        │           │ If    not     specified,     the     value     of    │
     │                                        │           │ <u>proxy.config.ssl.client.sni_policy</u> is used.          │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ http2                                  │ Inbound   │ Indicates whether the H2 protocol should be added    │
     │                                        │           │ to or removed from the protocol negotiation list.    │
     │                                        │           │ The valid values are <b>on</b> or <b>off</b>.                      │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ http2_buffer_water_mark                │ Inbound   │ Specifies  the  high  water  mark  for all HTTP/2    │
     │                                        │           │ frames on an  outoging  connection.   By  default    │
     │                                        │           │ this                                           is    │
     │                                        │           │ <u>proxy.config.http2.default_buffer_water_mark</u>.        │
     │                                        │           │ NOTE:  Connection  coalescing  may  prevent  this    │
     │                                        │           │ taking effect.                                       │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ http2_max_settings_frames_per_minute   │ Inbound   │ Specifies how many SETTINGS frames Traffic Server    │
     │                                        │           │ receives  per minute at maximum.  By default this    │
     │                                        │           │ is                                                   │
     │                                        │           │ <u>proxy.config.http2.max_settings_frames_per_minute</u>.   │
     │                                        │           │ NOTE: Connection coalescing may prevent this from    │
     │                                        │           │ taking effect.                                       │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ http2_max_ping_frames_per_minute       │ Inbound   │ Specifies how  many  PING  frames  Traffic  Server   │
     │                                        │           │ receives  per  minute at maximum.  By default this   │
     │                                        │           │ is  <u>proxy.config.http2.max_ping_frames_per_minute</u>.   │
     │                                        │           │ NOTE:  Connection coalescing may prevent this from   │
     │                                        │           │ taking effect.                                       │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ http2_max_priority_frames_per_minute   │ Inbound   │ Specifies how many PRIORITY frames Traffic  Server   │
     │                                        │           │ receives  per  minute at maximum.  By default this   │
     │                                        │           │ is                                                   │
     │                                        │           │ <u>proxy.config.http2.max_priority_frames_per_minute</u>.   │
     │                                        │           │ NOTE: Connection coalescing may prevent this  from   │
     │                                        │           │ taking effect.                                       │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ http2_max_rst_stream_frames_per_minute │ Inbound   │ Specifies   how  many  RST_STREAM  frames  Traffic   │
     │                                        │           │ Server receives per minute at maximum.  By default   │
     │                                        │           │ this                                            is   │
     │                                        │           │ <u>proxy.config.http2.max_rst_stream_frames_per_minute</u>. │
     │                                        │           │ NOTE:  Connection coalescing may prevent this from   │
     │                                        │           │ taking effect.                                       │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ disable_h2                             │ Inbound   │ Deprecated for the more general h2 setting.  Setting │
     │                                        │           │ disable_h2 to <b>true</b> is the same as setting  http2  to │
     │                                        │           │ <b>on</b>.                                                  │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ tunnel_route                           │ Inbound   │ Destination  as  an  FQDN  and  port, separated by a │
     │                                        │           │ colon <b>:</b>.  Match group number can be specified by  <b>$N</b> │
     │                                        │           │ where  N  should  refer  to a specified group in the │
     │                                        │           │ FQDN, <b>tunnel_route:</b> <b>$1.domain</b>.                       │
     │                                        │           │                                                      │
     │                                        │           │ This will  forward  all  traffic  to  the  specified │
     │                                        │           │ destination  without  first terminating the incoming │
     │                                        │           │ TLS connection.                                      │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ forward_route                          │ Inbound   │ Destination as an FQDN  and  port,  separated  by  a │
     │                                        │           │ colon <b>:</b>.                                             │
     │                                        │           │                                                      │
     │                                        │           │ This  is  similar to tunnel_route, but it terminates │
     │                                        │           │ the  TLS  connection  and  forwards  the   decrypted │
     │                                        │           │ traffic.  Traffic  Server  will  not  interpret  the │
     │                                        │           │ decrypted data, so the contents do not  need  to  be │
     │                                        │           │ HTTP.                                                │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ partial_blind_route                    │ Inbound   │ Destination  as  an  FQDN  and  port, separated by a │
     │                                        │           │ colon <b>:</b>.                                             │
     │                                        │           │                                                      │
     │                                        │           │ This is similar to  forward_route  in  that  Traffic │
     │                                        │           │ Server  terminates  the incoming TLS connection.  In │
     │                                        │           │ addition  partial_blind_route  creates  a  new   TLS │
     │                                        │           │ connection  to  the  specified  origin.  It does not │
     │                                        │           │ interpret the decrypted data before  passing  it  to │
     │                                        │           │ the  origin  TLS  connection, so the contents do not │
     │                                        │           │ need to be HTTP.                                     │
     ├────────────────────────────────────────┼───────────┼──────────────────────────────────────────────────────┤
     │ tunnel_alpn                            │ Inbound   │ List of ALPN Protocol Ids for Partial Blind Tunnel.  │
     │                                        │           │                                                      │
     │                                        │           │ ATS negotiates application protocol with the  client │
     │                                        │           │ on  behalf  of  the  origin server.  This only works │
     │                                        │           │ with <b>partial_blind_route</b>.                            │
     └────────────────────────────────────────┴───────────┴──────────────────────────────────────────────────────┘

   <b>Pre-warming</b> <b>TLS</b> <b>Tunnel</b>
                     ┌─────────────────────────────────┬───────────────────────────────────────┐
                     │ Key                             │ Meaning                               │
                     ├─────────────────────────────────┼───────────────────────────────────────┤
                     │ tunnel_prewarm                  │ Override  <u>proxy.config.tunnel.prewarm</u> │
                     │                                 │ in records.config.                    │
                     ├─────────────────────────────────┼───────────────────────────────────────┤
                     │ tunnel_prewarm_srv              │ Enable    SRV    record   lookup   on │
                     │                                 │ pre-warming. Default is <b>false</b>.        │
                     ├─────────────────────────────────┼───────────────────────────────────────┤
                     │ tunnel_prewarm_rate             │ Rate  of  how  many  connections   to │
                     │                                 │ pre-warm. Default is <b>1.0</b>.             │
                     ├─────────────────────────────────┼───────────────────────────────────────┤
                     │ tunnel_prewarm_min              │ Minimum  number  of pre-warming queue │
                     │                                 │ size (per thread). Default is <b>0</b>.      │
                     ├─────────────────────────────────┼───────────────────────────────────────┤
                     │ tunnel_prewarm_max              │ Maximum number of  pre-warming  queue │
                     │                                 │ size  (per  thread).  Default  is  <b>-1</b> │
                     │                                 │ (unlimited).                          │
                     ├─────────────────────────────────┼───────────────────────────────────────┤
                     │ tunnel_prewarm_connect_timeout  │ Timeout  for  TCP/TLS  handshake  (in │
                     │                                 │ seconds).                             │
                     ├─────────────────────────────────┼───────────────────────────────────────┤
                     │ tunnel_prewarm_inactive_timeout │ Inactive  timeout  for connections in │
                     │                                 │ the pool (in seconds).                │
                     └─────────────────────────────────┴───────────────────────────────────────┘

       Client        verification,        via        <b>verify_client</b>,        corresponds        to         setting
       <u>proxy.config.ssl.client.certification_level</u> for this connection as noted below.

       <b>NONE</b> <b>--</b> <b>0</b>
              Do not request a client certificate, ignore it if one is provided.

       <b>MODERATE</b> <b>-</b> <b>1</b>
              Request  a  client certificate and do verification if one is provided. The connection is denied if
              the verification of the client provided certificate fails.

       <b>STRICT</b> <b>-</b> <b>2</b>
              Request a client certificate and require one to be provided and  verified.   If  the  verification
              fails the failure is logged to <u>diags.log</u> and the connection is denied.

       Upstream  (server)  verification,  via  <b>verify_server_policy</b>  and <b>verify_server_properties</b>, is similar to
       client verification except there is always  an  upstream  certificate.  This  is  equivalent  to  setting
       <u>proxy.config.ssl.client.verify.server.policy</u>   and  <u>proxy.config.ssl.client.verify.server.properties</u>  for
       this connection.

       <b>verify_server_policy</b> specifies how Traffic Server will enforce the server certificate verification.

       <b>DISABLED</b>
              Do not verify the upstream server certificate.

       <b>PERMISSIVE</b>
              Do verification of the upstream certificate but do not enforce.  If  the  verification  fails  the
              failure is logged in <u>diags.log</u> but the connection is allowed.

       <b>ENFORCED</b>
              Do  verification  of  the  upstream  certificate.  If verification fails, the failure is logged in
              <u>diags.log</u> and the connection is denied.

       In addition <b>verify_server_properties</b> specifies  what  Traffic  Server  will  check  when  performing  the
       verification.

       <b>NONE</b>   Do  not  check anything in the standard Traffic Server verification routine.  Rely entirely on the
              <b>TS_SSL_VERIFY_SERVER_HOOK</b> for evaluating the origin's certificate.

       <b>SIGNATURE</b>
              Check the signature of the origin certificate.

       <b>NAME</b>   Verify that the SNI is in the origin certificate.

       <b>ALL</b>    Verify both the signature and the SNI in the origin certificate.

       If <b>tunnel_route</b> is specified, none  of  the  certificate  verification  will  be  done  because  the  TLS
       negotiation  will  be  tunneled  to  the  upstream  target,  making  those  values  irrelevant  for  that
       configuration item. This option is explained in more detail in <u>SNI</u> <u>Routing</u>.

</pre><h4><b>EXAMPLES</b></h4><pre>
       Disable HTTP/2 for <b>no-http2.example.com</b>.

          sni:
          - fqdn: no-http2.example.com
            http2: off

       Require client certificate  verification  for  <b>foo.com</b>  and  any  server  name  ending  with  <b>.yahoo.com</b>.
       Therefore,  client  request  for  a server name ending with yahoo.com (e.g., def.yahoo.com, abc.yahoo.com
       etc.) will cause Traffic Server require and verify the client certificate.

       For <b>foo.com</b>, if the user agent sets the host header to foo.com but the SNI to some other  value,  Traffic
       Server  will  warn  about  the  mismatch  but  continue to process the request.  Mismatches for the other
       domains will cause Traffic Server to warn and return 403.

       Traffic Server will allow a client certificate to be provided for  <b>example.com</b>  and  if  it  is,  Traffic
       Server will require the certificate to be valid.

          sni:
          - fqdn: example.com
            verify_client: MODERATE
          - fqdn: 'foo.com'
            verify_client: STRICT
            host_sni_policy: PERMISSIVE
          - fqdn: '*.yahoo.com'
            verify_client: STRICT

       Disable  outbound  server  certificate  verification  for  <b>trusted.example.com</b> and require a valid client
       certificate.

          sni:
          - fqdn: trusted.example.com
            verify_server_policy: DISABLED
            verify_client: STRICT

       Use FQDN captured group to match in <b>tunnel_route</b>.

          sni:
          - fqdn: '*.foo.com'
            tunnel_route: '$1.myfoo'
          - fqdn: '*.bar.*.com'
            tunnel_route: '$2.some.$1.yahoo'

       FQDN <b>some.foo.com</b> will match and the captured string will be replaced in the <b>tunnel_route</b> which will  end
       up  being  <b>some.myfoo</b>.   Second  part  is  using  multiple  groups,  having  <b>bob.bar.example.com</b> as FQDN,
       <b>tunnel_route</b> will end up being <b>bar.some.bob.yahoo</b>.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u>SNI</u> <u>Routing</u>

</pre><h4><b>COPYRIGHT</b></h4><pre>
       2025, <a href="mailto:dev@trafficserver.apache.org">dev@trafficserver.apache.org</a>

9.2                                               May 22, 2025                                       <u><a href="../man5/SNI.YAML.5.html">SNI.YAML</a></u>(5)
</pre>
 </div>
</div></section>
</div>
</body>
</html>