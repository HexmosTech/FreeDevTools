<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantize - ImageMagick's color reduction algorithm.</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/graphicsmagick">graphicsmagick_1.4+really1.3.45+hg17696-1build1_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       Quantize - ImageMagick's color reduction algorithm.

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;magick.h&gt;</b>

</pre><h4><b>DESCRIPTION</b></h4><pre>
       This  document  describes how <b>ImageMagick</b> performs color reduction on an image.  To fully understand this
       document, you should have a knowledge of basic  imaging  techniques  and  the  tree  data  structure  and
       terminology.

       For  purposes  of  color  allocation,  an  image is a set of <u>n</u> pixels, where each pixel is a point in RGB
       space.  RGB space is a 3-dimensional vector space, and each pixel, <u>pi</u>,  is defined by an  ordered  triple
       of red, green, and blue coordinates, (<u>ri,</u> <u>gi,</u> <u>bi</u>).

       Each  primary  color component (red, green, or blue) represents an intensity which varies linearly from 0
       to a maximum value, <u>cmax</u>, which corresponds to full  saturation  of  that  color.   Color  allocation  is
       defined  over  a  domain  consisting  of  the  cube  in  RGB  space with opposite vertices at (0,0,0) and
       (<u>cmax,cmax,cmax</u>).  <b>ImageMagick</b> requires <u>cmax</u> <u>=</u> <u>255</u>.

       The algorithm maps this domain onto a tree in which each node represents a cube within that  domain.   In
       the  following discussion, these cubes are defined by the coordinate of two opposite vertices: The vertex
       nearest the origin in RGB space and the vertex farthest from the origin.

       The tree's root node represents the the entire domain,  (0,0,0)  through  (<u>cmax,cmax,cmax</u>).   Each  lower
       level  in  the  tree  is generated by subdividing one node's cube into eight smaller cubes of equal size.
       This corresponds to bisecting the parent cube with planes passing through the midpoints of each edge.

       The basic algorithm operates in three phases:  <b>Classification,</b> <b>Reduction</b>, and <b>Assignment</b>.  <b>Classification</b>
       builds a color description tree for the  image.   <b>Reduction</b>  collapses  the  tree  until  the  number  it
       represents,  at most, is the number of colors desired in the output image.  <b>Assignment</b> defines the output
       image's color map and sets each pixel's color by reclassification in the reduced tree.  Our  goal  is  to
       minimize  the  numerical  discrepancies  between the original colors and quantized colors.  To learn more
       about quantization error, see MEASURING COLOR REDUCTION ERROR later in this document.

       <b>Classification</b> begins by initializing a color description tree of  sufficient  depth  to  represent  each
       possible  input color in a leaf.  However, it is impractical to generate a fully-formed color description
       tree in the classification phase for realistic values of <u>cmax</u>.  If color components in  the  input  image
       are  quantized  to <u>k</u>-bit precision, so that <u>cmax</u> <u>=</u> <u>2k-1</u>, the tree would need <u>k</u> levels below the root node
       to allow representing each possible input color in a leaf.  This becomes prohibitive because  the  tree's
       total number of nodes is

               Î£ ki=1 8k

       A  complete  tree  would  require 19,173,961 nodes for <u>k</u> <u>=</u> <u>8,</u> <u>cmax</u> <u>=</u> <u>255</u>.  Therefore, to avoid building a
       fully populated tree, <b>ImageMagick</b>: (1) Initializes data structures for nodes only as they are needed; (2)
       Chooses a maximum depth for the tree as a function of the desired number of colors in  the  output  image
       (currently  <u>log4(colormap</u> <u>size)+2</u>).  A tree of this depth generally allows the best representation of the
       source image with the fastest computational speed and the least amount of memory.  However,  the  default
       depth is inappropriate for some images.  Therefore, the caller can request a specific tree depth.

       For  each  pixel in the input image, classification scans downward from the root of the color description
       tree.  At each level of the tree, it identifies the single node which represents  a  cube  in  RGB  space
       containing the pixel's color.  It updates the following data for each such node:

       <b>n1:</b>    Number of pixels whose color is contained in the RGB cube which this node represents;

       <b>n2:</b>    Number  of pixels whose color is not represented in a node at lower depth in the tree;  initially,
              <u>n2</u> <u>=</u> <u>0</u> for all nodes except leaves of the tree.

       <b>Sr,</b> <b>Sg,</b> <b>Sb:</b>
              Sums of the red, green, and blue component values for all pixels not classified at a lower  depth.
              The  combination  of  these  sums  and  <u>n2</u> will ultimately characterize the mean color of a set of
              pixels represented by this node.

       <b>E:</b>     The distance squared in RGB space between each pixel  contained  within  a  node  and  the  nodes'
              center.  This represents the quantization error for a node.

       <b>Reduction</b>  repeatedly prunes the tree until the number of nodes with <u>n2</u>  <u>&gt;</u> <u>0</u> is less than or equal to the
       maximum number of colors allowed in the output image.  On any given iteration over the tree,  it  selects
       those  nodes  whose  <u>E</u>  value is minimal for pruning and merges their color statistics upward.  It uses a
       pruning threshold, <u>Ep</u>, to govern node selection as follows:

         Ep = 0
         while number of nodes with (n2 &gt; 0) &gt; required maximum number of colors
             prune all nodes such that E &lt;= Ep
             Set Ep  to minimum E in remaining nodes

       This has the effect of minimizing any quantization error when merging two nodes together.

       When a node to be pruned has offspring, the pruning procedure invokes  itself  recursively  in  order  to
       prune  the  tree  from  the  leaves upward.  The values of <u>n2</u>  <u>Sr,</u> <u>Sg,</u>  and <u>Sb</u> in a node being pruned are
       always added to the corresponding data in that node's parent.   This  retains  the  pruned  node's  color
       characteristics for later averaging.

       For  each  node,   <u>n2</u>  pixels  exist  for  which  that  node  represents the smallest volume in RGB space
       containing those pixel's colors.  When <u>n2</u>  <u>&gt;</u> <u>0</u> the node will uniquely define a color in the output image.
       At the beginning of reduction, <u>n2</u> <u>=</u> <u>0</u>  for all nodes except the leaves of the tree which represent colors
       present in the input image.

       The other pixel count, <u>n1</u>,  indicates the total number of colors within the cubic volume which  the  node
       represents.  This includes <u>n1</u> <u>-</u> <u>n2</u> pixels whose colors should be defined by nodes at a lower level in the
       tree.

       <b>Assignment</b> generates the output image from the pruned tree.  The output image consists of two parts:  (1)
       A  color  map, which is an array of color descriptions (RGB triples) for each color present in the output
       image; (2)  A pixel array, which represents each pixel as an index into the color map array.

       First, the assignment phase makes one pass over the  pruned  color  description  tree  to  establish  the
       image's  color  map.  For each node with <u>n2</u> <u>&gt;</u> <u>0</u>, it divides <u>Sr,</u> <u>Sg</u>, and <u>Sb</u> by <u>n2</u>.  This produces the mean
       color of all pixels that classify no lower than this node.  Each of these colors becomes an entry in  the
       color map.

       Finally,  the  assignment  phase  reclassifies each pixel in the pruned tree to identify the deepest node
       containing the pixel's color.  The pixel's value in the pixel array becomes the index of this node's mean
       color in the color map.

       Empirical evidence suggests that distances in color spaces such as YUV, or YIQ correspond  to  perceptual
       color  differences  more  closely  than  do  distances  in RGB space.  These color spaces may give better
       results when color reducing an image.  Here the algorithm is as described except each pixel is a point in
       the alternate color space.  For convenience, the color components are normalized to  the  range  0  to  a
       maximum value, <u>cmax</u>.  The color reduction can then proceed as described.

</pre><h4><b>MEASURING</b> <b>COLOR</b> <b>REDUCTION</b> <b>ERROR</b></h4><pre>
       Depending  on the image, the color reduction error may be obvious or invisible.  Images with high spatial
       frequencies (such as hair or grass) will show error much less than pictures with  large  smoothly  shaded
       areas  (such  as  faces).   This  is  because  the  high-frequency  contour edges introduced by the color
       reduction process are masked by the high frequencies in the image.

       To measure the difference between the original and  color  reduced  images  (the  total  color  reduction
       error),  <b>ImageMagick</b>  sums  over  all  pixels  in an image the distance squared in RGB space between each
       original pixel value and its color reduced value. <b>ImageMagick</b> prints several error measurements including
       the mean error per pixel, the normalized mean error, and the normalized maximum error.

       The normalized error measurement can be used to compare images.  In general, the closer the mean error is
       to zero the more the  quantized  image  resembles  the  source  image.   Ideally,  the  error  should  be
       perceptually-based, since the human eye is the final judge of quantization quality.

       These errors are measured and printed when <b>-verbose</b> and <b>-colors</b> <u>are</u> <u>specified</u> <u>on</u> <u>the</u> <u>command</u> <u>line:</u>

       <b>mean</b> <b>error</b> <b>per</b> <b>pixel:</b>
              is the mean error for any single pixel in the image.

       <b>normalized</b> <b>mean</b> <b>square</b> <b>error:</b>
              is the normalized mean square quantization error for any single pixel in the image.

              This distance measure is normalized to a range between 0 and 1.  It is independent of the range of
              red, green, and blue values in the image.

       <b>normalized</b> <b>maximum</b> <b>square</b> <b>error:</b>
              is the largest normalized square quantization error for any single pixel in the image.

              This distance measure is normalized to a range between 0 and 1.  It is independent of the range of
              red, green, and blue values in the image.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man1/display.1.html">display</a>(1),</b> <b><a href="../man1/animate.1.html">animate</a>(1),</b> <b><a href="../man1/mogrify.1.html">mogrify</a>(1),</b> <b><a href="../man1/import.1.html">import</a>(1),</b> <b><a href="../man5/miff.5.html">miff</a>(5)</b>

</pre><h4><b>COPYRIGHT</b></h4><pre>
       Copyright  (C)  2002  ImageMagick  Studio, a non-profit organization dedicated to making software imaging
       solutions freely available.

       Permission is hereby granted, free of charge, to any  person  obtaining  a  copy  of  this  software  and
       associated  documentation  files  ("ImageMagick"),  to deal in ImageMagick without restriction, including
       without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense,  and/or  sell
       copies  of  ImageMagick,  and to permit persons to whom the ImageMagick is furnished to do so, subject to
       the following conditions:

       The above copyright notice and this permission notice shall be included  in  all  copies  or  substantial
       portions of ImageMagick.

       The  software  is  provided  "as is", without warranty of any kind, express or implied, including but not
       limited to the warranties of merchantability, fitness for a particular purpose and  noninfringement.   In
       no  event  shall  ImageMagick  Studio  be liable for any claim, damages or other liability, whether in an
       action of contract, tort or otherwise, arising from, out of or in connection with ImageMagick or the  use
       or other dealings in ImageMagick.

       Except  as  contained in this notice, the name of the ImageMagick Studio shall not be used in advertising
       or otherwise  to  promote  the  sale,  use  or  other  dealings  in  ImageMagick  without  prior  written
       authorization from the ImageMagick Studio.

</pre><h4><b>ACKNOWLEDGEMENTS</b></h4><pre>
       Paul  Raveling,  USC Information Sciences Institute, for the original idea of using space subdivision for
       the color reduction algorithm.  With Paul's permission, this document is an adaptation from a document he
       wrote.

</pre><h4><b>AUTHORS</b></h4><pre>
       John Cristy, ImageMagick Studio

ImageMagick                                          $Date$                                          <u><a href="../man5/quantize.5.html">quantize</a></u>(5)
</pre>
 </div>
</div></section>
</div>
</body>
</html>