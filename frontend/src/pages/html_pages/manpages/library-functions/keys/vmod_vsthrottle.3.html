<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vmod_vsthrottle - Throttling VMOD</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/varnish-modules">varnish-modules_0.25.0-2_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       vmod_vsthrottle - Throttling VMOD

</pre><h4><b>SYNOPSIS</b></h4><pre>
          import vsthrottle [as name] [from "path"]

          BOOL is_denied(STRING key, INT limit, DURATION period, DURATION block)

          VOID return_token(STRING key, INT limit, DURATION period, DURATION block)

          INT remaining(STRING key, INT limit, DURATION period, DURATION block)

          DURATION blocked(STRING key, INT limit, DURATION period, DURATION block)

          VOID remove_bucket(STRING key, INT limit, DURATION period, DURATION block)

</pre><h4><b>DESCRIPTION</b></h4><pre>
       A  Varnish  vmod  for  rate-limiting  traffic  on  a single Varnish server. Offers a simple interface for
       throttling traffic on a per-key basis to a specific request rate.

       Keys can be specified from any VCL string, e.g. based on client.ip,  a  specific  cookie  value,  an  API
       token, etc.

       The  request  rate is specified as the number of requests permitted over a period. To keep things simple,
       this is passed as two separate parameters, 'limit' and 'period'.

       If an optional duration 'block' is specified, then access is denied altogether for that  period  of  time
       after the rate limit is reached. This is a way to entirely turn away a particularly troublesome source of
       traffic for a while, rather than let them back in as soon as the rate slips back under the threshold.

       This  VMOD  implements  a  token  bucket  algorithm  &lt;<a href="http://en.wikipedia.org/wiki/Token_bucket">http://en.wikipedia.org/wiki/Token_bucket</a>&gt;  . State
       associated with  the  token  bucket  for  each  key  is  stored  in-memory  using  BSD's  red-black  tree
       implementation.

       Memory usage is around 100 bytes per key tracked.

       Example:

          vcl 4.0;
          import vsthrottle;

          backend default { .host = "192.0.2.11"; .port = "8080"; }

          sub vcl_recv {
              # Varnish will set client.identity for you based on client IP.

              if (vsthrottle.is_denied(client.identity, 15, 10s, 30s)) {
                  # Client has exceeded 15 reqs per 10s.
                  # When this happens, block altogether for the next 30s.
                  return (synth(429, "Too Many Requests"));
              }

              # There is a quota per API key that must be fulfilled.
              if (vsthrottle.is_denied("apikey:" + req.http.Key, 30, 60s)) {
                      return (synth(429, "Too Many Requests"));
              }

              # Only allow a few POST/PUTs per client.
              if (req.method == "POST" || req.method == "PUT") {
                  if (vsthrottle.is_denied("rw" + client.identity, 2, 10s)) {
                      return (synth(429, "Too Many Requests"));
                  }
              }
          }

   <b>BOOL</b> <b>is_denied(STRING</b> <b>key,</b> <b>INT</b> <b>limit,</b> <b>DURATION</b> <b>period,</b> <b>DURATION</b> <b>block)</b>
          BOOL is_denied(
             STRING key,
             INT limit,
             DURATION period,
             DURATION block=0
          )

       Arguments:

          • key: A unique identifier to define what is being throttled - more examples below

          • limit: How many requests in the specified period

          • period: The time period

          • block: a period to deny all access after hitting the threshold. Default is 0s

       <b>Description</b>
              Can  be  used  to  rate  limit the traffic for a specific key to a maximum of 'limit' requests per
              'period' time. If 'block' is &gt; 0s, (0s by default), then always deny for 'key' for that length  of
              time after hitting the threshold.

              Note: A token bucket is uniquely identified by the 4-tuple of its key, limit, period and block, so
              using the same key multiple places with different rules will create multiple token buckets.

       <b>Example</b>

                 sub vcl_recv {
                         if (vsthrottle.is_denied(client.identity, 15, 10s)) {
                                 # Client has exceeded 15 reqs per 10s
                                 return (synth(429, "Too Many Requests"));
                         }

                         # ...
                 }

   <b>VOID</b> <b>return_token(STRING</b> <b>key,</b> <b>INT</b> <b>limit,</b> <b>DURATION</b> <b>period,</b> <b>DURATION</b> <b>block)</b>
          VOID return_token(
             STRING key,
             INT limit,
             DURATION period,
             DURATION block=0
          )

       <b>Arguments:</b>

              • Same arguments as is_denied()

       <b>Description</b>
              Increment (by one) the number of tokens in the specified bucket. is_denied() decrements the bucket
              by  one  token and return_token() adds it back.  Using these two, you can effectively make a token
              bucket act like a limit on concurrent requests instead of requests / time.

              Note: This function doesn't enforce anything, it merely credits a token to appropriate bucket.

              Warning: If streaming is enabled (beresp.do_stream = true) as it is by default now,  vcl_deliver()
              is  called  <u>before</u>  the  response is sent to the client (who may download it slowly). Thus you may
              credit the token back too early if you use return_token() in vcl_backend_response().

       <b>Example</b>

                 sub vcl_recv {
                         if (vsthrottle.is_denied(client.identity, 20, 20s)) {
                                 # Client has more than 20 concurrent requests
                                 return (synth(429, "Too Many Requests In Flight"));
                         }

                         # ...
                 }

                 sub vcl_deliver {
                         vsthrottle.return_token(client.identity, 10, 10s);
                 }

   <b>INT</b> <b>remaining(STRING</b> <b>key,</b> <b>INT</b> <b>limit,</b> <b>DURATION</b> <b>period,</b> <b>DURATION</b> <b>block)</b>
          INT remaining(
             STRING key,
             INT limit,
             DURATION period,
             DURATION block=0
          )

       <b>Arguments:</b>

              • Same arguments as is_denied()

       Description
          Get the current number of tokens for a given token bucket. This can  be  used  to  create  a  response
          header to inform clients of their current quota.

       <b>Example</b>

                 sub vcl_deliver {
                    set resp.http.X-RateLimit-Remaining = vsthrottle.remaining(client.identity, 15, 10s);
                 }

   <b>DURATION</b> <b>blocked(STRING</b> <b>key,</b> <b>INT</b> <b>limit,</b> <b>DURATION</b> <b>period,</b> <b>DURATION</b> <b>block)</b>
          DURATION blocked(
             STRING key,
             INT limit,
             DURATION period,
             DURATION block
          )

       <b>Arguments:</b>

              • Same arguments as is_denied()

       Description
          If the token bucket identified by the four parameters has been blocked by use of the 'block' parameter
          in  'is_denied()',  then return the time remaining in the block. If it is not blocked, return 0s. This
          can be used to inform clients how long they will be locked out.

       <b>Example</b>

                 sub vcl_deliver {
                    set resp.http.Retry-After
                            = vsthrottle.blocked(client.identity, 15, 10s, 30s);
                 }

   <b>VOID</b> <b>remove_bucket(STRING</b> <b>key,</b> <b>INT</b> <b>limit,</b> <b>DURATION</b> <b>period,</b> <b>DURATION</b> <b>block)</b>
          VOID remove_bucket(
             STRING key,
             INT limit,
             DURATION period,
             DURATION block=0
          )

       <b>Arguments:</b>

              • Same arguments as is_denied()

       Description
          Remove the token bucket identified by the four parameters, if it exists.

       <b>Example</b>

                 sub vcl_deliver {
                        vsthrottle.remove_bucket(client.identity, 15, 10s, 30s);
                 }

                                                                                              <u><a href="../man3/VMOD_VSTHROTTLE.3.html">VMOD_VSTHROTTLE</a></u>(3)
</pre>
 </div>
</div></section>
</div>
</body>
</html>