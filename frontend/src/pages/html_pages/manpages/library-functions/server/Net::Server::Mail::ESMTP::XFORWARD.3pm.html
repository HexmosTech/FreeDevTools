<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Net::Server::Mail::ESMTP::XFORWARD - A module to add support to the XFORWARD command in</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/libnet-server-mail-perl">libnet-server-mail-perl_0.28-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       Net::Server::Mail::ESMTP::XFORWARD - A module to add support to the XFORWARD command in
       Net::Server::Mail::ESMTP

</pre><h4><b>SYNOPSIS</b></h4><pre>
           use Net::Server::Mail::ESMTP;

           my @local_domains = qw(example.com example.org);
           my $server = IO::Socket::INET-&gt;new( Listen =&gt; 1, LocalPort =&gt; 25 );

           my $conn;
           while($conn = $server-&gt;accept)
           {
               my $esmtp = Net::Server::Mail::ESMTP-&gt;new( socket =&gt; $conn );

               # activate XFORWARD extension if remote client is localhost
               $esmtp-&gt;register('Net::Server::Mail::ESMTP::XFORWARD')
                  if($server-&gt;get_property('peeraddr') =~ /^127/);
               # adding some handlers
               $esmtp-&gt;set_callback(RCPT =&gt; \&amp;validate_recipient);
               # adding XFORWARD handler
               $esmtp-&gt;set_callback(XFORWARD =&gt; \&amp;xforward);
               $esmtp-&gt;process();
               $conn-&gt;close();
           }

           sub xforward {
               my $self = shift;
               # Reject non IPV4 addresses
               return 0 unless( $self-&gt;get_forwarded_address =~ /^\d+\.\d+\.\d+\.\d+$/ );
               1;
           }

           sub validate_recipient
           {
               my($session, $recipient) = @_;
               my $domain;
               if($recipient =~ /\@(.*)&gt;\s*$/)
               {
                   $domain = $1;
               }

               if(not defined $domain)
               {
                   return(0, 513, 'Syntax error.');
               }
               elsif(not(grep $domain eq $_, @local_domains) &amp;&amp; $session-&gt;get_forwarded_addr != "10.1.1.1")
               {
                   return(0, 554, "$recipient: Recipient address rejected: Relay access denied");
               }

               <a href="../man1/return.1.html">return</a>(1);
           }

</pre><h4><b>DESCRIPTION</b></h4><pre>
       When using a Net::Server::Mail::ESMTP script inside a MTA and not in front of Internet, values like
       client IP address are not accessible to the script and when the script returns mail to another instance
       of smtpd daemon, it logs "localhost" as incoming address. To solve this problem, some administrators use
       the XFORWARD command. This module gives the ability to read and store XFORWARD information.

   <b>METHODS</b>
       These methods return the values set by the upstream MTA without modifying them so they can be set to
       undef or "[UNVAILABLE]". See Postfix documentation for more.

       •   get_forwarded_values : returns a hash reference containing all values forwarded (keys in lower case).

       •   get_forwarded_name : returns the up-stream hostname. The hostname may be a non-DNS hostname.

       •   get_forwarded_address  :  returns  the up-stream network address. Address information is not enclosed
           with []. The address may be a non-IP address.

       •   get_forwarded_source : returns LOCAL or REMOTE.

       •   get_forwarded_helo : returns the hostname that the up-stream host announced itself. It may be a  non-
           DNS hostname.

       •   get_forwarded_proto  : returns the mail protocol for receiving mail from the up-stream host. This may
           be an SMTP or non-SMTP protocol name of up to 64 characters.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       Net::Server::Mail::ESMTP, &lt;<a href="http://www.postfix.org/XFORWARD_README.html">http://www.postfix.org/XFORWARD_README.html</a>&gt;

</pre><h4><b>AUTHOR</b></h4><pre>
       Xavier Guimard, &lt;<a href="mailto:x.guimard@free.fr">x.guimard@free.fr</a>&gt;

</pre><h4><b>COPYRIGHT</b> <b>AND</b> <b>LICENSE</b></h4><pre>
       Copyright (C) 2006 by Xavier Guimard

       This library is free software; you can redistribute it and/or modify it under  the  same  terms  as  Perl
       itself, either Perl version 5.6.4 or, at your option, any later version of Perl 5 you may have available.

perl v5.34.0                                       2022-05-26             <u>Net::Server::Ma...ESMTP::<a href="../man3pm/XFORWARD.3pm.html">XFORWARD</a></u>(3pm)
</pre>
 </div>
</div></section>
</div>
</body>
</html>