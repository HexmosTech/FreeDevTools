<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nbdkit-ruby-plugin - nbdkit ruby plugin</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/jammy/+package/nbdkit-plugin-ruby">nbdkit-plugin-ruby_1.24.1-2ubuntu4_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       nbdkit-ruby-plugin - nbdkit ruby plugin

</pre><h4><b>SYNOPSIS</b></h4><pre>
        nbdkit ruby /path/to/plugin.rb [arguments...]

</pre><h4><b>WARNING</b></h4><pre>
       The Ruby language is fundamentally broken when it comes to embedding in a program which uses pthreads.
       This means you may see random "stack overflows" when using this plugin on some versions of Ruby but not
       others.

       For the whole sorry saga, see: https://redmine.ruby-lang.org/issues/2294

</pre><h4><b>DESCRIPTION</b></h4><pre>
       "nbdkit-ruby-plugin" is an embedded Ruby interpreter for <b><a href="../man1/nbdkit.1.html">nbdkit</a></b>(1), allowing you to write nbdkit plugins
       in Ruby.

   <b>If</b> <b>you</b> <b>have</b> <b>been</b> <b>given</b> <b>an</b> <b>nbdkit</b> <b>Ruby</b> <b>plugin</b>
       Assuming you have a Ruby script which is an nbdkit plugin, you run it like this:

        nbdkit ruby /path/to/ruby.rb

       You may have to add further "key=value" arguments to the command line.  Read the Ruby script to see if it
       requires any.

</pre><h4><b>WRITING</b> <b>A</b> <b>RUBY</b> <b>NBDKIT</b> <b>PLUGIN</b></h4><pre>
       For an example plugin written in Ruby, see:
       https://github.com/libguestfs/nbdkit/blob/master/plugins/ruby/example.rb

       Broadly speaking, Ruby nbdkit plugins work like C ones, so you should read <b><a href="../man3/nbdkit-plugin.3.html">nbdkit-plugin</a></b>(3) first.

       To write a Ruby nbdkit plugin, you create a Ruby file which contains at least the following required
       functions:

        def open(readonly)
          # see below
        end
        def get_size(h)
          # see below
        end
        def pread(h, count, offset)
          # see below
        end

       Note that the subroutines must have those literal names (like "open"), because the C part looks up and
       calls those functions directly.  You may want to include documentation and globals (eg. for storing
       global state).  Any other top level statements are run when the script is loaded, just like ordinary
       Ruby.

   <b>Executable</b> <b>script</b>
       If you want you can make the script executable and include a "shebang" at the top:

        #!/usr/sbin/nbdkit ruby

       See also "Shebang scripts" in <b><a href="../man1/nbdkit.1.html">nbdkit</a></b>(1).

       These scripts can also be installed in the $plugindir.  See "WRITING PLUGINS IN OTHER PROGRAMMING
       LANGUAGES" in <b><a href="../man3/nbdkit-plugin.3.html">nbdkit-plugin</a></b>(3).

   <b>Methods</b>
       Your script has access to the "Nbdkit" module, with the following singleton methods:

        Nbdkit.set_error(err)

       Record "err" as the reason you are about to raise an exception. "err" should either be a class that
       defines an "Errno" constant (all of the subclasses of "SystemCallError" in module "Errno" have this
       property), an object that defines an "errno" method with no arguments (all instances of "SystemCallError"
       have this property), or an integer value corresponding to the usual errno values.

   <b>Exceptions</b>
       Ruby callbacks should throw exceptions to indicate errors. Remember to use "Nbdkit.set_error" if you need
       to control which error is sent back to the client; if omitted, the client will see an error of "EIO".

   <b>Ruby</b> <b>callbacks</b>
       This just documents the arguments to the callbacks in Ruby, and any way that they differ from the C
       callbacks.  In all other respects they work the same way as the C callbacks, so you should go and read
       <b><a href="../man3/nbdkit-plugin.3.html">nbdkit-plugin</a></b>(3).

       "dump_plugin"
           (Optional)

           There are no arguments or return value.

       "config"
           (Optional)

            def config(key, value)
              # no return value
            end

       "config_complete"
           (Optional)

           There are no arguments or return value.

       "open"
           (Required)

            def open(readonly)
              # return handle
            end

           You can return any non-nil Ruby value as the handle.  It is passed back in subsequent calls.

       "close"
           (Optional)

            def close(h)
              # no return value
            end

       "get_size"
           (Required)

            def get_size(h)
              # return the size of the disk
            end

       "can_write"
           (Optional)

            def can_write(h)
              # return a boolean
            end

       "can_flush"
           (Optional)

            def can_flush(h)
              # return a boolean
            end

       "is_rotational"
           (Optional)

            def is_rotational(h)
              # return a boolean
            end

       "can_trim"
           (Optional)

            def can_trim(h)
              # return a boolean
            end

       "pread"
           (Required)

            def pread(h, count, offset)
              # construct a string of length count bytes and return it
            end

           The  body of your "pread" function should construct a string of length (at least) "count" bytes.  You
           should read "count" bytes from the disk starting at "offset".

           NBD only supports whole reads, so your  function  should  try  to  read  the  whole  region  (perhaps
           requiring  a  loop).   If  the  read  fails  or  is partial, your function should throw an exception,
           optionally using "Nbdkit.set_error" first.

       "pwrite"
           (Optional)

            def pwrite(h, buf, offset)
              length = buf.length
              # no return value
            end

           The body of your "pwrite" function should write the "buf" string  to  the  disk.   You  should  write
           "count" bytes to the disk starting at "offset".

           NBD  only  supports  whole  writes,  so  your  function should try to write the whole region (perhaps
           requiring a loop).  If the write fails or is  partial,  your  function  should  throw  an  exception,
           optionally using "Nbdkit.set_error" first.

       "flush"
           (Optional)

            def flush(h)
              # no return value
            end

           The  body  of  your "flush" function should do a <b><a href="../man2/sync.2.html">sync</a></b>(2) or <b><a href="../man2/fdatasync.2.html">fdatasync</a></b>(2) or equivalent on the backing
           store.

           If the flush fails, your function should throw  an  exception,  optionally  using  "Nbdkit.set_error"
           first.

       "trim"
           (Optional)

            def trim(h, count, offset)
              # no return value
            end

           The body of your "trim" function should "punch a hole" in the backing store.  If the trim fails, your
           function should throw an exception, optionally using "Nbdkit.set_error" first.

       "zero"
           (Optional)

            def zero(h, count, offset, may_trim)
              # no return value

           The  body of your "zero" function should ensure that "count" bytes of the disk, starting at "offset",
           will read back as zero.  If "may_trim" is true, the operation may be optimized as a trim as  long  as
           subsequent reads see zeroes.

           NBD  only  supports  whole  writes,  so  your  function should try to write the whole region (perhaps
           requiring a loop).  If the write fails or is  partial,  your  function  should  throw  an  exception,
           optionally  using  "Nbdkit.set_error"  first.  In particular, if you would like to automatically fall
           back to "pwrite" (perhaps because  there  is  nothing  to  optimize  if  "may_trim"  is  false),  use
           "Nbdkit.set_error(Errno::EOPNOTSUPP)".

   <b>Missing</b> <b>callbacks</b>
       Missing: "load" and "unload"
           These are not needed because you can just use ordinary Ruby constructs.

       Missing: "name", "version", "longname", "description", "config_help", "can_fua", "can_cache", "cache"
           These are not yet supported.

   <b>Threads</b>
       The thread model for Ruby callbacks currently cannot be set from Ruby.  It is hard-coded in the C part to
       "NBDKIT_THREAD_MODEL_SERIALIZE_ALL_REQUESTS".  This may change or be settable in future.

</pre><h4><b>FILES</b></h4><pre>
       <u>$plugindir/nbdkit-ruby-plugin.so</u>
           The plugin.

           Use "nbdkit --dump-config" to find the location of $plugindir.

</pre><h4><b>VERSION</b></h4><pre>
       "nbdkit-ruby-plugin" first appeared in nbdkit 1.2.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man1/nbdkit.1.html">nbdkit</a></b>(1), <b><a href="../man3/nbdkit-plugin.3.html">nbdkit-plugin</a></b>(3), <b><a href="../man1/ruby.1.html">ruby</a></b>(1).

</pre><h4><b>AUTHORS</b></h4><pre>
       Eric Blake

       Richard W.M. Jones

</pre><h4><b>COPYRIGHT</b></h4><pre>
       Copyright (C) 2013-2020 Red Hat Inc.

</pre><h4><b>LICENSE</b></h4><pre>
       Redistribution  and  use in source and binary forms, with or without modification, are permitted provided
       that the following conditions are met:

       •   Redistributions of source code must retain the above copyright notice, this list  of  conditions  and
           the following disclaimer.

       •   Redistributions in binary form must reproduce the above copyright notice, this list of conditions and
           the following disclaimer in the documentation and/or other materials provided with the distribution.

       •   Neither  the  name  of  Red  Hat  nor the names of its contributors may be used to endorse or promote
           products derived from this software without specific prior written permission.

       THIS SOFTWARE IS PROVIDED BY RED HAT AND CONTRIBUTORS ''AS IS'' AND ANY EXPRESS  OR  IMPLIED  WARRANTIES,
       INCLUDING,  BUT  NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
       PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL RED HAT OR CONTRIBUTORS BE LIABLE  FOR  ANY  DIRECT,  INDIRECT,
       INCIDENTAL,  SPECIAL,  EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
       SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
       ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  LIABILITY,  OR  TORT  (INCLUDING  NEGLIGENCE  OR
       OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
       DAMAGE.

nbdkit-1.24.1                                      2021-01-20                              <u><a href="../man3/nbdkit-ruby-plugin.3.html">nbdkit-ruby-plugin</a></u>(3)
</pre>
 </div>
</div></section>
</div>
</body>
</html>