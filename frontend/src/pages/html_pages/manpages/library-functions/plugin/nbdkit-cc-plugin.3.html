<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nbdkit-cc-plugin - write small nbdkit plugins in inline C (and other languages)</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/nbdkit">nbdkit_1.42.4-1ubuntu1_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       nbdkit-cc-plugin - write small nbdkit plugins in inline C (and other languages)

</pre><h4><b>SYNOPSIS</b></h4><pre>
        nbdkit cc /path/to/plugin.c [CC=&lt;CC&gt;] [CFLAGS=&lt;CFLAGS&gt;]
                                    [EXTRA_CFLAGS=&lt;EXTRA_CFLAGS&gt;]

        nbdkit cc - &lt;&lt;'EOF'
        ... C code ...
        EOF

</pre><h4><b>DESCRIPTION</b></h4><pre>
       This plugin allows you to write small <b><a href="../man1/nbdkit.1.html">nbdkit</a></b>(1) plugins in C (and some other languages).  When you use
       this plugin it compiles your source code to a temporary plugin and then jumps into your compiled plugin.
       It is somewhat similar to <b><a href="../man3/nbdkit-sh-plugin.3.html">nbdkit-sh-plugin</a></b>(3), except for C source code.  This can also be used to write
       plugins which are "C scripts".

       <b>Note</b> this is not the way you normally write nbdkit plugins in C.  To understand how to write plugins in C
       normally, read <b><a href="../man3/nbdkit-plugin.3.html">nbdkit-plugin</a></b>(3).

   <b>Simple</b> <b>plugin</b> <b>example</b>
       Simple plugins from the nbdkit source tree can be compiled and run directly using commands such as:

        $ nbdkit cc plugins/example1/example1.c EXTRA_CFLAGS="-I. -Iinclude"

       You can also read the source from stdin using "-":

        $ nbdkit cc - EXTRA_CFLAGS="-I. -Iinclude" \
                    &lt; plugins/example1/example1.c

       To replace the compiler flags:

        $ nbdkit cc plugins/example1/example1.c \
                    CFLAGS="-O3 -mavx2 -fPIC -shared"

   <b>Compiler</b> <b>name</b> <b>and</b> <b>flags</b>
       The plugin parameters "CC", "CFLAGS" and "EXTRA_CFLAGS" (written in uppercase) can be used to control
       which C compiler and C compiler flags are used.  If not set, the default compiler and flags from when
       nbdkit was itself compiled from source are used.  To see what those were you can do:

        $ nbdkit cc --dump-plugin
        ...
        CC=gcc
        CFLAGS=-g -O2 -fPIC -shared

       The "CFLAGS" parameter overrides the built-in flags completely.  The "EXTRA_CFLAGS" parameter adds extra
       flags to the built-in flags.

   <b>Plugin</b> <b>API</b> <b>version</b>
       Plugins compiled this way must use the same API version as the cc plugin itself uses.  Currently this is
       "NBDKIT_API_VERSION=2".

   <b>C</b> <b>plugin</b> <b>as</b> <b>a</b> <b>self-contained</b> <b>script</b>
       You can create a C plugin which is a self-contained script by adding the following lines at the top and
       ensuring the C source is executable ("chmod +x plugin.c"):

        #if 0
        exec nbdkit cc "$0" "$@"
        #endif

       The script can be run as a command with additional nbdkit flags and plugin parameters, eg:

        ./plugin.c -f -v
        ./plugin.c -p 10000 --filter=cow
        ./plugin.c param=1

   <b>Using</b> <b>this</b> <b>plugin</b> <b>with</b> <b>C++</b>
        nbdkit cc CC=g++ source.cpp

       C++ plugin scripts can be created similarly to C, but you must add "CC=g++" as a parameter to exec
       nbdkit.

   <b>Using</b> <b>this</b> <b>plugin</b> <b>with</b> <b>OCaml</b>
        nbdkit cc CC=ocamlopt \
                  CFLAGS="-output-obj -runtime-variant _pic   NBDKit.cmx -cclib -lnbdkitocaml" \
                  source.ml

       OCaml plugin scripts can be created using this trick:

        (*<a href="file:/.">/.</a>)&gt;/dev/null 2&gt;&amp;1
        exec nbdkit cc "$0" \
             CC=ocamlopt \
             CFLAGS="-output-obj -runtime-variant _pic   NBDKit.cmx -cclib -lnbdkitocaml" \
             "$@"
        *)
        (* followed by OCaml code for the plugin here *)

       As with C plugin scripts, the file must be executable.  See also <b><a href="../man3/nbdkit-ocaml-plugin.3.html">nbdkit-ocaml-plugin</a></b>(3).

   <b>Using</b> <b>this</b> <b>plugin</b> <b>with</b> <b>other</b> <b>programming</b> <b>languages</b>
       This plugin can be used with most ahead-of-time compiled programming languages if they can create shared
       objects (<u>.so</u> files).  The only requirement is that the compiler ("CC") supports an <u>-o</u> option to write a
       shared object.

</pre><h4><b>PARAMETERS</b></h4><pre>
       The script name, or "-", must appear as the first parameter.

       <b>CC=</b>CC
       <b>CFLAGS="</b>CFLAGS<b>"</b>
       <b>EXTRA_CFLAGS="</b>EXTRA_CFLAGS<b>"</b>
           Override the compiler and flags.  See "Compiler name and flags" above.

       All other parameters on the command line are passed to the plugin.

</pre><h4><b>EXAMPLE</b></h4><pre>
        $ nbdkit cc - &lt;&lt;'EOF'
        #include &lt;<a href="file:/usr/include/stdint.h">stdint.h</a>&gt;
        #include &lt;<a href="file:/usr/include/string.h">string.h</a>&gt;

        #define NBDKIT_API_VERSION 2
        #include &lt;nbdkit-plugin.h&gt;

        char data[10*1024*1024];

        #define THREAD_MODEL NBDKIT_THREAD_MODEL_PARALLEL

        static void *
        my_open (int readonly)
        {
          return NBDKIT_HANDLE_NOT_NEEDED;
        }

        static int64_t
        my_get_size (void *handle)
        {
          return (int64_t) sizeof (data);
        }

        static int
        my_pread (void *handle, void *buf,
                  uint32_t count, uint64_t offset,
                  uint32_t flags)
        {
          memcpy (buf, data+offset, count);
          return 0;
        }

        static int
        my_pwrite (void *handle, const void *buf,
                   uint32_t count, uint64_t offset,
                   uint32_t flags)
        {
          memcpy (data+offset, buf, count);
          return 0;
        }

        static struct nbdkit_plugin plugin = {
          .name              = "myplugin",
          .open              = my_open,
          .get_size          = my_get_size,
          .pread             = my_pread,
          .pwrite            = my_pwrite,
        };

        NBDKIT_REGISTER_PLUGIN(plugin)
        EOF

</pre><h4><b>FILES</b></h4><pre>
       <u>$plugindir/nbdkit-cc-plugin.so</u>
           The plugin.

           Use "nbdkit --dump-config" to find the location of $plugindir.

</pre><h4><b>VERSION</b></h4><pre>
       "nbdkit-cc-plugin" first appeared in nbdkit 1.22.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man1/nbdkit.1.html">nbdkit</a></b>(1), <b><a href="../man3/nbdkit-plugin.3.html">nbdkit-plugin</a></b>(3), <b><a href="../man3/nbdkit-eval-plugin.3.html">nbdkit-eval-plugin</a></b>(3), <b><a href="../man3/nbdkit-ocaml-plugin.3.html">nbdkit-ocaml-plugin</a></b>(3), <b><a href="../man3/nbdkit-sh-plugin.3.html">nbdkit-sh-plugin</a></b>(3).

</pre><h4><b>AUTHORS</b></h4><pre>
       Richard W.M. Jones

</pre><h4><b>COPYRIGHT</b></h4><pre>
       Copyright Red Hat

</pre><h4><b>LICENSE</b></h4><pre>
       Redistribution  and  use in source and binary forms, with or without modification, are permitted provided
       that the following conditions are met:

       •   Redistributions of source code must retain the above copyright notice, this list  of  conditions  and
           the following disclaimer.

       •   Redistributions in binary form must reproduce the above copyright notice, this list of conditions and
           the following disclaimer in the documentation and/or other materials provided with the distribution.

       •   Neither  the  name  of  Red  Hat  nor the names of its contributors may be used to endorse or promote
           products derived from this software without specific prior written permission.

       THIS SOFTWARE IS PROVIDED BY RED HAT AND CONTRIBUTORS ''AS IS'' AND ANY EXPRESS  OR  IMPLIED  WARRANTIES,
       INCLUDING,  BUT  NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
       PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL RED HAT OR CONTRIBUTORS BE LIABLE  FOR  ANY  DIRECT,  INDIRECT,
       INCIDENTAL,  SPECIAL,  EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
       SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
       ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  LIABILITY,  OR  TORT  (INCLUDING  NEGLIGENCE  OR
       OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
       DAMAGE.

nbdkit-1.42.4                                      2025-06-16                                <u><a href="../man3/nbdkit-cc-plugin.3.html">nbdkit-cc-plugin</a></u>(3)
</pre>
 </div>
</div></section>
</div>
</body>
</html>