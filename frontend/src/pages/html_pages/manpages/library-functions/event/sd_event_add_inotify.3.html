<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sd_event_add_inotify, sd_event_add_inotify_fd, sd_event_source_get_inotify_mask,</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/libsystemd-dev">libsystemd-dev_257.7-1ubuntu3_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       sd_event_add_inotify, sd_event_add_inotify_fd, sd_event_source_get_inotify_mask,
       sd_event_source_get_inotify_path, sd_event_inotify_handler_t - Add an "inotify" file system inode event
       source to an event loop

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;systemd/sd-event.h&gt;</b>

       <b>typedef</b> <b>struct</b> <b>sd_event_source</b> <b>sd_event_source;</b>

       <b>typedef</b> <b>int</b> <b>(*sd_event_inotify_handler_t)(sd_event_source</b> <b>*</b><u>s</u><b>,</b> <b>const</b> <b>struct</b> <b>inotify_event</b> <b>*</b><u>event</u><b>,</b>
                                                 <b>void</b> <b>*</b><u>userdata</u><b>);</b>

       <b>int</b> <b>sd_event_add_inotify(sd_event</b> <b>*</b><u>event</u><b>,</b> <b>sd_event_source</b> <b>**</b><u>source</u><b>,</b> <b>const</b> <b>char</b> <b>*</b><u>path</u><b>,</b> <b>uint32_t</b> <u>mask</u><b>,</b>
                                <b>sd_event_inotify_handler_t</b> <u>handler</u><b>,</b> <b>void</b> <b>*</b><u>userdata</u><b>);</b>

       <b>int</b> <b>sd_event_add_inotify_fd(sd_event</b> <b>*</b><u>event</u><b>,</b> <b>sd_event_source</b> <b>**</b><u>source</u><b>,</b> <b>int</b> <u>fd</u><b>,</b> <b>uint32_t</b> <u>mask</u><b>,</b>
                                   <b>sd_event_inotify_handler_t</b> <u>handler</u><b>,</b> <b>void</b> <b>*</b><u>userdata</u><b>);</b>

       <b>int</b> <b>sd_event_source_get_inotify_mask(sd_event_source</b> <b>*</b><u>source</u><b>,</b> <b>uint32_t</b> <b>*</b><u>ret</u><b>);</b>

       <b>int</b> <b>sd_event_source_get_inotify_path(sd_event_source</b> <b>*</b><u>source</u><b>,</b> <b>const</b> <b>char</b> <b>**</b><u>ret</u><b>);</b>

</pre><h4><b>DESCRIPTION</b></h4><pre>
       <b>sd_event_add_inotify()</b> adds a new <b><a href="../man7/inotify.7.html">inotify</a></b>(7) file system inode event source to an event loop. The event
       loop object is specified in the <u>event</u> parameter, the event source object is returned in the <u>source</u>
       parameter. The <u>path</u> parameter specifies the path of the file system inode to watch. The <u>mask</u> parameter
       specifies which types of inode events to watch specifically. It must contain an OR-ed combination of
       <b>IN_ACCESS</b>, <b>IN_ATTRIB</b>, <b>IN_CLOSE_WRITE</b>, ... flags. See <b><a href="../man7/inotify.7.html">inotify</a></b>(7) for further information.

       The <u>handler</u> must reference a function to call when the inode changes or <b>NULL</b>. The handler function will
       be passed the <u>userdata</u> pointer, which may be chosen freely by the caller. The handler also receives a
       pointer to a struct inotify_event structure containing information about the inode event. The handler may
       return negative to signal an error (see below), other return values are ignored. If <u>handler</u> is <b>NULL</b>, a
       default handler that calls <b><a href="../man3/sd_event_exit.3.html">sd_event_exit</a></b>(3) will be used.

       <b>sd_event_add_inotify_fd()</b> is identical to <b>sd_event_add_inotify()</b>, except that it takes a file descriptor
       to an inode (possibly an <b>O_PATH</b> one, but any other will do too) instead of a path in the file system.

       If multiple event sources are installed for the same inode the backing inotify watch descriptor is
       automatically shared. The mask parameter may contain any flag defined by the inotify API, with the
       exception of <b>IN_MASK_ADD</b>.

       The handler is enabled continuously (<b>SD_EVENT_ON</b>), but this may be changed with
       <b><a href="../man3/sd_event_source_set_enabled.3.html">sd_event_source_set_enabled</a></b>(3). Alternatively, the <b>IN_ONESHOT</b> mask flag may be used to request
       <b>SD_EVENT_ONESHOT</b> mode. If the handler function returns a negative error code, it will be disabled after
       the invocation, even if the <b>SD_EVENT_ON</b> mode was requested before.

       As a special limitation the priority of inotify event sources may only be altered (see
       <b><a href="../man3/sd_event_source_set_priority.3.html">sd_event_source_set_priority</a></b>(3)) in the time between creation of the event source object with
       <b>sd_event_add_inotify()</b> and the beginning of the next event loop iteration. Attempts of changing the
       priority any later will be refused. Consider freeing and allocating a new inotify event source to change
       the priority at that point.

       To destroy an event source object use <b><a href="../man3/sd_event_source_unref.3.html">sd_event_source_unref</a></b>(3), but note that the event source is only
       removed from the event loop when all references to the event source are dropped. To make sure an event
       source does not fire anymore, even when there's still a reference to it kept, consider disabling it with
       <b><a href="../man3/sd_event_source_set_enabled.3.html">sd_event_source_set_enabled</a></b>(3).

       If the second parameter of <b>sd_event_add_inotify()</b> is passed as <b>NULL</b> no reference to the event source
       object is returned. In this case, the event source is considered "floating", and will be destroyed
       implicitly when the event loop itself is destroyed.

       If the <u>handler</u> parameter to <b>sd_event_add_inotify()</b> is <b>NULL</b>, and the event source fires, this will be
       considered a request to exit the event loop. In this case, the <u>userdata</u> parameter, cast to an integer, is
       passed as the exit code parameter to <b><a href="../man3/sd_event_exit.3.html">sd_event_exit</a></b>(3).

       <b>sd_event_source_get_inotify_mask()</b> retrieves the configured inotify watch mask of an event source created
       previously with <b>sd_event_add_inotify()</b>. It takes the event source object as the <u>source</u> parameter and a
       pointer to a <b>uint32_t</b> variable to return the mask in.

       <b>sd_event_source_get_inotify_path()</b> retrieves the target path of the configured inotify watch of an event
       source created previously with <b>sd_event_add_inotify()</b>. It takes the event source object as the <u>source</u>
       parameter and a pointer to a <b>const</b> <b>char</b> <b>**</b> variable to return the path in. The caller must not free the
       returned path.

</pre><h4><b>RETURN</b> <b>VALUE</b></h4><pre>
       On success, these functions return 0 or a positive integer. On failure, they return a negative
       errno-style error code.

   <b>Errors</b>
       Returned errors may indicate the following problems:

       <b>-ENOMEM</b>
           Not enough memory to allocate an object.

       <b>-EINVAL</b>
           An invalid argument has been passed. This includes specifying a mask with <b>IN_MASK_ADD</b> set.

       <b>-ESTALE</b>
           Returned by <b>sd_event_source_add_inotify()</b> or <b>sd_event_source_add_inotify_fd()</b> when the event loop is
           already terminated. Returned by <b>sd_event_source_get_inotify_path()</b> when no active inode data is
           assigned to the event source, e.g. when the event source is disabled.

       <b>-ECHILD</b>
           The event loop has been created in a different process, library or module instance.

       <b>-EDOM</b>
           The passed event source is not an inotify process event source.

       <b>-EBADF</b>
           The passed file descriptor is not valid.

       <b>-ENOSYS</b>
           <b>sd_event_add_inotify_fd()</b> or <b>sd_event_source_get_inotify_path()</b> was called without <a href="file:/proc/">/proc/</a> mounted.

</pre><h4><b>EXAMPLES</b></h4><pre>
       <b>Example</b> <b>1.</b> <b>A</b> <b>simple</b> <b>program</b> <b>that</b> <b>uses</b> <b>inotify</b> <b>to</b> <b>monitor</b> <b>one</b> <b>or</b> <b>two</b> <b>directories</b>

           /* SPDX-License-Identifier: MIT-0 */

           #include &lt;<a href="file:/usr/include/stdio.h">stdio.h</a>&gt;
           #include &lt;<a href="file:/usr/include/string.h">string.h</a>&gt;
           #include &lt;sys/inotify.h&gt;

           #include &lt;systemd/sd-event.h&gt;

           #define _cleanup_(f) __attribute__((cleanup(f)))

           static int inotify_handler(sd_event_source *source,
                                      const struct inotify_event *event,
                                      void *userdata) {

             const char *desc = NULL;

             sd_event_source_get_description(source, &amp;desc);

             if (event-&gt;mask &amp; IN_Q_OVERFLOW)
               printf("inotify-handler &lt;%s&gt;: overflow\n", desc);
             else if (event-&gt;mask &amp; IN_CREATE)
               printf("inotify-handler &lt;%s&gt;: create on %s\n", desc, event-&gt;name);
             else if (event-&gt;mask &amp; IN_DELETE)
               printf("inotify-handler &lt;%s&gt;: delete on %s\n", desc, event-&gt;name);
             else if (event-&gt;mask &amp; IN_MOVED_TO)
               printf("inotify-handler &lt;%s&gt;: moved-to on %s\n", desc, event-&gt;name);

             /* Terminate the program if an "exit" file appears */
             if ((event-&gt;mask &amp; (IN_CREATE|IN_MOVED_TO)) &amp;&amp;
                 strcmp(event-&gt;name, "exit") == 0)
               sd_event_exit(sd_event_source_get_event(source), 0);

             return 1;
           }

           int main(int argc, char **argv) {
             _cleanup_(sd_event_unrefp) sd_event *event = NULL;
             _cleanup_(sd_event_source_unrefp) sd_event_source *source1 = NULL, *source2 = NULL;

             const char *path1 = argc &gt; 1 ? argv[1] : "<a href="file:/tmp">/tmp</a>";
             const char *path2 = argc &gt; 2 ? argv[2] : NULL;

             /* Note: failure handling is omitted for brevity */

             sd_event_default(&amp;event);

             sd_event_add_inotify(event, &amp;source1, path1,
                                  IN_CREATE | IN_DELETE | IN_MODIFY | IN_MOVED_TO,
                                  inotify_handler, NULL);
             if (path2)
               sd_event_add_inotify(event, &amp;source2, path2,
                                    IN_CREATE | IN_DELETE | IN_MODIFY | IN_MOVED_TO,
                                    inotify_handler, NULL);

             sd_event_loop(event);

             return 0;
           }

</pre><h4><b>NOTES</b></h4><pre>
       Functions described here are available as a shared library, which can be compiled against and linked to
       with the <b>libsystemd</b> <b><a href="../man1/pkg-config.1.html">pkg-config</a></b>(1) file.

       The code described here uses <b><a href="../man3/getenv.3.html">getenv</a></b>(3), which is declared to be not multi-thread-safe. This means that
       the code calling the functions described here must not call <b><a href="../man3/setenv.3.html">setenv</a></b>(3) from a parallel thread. It is
       recommended to only do calls to <b>setenv()</b> from an early phase of the program when no other threads have
       been started.

</pre><h4><b>HISTORY</b></h4><pre>
       <b>sd_event_inotify_handler_t()</b>, <b>sd_event_add_inotify()</b>, and <b>sd_event_source_get_inotify_mask()</b> were added
       in version 239.

       <b>sd_event_add_inotify_fd()</b> was added in version 250.

       <b>sd_event_source_get_inotify_path()</b> was added in version 256.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man1/systemd.1.html">systemd</a></b>(1), <b><a href="../man3/sd-event.3.html">sd-event</a></b>(3), <b><a href="../man3/sd_event_new.3.html">sd_event_new</a></b>(3), <b><a href="../man3/sd_event_now.3.html">sd_event_now</a></b>(3), <b><a href="../man3/sd_event_add_io.3.html">sd_event_add_io</a></b>(3), <b><a href="../man3/sd_event_add_time.3.html">sd_event_add_time</a></b>(3),
       <b><a href="../man3/sd_event_add_signal.3.html">sd_event_add_signal</a></b>(3), <b><a href="../man3/sd_event_add_defer.3.html">sd_event_add_defer</a></b>(3), <b><a href="../man3/sd_event_add_child.3.html">sd_event_add_child</a></b>(3), <b><a href="../man3/sd_event_source_set_enabled.3.html">sd_event_source_set_enabled</a></b>(3),
       <b><a href="../man3/sd_event_source_set_priority.3.html">sd_event_source_set_priority</a></b>(3), <b><a href="../man3/sd_event_source_set_userdata.3.html">sd_event_source_set_userdata</a></b>(3), <b><a href="../man3/sd_event_source_set_description.3.html">sd_event_source_set_description</a></b>(3),
       <b><a href="../man3/sd_event_source_set_floating.3.html">sd_event_source_set_floating</a></b>(3), <b><a href="../man2/waitid.2.html">waitid</a></b>(2)

systemd 257.7                                                                            <u><a href="../man3/SD_EVENT_ADD_INOTIFY.3.html">SD_EVENT_ADD_INOTIFY</a></u>(3)
</pre>
 </div>
</div></section>
</div>
</body>
</html>