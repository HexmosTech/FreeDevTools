<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rte_red.h</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/dpdk-doc">dpdk-doc_24.11.2-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       rte_red.h

</pre><h4><b>SYNOPSIS</b></h4><pre>
       #include &lt;<a href="file:/usr/include/stdint.h">stdint.h</a>&gt;
       #include &lt;<a href="file:/usr/include/limits.h">limits.h</a>&gt;
       #include &lt;rte_debug.h&gt;
       #include &lt;rte_cycles.h&gt;
       #include &lt;rte_branch_prediction.h&gt;

   <b>Data</b> <b>Structures</b>
       struct <b>rte_red_params</b>
       struct <b>rte_red_config</b>
       struct <b>rte_red</b>

   <b>Macros</b>
       #define <b>RTE_RED_SCALING</b>   10
       #define <b>RTE_RED_S</b>   (1 &lt;&lt; 22)
       #define <b>RTE_RED_MAX_TH_MAX</b>   1023
       #define <b>RTE_RED_WQ_LOG2_MIN</b>   1
       #define <b>RTE_RED_WQ_LOG2_MAX</b>   12
       #define <b>RTE_RED_MAXP_INV_MIN</b>   1
       #define <b>RTE_RED_MAXP_INV_MAX</b>   255
       #define <b>RTE_RED_2POW16</b>   (1&lt;&lt;16)

   <b>Functions</b>
       int <b>rte_red_rt_data_init</b> (struct <b>rte_red</b> *red)
           Initialises run-time data.
       int <b>rte_red_config_init</b> (struct <b>rte_red_config</b> *red_cfg, const uint16_t wq_log2, const uint16_t min_th,
           const uint16_t max_th, const uint16_t maxp_inv)
           Configures a single RED configuration parameter structure.
       static uint32_t <b>rte_fast_rand</b> (void)
           Generate random number for RED.
       static uint16_t <b>__rte_red_calc_qempty_factor</b> (uint8_t wq_log2, uint16_t m)
           calculate factor to scale average queue size when queue becomes empty
       static int <b>rte_red_enqueue_empty</b> (const struct <b>rte_red_config</b> *red_cfg, struct <b>rte_red</b> *red, const
           uint64_t time)
           Updates queue average in condition when queue is empty.
       static int <b>__rte_red_drop</b> (const struct <b>rte_red_config</b> *red_cfg, struct <b>rte_red</b> *red)
           make a decision to drop or enqueue a packet based on mark probability criteria
       static int <b>rte_red_enqueue_nonempty</b> (const struct <b>rte_red_config</b> *red_cfg, struct <b>rte_red</b> *red, const
           unsigned q)
           Decides if new packet should be enqueued or dropped in queue non-empty case.
       static int <b>rte_red_enqueue</b> (const struct <b>rte_red_config</b> *red_cfg, struct <b>rte_red</b> *red, const unsigned q,
           const uint64_t time)
           Decides if new packet should be enqueued or dropped Updates run time data based on new queue size
           value. Based on new queue average and RED configuration parameters gives verdict whether to enqueue
           or drop the packet.
       static void <b>rte_red_mark_queue_empty</b> (struct <b>rte_red</b> *red, const uint64_t time)
           Callback to records time that queue became empty.

   <b>Variables</b>
       uint32_t <b>rte_red_rand_val</b>

</pre><h4><b>Detailed</b> <b>Description</b></h4><pre>
       RTE Random Early Detection (RED)

       Definition in file <b>rte_red.h</b>.

</pre><h4><b>Macro</b> <b>Definition</b> <b>Documentation</b></h4><pre>
   <b>#define</b> <b>RTE_RED_SCALING</b>   <b>10</b>
       Fraction size for fixed-point

       Definition at line <b>23</b> of file <b>rte_red.h</b>.

   <b>#define</b> <b>RTE_RED_S</b>   <b>(1</b> <b>&lt;&lt;</b> <b>22)</b>
       Packet size multiplied by number of leaf queues

       Definition at line <b>24</b> of file <b>rte_red.h</b>.

   <b>#define</b> <b>RTE_RED_MAX_TH_MAX</b>   <b>1023</b>
       Max threshold limit in fixed point format

       Definition at line <b>25</b> of file <b>rte_red.h</b>.

   <b>#define</b> <b>RTE_RED_WQ_LOG2_MIN</b>   <b>1</b>
       Min inverse filter weight value

       Definition at line <b>26</b> of file <b>rte_red.h</b>.

   <b>#define</b> <b>RTE_RED_WQ_LOG2_MAX</b>   <b>12</b>
       Max inverse filter weight value

       Definition at line <b>27</b> of file <b>rte_red.h</b>.

   <b>#define</b> <b>RTE_RED_MAXP_INV_MIN</b>   <b>1</b>
       Min inverse mark probability value

       Definition at line <b>28</b> of file <b>rte_red.h</b>.

   <b>#define</b> <b>RTE_RED_MAXP_INV_MAX</b>   <b>255</b>
       Max inverse mark probability value

       Definition at line <b>29</b> of file <b>rte_red.h</b>.

   <b>#define</b> <b>RTE_RED_2POW16</b>   <b>(1&lt;&lt;16)</b>
       2 power 16

       Definition at line <b>30</b> of file <b>rte_red.h</b>.

</pre><h4><b>Function</b> <b>Documentation</b></h4><pre>
   <b>int</b> <b>rte_red_rt_data_init</b> <b>(struct</b> <b>rte_red</b> <b>*</b> <b>red)</b>
       Initialises run-time data.

       <b>Parameters</b>
           <u>red</u> [in,out] data pointer to RED runtime data

       <b>Returns</b>
           Operation status

       <b>Return</b> <b>values</b>
           <u>0</u> success
           <u>!0</u> error

   <b>int</b> <b>rte_red_config_init</b> <b>(struct</b> <b>rte_red_config</b> <b>*</b> <b>red_cfg,</b> <b>const</b> <b>uint16_t</b> <b>wq_log2,</b> <b>const</b> <b>uint16_t</b> <b>min_th,</b>
       <b>const</b> <b>uint16_t</b> <b>max_th,</b> <b>const</b> <b>uint16_t</b> <b>maxp_inv)</b>
       Configures a single RED configuration parameter structure.

       <b>Parameters</b>
           <u>red_cfg</u> [in,out] config pointer to a RED configuration parameter structure
           <u>wq_log2</u> [in] log2 of the filter weight, valid range is: RTE_RED_WQ_LOG2_MIN &lt;= wq_log2 &lt;=
           RTE_RED_WQ_LOG2_MAX
           <u>min_th</u> [in] queue minimum threshold in number of packets
           <u>max_th</u> [in] queue maximum threshold in number of packets
           <u>maxp_inv</u> [in] inverse maximum mark probability

       <b>Returns</b>
           Operation status

       <b>Return</b> <b>values</b>
           <u>0</u> success
           <u>!0</u> error

   <b>static</b> <b>uint32_t</b> <b>rte_fast_rand</b> <b>(void)</b> <b>[inline],</b>  <b>[static]</b>
       Generate random number for RED. Implementation based on: <a href="http://software.intel.com/en-us/articles/fast">http://software.intel.com/en-us/articles/fast</a>-
       random-number-generator-on-the-intel-pentiumr-4-processor/

       10 bit shift has been found through empirical tests (was 16).

       <b>Returns</b>
           Random number between 0 and (2^22 - 1)

       Definition at line <b>116</b> of file <b>rte_red.h</b>.

   <b>static</b> <b>uint16_t</b> <b>__rte_red_calc_qempty_factor</b> <b>(uint8_t</b> <b>wq_log2,</b> <b>uint16_t</b> <b>m)</b> <b>[inline],</b>  <b>[static]</b>
       calculate factor to scale average queue size when queue becomes empty

       <b>Parameters</b>
           <u>wq_log2</u> [in] where EWMA filter weight wq = 1/(2 ^ wq_log2)
           <u>m</u> [in] exponent in the computed value (1 - wq) ^ m

       <b>Returns</b>
           computed value

       <b>Return</b> <b>values</b>
           <u>((1</u> - wq) ^ m) scaled in fixed-point format

       Basic math tells us that: a^b = 2^(b * log2(a) )

       in our case: a = (1-Wq) b = m Wq = 1/ (2^log2n)

       So we are computing this equation: factor = 2 ^ ( m * log2(1-Wq))

       First we are computing: n = m * log2(1-Wq)

       To avoid dealing with signed numbers log2 values are positive but they should be negative because (1-Wq)
       is always &lt; 1. Contents of log2 table values are also scaled for precision.

       The tricky part is computing 2^n, for this I split n into integer part and fraction part. f - is fraction
       part of n n - is integer part of original n

       Now using basic math we compute 2^n: 2^(f+n) = 2^f * 2^n 2^f - we use lookup table 2^n - can be replaced
       with bit shift right operations

       Definition at line <b>133</b> of file <b>rte_red.h</b>.

   <b>static</b> <b>int</b> <b>rte_red_enqueue_empty</b> <b>(const</b> <b>struct</b> <b>rte_red_config</b> <b>*</b> <b>red_cfg,</b> <b>struct</b> <b>rte_red</b> <b>*</b> <b>red,</b> <b>const</b> <b>uint64_t</b>
       <b>time)</b> <b>[inline],</b>  <b>[static]</b>
       Updates queue average in condition when queue is empty. Note: packet is never dropped in this particular
       case.

       <b>Parameters</b>
           <u>red_cfg</u> [in] config pointer to a RED configuration parameter structure
           <u>red</u> [in,out] data pointer to RED runtime data
           <u>time</u> [in] current time stamp

       <b>Returns</b>
           Operation status

       <b>Return</b> <b>values</b>
           <u>0</u> enqueue the packet
           <u>1</u> drop the packet based on max threshold criterion
           <u>2</u> drop the packet based on mark probability criterion

       We compute avg but we don't compare avg against min_th or max_th, nor calculate drop probability

       m is the number of packets that might have arrived while the queue was empty. In this case we have time
       stamps provided by scheduler in byte units (bytes transmitted on network port). Such time stamp
       translates into time units as port speed is fixed but such approach simplifies the code.

       Check that m will fit into 16-bit unsigned integer

       Definition at line <b>196</b> of file <b>rte_red.h</b>.

   <b>static</b> <b>int</b> <b>__rte_red_drop</b> <b>(const</b> <b>struct</b> <b>rte_red_config</b> <b>*</b> <b>red_cfg,</b> <b>struct</b> <b>rte_red</b> <b>*</b> <b>red)</b> <b>[inline],</b>  <b>[static]</b>
       make a decision to drop or enqueue a packet based on mark probability criteria Drop probability (Sally
       Floyd and Van Jacobson):

       pb = (1 / maxp_inv) * (avg - min_th) / (max_th - min_th) pa = pb / (2 - count * pb)

                  (1 / maxp_inv) * (avg - min_th)
                 ---------------------------------
                          max_th - min_th

        pa = ----------------------------------------------- count * (1 / maxp_inv) * (avg - min_th) 2 -
       ----------------------------------------- max_th - min_th

                                   avg - min_th

        pa = ----------------------------------------------------------- 2 * (max_th - min_th) * maxp_inv -
       count * (avg - min_th)

       We define pa_const as: pa_const = 2 * (max_th - min_th) * maxp_inv. Then:

                      avg - min_th

        pa = ----------------------------------- pa_const - count * (avg - min_th)

       <b>Parameters</b>
           <u>red_cfg</u> [in] config pointer to structure defining RED parameters
           <u>red</u> [in,out] data pointer to RED runtime data

       <b>Returns</b>
           operation status

       <b>Return</b> <b>values</b>
           <u>0</u> enqueue the packet
           <u>1</u> drop the packet

       Definition at line <b>274</b> of file <b>rte_red.h</b>.

   <b>static</b> <b>int</b> <b>rte_red_enqueue_nonempty</b> <b>(const</b> <b>struct</b> <b>rte_red_config</b> <b>*</b> <b>red_cfg,</b> <b>struct</b> <b>rte_red</b> <b>*</b> <b>red,</b> <b>const</b>
       <b>unsigned</b> <b>q)</b> <b>[inline],</b>  <b>[static]</b>
       Decides if new packet should be enqueued or dropped in queue non-empty case.

       <b>Parameters</b>
           <u>red_cfg</u> [in] config pointer to a RED configuration parameter structure
           <u>red</u> [in,out] data pointer to RED runtime data
           <u>q</u> [in] current queue size (measured in packets)

       <b>Returns</b>
           Operation status

       <b>Return</b> <b>values</b>
           <u>0</u> enqueue the packet
           <u>1</u> drop the packet based on max threshold criterion
           <u>2</u> drop the packet based on mark probability criterion

       EWMA filter (Sally Floyd and Van Jacobson): avg = (1 - wq) * avg + wq * q avg = avg + q * wq - avg * wq

       We select: wq = 2^(-n). Let scaled version of avg be: avg_s = avg * 2^(N+n). We get: avg_s = avg_s + q *
       2^N - avg_s * 2^(-n)

       By using shift left/right operations, we get: avg_s = avg_s + (q &lt;&lt; N) - (avg_s &gt;&gt; n) avg_s += (q &lt;&lt; N) -
       (avg_s &gt;&gt; n)

       Definition at line <b>313</b> of file <b>rte_red.h</b>.

   <b>static</b> <b>int</b> <b>rte_red_enqueue</b> <b>(const</b> <b>struct</b> <b>rte_red_config</b> <b>*</b> <b>red_cfg,</b> <b>struct</b> <b>rte_red</b> <b>*</b> <b>red,</b> <b>const</b> <b>unsigned</b> <b>q,</b>
       <b>const</b> <b>uint64_t</b> <b>time)</b> <b>[inline],</b>  <b>[static]</b>
       Decides if new packet should be enqueued or dropped Updates run time data based on new queue size value.
       Based on new queue average and RED configuration parameters gives verdict whether to enqueue or drop the
       packet.

       <b>Parameters</b>
           <u>red_cfg</u> [in] config pointer to a RED configuration parameter structure
           <u>red</u> [in,out] data pointer to RED runtime data
           <u>q</u> [in] updated queue size in packets
           <u>time</u> [in] current time stamp

       <b>Returns</b>
           Operation status

       <b>Return</b> <b>values</b>
           <u>0</u> enqueue the packet
           <u>1</u> drop the packet based on max threshold criteria
           <u>2</u> drop the packet based on mark probability criteria

       Definition at line <b>375</b> of file <b>rte_red.h</b>.

   <b>static</b> <b>void</b> <b>rte_red_mark_queue_empty</b> <b>(struct</b> <b>rte_red</b> <b>*</b> <b>red,</b> <b>const</b> <b>uint64_t</b> <b>time)</b> <b>[inline],</b>  <b>[static]</b>
       Callback to records time that queue became empty.

       <b>Parameters</b>
           <u>red</u> [in,out] data pointer to RED runtime data
           <u>time</u> [in] current time stamp

       Definition at line <b>397</b> of file <b>rte_red.h</b>.

</pre><h4><b>Variable</b> <b>Documentation</b></h4><pre>
   <b>uint32_t</b> <b>rte_red_rand_val</b> <b>[extern]</b>
       Externs

</pre><h4><b>Author</b></h4><pre>
       Generated automatically by Doxygen for DPDK from the source code.

DPDK                                             Version 24.11.2                                    <u><a href="../man3/rte_red.h.3.html">rte_red.h</a></u>(3)
</pre>
 </div>
</div></section>
</div>
</body>
</html>