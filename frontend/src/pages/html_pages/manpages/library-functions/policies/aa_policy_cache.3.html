<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aa_policy_cache - an opaque object representing an AppArmor policy cache</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/libapparmor-dev">libapparmor-dev_5.0.0~alpha1-0ubuntu4_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       aa_policy_cache - an opaque object representing an AppArmor policy cache

       aa_policy_cache_new - create a new aa_policy_cache object from a path

       aa_policy_cache_ref - increments the ref count of an aa_policy_cache object

       aa_policy_cache_unref - decrements the ref count and frees the aa_policy_cache object when 0

       aa_policy_cache_remove - removes all policy cache files under a path

       aa_policy_cache_replace_all - performs a kernel policy replacement of all cached policies

       aa_policy_cache_dir_path - returns the path to the aa_policy_cache directory

       aa_policy_cache_dir_path_preview - returns a preview of the path to the aa_policy_cache directory without
       an existing aa_policy_cache object

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;sys/apparmor.h&gt;</b>

       <b>typedef</b> <b>struct</b> <b>aa_policy_cache</b> <b>aa_policy_cache;</b>

       <b>int</b> <b>aa_policy_cache_new(aa_policy_cache</b> <b>**policy_cache,</b> <b>aa_features</b> <b>*kernel_features,</b> <b>int</b> <b>dirfd,</b> <b>const</b>
       <b>char</b> <b>*path,</b> <b>uint16_t</b> <b>max_caches);</b>

       <b>int</b> <b>aa_policy_cache_add_ro_dir(aa_policy_cache</b> <b>*policy_cache,</b> <b>int</b> <b>dirfd,</b> <b>const</b> <b>char</b> <b>*path);</b>

       <b>aa_policy_cache</b> <b>*aa_policy_cache_ref(aa_policy_cache</b> <b>*policy_cache);</b>

       <b>void</b> <b>aa_policy_cache_unref(aa_policy_cache</b> <b>*policy_cache);</b>

       <b>int</b> <b>aa_policy_cache_remove(int</b> <b>dirfd,</b> <b>const</b> <b>char</b> <b>*path);</b>

       <b>int</b> <b>aa_policy_cache_replace_all(aa_policy_cache</b> <b>*policy_cache,</b> <b>aa_kernel_interface</b> <b>*kernel_interface);</b>

       <b>char</b> <b>*aa_policy_cache_dir_path(aa_policy_cache</b> <b>*policy_cache,</b> <b>int</b> <b>level);</b>

       <b>char</b> <b>*aa_policy_cache_dir_path_preview(aa_features</b> <b>*kernel_features,</b> <b>int</b> <b>dirfd,</b> <b>const</b> <b>char</b> <b>*path);</b>

       Link with <b>-lapparmor</b> when compiling.

</pre><h4><b>DESCRIPTION</b></h4><pre>
       The <u>aa_policy_cache</u> object contains information about a set of AppArmor policy cache files. The policy
       cache files are the binary representation of a human-readable AppArmor profile. The binary representation
       is the form that is loaded into the kernel.

       The <b>aa_policy_cache_new()</b> function creates an <u>aa_policy_cache</u> object based upon a directory file
       descriptor and path. See the <b><a href="../man2/openat.2.html">openat</a></b>(2) man page for examples of <u>dirfd</u> and <u>path</u>. The <u>path</u> must point to a
       directory and it will be used as the basis for the location of policy cache files. See
       <u>aa_policy_cache_dir_path</u> to find out which directory will be used to store the binary policy cache files.
       If additional overlay cache directories are used (see <u>aa_policy_cache_add_ro_dir</u>) the directory specified
       in <u>aa_policy_cache_new</u> is the first directory searched and is the writable overlay. If <u>kernel_features</u> is
       NULL, then the features of the current kernel are used. When specifying a valid <u>kernel_features</u> object,
       it must be compatible with the features of the kernel of interest.  The value of <u>max_caches</u> should be
       equal to the number of caches that should be allowed before old caches are automatically reaped. The
       definition of what is considered to be an old cache is private to libapparmor. Specifying 0 means that no
       new caches should be created and only existing, valid caches may be used.  Specifying UINT16_MAX means
       that a new cache may be created and that the reaping of old caches is disabled. The allocated
       <u>aa_policy_cache</u> object must be freed using <b>aa_policy_cache_unref()</b>.

       The <b>aa_policy_cache_add_ro_dir()</b> function adds an existing cache directory to the policy cache, as a
       readonly layer under the primary directory the cache was created with. When the cache is searched for an
       existing cache file the primary directory will be searched and then the readonly directories in the order
       that they were added to the policy cache.  This allows the policy cache to be seeded with precompiled
       policy that can be updated by overlaying the read only cache file with one written to the primary cache
       dir.

       <b>aa_policy_cache_ref()</b> increments the reference count on the <u>policy_cache</u> object.

       <b>aa_policy_cache_unref()</b> decrements the reference count on the <u>policy_cache</u> object and releases all
       corresponding resources when the reference count reaches zero.

       The <b>aa_policy_cache_remove()</b> function deletes all of the policy cache files based upon a directory file
       descriptor and path. The <u>path</u> must point to a directory. See the <b><a href="../man2/openat.2.html">openat</a></b>(2) man page for examples of <u>dirfd</u>
       and <u>path</u>.

       The <b>aa_policy_cache_replace_all()</b> function can be used to perform a policy replacement of all of the
       cache policies in the cache directory represented by the <u>policy_cache</u> object. If <u>kernel_interface</u> is
       NULL, then the current kernel interface is used. When specifying a valid <u>kernel_interface</u> object, it must
       be the interface of the currently running kernel.

       The <b>aa_policy_cache_dir_path()</b> function provides the path to the cache directory for a <u>policy_cache</u>
       object at <u>level</u> in the policy cache overlay of cache directories. A <u>level</u> of 0 will always be present and
       is the first directory to search in an overlay of cache directories, and will also be the writable cache
       directory layer. Binary policy cache files will be located in the directory returned by this function.

       The <b>aa_policy_cache_dir_levels()</b> function provides access to the number of directories that are being
       overlaid to create the policy cache.

</pre><h4><b>RETURN</b> <b>VALUE</b></h4><pre>
       The <b>aa_policy_cache_new()</b> function returns 0 on success and <u>*policy_cache</u> will point to an
       <u>aa_policy_cache</u> object that must be freed by <b>aa_policy_cache_unref()</b>. -1 is returned on error, with errno
       set appropriately, and <u>*policy_cache</u> will be set to NULL.

       <b>aa_policy_cache_ref()</b> returns the value of <u>policy_cache</u>.

       <b>aa_policy_cache_remove()</b> and <b>aa_policy_cache_replace_all()</b> return 0 on success.  -1 is returned on error,
       with errno set appropriately.

       <b>aa_policy_cache_dir_path()</b> returns a path string which must be freed by the caller. NULL is returned on
       error, with errno set appropriately.

       <b>aa_policy_cache_dir_levels()</b> returns a number indicating the number of directory levels there are
       associated with the <u>policy_cache</u>.

       <b>aa_policy_cache_dir_path_preview()</b> is the same as <b>aa_policy_cache_dir_path()</b> except that it doesn't
       require an existing <u>aa_policy_cache</u> object. This is useful if the calling program cannot create an
       <u>aa_policy_cache</u> object due to lack of privileges needed to create the cache directory.

</pre><h4><b>ERRORS</b></h4><pre>
       The errno value will be set according to the underlying error in the <u>aa_policy_cache</u> family of functions
       that return -1 or NULL on error.

</pre><h4><b>NOTES</b></h4><pre>
       All aa_policy_cache functions described above, except for the <b>aa_policy_cache_dir_path()</b> function was
       added in libapparmor version 2.13. All the other aa_policy_cache functions described above are present in
       libapparmor version 2.10.

       <b>aa_policy_cache_unref()</b> saves the value of errno when called and restores errno before exiting in
       libapparmor version 2.12 and newer.

</pre><h4><b>BUGS</b></h4><pre>
       None known. If you find any, please report them at &lt;https://gitlab.com/apparmor/apparmor/-/issues&gt;.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man3/aa_features.3.html">aa_features</a></b>(3), <b><a href="../man3/aa_kernel_interface.3.html">aa_kernel_interface</a></b>(3), <b><a href="../man2/openat.2.html">openat</a></b>(2) and &lt;https://wiki.apparmor.net&gt;.

AppArmor 5.0.0~alpha1                              2025-08-19                                 <u><a href="../man3/aa_policy_cache.3.html">aa_policy_cache</a></u>(3)
</pre>
 </div>
</div></section>
</div>
</body>
</html>