<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vmod_bodyaccess - Varnish Module for request body access</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/varnish-modules">varnish-modules_0.25.0-2_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       vmod_bodyaccess - Varnish Module for request body access

</pre><h4><b>SYNOPSIS</b></h4><pre>
          import bodyaccess [as name] [from "path"]

          INT rematch_req_body(REGEX re)

          VOID hash_req_body()

          INT len_req_body()

          VOID log_req_body(STRING prefix, INT length)

</pre><h4><b>DESCRIPTION</b></h4><pre>
       Varnish module that lets you access the request body.

       VCL example:

          vcl 4.0;
          import std;
          import bodyaccess;

          backend default { .host = "192.0.2.11"; .port = "8080"; }

          sub vcl_recv {
                  if (req.method == "POST") {
                          set req.http.x-method = req.method;
                          if (<a href="../man110KB/std.cache_req_body.110KB.html">std.cache_req_body</a>(110KB)) {
                                  set req.http.x-len = bodyaccess.len_req_body();
                                  set req.http.x-re = bodyaccess.rematch_req_body("Regex");
                                  bodyaccess.log_req_body("PREFIX:", 3);
                          }
                  }
          return(hash);
          }

          sub vcl_hash {
                  bodyaccess.hash_req_body();
                  return (lookup);
          }

          sub vcl_backend_fetch {
                  set bereq.method = bereq.http.x-method;
          }

          sub vcl_deliver {
                  set resp.http.x-len = req.http.x-len;
                  set resp.http.x-re = req.http.x-re;
          }

       N.B.  The request body must be retrieved before doing any operations on it.  It can be buffered using the
       cache_req_body() function from libvmod_std.

       These functions applies only to standard REST methods.  Caching is <u>not</u> allowed on PUT requests.

   <b>INT</b> <b>rematch_req_body(REGEX</b> <b>re)</b>
       <b>Description</b>
              Returns -1 if an error occurrs.  Returns 0 if the request body  doesn't  contain  the  string  <u>re</u>.
              Returns 1 if the request body contains the string <u>re</u>.

              Note that the comparison is case sensitive and the request body must be buffered.

       <b>Example</b>

                 | <a href="../man1KB/std.cache_req_body.1KB.html">std.cache_req_body</a>(1KB);
                 |
                 | if (bodyaccess.rematch_req_body("FOO") == 1) {
                 |    std.log("is true");
                 | }

   <b>VOID</b> <b>hash_req_body()</b>
       <b>Description</b>
              Adds  available  request  body  bytes to the lookup hash key.  Note that this function can only be
              used in vcl_hash and the request body must be buffered.

       <b>Example</b>

                 | sub vcl_recv {
                 |     <a href="../man1KB/std.cache_req_body.1KB.html">std.cache_req_body</a>(1KB);
                 | }
                 |
                 | sub vcl_hash{
                 |     bodyaccess.hash_req_body();
                 | }

   <b>INT</b> <b>len_req_body()</b>
       <b>Description</b>
              Returns the request body length or -1 if an error occurs.

              Note that the request body must be buffered.

       <b>Example</b>

                 | <a href="../man1KB/std.cache_req_body.1KB.html">std.cache_req_body</a>(1KB);
                 | set req.http.x-len = bodyaccess.len_req_body();

   <b>VOID</b> <b>log_req_body(STRING</b> <b>prefix="",</b> <b>INT</b> <b>length=200)</b>
       <b>Description</b>
              Log the request body to the VSL, making it available for other components.  When logging, it takes
              an optional prefix and a max line length, so the body could be split up across multiple  lines  as
              there is a limit to how large a single line can be.

       <b>Example</b>

                 | <a href="../man1KB/std.cache_req_body.1KB.html">std.cache_req_body</a>(1KB);
                 | bodyaccess.log_req_body("PREFIX:", 3);

                                                                                              <u><a href="../man3/VMOD_BODYACCESS.3.html">VMOD_BODYACCESS</a></u>(3)
</pre>
 </div>
</div></section>
</div>
</body>
</html>