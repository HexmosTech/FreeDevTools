<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nfstest.test_util - Test utilities module</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/nfstest">nfstest_3.2-3_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       nfstest.test_util - Test utilities module

</pre><h4><b>DESCRIPTION</b></h4><pre>
       Provides a set of tools for testing either the NFS client or the NFS server, most of the functionality is
       focused mainly on testing the client.  These tools include the following:

           - Process command line arguments
           - Provide functionality for PASS/FAIL
           - Provide test grouping functionality
           - Provide multiple client support
           - Logging mechanism
           - Debug info control
           - Mount/Unmount control
           - Create files/directories
           - Provide mechanism to start a packet trace
           - Provide mechanism to simulate a network partition
           - Support for pNFS testing

       In order to use some of the functionality available, the user id in all the client hosts must have access
       to  run commands as root using the 'sudo' command without the need for a password, this includes the host
       where the test is being executed. This is used to run commands like 'mount'  and  'umount'.  Furthermore,
       the  user id must be able to ssh to remote hosts without the need for a password if test requires the use
       of multiple clients.

       Network partition is simulated by the use of 'iptables', please be advised that after every test run  the
       iptables  is  flushed  and  reset  so  any  rules  previously  setup will be lost. Currently, there is no
       mechanism to restore the iptables rules to their original state.

</pre><h4><b>CLASSES</b></h4><pre>
   <b>class</b> <b>TestUtil(nfstest.nfs_util.NFSUtil)</b>
       TestUtil object

       TestUtil() -&gt; New server object

       Usage:
           x = TestUtil()

           # Process command line options
           x.scan_options()

           # Start packet trace using tcpdump
           x.trace_start()

           # Mount volume
           x.mount()

           # Create file
           x.create_file()

           # Unmount volume
           x.umount()

           # Stop packet trace
           x.trace_stop()

           # Exit script
           x.exit()

       <b>Methods</b> <b>defined</b> <b>here:</b>
       ---------------------

       <b>__del__(self)</b>
       Destructor

       Gracefully stop the packet trace, cleanup files, unmount volume,
       and reset network.

       <b>__init__(self,</b> <b>**kwargs)</b>
       Constructor

       Initialize object's private data.

              <b>sid:</b>   Test script ID [default: '']
                     This is used to have options targeted for a given ID without
                     including these options in any other test script.

              <b>usage:</b> Usage string [default: '']

              <b>testnames:</b>
                     List of test names [default: []]
                     When this list is not empty, the --runtest option is enabled and
                     test scripts should use the run_tests() method to run all the
                     tests. Test script should have methods named as &lt;testname&gt;_test.

              <b>testgroups:</b>
                     Dictionary of test groups where the key is the name of the test
                     group and its value is a dictionary having the following keys:
                     tests:
                     A list of tests belonging to this test group
                     desc:
                     Description of the test group, this is displayed
                     in the help if the name of the test group is also
                     included in testnames
                     tincl:
                     Include a comma separated list of tests belonging to
                     this test group to the description [default: False]
                     wrap:
                     Reformat the description so it fits in lines no
                     more than the width given. The description is not
                     formatted for a value of zero [default: 72]

              Example:
                  x = TestUtil(testnames=['basic', 'lock'])

                  # The following methods should exist:
                  x.basic_test()
                  x.lock_test()

       <b>cleanup(self)</b>
       Clean up test environment.

       Remove any files created: test files, trace files.

       <b>close_files(self,</b> <b>*fdlist)</b>
       Close all files opened by open_files() and all file descriptors
       given as arguments.

       <b>compare_data(self,</b> <b>data,</b> <b>offset=0,</b> <b>pattern=None,</b> <b>nlen=32,</b> <b>fd=None,</b> <b>msg='')</b>
       Compare data to the given pattern and return a three item tuple:
       absolute offset where data differs from pattern, sample data at
       diff offset, and the expected data at diff offset according to
       pattern. If data matches exactly it returns (None, None, None).

              <b>data:</b>  Data to compare against the pattern

              <b>offset:</b>
                     Absolute offset to get the expected data from pattern
                     [default: 0]

              <b>pattern:</b>
                     Data pattern function or string. If this is a function,
                     it must take offset and size as positional arguments.
                     If given as a string, the pattern repeats over and over
                     starting at offset = 0 [default: self.data_pattern]

              <b>nlen:</b>  Size of sample data to return if a difference is found
                     [default: 32]

              <b>fd:</b>    Opened file descriptor for the data, this is used where
                     the data comes from a file and a difference is found right
                     at the end of the given data. In this case, the data is
                     read from the file to return the sample diff of size given
                     by nlen [default: None]

              <b>msg:</b>   Message to append to debug message if a difference is
                     found. If set to None, debug messages are not displayed
                     [default: '']

       <b>compare_mount_args(self,</b> <b>mtopts1,</b> <b>mtopts2)</b>
       Compare mount arguments

       <b>config(self,</b> <b>msg)</b>
       Display config message and terminate test with an exit value of 2.

       <b>create_dir(self,</b> <b>dir=None,</b> <b>mode=493)</b>
       Create a directory under the given directory with the given mode.

       <b>create_file(self,</b> <b>offset=0,</b> <b>size=None,</b> <b>dir=None,</b> <b>mode=None,</b> <b>**kwds)</b>
       Create a file starting to write at given offset with total size
       of written data given by the size option.

              <b>offset:</b>
                     File offset where data will be written to [default: 0]

              <b>size:</b>  Total number of bytes to write [default: --filesize option]

              <b>dir:</b>   Create file under this directory

              <b>mode:</b>  File permissions [default: use default OS permissions]

              <b>pattern:</b>
                     Data pattern to write to the file [default: data_pattern default]

              <b>ftype:</b> File type to create [default: FTYPE_FILE]

              <b>hole_list:</b>
                     List of offsets where each hole is located [default: None]

              <b>hole_size:</b>
                     Size of each hole [default: --wsize option]

              <b>verbose:</b>
                     Verbosity level [default: 0]

              <b>dlevels:</b>
                     Debug level list to use [default: ["DBG2", "DBG3", "DBG4"]]

              Returns the file name created, the file name is also stored
              in the object attribute filename -- attribute absfile is also
              available as the absolute path of the file just created.

              File created is removed at cleanup.

       <b>create_rexec(self,</b> <b>servername=None,</b> <b>**kwds)</b>
       Create remote server object.

       <b>data_pattern(self,</b> <b>offset,</b> <b>size,</b> <b>pattern=None)</b>
       Return data pattern.

              <b>offset:</b>
                     Starting offset of pattern

              <b>size:</b>  Size of data to return

              <b>pattern:</b>
                     Data pattern to return, default is of the form:
                     hex_offset(0x%08X) abcdefghijklmnopqrst

       <b>delay_io(self,</b> <b>delay=None)</b>
       Delay I/O by value given or the value given in --iodelay option.

       <b>exit(self)</b>
       Terminate script with an exit value of 0 when all tests passed
       and a value of 1 when there is at least one test failure.

       <b>get_dirname(self,</b> <b>dir=None)</b>
       Return a unique directory name under the given directory.

       <b>get_filename(self,</b> <b>dir=None)</b>
       Return a unique file name under the given directory.

       <b>get_logname(self,</b> <b>remote=False)</b>
       Get next log file name.

       <b>get_marker_index(self,</b> <b>marker_id=None)</b>
       Find packet index of the trace marker given by the marker id

              <b>marker_id:</b>
                     ID of trace marker to find in the packet trace, if this is
                     not given the current marker id is used [default: None]

       <b>get_name(self)</b>
       Get unique name for this instance.

       <b>insert_trace_marker(self,</b> <b>name=None)</b>
       Send a LOOKUP for an unknown file to have a marker in
       the packet trace and return the trace marker id

              <b>name:</b>  Use this name as the trace marker but the caller must make
                     sure this is a unique name in order to find the correct
                     index for this marker. This could also be used to add any
                     arbitrary information to the packet trace [default: None]

       <b>lock_files(self,</b> <b>lock_type=None,</b> <b>offset=0,</b> <b>length=0)</b>
       Lock all files opened by open_files().

       <b>need_run_test(self,</b> <b>testname)</b>
       Return True only if user explicitly requested to run this test

       <b>open_files(self,</b> <b>mode,</b> <b>create=True)</b>
       Open files according to given mode, the file descriptors are saved
       internally to be used with write_files(), read_files() and
       close_files(). The number of files to open is controlled by
       the command line option '--nfiles'.

       The mode could be either 'r' or 'w' for opening files for reading
       or writing respectively. The open flags for mode 'r' is O_RDONLY
       while for mode 'w' is O_WRONLY|O_CREAT|O_SYNC. The O_SYNC is used
       to avoid the client buffering the written data.

       <b>process_client_option(self,</b> <b>option='client',</b> <b>remote=True,</b> <b>count=1)</b>
       Process the client option

       Clients are separated by a "," and each client definition can have
       the following options separated by ":":
           client:server:export:nfsversion:port:proto:sec:mtpoint

              <b>option:</b>
                     Option name [default: "client"]

              <b>remote:</b>
                     Expect a client hostname or IP address in the definition.
                     If this is set to None do not verify client name or IP.
                     [default: True]

              <b>count:</b> Number of client definitions to expect. If remote is True,
                     return the number of definitions listed in the given option
                     up to this number. If remote is False, return exactly this
                     number of definitions [default: 1]

              Examples:
                  # Using positional arguments with nfsversion=4.1 for client1
                  client=client1:::4.1,client2

                  # Using named arguments instead
                  client=client1:nfsversion=4.1,client2

       <b>process_option(self,</b> <b>value,</b> <b>arglist=[],</b> <b>typemap={})</b>
       Process option with a list of items separated by "," and each
       item in the list could have different arguments separated by ":".

              <b>value:</b> String of comma separated elements

              <b>arglist:</b>
                     Positional order of arguments, if this list is empty,
                     then use named arguments only [default: []]

              <b>typemap:</b>
                     Dictionary to convert arguments to their given types,
                     where the key is the argument name and its value is the
                     type function to use to convert the argument [default: {}]

       <b>read_files(self)</b>
       Read a block of data (size given by --rsize) from all files opened
       by open_files() for reading.

       <b>remove_test(self,</b> <b>testname)</b>
       Remove all instances of test from the list of tests to run

       <b>run_func(self,</b> <b>func,</b> <b>*args,</b> <b>**kwargs)</b>
       Run function with the given arguments and return the results.
       All positional arguments are passed to the function while the
       named arguments change the behavior of the method.
       Object attribute "oserror" is set to the OSError object if the
       function fails.

              <b>msg:</b>   Test assertion message [default: None]

              <b>err:</b>   Expected error number [default: 0]

       <b>run_tests(self,</b> <b>**kwargs)</b>
       Run all test specified by the --runtest option.

              <b>testnames:</b>
                     List of testnames to run [default: all tests given by --testnames]

              All other arguments given are passed to the test methods.

       <b>scan_options(self)</b>
       Process command line options.

       Process all the options in the file given by '--file', then the
       ones in the command line. This allows for command line options
       to over write options given in the file.

       Format of options file:
           # For options expecting a value
           &lt;option_name&gt; = &lt;value&gt;

           # For boolean (flag) options
           &lt;option_name&gt;

       Process options files and make sure not to process the same file
       twice, this is used for the case where HOMECFG and CWDCFG are the
       same, more specifically when environment variable HOME is not
       defined. Also, the precedence order is defined as follows:
         1. options given in command line
         2. options given in file specified by the -f|--file option
         3. options given in file specified by ./.nfstest
         4. options given in file specified by $HOME/.nfstest
         5. options given in file specified by /etc/nfstest

       NOTE:
         Must use the long name of the option (--&lt;option_name&gt;) in the file.

       <b>set_nfserr_list(self,</b> <b>nfs3list=[],</b> <b>nfs4list=[],</b> <b>nlm4list=[],</b> <b>mnt3list=[])</b>
       Temporaly set the NFS list of expected NFS errors in the next call
       to trace_open

       <b>setup(self,</b> <b>nfiles=None)</b>
       Set up test environment.

       Create nfiles number of files [default: --nfiles option]

       <b>str_args(self,</b> <b>args)</b>
       Return the formal string representation of the given list
       where string objects are truncated.

       <b>test(self,</b> <b>expr,</b> <b>msg,</b> <b>subtest=None,</b> <b>failmsg=None,</b> <b>terminate=False)</b>
       Test expr and display message as PASS/FAIL, terminate execution
       if terminate option is True.

              <b>expr:</b>  If expr is true, display as a PASS message,
                     otherwise as a FAIL message

              <b>msg:</b>   Message to display

              <b>subtest:</b>
                     If given, append this string to the displayed message and
                     mark this test as a member of the sub-group given by msg

              <b>failmsg:</b>
                     If given, append this string to the displayed message when
                     expr is false [default: None]

              <b>terminate:</b>
                     Terminate execution if true and expr is false [default: False]

              If tverbose=normal or level 1:
                  Sub-group message is displayed as a PASS/FAIL message including
                  the number of tests that passed and failed within the sub-group
              If tverbose=verbose or level 2:
                  All tests messages are displayed

       <b>test_description(self,</b> <b>tname=None)</b>
       Return the test description for the current test

       <b>test_group(self,</b> <b>msg)</b>
       Display heading message and start a test group.

       If tverbose=group or level 0:
           Group message is displayed as a PASS/FAIL message including the
           number of tests that passed and failed within this test group.
       If tverbose=normal|verbose or level 1|2:
           Group message is displayed as a heading messages for the tests
           belonging to this test group.

       <b>test_info(self,</b> <b>msg)</b>
       Display info message.

       <b>test_options(self,</b> <b>name=None)</b>
       Get options for the given test name. If the test name is not given
       it is determined by inspecting the stack to find which method is
       calling this method.

       <b>testid_count(self,</b> <b>tid)</b>
       Return the number of instances the testid has occurred.

       <b>trace_open(self,</b> <b>*kwts,</b> <b>**kwds)</b>
       This is a wrapper to the original trace_open method where the
       packet trace is scanned for NFS errors and a failure is logged
       for each error found not given on the list of expected errors
       set with method set_nfserr_list. Scanning for NFS error is done
       only if --nfserrors option has been specified.

       <b>trace_start(self,</b> <b>*kwts,</b> <b>**kwds)</b>
       This is a wrapper to the original trace_start method to reset
       the trace marker state

       <b>verify_client_option(self,</b> <b>tclient_dict,</b> <b>option='client')</b>
       Verify the client option is required from the list of tests to run.
       Also, check if enough clients were specified to run the tests.

              <b>tclient_dict:</b>
                     Dictionary having the number of clients required by each test

              <b>option:</b>
                     Option name [default: "client"]

       <b>verify_file_data(self,</b> <b>msg=None,</b> <b>pattern=None,</b> <b>path=None,</b> <b>filesize=None,</b> <b>nlen=None,</b> <b>cmsg='')</b>
       Verify file by comparing the data to the given pattern.
       It returns the results from the compare_data method.

              <b>msg:</b>   Test assertion message. If set to None, no assertion is
                     done it just returns the results [default: None]

              <b>pattern:</b>
                     Data pattern function or string. If this is a function,
                     it must take offset and size as positional arguments.
                     If given as a string, the pattern repeats over and over
                     starting at offset = 0 [default: self.data_pattern]

              <b>path:</b>  Absolute path of file to verify [default: self.absfile]

              <b>filesize:</b>
                     Expected size of file to be verified [default: self.filesize]

              <b>nlen:</b>  Size of sample data to return if a difference is found
                     [default: compare_data default]

              <b>cmsg:</b>  Message to append to debug message if a difference is
                     found. If set to None, debug messages are not displayed
                     [default: '']

       <b>warning(self,</b> <b>msg)</b>
       Display warning message.

       <b>write_data(self,</b> <b>fd,</b> <b>offset=0,</b> <b>size=None,</b> <b>pattern=None,</b> <b>verbose=0,</b> <b>dlevel='DBG5')</b>
       Write data to the file given by the file descriptor

              <b>fd:</b>    File descriptor

              <b>offset:</b>
                     File offset where data will be written to [default: 0]

              <b>size:</b>  Total number of bytes to write [default: --filesize option]

              <b>pattern:</b>
                     Data pattern to write to the file [default: data_pattern default]

              <b>verbose:</b>
                     Verbosity level [default: 0]

       <b>write_files(self)</b>
       Write a block of data (size given by --wsize) to all files opened
       by open_files() for writing.

       <b>Static</b> <b>methods</b> <b>defined</b> <b>here:</b>
       ----------------------------

       <b>get_list(value,</b> <b>nmap,</b> <b>sep=',')</b>
       Given the value as a string of 'comma' separated elements, return
       a list where each element is mapped using the dictionary 'nmap'.
           nmap = {"one":1, "two":2}
           out = x.get_list("one", nmap)        # out = [1]
           out = x.get_list("one,two", nmap)    # out = [1,2]
           out = x.get_list("two,one", nmap)    # out = [2,1]
           out = x.get_list("one,three", nmap)  # out = None

       <b>str_list(value,</b> <b>vtype=&lt;class</b> <b>'str'&gt;,</b> <b>sep=',')</b>
       Return a list of &lt;vtype&gt; elements from the comma separated string.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man3/baseobj.3.html">baseobj</a>(3),</b>  <b><a href="../man3/formatstr.3.html">formatstr</a>(3),</b>  <b><a href="../man3/nfstest.host.3.html">nfstest.host</a>(3),</b>  <b><a href="../man3/nfstest.nfs_util.3.html">nfstest.nfs_util</a>(3),</b>  <b><a href="../man3/nfstest.rexec.3.html">nfstest.rexec</a>(3),</b>   <b><a href="../man3/nfstest.utils.3.html">nfstest.utils</a>(3),</b>
       <b><a href="../man3/packet.nfs.nfs3_const.3.html">packet.nfs.nfs3_const</a>(3),</b> <b><a href="../man3/packet.nfs.nfs4_const.3.html">packet.nfs.nfs4_const</a>(3)</b>

</pre><h4><b>BUGS</b></h4><pre>
       No known bugs.

</pre><h4><b>AUTHOR</b></h4><pre>
       Jorge Mora (<a href="mailto:mora@netapp.com">mora@netapp.com</a>)

NFStest 3.2                                       21 March 2023                                     <u><a href="../man3/TEST_UTIL.3.html">TEST_UTIL</a></u>(3)
</pre>
 </div>
</div></section>
</div>
</body>
</html>