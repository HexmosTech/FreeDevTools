<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ares_library_init_android - c-ares library Android initialization</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/libc-ares-dev">libc-ares-dev_1.34.5-1_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       ares_library_init_android - c-ares library Android initialization

</pre><h4><b>SYNOPSIS</b></h4><pre>
       #include &lt;ares.h&gt;

       int ares_library_init_android(jobject <u>connectivity_manager</u>)

       int ares_library_android_initialized();

       void ares_library_init_jvm(JavaVM *<u>jvm</u>)

</pre><h4><b>DESCRIPTION</b></h4><pre>
       The  <u><a href="../man3/ares_library_init_android.3.html">ares_library_init_android</a>(3)</u>  function  performs  initializations  internally required by the c-ares
       library when used on Android. This can take place anytime after <u><a href="../man3/ares_library_init.3.html">ares_library_init</a>(3)</u>. It must take  place
       after  <u>ares_library_init_jvm</u>. ares_library_init_android must be called before DNS resolution will work on
       Android 8 (Oreo) or newer when targetSdkVersion is set to 26+.

       As of Android 8 (API level 26) getting DNS server information has becomei more restrictive and  can  only
       be  accessed  using  the Connectivity Manager. It is necessary to pass the connectivity manager to c-ares
       via JNI. Also, the ACCESS_NETWORK_STATE permission must be present in the Android application.

       Android older than 8 do not need to to be initialized as they are less restrictive. However,  this  is  a
       run  time  not compile time limitation. Proper Android initialization should take place regardless of the
       targeted Android version.

       Deinitialization will take place though <u><a href="../man3/ares_library_cleanup.3.html">ares_library_cleanup</a>(3)</u>.

       The <b>ares_library_init_jvm</b> function allows the caller to register the JVM with c-ares.  It's meant  to  be
       called  during JNI_OnLoad because you're guaranteed to have the JVM in that function. The JVM is required
       in order to use the Connectivity Manager registered using <u><a href="../man3/ares_library_init_android.3.html">ares_library_init_android</a>(3)</u>. This must be call
       before <u><a href="../man3/ares_library_init_android.3.html">ares_library_init_android</a>(3)</u>.

       The <b>ares_library_android_initialized</b> function can be used to check whether c-ares  has  been  initialized
       for use with Android.

</pre><h4><b>RETURN</b> <b>VALUES</b></h4><pre>
       ARES_SUCCESS will be returned on success otherwise an error code will be returned.

</pre><h4><b>THREAD</b> <b>SAFETY</b></h4><pre>
       <b>These</b>  <b>init</b>  <b>functions</b>  <b>are</b>  <b>not</b> <b>thread</b> <b>safe.</b>  You have to call it once the program has started, but this
       call must be done before the program starts any other thread. This is required to  avoid  potential  race
       conditions  in  library  initialization,  and  also due to the fact these might call functions from other
       libraries that are thread unsafe, and could conflict with any other thread that is  already  using  these
       other libraries.

</pre><h4><b>JNI</b></h4><pre>
       Accessing the Connectivity Manager though Java:

       Register the <u>ares_library_android_init</u>.
         static JNINativeMethod funcs[] = {
         { "initialize_native",     "(Landroid/net/ConnectivityManager;)I",
           (void *)&amp;ares_library_init_android}
         };

         JNIEXPORT jint JNICALL JNI_OnLoad(JavaVM *vm, void *reserved)
         {
           JNIEnv *env = NULL;
           jclass  cls = NULL;
           jint    res;

           if ((*vm)-&gt;GetEnv(vm, (void **)&amp;env, JNI_VERSION_1_6) != JNI_OK)
             return -1;

           cls = (*env)-&gt;FindClass(env, JNIT_CLASS);
           if (cls == NULL)
             return -1;

           res = (*env)-&gt;RegisterNatives(env, cls, funcs, sizeof(funcs)/sizeof(funcs[0]));
           if (res != 0)
             return -1;

           ares_library_init_jvm(vm);
           return JNI_VERSION_1_6;
         }
       Calling the registered function from Java:
         public class MyObject {
           static {
             System.loadLibrary("cares");
           }

           private static native boolean initialize_native(ConnectivityManager
             connectivity_manager);

           public static boolean initialize(Context context) {
             initialize_native((ConnectivityManager)context.getSystemService(Context.CONNECTIVITY_SERVICE));
           }
         }
       Initializing the Connectivity Manager in JNI directly using an Android Context. It is assumed the JVM has
       already been registered through <u>JNI_OnLoad</u>.
         void initialize(jobject android_context)
         {
           jclass obj_cls = jni_get_class(env, "android/content/Context");
           jmethodID obj_mid = jni_get_method_id(env, obj_cls, "getSystemService", "(Ljava/lang/String;)Ljava/lang/Object;");
           jfieldID fid = (*env)-&gt;GetStaticFieldID(env, obj_cls, "CONNECTIVITY_SERVICE", "Ljava/lang/String;");
           jstring str = (*env)-&gt;GetStaticObjectField(env, obj_cls, fid);
           connectivity_manager = (*env)-&gt;CallObjectMethod(env, android_context, obj_mid, str);
           if (connectivity_manager == NULL)
             return;
           ares_library_init_android(connectivity_manager);
         }

</pre><h4><b>AVAILABILITY</b></h4><pre>
       This function was first introduced in c-ares version 1.15.0.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man3/ares_library_init.3.html">ares_library_init</a></b>(3), <b><a href="../man3/ares_library_cleanup.3.html">ares_library_cleanup</a></b>(3),

                                                  13 Sept 2017                      <u><a href="../man3/ARES_LIBRARY_INIT_ANDROID.3.html">ARES_LIBRARY_INIT_ANDROID</a></u>(3)
</pre>
 </div>
</div></section>
</div>
</body>
</html>