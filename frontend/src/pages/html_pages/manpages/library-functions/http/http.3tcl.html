<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>http - Client-side implementation of the HTTP/1.1 protocol</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/tcl9.0-doc">tcl9.0-doc_9.0.1+dfsg-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       http - Client-side implementation of the HTTP/1.1 protocol

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>package</b> <b>require</b> <b>http</b> ?<b>2.10</b>?

       <b>::http::config</b> ?<u>-option</u> <u>value</u> ...?
       <b>::http::geturl</b> <u>url</u> ?<u>-option</u> <u>value</u> ...?
       <b>::http::formatQuery</b> <u>key</u> <u>value</u> ?<u>key</u> <u>value</u> ...?
       <b>::http::quoteString</b> <u>value</u>
       <b>::http::reset</b> <u>token</u> ?<u>why</u>?
       <b>::http::wait</b> <u>token</u>
       <b>::http::status</b> <u>token</u>
       <b>::http::size</b> <u>token</u>
       <b>::http::error</b> <u>token</u>
       <b>::http::postError</b> <u>token</u>
       <b>::http::cleanup</b> <u>token</u>
       <b>::http::requestLine</b> <u>token</u>
       <b>::http::requestHeaders</b> <u>token</u> ?<u>headerName</u>?
       <b>::http::requestHeaderValue</b> <u>token</u> <u>headerName</u>
       <b>::http::responseLine</b> <u>token</u>
       <b>::http::responseCode</b> <u>token</u>
       <b>::http::reasonPhrase</b> <u>code</u>
       <b>::http::responseHeaders</b> <u>token</u> ?<u>headerName</u>?
       <b>::http::responseHeaderValue</b> <u>token</u> <u>headerName</u>
       <b>::http::responseInfo</b> <u>token</u>
       <b>::http::responseBody</b> <u>token</u>
       <b>::http::register</b> <u>proto</u> <u>port</u> <u>command</u> ?<u>socketCmdVarName</u>? ?<u>useSockThread</u>? ?<u>endToEndProxy</u>?
       <b>::http::registerError</b> <u>sock</u> ?<u>message</u>?
       <b>::http::unregister</b> <u>proto</u>
       <b>::http::code</b> <u>token</u>
       <b>::http::data</b> <u>token</u>
       <b>::http::meta</b> <u>token</u> ?<u>headerName</u>?
       <b>::http::metaValue</b> <u>token</u> <u>headerName</u>
       <b>::http::ncode</b> <u>token</u>

</pre><h4><b>EXPORTED</b> <b>COMMANDS</b></h4><pre>
       Namespace  <b>http</b>  exports  the commands <b>config</b>, <b>formatQuery</b>, <b>geturl</b>, <b>postError</b>, <b>quoteString</b>, <b>reasonPhrase</b>,
       <b>register</b>, <b>registerError</b>, <b>requestHeaders</b>,  <b>requestHeaderValue</b>,  <b>requestLine</b>,  <b>responseBody</b>,  <b>responseCode</b>,
       <b>responseHeaders</b>, <b>responseHeaderValue</b>, <b>responseInfo</b>, <b>responseLine</b>, <b>reset</b>, <b>unregister</b>, and <b>wait</b>.

       It does not export the commands <b>cleanup</b>, <b>code</b>, <b>data</b>, <b>error</b>, <b>meta</b>, <b>metaValue</b>, <b>ncode</b>, <b>size</b>, or <b>status</b>.
________________________________________________________________________________________________________________

</pre><h4><b>DESCRIPTION</b></h4><pre>
       The <b>http</b> package provides the client side of the HTTP/1.1 protocol, as defined in RFC 9110 to 9112, which
       supersede  RFC 7230 to RFC 7235, which in turn supersede RFC 2616.  The package implements the GET, POST,
       and HEAD operations of HTTP/1.1.  It allows configuration of a proxy host to get through firewalls.   The
       package is compatible with the <b>Safesock</b> security policy, so it can be used by untrusted applets to do URL
       fetching  from  a  restricted  set  of  hosts.  This  package  can be extended to support additional HTTP
       transport protocols, such as HTTPS, by providing a custom <b>socket</b> command, via <b>::http::register</b>.

       The <b>::http::geturl</b> procedure does a HTTP transaction.  Its <u>options</u>  determine whether  a  GET,  POST,  or
       HEAD  transaction  is performed.  The return value of <b>::http::geturl</b> is a token for the transaction.  The
       token can be supplied as an argument to other  commands,  to  manage  the  transaction  and  examine  its
       results.

       If  the  <b>-command</b> option is specified, then the HTTP operation is done in the background.  <b>::http::geturl</b>
       returns immediately after generating the HTTP request and the  <b>-command</b>  callback  is  invoked  when  the
       transaction  completes.  For this to work, the Tcl event loop must be active.  In Tk applications this is
       always true.  For pure-Tcl applications, the caller can use <b>::http::wait</b> after calling <b>::http::geturl</b>  to
       start the event loop.

       <b>Note:</b> The event queue is even used without the <b>-command</b> option.  As a side effect, arbitrary commands may
       be processed while <b>http::geturl</b> is running.

       When  the  HTTP server has replied to the request, call the command <b>::http::responseInfo</b>, which returns a
       <b>dict</b> of metadata that is essential for identifying  a  successful  transaction  and  making  use  of  the
       response.  See section <b>METADATA</b> for details of the information returned.  The response itself is returned
       by  command  <b>::http::responseBody</b>,  unless  it  has  been  redirected to a file by the <u>-channel</u> option of
       <b>::http::geturl</b>.

</pre><h4><b>COMMANDS</b></h4><pre>
       <b>::http::config</b> ?<u>options</u>?
              The <b>::http::config</b> command is used to set and query the name of the proxy server and port, and the
              User-Agent name used in the HTTP  requests.   If  no  options  are  specified,  then  the  current
              configuration  is returned.  If a single argument is specified, then it should be one of the flags
              described below.  In this case the current value of that  setting  is  returned.   Otherwise,  the
              options should be a set of flags and values that define the configuration:

              <b>-accept</b> <u>mimetypes</u>
                     The  Accept  header  of  the  request.   The  default is */*, which means that all types of
                     documents are accepted.  Otherwise you can supply  a  comma-separated  list  of  mime  type
                     patterns that you are willing to receive.  For example, “image/gif, image/jpeg, text/*”.

              <b>-cookiejar</b> <u>command</u>
                     The  cookie  store  for  the  package  to use to manage HTTP cookies.  <u>command</u> is a command 2
                     prefix list; if the empty list (the default value) is used, no  cookies  will  be  sent  by 2
                     requests or stored from responses. The command indicated by <u>command</u>, if supplied, must obey 2
                     the <b>COOKIE</b> <b>JAR</b> <b>PROTOCOL</b> described below.

              <b>-pipeline</b> <u>boolean</u>
                     Specifies  whether HTTP/1.1 transactions on a persistent socket will be pipelined.  See the
                     <b>PERSISTENT</b> <b>SOCKETS</b> section for details. The default is 1.

              <b>-postfresh</b> <u>boolean</u>
                     Specifies whether requests that use the  <b>POST</b>  method  will  always  use  a  fresh  socket,
                     overriding  the  <b>-keepalive</b>  option  of  command  <b>http::geturl</b>.  See the <b>PERSISTENT</b> <b>SOCKETS</b>
                     section for details. The default is 0.

              <b>-proxyauth</b> <u>string</u>
                     If non-empty, the string is supplied to the proxy server as the value of the request header
                     Proxy-Authorization.  This option can be used for HTTP Basic Authentication.  If the  proxy
                     server  requires  authentication  by  another  technique,  e.g.  Digest Authentication, the
                     <b>-proxyauth</b> option is not useful.  In that case the caller must expect a 407  response  from
                     the  proxy, compute the authentication value to be supplied, and use the <b>-headers</b> option to
                     supply it as the value of the Proxy-Authorization header.

              <b>-proxyfilter</b> <u>command</u>
                     The command is a callback that is made during <b>::http::geturl</b> to determine  if  a  proxy  is
                     required  for  a  given  host.   One  argument, a host name, is added to <u>command</u> when it is
                     invoked.  If a proxy is required, the callback should return a two-element list  containing
                     the proxy server and proxy port.  Otherwise the filter command should return an empty list.

                     The  default  value  of  <b>-proxyfilter</b>  is <b>http::ProxyRequired</b>, and this command returns the
                     values of the <b>-proxyhost</b> and <b>-proxyport</b>  settings  if  they  are  non-empty.   The  options
                     <b>-proxyhost</b>,  <b>-proxyport</b>,  and  <b>-proxynot</b>  are used only by <b>http::ProxyRequired</b>, and nowhere
                     else in <b>::http::geturl</b>.  A user-supplied <b>-proxyfilter</b> command may  use  these  options,  or
                     alternatively  it  may  obtain  values from elsewhere in the calling script.  In the latter
                     case, any values provided for <b>-proxyhost</b>, <b>-proxyport</b>, and <b>-proxynot</b> are unused.

                     The  <b>::http::geturl</b>  command  runs  the  <b>-proxyfilter</b>  callback  inside  a  <b>catch</b>  command.
                     Therefore  an  error  in  the  callback command does not call the <b>bgerror</b> handler.  See the
                     <b>ERRORS</b> section for details.

              <b>-proxyhost</b> <u>hostname</u>
                     The host name or IP address of the proxy server, if  any.   If  this  value  is  the  empty
                     string, the URL host is contacted directly.  See <b>-proxyfilter</b> for how the value is used.

              <b>-proxynot</b> <u>list</u>
                     A  Tcl  list of domain names and IP addresses that should be accessed directly, not through
                     the proxy server.  The target hostname is compared with each list  element  using  a  case-
                     insensitive <b>string</b> <b>match</b>.  It is often convenient to use the wildcard "*" at the start of a
                     domain  name  (e.g.  *.example.com) or at the end of an IP address (e.g. 192.168.0.*).  See
                     <b>-proxyfilter</b> for how the value is used.

              <b>-proxyport</b> <u>number</u>
                     The port number of the proxy server.  See <b>-proxyfilter</b> for how the value is used.

              <b>-repost</b> <u>boolean</u>
                     Specifies what to do if a POST request over  a  persistent  connection  fails  because  the
                     server  has half-closed the connection.  If boolean <b>true</b>, the request will be automatically
                     retried; if boolean <b>false</b> it will not,  and  the  application  that  uses  <b>http::geturl</b>  is
                     expected to seek user confirmation before retrying the POST.  The value <b>true</b> should be used
                     only  under certain conditions. See the <b>PERSISTENT</b> <b>SOCKETS</b> section for details. The default
                     is 0.

              <b>-threadlevel</b> <u>level</u>
                     Specifies whether and how to use the <b>Thread</b> package.  Possible values of <u>level</u> are 0, 1  or
                     2.

                     <b>0</b>      (the default) do not use Thread

                     <b>1</b>      use Thread if it is available, do not use it if it is unavailable

                     <b>2</b>      use Thread if it is available, raise an error if it is unavailable

                     The  Tcl  <b>socket</b> <b>-async</b> command can block in adverse cases (e.g. a slow DNS lookup).  Using
                     the Thread package works around this problem, for both HTTP and HTTPS transactions.  Values
                     of <u>level</u> other than 0 are available only to the  main  interpreter  in  each  thread.   See
                     section <b>THREADS</b> for more information.

              <b>-urlencoding</b> <u>encoding</u>
                     The  <u>encoding</u>  used  for  creating  the  x-url-encoded  URLs  with  <b>::http::formatQuery</b> and
                     <b>::http::quoteString</b>.  The default is <b>utf-8</b>, as specified by RFC 2718.

              <b>-useragent</b> <u>string</u>
                     The value of the User-Agent header in the HTTP request.   In  an  unsafe  interpreter,  the
                     default  value  depends upon the operating system, and the version numbers of <b>http</b> and <b>Tcl</b>,
                     and is (for example) “<b>Mozilla/5.0</b> <b>(Windows;</b> <b>U;</b> <b>Windows</b> <b>NT</b> <b>10.0)</b> <b>http/2.10.0</b> <b>Tcl/9.0.0</b>”.   A
                     safe  interpreter  cannot  determine  its  operating  system,  and so the default in a safe
                     interpreter is to use a Windows 10 value with the current version numbers of <b>http</b> and <b>Tcl</b>.

              <b>-zip</b> <u>boolean</u>
                     If the value is boolean <b>true</b>, then by default requests will send a header “<b>Accept-Encoding:</b>
                     <b>gzip,deflate</b>”.  If the value is boolean <b>false</b>, then by default requests will send a  header
                     “<b>Accept-Encoding:</b>  <b>identity</b>”.   In  either  case  the  default  can  be  overridden  for an
                     individual request by supplying a custom <b>Accept-Encoding</b> header in the <b>-headers</b>  option  of
                     <b>http::geturl</b>. The default value is 1.

       <b>::http::geturl</b> <u>url</u> ?<u>options</u>?
              The  <b>::http::geturl</b>  command  is  the  main procedure in the package.  The <b>-query</b> or <b>-querychannel</b>
              option causes a POST operation and the <b>-validate</b> option causes a HEAD operation; otherwise, a  GET
              operation is performed.  The <b>::http::geturl</b> command returns a <u>token</u> value that can be passed as an
              argument  to other commands to get information about the transaction.  See the <b>METADATA</b> and <b>ERRORS</b>
              section for details.  The <b>::http::geturl</b> command blocks until the operation completes, unless  the
              <b>-command</b>  option  specifies  a  callback  that  is  invoked  when  the HTTP transaction completes.
              <b>::http::geturl</b> takes several options:

              <b>-binary</b> <u>boolean</u>
                     Specifies whether to force interpreting the URL data as binary.   Normally  this  is  auto-
                     detected (anything not beginning with a <b>text</b> content type or whose content encoding is <b>gzip</b>
                     or <b>deflate</b> is considered binary data).

              <b>-blocksize</b> <u>size</u>
                     The block size used when reading the URL.  At most <u>size</u> bytes are read at once.  After each
                     block, a call to the <b>-progress</b> callback is made (if that option is specified).

              <b>-channel</b> <u>name</u>
                     Copy  the URL contents to channel <u>name</u> instead of saving it in a Tcl variable for retrieval
                     by <b>::http::responseBody</b>.

              <b>-command</b> <u>callback</u>
                     The presence of this option causes <b>::http::geturl</b> to return immediately.   After  the  HTTP
                     transaction  completes, the value of <u>callback</u> is expanded, an additional argument is added,
                     and the resulting command is evaluated.  The additional argument is the <u>token</u> returned from
                     <b>::http::geturl</b>. This token is the name of an array that is described  in  the  <b>STATE</b>  <b>ARRAY</b>
                     section.  Here is a template for the callback:

                            proc httpCallback {token} {
                                upvar 0 $token state
                                # Access state as a Tcl array defined in this proc
                                ...
                                return
                            }

                     The <b>::http::geturl</b> command runs the <b>-command</b> callback inside a <b>catch</b> command.  Therefore an
                     error  in  the  callback command does not call the <b>bgerror</b> handler.  See the <b>ERRORS</b> section
                     for details.

              <b>-guesstype</b> <u>boolean</u>
                     Attempt to guess the <b>Content-Type</b> and character set when a misconfigured server provides no
                     information.  The default value is <u>false</u> (do nothing).  If boolean <u>true</u> then, if the server
                     does not send a <b>Content-Type</b> header, or if it sends the  value  "application/octet-stream",
                     <b>http::geturl</b>  will  attempt  to guess appropriate values.  This is not intended to become a
                     general-purpose tool, and currently it is limited to detecting  XML  documents  that  begin
                     with  an  XML  declaration.  In this case the <b>Content-Type</b> is changed to "application/xml",
                     the binary flag state(binary) is changed to 0, and the character set is changed to the  one
                     specified  by  the "encoding" tag of the XML line, or to utf-8 if no encoding is specified.
                     Not used if a <b>-channel</b> is specified.

              <b>-handler</b> <u>callback</u>
                     If this option is absent, <b>http::geturl</b> processes incoming data itself, either appending  it
                     to  the  state(body) variable or writing it to the -channel.  But if the <b>-handler</b> option is
                     present, <b>http::geturl</b> does not do this processing and  instead  calls  <u>callback</u>.   Whenever
                     HTTP  data is available, the value of <u>callback</u> is expanded, an additional two arguments are
                     added, and the resulting command is evaluated.   The  two  additional  arguments  are:  the
                     socket for the HTTP data and the <u>token</u> returned from <b>::http::geturl</b>.  The token is the name
                     of  a global array that is described in the <b>STATE</b> <b>ARRAY</b> section.  The procedure is expected
                     to return the number of bytes read from the socket.  Here is a template for the callback:

                            proc httpHandlerCallback {socket token} {
                                upvar 0 $token state
                                # Access socket, and state as a Tcl array defined in this proc
                                # For example...
                                ...
                                set data [read $socket 1000]
                                set nbytes [string length $data]
                                ...
                                return $nbytes
                            }

                     The <b>http::geturl</b> code for the <b>-handler</b> option is not compatible with either compression  or
                     chunked  transfer-encoding.   If  <b>-handler</b>  is  specified, then to work around these issues
                     <b>http::geturl</b> will reduce the HTTP protocol to 1.0, and override the <b>-zip</b>  option  (i.e.  it
                     will send the header <b>Accept-Encoding:</b> <b>identity</b> instead of <b>Accept-Encoding:</b> <b>gzip,deflate</b>).

                     If  options <b>-handler</b> and <b>-channel</b> are used together, the handler is responsible for copying
                     the data from the HTTP socket to the  specified  channel.   The  name  of  the  channel  is
                     available to the handler as element <b>-channel</b> of the token array.

                     The <b>::http::geturl</b> command runs the <b>-handler</b> callback inside a <b>catch</b> command.  Therefore an
                     error  in  the  callback command does not call the <b>bgerror</b> handler.  See the <b>ERRORS</b> section
                     for details.

              <b>-headers</b> <u>keyvaluelist</u>
                     This option is used to add headers not already specified  by  <b>::http::config</b>  to  the  HTTP
                     request.   The  <u>keyvaluelist</u>  argument  must be a list with an even number of elements that
                     alternate between keys and values.  The keys  become  header  field  names.   Newlines  are
                     stripped  from  the values so the header cannot be corrupted.  For example, if <u>keyvaluelist</u>
                     is <b>Pragma</b> <b>no-cache</b> then the following header is included in the HTTP request:

                            Pragma: no-cache

              <b>-keepalive</b> <u>boolean</u>
                     If boolean <b>true</b>, attempt to keep the  connection  open  for  servicing  multiple  requests.
                     Default is 0.

              <b>-method</b> <u>type</u>
                     Force  the  HTTP  request method to <u>type</u>. <b>::http::geturl</b> will auto-select GET, POST or HEAD
                     based on other options, but this option overrides that selection and enables  choices  like
                     PUT and DELETE for WebDAV support.

                     It  is  the  caller's  responsibility  to ensure that the headers and request body (if any)
                     conform to the requirements of the request method.  For example, if using <b>-method</b>  <u>POST</u>  to
                     send a POST with an empty request body, the caller must also supply the option

                            -headers {Content-Length 0}

              <b>-myaddr</b> <u>address</u>
                     Pass  an  specific  local address to the underlying <b>socket</b> call in case multiple interfaces
                     are available.

              <b>-progress</b> <u>callback</u>
                     If the <b>-progress</b> option is present, then the <u>callback</u> is made after each transfer  of  data
                     from  the URL.  The value of <u>callback</u> is expanded, an additional three arguments are added,
                     and the resulting command is evaluated.  The three  additional  arguments  are:  the  <u>token</u>
                     returned  from  <b>::http::geturl</b>,  the  expected total size of the contents from the <b>Content-</b>
                     <b>Length</b> response header, and the current number of bytes transferred so far.  The  token  is
                     the  name  of  a  global  array that is described in the <b>STATE</b> <b>ARRAY</b> section.  The expected
                     total size may be unknown, in which case zero  is  passed  to  the  callback.   Here  is  a
                     template for the progress callback:

                            proc httpProgress {token total current} {
                                upvar 0 $token state
                                # Access state as a Tcl array defined in this proc
                                ...
                                return
                            }

              <b>-protocol</b> <u>version</u>
                     Select  the  HTTP  protocol version to use. This should be 1.0 or 1.1 (the default). Should
                     only be necessary for servers that do not understand or otherwise complain about HTTP/1.1.

              <b>-query</b> <u>query</u>
                     This flag (if the value is non-empty) causes <b>::http::geturl</b>  to  do  a  POST  request  that
                     passes  the string <u>query</u> verbatim to the server as the request payload.  The content format
                     (and encoding) of <u>query</u> is announced by the request header <b>Content-Type</b> which is set by the
                     option <b>-type</b>.  Any value of <b>-type</b> is permitted, and it is the responsibility of the  caller
                     to supply <u>query</u> in the correct format.

                     If <b>-type</b> is not specified, it defaults to <u>application/x-www-form-urlencoded</u>, which requires
                     <u>query</u>  to be an x-url-encoding formatted query-string (this <b>-type</b> and query format are used
                     in a POST submitted from an html form).  The <b>::http::formatQuery</b> procedure can be  used  to
                     do the formatting.

              <b>-queryblocksize</b> <u>size</u>
                     The  block size used when posting query data to the URL.  At most <u>size</u> bytes are written at
                     once.  After each block, a call to the <b>-queryprogress</b> callback is made (if that  option  is
                     specified).

              <b>-querychannel</b> <u>channelID</u>
                     This  flag  causes  <b>::http::geturl</b>  to  do a POST request that passes the data contained in
                     <u>channelID</u> to the server.  The  data  contained  in  <u>channelID</u>  must  be  an  x-url-encoding
                     formatted  query  unless the <b>-type</b> option below is used.  If a <b>Content-Length</b> header is not
                     specified via the <b>-headers</b> options, <b>::http::geturl</b> attempts to determine the  size  of  the
                     post  data  in  order  to  create  that  header.  If it is unable to determine the size, it
                     returns an error.

              <b>-queryprogress</b> <u>callback</u>
                     If the <b>-queryprogress</b> option is present, then the <u>callback</u> is made after each  transfer  of
                     data  to  the  URL  in  a POST request (i.e. a call to <b>::http::geturl</b> with option <b>-query</b> or
                     <b>-querychannel</b>) and acts exactly like the <b>-progress</b>  option  (the  callback  format  is  the
                     same).

              <b>-strict</b> <u>boolean</u>
                     If  true  then the command will test that the URL complies with RFC 3986, i.e.  that it has
                     no characters that should be "x-url-encoded" (e.g. a space should  be  encoded  to  "%20").
                     Default value is 1.

              <b>-timeout</b> <u>milliseconds</u>
                     If  <u>milliseconds</u>  is  non-zero,  then  <b>::http::geturl</b>  sets up a timeout to occur after the
                     specified number of milliseconds.  A timeout results in a call to <b>::http::reset</b> and to  the
                     <b>-command</b>  callback, if specified.  The return value of <b>::http::status</b> (and the value of the
                     <u>status</u> key in the dictionary returned by <b>::http::responseInfo</b>) is <b>timeout</b> after  a  timeout
                     has occurred.

              <b>-type</b> <u>mime-type</u>
                     Use  <u>mime-type</u>  as the <b>Content-Type</b> value, instead of the default value (<b>application/x-www-</b>
                     <b>form-urlencoded</b>) during a POST operation.

              <b>-validate</b> <u>boolean</u>
                     If <u>boolean</u> is non-zero, then <b>::http::geturl</b> does an HTTP HEAD request.  This server returns
                     the same status line and response headers as it would for a HTTP GET request, but omits the
                     response entity (the URL  "contents").   The  response  headers  are  available  after  the
                     transaction   using   command   <b>::http::responseHeaders</b>   or,   for  selected  information,
                     <b>::http::responseInfo</b>.

       <b>::http::formatQuery</b> <u>key</u> <u>value</u> ?<u>key</u> <u>value</u> ...?
              This procedure does x-url-encoding of query data.  It takes an even number of arguments  that  are
              the  keys  and values of the query.  It encodes the keys and values, and generates one string that
              has the proper &amp; and = separators.  The  result  is  suitable  for  the  <b>-query</b>  value  passed  to
              <b>::http::geturl</b>.

       <b>::http::quoteString</b> <u>value</u>
              This procedure does x-url-encoding of string.  It takes a single argument and encodes it.

       <b>::http::reset</b> <u>token</u> ?<u>why</u>?
              This command resets the HTTP transaction identified by <u>token</u>, if any.  This sets the <b>state(status)</b>
              value to <u>why</u>, which defaults to <b>reset</b>, and then calls the registered <b>-command</b> callback.

       <b>::http::wait</b> <u>token</u>
              This  command  blocks  and waits for the transaction to complete.  This only works in trusted code
              because it uses <b>vwait</b>.  Also, it is not useful for the case where <b>::http::geturl</b> is called <u>without</u>
              the <b>-command</b> option because in this case the <b>::http::geturl</b> call does not return  until  the  HTTP
              transaction is complete, and thus there is nothing to wait for.

       <b>::http::status</b> <u>token</u>
              This command returns a description of the status of the HTTP transaction.  The return value is the
              empty  string  until  the HTTP transaction is completed; after completion it has one of the values
              ok, eof, error, timeout, and reset.  The meaning of these  values  is  described  in  the  section
              <b>ERRORS</b> (below).

              The name "status" is not related to the terms "status line" and "status code" that are defined for
              a HTTP response.

       <b>::http::size</b> <u>token</u>
              This command returns the number of bytes received so far from the URL in the <b>::http::geturl</b> call.

       <b>::http::error</b> <u>token</u>
              This  command returns the error information if the HTTP transaction failed, or the empty string if
              there was no error.  The information is a Tcl list of the error message, stack  trace,  and  error
              code.

       <b>::http::postError</b> <u>token</u>
              A  POST  request  is a call to <b>::http::geturl</b> with either the <b>-query</b> or <b>-querychannel</b> option.  The
              <b>::http::postError</b> command returns the error information generated when a HTTP POST  request  sends
              its  request-body  to the server; or the empty string if there was no error.  The information is a
              Tcl list of the error message, stack trace, and error code.  When this type of error  occurs,  the
              <b>::http::geturl</b>  command  continues  the  transaction  and  attempts to receive a response from the
              server.

       <b>::http::cleanup</b> <u>token</u>
              This procedure cleans up the state associated with the connection identified by <u>token</u>.  After this
              call, the procedures like <b>::http::responseBody</b>  cannot  be  used  to  get  information  about  the
              operation.  It is <u>strongly</u> recommended that you call this function after you are done with a given
              HTTP  request.   Not  doing  so  will  result  in  memory  not  being freed, and if your app calls
              <b>::http::geturl</b> enough times, the memory leak could cause a performance hit...or worse.

       <b>::http::requestLine</b> <u>token</u>
              This command returns the "request line" sent to the server.  The "request line" is the first  line
              of  a  HTTP  client  request, and has three elements separated by spaces: the HTTP method, the URL
              relative to the server, and the HTTP version. Examples:

              GET / HTTP/1.1 GET /introduction.html?subject=plumbing HTTP/1.1 POST /forms/order.html HTTP/1.1

       <b>::http::requestHeaders</b> <u>token</u> ?<u>headerName</u>?
              This command returns the HTTP request header names and values, in the order that they were sent to
              the server, as a Tcl list of the form ?name value ...?  Header names are case-insensitive and  are
              converted  to lower case.  The return value is not a <b>dict</b> because some header names may occur more
              than once.  If one argument is supplied, all request headers are returned.  If two  arguments  are
              supplied,  the  second  provides the value of a header name.  Only headers with the requested name
              (converted to lower case) are returned.  If no such headers are found, an empty list is returned.

       <b>::http::requestHeaderValue</b> <u>token</u> <u>headerName</u>
              This command returns the value of the HTTP request header  named  <u>headerName</u>.   Header  names  are
              case-insensitive  and  are converted to lower case.  If no such header exists, the return value is
              the empty string.  If there are multiple headers named  <u>headerName</u>,  the  result  is  obtained  by
              joining the individual values with the string ", " (comma and space), preserving their order.

       <b>::http::responseLine</b> <u>token</u>
              This  command  returns the first line of the server response: the HTTP "status line".  The "status
              line" has three elements separated by spaces: the HTTP version, a  three-digit  numerical  "status
              code", and a "reason phrase".  Only the reason phrase may contain spaces.  Examples:

              HTTP/1.1 200 OK HTTP/1.0 404 Not Found
              The  "status  code" is a three-digit number in the range 100 to 599.  A value of 200 is the normal
              return from a GET request, and its matching "reason phrase" is "OK".  Codes beginning with 4 or  5
              indicate  errors.   Codes  beginning  with  3  are  redirection errors.  In this case the <b>Location</b>
              response header specifies a new URL that contains the requested information.

              The "reason phrase" is a textual description of the "status code": it  may  vary  from  server  to
              server,  and can be changed without affecting the HTTP protocol.  The recommended values (RFC 7231
              and IANA assignments) for each code are provided by the command <b>::http::reasonPhrase</b>.

       <b>::http::responseCode</b> <u>token</u>
              This command returns the "status code" (200, 404, etc.) of the server "status line".  If a  three-
              digit  code  cannot  be found, the full status line is returned.  See command <b>::http::responseLine</b>
              for more information on the "status line".

       <b>::http::reasonPhrase</b> <u>code</u>
              This command returns the IANA recommended "reason phrase" for a particular "status code"  returned
              by  a  HTTP  server.  The argument <u>code</u> is a valid status code, and therefore is an integer in the
              range 100 to 599 inclusive.  For numbers in this range  with  no  assigned  meaning,  the  command
              returns  the  value  "Unassigned".   Several status codes are used only in response to the methods
              defined by HTTP extensions such as WebDAV, and not in response to a HEAD,  GET,  or  POST  request
              method.

              The  "reason  phrase"  returned  by  a  HTTP server may differ from the recommended value, without
              affecting the HTTP protocol.  The value returned by <b>::http::geturl</b>  can  be  obtained  by  calling
              either   command   <b>::http::responseLine</b>   (which   returns   the  full  status  line)  or  command
              <b>::http::responseInfo</b> (which  returns  a  dictionary,  with  the  "reason  phrase"  stored  in  key
              <u>reasonPhrase</u>).

              A  registry  of  valid status codes is maintained at https://www.iana.org/assignments/http-status-
              codes/http-status-codes.xhtml

       <b>::http::responseHeaders</b> <u>token</u> ?<u>headerName</u>?
              The response from a HTTP server includes metadata headers that describe the response body and  the
              transaction  itself.  This command returns the HTTP response header names and values, in the order
              that they were received from the server, as a Tcl list of the form ?name value ...?  Header  names
              are case-insensitive and are converted to lower case.  The return value is not a <b>dict</b> because some
              header  names  may  occur  more  than  once,  notably  <b>Set-Cookie</b>.   If the second argument is not
              supplied, all response headers are returned.  If the second argument is supplied, it provides  the
              value  of  a  header  name.   Only  headers  with the requested name (converted to lower case) are
              returned.  If no such headers are found, an empty list is returned.  See section <b>METADATA</b> for more
              information.

       <b>::http::responseHeaderValue</b> <u>token</u> <u>headerName</u>
              This command returns the value of the HTTP response header named  <u>headerName</u>.   Header  names  are
              case-insensitive  and  are converted to lower case.  If no such header exists, the return value is
              the empty string.  If there are multiple headers named  <u>headerName</u>,  the  result  is  obtained  by
              joining  the  individual  values  with  the string ", " (comma and space), preserving their order.
              Multiple headers with the same name may be processed in this manner, except <b>Set-Cookie</b> which  does
              not  conform  to the comma-separated-list syntax and cannot be combined into a single value.  Each
              <b>Set-Cookie</b>  header  must  be  treated  individually,  e.g.  by  processing  the  return  value  of
              <b>::http::responseHeaders</b> <u>token</u> <b>Set-Cookie</b>.

       <b>::http::responseInfo</b> <u>token</u>
              This  command  returns  a  <b>dict</b> of selected response metadata that are essential for identifying a
              successful transaction and making use  of  the  response,  along  with  other  metadata  that  are
              informational.   The  keys of the <b>dict</b> are <u>stage</u>, <u>status</u>, <u>responseCode</u>, <u>reasonPhrase</u>, <u>contentType</u>,
              <u>binary</u>,  <u>redirection</u>,  <u>upgrade</u>,  <u>error</u>,  <u>postError</u>,  <u>method</u>,  <u>charset</u>,  <u>compression</u>,  <u>httpRequest</u>,
              <u>httpResponse</u>,  <u>url</u>,  <u>connectionRequest</u>,  <u>connectionResponse</u>,  <u>connectionActual</u>,  <u>transferEncoding</u>,
              <u>totalPost</u>, <u>currentPost</u>, <u>totalSize</u>, and <u>currentSize</u>.  The meaning of these keys is described in the
              section <b>METADATA</b> below.

              It is always worth checking the value of <u>binary</u> after a HTTP transaction, to determine  whether  a
              misconfigured server has caused http to interpret a text resource as a binary, or vice versa.

              After  a  POST  transaction,  check  the  value  of  <u>postError</u> to verify that the request body was
              uploaded without error.

       <b>::http::responseBody</b> <u>token</u>
              This command returns the entity sent by the HTTP server (unless <u>-channel</u> was used, in  which  case
              the entity was delivered to the channel, and the command returns the empty string).

              Other   terms  for  "entity",  with  varying  precision,  include  "representation  of  resource",
              "resource",  "response  body  after  decoding",  "payload",   "message   body   after   decoding",
              "content(s)", and "file".

       <b>::http::register</b> <u>proto</u> <u>port</u> <u>command</u> ?<u>socketCmdVarName</u>? ?<u>useSockThread</u>? ?<u>endToEndProxy</u>?
              This  procedure  allows one to provide custom HTTP transport types such as HTTPS, by registering a
              prefix, the default port, and the command to execute to  create  the  Tcl  <b>channel</b>.  The  optional
              arguments  configure  how  <b>http</b>  uses  the  custom  transport,  and  have  default values that are
              compatible with older versions of <b>http</b> in which <b>::http::register</b> has no optional arguments.

              Argument <u>socketCmdVarName</u> is the name of a variable provided by the transport, whose value is  the
              command  used by the transport to open a socket.  Its default value is set by the transport and is
              "::socket", but if the name of the variable is supplied to <b>::http::register</b>, then <b>http</b> will set  a
              new  value  in  order  to make optional facilities available.  These facilities are enabled by the
              optional arguments <u>useSockThread</u>, <u>endToEndProxy</u>, which take  boolean  values  with  default  value
              <u>false</u>.

              Iff  argument  <u>useSockThread</u>  is  supplied  and  is  boolean <u>true</u>, then iff permitted by the value
              [<b>http::config</b> <u>-threadlevel</u>] and by the availability of package <b>Thread</b>,  sockets  created  for  the
              transport will be opened in a different thread so that a slow DNS lookup will not cause the script
              to block.

              Iff  argument  <u>endToEndProxy</u>  is  supplied  and is boolean <u>true</u>, then when <b>http::geturl</b> accesses a
              server via a proxy, it will open a channel by sending a CONNECT request to the proxy, and it  will
              then  make  its  request  over this channel.  This allows end-to-end encryption for HTTPS requests
              made through a proxy.

              For example,

                            package require http
                            package require tls

                            ::http::register https 443 ::tls::socket ::tls::socketCmd 1 1

                            set token [::http::geturl https://my.secure.site/]

       <b>::http::registerError</b> <u>sock</u> ?<u>message</u>?
              This procedure allows a registered protocol handler to deliver an error message for use  by  <b>http</b>.
              Calling  this  command  does  not raise an error. The command is useful when a registered protocol
              detects an problem (for example, an invalid TLS certificate) that will cause an error to propagate
              to <b>http</b>.  The command allows <b>http</b> to provide a precise error message rather than  a  general  one.
              The command returns the value provided by the last call with argument <u>message</u>, or the empty string
              if no such call has been made.

       <b>::http::unregister</b> <u>proto</u>
              This procedure unregisters a protocol handler that was previously registered via <b>::http::register</b>,
              returning a six-item list of the values that were previously supplied to <b>::http::register</b> if there
              was such a handler, and an error if there was no such handler.

       <b>::http::code</b> <u>token</u>
              An alternative name for the command <b>::http::responseLine</b>

       <b>::http::data</b> <u>token</u>
              An alternative name for the command <b>::http::responseBody</b>.

       <b>::http::meta</b> <u>token</u> ?<u>headerName</u>?
              An alternative name for the command <b>::http::responseHeaders</b>

       <b>::http::ncode</b> <u>token</u>
              An alternative name for the command <b>::http::responseCode</b>

</pre><h4><b>ERRORS</b></h4><pre>
       The  <b>::http::geturl</b>  procedure will raise errors in the following cases: invalid command line options, or
       an invalid URL.  These errors mean that it cannot even start the network  transaction.   For  synchronous
       <b>::http::geturl</b>  calls  (where  <b>-command</b> is not specified), it will raise an error if the URL is on a non-
       existent host or at a bad port on an existing host.  It will also raise an error for any I/O errors while
       writing out the HTTP request line and headers, or reading  the  HTTP  reply  headers  or  data.   Because
       <b>::http::geturl</b>  does  not return a token in these cases, it does all the required cleanup and there is no
       issue of your app having to call <b>::http::cleanup</b>.

       For asynchronous <b>::http::geturl</b> calls, all of the above error situations apply, except that if  there  is
       any  error  while  reading the HTTP reply headers or data, no exception is thrown.  This is because after
       writing the HTTP headers, <b>::http::geturl</b> returns, and the rest of the  HTTP  transaction  occurs  in  the
       background.   The  command  callback  can  check  if  any  error  occurred  during  the  read  by calling
       <b>::http::responseInfo</b> to check the transaction status.

       Alternatively, if the main program flow reaches a point  where  it  needs  to  know  the  result  of  the
       asynchronous  HTTP  request,  it  can  call  <b>::http::wait</b>  and  then  check status and error, just as the
       synchronous call does.

       The <b>::http::geturl</b> command runs the  <b>-command</b>,  <b>-handler</b>,  and  <b>-proxyfilter</b>  callbacks  inside  a  <b>catch</b>
       command.   Therefore  an error in the callback command does not call the <b>bgerror</b> handler.  When debugging
       one of these callbacks, it may be convenient to report  errors  by  using  a  <b>catch</b>  command  within  the
       callback command itself, e.g. to write an error message to stdout.

       In any case, you must still call <b>::http::cleanup</b> to delete the state array when you are done.

       There  are  other  possible  results  of  the  HTTP  transaction  determined by examining the status from
       <b>::http::status</b> (or the value of the <u>status</u> key  in  the  dictionary  returned  by  <b>::http::responseInfo</b>).
       These are described below.

       <b>ok</b>     If  the  HTTP  transaction  completes entirely, then status will be <b>ok</b>.  However, you should still
              check the <b>::http::responseLine</b> value to get the HTTP status.  The  <b>::http::responseCode</b>  procedure
              provides  just  the numeric error (e.g., 200, 404 or 500) while the <b>::http::responseLine</b> procedure
              returns a value like “HTTP 404 File not found”.

       <b>eof</b>    If the server closes the socket without replying, then no error is raised, but the status  of  the
              transaction will be <b>eof</b>.

       <b>error</b>  The  error  message,  stack  trace,  and  error  code are accessible via <b>::http::error</b>.  The error
              message is  also  provided  by  the  value  of  the  <u>error</u>  key  in  the  dictionary  returned  by
              <b>::http::responseInfo</b>.

       <b>timeout</b>
              A timeout occurred before the transaction could complete.

       <b>reset</b>  The user has called <b>::http::reset</b>.

       <b>""</b>     (empty string) The transaction has not yet finished.

       Another  error  possibility  is  that  <b>::http::geturl</b>  failed to write the whole of the POST request body
       (<b>-query</b> or <b>-querychannel</b> data) to  the  server.   <b>::http::geturl</b>  stores  the  error  message  for  later
       retrieval  by  the  <b>::http::postError</b> or <b>::http::responseInfo</b> commands, and then attempts to complete the
       transaction.  If it can read the server's response the status will be <b>ok</b>, but it  is  important  to  call
       <b>::http::postError</b>  or  <b>::http::responseInfo</b> after every POST to check that the data was sent in full.  If
       the server has closed the connection the status will be <b>eof</b>.

</pre><h4><b>METADATA</b></h4><pre>
   <b>MOST</b> <b>USEFUL</b> <b>METADATA</b>
       When a HTTP server responds to a request, it supplies not only the entity requested, but  also  metadata.
       This  is provided by the first line (the "status line") of the response, and by a number of HTTP headers.
       Further metadata relates to how <b>::http::geturl</b> has processed the response from the server.

       The most important metadata can be accessed with the command <b>::http::responseInfo</b>.  This command  returns
       a  <b>dict</b>  of  metadata  that  are essential for identifying a successful transaction and making use of the
       response, along with other metadata that are informational.  The keys of the <b>dict</b> are:

                     <b>=====</b> <b>Essential</b> <b>Values</b> <b>=====</b>

       <b>stage</b>  This value, set by <b>::http::geturl</b>, describes the stage that the transaction has  reached.  Values,
              in  order  of  the  transaction  lifecycle,  are:  "created",  "connecting", "header", "body", and
              "complete".  The other <b>dict</b> keys will not be available until the  value  of  <b>stage</b>  is  "body"  or
              "complete".  The key <b>currentSize</b> has its final value only when <b>stage</b> is "complete".

       <b>status</b> This  value,  set  by  <b>::http::geturl</b>,  is  "ok"  for  a  successful  transaction; "eof", "error",
              "timeout", or "reset" for an unsuccessful transaction; or  ""  if  the  transaction  is  still  in
              progress.   The value is the same as that returned by command <b>::http::status</b>. The meaning of these
              values is described in the section <b>ERRORS</b> (above).

       <b>responseCode</b>
              The "HTTP status code" sent by the server in the first line (the "status line") of  the  response.
              If the value cannot be extracted from the status line, the full status line is returned.

       <b>reasonPhrase</b>
              The  "reason  phrase"  sent  by the server as a description of the HTTP status code.  If the value
              cannot be extracted from the status line, the full status line is returned.

       <b>contentType</b>
              The value of the <b>Content-Type</b> response header or, if the header  was  not  supplied,  the  default
              value "application/octet-stream".

       <b>binary</b> This  boolean  value,  set by <b>::http::geturl</b>, describes how the command has interpreted the entity
              returned by the server (after decoding any compression specified by the <b>Content-Encoding</b>  response
              header).    This   decoded   entity   is   accessible   as   the   return  value  of  the  command
              <b>::http::responseBody</b>.

              The value is <b>true</b> if http has interpreted the decoded entity as binary.   The  value  returned  by
              <b>::http::responseBody</b> is a Tcl binary string.  This is a suitable format for image data, zip files,
              etc.   <b>::http::geturl</b>  chooses  this  value  if  the user has requested a binary interpretation by
              passing the option <b>-binary</b> to the command, or if the server has supplied a binary content type  in
              a <b>Content-Type</b> response header, or if the server has not supplied any <b>Content-Type</b> header.

              The  value is <b>false</b> in other cases, and this means that http has interpreted the decoded entity as
              text. The text has been converted, from the character set  notified  by  the  server,  into  Tcl's
              internal Unicode format; the value returned by <b>::http::responseBody</b> is an ordinary Tcl string.

              It is always worth checking the value of "binary" after a HTTP transaction, to determine whether a
              misconfigured server has caused http to interpret a text resource as a binary, or vice versa.

       <b>redirection</b>
              The  URL  that is the redirection target. The value is that of the <b>Location</b> response header.  This
              header is sent when a response has status code 3XX (redirection).

       <b>upgrade</b>
              If not empty, the value indicates the protocol(s) to which the server will switch after completion
              of this transaction, while continuing to use the same connection.   When  the  server  intends  to
              switch protocols, it will also send the value "101" as the status code (the <b>responseCode</b> key), and
              the  word  "upgrade" as an element of the <b>Connection</b> response header (the <b>connectionResponse</b> key),
              and it will not send a response body.  See the section <b>PROTOCOL</b> <b>UPGRADES</b> for more information.

       <b>error</b>  The error message, if there is one.  Further information, including a stack trace and error  code,
              are available from command <b>::http::error</b>.

       <b>postError</b>
              The  error  message  (if  any)  generated  when  a HTTP POST request sends its request-body to the
              server.  Further information, including a stack trace and error code, are available  from  command
              <b>::http::postError</b>.   A  POST transaction may appear complete, according to the keys <b>stage</b>, <b>status</b>,
              and <b>responseCode</b>, but it is important to check this <b>postError</b> key in case an error  occurred  when
              uploading the request-body.

                     <b>=====</b> <b>Informational</b> <b>Values</b> <b>=====</b>

       <b>method</b> The HTTP method used in the request.

       <b>charset</b>
              The value of the charset attribute of the <b>Content-Type</b> response header.  The charset value is used
              only  for a text resource.  If the server did not specify a charset, the value defaults to that of
              the variable <b>::http::defaultCharset</b>, which unless it has been deliberately modified by the  caller
              is  <b>iso8859-1</b>.   Incoming  text  data is automatically converted from the character set defined by
              <b>charset</b> to Tcl's internal Unicode representation, i.e. to a Tcl string.

       <b>compression</b>
              A copy of the <b>Content-Encoding</b> response-header value.

       <b>httpRequest</b>
              The version of HTTP specified in the request (i.e. sent in the request line).  The value  is  that
              of  the  option  <b>-protocol</b>  supplied  to  <b>::http::geturl</b> (default value "1.1"), unless the command
              reduced the value to "1.0" because it was passed the <b>-handler</b> option.

       <b>httpResponse</b>
              The version of HTTP used by the server (obtained from the response  "status  line").   The  server
              uses  this  version of HTTP in its response, but ensures that this response is compatible with the
              HTTP version specified in the client's request.  If the value cannot be extracted from the  status
              line, the full status line is returned.

       <b>url</b>    The  requested  URL,  typically  the URL supplied as an argument to <b>::http::geturl</b> but without its
              "fragment" (the final part of the URL beginning with "#").

       <b>connectionRequest</b>
              The value, if any, sent to the server in <b>Connection</b> request header(s).

       <b>connectionResponse</b>
              The value, if any, received from the server in <b>Connection</b> response header(s).

       <b>connectionActual</b>
              This value, set by <b>::http::geturl</b>, reports whether the connection was closed after the transaction
              (value "close"), or left open (value "keep-alive").

       <b>transferEncoding</b>
              The value of the Transfer-Encoding response header,  if  it  is  present.   The  value  is  either
              "chunked" (indicating HTTP/1.1 "chunked encoding") or the empty string.

       <b>totalPost</b>
              The total length of the request body in a POST request.

       <b>currentPost</b>
              The  number of bytes of the POST request body sent to the server so far.  The value is the same as
              that returned by command <b>::http::size</b>.

       <b>totalSize</b>
              A copy of the <b>Content-Length</b> response-header value.  The number of bytes specified in  a  <b>Content-</b>
              <b>Length</b>  header, if one was sent.  If none was sent, the value is 0.  A correctly configured server
              omits this header if the transfer-encoding is "chunked", or (for  older  servers)  if  the  server
              closes the connection when it reaches the end of the resource.

       <b>currentSize</b>
              The number of bytes fetched from the server so far.

   <b>MORE</b> <b>METADATA</b>
       The  dictionary  returned  by  <b>::http::responseInfo</b>  is the most useful subset of the available metadata.
       Other metadata include:

       1. The full "status line" of the response, available as the return value of command <b>::http::responseLine</b>.

       2. The full response headers, available as the return value  of  command  <b>::http::responseHeaders</b>.   This
       return value is a list of the response-header names and values, in the order that they were received from
       the server.

       The return value is not a <b>dict</b> because some header names may occur more than once, notably <b>Set-Cookie</b>. If
       the  value  is  read  into a <b>dict</b> or into an array (using array set), only the last header with each name
       will be preserved.

              Some of the header names (metadata keys) are listed below, but the HTTP standard  defines  several
              more,  and  servers  are  free  to  add their own.  When a dictionary key is mentioned below, this
              refers to the <b>dict</b> value returned by command <b>::http::responseInfo</b>.

              <b>Content-Type</b>
                     The  content  type  of  the  URL  contents.    Examples   include   <b>text/html</b>,   <b>image/gif,</b>
                     <b>application/postscript</b>  and  <b>application/x-tcl</b>.   Text values typically specify a character
                     set, e.g.  <b>text/html;</b> <b>charset=UTF-8</b>.  Dictionary key <u>contentType</u>.

              <b>Content-Length</b>
                     The advertised size in bytes of the contents, available as dictionary key  <u>totalSize</u>.   The
                     actual  number  of  bytes  read  by  <b>::http::geturl</b>  so  far is available as dictionary key
                     <b>currentSize</b>.

              <b>Content-Encoding</b>
                     The  compression  algorithm  used  for  the  contents.   Examples  include  <b>gzip</b>,  <b>deflate</b>.
                     Dictionary key <u>content</u>.

              <b>Location</b>
                     This header is sent when a response has status code 3XX (redirection).  It provides the URL
                     that is the redirection target.  Dictionary key <u>redirection</u>.

              <b>Set-Cookie</b>
                     This  header  is  sent  to  offer a cookie to the client.  Cookie management is done by the
                     <b>::http::config</b> option <b>-cookiejar</b>, and so the <b>Set-Cookie</b> headers need not be parsed by  user
                     scripts.  See section <b>COOKIE</b> <b>JAR</b> <b>PROTOCOL</b>.

              <b>Connection</b>
                     The  value  can  be  supplied  as a comma-separated list, or by multiple headers.  The list
                     often has only one element, either "close" or "keep-alive".  The value "upgrade"  indicates
                     a successful upgrade request and is typically combined with the status code 101, an <b>Upgrade</b>
                     response header, and no response body.  Dictionary key <u>connectionResponse</u>.

              <b>Upgrade</b>
                     The  value  indicates the protocol(s) to which the server will switch immediately after the
                     empty line that terminates the 101 response headers.  Dictionary key <u>upgrade</u>.

   <b>EVEN</b> <b>MORE</b> <b>METADATA</b>
       1.     Details of the HTTP request.  The request is determined by the options supplied to  <b>::http::geturl</b>
              and <b>::http::config</b>.  However, it is sometimes helpful to examine what <b>::http::geturl</b> actually sent
              to  the  server,  and  this  information  is available through commands <b>::http::requestHeaders</b> and
              <b>::http::requestLine</b>.

       2.     The state array: the internal variables of <b>::http::geturl</b>.  It may sometimes be helpful to examine
              this array.  Details are given in the next section.

</pre><h4><b>STATE</b> <b>ARRAY</b></h4><pre>
       The <b>::http::geturl</b> procedure returns a <u>token</u> that can be used as an argument to other <b>::http::*</b> commands,
       which examine and manage the state of the  HTTP  transaction.   For  most  purposes  these  commands  are
       sufficient.   The <u>token</u> can also be used to access the internal state of the transaction, which is stored
       in a Tcl array.  This facility is most useful when writing callback commands for  the  options  <b>-command</b>,
       <b>-handler</b>,  <b>-progress</b>, or <b>-queryprogress</b>.  Use the following command inside the proc to define an easy-to-
       use array <u>state</u> as a local variable within the proc

              upvar 0 $token state

       Once the data associated with the URL is no longer needed, the state array should be  unset  to  free  up
       storage.  The <b>::http::cleanup</b> procedure is provided for that purpose.

       The  following elements of the array are supported, and are the origin of the values returned by commands
       as described below.  When a dictionary key is mentioned below, this refers to the <b>dict</b> value returned  by
       command <b>::http::responseInfo</b>.

              <b>binary</b> For dictionary key <u>binary</u>.

              <b>body</b>   For command <b>::http::responseBody</b>.

              <b>charset</b>
                     For dictionary key <u>charset</u>.

              <b>coding</b> For dictionary key <u>compression</u>.

              <b>connection</b>
                     For dictionary key <u>connectionActual</u>.

              <b>currentsize</b>
                     For command <b>::http::size</b>; and for dictionary key <u>currentSize</u>.

              <b>error</b>  For command <b>::http::error</b>; part is used in dictionary key <u>error</u>.

              <b>http</b>   For command <b>::http::responseLine</b>.

              <b>httpResponse</b>
                     For dictionary key <u>httpResponse</u>.

              <b>meta</b>   For command <b>::http::responseHeaders</b>. Further discussion above in the section <b>MORE</b> <b>METADATA</b>.

              <b>method</b> For dictionary key <u>method</u>.

              <b>posterror</b>
                     For dictionary key <u>postError</u>.

              <b>postErrorFull</b>
                     For command <b>::http::postError</b>.

              <b>-protocol</b>
                     For dictionary key <u>httpRequest</u>.

              <b>querylength</b>
                     For dictionary key <u>totalPost</u>.

              <b>queryoffset</b>
                     For dictionary key <u>currentPost</u>.

              <b>reasonPhrase</b>
                     For dictionary key <u>reasonPhrase</u>.

              <b>requestHeaders</b>
                     For command <b>::http::requestHeaders</b>.

              <b>requestLine</b>
                     For command <b>::http::requestLine</b>.

              <b>responseCode</b>
                     For dictionary key <u>responseCode</u>.

              <b>state</b>  For dictionary key <u>stage</u>.

              <b>status</b> For command <b>::http::status</b>; and for dictionary key <u>status</u>.

              <b>totalsize</b>
                     For dictionary key <u>totalSize</u>.

              <b>transfer</b>
                     For dictionary key <u>transferEncoding</u>.

              <b>type</b>   For dictionary key <u>contentType</u>.

              <b>upgrade</b>
                     For dictionary key <u>upgrade</u>.

              <b>url</b>    For dictionary key <u>url</u>.

</pre><h4><b>PERSISTENT</b> <b>CONNECTIONS</b></h4><pre>
   <b>BASICS</b>
       See RFC 7230 Sec 6, which supersedes RFC 2616 Sec 8.1.

       A persistent connection allows multiple HTTP/1.1 transactions to be carried over the same TCP connection.
       Pipelining  allows  a  client  to make multiple requests over a persistent connection without waiting for
       each response.  The server sends responses in the same order that the requests were received.

       If a POST request fails to complete, typically user confirmation is needed  before  sending  the  request
       again.   The  user  may wish to verify whether the server was modified by the failed POST request, before
       sending the same request again.

       A HTTP request will use a persistent socket if the call to <b>http::geturl</b> has the option  <b>-keepalive</b>  <b>true</b>.
       It  will use pipelining where permitted if the <b>http::config</b> option <b>-pipeline</b> is boolean <b>true</b> (its default
       value).

       The http package maintains no more than one persistent connection to each  server  (i.e.  each  value  of
       “domain:port”).   If  <b>http::geturl</b>  is  called  to  make a request over a persistent connection while the
       connection is busy with another request, the new request will be held in a queue until the connection  is
       free.

       The http package does not support HTTP/1.0 persistent connections controlled by the <b>Keep-Alive</b> header.

   <b>SPECIAL</b> <b>CASES</b>
       This subsection discusses issues related to closure of the persistent connection by the server, automatic
       retry  of failed requests, the special treatment necessary for POST requests, and the options for dealing
       with these cases.

       In accordance with RFC 7230, <b>http::geturl</b> does not pipeline requests that use the POST method.  If a POST
       uses a persistent connection and is not the first request on that connection, <b>http::geturl</b> waits until it
       has received the response for the previous request; or (if  <b>http::config</b>  option  <b>-postfresh</b>  is  boolean
       <b>true</b>) it uses a new connection for each POST.

       If  the  server  is  processing  a number of pipelined requests, and sends a response header “<b>Connection:</b>
       <b>close</b>” with one of the responses (other than  the  last),  then  subsequent  responses  are  unfulfilled.
       <b>http::geturl</b> will send the unfulfilled requests again over a new connection.

       A  difficulty  arises  when a HTTP client sends a request over a persistent connection that has been idle
       for a while.  The HTTP server may half-close an apparently idle connection while the client is sending  a
       request,  but  before the request arrives at the server: in this case (an “asynchronous close event”) the
       request will fail.  The difficulty arises because the client cannot be certain whether the POST  modified
       the state of the server.  For HEAD or GET requests, <b>http::geturl</b> opens another connection and retransmits
       the  failed  request.  However,  if  the request was a POST, RFC 7230 forbids automatic retry by default,
       suggesting  either  user  confirmation,  or  confirmation  by  user-agent  software  that  has   semantic
       understanding of the application.  The <b>http::config</b> option <b>-repost</b> allows for either possibility.

       Asynchronous  close  events  can  occur only in a short interval of time.  The <b>http</b> package monitors each
       persistent connection for closure by the server.  Upon detection, the connection is also  closed  at  the
       client end, and subsequent requests will use a fresh connection.

       If  the  <b>http::geturl</b>  command  is  called  with  option <b>-keepalive</b> <b>true</b>, then it will both try to use an
       existing persistent connection (if one is available), and it will send the server  a  “<b>Connection:</b>  <b>keep-</b>
       <b>alive</b>” request header asking to keep the connection open for future requests.

       The <b>http::config</b> options <b>-pipeline</b>, <b>-postfresh</b>, and <b>-repost</b> relate to persistent connections.

       Option <b>-pipeline</b>, if boolean <b>true</b>, will pipeline GET and HEAD requests made over a persistent connection.
       POST  requests  will  not  be pipelined - if the POST is not the first transaction on the connection, its
       request will not be sent until the previous response has finished.  GET and HEAD requests  made  after  a
       POST will not be sent until the POST response has been delivered, and will not be sent if the POST fails.

       Option  <b>-postfresh</b>,  if boolean <b>true</b>, will override the <b>http::geturl</b> option <b>-keepalive</b>, and always open a
       fresh connection for a POST request.

       Option <b>-repost</b>, if <b>true</b>, permits automatic retry  of  a  POST  request  that  fails  because  it  uses  a
       persistent  connection  that  the server has half-closed (an “asynchronous close event”).  Subsequent GET
       and HEAD requests in a failed pipeline will also be retried.  <u>The</u> <b>-repost</b> <u>option</u> <u>should</u> <u>be</u> <u>used</u>  <u>only</u>  <u>if</u>
       <u>the</u>  <u>application</u> <u>understands</u> <u>that</u> <u>the</u> <u>retry</u> <u>is</u> <u>appropriate</u> - specifically, the application must know that
       if the failed POST successfully modified the state of the server, a repeat POST  would  have  no  adverse
       effect.                                                                                                   2

<b>COOKIE</b> <b>JAR</b> <b>PROTOCOL</b>                                                                                              2
       Cookies  are  short  key-value  pairs  used  to  implement  sessions  within the otherwise-stateless HTTP 2
       protocol. (See RFC 6265 for details; Tcl does not implement the Cookie2 protocol as that is  rarely  seen 2
       in the wild.)                                                                                             2

       Cookie  storage  management commands — “cookie jars” — must support these subcommands which form the HTTP 2
       cookie storage management protocol. Note that <u>cookieJar</u> below does not have to be a command name;  it  is 2
       properly  a  command prefix (a Tcl list of words that will be expanded in place) and admits many possible 2
       implementations.                                                                                          2

       Though not formally part of the protocol, it  is  expected  that  particular  values  of  <u>cookieJar</u>  will 2
       correspond  to  sessions;  it is up to the caller of <b>::http::config</b> to decide what session applies and to 2
       manage the deletion of said sessions when they are no longer desired  (which  should  be  when  they  not 2
       configured as the current cookie jar).                                                                    2

       <u>cookieJar</u> <b>getCookies</b> <u>protocol</u> <u>host</u> <u>requestPath</u>                                                            2
              This  command  asks  the  cookie  jar what cookies should be supplied for a particular request. It 2
              should take the <u>protocol</u> (typically <b>http</b> or <b>https</b>), <u>host</u> name and <u>requestPath</u> (parsed from the <u>url</u> 2
              argument to <b>::http::geturl</b>) and return a list of cookie keys and values that describe the  cookies 2
              to supply to the remote host. The list must have an even number of elements.                       2

              There  should only ever be at most one cookie with a particular key for any request (typically the 2
              one with the most specific <u>host</u>/domain match and most specific <u>requestPath</u>/path match), but  there 2
              may be many cookies with different names in any request.                                           2

       <u>cookieJar</u> <b>storeCookie</b> <u>cookieDictionary</u>                                                                    2
              This  command asks the cookie jar to store a particular cookie that was returned by a request; the 2
              result of this command is ignored. The cookie (which will have been parsed by the http package) is 2
              described by a dictionary, <u>cookieDictionary</u>, that may have the following keys:                     2

              <b>domain</b>                                                                                             2
                     This is always present. Its value describes the domain hostname <u>or</u> <u>prefix</u> that  the  cookie 2
                     should  be  returned  for.  The checking of the domain against the origin (below) should be 2
                     careful since sites that issue cookies should only do so for domains related to themselves. 2
                     Cookies that do not obey a relevant origin matching rule should be ignored.                 2

              <b>expires</b>                                                                                            2
                     This is optional. If present, the cookie is intended to be  a  persistent  cookie  and  the 2
                     value  of  the option is the Tcl timestamp (in seconds from the same base as <b>clock</b> <b>seconds</b>) 2
                     of when the cookie expires (which may be in the past, which should  result  in  the  cookie 2
                     being  deleted  immediately). If absent, the cookie is intended to be a session cookie that 2
                     should be not persisted beyond the lifetime of the cookie jar.                              2

              <b>hostonly</b>                                                                                           2
                     This is always present. Its value is a boolean that  describes  whether  the  cookie  is  a 2
                     single host cookie (true) or a domain-level cookie (false).                                 2

              <b>httponly</b>                                                                                           2
                     This is always present. Its value is a boolean that is true when the site wishes the cookie 2
                     to only ever be used with HTTP (or HTTPS) traffic.                                          2

              <b>key</b>                                                                                                2
                     This  is  always  present.  Its  value  is  the  <u>key</u>  of  the  cookie, which is part of the 2
                     information that must be return when sending this cookie back in a future request.          2

              <b>origin</b>                                                                                             2
                     This is always present. Its value describes where the http package believes it received the 2
                     cookie from, which may be useful for checking whether the cookie's domain is valid.         2

              <b>path</b>                                                                                               2
                     This is always present. Its value describes the path  prefix  of  requests  to  the  cookie 2
                     domain where the cookie should be returned.                                                 2

              <b>secure</b>                                                                                             2
                     This  is  always  present.  Its value is a boolean that is true when the cookie should only 2
                     used on requests sent over secure channels (typically HTTPS).                               2

              <b>value</b>                                                                                              2
                     This is always present. Its value is the  value  of  the  cookie,  which  is  part  of  the 2
                     information that must be return when sending this cookie back in a future request.          2

              Other keys may always be ignored; they have no meaning in this protocol.                           2

</pre><h4><b>PROTOCOL</b> <b>UPGRADES</b></h4><pre>
       The  HTTP/1.1  <b>Connection</b>  and <b>Upgrade</b> request headers inform the server that the client wishes to change
       the protocol used over the existing connection (RFC 7230).  This mechanism  can  be  used  to  request  a
       WebSocket  (RFC  6455), a higher version of the HTTP protocol (HTTP 2), or TLS encryption.  If the server
       accepts the upgrade request, its response code will be 101.

       To request a protocol upgrade when calling <b>http::geturl</b>, the  <b>-headers</b>  option  must  supply  appropriate
       values  for  <b>Connection</b>  and  <b>Upgrade</b>,  and the <b>-command</b> option must supply a command that implements the
       requested protocol and can also handle the server response if the server refuses  the  protocol  upgrade.
       For  upgrade requests <b>http::geturl</b> ignores the value of option <b>-keepalive</b>, and always uses the value <b>0</b> so
       that the upgrade request is not made over a connection that is intended for multiple HTTP requests.

       The Tcllib library <b>websocket</b> implements WebSockets, and makes the necessary calls to commands in the <b>http</b>
       package.

       There is currently no native Tcl client library for HTTP/2.

       The <b>Upgrade</b> mechanism is not used to request TLS in web browsers, because <b>http</b> and <b>https</b> are served  over
       different  ports.  It is used by protocols such as Internet Printing Protocol (IPP) that are built on top
       of <b>http(s)</b> and use the same TCP port number for both secure and insecure traffic.

       In browsers, opportunistic encryption is instead  implemented  by  the  <b>Upgrade-Insecure-Requests</b>  client
       header.   If  a secure service is available, the server response code is a 307 redirect, and the response
       header <b>Location</b> specifies the target URL.  The browser must call <b>http::geturl</b> again  in  order  to  fetch
       this URL.  See https://w3c.github.io/webappsec-upgrade-insecure-requests/

</pre><h4><b>THREADS</b></h4><pre>
   <b>PURPOSE</b>
       Command  <b>::http::geturl</b>  uses  the  Tcl  <b>::socket</b>  command  with the <b>-async</b> option to connect to a remote
       server, but the return from this command can be delayed in  adverse  cases  (e.g.  a  slow  DNS  lookup),
       preventing the event loop from processing other events.  This delay is avoided if the <b>::socket</b> command is
       evaluated  in  another  thread.   The  Thread  package  is  not part of Tcl but is provided in "Batteries
       Included" distributions.  Instead of the <b>::socket</b> command, the http  package  uses  <b>::http::socket</b>  which
       makes  connections  in  the manner specified by the value of <b>-threadlevel</b> and the availability of package
       Thread.

   <b>WITH</b> <b>TLS</b> <b>(HTTPS)</b>
       The same <b>-threadlevel</b> configuration applies to both HTTP and HTTPS  connections.   HTTPS  is  enabled  by
       using the <b>http::register</b> command, typically by specifying the <b>::tls::socket</b> command of the tls package to
       handle  TLS  cryptography.   The <b>::tls::socket</b> command connects to the remote server by using the command
       specified by the value  of  variable  <b>::tls::socketCmd</b>,  and  this  value  defaults  to  "::socket".   If
       http::geturl  finds that <b>::tls::socketCmd</b> has this value, it replaces it with the value "::http::socket".
       If <b>::tls::socketCmd</b> has a value other than "::socket", i.e. if the script or  the  Tcl  installation  has
       replaced  the value "::socket" with the name of a different command, then http does not change the value.
       The script or installation that modified <b>::tls::socketCmd</b> is responsible for  integrating  <b>::http::socket</b>
       into its own replacement command.

   <b>WITH</b> <b>A</b> <b>CHILD</b> <b>INTERPRETER</b>
       The  peer  thread can transfer the socket only to the main interpreter of the script's thread.  Therefore
       the thread-based <b>::http::socket</b> works with non-zero <b>-threadlevel</b> values only if the script  runs  in  the
       main interpreter.  A child interpreter must use <b>-threadlevel</b> <b>0</b> unless the parent interpreter has provided
       alternative  facilities.   The  main parent interpreter may grant full <b>-threadlevel</b> facilities to a child
       interpreter, for example by aliasing, to <b>::http::socket</b> in the child, a command that runs <b>http::socket</b> in
       the parent, and then transfers the socket to the child.

</pre><h4><b>EXAMPLE</b></h4><pre>
       This example creates a procedure to copy a URL to a file while printing a progress meter, and prints  the
       response headers associated with the URL.

              proc httpcopy { url file {chunk 4096} } {
                  set out [open $file w]
                  set token [<b>::http::geturl</b> $url -channel $out \
                          -progress httpCopyProgress -blocksize $chunk]
                  close $out

                  # This ends the line started by httpCopyProgress
                  puts stderr ""

                  upvar 0 $token state
                  set max 0
                  foreach {name value} $<a href="../manmeta/state.meta.html">state</a>(meta) {
                      if {[string length $name] &gt; $max} {
                          set max [string length $name]
                      }
                      if {[regexp -nocase ^location$ $name]} {
                          # Handle URL redirects
                          puts stderr "Location:$value"
                          return [httpcopy [string trim $value] $file $chunk]
                      }
                  }
                  incr max
                  foreach {name value} $<a href="../manmeta/state.meta.html">state</a>(meta) {
                      puts [format "%-*s %s" $max $name: $value]
                  }

                  return $token
              }
              proc httpCopyProgress {args} {
                  puts -nonewline stderr .
                  flush stderr
              }

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <a href="../man3tcl/safe.3tcl.html">safe</a>(3tcl), <a href="../man3tcl/socket.3tcl.html">socket</a>(3tcl), <a href="../man3tcl/safesock.3tcl.html">safesock</a>(3tcl)

</pre><h4><b>KEYWORDS</b></h4><pre>
       internet, security policy, socket, www

http                                                  2.10                                            <u><a href="../man3tcl/http.3tcl.html">http</a></u>(3tcl)
</pre>
 </div>
</div></section>
</div>
</body>
</html>