<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>This  manual  page  is part of the POSIX Programmer's Manual.  The Linux implementation of this interface</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/manpages-posix-dev">manpages-posix-dev_2017a-2_all</a> <br><br><pre>
</pre><h4><b>PROLOG</b></h4><pre>
       This  manual  page  is part of the POSIX Programmer's Manual.  The Linux implementation of this interface
       may differ (consult the corresponding Linux manual page for details of Linux behavior), or the  interface
       may not be implemented on Linux.

</pre><h4><b>NAME</b></h4><pre>
       posix_spawn_file_actions_addclose,  posix_spawn_file_actions_addopen  — add close or open action to spawn
       file actions object (<b>ADVANCED</b> <b>REALTIME</b>)

</pre><h4><b>SYNOPSIS</b></h4><pre>
       #include &lt;<a href="file:/usr/include/spawn.h">spawn.h</a>&gt;

       int posix_spawn_file_actions_addclose(posix_spawn_file_actions_t
           *<u>file_actions</u>, int <u>fildes</u>);
       int posix_spawn_file_actions_addopen(posix_spawn_file_actions_t
           *restrict <u>file_actions</u>, int <u>fildes</u>,
           const char *restrict <u>path</u>, int <u>oflag</u>, mode_t <u>mode</u>);

</pre><h4><b>DESCRIPTION</b></h4><pre>
       These functions shall add or delete a close or open action to a spawn file actions object.

       A spawn file actions object is of type <b>posix_spawn_file_actions_t</b> (defined in <u>&lt;spawn.h&gt;</u>) and is  used  to
       specify  a  series  of actions to be performed by a <u>posix_spawn</u>() or <u>posix_spawnp</u>() operation in order to
       arrive at the set of open file descriptors for the child process given the set of open  file  descriptors
       of  the  parent.   POSIX.1‐2008  does  not  define  comparison  or  assignment  operators  for  the  type
       <b>posix_spawn_file_actions_t</b>.

       A spawn file actions object, when passed to <u>posix_spawn</u>() or <u>posix_spawnp</u>(), shall specify how the set of
       open file descriptors in the calling  process  is  transformed  into  a  set  of  potentially  open  file
       descriptors for the spawned process. This transformation shall be as if the specified sequence of actions
       was  performed exactly once, in the context of the spawned process (prior to execution of the new process
       image), in the order in which the actions were added to the object; additionally, when  the  new  process
       image  is  executed,  any  file descriptor (from this new set) which has its FD_CLOEXEC flag set shall be
       closed (see <u>posix_spawn</u>()).

       The <u>posix_spawn_file_actions_addclose</u>() function shall add a <u>close</u> action to  the  object  referenced  by
       <u>file_actions</u>  that  shall  cause  the  file  descriptor <u>fildes</u> to be closed (as if <u>close</u>(<u>fildes</u>) had been
       called) when a new process is spawned using this file actions object.

       The <u>posix_spawn_file_actions_addopen</u>() function shall add an <u>open</u> action  to  the  object  referenced  by
       <u>file_actions</u> that shall cause the file named by <u>path</u> to be opened (as if <u>open</u>(<u>path</u>, <u>oflag</u>, <u>mode</u>) had been
       called,  and  the returned file descriptor, if not <u>fildes</u>, had been changed to <u>fildes</u>) when a new process
       is spawned using this file actions object. If <u>fildes</u> was already an open file  descriptor,  it  shall  be
       closed before the new file is opened.

       The string described by <u>path</u> shall be copied by the <u>posix_spawn_file_actions_addopen</u>() function.

</pre><h4><b>RETURN</b> <b>VALUE</b></h4><pre>
       Upon  successful  completion,  these  functions  shall  return  zero; otherwise, an error number shall be
       returned to indicate the error.

</pre><h4><b>ERRORS</b></h4><pre>
       The <u>posix_spawn_file_actions_addopen</u>() function shall fail if:

       <b>EBADF</b>  The value specified by <u>fildes</u> is negative or greater than or equal to {OPEN_MAX}.

       The <u>posix_spawn_file_actions_addclose</u>() function shall fail if:

       <b>EBADF</b>  The value specified by <u>fildes</u> is negative.

       These functions may fail if:

       <b>EINVAL</b> The value specified by <u>file_actions</u> is invalid.

       <b>ENOMEM</b> Insufficient memory exists to add to the spawn file actions object.

       It shall not be considered an error for the <u>fildes</u> argument passed to these functions to specify  a  file
       descriptor  for  which  the  specified operation could not be performed at the time of the call. Any such
       error will be detected when the associated file actions object is later used during  a  <u>posix_spawn</u>()  or
       <u>posix_spawnp</u>() operation.

       <u>The</u> <u>following</u> <u>sections</u> <u>are</u> <u>informative.</u>

</pre><h4><b>EXAMPLES</b></h4><pre>
       None.

</pre><h4><b>APPLICATION</b> <b>USAGE</b></h4><pre>
       These functions are part of the Spawn option and need not be provided on all implementations.

       Implementations  may  use  file  descriptors  that  must  be inherited into child processes for the child
       process to remain conforming, such as for message catalog or tracing purposes. Therefore, an  application
       that  calls  <u>posix_spawn_file_actions_addclose</u>() with an arbitrary integer risks non-conforming behavior,
       and this function can only portably be used to close file descriptor  values  that  the  application  has
       obtained  through  explicit actions, or for the three file descriptors corresponding to the standard file
       streams. In order to avoid a race condition of  leaking  an  unintended  file  descriptor  into  a  child
       process,  an  application should consider opening all file descriptors with the FD_CLOEXEC bit set unless
       the file descriptor is intended to be inherited across <u>exec</u>.

</pre><h4><b>RATIONALE</b></h4><pre>
       A spawn file actions object may be initialized to contain an ordered sequence  of  <u>close</u>(),  <u>dup2</u>(),  and
       <u>open</u>()  operations  to  be  used  by  <u>posix_spawn</u>()  or  <u>posix_spawnp</u>() to arrive at the set of open file
       descriptors inherited by the spawned process from the set of open file descriptors in the parent  at  the
       time  of  the  <u>posix_spawn</u>()  or  <u>posix_spawnp</u>()  call. It had been suggested that the <u>close</u>() and <u>dup2</u>()
       operations alone are sufficient to rearrange file descriptors, and that files which need to be opened for
       use by the spawned process can be handled either by having the  calling  process  open  them  before  the
       <u>posix_spawn</u>()  or  <u>posix_spawnp</u>()  call  (and  close  them after), or by passing pathnames to the spawned
       process (in <u>argv</u>) so that it may open them itself. The standard developers  recommend  that  applications
       use  one  of  these two methods when practical, since detailed error status on a failed open operation is
       always available to the application this way. However, the standard developers feel that allowing a spawn
       file actions object to specify open operations is still appropriate because:

        1. It is consistent with equivalent POSIX.5 (Ada) functionality.

        2. It supports the I/O redirection paradigm commonly employed by POSIX programs designed to  be  invoked
           from  a  shell. When such a program is the child process, it may not be designed to open files on its
           own.

        3. It allows file opens that might otherwise fail or violate file ownership/access rights if executed by
           the parent process.

       Regarding 2. above, note that the spawn open file action provides to <u>posix_spawn</u>() and <u>posix_spawnp</u>() the
       same capability that the shell redirection operators provide to <u>system</u>(), only  without  the  intervening
       execution of a shell; for example:

           system ("myprog &lt;file1 3&lt;file2");

       Regarding  3.  above,  note that if the calling process needs to open one or more files for access by the
       spawned process, but has insufficient spare file descriptors, then the open action is necessary to  allow
       the  <u>open</u>()  to  occur  in the context of the child process after other file descriptors have been closed
       (that must remain open in the parent).

       Additionally, if a parent is executed from  a  file  having  a  ``set-user-id''  mode  bit  set  and  the
       POSIX_SPAWN_RESETIDS  flag  is set in the spawn attributes, a file created within the parent process will
       (possibly incorrectly) have the parent's effective user ID as its owner, whereas a file  created  via  an
       <u>open</u>()  action during <u>posix_spawn</u>() or <u>posix_spawnp</u>() will have the parent's real ID as its owner; and an
       open by the parent process may successfully open a file to which the real user should not have access  or
       fail to open a file to which the real user should have access.

   <b>File</b> <b>Descriptor</b> <b>Mapping</b>
       The  standard developers had originally proposed using an array which specified the mapping of child file
       descriptors back to those of the parent. It was pointed out by the ballot group that it is  not  possible
       to  reshuffle file descriptors arbitrarily in a library implementation of <u>posix_spawn</u>() or <u>posix_spawnp</u>()
       without provision for one or more spare file descriptor entries (which simply may not be available). Such
       an array requires that an implementation develop a  complex  strategy  to  achieve  the  desired  mapping
       without inadvertently closing the wrong file descriptor at the wrong time.

       It  was  noted  by  a  member  of  the Ada Language Bindings working group that the approved Ada Language
       <u>Start_Process</u> family of POSIX process primitives use a caller-specified set of file actions to alter  the
       normal  <u>fork</u>()/<u>exec</u>  semantics  for  inheritance  of file descriptors in a very flexible way, yet no such
       problems exist because the burden of determining how to achieve the  final  file  descriptor  mapping  is
       completely  on  the  application. Furthermore, although the file actions interface appears frightening at
       first glance, it is actually quite simple to implement in either a library or the kernel.

       The <u>posix_spawn_file_actions_addclose</u>() function is not required to check whether the file descriptor  is
       less than {OPEN_MAX} because on some implementations {OPEN_MAX} reflects the RLIMIT_NOFILE soft limit and
       therefore  calling  <u>setrlimit</u>() to reduce this limit can result in an {OPEN_MAX} value less than or equal
       to an already open file descriptor.  Applications need to be able  to  close  such  file  descriptors  on
       spawn.    On   implementations   where   {OPEN_MAX}   does   not   change,   it   is   recommended   that
       <u>posix_spawn_file_actions_addclose</u>() should  return  <b>[EBADF]</b>  if  <u>fildes</u>  is  greater  than  or  equal  to
       {OPEN_MAX}.

</pre><h4><b>FUTURE</b> <b>DIRECTIONS</b></h4><pre>
       None.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u>close</u>(), <u>dup</u>(), <u>open</u>(), <u>posix_spawn</u>(), <u>posix_spawn_file_actions_adddup2</u>(),
       <u>posix_spawn_file_actions_destroy</u>()

       The Base Definitions volume of POSIX.1‐2017, <b>&lt;spawn.h&gt;</b>

</pre><h4><b>COPYRIGHT</b></h4><pre>
       Portions of this text are reprinted and reproduced in electronic form from IEEE Std 1003.1-2017, Standard
       for  Information  Technology  --  Portable  Operating  System  Interface  (POSIX),  The  Open  Group Base
       Specifications Issue 7, 2018 Edition, Copyright (C) 2018 by the Institute of Electrical  and  Electronics
       Engineers, Inc and The Open Group.  In the event of any discrepancy between this version and the original
       IEEE  and The Open Group Standard, the original IEEE and The Open Group Standard is the referee document.
       The original Standard can be obtained online at <a href="http://www.opengroup.org/unix/online.html">http://www.opengroup.org/unix/online.html</a> .

       Any typographical or formatting errors that appear in this page are most likely to have  been  introduced
       during   the   conversion  of  the  source  files  to  man  page  format.  To  report  such  errors,  see
       https://www.kernel.org/doc/man-pages/reporting_bugs.html .

IEEE/The Open Group                                   2017             <u><a href="../man3POSIX/POSIX_SPAWN_FILE_ACTIONS_ADDCLOSE.3POSIX.html">POSIX_SPAWN_FILE_ACTIONS_ADDCLOSE</a></u>(3POSIX)
</pre>
 </div>
</div></section>
</div>
</body>
</html>