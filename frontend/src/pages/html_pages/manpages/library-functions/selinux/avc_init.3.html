<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>avc_init - legacy userspace SELinux AVC setup</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/libselinux1-dev">libselinux1-dev_3.8.1-1_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       avc_init - legacy userspace SELinux AVC setup

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>#include</b> <b>&lt;selinux/selinux.h&gt;</b>
       <b>#include</b> <b>&lt;selinux/avc.h&gt;</b>

       <b>int</b> <b>avc_init(const</b> <b>char</b> <b>*</b><u>msgprefix</u><b>,</b>
                    <b>const</b> <b>struct</b> <b>avc_memory_callback</b> <b>*</b><u>mem_callbacks</u><b>,</b>
                    <b>const</b> <b>struct</b> <b>avc_log_callback</b> <b>*</b><u>log_callbacks</u><b>,</b>
                    <b>const</b> <b>struct</b> <b>avc_thread_callback</b> <b>*</b><u>thread_callbacks</u><b>,</b>
                    <b>const</b> <b>struct</b> <b>avc_lock_callback</b> <b>*</b><u>lock_callbacks</u><b>);</b>

</pre><h4><b>DESCRIPTION</b></h4><pre>
       <b>avc_init</b>()  is  deprecated; please use <b><a href="../man3/avc_open.3.html">avc_open</a></b>(3) in conjunction with <b><a href="../man3/selinux_set_callback.3.html">selinux_set_callback</a></b>(3) in all new
       code.

       <b>avc_init</b>() initializes the userspace AVC and must be  called  before  any  other  AVC  operation  can  be
       performed.   A  non-NULL <u>msgprefix</u> will be prepended to all audit messages produced by the userspace AVC.
       The default is `uavc'.  The remaining arguments, if  non-NULL,  specify  callbacks  to  be  used  by  the
       userspace AVC.

</pre><h4><b>CALLBACKS</b></h4><pre>
       The userspace AVC can be directed how to perform memory allocation, logging, thread creation, and locking
       via callback functions passed to <b>avc_init</b>().  The purpose of this functionality is to allow the userspace
       AVC to be smoothly integrated into existing userspace object managers.

       Use an <b>avc_memory_callback</b> structure to specify alternate functions for dynamic memory allocation.

              struct avc_memory_callback {
                  void  *(*func_malloc)(size_t size);
                  void  (*func_free)(void *ptr);
              };

       The  two  fields  of the structure should be pointers to functions which behave as <b><a href="../man3/malloc.3.html">malloc</a></b>(3) and <b><a href="../man3/free.3.html">free</a></b>(3),
       which are used by default.

       Use an <b>avc_log_callback</b> structure to specify alternate functions for logging.

              struct avc_log_callback {
                  void  (*func_log)(const char *fmt, ...);
                  void  (*func_audit)(void *auditdata,
                                      security_class_t class,
                                      char *msgbuf, size_t msgbufsize);
              };

       The <b>func_log</b> callback should accept a <b><a href="../man3/printf.3.html">printf</a></b>(3) style format and arguments and log them as desired.   The
       default  behavior prints the message on the standard error.  The <b>func_audit</b> callback should interpret the
       <u>auditdata</u> parameter for the given <u>class</u>, printing a human-readable interpretation to <u>msgbuf</u> using no more
       than <u>msgbufsize</u> characters.  The default behavior is to ignore <u>auditdata</u>.

       Use an <b>avc_thread_callback</b> structure to specify functions for starting and manipulating threads.

              struct avc_thread_callback {
                  void  *(*func_create_thread)(void (*run)(void));
                  void  (*func_stop_thread)(void *thread);
              };

       The <b>func_create_thread</b> callback should create a new thread and return a pointer which references it.  The
       thread  should  execute  the  <u>run</u>  argument,  which  does  not  return  under  normal  conditions.    The
       <b>func_stop_thread</b>  callback  should cancel the running thread referenced by <u>thread</u>.  By default, threading
       is not used; see <b>KERNEL</b> <b>STATUS</b> <b>PAGE</b> and <b>NETLINK</b> <b>NOTIFICATION</b> below.

       Use an <b>avc_lock_callback</b> structure to specify functions to create, obtain, and release locks for  use  by
       threads.

              struct avc_lock_callback {
                  void  *(*func_alloc_lock)(void);
                  void  (*func_get_lock)(void *lock);
                  void  (*func_release_lock)(void *lock);
                  void  (*func_free_lock)(void *lock);
              };

       The  <b>func_alloc_lock</b>  callback  should  create  a new lock, returning a pointer which references it.  The
       <b>func_get_lock</b> callback should obtain <u>lock</u>, blocking if necessary.  The <b>func_release_lock</b> callback  should
       release <u>lock</u>.  The <b>func_free_lock</b> callback should destroy <u>lock</u>, freeing any resources associated with it.
       The default behavior is not to perform any locking.  Note that undefined behavior may result if threading
       is used without appropriate locking.

</pre><h4><b>KERNEL</b> <b>STATUS</b> <b>PAGE</b></h4><pre>
       Linux  kernel  version 2.6.37 supports the SELinux kernel status page, enabling userspace applications to
       <b><a href="../man2/mmap.2.html">mmap</a></b>(2) SELinux status state in read-only mode to avoid system calls during the cache hit code path.

       <b>avc_init</b>()  calls  <b><a href="../man3/selinux_status_open.3.html">selinux_status_open</a></b>(3)  to  initialize  the  selinux  status  state.  If  successfully
       initialized, the userspace AVC will default to single-threaded mode and ignore the <b>func_create_thread</b> and
       <b>func_stop_thread</b> callbacks. All callbacks set via <b><a href="../man3/selinux_set_callback.3.html">selinux_set_callback</a></b>(3) will still be honored.

       <b><a href="../man3/avc_has_perm.3.html">avc_has_perm</a></b>(3)   and   <b><a href="../man3/selinux_check_access.3.html">selinux_check_access</a></b>(3)   both   check   for  status  updates  through  calls  to
       <b><a href="../man3/selinux_status_updated.3.html">selinux_status_updated</a></b>(3) at the start of each permission query and take the appropriate action.

       Two status types are currently implemented.  <b>setenforce</b> events will change the effective enforcing  state
       used within the AVC, and <b>policyload</b> events will result in a cache flush.

</pre><h4><b>NETLINK</b> <b>NOTIFICATION</b></h4><pre>
       In  the  event  that  the  kernel  status page is not successfully <b><a href="../man2/mmap.2.html">mmap</a></b>(2)'ed the AVC will default to the
       netlink fallback mechanism, which opens a netlink socket for receiving status  updates.   <b>setenforce</b>  and
       <b>policyload</b> events will have the same results as for the status page implementation, but all status update
       checks will now require a system call.

       By  default, <b><a href="../man3/avc_open.3.html">avc_open</a></b>(3) does not set threading or locking callbacks. In the fallback case, the userspace
       AVC checks for new netlink messages at the start of each  permission  query.  If  threading  and  locking
       callbacks  are  passed to <b>avc_init</b>(), a dedicated thread will be started to listen on the netlink socket.
       This may increase performance in the absence of the status page and will ensure  that  log  messages  are
       generated immediately rather than at the time of the next permission query.

</pre><h4><b>RETURN</b> <b>VALUE</b></h4><pre>
       Functions  with  a  return  value  return  zero  on  success.   On error, -1 is returned and <u>errno</u> is set
       appropriately.

</pre><h4><b>NOTES</b></h4><pre>
       The <u>msgprefix</u> argument to <b>avc_init</b>() currently has a length limit of 15 characters and will be  truncated
       if necessary.

       If  a  provided  <b>func_malloc</b>  callback does not set <u>errno</u> appropriately on error, userspace AVC calls may
       exhibit the same behavior.

       If a netlink thread has been created and an error occurs on the socket (such as  an  access  error),  the
       thread  may terminate and cause the userspace AVC to return <b>EINVAL</b> on all further permission checks until
       <b>avc_destroy</b> is called.

</pre><h4><b>AUTHOR</b></h4><pre>
       Eamon Walsh &lt;<a href="mailto:ewalsh@tycho.nsa.gov">ewalsh@tycho.nsa.gov</a>&gt;

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b><a href="../man3/avc_open.3.html">avc_open</a></b>(3), <b><a href="../man3/selinux_status_open.3.html">selinux_status_open</a></b>(3), <b><a href="../man3/selinux_status_updated.3.html">selinux_status_updated</a></b>(3), <b><a href="../man3/selinux_set_callback.3.html">selinux_set_callback</a></b>(3), <b><a href="../man8/selinux.8.html">selinux</a></b>(8)

                                                   27 May 2004                                       <u><a href="../man3/avc_init.3.html">avc_init</a></u>(3)
</pre>
 </div>
</div></section>
</div>
</body>
</html>