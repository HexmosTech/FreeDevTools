<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>avr-evtd - Linkstation AVR Event daemon</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/avr-evtd">avr-evtd_1.7.7-5_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       avr-evtd - Linkstation AVR Event daemon

</pre><h4><b>SYNOPSIS</b></h4><pre>
       avr-evtd [ <b>-d</b> <u>/dev/tty</u> ] [i | c | v]

</pre><h4><b>DESCRIPTION</b></h4><pre>
       <u>avr-evtd</u>  is a simple and small user space interface to the Linkstation AVR micro-controller.  It doesn't
       have a lot of special  features,  but  it's  main  task  is  to  provide  'keep-alive'  messages  to  the
       Linkstation's  on-board  AVR device.  This device controls/monitors the fan, various LEDs, timed power up
       and two buttons.  This daemon provides the necessary initialization to the device and also stimulates the
       LEDs depending on various fault conditions.  It also monitors a power button (located at the front) and a
       reset button (located at the rear).

       <u>avr-evtd</u> searches for a configuration file located within <b>/etc/melco</b> at start-up time. If this file  does
       not  exist,  then  <u>avr-evtd</u>  reverts to reading the file located at <b>/etc/default/avr-evtd.</b>  Additionally,
       <u>avr-evtd</u> may, if requested, periodically check the root (<b>Under</b>  <b>user</b>  <b>control</b>  <b>and</b>  <b>could</b>  <b>be</b>  <b>/dev/hda1</b>)
       partition  and  the user working partition (<b>For</b> <b>example,</b> <b>/dev/hda3</b>) to ensure they are mounted.  Also, if
       requested, it will determine if sufficient space remains  and  if  not  then  the  AVR  is  requested  to
       illuminate  the  DISK  LED.  This periodic checking also takes place on the configuration files.  If they
       are deemed to have been updated, then the daemon will respond accordingly.

       Any failures are normally routed through the log files.  With timed shutdown/power up, a warning will  be
       broadcast  to  all users (console message) when within 5 or less minutes of power off.  Also, fan failure
       alerts will be broadcast in this fashion.  Failure to determine mounted <b>working</b> partition will result  in
       the DIAG LED flashing three times, repeatedly.

       A new feature of this daemon is the ability to code events for single or groups of days.  This allows the
       user to add any number of power-on/off events as required.  This also has the added benefit of being able
       to  shut  down the device for longer periods.  The internal AVR timer has a 12-bit resolution timer which
       can power up the Linkstation from a maximum of a sixty eight hour sleep: from time  of  invocation.   The
       AVR  is  updated  again  at time of power down/shutdown to re-validate the timer, in case of time updates
       (either by user or NTP).  This will also preserve the 68 hour sleep resolution.

</pre><h4><b>OPTIONS</b></h4><pre>
       <b>-d</b>   <u>/dev/tty</u> Specifies the UART device used to communicate with the AVR. This is normally taken care  of
            by the scripts but can be specified in the configuration file.  <b>See</b> <b>below</b> <b>for</b> <b>details.</b>

       <b>-c</b>   Don't fork, i.e. run in the foreground (debug use only).

       <b>-i</b>   Returns the port memory location for the device specified by <b>-d</b> <u>/dev/tty</u>

       <b>-v</b>   Display daemon version.

</pre><h4><b>THE</b> <b>CONFIGURATION</b> <b>FILE</b></h4><pre>
       The  <u>avr-evtd</u>  configuration  file  is  the  fallback file in the event that the stock melco files do not
       exist.  The file is read at initial start-up in order to determine if timed shutdown is required  and  if
       the  disk  usage is to be monitored.  The file should be always located within the <a href="file:/etc/default">/etc/default</a> directory
       and a sample file is provided.  The file format is similar to other Unix configuration files  -  comments
       begin  with  a  #  character  and  extend to the end of the line; blank lines are ignored.  Configuration
       commands consist of an initial keyword followed by an  argument.   Arguments  may  be  strings  or  times
       written  in  HH:MM  (UTC) format.  Optional arguments are delimited by [ ] in the following descriptions,
       while alternatives are separated by |.

       <u>DEBUG</u>
            [ON | OFF]

            This is reserved for admin only.  Allows logging  of  certain  information.   A  log  file  will  be
            maintained in /etc/avr-evtd logging events and when run from command line, the process will log data
            to the console.

       <u>TIMER</u>
            [YES | NO]

            The timer command informs the daemon if it has to provide time controlled shutdown and power up.  If
            <u>TIMER</u>  is  set  to  <b>NO</b> then this function is not available and the commands <u>SHUTDOWN</u> and <u>POWERON</u> are
            ignored and have no effect.  The same applies if any day events are specified and the <u>TIMER</u>  is  set
            to <b>NO</b> then these events will also be ignored.

       <u>DEVICE</u>
            [/dev/tty]

            This  informs  the  AVR  which  UART to use when communicating with the AVR.  The communication path
            between the micro-controller and this daemon is via a serial link.  This keyword is not for  general
            use  and is provided to allow advanced users the option of overriding automatic configuration.  This
            would normally be set to /dev/ttyS1 but on some systems it is  /dev/ttyS0.   The  selection  of  the
            correct port is performed by the daemon start script and is not normally required to be altered.

       <u>[&lt;day&gt;</u>|<u>&lt;day&gt;-&lt;day&gt;]</u>
            [ON=HH:MM | ON= | OFF=HH:MM | OFF=]

            This  defines  events for either a single day or group of days, '-' separator.  Any number of <b>ON</b> and
            <b>OFF</b> events can be specified and can be extended over additional lines. &lt;day&gt; can be  any  number  of
            days of the week specified as either SUN, MON, TUE, WED, THR, FRI, and SAT.  For example:

                      <b>MON-WED=ON=09:00,OFF=23:00</b>
                      <b>THR=ON=09:00</b>
                      <b>FRI=OFF=01:00</b>

            In  this  example, the first power on event is Monday at 09:00.  At 23:00 the Linkstation will power
            down.  This is repeated for Tuesday and Wednesday.  On Thursday, the Linkstation will  power  on  at
            09:00  and will power off on Friday at 01:00.  The unit will then remain off for Saturday and Sunday
            and not power up again till 09:00 on Monday.  The unit is capable of sleeping for no  more  than  68
            hours  (due  to  the  resolution  of the internal timer).  Again, this time MUST be specified in UTC
            format and follow HH:MM.

            Five minutes before power off is required,  a  message  is  broadcast  to  all  console  users.   At
            shutdown, an event message is sent to the event script.  <b>See</b> <b>below</b> <b>for</b> <b>more</b> <b>details.</b>

       <u>SHUTDOWN</u>
            [HH:MM]

            This  specifies  the time that the Linkstation will be powered down.  This time MUST be specified in
            UTC and must follow the format HH:MM.  If the user alters this configuration file whilst the  daemon
            is  running, then the change will be seen and the new settings will be implemented.  If the new time
            entered is passed the current time, then the shutdown time will be for the following day.  If single
            or multiple day events are specified, then  this  becomes  the  default  power  down  time  for  any
            undefined days.

       <u>POWERON</u>
            [HH:MM]

            This  specifies  the  time  that  the  Linkstation  will be automatically powered up; as long as now
            unexpected power outage occurs.  Again, if this time is less than the <u>SHUTDOWN</u> time then it  is  for
            the  following  day.  Both the <u>TIMER</u> set to ON and the <u>SHUTDOWN</u> and the <u>POWERON</u> times are valid will
            timed shutdown/power up be enabled.  This will be reported in the message log along with any  errors
            in the configuration file.

            If  single or multiple day events are specified, then this becomes the default power on time for any
            undefined days.

       <u>DISKCHECK</u>
            [OFF | 0..100]

            If this is set to OFF or 0 (zero) then disk usage/monitoring is disabled.  Set to a value between  0
            and 100% to monitor disk usage.  If disk usage is above this specified value, then the DISK LED will
            be illuminated.  At the same time, a disk full event message will be sent to the event script.

       <u>ROOT</u> [hda1..9]

            No  default.   This  allows  the  root  partition  to be defined by the user.  No syntax checking is
            performed on this entry or validation of the partition ID.

       <u>WORK</u> [hda1..9]

            No default.  This allows the working partition to be defined by the user.  Again, no syntax checking
            is performed on this entry or validation of the partition ID.

       <u>REFRESH</u>
            [1..300]

            This defaults to 40.  This provides control over the rate (in seconds) that the  daemon  checks  the
            system  for  changes  and refreshes the AVR.  Any number between 1 and 300 can be entered.  Anything
            less than the default will result in higher impact on the system: more CPU usage.  Higher times will
            result with slower response to configuration file changes but this may not be  an  issue  with  most
            users.

       <u>HOLD</u> [1..9]

            This  defaults  to  3.  This provides control over the time (in seconds) that the user needs to hold
            either the reset of the power button in for a reset event (reset button) or power off  event  (power
            button).

       <u>DISKNAG</u>
            [ON | OFF]

            Default  if off.  This provides the user control over the disk full event.  The default is that once
            detected, just a single event is triggered.  If required, setting this to on will generate  repeated
            events, at the frequency of <b>REFRESH</b> until the disk is no longer deemed full.

       <u>FANSTOP</u>
            [OFF | 0..60]

            Default  is  30  seconds.  This  is  the  time,  from report of fan failure in which the daemon will
            generate a fan failure event call to the event script.  This allows the user to act accordingly.  At
            present, the script is setup to power down.  This can  be  changed  to  an  e-mail  event  prior  to
            shutdown if required.

            Otherwise,  if  a user has decided to remove the fan then this can be set to OFF to prevent shutdown
            from occurring.  It must be stressed that alternative cooling must be  sourced  if  this  option  is
            selected.

</pre><h4><b>BUTTON</b> <b>OPERATION</b></h4><pre>
       All events, whether mechanical button operation, or software reset/shutdown actions are routed through an
       event script located at <b>/etc/avr-evtd/EventSCript</b>

       <u>POWER</u>
            On press, a button event message is sent.  On release, another event message is sent.  If the button
            is  held  in  for  more  than <b>HOLD</b> seconds, then a shutdown event request is sent.  If the button is
            pressed twice within a period of one second, then a reset request event is sent.

            If the power button is pressed during the five minute timed shutdown warning, then the shutdown time
            is increased by five minutes.  Multiple presses will keep increasing the time by five minutes (to  a
            maximum pause of fifty minutes).  This provides the user with the ability to carry on working before
            timed  shutdown  is  finally  activated;  careful  here  as  repeated presses maybe seen as a reboot
            request.

       <u>RESET</u>
            On press, a button event message is sent.  On release, another event message is sent.  If the button
            is held in for more than twenty seconds, then a EM-Mode event request is sent.   If  the  button  is
            pressed twice within a period of one second, then a <u>special</u> event is sent which in the default state
            will launch the telnet daemon.

</pre><h4><b>MESSAGE</b> <b>EVENTS</b></h4><pre>
       The  event  system has been modified such that 99% of the daemon event system is pushed through the event
       script.  A third parameter is supplied by the daemon out to the script detailing information relevant  to
       the  generated  message.   For  example,  for  a  disk full message, the third parameter would detail the
       percentage disk space used (worst of the two monitored partitions) and when this is  cleared,  then  this
       parameter would be cleared to zero.

       <u>0</u>    User  has  requested  (by  double press of reset button) to, with the first press, launch the telnet
            daemon, or other client as specified in the <u>EventScript.</u>  The script also establishes a static IP to
            an alias Ethernet device :EM at 192.168.11.150.  If this IP is already in-use, then it will  not  be
            created.   If the Ethernet is not running, then an alternative Ethernet configuration file is loaded
            providing a static IP at 192.168.11.150.  and also a DHCP provided IP.  On the <u>THIRD</u>  double  press,
            then  a  known  set of group and user password files are copied to /etc.  Prior to the transfer, the
            relevant original files are copied to <u>.em.</u>  A file, recovery.tar, is  extracted  and  the  LEDs  are
            flashed to indicate this new mode.  A user can now gain root access using the password <u>emergency</u> and
            gain access via the telnet port 1234 to their box.

       <u>1</u>    AVR micro-controller has requested a reset.

       <u>2</u>    Shutdown request from the shutdown timer event.

       <u>3</u>    Power button has been released event.

       <u>4</u>    Power button has been pressed event.

       <u>5</u>    Reset button (rear of unit) has been released.

       <u>6</u>    Reset button has been pressed.

       <u>7</u>    User has requested (by holding power button for more than <b>HOLD</b> seconds) to shutdown the unit.

       <u>8</u>    User has requested (by double press of the power button) to reset the unit.

       <u>9</u>    Disk usage greater than DISKCHECK.  Parameter 3 set to percentage used or zero.

       <u>F</u>    Fan has been stationary for FANSTOP seconds.  Parameter 3 is set to 4 when cleared.

       <u>E</u>    EM-Mode  has  been  selected.  The EM-Mode sequence is written to the desired flash location and the
            system is issued a reboot request.  EM-Mode is an emergency boot mode that for  the  Linkstation  it
            boots  from an image in flash and rebuilds files on the disk.  <b>This</b> <b>should</b> <b>only</b> <b>be</b> <b>used</b> <b>by</b> <b>those</b> <b>who</b>
            <b>know</b> <b>what</b> <b>will</b> <b>happen</b> <b>to</b> <b>their</b> disks when this Mode is selected

       <u>S</u>    The system will shutdown in less than five minutes warning.  Parameter 3 indicates shutdown delay on
            power press.

       <u>D</u>    Error message handler.  Parameter 3 indicates error number.

</pre><h4><b>ERROR</b> <b>CODES</b></h4><pre>
       The following error messages maybe displayed in the log files during operation:

       <u>1</u>    No stock or avr-evtd configuration files were located.

       <u>2</u>    Power off time greater than that supported by the AVR.  As this is calculated at the time the  timer
            is established, this fault may clear at shutdown as timers are re-validated.

       <u>3</u>    Timer declaration error in /etc/default/avr-evtd configuration file

       <u>4</u>    Error in stock configuration file

</pre><h4><b>FILES</b></h4><pre>
       <u>/etc/default/avr-evtd</u>
       <u>/etc/avr-evtd/EventScript</u>
       <u>/etc/avr-evtd/emergency-eth0</u>
       <u>/etc/default/events.log</u>
       <u>/etc/avr-evtd/recovery.tar</u>

</pre><h4><b>AUTHORS</b></h4><pre>
       Bob  Perry &lt;<a href="mailto:lb-source@users.sourceforge.net">lb-source@users.sourceforge.net</a>&gt; (2006), with some modifications by Rog√©rio Theodoro de Brito
       &lt;<a href="mailto:rbrito@users.sourceforge.net">rbrito@users.sourceforge.net</a>&gt; (2008, 2009).

</pre><h4><b>COPYRIGHT</b></h4><pre>
       This program is free software; you can redistribute it and/or modify  it  under  the  terms  of  the  GNU
       General  Public License as published by the Free Software Foundation; either version 2 of the License, or
       (at your option) any later version.

       This program is distributed in the hope that it will be useful, but WITHOUT ANY  WARRANTY;  without  even
       the  implied  warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
       License for more details.

       You should have received a copy of the GNU General Public License along with this program; if not,  write
       to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

                                                   28 Aug 2009                                       <u><a href="../man8/AVR-EVTD.8.html">AVR-EVTD</a></u>(8)
</pre>
 </div>
</div></section>
</div>
</body>
</html>