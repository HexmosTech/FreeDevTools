<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sudo_plugin — Sudo Plugin API</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/jammy/+package/sudo-ldap">sudo-ldap_1.9.9-1ubuntu2.5_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       sudo_plugin — Sudo Plugin API

</pre><h4><b>DESCRIPTION</b></h4><pre>
       Starting  with  version  1.8,  <b>sudo</b> supports a plugin API for policy and session logging.  Plugins may be
       compiled as dynamic shared objects (the default on systems that support them) or compiled statically into
       the <b>sudo</b> binary itself.  By default, the <b>sudoers</b> plugin provides audit, security policy and  I/O  logging
       capabilities.   Via  the  plugin  API,  <b>sudo</b> can be configured to use alternate plugins provided by third
       parties.  The plugins to be used are specified in the <u><a href="../man5/sudo.conf.5.html">sudo.conf</a></u>(5) file.

       The API is versioned with a major and minor  number.   The  minor  version  number  is  incremented  when
       additions are made.  The major number is incremented when incompatible changes are made.  A plugin should
       be check the version passed to it and make sure that the major version matches.

       The plugin API is defined by the <b>sudo_plugin.h</b> header file.

   <b>Policy</b> <b>plugin</b> <b>API</b>
       A  policy  plugin  must  declare and populate a <b>policy_plugin</b> struct in the global scope.  This structure
       contains pointers to the functions that implement the <b>sudo</b> policy checks.  The name of the symbol  should
       be specified in <u><a href="../man5/sudo.conf.5.html">sudo.conf</a></u>(5) along with a path to the plugin so that <b>sudo</b> can load it.

       struct policy_plugin {
       #define SUDO_POLICY_PLUGIN     1
           unsigned int type; /* always SUDO_POLICY_PLUGIN */
           unsigned int version; /* always SUDO_API_VERSION */
           int (*open)(unsigned int version, sudo_conv_t conversation,
               sudo_printf_t plugin_printf, char * const settings[],
               char * const user_info[], char * const user_env[],
               char * const plugin_options[], const char **errstr);
           void (*close)(int exit_status, int error);
           int (*show_version)(int verbose);
           int (*check_policy)(int argc, char * const argv[],
               char *env_add[], char **command_info[],
               char **argv_out[], char **user_env_out[], const char **errstr);
           int (*list)(int argc, char * const argv[], int verbose,
               const char *list_user, const char **errstr);
           int (*validate)(const char **errstr);
           void (*invalidate)(int remove);
           int (*init_session)(struct passwd *pwd, char **user_env[],
               const char **errstr);
           void (*register_hooks)(int version,
              int (*register_hook)(struct sudo_hook *hook));
           void (*deregister_hooks)(int version,
              int (*deregister_hook)(struct sudo_hook *hook));
           struct sudo_plugin_event * (*event_alloc)(void);
       };

       The policy_plugin struct has the following fields:

       type  The <b>type</b> field should always be set to SUDO_POLICY_PLUGIN.

       version
             The <b>version</b> field should be set to SUDO_API_VERSION.

             This allows <b>sudo</b> to determine the API version the plugin was built against.

       open
             int (*open)(unsigned int version, sudo_conv_t conversation,
                 sudo_printf_t plugin_printf, char * const settings[],
                 char * const user_info[], char * const user_env[],
                 char * const plugin_options[], const char **errstr);

             Returns  1  on  success,  0  on failure, -1 if a general error occurred, or -2 if there was a usage
             error.  In the latter case, <b>sudo</b> will print a usage message before it exits.  If an  error  occurs,
             the   plugin   may   optionally   call   the   <b>conversation</b>()   or  <b>plugin_printf</b>()  function  with
             SUDO_CONF_ERROR_MSG to present additional error information to the user.

             The function arguments are as follows:

             version
                   The version passed in by <b>sudo</b> allows the plugin to determine  the  major  and  minor  version
                   number of the plugin API supported by <b>sudo</b>.

             conversation
                   A  pointer to the <b>conversation</b>() function that can be used by the plugin to interact with the
                   user (see “Conversation API” for details).  Returns 0 on success and -1 on failure.

             plugin_printf
                   A pointer to a <b>printf</b>()-style function that may be used to  display  informational  or  error
                   messages  (see  “Conversation API” for details).  Returns the number of characters printed on
                   success and -1 on failure.

             settings
                   A vector of user-supplied <b>sudo</b> settings in the form of “name=value” strings.  The  vector  is
                   terminated  by  a NULL pointer.  These settings correspond to options the user specified when
                   running <b>sudo</b>.  As such, they will only be present when  the  corresponding  option  has  been
                   specified on the command line.

                   When  parsing  <u>settings</u>, the plugin should split on the <b>first</b> equal sign (‘=’) since the <u>name</u>
                   field will never include one itself but the <u>value</u> might.

                   The following values may be set by <b>sudo</b>:

                   bsdauth_type=string
                         Authentication type, if specified by the  <b>-a</b>  option,  to  use  on  systems  where  BSD
                         authentication is supported.

                   closefrom=number
                         If  specified,  the  user  has  requested  via  the <b>-C</b> option that <b>sudo</b> close all files
                         descriptors with a value of <u>number</u> or higher.  The plugin may optionally pass this,  or
                         another value, back in the <u>command_info</u> list.

                   cmnd_chroot=string
                         The  root directory (see <u><a href="../man2/chroot.2.html">chroot</a></u>(2)) to run the command in, as specified by the user via
                         the <b>-R</b> option.  The plugin may ignore or restrict the user's ability to specify  a  new
                         root directory.  Only available starting with API version 1.16.

                   cmnd_cwd=string
                         The  working  directory  to  run  the  command  in, as specified by the user via the <b>-D</b>
                         option.  The plugin may ignore or restrict the user's ability to specify a new  working
                         directory.  Only available starting with API version 1.16.

                   debug_flags=string
                         A  debug  file  path name followed by a space and a comma-separated list of debug flags
                         that correspond to the plugin's <b>Debug</b> entry in <u><a href="../man5/sudo.conf.5.html">sudo.conf</a></u>(5),  if  there  is  one.   The
                         flags are passed to the plugin exactly as they appear in <u><a href="../man5/sudo.conf.5.html">sudo.conf</a></u>(5).  The syntax used
                         by  <b>sudo</b>  and  the  <b>sudoers</b>  plugin is <u>subsystem</u>@<u>priority</u> but a plugin is free to use a
                         different format so long as it does not include a comma (‘,’).  Prior to  <b>sudo</b>  1.8.12,
                         there  was  no  way  to specify plugin-specific <u>debug_flags</u> so the value was always the
                         same as that used by the <b>sudo</b> front-end and did not include a path name, only the flags
                         themselves.  As of version 1.7 of the plugin interface, <b>sudo</b> will only pass <u>debug_flags</u>
                         if <u><a href="../man5/sudo.conf.5.html">sudo.conf</a></u>(5) contains a plugin-specific <b>Debug</b> entry.

                   ignore_ticket=bool
                         Set to true if the user specified the <b>-k</b> option along with a command,  indicating  that
                         the  user  wishes  to  ignore  any cached authentication credentials.  <u>implied_shell</u> to
                         true.  This allows <b>sudo</b> with no arguments to be used similarly to <u><a href="../man1/su.1.html">su</a></u>(1).  If the plugin
                         does not to support this usage, it may return a value of  -2  from  the  <b>check_policy</b>()
                         function, which will cause <b>sudo</b> to print a usage message and exit.

                   implied_shell=bool
                         If  the  user does not specify a program on the command line, <b>sudo</b> will pass the plugin
                         the path to the user's shell and set

                   login_class=string
                         BSD login class to use when setting resource limits and nice value, if specified by the
                         <b>-c</b> option.

                   login_shell=bool
                         Set to true if the user specified the <b>-i</b> option, indicating that the user wishes to run
                         a login shell.

                   max_groups=int
                         The maximum number of groups a user may belong to.  This will only be present if  there
                         is a corresponding setting in <u><a href="../man5/sudo.conf.5.html">sudo.conf</a></u>(5).

                   network_addrs=list
                         A space-separated list of IP network addresses and netmasks in the form “addr/netmask”,
                         e.g., “192.168.1.2/255.255.255.0”.  The address and netmask pairs may be either IPv4 or
                         IPv6, depending on what the operating system supports.  If the address contains a colon
                         (‘:’), it is an IPv6 address, else it is IPv4.

                   noninteractive=bool
                         Set to true if the user specified the <b>-n</b> option, indicating that <b>sudo</b> should operate in
                         non-interactive  mode.   The plugin may reject a command run in non-interactive mode if
                         user interaction is required.

                   plugin_dir=string
                         The default plugin directory used by the <b>sudo</b> front-end.  This is the default directory
                         set at compile time and may not correspond to the  directory  the  running  plugin  was
                         loaded from.  It may be used by a plugin to locate support files.

                   plugin_path=string
                         The  path  name of plugin loaded by the <b>sudo</b> front-end.  The path name will be a fully-
                         qualified unless the plugin was statically compiled into <b>sudo</b>.

                   preserve_environment=bool
                         Set to true if the user specified the <b>-E</b> option, indicating that  the  user  wishes  to
                         preserve the environment.

                   preserve_groups=bool
                         Set  to  true  if  the user specified the <b>-P</b> option, indicating that the user wishes to
                         preserve the group vector instead of setting it based on the runas user.

                   progname=string
                         The command name that sudo was run as, typically “sudo” or “sudoedit”.

                   prompt=string
                         The prompt to use when requesting a password, if specified via the <b>-p</b> option.

                   remote_host=string
                         The name of the remote host to run the command on, if  specified  via  the  <b>-h</b>  option.
                         Support  for  running  the  command  on  a remote host is meant to be implemented via a
                         helper program that is executed in place  of  the  user-specified  command.   The  <b>sudo</b>
                         front-end  is  only  capable  of  executing commands on the local host.  Only available
                         starting with API version 1.4.

                   run_shell=bool
                         Set to true if the user specified the <b>-s</b> option, indicating that the user wishes to run
                         a shell.

                   runas_group=string
                         The group name or group-ID to run the command as, if specified via the <b>-g</b> option.

                   runas_user=string
                         The user name or user-ID to run the command as, if specified via the <b>-u</b> option.

                   selinux_role=string
                         SELinux role to use when executing the command, if specified by the <b>-r</b> option.

                   selinux_type=string
                         SELinux type to use when executing the command, if specified by the <b>-t</b> option.

                   set_home=bool
                         Set to true if the user specified the <b>-H</b> option.  If true,  set  the  <b>HOME</b>  environment
                         variable to the target user's home directory.

                   sudoedit=bool
                         Set  to  true  when  the  <b>-e</b> option is specified or if invoked as <b>sudoedit</b>.  The plugin
                         shall substitute an editor into <u>argv</u> in the <b>check_policy</b>() function or return -2 with a
                         usage error if the plugin does not support <u>sudoedit</u>.  For  more  information,  see  the
                         <u>check_policy</u> section.

                   timeout=string
                         Command  timeout  specified  by  the  user  via the <b>-T</b> option.  Not all plugins support
                         command timeouts and the ability of the user to set a  timeout  may  be  restricted  by
                         policy.  The format of the timeout string is plugin-specific.

                   Additional  settings may be added in the future so the plugin should silently ignore settings
                   that it does not recognize.

             user_info
                   A vector of information about the user running  the  command  in  the  form  of  “name=value”
                   strings.  The vector is terminated by a NULL pointer.

                   When  parsing <u>user_info</u>, the plugin should split on the <b>first</b> equal sign (‘=’) since the <u>name</u>
                   field will never include one itself but the <u>value</u> might.

                   The following values may be set by <b>sudo</b>:

                   cols=int
                         The number of columns the user's terminal supports.  If there  is  no  terminal  device
                         available, a default value of 80 is used.

                   cwd=string
                         The user's current working directory.

                   egid=gid_t
                         The effective group-ID of the user invoking <b>sudo</b>.

                   euid=uid_t
                         The effective user-ID of the user invoking <b>sudo</b>.

                   gid=gid_t
                         The real group-ID of the user invoking <b>sudo</b>.

                   groups=list
                         The user's supplementary group list formatted as a string of comma-separated group-IDs.

                   host=string
                         The local machine's hostname as returned by the <u><a href="../man2/gethostname.2.html">gethostname</a></u>(2) system call.

                   lines=int
                         The  number  of  lines  the  user's  terminal supports.  If there is no terminal device
                         available, a default value of 24 is used.

                   pgid=int
                         The ID of the process group that the  running  <b>sudo</b>  process  is  a  member  of.   Only
                         available starting with API version 1.2.

                   pid=int
                         The  process  ID of the running <b>sudo</b> process.  Only available starting with API version
                         1.2.

                   ppid=int
                         The parent process ID of the running <b>sudo</b> process.  Only available  starting  with  API
                         version 1.2.

                   rlimit_as=soft,hard
                         The maximum size to which the process's address space may grow (in bytes), if supported
                         by  the  operating system.  The soft and hard limits are separated by a comma.  A value
                         of “infinity” indicates that there is no  limit.   Only  available  starting  with  API
                         version 1.16.

                   rlimit_core=soft,hard
                         The  largest  size  core  dump  file that may be created (in bytes).  The soft and hard
                         limits are separated by a comma.  A value of “infinity”  indicates  that  there  is  no
                         limit.  Only available starting with API version 1.16.

                   rlimit_cpu=soft,hard
                         The  maximum  amount  of  CPU time that the process may use (in seconds).  The soft and
                         hard limits are separated by a comma.  A value of “infinity” indicates that there is no
                         limit.  Only available starting with API version 1.16.

                   rlimit_data=soft,hard
                         The maximum size of the data segment for the process (in bytes).   The  soft  and  hard
                         limits  are  separated  by  a  comma.  A value of “infinity” indicates that there is no
                         limit.  Only available starting with API version 1.16.

                   rlimit_fsize=soft,hard
                         The largest size file that the process may create (in bytes).  The soft and hard limits
                         are separated by a comma.  A value of “infinity” indicates  that  there  is  no  limit.
                         Only available starting with API version 1.16.

                   rlimit_locks=soft,hard
                         The  maximum  number  of  locks  that  the  process  may establish, if supported by the
                         operating system.  The soft and hard limits are separated  by  a  comma.   A  value  of
                         “infinity”  indicates that there is no limit.  Only available starting with API version
                         1.16.

                   rlimit_memlock=soft,hard
                         The maximum size that the process may lock in memory (in bytes), if  supported  by  the
                         operating  system.   The  soft  and  hard  limits are separated by a comma.  A value of
                         “infinity” indicates that there is no limit.  Only available starting with API  version
                         1.16.

                   rlimit_nofile=soft,hard
                         The  maximum  number of files that the process may have open.  The soft and hard limits
                         are separated by a comma.  A value of “infinity” indicates  that  there  is  no  limit.
                         Only available starting with API version 1.16.

                   rlimit_nproc=soft,hard
                         The  maximum  number  of  processes that the user may run simultaneously.  The soft and
                         hard limits are separated by a comma.  A value of “infinity” indicates that there is no
                         limit.  Only available starting with API version 1.16.

                   rlimit_rss=soft,hard
                         The maximum size to which the process's resident set size may  grow  (in  bytes).   The
                         soft  and  hard  limits are separated by a comma.  A value of “infinity” indicates that
                         there is no limit.  Only available starting with API version 1.16.

                   rlimit_stack=soft,hard
                         The maximum size to which the process's stack may grow (in bytes).  The soft  and  hard
                         limits  are  separated  by  a  comma.  A value of “infinity” indicates that there is no
                         limit.  Only available starting with API version 1.16.

                   sid=int
                         The session ID of the running <b>sudo</b> process or 0 if <b>sudo</b> is not  part  of  a  POSIX  job
                         control session.  Only available starting with API version 1.2.

                   tcpgid=int
                         The  ID  of the foreground process group associated with the terminal device associated
                         with the <b>sudo</b> process or 0 if there is no terminal present.   Only  available  starting
                         with API version 1.2.

                   tty=string
                         The  path to the user's terminal device.  If the user has no terminal device associated
                         with the session, the value will be empty, as in “<b>tty=</b>”.

                   uid=uid_t
                         The real user-ID of the user invoking <b>sudo</b>.

                   umask=octal
                         The invoking user's file creation mask.  Only available starting with API version 1.10.

                   user=string
                         The name of the user invoking <b>sudo</b>.

             user_env
                   The user's environment in the form of a NULL-terminated vector of “name=value” strings.

                   When parsing <u>user_env</u>, the plugin should split on the <b>first</b> equal sign (‘=’) since  the  <u>name</u>
                   field will never include one itself but the <u>value</u> might.

             plugin_options
                   Any  (non-comment)  strings  immediately after the plugin path are passed as arguments to the
                   plugin.  These arguments are split on a white space boundary and are passed to the plugin  in
                   the   form  of  a  NULL-terminated  array  of  strings.   If  no  arguments  were  specified,
                   <u>plugin_options</u> will be the NULL pointer.

                   NOTE: the <u>plugin_options</u> parameter is only available starting with API version 1.2.  A plugin
                   <b>must</b> check the API version specified by  the  <b>sudo</b>  front-end  before  using  <u>plugin_options</u>.
                   Failure to do so may result in a crash.

             errstr
                   If  the  <b>open</b>()  function  returns  a  value  other  than  1,  the plugin may store a message
                   describing the failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this  value  to
                   any  registered  audit  plugins.   The  string  stored  in <u>errstr</u> must remain valid until the
                   plugin's <b>close</b>() function is called.

                   NOTE: the <u>errstr</u> parameter is only available starting with API version 1.15.  A  plugin  <b>must</b>
                   check  the API version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do so
                   may result in a crash.

       close
             void (*close)(int exit_status, int error);

             The <b>close</b>() function is called when <b>sudo</b> is finished, shortly before it exits.  Starting  with  API
             version 1.15, <b>close</b>() is called regardless of whether or not a command was actually executed.  This
             makes  it  possible  for  plugins  to  perform  cleanup even when a command was not run.  It is not
             possible to tell whether a command was run based solely on the  arguments  passed  to  the  <b>close</b>()
             function.  To determine if a command was actually run, the plugin must keep track of whether or not
             the <b>check_policy</b>() function returned successfully.

             The function arguments are as follows:

             exit_status
                   The  command's exit status, as returned by the <u><a href="../man2/wait.2.html">wait</a></u>(2) system call, or zero if no command was
                   run.  The value of <b>exit_status</b> is undefined if <b>error</b> is non-zero.

             error
                   If the command could not be executed, this is set to the value of <b>errno</b> set by the  <u><a href="../man2/execve.2.html">execve</a></u>(2)
                   system   call.    The  plugin  is  responsible  for  displaying  error  information  via  the
                   <b>conversation</b>() or <b>plugin_printf</b>() function.  If the command was  successfully  executed,  the
                   value of <b>error</b> is zero.

             If  no  <b>close</b>() function is defined, no I/O logging plugins are loaded, and neither the <u>timeout</u> not
             <u>use_pty</u> options are set in the <b>command_info</b> list,  the  <b>sudo</b>  front-end  may  execute  the  command
             directly instead of running it as a child process.

       show_version
             int (*show_version)(int verbose);

             The  <b>show_version</b>()  function  is called by <b>sudo</b> when the user specifies the <b>-V</b> option.  The plugin
             may display its version information to the user via the <b>conversation</b>() or <b>plugin_printf</b>()  function
             using SUDO_CONV_INFO_MSG.  If the user requests detailed version information, the verbose flag will
             be set.

             Returns  1  on  success,  0  on failure, -1 if a general error occurred, or -2 if there was a usage
             error, although the return value is currently ignored.

       check_policy
             int (*check_policy)(int argc, char * const argv[], char *env_add[],
                 char **command_info[], char **argv_out[], char **user_env_out[],
                 const char **errstr);

             The <b>check_policy</b>() function is called by <b>sudo</b> to determine whether the user is allowed to  run  the
             specified commands.

             If  the  <u>sudoedit</u>  option was enabled in the <u>settings</u> array passed to the <b>open</b>() function, the user
             has requested <u>sudoedit</u> mode.  <u>sudoedit</u> is a mechanism for editing one or more files where an editor
             is run with the user's credentials instead of with elevated  privileges.   <b>sudo</b>  achieves  this  by
             creating  user-writable  temporary  copies  of  the  files  to  be  edited and then overwriting the
             originals with the temporary copies after editing is complete.  If the plugin supports <u>sudoedit</u>, it
             should choose the editor to be used, potentially from a variable in the user's environment, such as
             <b>EDITOR</b>, and include it in <u>argv_out</u> (note  that  environment  variables  may  include  command  line
             options).   The  files  to  be  edited should be copied from <u>argv</u> into <u>argv_out</u>, separated from the
             editor and its arguments by a “<b>--</b>” element.  The “<b>--</b>” will be removed by <b>sudo</b> before the editor  is
             executed.  The plugin should also set <u>sudoedit=true</u> in the <u>command_info</u> list.

             The <b>check_policy</b>() function returns 1 if the command is allowed, 0 if not allowed, -1 for a general
             error,  or  -2 for a usage error or if <u>sudoedit</u> was specified but is unsupported by the plugin.  In
             the latter case, <b>sudo</b> will print a usage message before it exits.  If an error occurs,  the  plugin
             may  optionally  call  the  <b>conversation</b>()  or <b>plugin_printf</b>() function with SUDO_CONF_ERROR_MSG to
             present additional error information to the user.

             The function arguments are as follows:

             argc  The number of elements in <u>argv</u>, not counting the final NULL pointer.

             argv  The argument vector describing the command the user wishes to run, in the same form  as  what
                   would be passed to the <u><a href="../man2/execve.2.html">execve</a></u>(2) system call.  The vector is terminated by a NULL pointer.

             env_add
                   Additional  environment  variables specified by the user on the command line in the form of a
                   NULL-terminated vector of “name=value” strings.  The plugin may reject the command if one  or
                   more variables are not allowed to be set, or it may silently ignore such variables.

                   When  parsing  <u>env_add</u>,  the plugin should split on the <b>first</b> equal sign (‘=’) since the <u>name</u>
                   field will never include one itself but the <u>value</u> might.

             command_info
                   Information about the command being run in the form of “name=value”  strings.   These  values
                   are  used  by  <b>sudo</b>  to  set the execution environment when running a command.  The plugin is
                   responsible for creating and populating the vector, which must  be  terminated  with  a  NULL
                   pointer.  The following values are recognized by <b>sudo</b>:

                   chroot=string
                         The root directory to use when running the command.

                   closefrom=number
                         If specified, <b>sudo</b> will close all files descriptors with a value of <u>number</u> or higher.

                   command=string
                         Fully qualified path to the command to be executed.

                   cwd=string
                         The  current  working  directory  to  change to when executing the command.  If <b>sudo</b> is
                         unable to change to the new working directory, the  command  will  not  be  run  unless
                         <u>cwd_optional</u> is also set (see below).

                   cwd_optional=bool
                         If  enabled,  <b>sudo</b>  will treat an inability to change to the new working directory as a
                         non-fatal error.  This setting has no effect unless <u>cwd</u> is also set.

                   exec_background=bool
                         By default, <b>sudo</b> runs a command as the foreground process as long  as  <b>sudo</b>  itself  is
                         running  in  the  foreground.  When <u>exec_background</u> is enabled and the command is being
                         run in a pseudo-terminal (due to I/O logging or the <u>use_pty</u> setting), the command  will
                         be  run as a background process.  Attempts to read from the controlling terminal (or to
                         change terminal settings) will result in the command being suspended with  the  SIGTTIN
                         signal  (or  SIGTTOU in the case of terminal settings).  If this happens when <b>sudo</b> is a
                         foreground process, the command will be granted the controlling terminal and resumed in
                         the foreground with no user intervention required.  The advantage of initially  running
                         the  command  in the background is that <b>sudo</b> need not read from the terminal unless the
                         command explicitly requests it.  Otherwise, any terminal input must be  passed  to  the
                         command,  whether  it has required it or not (the kernel buffers terminals so it is not
                         possible to tell whether the command really wants the input).  This is  different  from
                         historic <u>sudo</u> behavior or when the command is not being run in a pseudo-terminal.

                         For this to work seamlessly, the operating system must support the automatic restarting
                         of system calls.  Unfortunately, not all operating systems do this by default, and even
                         those  that  do may have bugs.  For example, macOS fails to restart the <b>tcgetattr</b>() and
                         <b>tcsetattr</b>() system calls (this is a bug in macOS).  Furthermore, because this  behavior
                         depends  on  the  command  stopping  with the SIGTTIN or SIGTTOU signals, programs that
                         catch these signals and suspend themselves with a  different  signal  (usually  SIGTOP)
                         will  not  be  automatically  foregrounded.   Some  versions of the linux <u><a href="../man1/su.1.html">su</a></u>(1) command
                         behave this way.  Because of this, a plugin should not set <u>exec_background</u> unless it is
                         explicitly enabled by the administrator and there should be a way to enabled or disable
                         it on a per-command basis.

                         This setting has no effect unless I/O logging is enabled or <u>use_pty</u> is enabled.

                   execfd=number
                         If specified, <b>sudo</b> will use the <u><a href="../man2/fexecve.2.html">fexecve</a></u>(2) system call to execute the  command  instead
                         of <u><a href="../man2/execve.2.html">execve</a></u>(2).  The specified <u>number</u> must refer to an open file descriptor.

                   iolog_compress=bool
                         Set  to true if the I/O logging plugins, if any, should compress the log data.  This is
                         a hint to the I/O logging plugin which may choose to ignore it.

                   iolog_group=string
                         The group that will own newly created I/O log files and directories.  This is a hint to
                         the I/O logging plugin which may choose to ignore it.

                   iolog_mode=octal
                         The file permission mode to use when creating I/O log files and directories.  This is a
                         hint to the I/O logging plugin which may choose to ignore it.

                   iolog_user=string
                         The user that will own newly created I/O log files and directories.  This is a hint  to
                         the I/O logging plugin which may choose to ignore it.

                   iolog_path=string
                         Fully  qualified  path to the file or directory in which I/O log is to be stored.  This
                         is a hint to the I/O logging plugin which may choose to ignore it.  If no  I/O  logging
                         plugin is loaded, this setting has no effect.

                   iolog_stdin=bool
                         Set  to true if the I/O logging plugins, if any, should log the standard input if it is
                         not connected to a terminal device.  This is a hint to the I/O logging plugin which may
                         choose to ignore it.

                   iolog_stdout=bool
                         Set to true if the I/O logging plugins, if any, should log the standard output if it is
                         not connected to a terminal device.  This is a hint to the I/O logging plugin which may
                         choose to ignore it.

                   iolog_stderr=bool
                         Set to true if the I/O logging plugins, if any, should log the standard error if it  is
                         not connected to a terminal device.  This is a hint to the I/O logging plugin which may
                         choose to ignore it.

                   iolog_ttyin=bool
                         Set  to  true  if the I/O logging plugins, if any, should log all terminal input.  This
                         only includes input typed by the user and not from a pipe or redirected  from  a  file.
                         This is a hint to the I/O logging plugin which may choose to ignore it.

                   iolog_ttyout=bool
                         Set  to  true if the I/O logging plugins, if any, should log all terminal output.  This
                         only includes output to the screen, not output to a pipe or file.  This is  a  hint  to
                         the I/O logging plugin which may choose to ignore it.

                   login_class=string
                         BSD  login  class  to use when setting resource limits and nice value (optional).  This
                         option is only set on systems that support login classes.

                   nice=int
                         Nice value (priority) to use when executing the command.  The nice value, if specified,
                         overrides the priority associated with the <u>login_class</u> on BSD systems.

                   noexec=bool
                         If set, prevent the command from executing other programs.

                   preserve_fds=list
                         A comma-separated list of file descriptors that should be preserved, regardless of  the
                         value of the <u>closefrom</u> setting.  Only available starting with API version 1.5.

                   preserve_groups=bool
                         If  set,  <b>sudo</b>  will preserve the user's group vector instead of initializing the group
                         vector based on <b>runas_user</b>.

                   rlimit_as=soft,hard
                         The maximum size to which the process's address space may grow (in bytes), if supported
                         by the operating system.  The soft and hard limits are separated by a comma.  If only a
                         single value is specified, both  the  hard  and  soft  limits  are  set.   A  value  of
                         “infinity” indicates that there is no limit.  A value of “user” will cause the invoking
                         user's  resource  limit  to  be  preserved.  A value of “default” will cause the target
                         user's default resource limit to be used on systems that allow per-user resource limits
                         to be configured.  Only available starting with API version 1.17.

                   rlimit_core=soft,hard
                         The largest size core dump file that may be created (in  bytes).   The  soft  and  hard
                         limits  are  separated  by a comma.  If only a single value is specified, both the hard
                         and soft limits are set.  A value of “infinity” indicates that there is  no  limit.   A
                         value of “user” will cause the invoking user's resource limit to be preserved.  A value
                         of  “default” will cause the target user's default resource limit to be used on systems
                         that allow per-user resource limits to be configured.  Only available starting with API
                         version 1.17.

                   rlimit_cpu=soft,hard
                         The maximum amount of CPU time that the process may use (in  seconds).   The  soft  and
                         hard  limits  are  separated by a comma.  If only a single value is specified, both the
                         hard and soft limits are set.  A value of “infinity” indicates that there is no  limit.
                         A  value  of  “user”  will cause the invoking user's resource limit to be preserved.  A
                         value of “default” will cause the target user's default resource limit to  be  used  on
                         systems  that allow per-user resource limits to be configured.  Only available starting
                         with API version 1.17.

                   rlimit_data=soft,hard
                         The maximum size of the data segment for the process (in bytes).   The  soft  and  hard
                         limits  are  separated  by a comma.  If only a single value is specified, both the hard
                         and soft limits are set.  A value of “infinity” indicates that there is  no  limit.   A
                         value of “user” will cause the invoking user's resource limit to be preserved.  A value
                         of  “default” will cause the target user's default resource limit to be used on systems
                         that allow per-user resource limits to be configured.  Only available starting with API
                         version 1.17.

                   rlimit_fsize=soft,hard
                         The largest size file that the process may create (in bytes).  The soft and hard limits
                         are separated by a comma.  If only a single value is specified, both the hard and  soft
                         limits  are  set.   A value of “infinity” indicates that there is no limit.  A value of
                         “user” will cause the invoking user's resource limit  to  be  preserved.   A  value  of
                         “default”  will  cause  the  target user's default resource limit to be used on systems
                         that allow per-user resource limits to be configured.  Only available starting with API
                         version 1.17.

                   rlimit_locks=soft,hard
                         The maximum number of locks that  the  process  may  establish,  if  supported  by  the
                         operating system.  The soft and hard limits are separated by a comma.  If only a single
                         value  is  specified,  both  the  hard  and soft limits are set.  A value of “infinity”
                         indicates that there is no limit.  A value of “user” will  cause  the  invoking  user's
                         resource  limit  to  be  preserved.   A value of “default” will cause the target user's
                         default resource limit to be used on systems that allow per-user resource limits to  be
                         configured.  Only available starting with API version 1.17.

                   rlimit_memlock=soft,hard
                         The  maximum  size  that the process may lock in memory (in bytes), if supported by the
                         operating system.  The soft and hard limits are separated by a comma.  If only a single
                         value is specified, both the hard and soft limits  are  set.   A  value  of  “infinity”
                         indicates  that  there  is  no limit.  A value of “user” will cause the invoking user's
                         resource limit to be preserved.  A value of “default”  will  cause  the  target  user's
                         default  resource limit to be used on systems that allow per-user resource limits to be
                         configured.  Only available starting with API version 1.17.

                   rlimit_nofile=soft,hard
                         The maximum number of files that the process may have open.  The soft and  hard  limits
                         are  separated by a comma.  If only a single value is specified, both the hard and soft
                         limits are set.  A value of “infinity” indicates that there is no limit.   A  value  of
                         “user”  will  cause  the  invoking  user's  resource limit to be preserved.  A value of
                         “default” will cause the target user's default resource limit to  be  used  on  systems
                         that allow per-user resource limits to be configured.  Only available starting with API
                         version 1.17.

                   rlimit_nproc=soft,hard
                         The  maximum  number  of  processes that the user may run simultaneously.  The soft and
                         hard limits are separated by a comma.  If only a single value is  specified,  both  the
                         hard  and soft limits are set.  A value of “infinity” indicates that there is no limit.
                         A value of “user” will cause the invoking user's resource limit  to  be  preserved.   A
                         value  of  “default”  will cause the target user's default resource limit to be used on
                         systems that allow per-user resource limits to be configured.  Only available  starting
                         with API version 1.17.

                   rlimit_rss=soft,hard
                         The  maximum  size  to  which the process's resident set size may grow (in bytes).  The
                         soft and hard limits are separated by a comma.  If only a single  value  is  specified,
                         both  the  hard and soft limits are set.  A value of “infinity” indicates that there is
                         no limit.  A value of “user” will cause  the  invoking  user's  resource  limit  to  be
                         preserved.  A value of “default” will cause the target user's default resource limit to
                         be  used  on  systems  that  allow  per-user  resource  limits  to be configured.  Only
                         available starting with API version 1.17.

                   rlimit_stack=soft,hard
                         The maximum size to which the process's stack may grow (in bytes).  The soft  and  hard
                         limits  are  separated  by a comma.  If only a single value is specified, both the hard
                         and soft limits are set.  A value of “infinity” indicates that there is  no  limit.   A
                         value of “user” will cause the invoking user's resource limit to be preserved.  A value
                         of  “default” will cause the target user's default resource limit to be used on systems
                         that allow per-user resource limits to be configured.  Only available starting with API
                         version 1.17.

                   runas_egid=gid
                         Effective group-ID to run the command as.  If not specified, the value of <u>runas_gid</u>  is
                         used.

                   runas_euid=uid
                         Effective  user-ID  to run the command as.  If not specified, the value of <u>runas_uid</u> is
                         used.

                   runas_gid=gid
                         Group-ID to run the command as.

                   runas_group=string
                         The name of the group the command will run as, if it is different from the <u>runas_user</u>'s
                         default group.  This value is provided for auditing purposes only, the  <b>sudo</b>  front-end
                         uses <u>runas_egid</u> and <u>runas_gid</u> when executing the command.

                   runas_groups=list
                         The  supplementary group vector to use for the command in the form of a comma-separated
                         list of group-IDs.  If <u>preserve_groups</u> is set, this option is ignored.

                   runas_uid=uid
                         User-ID to run the command as.

                   runas_user=string
                         The name of the user the command will run as, which should correspond to <u>runas_euid</u> (or
                         <u>runas_uid</u> if <u>runas_euid</u> is not set).  This value  is  provided  for  auditing  purposes
                         only, the <b>sudo</b> front-end uses <u>runas_euid</u> and <u>runas_uid</u> when executing the command.

                   selinux_role=string
                         SELinux role to use when executing the command.

                   selinux_type=string
                         SELinux type to use when executing the command.

                   set_utmp=bool
                         Create  a  utmp  (or utmpx) entry when a pseudo-terminal is allocated.  By default, the
                         new entry will be a copy of the user's existing utmp entry  (if  any),  with  the  tty,
                         time, type, and pid fields updated.

                   sudoedit=bool
                         Set  to  true  when in <u>sudoedit</u> mode.  The plugin may enable <u>sudoedit</u> mode even if <b>sudo</b>
                         was not invoked as <b>sudoedit</b>.  This allows the plugin to  perform  command  substitution
                         and transparently enable <u>sudoedit</u> when the user attempts to run an editor.

                   sudoedit_checkdir=bool
                         Set to false to disable directory writability checks in <b>sudoedit</b>.  By default, <b>sudoedit</b>
                         1.8.16  and  higher  will  check  all directory components of the path to be edited for
                         writability by the invoking user.  Symbolic links will  not  be  followed  in  writable
                         directories  and  <b>sudoedit</b>  will refuse to edit a file located in a writable directory.
                         These restrictions are not enforced when <b>sudoedit</b> is run by root.  The  <u>sudoedit_follow</u>
                         option  can  be  set  to false to disable this check.  Only available starting with API
                         version 1.8.

                   sudoedit_follow=bool
                         Set to true to allow <b>sudoedit</b> to edit files  that  are  symbolic  links.   By  default,
                         <b>sudoedit</b>  1.8.15  and  higher will refuse to open a symbolic link.  The <u>sudoedit_follow</u>
                         option can be used to restore the older behavior and allow <b>sudoedit</b>  to  open  symbolic
                         links.  Only available starting with API version 1.8.

                   timeout=int
                         Command timeout.  If non-zero then when the timeout expires the command will be killed.

                   umask=octal
                         The file creation mask to use when executing the command.  This value may be overridden
                         by PAM or login.conf on some systems unless the <u>umask_override</u> option is also set.

                   umask_override=bool
                         Force  the  value  specified  by  the  <u>umask</u> option to override any umask set by PAM or
                         login.conf.

                   use_pty=bool
                         Allocate a pseudo-terminal to run the command in, regardless  of  whether  or  not  I/O
                         logging  is  in  use.   By default, <b>sudo</b> will only run the command in a pseudo-terminal
                         when an I/O log plugin is loaded.

                   utmp_user=string
                         User name to use when constructing a  new  utmp  (or  utmpx)  entry  when  <u>set_utmp</u>  is
                         enabled.   This  option can be used to set the user field in the utmp entry to the user
                         the command runs as rather than the invoking user.  If not set, <b>sudo</b> will base the  new
                         entry on the invoking user's existing entry.

                   Unsupported values will be ignored.

             argv_out
                   The  NULL-terminated  argument vector to pass to the <u><a href="../man2/execve.2.html">execve</a></u>(2) system call when executing the
                   command.  The plugin is responsible for allocating and populating the vector.

             user_env_out
                   The NULL-terminated environment vector to use when executing  the  command.   The  plugin  is
                   responsible for allocating and populating the vector.

             errstr
                   If  the  <b>check_policy</b>() function returns a value other than 1, the plugin may store a message
                   describing the failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this  value  to
                   any  registered  audit  plugins.   The  string  stored  in <u>errstr</u> must remain valid until the
                   plugin's <b>close</b>() function is called.

                   NOTE: the <u>errstr</u> parameter is only available starting with API version 1.15.  A  plugin  <b>must</b>
                   check  the API version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do so
                   may result in a crash.

       list
             int (*list)(int argc, char * const argv[], int verbose,
                 const char *list_user, const char **errstr);

             List available privileges for the invoking user.  Returns 1 on success, 0 on  failure,  and  -1  on
             error.   On  error,  the  plugin may optionally call the <b>conversation</b>() or <b>plugin_printf</b>() function
             with SUDO_CONF_ERROR_MSG to present additional error information to the user.

             Privileges  should  be  output  via  the   <b>conversation</b>()   or   <b>plugin_printf</b>()   function   using
             SUDO_CONV_INFO_MSG.

             The function arguments are as follows:

             argc  The number of elements in <u>argv</u>, not counting the final NULL pointer.

             argv  If  non-NULL,  an  argument  vector describing a command the user wishes to check against the
                   policy in the same form as what would be passed to the <u><a href="../man2/execve.2.html">execve</a></u>(2) system call.  If the command
                   is permitted by the policy, the fully-qualified path to the command should be displayed along
                   with any command line arguments.

             verbose
                   Flag indicating whether to list in verbose mode or not.

             list_user
                   The name of a different user to list privileges for if the policy allows it.   If  NULL,  the
                   plugin should list the privileges of the invoking user.

             errstr
                   If  the  <b>list</b>()  function  returns  a  value  other  than  1,  the plugin may store a message
                   describing the failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this  value  to
                   any  registered  audit  plugins.   The  string  stored  in <u>errstr</u> must remain valid until the
                   plugin's <b>close</b>() function is called.

                   NOTE: the <u>errstr</u> parameter is only available starting with API version 1.15.  A  plugin  <b>must</b>
                   check  the API version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do so
                   may result in a crash.

       validate
             int (*validate)(const char **errstr);

             The <b>validate</b>() function is called when <b>sudo</b> is run with the <b>-v</b> option.  For policy plugins such  as
             <b>sudoers</b>  that  cache  authentication  credentials,  this  function  will  validate  and  cache  the
             credentials.

             The <b>validate</b>() function should be NULL if the plugin does not support credential caching.

             Returns 1 on success, 0 on failure, and -1 on error.  On error, the plugin may optionally call  the
             <b>conversation</b>()  or  <b>plugin_printf</b>()  function  with SUDO_CONF_ERROR_MSG to present additional error
             information to the user.

             The function arguments are as follows:

             errstr
                   If the <b>validate</b>() function returns a value other than 1,  the  plugin  may  store  a  message
                   describing  the  failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this value to
                   any registered audit plugins.  The string stored  in  <u>errstr</u>  must  remain  valid  until  the
                   plugin's <b>close</b>() function is called.

                   NOTE:  the  <u>errstr</u> parameter is only available starting with API version 1.15.  A plugin <b>must</b>
                   check the API version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do  so
                   may result in a crash.

       invalidate
             void (*invalidate)(int remove);

             The  <b>invalidate</b>() function is called when <b>sudo</b> is run with the <b>-k</b> or <b>-K</b> option.  For policy plugins
             such  as  <b>sudoers</b>  that  cache  authentication  credentials,  this  function  will  invalidate  the
             credentials.   If  the  <u>remove</u> flag is set, the plugin may remove the credentials instead of simply
             invalidating them.

             The <b>invalidate</b>() function should be NULL if the plugin does not support credential caching.

       init_session
             int (*init_session)(struct passwd *pwd, char **user_env_out[]);

             The <b>init_session</b>() function is called before  <b>sudo</b>  sets  up  the  execution  environment  for  the
             command.   It  is  run in the parent <b>sudo</b> process and before any user-ID or group-ID changes.  This
             can be used to perform session setup that is not supported by <u>command_info</u>, such as opening the PAM
             session.  The <b>close</b>()  function  can  be  used  to  tear  down  the  session  that  was  opened  by
             <b>init_session</b>.

             The  <u>pwd</u>  argument points to a passwd struct for the user the command will be run as if the user-ID
             the command will run as was found in the password database, otherwise it will be NULL.

             The <u>user_env_out</u> argument points to the environment the command will run  in,  in  the  form  of  a
             NULL-terminated  vector of “name=value” strings.  This is the same string passed back to the front-
             end via the Policy Plugin's <u>user_env_out</u> parameter.  If the <b>init_session</b>() function needs to modify
             the user environment, it should update the pointer stored in <u>user_env_out</u>.  The expected  use  case
             is  to merge the contents of the PAM environment (if any) with the contents of <u>user_env_out</u>.  NOTE:
             the <u>user_env_out</u> parameter is only available starting with API version 1.2.  A  plugin  <b>must</b>  check
             the  API  version  specified by the <b>sudo</b> front-end before using <u>user_env_out</u>.  Failure to do so may
             result in a crash.

             Returns 1 on success, 0 on failure, and -1 on error.  On error, the plugin may optionally call  the
             <b>conversation</b>()  or  <b>plugin_printf</b>()  function  with SUDO_CONF_ERROR_MSG to present additional error
             information to the user.

       register_hooks
             void (*register_hooks)(int version,
                int (*register_hook)(struct sudo_hook *hook));

             The <b>register_hooks</b>() function is called by the sudo front-end to  register  any  hooks  the  plugin
             needs.  If the plugin does not support hooks, <b>register_hooks</b> should be set to the NULL pointer.

             The <u>version</u> argument describes the version of the hooks API supported by the <b>sudo</b> front-end.

             The  <b>register_hook</b>()  function should be used to register any supported hooks the plugin needs.  It
             returns 0 on success, 1 if the hook type is not supported, and -1 if the major  version  in  <b>struct</b>
             <b>hook</b> does not match the front-end's major hook API version.

             See the “Hook function API” section below for more information about hooks.

             NOTE:  the  <b>register_hooks</b>() function is only available starting with API version 1.2.  If the <b>sudo</b>
             front-end doesn't support API version 1.2 or higher, <b>register_hooks</b> will not be called.

       deregister_hooks
             void (*deregister_hooks)(int version,
                int (*deregister_hook)(struct sudo_hook *hook));

             The <b>deregister_hooks</b>() function is called by the sudo front-end to deregister any hooks the  plugin
             has  registered.   If the plugin does not support hooks, <b>deregister_hooks</b> should be set to the NULL
             pointer.

             The <u>version</u> argument describes the version of the hooks API supported by the <b>sudo</b> front-end.

             The <b>deregister_hook</b>() function should be used to deregister any hooks that were put in place by the
             <b>register_hook</b>() function.  If the plugin tries to deregister a hook that  the  front-end  does  not
             support, <b>deregister_hook</b> will return an error.

             See the “Hook function API” section below for more information about hooks.

             NOTE: the <b>deregister_hooks</b>() function is only available starting with API version 1.2.  If the <b>sudo</b>
             front-end doesn't support API version 1.2 or higher, <b>deregister_hooks</b> will not be called.

       event_alloc
             struct sudo_plugin_event * (*event_alloc)(void);

             The  <b>event_alloc</b>() function is used to allocate a <b>struct</b> <b>sudo_plugin_event</b> which provides access to
             the main <b>sudo</b> event loop.  Unlike the other fields, the <b>event_alloc</b>() pointer is filled in  by  the
             <b>sudo</b> front-end, not by the plugin.

             See the “Event API” section below for more information about events.

             NOTE:  the  <b>event_alloc</b>()  function  is only available starting with API version 1.15.  If the <b>sudo</b>
             front-end doesn't support API version 1.15 or higher, <b>event_alloc</b>() will not be set.

       errstr
             If the <b>init_session</b>() function returns a value other  than  1,  the  plugin  may  store  a  message
             describing  the  failure  or  error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this value to any
             registered audit plugins.  The string stored in <u>errstr</u> must remain valid until the plugin's <b>close</b>()
             function is called.

             NOTE: the <u>errstr</u> parameter is only available starting with API version 1.15.  A plugin  <b>must</b>  check
             the  API  version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do so may result
             in a crash.

       <u>Policy</u> <u>Plugin</u> <u>Version</u> <u>Macros</u>

       /* Plugin API version major/minor. */
       #define SUDO_API_VERSION_MAJOR 1
       #define SUDO_API_VERSION_MINOR 13
       #define SUDO_API_MKVERSION(x, y) ((x &lt;&lt; 16) | y)
       #define SUDO_API_VERSION SUDO_API_MKVERSION(SUDO_API_VERSION_MAJOR,\
                                                   SUDO_API_VERSION_MINOR)

       /* Getters and setters for API version */
       #define SUDO_API_VERSION_GET_MAJOR(v) ((v) &gt;&gt; 16)
       #define SUDO_API_VERSION_GET_MINOR(v) ((v) &amp; 0xffff)
       #define SUDO_API_VERSION_SET_MAJOR(vp, n) do { \
           *(vp) = (*(vp) &amp; 0x0000ffff) | ((n) &lt;&lt; 16); \
       } <a href="../man0/while.0.html">while</a>(0)
       #define SUDO_API_VERSION_SET_MINOR(vp, n) do { \
           *(vp) = (*(vp) &amp; 0xffff0000) | (n); \
       } <a href="../man0/while.0.html">while</a>(0)

   <b>I/O</b> <b>plugin</b> <b>API</b>
       struct io_plugin {
       #define SUDO_IO_PLUGIN 2
           unsigned int type; /* always SUDO_IO_PLUGIN */
           unsigned int version; /* always SUDO_API_VERSION */
           int (*open)(unsigned int version, sudo_conv_t conversation,
               sudo_printf_t plugin_printf, char * const settings[],
               char * const user_info[], char * const command_info[],
               int argc, char * const argv[], char * const user_env[],
               char * const plugin_options[], const char **errstr);
           void (*close)(int exit_status, int error); /* wait status or error */
           int (*show_version)(int verbose);
           int (*log_ttyin)(const char *buf, unsigned int len,
               const char **errstr);
           int (*log_ttyout)(const char *buf, unsigned int len,
               const char **errstr);
           int (*log_stdin)(const char *buf, unsigned int len,
               const char **errstr);
           int (*log_stdout)(const char *buf, unsigned int len,
               const char **errstr);
           int (*log_stderr)(const char *buf, unsigned int len,
               const char **errstr);
           void (*register_hooks)(int version,
              int (*register_hook)(struct sudo_hook *hook));
           void (*deregister_hooks)(int version,
              int (*deregister_hook)(struct sudo_hook *hook));
           int (*change_winsize)(unsigned int lines, unsigned int cols,
               const char **errstr);
           int (*log_suspend)(int signo, const char **errstr);
           struct sudo_plugin_event * (*event_alloc)(void);
       };

       When an I/O plugin is loaded, <b>sudo</b> runs the command in a pseudo-terminal.  This makes it possible to  log
       the input and output from the user's session.  If any of the standard input, standard output, or standard
       error  do not correspond to a tty, <b>sudo</b> will open a pipe to capture the I/O for logging before passing it
       on.

       The log_ttyin function receives the raw user input from the terminal device (note that this will  include
       input  even  when  echo  is disabled, such as when a password is read).  The log_ttyout function receives
       output from the pseudo-terminal that is suitable for replaying the user's session at a later  time.   The
       <b>log_stdin</b>(),  <b>log_stdout</b>(),  and  <b>log_stderr</b>()  functions are only called if the standard input, standard
       output, or standard error respectively correspond to something other than a tty.

       Any of the logging functions may be set to the NULL pointer if no logging is to  be  performed.   If  the
       open function returns 0, no I/O will be sent to the plugin.

       If  a  logging  function  returns  an  error  (-1), the running command will be terminated and all of the
       plugin's logging functions will be disabled.  Other I/O logging plugins will still receive any  remaining
       input or output that has not yet been processed.

       If an input logging function rejects the data by returning 0, the command will be terminated and the data
       will  not be passed to the command, though it will still be sent to any other I/O logging plugins.  If an
       output logging function rejects the data by returning 0, the command will be terminated and the data will
       not be written to the terminal, though it will still be sent to any other I/O logging plugins.

       The audit_plugin struct has the following fields:

       type  The <b>type</b> field should always be set to SUDO_IO_PLUGIN.

       version
             The <b>version</b> field should be set to SUDO_API_VERSION.

             This allows <b>sudo</b> to determine the API version the plugin was built against.

       open
             int (*open)(unsigned int version, sudo_conv_t conversation,
                 sudo_printf_t plugin_printf, char * const settings[],
                 char * const user_info[], char * const command_info[],
                 int argc, char * const argv[], char * const user_env[],
                 char * const plugin_options[]);

             The <b>open</b>() function  is  run  before  the  <b>log_ttyin</b>(),  <b>log_ttyout</b>(),  <b>log_stdin</b>(),  <b>log_stdout</b>(),
             <b>log_stderr</b>(),  <b>log_suspend</b>(), <b>change_winsize</b>(), or <b>show_version</b>() functions are called.  It is only
             called if the version is being requested or if the  policy  plugin's  <b>check_policy</b>()  function  has
             returned  successfully.   It returns 1 on success, 0 on failure, -1 if a general error occurred, or
             -2 if there was a usage error.  In the latter case, <b>sudo</b> will  print  a  usage  message  before  it
             exits.   If  an  error occurs, the plugin may optionally call the <b>conversation</b>() or <b>plugin_printf</b>()
             function with SUDO_CONF_ERROR_MSG to present additional error information to the user.

             The function arguments are as follows:

             version
                   The version passed in by <b>sudo</b> allows the plugin to determine  the  major  and  minor  version
                   number of the plugin API supported by <b>sudo</b>.

             conversation
                   A  pointer  to the <b>conversation</b>() function that may be used by the <b>show_version</b>() function to
                   display version information (see <b>show_version</b>() below).  The <b>conversation</b>() function may also
                   be used to display additional error message to the user.  The <b>conversation</b>() function returns
                   0 on success and -1 on failure.

             plugin_printf
                   A pointer to a <b>printf</b>()-style function that may be used by  the  <b>show_version</b>()  function  to
                   display  version information (see show_version below).  The <b>plugin_printf</b>() function may also
                   be used to display additional error  message  to  the  user.   The  <b>plugin_printf</b>()  function
                   returns number of characters printed on success and -1 on failure.

             settings
                   A  vector  of user-supplied <b>sudo</b> settings in the form of “name=value” strings.  The vector is
                   terminated by a NULL pointer.  These settings correspond to options the user  specified  when
                   running  <b>sudo</b>.   As  such,  they  will only be present when the corresponding option has been
                   specified on the command line.

                   When parsing <u>settings</u>, the plugin should split on the <b>first</b> equal sign (‘=’) since  the  <u>name</u>
                   field will never include one itself but the <u>value</u> might.

                   See the “Policy plugin API” section for a list of all possible settings.

             user_info
                   A  vector  of  information  about  the  user  running the command in the form of “name=value”
                   strings.  The vector is terminated by a NULL pointer.

                   When parsing <u>user_info</u>, the plugin should split on the <b>first</b> equal sign (‘=’) since the  <u>name</u>
                   field will never include one itself but the <u>value</u> might.

                   See the “Policy plugin API” section for a list of all possible strings.

             command_info
                   A vector of information describing the command being run in the form of “name=value” strings.
                   The vector is terminated by a NULL pointer.

                   When  parsing  <u>command_info</u>,  the plugin should split on the <b>first</b> equal sign (‘=’) since the
                   <u>name</u> field will never include one itself but the <u>value</u> might.

                   See the “Policy plugin API” section for a list of all possible strings.

             argc  The number of elements in <u>argv</u>, not counting the final NULL pointer.  It can  be  zero,  when
                   <b>sudo</b> is called with <b>-V</b>.

             argv  If  non-NULL, an argument vector describing a command the user wishes to run in the same form
                   as what would be passed to the <u><a href="../man2/execve.2.html">execve</a></u>(2) system call.

             user_env
                   The user's environment in the form of a NULL-terminated vector of “name=value” strings.

                   When parsing <u>user_env</u>, the plugin should split on the <b>first</b> equal sign (‘=’) since  the  <u>name</u>
                   field will never include one itself but the <u>value</u> might.

             plugin_options
                   Any  (non-comment)  strings immediately after the plugin path are treated as arguments to the
                   plugin.  These arguments are split on a white space boundary and are passed to the plugin  in
                   the   form  of  a  NULL-terminated  array  of  strings.   If  no  arguments  were  specified,
                   <u>plugin_options</u> will be the NULL pointer.

                   NOTE: the <u>plugin_options</u> parameter is only available starting with API version 1.2.  A plugin
                   <b>must</b> check the API version specified by  the  <b>sudo</b>  front-end  before  using  <u>plugin_options</u>.
                   Failure to do so may result in a crash.

             errstr
                   If  the  <b>open</b>()  function  returns  a  value  other  than  1,  the plugin may store a message
                   describing the failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this  value  to
                   any  registered  audit  plugins.   The  string  stored  in <u>errstr</u> must remain valid until the
                   plugin's <b>close</b>() function is called.

                   NOTE: the <u>errstr</u> parameter is only available starting with API version 1.15.  A  plugin  <b>must</b>
                   check  the API version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do so
                   may result in a crash.

       close
             void (*close)(int exit_status, int error);

             The <b>close</b>() function is called when <b>sudo</b> is finished, shortly before it exits.

             The function arguments are as follows:

             exit_status
                   The command's exit status, as returned by the <u><a href="../man2/wait.2.html">wait</a></u>(2) system call, or zero if no command  was
                   run.  The value of <b>exit_status</b> is undefined if <b>error</b> is non-zero.

             error
                   If  the command could not be executed, this is set to the value of <b>errno</b> set by the <u><a href="../man2/execve.2.html">execve</a></u>(2)
                   system call.  If the command was successfully executed, the value of <b>error</b> is zero.

       show_version
             int (*show_version)(int verbose);

             The <b>show_version</b>() function is called by <b>sudo</b> when the user specifies the <b>-V</b>  option.   The  plugin
             may  display its version information to the user via the <b>conversation</b>() or <b>plugin_printf</b>() function
             using SUDO_CONV_INFO_MSG.

             Returns 1 on success, 0 on failure, -1 if a general error occurred, or -2  if  there  was  a  usage
             error, although the return value is currently ignored.

       log_ttyin
             int (*log_ttyin)(const char *buf, unsigned int len,
                 const char **errstr);

             The  <b>log_ttyin</b>() function is called whenever data can be read from the user but before it is passed
             to the running command.  This allows the plugin to reject data if it chooses to  (for  instance  if
             the  input  contains  banned content).  Returns 1 if the data should be passed to the command, 0 if
             the data is rejected (which will terminate the running command), or -1 if an error occurred.

             The function arguments are as follows:

             buf   The buffer containing user input.

             len   The length of <u>buf</u> in bytes.

             errstr
                   If the <b>log_ttyin</b>() function returns a value other than 1, the  plugin  may  store  a  message
                   describing  the  failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this value to
                   any registered audit plugins.  The string stored  in  <u>errstr</u>  must  remain  valid  until  the
                   plugin's <b>close</b>() function is called.

                   NOTE:  the  <u>errstr</u> parameter is only available starting with API version 1.15.  A plugin <b>must</b>
                   check the API version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do  so
                   may result in a crash.

       log_ttyout
             int (*log_ttyout)(const char *buf, unsigned int len,
                 const char **errstr);

             The  <b>log_ttyout</b>()  function  is  called whenever data can be read from the command but before it is
             written to the user's terminal.  This allows the plugin to  reject  data  if  it  chooses  to  (for
             instance  if  the  output  contains banned content).  Returns 1 if the data should be passed to the
             user, 0 if the data is rejected (which will terminate the running  command),  or  -1  if  an  error
             occurred.

             The function arguments are as follows:

             buf   The buffer containing command output.

             len   The length of <u>buf</u> in bytes.

             errstr
                   If  the  <b>log_ttyout</b>()  function  returns a value other than 1, the plugin may store a message
                   describing the failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this  value  to
                   any  registered  audit  plugins.   The  string  stored  in <u>errstr</u> must remain valid until the
                   plugin's <b>close</b>() function is called.

                   NOTE: the <u>errstr</u> parameter is only available starting with API version 1.15.  A  plugin  <b>must</b>
                   check  the API version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do so
                   may result in a crash.

       log_stdin
             int (*log_stdin)(const char *buf, unsigned int len,
                 const char **errstr);

             The <b>log_stdin</b>() function is only used if the standard input does not correspond to  a  tty  device.
             It  is  called  whenever  data  can  be read from the standard input but before it is passed to the
             running command.  This allows the plugin to reject data if it chooses to (for instance if the input
             contains banned content).  Returns 1 if the data should be passed to the command, 0 if the data  is
             rejected (which will terminate the running command), or -1 if an error occurred.

             The function arguments are as follows:

             buf   The buffer containing user input.

             len   The length of <u>buf</u> in bytes.

             errstr
                   If  the  <b>log_stdin</b>()  function  returns  a value other than 1, the plugin may store a message
                   describing the failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this  value  to
                   any  registered  audit  plugins.   The  string  stored  in <u>errstr</u> must remain valid until the
                   plugin's <b>close</b>() function is called.

                   NOTE: the <u>errstr</u> parameter is only available starting with API version 1.15.  A  plugin  <b>must</b>
                   check  the API version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do so
                   may result in a crash.

       log_stdout
             int (*log_stdout)(const char *buf, unsigned int len,
                 const char **errstr);

             The <b>log_stdout</b>() function is only used if the standard output does not correspond to a tty  device.
             It  is  called  whenever data can be read from the command but before it is written to the standard
             output.  This allows the plugin to reject data if  it  chooses  to  (for  instance  if  the  output
             contains  banned  content).   Returns  1 if the data should be passed to the user, 0 if the data is
             rejected (which will terminate the running command), or -1 if an error occurred.

             The function arguments are as follows:

             buf   The buffer containing command output.

             len   The length of <u>buf</u> in bytes.

             errstr
                   If the <b>log_stdout</b>() function returns a value other than 1, the plugin  may  store  a  message
                   describing  the  failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this value to
                   any registered audit plugins.  The string stored  in  <u>errstr</u>  must  remain  valid  until  the
                   plugin's <b>close</b>() function is called.

                   NOTE:  the  <u>errstr</u> parameter is only available starting with API version 1.15.  A plugin <b>must</b>
                   check the API version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do  so
                   may result in a crash.

       log_stderr
             int (*log_stderr)(const char *buf, unsigned int len,
                 const char **errstr);

             The  <b>log_stderr</b>()  function is only used if the standard error does not correspond to a tty device.
             It is called whenever data can be read from the command but before it is written  to  the  standard
             error.  This allows the plugin to reject data if it chooses to (for instance if the output contains
             banned  content).   Returns  1  if the data should be passed to the user, 0 if the data is rejected
             (which will terminate the running command), or -1 if an error occurred.

             The function arguments are as follows:

             buf   The buffer containing command output.

             len   The length of <u>buf</u> in bytes.

             errstr
                   If the <b>log_stderr</b>() function returns a value other than 1, the plugin  may  store  a  message
                   describing  the  failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this value to
                   any registered audit plugins.  The string stored  in  <u>errstr</u>  must  remain  valid  until  the
                   plugin's <b>close</b>() function is called.

                   NOTE:  the  <u>errstr</u> parameter is only available starting with API version 1.15.  A plugin <b>must</b>
                   check the API version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do  so
                   may result in a crash.

       register_hooks
             See the “Policy plugin API” section for a description of <b>register_hooks</b>.

       deregister_hooks
             See the “Policy plugin API” section for a description of <b>deregister_hooks</b>.

       change_winsize
             int (*change_winsize)(unsigned int lines, unsigned int cols,
                 const char **errstr);

             The  <b>change_winsize</b>()  function is called whenever the window size of the terminal changes from the
             initial values specified in the <b>user_info</b> list.  Returns -1 if an error occurred, in which case  no
             further calls to <b>change_winsize</b>() will be made,

             The function arguments are as follows:

             lines
                   The number of lines (rows) in the re-sized terminal.

             cols  The number of columns in the re-sized terminal.

             errstr
                   If the <b>change_winsize</b>() function returns a value other than 1, the plugin may store a message
                   describing  the  failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this value to
                   any registered audit plugins.  The string stored  in  <u>errstr</u>  must  remain  valid  until  the
                   plugin's <b>close</b>() function is called.

                   NOTE:  the  <u>errstr</u> parameter is only available starting with API version 1.15.  A plugin <b>must</b>
                   check the API version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do  so
                   may result in a crash.

       log_suspend
             int (*log_suspend)(int signo, const char **errstr);

             The  <b>log_suspend</b>()  function  is  called  whenever a command is suspended or resumed.  Logging this
             information makes it possible to skip the period of time when  the  command  was  suspended  during
             playback  of  a  session.   Returns  -1  if  an  error  occurred, in which case no further calls to
             <b>log_suspend</b>() will be made,

             The function arguments are as follows:

             signo
                   The signal that caused the command to be suspended, or SIGCONT if the command was resumed.

             errstr
                   If the <b>log_suspend</b>() function returns a value other than 1, the plugin may  store  a  message
                   describing  the  failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this value to
                   any registered audit plugins.  The string stored  in  <u>errstr</u>  must  remain  valid  until  the
                   plugin's <b>close</b>() function is called.

                   NOTE:  the  <u>errstr</u> parameter is only available starting with API version 1.15.  A plugin <b>must</b>
                   check the API version specified by the <b>sudo</b> front-end before using <u>errstr</u>.  Failure to do  so
                   may result in a crash.

             event_alloc
                   struct sudo_plugin_event * (*event_alloc)(void);

                   The  <b>event_alloc</b>()  function  is  used  to allocate a <b>struct</b> <b>sudo_plugin_event</b> which provides
                   access to the main <b>sudo</b> event loop.  Unlike the other fields, the  <b>event_alloc</b>()  pointer  is
                   filled in by the <b>sudo</b> front-end, not by the plugin.

                   See the “Event API” section below for more information about events.

                   NOTE:  the  <b>event_alloc</b>()  function is only available starting with API version 1.15.  If the
                   <b>sudo</b> front-end doesn't support API version 1.15 or higher, <b>event_alloc</b>() will not be set.

             <u>I/O</u> <u>Plugin</u> <u>Version</u> <u>Macros</u>

             Same as for the “Policy plugin API”.

   <b>Audit</b> <b>plugin</b> <b>API</b>
       /* Audit plugin close function status types. */
       #define SUDO_PLUGIN_NO_STATUS           0
       #define SUDO_PLUGIN_WAIT_STATUS         1
       #define SUDO_PLUGIN_EXEC_ERROR          2
       #define SUDO_PLUGIN_SUDO_ERROR          3

       #define SUDO_AUDIT_PLUGIN 3
       struct audit_plugin {
           unsigned int type; /* always SUDO_AUDIT_PLUGIN */
           unsigned int version; /* always SUDO_API_VERSION */
           int (*open)(unsigned int version, sudo_conv_t conversation,
               sudo_printf_t sudo_printf, char * const settings[],
               char * const user_info[], int submit_optind,
               char * const submit_argv[], char * const submit_envp[],
               char * const plugin_options[], const char **errstr);
           void (*close)(int status_type, int status);
           int (*accept)(const char *plugin_name,
               unsigned int plugin_type, char * const command_info[],
               char * const run_argv[], char * const run_envp[],
               const char **errstr);
           int (*reject)(const char *plugin_name, unsigned int plugin_type,
               const char *audit_msg, char * const command_info[],
               const char **errstr);
           int (*error)(const char *plugin_name, unsigned int plugin_type,
               const char *audit_msg, char * const command_info[],
               const char **errstr);
           int (*show_version)(int verbose);
           void (*register_hooks)(int version,
               int (*register_hook)(struct sudo_hook *hook));
           void (*deregister_hooks)(int version,
               int (*deregister_hook)(struct sudo_hook *hook));
           struct sudo_plugin_event * (*event_alloc)(void);
       }

       An audit plugin can be used to log successful and unsuccessful attempts to run <b>sudo</b>  independent  of  the
       policy or any I/O plugins.  Multiple audit plugins may be specified in <u><a href="../man5/sudo.conf.5.html">sudo.conf</a></u>(5).

       The audit_plugin struct has the following fields:

       type  The <b>type</b> field should always be set to SUDO_AUDIT_PLUGIN.

       version
             The <b>version</b> field should be set to SUDO_API_VERSION.

             This allows <b>sudo</b> to determine the API version the plugin was built against.

       open
             int (*open)(unsigned int version, sudo_conv_t conversation,
                 sudo_printf_t sudo_printf, char * const settings[],
                 char * const user_info[], int submit_optind,
                 char * const submit_argv[], char * const submit_envp[],
                 char * const plugin_options[], const char **errstr);

             The  audit  <b>open</b>()  function  is  run  before  any  other <b>sudo</b> plugin API functions.  This makes it
             possible to audit failures in the other plugins.  It returns 1 on success, 0 on failure,  -1  if  a
             general  error  occurred,  or -2 if there was a usage error.  In the latter case, <b>sudo</b> will print a
             usage message  before  it  exits.   If  an  error  occurs,  the  plugin  may  optionally  call  the
             <b>conversation</b>()  or  <b>plugin_printf</b>()  function  with SUDO_CONF_ERROR_MSG to present additional error
             information to the user.

             The function arguments are as follows:

             version
                   The version passed in by <b>sudo</b> allows the plugin to determine  the  major  and  minor  version
                   number of the plugin API supported by <b>sudo</b>.

             conversation
                   A  pointer  to the <b>conversation</b>() function that may be used by the <b>show_version</b>() function to
                   display version information (see <b>show_version</b>() below).  The <b>conversation</b>() function may also
                   be used to display additional error message to the user.  The <b>conversation</b>() function returns
                   0 on success, and -1 on failure.

             plugin_printf
                   A pointer to a <b>printf</b>()-style function that may be used by  the  <b>show_version</b>()  function  to
                   display  version information (see show_version below).  The <b>plugin_printf</b>() function may also
                   be used to display additional error  message  to  the  user.   The  <b>plugin_printf</b>()  function
                   returns number of characters printed on success and -1 on failure.

             settings
                   A  vector  of user-supplied <b>sudo</b> settings in the form of “name=value” strings.  The vector is
                   terminated by a NULL pointer.  These settings correspond to options the user  specified  when
                   running  <b>sudo</b>.   As  such,  they  will only be present when the corresponding option has been
                   specified on the command line.

                   When parsing <u>settings</u>, the plugin should split on the <b>first</b> equal sign (‘=’) since  the  <u>name</u>
                   field will never include one itself but the <u>value</u> might.

                   See the “Policy plugin API” section for a list of all possible settings.

             user_info
                   A  vector  of  information  about  the  user  running the command in the form of “name=value”
                   strings.  The vector is terminated by a NULL pointer.

                   When parsing <u>user_info</u>, the plugin should split on the <b>first</b> equal sign (‘=’) since the  <u>name</u>
                   field will never include one itself but the <u>value</u> might.

                   See the “Policy plugin API” section for a list of all possible strings.

             submit_optind
                   The  index  into  <u>submit_argv</u>  that corresponds to the first entry that is not a command line
                   option.  If <u>submit_argv</u> only consists of options, which may be the case with  the  <b>-l</b>  or  <b>-v</b>
                   options, <b>submit_argv[submit_optind]</b> will evaluate to the NULL pointer.

             submit_argv
                   The  argument  vector  <b>sudo</b>  was  invoked  with,  including  all  command  line options.  The
                   <u>submit_optind</u> argument can be used to determine the end of the command line options.

             submit_envp
                   The invoking user's environment in the form  of  a  NULL-terminated  vector  of  “name=value”
                   strings.

                   When  parsing  <u>submit_envp</u>,  the  plugin should split on the <b>first</b> equal sign (‘=’) since the
                   <u>name</u> field will never include one itself but the <u>value</u> might.

             plugin_options
                   Any (non-comment) strings immediately after the plugin path are treated as arguments  to  the
                   plugin.   These arguments are split on a white space boundary and are passed to the plugin in
                   the  form  of  a  NULL-terminated  array  of  strings.   If  no  arguments  were   specified,
                   <u>plugin_options</u> will be the NULL pointer.

             errstr
                   If  the  <b>open</b>()  function  returns  a  value  other  than  1,  the plugin may store a message
                   describing the failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this  value  to
                   any  registered  audit  plugins.   The  string  stored  in <u>errstr</u> must remain valid until the
                   plugin's <b>close</b>() function is called.

       close
             void (*close)(int status_type, int status);

             The <b>close</b>() function is called when <b>sudo</b> is finished, shortly before it exits.

             The function arguments are as follows:

             status_type
                   The type of status being  passed.   One  of  SUDO_PLUGIN_NO_STATUS,  SUDO_PLUGIN_WAIT_STATUS,
                   SUDO_PLUGIN_EXEC_ERROR or SUDO_PLUGIN_SUDO_ERROR.

             status
                   Depending  on  the  value  of  <u>status_type</u>,  this value is either ignored, the command's exit
                   status as returned by the <u><a href="../man2/wait.2.html">wait</a></u>(2) system call, the value of <b>errno</b> set by the <u><a href="../man2/execve.2.html">execve</a></u>(2) system
                   call, or the value of <b>errno</b> resulting from an error in the <b>sudo</b> front-end.

       accept
             int (*accept)(const char *plugin_name, unsigned int plugin_type,
                 char * const command_info[], char * const run_argv[],
                 char * const run_envp[], const char **errstr);

             The <b>accept</b>() function is called when a command or action  is  accepted  by  a  policy  or  approval
             plugin.  The function arguments are as follows:

             plugin_name
                   The name of the plugin that accepted the command or “sudo” for the <b>sudo</b> front-end.

             plugin_type
                   The   type  of  plugin  that  accepted  the  command,  currently  either  SUDO_POLICY_PLUGIN,
                   SUDO_POLICY_APPROVAL,  or  SUDO_FRONT_END.   The  <b>accept</b>()  function   is   called   multiple
                   times--once for each policy or approval plugin that succeeds and once for the sudo front-end.
                   When called on behalf of the sudo front-end, <u>command_info</u> may include information from an I/O
                   logging plugin as well.

                   Typically,  an audit plugin is interested in either the accept status from the <b>sudo</b> front-end
                   or from the various policy and approval plugins, but not both.  It is possible for the policy
                   plugin to accept a command that is later rejected by an approval plugin, in  which  case  the
                   audit plugin's <b>accept</b>() and <b>reject</b>() functions will <u>both</u> be called.

             command_info
                   An  optional  vector  of  information  describing  the  command  being  run  in  the  form of
                   “name=value” strings.  The vector is terminated by a NULL pointer.

                   When parsing <u>command_info</u>, the plugin should split on the <b>first</b> equal sign  (‘=’)  since  the
                   <u>name</u> field will never include one itself but the <u>value</u> might.

                   See the “Policy plugin API” section for a list of all possible strings.

             run_argv
                   A  NULL-terminated  argument vector describing a command that will be run in the same form as
                   what would be passed to the <u><a href="../man2/execve.2.html">execve</a></u>(2) system call.

             run_envp
                   The environment the command will be run with in the  form  of  a  NULL-terminated  vector  of
                   “name=value” strings.

                   When  parsing  <u>run_envp</u>, the plugin should split on the <b>first</b> equal sign (‘=’) since the <u>name</u>
                   field will never include one itself but the <u>value</u> might.

             errstr
                   If the <b>accept</b>() function returns a value other  than  1,  the  plugin  may  store  a  message
                   describing  the  failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this value to
                   any registered audit plugins.  The string stored  in  <u>errstr</u>  must  remain  valid  until  the
                   plugin's <b>close</b>() function is called.

       reject
             int (*reject)(const char *plugin_name, unsigned int plugin_type,
                 const char *audit_msg, char * const command_info[],
                 const char **errstr);

             The  <b>reject</b>()  function  is  called when a command or action is rejected by a plugin.  The function
             arguments are as follows:

             plugin_name
                   The name of the plugin that rejected the command.

             plugin_type
                   The  type  of  plugin  that  rejected  the  command,  currently  either   SUDO_POLICY_PLUGIN,
                   SUDO_APPROVAL_PLUGIN, or SUDO_IO_PLUGIN.

                   Unlike  the  <b>accept</b>()  function,  the  <b>reject</b>()  function is not called on behalf of the <b>sudo</b>
                   front-end.

             audit_msg
                   An optional string describing the reason the command was rejected  by  the  plugin.   If  the
                   plugin did not provide a reason, <u>audit_msg</u> will be the NULL pointer.

             command_info
                   An  optional  vector  of  information  describing  the  command  being  run  in  the  form of
                   “name=value” strings.  The vector is terminated by a NULL pointer.

                   When parsing <u>command_info</u>, the plugin should split on the <b>first</b> equal sign  (‘=’)  since  the
                   <u>name</u> field will never include one itself but the <u>value</u> might.

                   See the “Policy plugin API” section for a list of all possible strings.

             errstr
                   If  the  <b>reject</b>()  function  returns  a  value  other  than 1, the plugin may store a message
                   describing the failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this  value  to
                   any  registered  audit  plugins.   The  string  stored  in <u>errstr</u> must remain valid until the
                   plugin's <b>close</b>() function is called.

       error
             int (*error)(const char *plugin_name, unsigned int plugin_type,
                 const char *audit_msg, char * const command_info[],
                 const char **errstr);

             The <b>error</b>() function is called when a plugin or the <b>sudo</b> front-end returns an error.  The  function
             arguments are as follows:

             plugin_name
                   The name of the plugin that generated the error or “sudo” for the <b>sudo</b> front-end.

             plugin_type
                   The type of plugin that generated the error, or SUDO_FRONT_END for the <b>sudo</b> front-end.

             audit_msg
                   An optional string describing the plugin error.  If the plugin did not provide a description,
                   <u>audit_msg</u> will be the NULL pointer.

             command_info
                   An  optional  vector  of  information  describing  the  command  being  run  in  the  form of
                   “name=value” strings.  The vector is terminated by a NULL pointer.

                   When parsing <u>command_info</u>, the plugin should split on the <b>first</b> equal sign  (‘=’)  since  the
                   <u>name</u> field will never include one itself but the <u>value</u> might.

                   See the “Policy plugin API” section for a list of all possible strings.

             errstr
                   If  the  <b>error</b>()  function  returns  a  value  other  than  1, the plugin may store a message
                   describing the failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this  value  to
                   any  registered  audit  plugins.   The  string  stored  in <u>errstr</u> must remain valid until the
                   plugin's <b>close</b>() function is called.

       show_version
             int (*show_version)(int verbose);

             The <b>show_version</b>() function is called by <b>sudo</b> when the user specifies the <b>-V</b>  option.   The  plugin
             may  display its version information to the user via the <b>conversation</b>() or <b>plugin_printf</b>() function
             using SUDO_CONV_INFO_MSG.  If the user requests detailed version information, the verbose flag will
             be set.

             Returns 1 on success, 0 on failure, -1 if a general error occurred, or -2  if  there  was  a  usage
             error, although the return value is currently ignored.

       register_hooks
             See the “Policy plugin API” section for a description of <b>register_hooks</b>.

       deregister_hooks
             See the “Policy plugin API” section for a description of <b>deregister_hooks</b>.

       event_alloc
             struct sudo_plugin_event * (*event_alloc)(void);

             The  <b>event_alloc</b>() function is used to allocate a <b>struct</b> <b>sudo_plugin_event</b> which provides access to
             the main <b>sudo</b> event loop.  Unlike the other fields, the <b>event_alloc</b>() pointer is filled in  by  the
             <b>sudo</b> front-end, not by the plugin.

             See the “Event API” section below for more information about events.

             NOTE:  the  <b>event_alloc</b>()  function  is only available starting with API version 1.17.  If the <b>sudo</b>
             front-end doesn't support API version 1.17 or higher, <b>event_alloc</b>() will not be set.

   <b>Approval</b> <b>plugin</b> <b>API</b>
       struct approval_plugin {
       #define SUDO_APPROVAL_PLUGIN 4
           unsigned int type; /* always SUDO_APPROVAL_PLUGIN */
           unsigned int version; /* always SUDO_API_VERSION */
           int (*open)(unsigned int version, sudo_conv_t conversation,
               sudo_printf_t sudo_printf, char * const settings[],
               char * const user_info[], int submit_optind,
               char * const submit_argv[], char * const submit_envp[],
               char * const plugin_options[], const char **errstr);
           void (*close)(void);
           int (*check)(char * const command_info[], char * const run_argv[],
               char * const run_envp[], const char **errstr);
           int (*show_version)(int verbose);
       };

       An approval plugin can be used to apply extra constraints after a command has been accepted by the policy
       plugin.  Unlike the other plugin types, it does not remain open until the command completes.  The  plugin
       is  opened  before  a  call  to  <b>check</b>()  or  <b>show_version</b>()  and closed shortly thereafter (audit plugin
       functions must be called before the plugin is closed).  Multiple approval plugins  may  be  specified  in
       <u><a href="../man5/sudo.conf.5.html">sudo.conf</a></u>(5).

       The approval_plugin struct has the following fields:

       type  The <b>type</b> field should always be set to SUDO_APPROVAL_PLUGIN.

       version
             The <b>version</b> field should be set to SUDO_API_VERSION.

             This allows <b>sudo</b> to determine the API version the plugin was built against.

       open
             int (*open)(unsigned int version, sudo_conv_t conversation,
                 sudo_printf_t sudo_printf, char * const settings[],
                 char * const user_info[], int submit_optind,
                 char * const submit_argv[], char * const submit_envp[],
                 char * const plugin_options[], const char **errstr);

             The  approval  <b>open</b>()  function  is  run  immediately  before  a  call  to  the plugin's <b>check</b>() or
             <b>show_version</b>() functions.  It is only called if the version is being requested  or  if  the  policy
             plugin's <b>check_policy</b>() function has returned successfully.  It returns 1 on success, 0 on failure,
             -1  if  a  general error occurred, or -2 if there was a usage error.  In the latter case, <b>sudo</b> will
             print a usage message before it exits.  If an error occurs, the  plugin  may  optionally  call  the
             <b>conversation</b>()  or  <b>plugin_printf</b>()  function  with SUDO_CONF_ERROR_MSG to present additional error
             information to the user.

             The function arguments are as follows:

             version
                   The version passed in by <b>sudo</b> allows the plugin to determine  the  major  and  minor  version
                   number of the plugin API supported by <b>sudo</b>.

             conversation
                   A  pointer to the <b>conversation</b>() function that can be used by the plugin to interact with the
                   user (see “Conversation API” for details).  Returns 0 on success and -1 on failure.

             plugin_printf
                   A pointer to a <b>printf</b>()-style function that may be used to  display  informational  or  error
                   messages  (see  “Conversation API” for details).  Returns the number of characters printed on
                   success and -1 on failure.

             settings
                   A vector of user-supplied <b>sudo</b> settings in the form of “name=value” strings.  The  vector  is
                   terminated  by  a NULL pointer.  These settings correspond to options the user specified when
                   running <b>sudo</b>.  As such, they will only be present when  the  corresponding  option  has  been
                   specified on the command line.

                   When  parsing  <u>settings</u>, the plugin should split on the <b>first</b> equal sign (‘=’) since the <u>name</u>
                   field will never include one itself but the <u>value</u> might.

                   See the “Policy plugin API” section for a list of all possible settings.

             user_info
                   A vector of information about the user running  the  command  in  the  form  of  “name=value”
                   strings.  The vector is terminated by a NULL pointer.

                   When  parsing <u>user_info</u>, the plugin should split on the <b>first</b> equal sign (‘=’) since the <u>name</u>
                   field will never include one itself but the <u>value</u> might.

                   See the “Policy plugin API” section for a list of all possible strings.

             submit_optind
                   The index into <u>submit_argv</u> that corresponds to the first entry that is  not  a  command  line
                   option.   If  <u>submit_argv</u>  only  consists of options, which may be the case with the <b>-l</b> or <b>-v</b>
                   options, <b>submit_argv[submit_optind]</b> will evaluate to the NULL pointer.

             submit_argv
                   The argument vector  <b>sudo</b>  was  invoked  with,  including  all  command  line  options.   The
                   <u>submit_optind</u> argument can be used to determine the end of the command line options.

             submit_envp
                   The  invoking  user's  environment  in  the  form of a NULL-terminated vector of “name=value”
                   strings.

                   When parsing <u>submit_envp</u>, the plugin should split on the <b>first</b> equal  sign  (‘=’)  since  the
                   <u>name</u> field will never include one itself but the <u>value</u> might.

             plugin_options
                   Any  (non-comment)  strings immediately after the plugin path are treated as arguments to the
                   plugin.  These arguments are split on a white space boundary and are passed to the plugin  in
                   the   form  of  a  NULL-terminated  array  of  strings.   If  no  arguments  were  specified,
                   <u>plugin_options</u> will be the NULL pointer.

             errstr
                   If the <b>open</b>() function returns a  value  other  than  1,  the  plugin  may  store  a  message
                   describing  the  failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this value to
                   any registered audit plugins.  The string stored  in  <u>errstr</u>  must  remain  valid  until  the
                   plugin's <b>close</b>() function is called.

       close
             void (*close)(void);

             The <b>close</b>() function is called after the approval plugin's <b>check</b>() or <b>show_version</b>() functions have
             been  called.   It  takes  no arguments.  The <b>close</b>() function is typically used to perform plugin-
             specific cleanup, such as the freeing of memory objects allocated by the  plugin.   If  the  plugin
             does not need to perform any cleanup, <b>close</b>() may be set to the NULL pointer.

       check
             int (*check)(char * const command_info[], char * const run_argv[],
                 char * const run_envp[], const char **errstr);

             The approval <b>check</b>() function is run after the policy plugin <b>check_policy</b>() function and before any
             I/O  logging  plugins.   If  multiple  approval  plugins  are loaded, they must all succeed for the
             command to be allowed.  It returns 1 on success, 0 on failure, -1 if a general error  occurred,  or
             -2  if  there  was  a  usage  error.  In the latter case, <b>sudo</b> will print a usage message before it
             exits.  If an error occurs, the plugin may optionally call the  <b>conversation</b>()  or  <b>plugin_printf</b>()
             function with SUDO_CONF_ERROR_MSG to present additional error information to the user.

             The function arguments are as follows:

             command_info
                   A vector of information describing the command being run in the form of “name=value” strings.
                   The vector is terminated by a NULL pointer.

                   When  parsing  <u>command_info</u>,  the plugin should split on the <b>first</b> equal sign (‘=’) since the
                   <u>name</u> field will never include one itself but the <u>value</u> might.

                   See the “Policy plugin API” section for a list of all possible strings.

             run_argv
                   A NULL-terminated argument vector describing a command that will be run in the same  form  as
                   what would be passed to the <u><a href="../man2/execve.2.html">execve</a></u>(2) system call.

             run_envp
                   The  environment  the  command  will  be  run with in the form of a NULL-terminated vector of
                   “name=value” strings.

                   When parsing <u>run_envp</u>, the plugin should split on the <b>first</b> equal sign (‘=’) since  the  <u>name</u>
                   field will never include one itself but the <u>value</u> might.

             errstr
                   If  the  <b>open</b>()  function  returns  a  value  other  than  1,  the plugin may store a message
                   describing the failure or error in <u>errstr</u>.  The <b>sudo</b> front-end will then pass this  value  to
                   any  registered  audit  plugins.   The  string  stored  in <u>errstr</u> must remain valid until the
                   plugin's <b>close</b>() function is called.

       show_version
             int (*show_version)(int verbose);

             The <b>show_version</b>() function is called by <b>sudo</b> when the user specifies the <b>-V</b>  option.   The  plugin
             may  display its version information to the user via the <b>conversation</b>() or <b>plugin_printf</b>() function
             using SUDO_CONV_INFO_MSG.  If the user requests detailed version information, the verbose flag will
             be set.

             Returns 1 on success, 0 on failure, -1 if a general error occurred, or -2  if  there  was  a  usage
             error, although the return value is currently ignored.

   <b>Signal</b> <b>handlers</b>
       The <b>sudo</b> front-end installs default signal handlers to trap common signals while the plugin functions are
       run.  The following signals are trapped by default before the command is executed:

       <b>•</b>  SIGALRM
       <b>•</b>  SIGHUP
       <b>•</b>  SIGINT
       <b>•</b>  SIGPIPE
       <b>•</b>  SIGQUIT
       <b>•</b>  SIGTERM
       <b>•</b>  SIGTSTP
       <b>•</b>  SIGUSR1
       <b>•</b>  SIGUSR2

       If  a  fatal  signal  is  received  before  the  command is executed, <b>sudo</b> will call the plugin's <b>close</b>()
       function with an exit status of 128 plus the value of the signal that  was  received.   This  allows  for
       consistent  logging of commands killed by a signal for plugins that log such information in their <b>close</b>()
       function.  An exception to this is SIGPIPE, which is ignored until the command is executed.

       A plugin may temporarily install its own signal handlers but must restore the original handler before the
       plugin function returns.

   <b>Hook</b> <b>function</b> <b>API</b>
       Beginning with plugin API version 1.2, it is possible to install hooks for certain  functions  called  by
       the <b>sudo</b> front-end.

       Currently,  the  only supported hooks relate to the handling of environment variables.  Hooks can be used
       to intercept attempts to get, set, or remove environment variables so that these changes can be reflected
       in the version of the environment that is used to execute a command.  A future version of  the  API  will
       support hooking internal <b>sudo</b> front-end functions as well.

       <u>Hook</u> <u>structure</u>

       Hooks in <b>sudo</b> are described by the following structure:

       typedef int (*sudo_hook_fn_t)();

       struct sudo_hook {
           unsigned int hook_version;
           unsigned int hook_type;
           sudo_hook_fn_t hook_fn;
           void *closure;
       };

       The <b>sudo_hook</b> structure has the following fields:

       hook_version
             The <b>hook_version</b> field should be set to SUDO_HOOK_VERSION.

       hook_type
             The <b>hook_type</b> field may be one of the following supported hook types:

             SUDO_HOOK_SETENV
                   The  C  library  <u><a href="../man3/setenv.3.html">setenv</a></u>(3)  function.   Any  registered  hooks  will run before the C library
                   implementation.  The <b>hook_fn</b> field should be a function that matches the following typedef:

                   typedef int (*sudo_hook_fn_setenv_t)(const char *name,
                      const char *value, int overwrite, void *closure);

                   If the registered hook does not match the typedef the results are unspecified.

             SUDO_HOOK_UNSETENV
                   The C library <u><a href="../man3/unsetenv.3.html">unsetenv</a></u>(3) function.  Any registered hooks  will  run  before  the  C  library
                   implementation.  The <b>hook_fn</b> field should be a function that matches the following typedef:

                   typedef int (*sudo_hook_fn_unsetenv_t)(const char *name,
                      void *closure);

             SUDO_HOOK_GETENV
                   The  C  library  <u><a href="../man3/getenv.3.html">getenv</a></u>(3)  function.   Any  registered  hooks  will run before the C library
                   implementation.  The <b>hook_fn</b> field should be a function that matches the following typedef:

                   typedef int (*sudo_hook_fn_getenv_t)(const char *name,
                      char **value, void *closure);

                   If the registered hook does not match the typedef the results are unspecified.

             SUDO_HOOK_PUTENV
                   The C library <u><a href="../man3/putenv.3.html">putenv</a></u>(3) function.  Any  registered  hooks  will  run  before  the  C  library
                   implementation.  The <b>hook_fn</b> field should be a function that matches the following typedef:

                   typedef int (*sudo_hook_fn_putenv_t)(char *string,
                      void *closure);

                   If the registered hook does not match the typedef the results are unspecified.

       hook_fn
             sudo_hook_fn_t hook_fn;

             The <b>hook_fn</b> field should be set to the plugin's hook implementation.  The actual function arguments
             will  vary  depending  on  the <b>hook_type</b> (see <b>hook_type</b> above).  In all cases, the <b>closure</b> field of
             <b>struct</b> <b>sudo_hook</b> is passed as the last function parameter.  This can be used to pass arbitrary data
             to the plugin's hook implementation.

             The function return value may be one of the following:

             SUDO_HOOK_RET_ERROR
                   The hook function encountered an error.

             SUDO_HOOK_RET_NEXT
                   The hook completed without error, go on to the next hook (including the system implementation
                   if applicable).  For example,  a  <u><a href="../man3/getenv.3.html">getenv</a></u>(3)  hook  might  return  SUDO_HOOK_RET_NEXT  if  the
                   specified variable was not found in the private copy of the environment.

             SUDO_HOOK_RET_STOP
                   The  hook  completed  without  error, stop processing hooks for this invocation.  This can be
                   used to replace the system implementation.  For example, a <b>setenv</b> hook  that  operates  on  a
                   private copy of the environment but leaves <b>environ</b> unchanged.

       Note  that  it  is very easy to create an infinite loop when hooking C library functions.  For example, a
       <u><a href="../man3/getenv.3.html">getenv</a></u>(3) hook that calls the <u><a href="../man3/snprintf.3.html">snprintf</a></u>(3) function may create a loop if  the  <u><a href="../man3/snprintf.3.html">snprintf</a></u>(3)  implementation
       calls  <u><a href="../man3/getenv.3.html">getenv</a></u>(3) to check the locale.  To prevent this, you may wish to use a static variable in the hook
       function to guard against nested calls.  For example:

       static int in_progress = 0; /* avoid recursion */
       if (in_progress)
           return SUDO_HOOK_RET_NEXT;
       in_progress = 1;
       ...
       in_progress = 0;
       return SUDO_HOOK_RET_STOP;

       <u>Hook</u> <u>API</u> <u>Version</u> <u>Macros</u>

       /* Hook API version major/minor */
       #define SUDO_HOOK_VERSION_MAJOR 1
       #define SUDO_HOOK_VERSION_MINOR 0
       #define SUDO_HOOK_VERSION SUDO_API_MKVERSION(SUDO_HOOK_VERSION_MAJOR,\
                                                     SUDO_HOOK_VERSION_MINOR)

       For getters and setters see the “Policy plugin API”.

   <b>Event</b> <b>API</b>
       When <b>sudo</b> runs a command, it uses an event loop to service signals and  I/O.   Events  may  be  triggered
       based  on time, a file or socket descriptor becoming ready, or due to receipt of a signal.  Starting with
       API version 1.15, it is possible for  a  plugin  to  participate  in  this  event  loop  by  calling  the
       <b>event_alloc</b>() function.

       <u>Event</u> <u>structure</u>

       Events are described by the following structure:

       typedef void (*sudo_plugin_ev_callback_t)(int fd, int what, void *closure);

       struct sudo_plugin_event {
           int (*set)(struct sudo_plugin_event *pev, int fd, int events,
               sudo_plugin_ev_callback_t callback, void *closure);
           int (*add)(struct sudo_plugin_event *pev, struct timespec *timeout);
           int (*del)(struct sudo_plugin_event *pev);
           int (*pending)(struct sudo_plugin_event *pev, int events,
               struct timespec *ts);
           int (*fd)(struct sudo_plugin_event *pev);
           void (*setbase)(struct sudo_plugin_event *pev, void *base);
           void (*loopbreak)(struct sudo_plugin_event *pev);
           void (*free)(struct sudo_plugin_event *pev);
       };

       The sudo_plugin_event struct contains the following function pointers:

       <b>set</b>()
             int (*set)(struct sudo_plugin_event *pev, int fd, int events,
                 sudo_plugin_ev_callback_t callback, void *closure);

             The <b>set</b>() function takes the following arguments:

             struct sudo_plugin_event *<u>pev</u>
                   A pointer to the struct sudo_plugin_event itself.

             <u>fd</u>    The  file  or  socket descriptor for I/O-based events or the signal number for signal events.
                   For time-based events, <u>fd</u> must be -1.

             <u>events</u>
                   The following values determine what will trigger the event callback:

                   SUDO_PLUGIN_EV_TIMEOUT
                         callback is run after the specified timeout expires

                   SUDO_PLUGIN_EV_READ
                         callback is run when the file descriptor is readable

                   SUDO_PLUGIN_EV_WRITE
                         callback is run when the file descriptor is writable

                   SUDO_PLUGIN_EV_PERSIST
                         event is persistent and remains enabled until explicitly deleted

                   SUDO_PLUGIN_EV_SIGNAL
                         callback is run when the specified signal is received

                   The SUDO_PLUGIN_EV_PERSIST flag may be ORed with any of the event types.  It is also possible
                   to OR SUDO_PLUGIN_EV_READ and SUDO_PLUGIN_EV_WRITE  together  to  run  the  callback  when  a
                   descriptor  is  ready  to  be  either  read  from  or written to.  All other event values are
                   mutually exclusive.

             sudo_plugin_ev_callback_t <u>callback</u>
                   typedef void (*sudo_plugin_ev_callback_t)(int fd, int what,
                       void *closure);

                   The function to call when an event is triggered.  The <b>callback</b>() function  is  run  with  the
                   following arguments:

                   <u>fd</u>    The  file  or  socket  descriptor  for I/O-based events or the signal number for signal
                         events.

                   <u>what</u>  The event type that triggered that callback.  For events that have multiple event types
                         (for example  SUDO_PLUGIN_EV_READ  and  SUDO_PLUGIN_EV_WRITE)  or  have  an  associated
                         timeout, <u>what</u> can be used to determine why the callback was run.

                   <u>closure</u>
                         The generic pointer that was specified in the <b>set</b>() function.

             closure
                   A generic pointer that will be passed to the callback function.

             The <b>set</b>() function returns 1 on success, and -1 if a error occurred.

       <b>add</b>()
             int (*add)(struct sudo_plugin_event *pev, struct timespec *timeout);

             The  <b>add</b>()  function  adds the event <u>pev</u> to <b>sudo</b>'s event loop.  The event must have previously been
             initialized via the <b>set</b>() function.  If the <u>timeout</u> argument is  not  NULL,  it  should  specify  a
             (relative)  timeout after which the event will be triggered if the main event criteria has not been
             met.  This is often used to implement an I/O timeout where the event will fire if a  descriptor  is
             not  ready  within  a  certain time period.  If the event is already present in the event loop, its
             <u>timeout</u> will be adjusted to match the new value, if any.

             The <b>add</b>() function returns 1 on success, and -1 if a error occurred.

       <b>del</b>()
             int (*del)(struct sudo_plugin_event *pev);

             The <b>del</b>() function deletes the event <u>pev</u> from <b>sudo</b>'s event loop.  Deleted events can be added  back
             via the <b>add</b>() function.

             The <b>del</b>() function returns 1 on success, and -1 if a error occurred.

       <b>pending</b>()
             int (*pending)(struct sudo_plugin_event *pev, int events,
                 struct timespec *ts);

             The  <b>pending</b>() function can be used to determine whether one or more events is pending.  The <u>events</u>
             argument specifies which events to check for.  See the <b>set</b>() function for a  list  of  valid  event
             types.   If  SUDO_PLUGIN_EV_TIMEOUT is specified in events, the event has an associated timeout and
             the <u>ts</u> pointer is non-NULL, it will be filled in with the remaining time.

       <b>fd</b>()
             int (*fd)(struct sudo_plugin_event *pev);

             The <b>fd</b>() function returns the descriptor or signal number associated with the event <u>pev</u>.

       <b>setbase</b>()
             void (*setbase)(struct sudo_plugin_event *pev, void *base);

             The <b>setbase</b>() function sets the underlying event <u>base</u> for <u>pev</u> to the specified value.  This can  be
             used  to  move  an  event  created  via <b>event_alloc</b>() to a new event loop allocated by sudo's event
             subsystem.  If <u>base</u> is NULL, <u>pev</u>'s event base is reset to the default value, which  corresponds  to
             <b>sudo</b>'s  main  event  loop.   Using  this  function  requires  linking the plugin with the sudo_util
             library.  It is unlikely to be used outside of the <b>sudoers</b> plugin.

       <b>loopbreak</b>()
             void (*loopbreak)(struct sudo_plugin_event *pev);

             The <b>loopbreak</b>() function causes <b>sudo</b>'s event loop to exit immediately and the running command to be
             terminated.

       <b>free</b>()
             void (*free)(struct sudo_plugin_event *pev);

             The <b>free</b>() function deletes the event <u>pev</u> from the event loop and frees the memory associated  with
             it.

   <b>Remote</b> <b>command</b> <b>execution</b>
       The  <b>sudo</b>  front-end does not support running remote commands.  However, starting with <b>sudo</b> 1.8.8, the <b>-h</b>
       option may be used to specify a remote host that is passed to the  policy  plugin.   A  plugin  may  also
       accept  a  <u>runas_user</u>  in the form of “user@hostname” which will work with older versions of <b>sudo</b>.  It is
       anticipated that remote commands will be supported by executing a “helper” program.   The  policy  plugin
       should  setup  the execution environment such that the <b>sudo</b> front-end will run the helper which, in turn,
       will connect to the remote host and run the command.

       For example, the policy plugin could utilize <b>ssh</b> to perform remote command execution.  The helper program
       would be responsible for running <b>ssh</b> with the proper options to use a private key or certificate that the
       remote host will accept and run a program on the remote host that would setup the  execution  environment
       accordingly.

       Note  that  remote  <b>sudoedit</b>  functionality  must be handled by the policy plugin, not <b>sudo</b> itself as the
       front-end has no knowledge that a remote command is being executed.  This may be addressed  in  a  future
       revision of the plugin API.

   <b>Conversation</b> <b>API</b>
       If  the  plugin  needs to interact with the user, it may do so via the <b>conversation</b>() function.  A plugin
       should not attempt to read directly from the standard input or the  user's  tty  (neither  of  which  are
       guaranteed to exist).  The caller must include a trailing newline in <b>msg</b> if one is to be printed.

       A  <b>printf</b>()-style  function is also available that can be used to display informational or error messages
       to the user, which is usually more convenient for simple messages where no use input is required.

       <u>Conversation</u> <u>function</u> <u>structures</u>

       The conversation function takes as arguments pointers to the following structures:

       struct sudo_conv_message {
       #define SUDO_CONV_PROMPT_ECHO_OFF  0x0001 /* do not echo user input */
       #define SUDO_CONV_PROMPT_ECHO_ON   0x0002 /* echo user input */
       #define SUDO_CONV_ERROR_MSG        0x0003 /* error message */
       #define SUDO_CONV_INFO_MSG         0x0004 /* informational message */
       #define SUDO_CONV_PROMPT_MASK      0x0005 /* mask user input */
       #define SUDO_CONV_PROMPT_ECHO_OK   0x1000 /* flag: allow echo if no tty */
       #define SUDO_CONV_PREFER_TTY       0x2000 /* flag: use tty if possible */
           int msg_type;
           int timeout;
           const char *msg;
       };

       #define SUDO_CONV_REPL_MAX      1023

       struct sudo_conv_reply {
           char *reply;
       };

       typedef int (*sudo_conv_callback_fn_t)(int signo, void *closure);
       struct sudo_conv_callback {
           unsigned int version;
           void *closure;
           sudo_conv_callback_fn_t on_suspend;
           sudo_conv_callback_fn_t on_resume;
       };

       Pointers to the <b>conversation</b>() and <b>printf</b>()-style functions are passed in to the plugin's <b>open</b>() function
       when the plugin is initialized.  The following type definitions can be used in  the  declaration  of  the
       <b>open</b>() function:

       typedef int (*sudo_conv_t)(int num_msgs,
           const struct sudo_conv_message msgs[],
           struct sudo_conv_reply replies[], struct sudo_conv_callback *callback);

       typedef int (*sudo_printf_t)(int msg_type, const char *fmt, ...);

       To   use   the  <b>conversation</b>()  function,  the  plugin  must  pass  an  array  of  <b>sudo_conv_message</b>  and
       <b>sudo_conv_reply</b> structures.  There must be a <b>struct</b> <b>sudo_conv_message</b> and <b>struct</b> <b>sudo_conv_reply</b> for each
       message in the conversation, that is, both arrays must have the same number  of  elements.   Each  <b>struct</b>
       <b>sudo_conv_reply</b>  must  have its <u>reply</u> member initialized to NULL.  The <b>struct</b> <b>sudo_conv_callback</b> pointer,
       if not NULL, should contain function pointers to be called when the  <b>sudo</b>  process  is  suspended  and/or
       resumed  during  conversation  input.   The <u>on_suspend</u> and <u>on_resume</u> functions are called with the signal
       that caused <b>sudo</b> to be suspended and the <u>closure</u>  pointer  from  the  <b>struct</b>  <b>sudo_conv_callback</b>.   These
       functions  should  return  0  on  success  and  -1 on error.  On error, the conversation will end and the
       conversation function will return a value of -1.  The intended use is to  allow  the  plugin  to  release
       resources,  such  as  locks, that should not be held indefinitely while suspended and then reacquire them
       when the process is resumed.  Note that the functions are not  actually  invoked  from  within  a  signal
       handler.

       The <u>msg_type</u> must be set to one of the following values:

       SUDO_CONV_PROMPT_ECHO_OFF
             Prompt the user for input with echo disabled; this is generally used for passwords.  The reply will
             be stored in the <u>replies</u> array, and it will never be NULL.

       SUDO_CONV_PROMPT_ECHO_ON
             Prompt the user for input with echo enabled.  The reply will be stored in the <u>replies</u> array, and it
             will never be NULL.

       SUDO_CONV_ERROR_MSG
             Display   an   error   message.    The  message  is  written  to  the  standard  error  unless  the
             SUDO_CONV_PREFER_TTY flag is set, in which case it is written to the user's terminal if possible.

       SUDO_CONV_INFO_MSG
             Display a message.  The message is written to the standard output unless  the  SUDO_CONV_PREFER_TTY
             flag is set, in which case it is written to the user's terminal if possible.

       SUDO_CONV_PROMPT_MASK
             Prompt  the  user for input but echo an asterisk character for each character read.  The reply will
             be stored in the <u>replies</u> array, and it will never be NULL.  This can  be  used  to  provide  visual
             feedback to the user while reading sensitive information that should not be displayed.

       In addition to the above values, the following flag bits may also be set:

       SUDO_CONV_PROMPT_ECHO_OK
             Allow   input   to   be   read   when   echo   cannot   be   disabled  when  the  message  type  is
             SUDO_CONV_PROMPT_ECHO_OFF or SUDO_CONV_PROMPT_MASK.  By default, <b>sudo</b> will refuse to read input  if
             the echo cannot be disabled for those message types.

       SUDO_CONV_PREFER_TTY
             When  displaying  a message via SUDO_CONV_ERROR_MSG or SUDO_CONV_INFO_MSG, try to write the message
             to the user's terminal.  If the terminal is unavailable, the standard error or standard output will
             be used, depending upon whether SUDO_CONV_ERROR_MSG or SUDO_CONV_INFO_MSG  was  used.   The  user's
             terminal is always used when possible for input, this flag is only used for output.

       The  <u>timeout</u>  in  seconds until the prompt will wait for no more input.  A zero value implies an infinite
       timeout.

       The plugin is responsible for freeing the reply buffer located in each <b>struct</b> <b>sudo_conv_reply</b>, if  it  is
       not  NULL.   SUDO_CONV_REPL_MAX  represents  the  maximum  length  of the reply buffer (not including the
       trailing NUL character).  In practical terms, this is the longest password <b>sudo</b> will support.

       The <b>printf</b>()-style function uses the same underlying mechanism as the <b>conversation</b>()  function  but  only
       supports  SUDO_CONV_INFO_MSG  and  SUDO_CONV_ERROR_MSG  for  the  <u>msg_type</u>  parameter.   It  can  be more
       convenient than using the <b>conversation</b>() function if no  user  reply  is  needed  and  supports  standard
       <b>printf</b>() escape sequences.

       See the sample plugin for an example of the <b>conversation</b>() function usage.

   <b>Plugin</b> <b>invocation</b> <b>order</b>
       As of <b>sudo</b> 1.9.0, the plugin <b>open</b>() and <b>close</b>() functions are called in the following order:

       1.   audit open

       2.   policy open

       3.   approval open

       4.   approval close

       5.   I/O log open

       6.   command runs

       7.   command exits

       8.   I/O log close

       9.   policy close

       10.  audit close

       11.  sudo exits

       Prior to <b>sudo</b> 1.9.0, the I/O log <b>close</b>() function was called <u>after</u> the policy <b>close</b>() function.

   <b>Sudoers</b> <b>group</b> <b>plugin</b> <b>API</b>
       The  <b>sudoers</b>  plugin supports its own plugin interface to allow non-Unix group lookups.  This can be used
       to query a group source other than the standard Unix  group  database.   Two  sample  group  plugins  are
       bundled  with  <b>sudo</b>, <u>group_file</u>, and <u>system_group</u>, are detailed in <u><a href="../man5/sudoers.5.html">sudoers</a></u>(5).  Third party group plugins
       include a QAS AD plugin available from Quest Software.

       A group plugin must declare and populate  a  <b>sudoers_group_plugin</b>  struct  in  the  global  scope.   This
       structure  contains  pointers  to  the functions that implement plugin initialization, cleanup, and group
       lookup.

       struct sudoers_group_plugin {
           unsigned int version;
           int (*init)(int version, sudo_printf_t sudo_printf,
               char *const argv[]);
           void (*cleanup)(void);
           int (*query)(const char *user, const char *group,
               const struct passwd *pwd);
       };

       The <b>sudoers_group_plugin</b> struct has the following fields:

       version
             The <b>version</b> field should be set to GROUP_API_VERSION.

             This allows <b>sudoers</b> to determine the API version the group plugin was built against.

       init
             int (*init)(int version, sudo_printf_t plugin_printf,
                 char *const argv[]);

             The <b>init</b>() function is called after <u>sudoers</u> has been parsed  but  before  any  policy  checks.   It
             returns  1  on  success,  0  on  failure  (or  if  the plugin is not configured), and -1 if a error
             occurred.   If  an  error  occurs,  the  plugin  may  call  the   <b>plugin_printf</b>()   function   with
             SUDO_CONF_ERROR_MSG to present additional error information to the user.

             The function arguments are as follows:

             version
                   The  version  passed in by <b>sudoers</b> allows the plugin to determine the major and minor version
                   number of the group plugin API supported by <b>sudoers</b>.

             plugin_printf
                   A pointer to a <b>printf</b>()-style function that may be used to  display  informational  or  error
                   message to the user.  Returns the number of characters printed on success and -1 on failure.

             argv  A  NULL-terminated  array of arguments generated from the <u>group_plugin</u> option in <u>sudoers</u>.  If
                   no arguments were given, <u>argv</u> will be NULL.

       cleanup
             void (*cleanup)();

             The <b>cleanup</b>() function is called when <b>sudoers</b> has finished its group  checks.   The  plugin  should
             free any memory it has allocated and close open file handles.

       query
             int (*query)(const char *user, const char *group,
                 const struct passwd *pwd);

             The <b>query</b>() function is used to ask the group plugin whether <u>user</u> is a member of <u>group</u>.

             The function arguments are as follows:

             user  The name of the user being looked up in the external group database.

             group
                   The name of the group being queried.

             pwd   The  password  database  entry  for  <u>user</u>,  if  any.   If <u>user</u> is not present in the password
                   database, <u>pwd</u> will be NULL.

       <u>Group</u> <u>API</u> <u>Version</u> <u>Macros</u>

       /* Sudoers group plugin version major/minor */
       #define GROUP_API_VERSION_MAJOR 1
       #define GROUP_API_VERSION_MINOR 0
       #define GROUP_API_VERSION ((GROUP_API_VERSION_MAJOR &lt;&lt; 16) | \
                                  GROUP_API_VERSION_MINOR)
       For getters and setters see the “Policy plugin API”.

</pre><h4><b>PLUGIN</b> <b>API</b> <b>CHANGELOG</b></h4><pre>
       The following revisions have been made to the Sudo Plugin API.

       Version 1.0
             Initial API version.

       Version 1.1 (sudo 1.8.0)
             The I/O logging plugin's <b>open</b>() function was modified to take the <b>command_info</b> list as an argument.

       Version 1.2 (sudo 1.8.5)
             The Policy and I/O logging plugins' <b>open</b>() functions are now passed a list of plugin parameters  if
             any are specified in <u><a href="../man5/sudo.conf.5.html">sudo.conf</a></u>(5).

             A  simple  hooks  API  has  been introduced to allow plugins to hook in to the system's environment
             handling functions.

             The <b>init_session</b> Policy plugin function is now passed a pointer to the user environment  which  can
             be  updated as needed.  This can be used to merge in environment variables stored in the PAM handle
             before a command is run.

       Version 1.3 (sudo 1.8.7)
             Support for the <u>exec_background</u> entry has been added to the <b>command_info</b> list.

             The <u>max_groups</u> and <u>plugin_dir</u> entries were added to the <b>settings</b> list.

             The <b>version</b>() and <b>close</b>() functions are now optional.  Previously, a missing <b>version</b>()  or  <b>close</b>()
             function  would  result  in  a  crash.   If no policy plugin <b>close</b>() function is defined, a default
             <b>close</b>() function will be provided by the <b>sudo</b> front-end that displays  a  warning  if  the  command
             could not be executed.

             The  <b>sudo</b>  front-end  now  installs default signal handlers to trap common signals while the plugin
             functions are run.

       Version 1.4 (sudo 1.8.8)
             The <u>remote_host</u> entry was added to the <b>settings</b> list.

       Version 1.5 (sudo 1.8.9)
             The <u>preserve_fds</u> entry was added to the <b>command_info</b> list.

       Version 1.6 (sudo 1.8.11)
             The behavior when an I/O logging plugin returns an error (-1) has changed.   Previously,  the  <b>sudo</b>
             front-end  took  no  action  when  the  <b>log_ttyin</b>(),  <b>log_ttyout</b>(),  <b>log_stdin</b>(),  <b>log_stdout</b>(), or
             <b>log_stderr</b>() function returned an error.

             The behavior when an I/O logging plugin returns 0 has changed.  Previously, output from the command
             would be displayed to the terminal even if an output logging function returned 0.

       Version 1.7 (sudo 1.8.12)
             The <u>plugin_path</u> entry was added to the <b>settings</b> list.

             The <u>debug_flags</u> entry now starts with a debug file path name and may occur multiple times if  there
             are multiple plugin-specific Debug lines in the <u><a href="../man5/sudo.conf.5.html">sudo.conf</a></u>(5) file.

       Version 1.8 (sudo 1.8.15)
             The <u>sudoedit_checkdir</u> and <u>sudoedit_follow</u> entries were added to the <b>command_info</b> list.  The default
             value of <u>sudoedit_checkdir</u> was changed to true in sudo 1.8.16.

             The  sudo  <u>conversation</u>  function  now takes a pointer to a <b>struct</b> <b>sudo_conv_callback</b> as its fourth
             argument.  The <b>sudo_conv_t</b> definition has been updated to match.  The plugin must specify  that  it
             supports  plugin API version 1.8 or higher to receive a conversation function pointer that supports
             this argument.

       Version 1.9 (sudo 1.8.16)
             The <u>execfd</u> entry was added to the <b>command_info</b> list.

       Version 1.10 (sudo 1.8.19)
             The <u>umask</u> entry was added to the <b>user_info</b>  list.   The  <u>iolog_group</u>,  <u>iolog_mode</u>,  and  <u>iolog_user</u>
             entries were added to the <b>command_info</b> list.

       Version 1.11 (sudo 1.8.20)
             The <u>timeout</u> entry was added to the <b>settings</b> list.

       Version 1.12 (sudo 1.8.21)
             The <b>change_winsize</b> field was added to the io_plugin struct.

       Version 1.13 (sudo 1.8.26)
             The <b>log_suspend</b> field was added to the io_plugin struct.

       Version 1.14 (sudo 1.8.29)
             The <u>umask_override</u> entry was added to the <b>command_info</b> list.

       Version 1.15 (sudo 1.9.0)
             The <u>cwd_optional</u> entry was added to the <b>command_info</b> list.

             The <u>event_alloc</u> field was added to the policy_plugin and io_plugin structs.

             The  <u>errstr</u> argument was added to the policy and I/O plugin functions which the plugin function can
             use to return an error string.  This string may be used by the audit plugin to  report  failure  or
             error conditions set by the other plugins.

             The <b>close</b>() function is now is called regardless of whether or not a command was actually executed.
             This makes it possible for plugins to perform cleanup even when a command was not run.

             SUDO_CONV_REPL_MAX has increased from 255 to 1023 bytes.

             Support for audit and approval plugins was added.

       Version 1.16 (sudo 1.9.3)
             Initial resource limit values were added to the <b>user_info</b> list.

             The <u>cmnd_chroot</u> and <u>cmnd_cwd</u> enties were added to the <b>settings</b> list.

       Version 1.17 (sudo 1.9.4)
             The <u>event_alloc</u> field was added to the audit_plugin and approval_plugin structs.

       Version 1.18 (sudo 1.9.9)
             The policy may now set resource limit values in the <b>command_info</b> list.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man5/sudo.conf.5.html">sudo.conf</a></u>(5), <u><a href="../man5/sudoers.5.html">sudoers</a></u>(5), <u><a href="../man8/sudo.8.html">sudo</a></u>(8)

</pre><h4><b>AUTHORS</b></h4><pre>
       Many people have worked on <b>sudo</b> over the years; this version consists of code written primarily by:

             Todd C. Miller

       See  the  CONTRIBUTORS  file  in  the  <b>sudo</b>  distribution  (https://www.sudo.ws/contributors.html) for an
       exhaustive list of people who have contributed to <b>sudo</b>.

</pre><h4><b>BUGS</b></h4><pre>
       If you feel you have found a bug in <b>sudo</b>, please submit a bug report at https://bugzilla.sudo.ws/

</pre><h4><b>SUPPORT</b></h4><pre>
       Limited    free    support    is    available    via     the     sudo-users     mailing     list,     see
       https://www.sudo.ws/mailman/listinfo/sudo-users to subscribe or search the archives.

</pre><h4><b>DISCLAIMER</b></h4><pre>
       <b>sudo</b>  is  provided  “AS  IS”  and  any  express or implied warranties, including, but not limited to, the
       implied warranties of merchantability and fitness for a  particular  purpose  are  disclaimed.   See  the
       LICENSE file distributed with <b>sudo</b> or https://www.sudo.ws/license.html for complete details.

Sudo 1.9.9                                      January 20, 2022                                  <u><a href="../man5/SUDO_PLUGIN.5.html">SUDO_PLUGIN</a></u>(5)
</pre>
 </div>
</div></section>
</div>
</body>
</html>