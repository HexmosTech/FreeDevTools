---
import {
  getClusters,
  getIconsByCluster,
  getTotalIcons,
} from 'db/png_icons/png-icons-utils';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PngIcons from './_PngIcons.astro';

export const prerender = false;

const { page } = Astro.params;
const urlPath = Astro.url.pathname;

// Early return if no page param
if (!page) {
  return new Response(null, { status: 404 });
}

let categoryData: any = null;
let paginationData: any = null;

// Check if page param is numeric
if (!/^\d+$/.test(page)) {
  // If not numeric, it might be a category name
  // Redirect to add trailing slash if missing (BEFORE checking category)
  if (!urlPath.endsWith('/')) {
    return Astro.redirect(`${urlPath}/`, 301);
  }

  // Check if it's a valid category
  const clusters = getClusters();
  const categoryNames = clusters.map((cluster) => cluster.name);
  const isCategory = categoryNames.includes(page);

  if (isCategory) {
    // This is a category route - redirect to category page
    return Astro.redirect(`/freedevtools/png_icons/${page}/`, 301);
  } else {
    // Not a valid category or page number - 404
    return new Response(null, { status: 404 });
  }
} else {
  // Handle pagination route
  const currentPage = parseInt(page, 10);

  // Redirect /png_icons/1 to /png_icons
  if (currentPage === 1) {
    return Astro.redirect('/freedevtools/png_icons/');
  }

  // Fetch categories data directly (SSR mode)
  const clusters = getClusters();
  const allCategories = clusters.map((cluster) => {
    const icons = getIconsByCluster(cluster.source_folder || cluster.name);
    return {
      id: cluster.source_folder || cluster.name,
      name: cluster.name,
      description: cluster.description,
      icon: `/freedevtools/png_icons/${cluster.name}/`,
      iconCount: icons.length,
      url: `/freedevtools/png_icons/${cluster.name}/`,
      keywords: cluster.keywords,
      features: cluster.tags,
      fileNames: icons.map((icon) => icon.name),
    };
  });

  const itemsPerPage = 30;
  const totalPages = Math.ceil(allCategories.length / itemsPerPage);

  // Validate page number
  if (currentPage > totalPages || currentPage < 1) {
    return new Response(null, { status: 404 });
  }

  const totalCategories = allCategories.length;
  const totalPngIcons = getTotalIcons();

  // Get categories for current page
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentPageCategories = allCategories.slice(startIndex, endIndex);

  // Breadcrumb data
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'PNG Icons', href: '/freedevtools/png_icons/' },
    { label: `Page ${currentPage}` },
  ];

  // SEO data
  const seoTitle = `Free PNG Icons - Page ${currentPage} | Online Free DevTools by Hexmos | No Registration Required`;
  const seoDescription = `Page ${currentPage} of ${totalPages} in our PNG icon archive. Get free vector icons with fast, no-login downloads.`;
  const canonical = `https://hexmos.com/freedevtools/png_icons/${currentPage}/`;

  // Enhanced keywords for paginated content
  const paginatedKeywords = [
    'png icons',
    'vector graphics',
    'free icons',
    'download icons',
    'edit icons',
    `page ${currentPage}`,
    'pagination',
    'icon collection',
    'vector graphics library',
  ];

  paginationData = {
    currentPage,
    totalPages,
    totalCategories,
    totalPngIcons,
    categories: currentPageCategories,
    breadcrumbItems,
    seoTitle,
    seoDescription,
    canonical,
    paginatedKeywords,
    itemsPerPage,
  };
}
---

{
  paginationData ? (
    <BaseLayout
      name="PNG Icons"
      path={`/freedevtools/png_icons/${paginationData.currentPage}/`}
      title={paginationData.seoTitle}
      description={paginationData.seoDescription}
      canonical={paginationData.canonical}
      showHeader={true}
      totalItems={paginationData.totalCategories}
      itemsPerPage={paginationData.itemsPerPage}
      currentPage={paginationData.currentPage}
      category="PNG Icons"
      partOf="Free DevTools"
      partOfUrl="https://hexmos.com/freedevtools/"
      keywords={paginationData.paginatedKeywords}
      features={[
        'Download',
        'Edit colors',
        'Add backgrounds',
        'Customize',
        'No registration',
      ]}
    >
      <PngIcons
        categories={paginationData.categories}
        currentPage={paginationData.currentPage}
        totalPages={paginationData.totalPages}
        totalCategories={paginationData.totalCategories}
        totalPngIcons={paginationData.totalPngIcons}
        breadcrumbItems={paginationData.breadcrumbItems}
      />
    </BaseLayout>
  ) : null
}
