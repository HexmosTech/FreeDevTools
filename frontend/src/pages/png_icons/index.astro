---
import {
  getClusters,
  getClustersWithPreviewIcons,
  getTotalIcons,
} from 'db/png_icons/png-icons-utils';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PngIcons from './_PngIcons.astro';

// Track request start time
const requestStartTime = Date.now();
const requestPath = Astro.url.pathname;
console.log(`[PNG_ICONS] Request reached server: ${requestPath} at ${new Date().toISOString()}`);

// Pagination logic for page 1
const itemsPerPage = 30;
const currentPage = 1;

// Get total count of clusters for pagination (single query)
const totalClustersQueryStartTime = Date.now();
const allClusters = getClusters();
const totalCategories = allClusters.length;
const totalClustersQueryEndTime = Date.now();
console.log(`[PNG_ICONS] getClusters() for count took ${totalClustersQueryEndTime - totalClustersQueryStartTime}ms`);

// Get paginated clusters with preview icons in ONE optimized query
const categoriesWithIcons = getClustersWithPreviewIcons(currentPage, itemsPerPage, 6);

// Transform to match expected format
const categories = categoriesWithIcons.map((cluster) => {
  return {
    id: cluster.source_folder || cluster.name,
    name: cluster.name,
    description: cluster.description,
    icon: `/freedevtools/png_icons/${cluster.name}/`,
    iconCount: cluster.count,
    url: `/freedevtools/png_icons/${cluster.name}/`,
    keywords: cluster.keywords,
    features: cluster.tags,
    previewIcons: cluster.previewIcons, // Include preview icons
  };
});

const totalPages = Math.ceil(totalCategories / itemsPerPage);

// Calculate total PNG icons across all categories
const totalIconsQueryStartTime = Date.now();
const totalPngIcons = getTotalIcons();
const totalIconsQueryEndTime = Date.now();
console.log(`[PNG_ICONS] getTotalIcons() took ${totalIconsQueryEndTime - totalIconsQueryStartTime}ms`);

// Log total roundtrip time
const requestEndTime = Date.now();
const totalRoundtripTime = requestEndTime - requestStartTime;
console.log(`[PNG_ICONS] Total roundtrip time for ${requestPath}: ${totalRoundtripTime}ms`);

// Breadcrumb data
const breadcrumbItems = [
  { label: 'Free DevTools', href: '/freedevtools/' },
  { label: 'PNG Icons' },
];

// SEO data
const seoTitle =
  currentPage === 1
    ? 'Free PNG Icons - Download Vector Graphics | Online Free DevTools by Hexmos | No Registration Required'
    : `Free PNG Icons - Page ${currentPage} | Online Free DevTools by Hexmos | No Registration Required`;

const seoDescription =
  currentPage === 1
    ? `Download 50k+ free PNG icons instantly. High quality, no registration required.`
    : `Page ${currentPage} of ${totalPages} in our PNG icon archive. Get free vector icons with fast, no-login downloads.`;

const canonical =
  currentPage === 1
    ? 'https://hexmos.com/freedevtools/png_icons/'
    : `https://hexmos.com/freedevtools/png_icons/${currentPage}/`;

// Enhanced keywords for main page
const mainKeywords = [
  'png icons',
  'vector graphics',
  'free icons',
  'download icons',
  'edit icons',
  'icon library',
  'vector graphics library',
  'png download',
  'free vector icons',
  'customizable icons',
];
---

<BaseLayout
  name="PNG Icons"
  path={currentPage === 1
    ? '/freedevtools/png_icons/'
    : `/freedevtools/png_icons/${currentPage}/`}
  title={seoTitle}
  description={seoDescription}
  canonical={canonical}
  showHeader={true}
  totalItems={totalCategories}
  itemsPerPage={itemsPerPage}
  currentPage={currentPage}
  category="PNG Icons"
  partOf="Free DevTools"
  partOfUrl="https://hexmos.com/freedevtools/"
  keywords={mainKeywords}
  features={['Download', 'No registration', 'High quality']}
>
  <PngIcons
    categories={categories}
    currentPage={currentPage}
    totalPages={totalPages}
    totalCategories={totalCategories}
    totalPngIcons={totalPngIcons}
    breadcrumbItems={breadcrumbItems}
  />
</BaseLayout>
