---
import {
  getClusterByName,
  getClusters,
  getIconsByCluster,
} from 'db/png_icons/png-icons-utils';
import AdBanner from '../../components/banner/AdBanner.astro';
import CreditsButton from '../../components/buttons/CreditsButton';
import ToolContainer from '../../components/tool/ToolContainer';
import ToolHead from '../../components/tool/ToolHead';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const clusters = getClusters();

  // Use cluster names for URLs (these match cluster_svg.json cluster.name)
  const categories = clusters.map((cluster) => cluster.name);

  return categories.map((category) => ({
    params: { category },
    props: { category },
  }));
}

const { category } = Astro.params;

// Function to get random content based on category name
function getPngCategoryContent(categoryName: string) {
  // Simple hash function to deterministically select variant based on category name
  function hashString(str: string): number {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = (hash << 5) - hash + char;
      hash = hash & hash; // Convert to 32-bit integer
    }
    return Math.abs(hash);
  }

  const hash = hashString(categoryName);
  const aboutIndex = hash % 5;
  const listicleIndex = (hash >> 8) % 5; // Use different part of hash for listicle

  const aboutVariants = [
    `PNG (Portable Network Graphics) icons are raster images perfect for web design, presentations, and applications. These ${categoryName} PNG icons are ready-to-use with transparent backgrounds, making them ideal for overlaying on any design. Download high-quality ${categoryName} PNG icons instantly, no conversion needed.`,
    `Discover professional ${categoryName} PNG icons designed for modern digital projects. These raster graphics feature transparent backgrounds and high resolution, ensuring crisp visuals at any size. Perfect for websites, mobile apps, and marketing materials. Get ${categoryName} PNG icons ready to download immediately.`,
    `Enhance your projects with premium ${categoryName} PNG icons. These Portable Network Graphics files offer lossless compression and alpha channel transparency, making them versatile for any design context. Browse our collection of ${categoryName} PNG icons and download instantly without registration.`,
    `Our ${categoryName} PNG icon collection provides high-quality raster graphics optimized for digital use. Each icon features a transparent background and is optimized for web performance. Whether you're building websites, apps, or presentations, these ${categoryName} PNG icons are ready to use right away.`,
    `Get access to professionally crafted ${categoryName} PNG icons with full transparency support. These raster images are perfect for designers and developers who need pixel-perfect graphics. Download ${categoryName} PNG icons in high resolution, compatible with all major design tools and platforms.`,
  ];

  const listicleVariants = [
    [
      'Transparent backgrounds for easy integration',
      'High-quality raster format perfect for web use',
      'No conversion needed - ready to use immediately',
      'Compatible with all design software and browsers',
    ],
    [
      'Lossless compression maintains image quality',
      'Alpha channel transparency supports complex overlays',
      'Optimized file sizes for faster page loads',
      'Works seamlessly across all platforms and devices',
    ],
    [
      'Pixel-perfect graphics at any display size',
      'No vector conversion required - use as-is',
      'Ideal for web graphics and digital marketing',
      'Supports millions of colors for rich visuals',
    ],
    [
      'Instant download without registration or signup',
      'Professional quality suitable for commercial use',
      'Transparent backgrounds enable flexible design',
      'Compatible with Photoshop, Figma, and other tools',
    ],
    [
      'High-resolution images for crisp displays',
      'Ready-to-use format saves time and effort',
      'Perfect for icons, logos, and UI elements',
      'Free to use in personal and commercial projects',
    ],
  ];

  return {
    about: aboutVariants[aboutIndex],
    listicle: listicleVariants[listicleIndex],
  };
}

async function getCategoryIcons() {
  // Get icons from SQLite database
  // The category parameter is the cluster display name (from cluster.name in cluster_svg.json)
  // Look up cluster by display name to get the source_folder (actual folder name used in icon table)
  const clusterData = getClusterByName(category);

  if (!clusterData) {
    return [];
  }

  // The icon table uses cluster key (folder name = source_folder), not display name
  // Use source_folder to query icons
  const dbIcons = getIconsByCluster(clusterData.source_folder || category);

  const icons = dbIcons.map((icon) => {
    const iconName = icon.name.replace('.svg', '');

    return {
      name: iconName,
      description: icon.description || `Free ${iconName} icon`,
      category: category,
      tags: icon.tags || [],
      author: 'Free DevTools',
      license: 'MIT',
      url: `/freedevtools/png_icons/${category}/${iconName}/`,
      base64: icon.base64,
    };
  });

  return icons;
}

const categoryIcons = await getCategoryIcons();
const totalIcons = categoryIcons.length;

// Get randomized content for this category
const pngContent = getPngCategoryContent(category);

// Breadcrumb data
const breadcrumbItems = [
  { label: 'Free DevTools', href: '/freedevtools/' },
  { label: 'PNG Icons', href: '/freedevtools/png_icons/' },
  { label: category },
];
---

<BaseLayout
  name={`${category.charAt(0).toUpperCase() + category.slice(1)} PNG Icons`}
  path={`/freedevtools/png_icons/${category}`}
  title={`Free ${category} PNG Icons | Online Free DevTools by Hexmos`}
  description={`Browse & download free ${category} PNG icons instantly. ${totalIcons} icons available.`}
  canonical={`https://hexmos.com/freedevtools/png_icons/${category}/`}
  showHeader={true}
  totalItems={totalIcons}
  category={category}
  partOf="PNG Icons"
  partOfUrl="https://hexmos.com/freedevtools/png_icons/"
  keywords={[
    category,
    'png icons',
    'raster images',
    'transparent png',
    'web graphics',
    'free icons',
  ]}
>
  <ToolContainer>
    <div id={`png-icon-ad-banner-${category}`} class="mb-16 mt-[74px]">
      <AdBanner />
    </div>
    <ToolHead
      id={`png-icon-tool-head-${category}`}
      name={`${category.charAt(0).toUpperCase() + category.slice(1)} PNG Icons Collection`}
      description={`Browse ${totalIcons} ready-to-use ${category} images, instantly downloadable without restrictions`}
      breadcrumbItems={breadcrumbItems}
    />

    <div id={`png-icon-main-section-${category}`} class="min-h-[200px]">
      <div
        id={`png-icon-grid-${category}`}
        class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-6 mb-8 mt-3"
      >
        {
          categoryIcons.map((icon) => {
            const iconName = icon.name
              .replace(/_/g, ' ')
              .replace(/\b\w/g, (l: string) => l.toUpperCase());

            return (
              <a
                href={icon.url}
                class="bg-white rounded-lg p-4 cursor-pointer hover:bg-slate-100 border border-white hover:border-slate-300 transition-all duration-200 shadow-sm hover:shadow-md"
                title={iconName + 'PNG'}
              >
                <div class="flex flex-col items-center text-center">
                  <div class="w-24 h-24 flex items-center justify-center">
                    <div
                      class="w-24 h-24 text-slate-600"
                      style="display: flex; align-items: center; justify-content: center; overflow: hidden;"
                    >
                      <img
                        src={`data:image/png;base64,${icon.base64}`}
                        alt={`${iconName} PNG icon in ${category} category`}
                        class="w-20 h-20 object-contain"
                        loading="lazy"
                      />
                    </div>
                  </div>
                </div>
              </a>
            );
          })
        }
      </div>
    </div>
    <!-- Unique informational content about PNG icons -->
    <div
      id={`png-icon-about-section-${category}`}
      class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800"
    >
      <h2 id={`png-icon-about-section-title-${category}`} class="mb-2">
        About PNG Icons
      </h2>
      <p>
        {pngContent.about}
      </p>
    </div>

    <!-- PNG-specific features section -->
    <div
      id={`png-icon-features-section-${category}`}
      class="mt-8 p-6 bg-slate-50 dark:bg-slate-800 rounded-lg"
    >
      <h3
        id={`png-icon-features-section-title-${category}`}
        class="text-md font-semibold mb-3"
      >
        Why Choose our PNG Icons?
      </h3>
      <ul
        class="list-disc list-inside space-y-2 text-sm text-slate-700 dark:text-slate-300"
      >
        {pngContent.listicle.map((item) => <li>{item}</li>)}
      </ul>
    </div>
    <!-- Credits Section -->
    <div
      id={`png-icon-credits-section-${category}`}
      class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700"
    >
      <div
        id={`png-icon-credits-content-${category}`}
        class="flex flex-wrap gap-4"
      >
        <a
          href="/freedevtools/png_icons/"
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
        >
          ‚Üê Back to PNG Icons
        </a>
        <CreditsButton
          href="/freedevtools/png_icons/credits/"
          id={`png-icon-credits-button-${category}`}
        />
      </div>
    </div>
  </ToolContainer>
</BaseLayout>

<style>
  .icon-preview svg {
    width: 100% !important;
    height: 100% !important;
    max-width: 104px;
    max-height: 104px;
    display: block;
    object-fit: contain;
  }
</style>
