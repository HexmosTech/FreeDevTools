---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import Pagination from '../../../../components/PaginationComponent.astro';
import CreditsButton from '../../../../components/buttons/CreditsButton';
import ToolContainer from '../../../../components/tool/ToolContainer';
import ToolHead from '../../../../components/tool/ToolHead';
import { getEmojisByCategory, getEmojiCategories, fetchLatestAppleImage } from '../../../../lib/emojis';
import AdBanner from '../../../../components/banner/AdBanner.astro';

export const prerender = false;

const { category: categorySlug, page } = Astro.params;
const urlPath = Astro.url.pathname;

// Handle trailing slash redirect FIRST (before any logic)
if (!urlPath.endsWith('/')) {
  return Astro.redirect(`${urlPath}/`, 301);
}

// Validate page is numeric
if (!page || !/^\d+$/.test(page)) {
  return new Response(null, { status: 404 });
}

const currentPage = parseInt(page, 10);

// Validate category exists
const allCategories = getEmojiCategories();
const categorySlugs = allCategories.map(cat => cat.toLowerCase().replace(/[^a-z0-9]+/g, '-'));

if (!categorySlug || !categorySlugs.includes(categorySlug)) {
  return new Response(null, { status: 404 });
}

// Find the actual category name from the slug
const categoryName = allCategories.find(
  cat => cat.toLowerCase().replace(/[^a-z0-9]+/g, '-') === categorySlug
) || categorySlug.replace(/-/g, ' ').replace(/\b\w/g, (l: string) => l.toUpperCase());

const categorySeo: Record<string, { title: string; description: string; keywords: string[] }> = {
  'Activities': {
    title: 'Apple Vendor Activities Emojis - Sports, Events & Hobbies | Free DevTools by Hexmos',
    description: 'Browse Apple-style activities emojis including sports, games, celebrations, and hobbies. Copy emoji and view meanings instantly.',
    keywords: ['apple emojis', 'activities emojis', 'sports', 'games', 'celebration', 'hobby', 'copy emoji']
  },
  'Animals & Nature': {
    title: 'Apple Vendor Animals & Nature Emojis - Wildlife, Plants & Weather | Free DevTools by Hexmos',
    description: 'Explore Apple-style animals and nature emojis featuring wildlife, plants, and weather icons. Copy emoji and view meanings instantly.',
    keywords: ['apple emojis', 'animals', 'nature', 'wildlife', 'plants', 'weather', 'copy emoji']
  },
  'Food & Drink': {
    title: 'Apple Vendor Food & Drink Emojis - Meals & Beverages | Free DevTools by Hexmos',
    description: 'Discover Apple-style food and drink emojis for meals, beverages, and snacks. Copy emoji and find meanings instantly.',
    keywords: ['apple emojis', 'food', 'drink', 'meals', 'beverages', 'snacks', 'copy emoji']
  },
  'People & Body': {
    title: 'Apple Vendor People & Body Emojis - Faces & Gestures | Free DevTools by Hexmos',
    description: 'Explore Apple-style people and body emojis including faces, gestures, and family members. Copy emoji and view meanings instantly.',
    keywords: ['apple emojis', 'people', 'faces', 'gestures', 'body', 'copy emoji']
  },
  'Smileys & Emotion': {
    title: 'Apple Vendor Smileys & Emotion Emojis - Faces & Feelings | Free DevTools by Hexmos',
    description: 'Find Apple-style smileys and emotion emojis that express feelings and moods. Copy emoji and view meanings instantly.',
    keywords: ['apple emojis', 'smileys', 'emotions', 'faces', 'feelings', 'copy emoji']
  },
  'Flags': {
    title: 'Apple Vendor Flag Emojis - Country & Regional Flags | Free DevTools by Hexmos',
    description: 'Browse Apple-style flag emojis featuring country, regional, and pride flags. Copy emoji and view meanings instantly.',
    keywords: ['apple emojis', 'flags', 'country flags', 'regional flags', 'copy emoji']
  }
};

const seoData = categorySeo[categoryName] || {
  title: `Apple Vendor ${categoryName} Emojis | Free DevTools by Hexmos`,
  description: `Explore Apple-style ${categoryName.toLowerCase()} emojis. Copy emoji and view meanings instantly.`,
  keywords: [`apple ${categoryName.toLowerCase()} emojis`, 'copy emoji', 'emoji meanings']
};

// const emojis = await getEmojisByCategory(categoryName, "apple");
const emojis = (await getEmojisByCategory(categoryName, "apple"))
  .map(e => ({
    ...e,
    latestAppleImage: fetchLatestAppleImage(e.slug)
  }));

const totalEmojis = emojis.length;

const itemsPerPage = 36;
const totalPages = Math.ceil(totalEmojis / itemsPerPage);
const startIndex = (currentPage - 1) * itemsPerPage;
const endIndex = startIndex + itemsPerPage;
const paginatedEmojis = emojis.slice(startIndex, endIndex);

const breadcrumbItems = [
  { label: 'Free DevTools', href: '/freedevtools/' },
  { label: 'Emojis', href: '/freedevtools/emojis/' },
  { label: 'Apple Emojis', href: '/freedevtools/emojis/apple-emojis/' },
  { label: categoryName, href: `/freedevtools/emojis/apple-emojis/${categorySlug}/` }
];
---

<BaseLayout 
  name={categoryName}
  path={`/emojis/apple-emojis/${categorySlug}/`}
  title={seoData.title}
  description={seoData.description}
  canonical={`https://hexmos.com/freedevtools/emojis/apple-emojis/${categorySlug}/${currentPage}/`}
  keywords={seoData.keywords}
  showHeader={true}
  totalItems={totalEmojis}
  features={["Copy Apple-style emojis", "View meanings", "Free access", "No signup required"]}
  emojiCategory={categoryName}
>
  <ToolContainer>
    <div class="mb-16 mt-[74px]">
      <AdBanner />
    </div>

    <ToolHead
      name={`Apple ${categoryName} Emojis`}
      description={seoData.description}
      breadcrumbItems={breadcrumbItems}
    />

    <!-- Overview Stats -->
    <div id="pagination-info" class="text-center mb-8">
      <div class="grid grid-cols-2 gap-6 mt-8">
        <div class="text-center">
          <div class="text-3xl font-bold text-blue-600">{totalEmojis.toLocaleString()}</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Emojis</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-green-600">{totalPages}</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Pages</div>
        </div>
      </div>
    </div>

    <div class="bg-slate-50 dark:bg-slate-800 rounded-lg p-4 mb-6 mt-8">
      <div class="text-sm text-slate-600 dark:text-slate-400 text-center">
        Showing {paginatedEmojis.length} of {totalEmojis} emojis (Page {currentPage} of {totalPages})
      </div>
    </div>

    <!-- Emojis Grid -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4 mb-8">
        {paginatedEmojis.map((emoji) => {
          const emojiChar = emoji.code || '';
          const graphemeCount = [...emojiChar].length;
          const zwjCount = (emojiChar.match(/\u200d/g) || []).length;
          const complexity = graphemeCount + zwjCount * 2;
          let emojiSizeClass = 'h-10 w-10';
  
          if (complexity > 10) emojiSizeClass = 'h-6 w-6';
          else if (complexity > 6) emojiSizeClass = 'h-8 w-8';
  
          return (
            <a
              href={`/freedevtools/emojis/apple-emojis/${emoji.slug}/`}
              class="emoji-card bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-4 text-center hover:shadow-lg transition-all duration-200 cursor-pointer block"
              data-emoji={emojiChar}
              data-title={emoji.title}
            >
              <div class="mb-2 select-none">
                {emoji.latestAppleImage ? (
                  <img
                    src={emoji.latestAppleImage}
                    alt={emoji.title || emoji.slug}
                    class={`mx-auto ${emojiSizeClass}`}
                    loading="lazy"
                    decoding="async"
                    draggable="false"
                    onError={(e) => (e.currentTarget.style.display = 'none')}
                  />
                ) : (
                  <div class="text-4xl">{emojiChar}</div>
                )}
              </div>
              <div class="text-xs text-slate-600 dark:text-slate-400 truncate" title={emoji.title}>
                {emoji.title}
              </div>
            </a>
          );
        })}
      </div>
  

    <Pagination 
      currentPage={currentPage}
      totalPages={totalPages}
      baseUrl={`/freedevtools/emojis/apple-emojis/${categorySlug}/`}
    />

    <div class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700">
      <div class="flex flex-wrap gap-4">
        <a 
          href="/freedevtools/emojis/apple-emojis/" 
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
        >
          ‚Üê  Back to Apple Emojis
        </a>
        <CreditsButton href="/freedevtools/emojis/credits/" />
      </div>
    </div>
  </ToolContainer>
</BaseLayout>

<script>
  if (window.location.hash === '#pagination-info') {
    const paginationInfo = document.getElementById('pagination-info');
    if (paginationInfo) paginationInfo.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
</script>
