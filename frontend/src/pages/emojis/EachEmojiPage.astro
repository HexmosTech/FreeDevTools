---
import Banner from '../../components/banner/Banner.astro';
import SeeAlsoIndex from '../../components/seealso/SeeAlsoIndex.astro';
import type { EmojiData, EmojiImageVariants } from '../../lib/emojis';
import {
  CopyButtons,
  ImageVariants,
  ShortcodesTable,
} from './_EmojiComponents';

interface Props {
  emoji: EmojiData;
  images: EmojiImageVariants;
}

const { emoji, images } = Astro.props;

// Defensive check for emoji
if (!emoji) {
  return Astro.redirect('/freedevtools/emojis/');
}

// Prefer primary code, then Fluent UI glyph, then top-level glyph found in some sources
const emojiChar = (emoji.code ||
  emoji.fluentui_metadata?.glyph ||
  (emoji as any).glyph ||
  '') as string;

const cleanDescription = (text?: string) => {
  if (!text) return '';
  return text
    .replace(/<[^>]*>/g, '')
    .replace(/&nbsp;/g, ' ')
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/[?]{2,}/g, '')
    .trim();
};

// Recursively collect strings for a given key anywhere in a nested object
function collectNestedStrings(data: unknown, keys: string[]): string[] {
  const results: string[] = [];
  const visit = (node: unknown) => {
    if (!node) return;
    if (Array.isArray(node)) {
      node.forEach(visit);
    } else if (typeof node === 'object') {
      const obj = node as Record<string, unknown>;
      for (const k of Object.keys(obj)) {
        if (keys.includes(k)) {
          const val = obj[k];
          if (Array.isArray(val)) {
            // Array of strings or array of { id: [strings] }
            (val as unknown[]).forEach((item) => {
              if (typeof item === 'string') results.push(item);
              else if (item && typeof item === 'object') {
                Object.values(item as Record<string, unknown>).forEach((v) => {
                  if (Array.isArray(v))
                    (v as unknown[]).forEach((s) => {
                      if (typeof s === 'string') results.push(s);
                    });
                  else if (typeof v === 'string') results.push(v);
                });
              }
            });
          } else if (typeof val === 'string') {
            results.push(val);
          }
        }
        visit(obj[k]);
      }
    }
  };
  visit(data);
  return Array.from(new Set(results));
}

const getImageVariants = () => {
  const variants: Array<{ type: string; url: string }> = [];
  if (images && typeof images === 'object') {
    if (images['3d'] && typeof images['3d'] === 'string')
      variants.push({ type: '3D', url: images['3d'] });
    if (images['color'] && typeof images['color'] === 'string')
      variants.push({ type: 'Color', url: images['color'] });
    if (images['flat'] && typeof images['flat'] === 'string')
      variants.push({ type: 'Flat', url: images['flat'] });
    if (images['high_contrast'] && typeof images['high_contrast'] === 'string')
      variants.push({ type: 'High Contrast', url: images['high_contrast'] });
  }
  return variants;
};

const imageVariants = getImageVariants();

// Type guard for shortcode validation
function isValidShortcode(shortcode: any): shortcode is {
  code: string;
  vendor: { title: string };
} {
  return (
    shortcode &&
    typeof shortcode === 'object' &&
    typeof shortcode.code === 'string' &&
    shortcode.code.length > 0 &&
    shortcode.vendor &&
    typeof shortcode.vendor === 'object' &&
    typeof shortcode.vendor.title === 'string'
  );
}

const allShortcodes = (emoji.shortcodes || []).filter(
  (s): s is NonNullable<typeof s> => s != null
);
const validShortcodes = allShortcodes.filter(isValidShortcode);
const uniqueShortcodes = validShortcodes.filter((shortcode, index, array) => {
  const foundIndex = array.findIndex(
    (s) => s && s.code && shortcode.code && s.code === shortcode.code
  );
  return foundIndex === index;
});
const topShortcodes = uniqueShortcodes.slice(0, 3);
const emojiId = `emoji-${(emoji.slug || 'unknown') as string}`;
---

<div class="mt-6">
  <!-- Header Section -->
  <div
    class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-6 mb-6 shadow-sm"
  >
    <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
      <!-- Large Emoji Display -->
      <div class="text-8xl md:text-9xl flex-shrink-0">
        {emojiChar}
      </div>

      <!-- Emoji Info -->
      <div class="flex-1">
        <p class="mb-2">
          {emoji.code || (emoji as any).glyph}
          {
            emoji.title ||
              emoji.fluentui_metadata?.cldr ||
              emoji.slug ||
              'Unknown'
          }
        </p>

        {
          emoji.alsoKnownAs && emoji.alsoKnownAs.length > 0 && (
            <p class="text-slate-600 dark:text-slate-400 mb-4">
              Also known as: {emoji.alsoKnownAs.join(', ')}
            </p>
          )
        }

        <!-- Copy Buttons -->
        <CopyButtons
          emojiChar={emojiChar}
          topShortcodes={topShortcodes || []}
          client:load
        />

        <!-- Unicode Info -->
        {
          emoji.codepointsHex && emoji.codepointsHex.length > 0 && (
            <div class="text-sm text-slate-500 dark:text-slate-400">
              Unicode: {emoji.codepointsHex.join(', ')}
            </div>
          )
        }
      </div>
    </div>
  </div>

  <!-- Image Variants -->
  <ImageVariants
    emojiId={emojiId}
    emojiTitle={emoji.title ||
      emoji.fluentui_metadata?.cldr ||
      emoji.slug ||
      'Unknown'}
    variants={imageVariants}
    client:load
  />

  <!-- Banner -->
  <Banner />

  <!-- Technical Details -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <!-- Version Info -->
    {
      (emoji.emojiVersion || emoji.version) && (
        <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-6 shadow-sm">
          <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-3">
            Version Information
          </h3>
          <div class="space-y-2 text-sm">
            {emoji.emojiVersion && (
              <div>
                <span class="font-medium text-slate-600 dark:text-slate-400">
                  Emoji Version:
                </span>
                <span class="ml-2 text-slate-900 dark:text-slate-100">
                  {emoji.emojiVersion.name}
                </span>
              </div>
            )}
            {emoji.version && (
              <div>
                <span class="font-medium text-slate-600 dark:text-slate-400">
                  Unicode Version:
                </span>
                <span class="ml-2 text-slate-900 dark:text-slate-100">
                  {emoji.version.name}
                </span>
              </div>
            )}
          </div>
        </div>
      )
    }

    <!-- Keywords -->
    {
      emoji.fluentui_metadata?.keywords &&
        emoji.fluentui_metadata.keywords.length > 0 && (
          <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-6 shadow-sm">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-3">
              Keywords
            </h3>
            <div class="flex flex-wrap gap-2">
              {emoji.fluentui_metadata.keywords.map((keyword) => (
                <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full dark:bg-blue-900/20 dark:text-blue-400">
                  {keyword}
                </span>
              ))}
            </div>
          </div>
        )
    }
  </div>

  <!-- Shortcodes Table -->
  {
    uniqueShortcodes && uniqueShortcodes.length > 0 && (
      <ShortcodesTable
        emojiId={emojiId}
        shortcodes={uniqueShortcodes}
        client:load
      />
    )
  }

  <!-- Additional Data -->
  {
    emoji.emoji_net_data && (
      <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-6 shadow-sm">
        <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100 mb-4">
          Additional Information
        </h2>
        <div class="space-y-3 text-sm">
          {emoji.emoji_net_data.category && (
            <div>
              <span class="font-medium text-slate-600 dark:text-slate-400">
                Category:
              </span>
              <span class="ml-2 text-slate-900 dark:text-slate-100">
                {emoji.emoji_net_data.category}
              </span>
            </div>
          )}
          {emoji.emoji_net_data.definition && (
            <div>
              <span class="font-medium text-slate-600 dark:text-slate-400">
                Definition:
              </span>
              <p class="mt-1 text-slate-700 dark:text-slate-300">
                {cleanDescription(emoji.emoji_net_data.definition)}
              </p>
            </div>
          )}
          {collectNestedStrings(emoji.emoji_net_data?.senses, ['adjectives'])
            .length > 0 && (
            <div>
              <span class="font-medium text-slate-600 dark:text-slate-400">
                Adjectives:
              </span>
              <ul class="mt-2 list-disc list-inside space-y-1 text-slate-700 dark:text-slate-300">
                {collectNestedStrings(emoji.emoji_net_data?.senses, [
                  'adjectives',
                ])
                  .slice(0, 12)
                  .map((desc: string) => (
                    <li>{desc}</li>
                  ))}
              </ul>
            </div>
          )}
          {collectNestedStrings(emoji.emoji_net_data?.senses, ['verbs'])
            .length > 0 && (
            <div>
              <span class="font-medium text-slate-600 dark:text-slate-400">
                Verbs:
              </span>
              <ul class="mt-2 list-disc list-inside space-y-1 text-slate-700 dark:text-slate-300">
                {collectNestedStrings(emoji.emoji_net_data?.senses, ['verbs'])
                  .slice(0, 12)
                  .map((desc: string) => (
                    <li>{desc}</li>
                  ))}
              </ul>
            </div>
          )}
          {collectNestedStrings(emoji.emoji_net_data?.senses, ['nouns'])
            .length > 0 && (
            <div>
              <span class="font-medium text-slate-600 dark:text-slate-400">
                Nouns:
              </span>
              <ul class="mt-2 list-disc list-inside space-y-1 text-slate-700 dark:text-slate-300">
                {collectNestedStrings(emoji.emoji_net_data?.senses, ['nouns'])
                  .slice(0, 12)
                  .map((desc: string) => (
                    <li>{desc}</li>
                  ))}
              </ul>
            </div>
          )}
        </div>
      </div>
    )
  }

  <SeeAlsoIndex />
</div>
