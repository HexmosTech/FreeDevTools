---
import AdBanner from '../../components/banner/AdBanner.astro';
import CreditsButton from '../../components/buttons/CreditsButton';
import ToolContainer from '../../components/tool/ToolContainer';
import ToolHead from '../../components/tool/ToolHead';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Pagination from '../../components/PaginationComponent.astro';
import { getEmojiBySlug, getEmojiImages, getAllEmojis, getEmojiCategories } from '../../lib/emojis';
import { apple_vendor_excluded_emojis, discord_vendor_excluded_emojis } from '@/lib/emojis-consts';
import EachEmojiPage from './EachEmojiPage.astro';

export const prerender = false;

const { slug } = Astro.params;

// Early return if no slug param
if (!slug) {
  return new Response(null, { status: 404 });
}

// Check if slug is numeric (pagination)
const isNumericPage = slug && /^\d+$/.test(slug);
const pageNumber = isNumericPage ? parseInt(slug, 10) : null;

let paginationData: any = null;
let emojiData: any = null;

if (pageNumber !== null) {
  // Handle pagination route
  const currentPage = pageNumber;
  const emojis = await getAllEmojis();
  const categories = getEmojiCategories();
  const emojisByCategory: Record<string, any[]> = {};
  
  for (const cat of categories) {
    emojisByCategory[cat] = emojis.filter(
      (e) =>
        (e.category || 'Other') === cat
    );
  }
  
  const sortedCategories = Object.keys(emojisByCategory).sort();
  for (const category of sortedCategories) {
    emojisByCategory[category].sort((a, b) => {
      const titleA = a.title || a.slug || '';
      const titleB = b.title || b.slug || '';
      return titleA.localeCompare(titleB);
    });
  }
  
  const itemsPerPage = 36;
  const totalPages = Math.ceil(sortedCategories.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedCategories = sortedCategories.slice(startIndex, endIndex);
  
  const categoryIconMap: Record<string, string> = {
    'Smileys & Emotion': 'üòÄ',
    'People & Body': 'üë§',
    'Animals & Nature': 'üê∂',
    'Food & Drink': 'üçé',
    'Travel & Places': '‚úàÔ∏è',
    Activities: '‚öΩ',
    Objects: 'üì±',
    Symbols: '‚ù§Ô∏è',
    Flags: 'üèÅ',
    Other: '‚ùì',
  };
  
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'Emojis', href: '/freedevtools/emojis/' },
  ];
  
  paginationData = {
    currentPage,
    totalPages,
    sortedCategories,
    paginatedCategories,
    emojisByCategory,
    emojis,
    categoryIconMap,
    breadcrumbItems,
  };
} else {
  // Handle emoji page route
  const emoji = getEmojiBySlug(slug!);
  const images = getEmojiImages(slug!);

  if (!emoji) {
    return new Response(null, { status: 404 });
  }

  const cleanDescription = (text?: string) => {
    if (!text) return '';
    return text
      .replace(/<[^>]*>/g, '')
      .replace(/&nbsp;/g, ' ')
      .replace(/&amp;/g, '&')
      .replace(/&lt;/g, '<')
      .replace(/&gt;/g, '>')
      .replace(/&quot;/g, '"')
      .replace(/&#39;/g, "'")
      .replace(/[?]{2,}/g, '')
      .trim();
  };

  // Get category for breadcrumb
  const categoryName = (emoji.category || 'Other') as string;
  const categorySlug = categoryName.toLowerCase().replace(/[^a-z0-9]+/g, '-');

  // Clean description now (don't store function)
  const cleanedDescription = cleanDescription(emoji.description);
  const seoDescription = cleanedDescription || 
    `Learn about the ${emoji.title || emoji.slug} emoji ${emoji.code || ''}. Find meanings, shortcodes, and usage information.`;

  // Breadcrumb items
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'Emojis', href: '/freedevtools/emojis/' },
    { label: categoryName, href: `/freedevtools/emojis/${categorySlug}/` },
    { label: emoji.title || emoji.slug },
  ];

  emojiData = {
    emoji,
    images,
    categoryName,
    categorySlug,
    breadcrumbItems,
    cleanedDescription,
    seoDescription,
  };
}
---

{paginationData ? (
  <BaseLayout
    name="Emojis"
    path="/emojis/"
    title="Emoji Reference - Browse & Copy Emojis | Online Free DevTools by Hexmos"
    description="Explore the emoji reference by category. Find meanings, names, and shortcodes. Browse thousands of emojis and copy instantly. Free, fast, no signup."
    canonical="https://hexmos.com/freedevtools/emojis/"
    keywords={[
      'emoji reference',
      'emoji categories',
      'copy emojis',
      'emoji meanings',
      'emoji shortcodes',
    ]}
    showHeader={true}
    totalItems={paginationData.sortedCategories.length}
    features={[
      'Browse by category',
      'Copy instantly',
      'Find meanings',
      'No signup required',
      'Free access',
    ]}
    emojiCategory="Reference"
  >
    <ToolContainer>
      <div class="mb-16 mt-[74px]">
        <AdBanner />
      </div>
      <ToolHead
        name="Emojis"
        description="Comprehensive emoji reference with categories, meanings, and copy functionality. Browse categories like Smileys & Emotion, People & Body, Animals & Nature, Food & Drink, Travel & Places, Activities, Objects, Symbols, and Flags."
        breadcrumbItems={paginationData.breadcrumbItems}
      />

      <div id="pagination-info" class="text-center mb-8">
        <div class="grid grid-cols-2 gap-6 mt-8">
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600">
              {paginationData.sortedCategories.length}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Categories</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-600">
              {paginationData.emojis.length.toLocaleString()}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Emojis</div>
          </div>
        </div>
      </div>

      <div
        id="emoji-categories"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 md:gap-4 lg:gap-8"
      >
        {
          paginationData.paginatedCategories.map((category) => (
            <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-900 rounded-xl p-4 md:p-4 lg:p-8 transition-all duration-300 ease-in-out shadow-sm hover:-translate-y-1 hover:shadow-xl hover:border-border">
              <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 rounded-lg flex items-center justify-center mr-3 border border-slate-200 dark:border-slate-700 shadow-sm">
                  <span class="text-white font-bold text-lg select-none">
                    {paginationData.categoryIconMap[category] || '‚ùì'}
                  </span>
                </div>
                <a
                  href={`/freedevtools/emojis/${category.toLowerCase().replace(/[^a-z0-9]+/g, '-')}/`}
                  class="text-xl font-semibold text-black dark:text-neon-light capitalize hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                >
                  {category.replace('-', ' ')}
                </a>
              </div>

              <p class="text-sm text-slate-800 dark:text-slate-400 mb-4 m-0">
                {paginationData.emojisByCategory[category].length} emojis available
              </p>

              <div class="space-y-2">
                {paginationData.emojisByCategory[category].slice(0, 5).map((emoji) => {
                  const emojiName =
                    emoji.title || emoji.slug;
                  const truncatedName =
                    emojiName.length > 27
                      ? emojiName.substring(0, 27) + '...'
                      : emojiName;
                  return (
                    <a
                      href={`/freedevtools/emojis/${emoji.slug}/`}
                      class="block text-sm text-blue-600 dark:text-blue-400 hover:text-black dark:hover:text-white hover:font-bold"
                    >
                      {emoji.code || emoji.emoji} {truncatedName}
                    </a>
                  );
                })}
                {paginationData.emojisByCategory[category].length > 5 && (
                  <p class="text-xs text-slate-500 dark:text-slate-500">
                    +{paginationData.emojisByCategory[category].length - 5} more items
                  </p>
                )}
              </div>

              <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-900">
                <a
                  href={`/freedevtools/emojis/${category.toLowerCase().replace(/[^a-z0-9]+/g, '-')}/`}
                  class="text-sm font-medium text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
                >
                  View all {category} emojis ‚Üí
                </a>
              </div>
            </div>
          ))
        }
      </div>

      <Pagination
        currentPage={paginationData.currentPage}
        totalPages={paginationData.totalPages}
        baseUrl="/freedevtools/emojis/"
      />

      <div
        class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700"
      >
        <div class="flex flex-wrap gap-4">
          <a
            href="/freedevtools/"
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
          >
            ‚Üê Back to Free DevTools
          </a>
          <CreditsButton href="/freedevtools/emojis/credits/" />
        </div>
      </div>
    </ToolContainer>
  </BaseLayout>
) : emojiData ? (
  <BaseLayout
    name="Emojis"
    path="/emojis/"
    title={`${emojiData.emoji.code || ''} ${emojiData.emoji.title || emojiData.emoji.slug} - Emoji Reference | Online Free DevTools by Hexmos`}
    description={emojiData.seoDescription}
    canonical={`https://hexmos.com/freedevtools/emojis/${emojiData.emoji.slug}/`}
    showHeader={true}
    keywords={emojiData.emoji.keywords || []}
  >
    <ToolContainer>
      <div class="mb-16 mt-[74px]">
        <AdBanner />
      </div>
      <ToolHead
        name={`${emojiData.emoji.code || ''} ${emojiData.emoji.title || emojiData.emoji.slug}`}
        description={emojiData.seoDescription}
        breadcrumbItems={emojiData.breadcrumbItems}
      />

      <EachEmojiPage emoji={emojiData.emoji} images={emojiData.images} />

      <!-- Navigation -->
      <div
        class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700"
      >
        <div class="flex flex-wrap gap-4">
          <a
            href="/freedevtools/emojis/"
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
          >
            ‚Üê Back to Emojis
          </a>
          {
            emojiData.emoji.category ? (
              <a
                href={`/freedevtools/emojis/${emojiData.emoji.category.toLowerCase().replace(/[^a-z0-9]+/g, '-')}/`}
                class="inline-flex items-center px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                View{' '}
                {emojiData.emoji.category
                  .replace(/-/g, ' ')
                  .replace(/\b\w/g, (l) => l.toUpperCase())}{' '}
                Category
              </a>
            ) : null
          }

          {
            emojiData.emoji.apple_vendor_description &&
            !apple_vendor_excluded_emojis.includes(emojiData.emoji.slug) ? (
              <a
                href={`/freedevtools/emojis/apple-emojis/${emojiData.emoji.slug}/`}
                class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                üçé <span>View Apple Version</span>
              </a>
            ) : null
          }

          {
            emojiData.emoji.discord_vendor_description &&
            !discord_vendor_excluded_emojis.includes(emojiData.emoji.slug) ? (
              <a
                href={`/freedevtools/emojis/discord-emojis/${emojiData.emoji.slug}/`}
                class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                üéÆ <span>View Discord Version</span> 
              </a>
            ) : null
          }

          
          <CreditsButton href="/freedevtools/emojis/credits/" />
        </div>
      </div>
    </ToolContainer>
  </BaseLayout>
) : null}

<script>
  // Scroll to pagination info only if hash is present in URL
  if (window.location.hash === '#pagination-info') {
    const paginationInfo = document.getElementById('pagination-info');
    if (paginationInfo) {
      paginationInfo.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
</script>
