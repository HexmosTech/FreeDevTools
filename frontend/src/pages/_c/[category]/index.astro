---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import {
  getAllCheatsheetCategories,
  getCheatsheetsByCategory,
} from '../../../lib/cheatsheets-utils';
import CategoryCheatsheetsPage from './_CategoryCheatsheetsPage.astro';
import CheatsheetPage from '../_CheatsheetPage.astro';

export const prerender = false;

const { category: categorySlug } = Astro.params;
const urlPath = Astro.url.pathname;

if (!categorySlug) {
  return new Response(null, { status: 404 });
}

// Redirect to add trailing slash if missing (BEFORE other checks)
if (!urlPath.endsWith('/')) {
  return Astro.redirect(`${urlPath}/`, 301);
}

let categoryData: any = null;
let paginationData: any = null;

// If category is numeric, this is actually a pagination route
// Handle it directly (workaround for route priority)
if (/^\d+$/.test(categorySlug)) {
  const currentPage = parseInt(categorySlug, 10);

  // Redirect /c/1 to /c
  if (currentPage === 1) {
    return Astro.redirect('/freedevtools/c/');
  }

  // Fetch categories data directly (SSR mode)
  const allCategories = await getAllCheatsheetCategories();

  const itemsPerPage = 30;
  const totalPages = Math.ceil(allCategories.length / itemsPerPage);

  // Validate page number
  if (currentPage > totalPages || currentPage < 1) {
    return new Response(null, { status: 404 });
  }

  const totalCategories = allCategories.length;

  // Calculate total cheatsheets
  const totalCheatsheets = allCategories.reduce((total, category) => total + category.cheatsheetCount, 0);

  // Get categories for current page
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const categories = allCategories.slice(startIndex, endIndex);

  // Breadcrumb data
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'Cheatsheets', href: '/freedevtools/c/' },
  ];

  // SEO data
  const seoTitle = `Cheatsheets - Page ${currentPage} | Online Free DevTools by Hexmos`;
  const seoDescription = `Browse page ${currentPage} of our cheatsheets collection. Quick reference for commands, syntax, and programming concepts.`;
  const canonical = `https://hexmos.com/freedevtools/c/${currentPage}/`;

  const mainKeywords = [
    'cheatsheets',
    'reference',
    'commands',
    'syntax',
    'programming',
    'documentation',
    'quick reference',
    'command line',
    'cli',
    'terminal',
  ];

  paginationData = {
    currentPage,
    totalPages,
    totalCategories,
    totalCheatsheets,
    categories,
    breadcrumbItems,
    seoTitle,
    seoDescription,
    canonical,
    mainKeywords,
    itemsPerPage,
  };
} else {
  // Validate category exists
  const allCategories = await getAllCheatsheetCategories();
  const categoryIds = allCategories.map((c) => c.id);
  if (!categoryIds.includes(categorySlug)) {
    return new Response(null, { status: 404 });
  }

  // Find the category
  const category = allCategories.find((c) => c.id === categorySlug);
  if (!category) {
    return new Response(null, { status: 404 });
  }

  const categoryName = category.name;

  // Get cheatsheets for this category
  const cheatsheets = await getCheatsheetsByCategory(categoryName);
  const totalCheatsheets = cheatsheets.length;

  // Pagination logic for page 1
  const itemsPerPage = 30;
  const currentPage = 1;
  const totalPages = Math.ceil(totalCheatsheets / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedCheatsheets = cheatsheets.slice(startIndex, endIndex);

  // Breadcrumb items
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'Cheatsheets', href: '/freedevtools/c/' },
    { label: categoryName, href: `/freedevtools/c/${categorySlug}/` },
  ];

  // SEO data
  const seoTitle = `${categoryName} Cheatsheets | Online Free DevTools by Hexmos`;
  const seoDescription = `Comprehensive ${categoryName.toLowerCase()} cheatsheets covering commands, syntax, and key concepts for faster learning and recall.`;
  const keywords = [
    categoryName.toLowerCase(),
    'cheatsheets',
    'reference',
    'commands',
    'syntax',
    'programming',
    'documentation',
  ];

  categoryData = {
    categoryName,
    categorySlug,
    paginatedCheatsheets,
    totalCheatsheets,
    currentPage,
    totalPages,
    seoTitle,
    seoDescription,
    keywords,
    breadcrumbItems,
  };
}
---

{paginationData ? (
  <BaseLayout 
    name="Cheatsheets"
    path={`/freedevtools/c/${paginationData.currentPage}/`}
    title={paginationData.seoTitle}
    description={paginationData.seoDescription}
    canonical={paginationData.canonical}
    showHeader={true}
    totalItems={paginationData.totalCategories}
    itemsPerPage={paginationData.itemsPerPage}
    currentPage={paginationData.currentPage}
    category="Cheatsheets"
    partOf="Free DevTools"
    partOfUrl="https://hexmos.com/freedevtools/"
    keywords={paginationData.mainKeywords}
    features={["Quick reference", "Command syntax", "Easy to scan", "Fast learning", "Free access"]}
    commandCategory="Reference"
  >
    <CheatsheetPage 
      categories={paginationData.categories}
      currentPage={paginationData.currentPage}
      totalPages={paginationData.totalPages}
      totalCategories={paginationData.totalCategories}
      totalCheatsheets={paginationData.totalCheatsheets}
      breadcrumbItems={paginationData.breadcrumbItems}
    />
  </BaseLayout>
) : categoryData ? (
  <BaseLayout
    name={`${categoryData.categoryName} Cheatsheets`}
    path={`/c/${categoryData.categorySlug}/`}
    title={categoryData.seoTitle}
    description={categoryData.seoDescription}
    canonical={`https://hexmos.com/freedevtools/c/${categoryData.categorySlug}/`}
    keywords={categoryData.keywords}
    showHeader={true}
    totalItems={categoryData.totalCheatsheets}
    features={[
      'Quick reference',
      'Command syntax',
      'Easy to scan',
      'Fast learning',
      'Free access',
    ]}
    commandCategory="Reference"
  >
    <CategoryCheatsheetsPage
      categoryName={categoryData.categoryName}
      categorySlug={categoryData.categorySlug}
      paginatedCheatsheets={categoryData.paginatedCheatsheets}
      totalCheatsheets={categoryData.totalCheatsheets}
      currentPage={categoryData.currentPage}
      totalPages={categoryData.totalPages}
      seoDescription={categoryData.seoDescription}
      breadcrumbItems={categoryData.breadcrumbItems}
    />
  </BaseLayout>
) : null}
