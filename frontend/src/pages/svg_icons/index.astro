---
import {
  getClusters,
  getClustersWithPreviewIcons,
  getTotalIcons,
} from 'db/svg_icons/svg-icons-utils';
import BaseLayout from '../../layouts/BaseLayout.astro';
import SvgIcons from './_SvgIcons.astro';

// Track request start time
const requestStartTime = Date.now();
const requestPath = Astro.url.pathname;
console.log(`[SVG_ICONS] Request reached server: ${requestPath} at ${new Date().toISOString()}`);

// Pagination logic for page 1
const itemsPerPage = 30;
const currentPage = 1;

// Get total count of clusters for pagination (single query)
const totalClustersQueryStartTime = Date.now();
const allClusters = await getClusters();
const totalCategories = allClusters.length;
const totalClustersQueryEndTime = Date.now();
console.log(`[SVG_ICONS] getClusters() for count took ${totalClustersQueryEndTime - totalClustersQueryStartTime}ms`);

// Get paginated clusters with preview icons in ONE optimized query
const categoriesWithIcons = await getClustersWithPreviewIcons(currentPage, itemsPerPage, 6);

// Transform to match expected format
const categories = categoriesWithIcons.map((cluster) => {
  return {
    id: cluster.source_folder || cluster.name,
    name: cluster.name,
    description: cluster.description,
    icon: `/freedevtools/svg_icons/${cluster.name}/`,
    iconCount: cluster.count,
    url: `/freedevtools/svg_icons/${cluster.name}/`,
    keywords: cluster.keywords,
    features: cluster.tags,
    previewIcons: cluster.previewIcons, // Include preview icons
  };
});

const totalPages = Math.ceil(totalCategories / itemsPerPage);

// Calculate total SVG icons across all categories
const totalIconsQueryStartTime = Date.now();
const totalSvgIcons = await getTotalIcons();
const totalIconsQueryEndTime = Date.now();
console.log(`[SVG_ICONS] getTotalIcons() took ${totalIconsQueryEndTime - totalIconsQueryStartTime}ms`);

// Log total roundtrip time
const requestEndTime = Date.now();
const totalRoundtripTime = requestEndTime - requestStartTime;
console.log(`[SVG_ICONS] Total roundtrip time for ${requestPath}: ${totalRoundtripTime}ms`);

// Breadcrumb data
const breadcrumbItems = [
  { label: 'Free DevTools', href: '/freedevtools/' },
  { label: 'SVG Icons' },
];

// SEO data
const seoTitle =
  currentPage === 1
    ? 'Free SVG Icons - Download & Edit Vector Graphics | Online Free DevTools by Hexmos'
    : `Free SVG Icons - Page ${currentPage} | Online Free DevTools by Hexmos`;

const seoDescription =
  currentPage === 1
    ? `Download 50k+ free SVG icons instantly. No registration required.`
    : `Browse page ${currentPage} of our free SVG icons collection. Download thousands of vector graphics instantly. No registration required.`;

const canonical =
  currentPage === 1
    ? 'https://hexmos.com/freedevtools/svg_icons/'
    : `https://hexmos.com/freedevtools/svg_icons/${currentPage}/`;

// Enhanced keywords for main page
const mainKeywords = [
  'svg icons',
  'vector graphics',
  'free icons',
  'download icons',
  'edit icons',
  'icon library',
  'vector graphics library',
  'svg download',
  'free vector icons',
  'customizable icons',
];
---

<BaseLayout
  name="SVG Icons"
  path={currentPage === 1
    ? '/freedevtools/svg_icons/'
    : `/freedevtools/svg_icons/${currentPage}/`}
  title={seoTitle}
  description={seoDescription}
  canonical={canonical}
  showHeader={true}
  totalItems={totalCategories}
  itemsPerPage={itemsPerPage}
  currentPage={currentPage}
  category="SVG Icons"
  partOf="Free DevTools"
  partOfUrl="https://hexmos.com/freedevtools/"
  keywords={mainKeywords}
  features={[
    'Download',
    'Edit colors',
    'Add backgrounds',
    'Customize',
    'No registration',
  ]}
>
  <SvgIcons
    categories={categories}
    currentPage={currentPage}
    totalPages={totalPages}
    totalCategories={totalCategories}
    totalSvgIcons={totalSvgIcons}
    breadcrumbItems={breadcrumbItems}
  />
</BaseLayout>
