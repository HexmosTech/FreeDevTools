---
import BaseLayout from '../../layouts/BaseLayout.astro';
import {
  getAllTldrPlatforms,
  getTldrPlatformCommands,
} from '../../lib/tldr-utils';
import Tldr from './_Tldr.astro';
import TldrPlatform from './_TldrPlatform.astro';

export const prerender = false;

const { page } = Astro.params;
const urlPath = Astro.url.pathname;

// Early return if no page param
if (!page) {
  return new Response(null, { status: 404 });
}

let platformData: any = null;
let paginationData: any = null;

// Check if page param is numeric
if (!/^\d+$/.test(page)) {
  // If not numeric, it might be a platform name
  // Redirect to add trailing slash if missing (before checking platform)
  if (!urlPath.endsWith('/')) {
    return Astro.redirect(`${urlPath}/`, 301);
  }

  const allPlatforms = await getAllTldrPlatforms();
  const isPlatform = allPlatforms.some((p) => p.name === page);

  if (isPlatform) {
    // This is a platform index route - render it here since [page].astro matched first
    // This is a workaround for route priority not working as expected
    const platform = page!;
    const allCommands = await getTldrPlatformCommands(platform);
    const itemsPerPage = 30;
    const currentPage = 1;
    const totalPages = Math.ceil(allCommands.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const commands = allCommands.slice(startIndex, endIndex);
    const totalCommands = allCommands.length;

    const breadcrumbItems = [
      { label: 'Free DevTools', href: '/freedevtools/' },
      { label: 'TLDR', href: '/freedevtools/tldr/' },
      { label: platform },
    ];

    const seoTitle = `${platform} Commands - TLDR Documentation | Online Free DevTools by Hexmos`;
    const seoDescription = `Comprehensive documentation for ${platform} command-line tools. Learn ${platform} commands quickly with practical examples. ${totalCommands} commands available.`;
    const canonical = `https://hexmos.com/freedevtools/tldr/${platform}/`;

    const platformKeywords = [
      `${platform} commands`,
      `${platform} cli`,
      `${platform} documentation`,
      'command line',
      'cli documentation',
      'terminal commands',
      'command reference',
      'cli documentation',
    ];

    platformData = {
      platform,
      commands,
      currentPage,
      totalPages,
      totalCommands,
      breadcrumbItems,
      seoTitle,
      seoDescription,
      canonical,
      platformKeywords,
    };
  } else {
    // Not a valid platform or page number - 404
    return new Response(null, { status: 404 });
  }
} else {
  // Handle pagination route
  const currentPage = parseInt(page, 10);

  // Redirect /tldr/1 to /tldr
  if (currentPage === 1) {
    return Astro.redirect('/freedevtools/tldr/');
  }

  // Fetch platforms data directly (SSR mode)
  const allPlatforms = await getAllTldrPlatforms();
  const itemsPerPage = 30;
  const totalPages = Math.ceil(allPlatforms.length / itemsPerPage);

  // Validate page number
  if (currentPage > totalPages || currentPage < 1) {
    return Astro.redirect('/404');
  }

  const totalPlatforms = allPlatforms.length;

  // Get platforms for current page
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentPagePlatforms = allPlatforms.slice(startIndex, endIndex);

  // Calculate total commands across all platforms
  const totalCommands = allPlatforms.reduce(
    (total: number, platform: any) => total + platform.count,
    0
  );

  // Breadcrumb data
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'TLDR', href: '/freedevtools/tldr/' },
    { label: `Page ${currentPage}` },
  ];

  // SEO data
  const seoTitle = `TLDR - Page ${currentPage} | Online Free DevTools by Hexmos`;
  const seoDescription = `Browse page ${currentPage} of ${totalPages} pages in our TLDR command documentation. Learn command-line tools across different platforms.`;
  const canonical = `https://hexmos.com/freedevtools/tldr/${currentPage}/`;

  const paginatedKeywords = [
    'tldr',
    'command line',
    'cli documentation',
    'terminal commands',
    `page ${currentPage}`,
    'pagination',
    'command reference',
    'cli documentation',
  ];

  paginationData = {
    currentPage,
    totalPages,
    totalPlatforms,
    currentPagePlatforms,
    totalCommands,
    breadcrumbItems,
    seoTitle,
    seoDescription,
    canonical,
    paginatedKeywords,
    itemsPerPage,
  };
}
---

{
  platformData ? (
    <BaseLayout
      name={`${platformData.platform} Commands`}
      path={`/freedevtools/tldr/${platformData.platform}/`}
      title={platformData.seoTitle}
      description={platformData.seoDescription}
      canonical={platformData.canonical}
      showHeader={true}
      totalItems={platformData.totalCommands}
      itemsPerPage={30}
      currentPage={platformData.currentPage}
      category={`${platformData.platform} Commands`}
      partOf="TLDR"
      partOfUrl="https://hexmos.com/freedevtools/tldr/"
      keywords={platformData.platformKeywords}
      features={[
        'Quick Reference',
        'Platform Specific',
        'Practical Examples',
        'No Registration',
      ]}
    >
      <TldrPlatform
        commands={platformData.commands}
        currentPage={platformData.currentPage}
        totalPages={platformData.totalPages}
        totalCommands={platformData.totalCommands}
        platform={platformData.platform}
        breadcrumbItems={platformData.breadcrumbItems}
      />
    </BaseLayout>
  ) : paginationData ? (
    <BaseLayout
      name="TLDR"
      path={`/freedevtools/tldr/${paginationData.currentPage}/`}
      title={paginationData.seoTitle}
      description={paginationData.seoDescription}
      canonical={paginationData.canonical}
      showHeader={true}
      totalItems={paginationData.totalPlatforms}
      itemsPerPage={paginationData.itemsPerPage}
      currentPage={paginationData.currentPage}
      category="TLDR"
      partOf="Free DevTools"
      partOfUrl="https://hexmos.com/freedevtools/"
      keywords={paginationData.paginatedKeywords}
      features={[
        'Quick Reference',
        'Platform Specific',
        'Practical Examples',
        'No Registration',
      ]}
    >
      <Tldr
        platforms={paginationData.currentPagePlatforms}
        currentPage={paginationData.currentPage}
        totalPages={paginationData.totalPages}
        totalPlatforms={paginationData.totalPlatforms}
        totalCommands={paginationData.totalCommands}
        breadcrumbItems={paginationData.breadcrumbItems}
      />
    </BaseLayout>
  ) : null
}
