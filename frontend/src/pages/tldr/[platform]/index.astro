---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getAllTldrPlatforms } from '../../../../db/tldrs/tldr-utils';
import { getTldrPlatformCommandsPaginated } from '../../../../db/tldrs/tldr-utils';
import Tldr from '../_Tldr.astro';
import TldrPlatform from '../_TldrPlatform.astro';

export const prerender = false;

const { platform } = Astro.params;

if (!platform) {
  return Astro.redirect('/404');
}

let paginationData: any = null;
let platformData: any = null;

// If platform is numeric, this is actually a pagination route for the main index
// Render pagination content directly (workaround for route priority)
if (/^\d+$/.test(platform)) {
  const currentPage = parseInt(platform, 10);

  // Redirect /tldr/1 to /tldr
  if (currentPage === 1) {
    return Astro.redirect('/freedevtools/tldr/');
  }

  // Fetch paginated platforms data
  const start = Date.now();
  const result = await getAllTldrPlatforms(currentPage);
  console.log(
    `[TLDR_PLATFORM_PAGE] getAllTldrPlatforms(${currentPage}) finished in ${Date.now() - start}ms`
  );

  if (!result) {
    return Astro.redirect('/404');
  }

  const {
    platforms: currentPagePlatforms,
    total: totalPlatforms,
    total_pages: totalPages,
    page,
    total_commands: totalCommands,
  } = result;

  // Validate page number
  if (page > totalPages || page < 1) {
    return Astro.redirect('/404');
  }

  const itemsPerPage = 30;

  // Breadcrumb data
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'TLDR', href: '/freedevtools/tldr/' },
    { label: `Page ${currentPage}` },
  ];

  // SEO data
  const seoTitle = `TLDR - Page ${currentPage} | Online Free DevTools by Hexmos`;
  const seoDescription = `Browse page ${currentPage} of ${totalPages} pages in our TLDR command documentation. Learn command-line tools across different platforms.`;
  const canonical = `https://hexmos.com/freedevtools/tldr/${currentPage}/`;

  const paginatedKeywords = [
    'tldr',
    'command line',
    'cli documentation',
    'terminal commands',
    `page ${currentPage}`,
    'pagination',
    'command reference',
    'cli documentation',
  ];

  paginationData = {
    currentPage,
    totalPages,
    totalPlatforms,
    currentPagePlatforms,
    totalCommands,
    breadcrumbItems,
    seoTitle,
    seoDescription,
    canonical,
    paginatedKeywords,
    itemsPerPage,
  };
} else {
  // Get commands for this platform (Page 1)
  const start = Date.now();
  const result = await getTldrPlatformCommandsPaginated(platform, 1);
  console.log(
    `[TLDR_PLATFORM_PAGE] getTldrPlatformCommandsPaginated(${platform}, 1) finished in ${Date.now() - start}ms`
  );

  if (!result) {
    return Astro.redirect('/404');
  }

  const {
    commands,
    total: totalCommands,
    total_pages: totalPages,
    page: currentPage,
  } = result;
  const itemsPerPage = 30;

  // Breadcrumb data
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'TLDR', href: '/freedevtools/tldr/' },
    { label: platform },
  ];

  // SEO data
  const seoTitle = `${platform} Commands - TLDR Documentation | Online Free DevTools by Hexmos`;
  const seoDescription = `Comprehensive documentation for ${platform} command-line tools. Learn ${platform} commands quickly with practical examples. ${totalCommands} commands available.`;
  const canonical = `https://hexmos.com/freedevtools/tldr/${platform}/`;

  // Enhanced keywords for platform page
  const platformKeywords = [
    `${platform} commands`,
    `${platform} cli`,
    `${platform} documentation`,
    'command line',
    'cli documentation',
    'terminal commands',
    'command reference',
    'cli documentation',
  ];

  platformData = {
    platform,
    commands,
    currentPage,
    totalPages,
    totalCommands,
    breadcrumbItems,
    seoTitle,
    seoDescription,
    canonical,
    platformKeywords,
    itemsPerPage,
  };
}
---

{
  paginationData ? (
    <BaseLayout
      name="TLDR"
      path={`/freedevtools/tldr/${paginationData.currentPage}/`}
      title={paginationData.seoTitle}
      description={paginationData.seoDescription}
      canonical={paginationData.canonical}
      showHeader={true}
      totalItems={paginationData.totalPlatforms}
      itemsPerPage={paginationData.itemsPerPage}
      currentPage={paginationData.currentPage}
      category="TLDR"
      partOf="Free DevTools"
      partOfUrl="https://hexmos.com/freedevtools/"
      keywords={paginationData.paginatedKeywords}
      features={[
        'Quick Reference',
        'Platform Specific',
        'Practical Examples',
        'No Registration',
      ]}
    >
      <Tldr
        platforms={paginationData.currentPagePlatforms}
        currentPage={paginationData.currentPage}
        totalPages={paginationData.totalPages}
        totalPlatforms={paginationData.totalPlatforms}
        totalCommands={paginationData.totalCommands}
        breadcrumbItems={paginationData.breadcrumbItems}
      />
    </BaseLayout>
  ) : platformData ? (
    <BaseLayout
      name={`${platformData.platform} Commands`}
      path={`/freedevtools/tldr/${platformData.platform}/`}
      title={platformData.seoTitle}
      description={platformData.seoDescription}
      canonical={platformData.canonical}
      showHeader={true}
      totalItems={platformData.totalCommands}
      itemsPerPage={platformData.itemsPerPage}
      currentPage={platformData.currentPage}
      category={`${platformData.platform} Commands`}
      partOf="TLDR"
      partOfUrl="https://hexmos.com/freedevtools/tldr/"
      keywords={platformData.platformKeywords}
      features={[
        'Quick Reference',
        'Platform Specific',
        'Practical Examples',
        'No Registration',
      ]}
    >
      <TldrPlatform
        commands={platformData.commands}
        currentPage={platformData.currentPage}
        totalPages={platformData.totalPages}
        totalCommands={platformData.totalCommands}
        platform={platformData.platform}
        breadcrumbItems={platformData.breadcrumbItems}
      />
    </BaseLayout>
  ) : null
}
