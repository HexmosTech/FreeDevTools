---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import {
  getAllTldrPlatforms,
  getTldrPlatformCommands,
} from '../../../lib/tldr-utils';
import Tldr from '../_Tldr.astro';
import TldrPlatform from '../_TldrPlatform.astro';

export const prerender = false;

const { platform } = Astro.params;

if (!platform) {
  return Astro.redirect('/404');
}

let paginationData: any = null;
let platformData: any = null;

// If platform is numeric, this is actually a pagination route
// Render pagination content directly (workaround for route priority)
if (/^\d+$/.test(platform)) {
  const currentPage = parseInt(platform, 10);

  // Redirect /tldr/1 to /tldr
  if (currentPage === 1) {
    return Astro.redirect('/freedevtools/tldr/');
  }

  // Fetch platforms data directly (SSR mode)
  const allPlatforms = await getAllTldrPlatforms();
  const itemsPerPage = 30;
  const totalPages = Math.ceil(allPlatforms.length / itemsPerPage);

  // Validate page number
  if (currentPage > totalPages || currentPage < 1) {
    return Astro.redirect('/404');
  }

  const totalPlatforms = allPlatforms.length;

  // Get platforms for current page
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentPagePlatforms = allPlatforms.slice(startIndex, endIndex);

  // Calculate total commands across all platforms
  const totalCommands = allPlatforms.reduce(
    (total: number, platform: any) => total + platform.count,
    0
  );

  // Breadcrumb data
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'TLDR', href: '/freedevtools/tldr/' },
    { label: `Page ${currentPage}` },
  ];

  // SEO data
  const seoTitle = `TLDR - Page ${currentPage} | Online Free DevTools by Hexmos`;
  const seoDescription = `Browse page ${currentPage} of ${totalPages} pages in our TLDR command documentation. Learn command-line tools across different platforms.`;
  const canonical = `https://hexmos.com/freedevtools/tldr/${currentPage}/`;

  const paginatedKeywords = [
    'tldr',
    'command line',
    'cli documentation',
    'terminal commands',
    `page ${currentPage}`,
    'pagination',
    'command reference',
    'cli documentation',
  ];

  paginationData = {
    currentPage,
    totalPages,
    totalPlatforms,
    currentPagePlatforms,
    totalCommands,
    breadcrumbItems,
    seoTitle,
    seoDescription,
    canonical,
    paginatedKeywords,
    itemsPerPage,
  };
} else {
  // Get all commands for this platform
  const allCommands = await getTldrPlatformCommands(platform);

  // Pagination logic for page 1
  const itemsPerPage = 30;
  const currentPage = 1;
  const totalPages = Math.ceil(allCommands.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const commands = allCommands.slice(startIndex, endIndex);
  const totalCommands = allCommands.length;

  // Breadcrumb data
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'TLDR', href: '/freedevtools/tldr/' },
    { label: platform },
  ];

  // SEO data
  const seoTitle = `${platform} Commands - TLDR Documentation | Online Free DevTools by Hexmos`;
  const seoDescription = `Comprehensive documentation for ${platform} command-line tools. Learn ${platform} commands quickly with practical examples. ${totalCommands} commands available.`;
  const canonical = `https://hexmos.com/freedevtools/tldr/${platform}/`;

  // Enhanced keywords for platform page
  const platformKeywords = [
    `${platform} commands`,
    `${platform} cli`,
    `${platform} documentation`,
    'command line',
    'cli documentation',
    'terminal commands',
    'command reference',
    'cli documentation',
  ];

  platformData = {
    platform,
    commands,
    currentPage,
    totalPages,
    totalCommands,
    breadcrumbItems,
    seoTitle,
    seoDescription,
    canonical,
    platformKeywords,
    itemsPerPage,
  };
}
---

{paginationData ? (
  <BaseLayout
    name="TLDR"
    path={`/freedevtools/tldr/${paginationData.currentPage}/`}
    title={paginationData.seoTitle}
    description={paginationData.seoDescription}
    canonical={paginationData.canonical}
    showHeader={true}
    totalItems={paginationData.totalPlatforms}
    itemsPerPage={paginationData.itemsPerPage}
    currentPage={paginationData.currentPage}
    category="TLDR"
    partOf="Free DevTools"
    partOfUrl="https://hexmos.com/freedevtools/"
    keywords={paginationData.paginatedKeywords}
    features={[
      'Quick Reference',
      'Platform Specific',
      'Practical Examples',
      'No Registration',
    ]}
  >
    <Tldr
      platforms={paginationData.currentPagePlatforms}
      currentPage={paginationData.currentPage}
      totalPages={paginationData.totalPages}
      totalPlatforms={paginationData.totalPlatforms}
      totalCommands={paginationData.totalCommands}
      breadcrumbItems={paginationData.breadcrumbItems}
    />
  </BaseLayout>
) : platformData ? (
  <BaseLayout
    name={`${platformData.platform} Commands`}
    path={`/freedevtools/tldr/${platformData.platform}/`}
    title={platformData.seoTitle}
    description={platformData.seoDescription}
    canonical={platformData.canonical}
    showHeader={true}
    totalItems={platformData.totalCommands}
    itemsPerPage={platformData.itemsPerPage}
    currentPage={platformData.currentPage}
    category={`${platformData.platform} Commands`}
    partOf="TLDR"
    partOfUrl="https://hexmos.com/freedevtools/tldr/"
    keywords={platformData.platformKeywords}
    features={[
      'Quick Reference',
      'Platform Specific',
      'Practical Examples',
      'No Registration',
    ]}
  >
    <TldrPlatform
      commands={platformData.commands}
      currentPage={platformData.currentPage}
      totalPages={platformData.totalPages}
      totalCommands={platformData.totalCommands}
      platform={platformData.platform}
      breadcrumbItems={platformData.breadcrumbItems}
    />
  </BaseLayout>
) : null}
