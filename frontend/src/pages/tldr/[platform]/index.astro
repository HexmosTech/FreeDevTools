---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getTldrIndex, getTldrContent } from '../../../../db/tldrs/tldr-utils';
import Tldr from '../_Tldr.astro';
import TldrPlatform from '../_TldrPlatform.astro';

export const prerender = false;

const { platform } = Astro.params;

if (!platform) {
  return Astro.redirect('/404');
}

let paginationData: any = null;
let platformData: any = null;

// If platform is numeric, this is actually a pagination route for the main index
// Render pagination content directly (workaround for route priority)
if (/^\d+$/.test(platform)) {
  const currentPage = parseInt(platform, 10);

  // Redirect /tldr/1 to /tldr
  if (currentPage === 1) {
    return Astro.redirect('/freedevtools/tldr/');
  }

  // Fetch paginated platforms data
  const result = await getTldrIndex(currentPage);

  if (!result) {
    return Astro.redirect('/404');
  }

  // Validate page number
  if (result.currentPage > result.totalPages || result.currentPage < 1) {
    return Astro.redirect('/404');
  }

  paginationData = result;
} else {
  // Get commands for this platform (Page 1)
  const result = await getTldrContent(platform, '1');

  if (!result || result.type !== 'list') {
    return Astro.redirect('/404');
  }

  platformData = {
    platform,
    ...result.data,
    itemsPerPage: 30,
  };
}
---

{
  paginationData ? (
    <BaseLayout
      name="TLDR"
      path={`/freedevtools/tldr/${paginationData.currentPage}/`}
      title={paginationData.seoTitle}
      description={paginationData.seoDescription}
      canonical={paginationData.canonical}
      showHeader={true}
      totalItems={paginationData.totalPlatforms}
      itemsPerPage={paginationData.itemsPerPage}
      currentPage={paginationData.currentPage}
      category="TLDR"
      partOf="Free DevTools"
      partOfUrl="https://hexmos.com/freedevtools/"
      keywords={paginationData.paginatedKeywords}
      features={[
        'Quick Reference',
        'Platform Specific',
        'Practical Examples',
        'No Registration',
      ]}
    >
      <Tldr
        platforms={paginationData.currentPagePlatforms}
        currentPage={paginationData.currentPage}
        totalPages={paginationData.totalPages}
        totalPlatforms={paginationData.totalPlatforms}
        totalCommands={paginationData.totalCommands}
        breadcrumbItems={paginationData.breadcrumbItems}
      />
    </BaseLayout>
  ) : platformData ? (
    <BaseLayout
      name={`${platformData.platform} Commands`}
      path={`/freedevtools/tldr/${platformData.platform}/`}
      title={platformData.seoTitle}
      description={platformData.seoDescription}
      canonical={platformData.canonical}
      showHeader={true}
      totalItems={platformData.totalCommands}
      itemsPerPage={platformData.itemsPerPage}
      currentPage={platformData.currentPage}
      category={`${platformData.platform} Commands`}
      partOf="TLDR"
      partOfUrl="https://hexmos.com/freedevtools/tldr/"
      keywords={platformData.paginatedPlatformKeywords}
      features={[
        'Quick Reference',
        'Platform Specific',
        'Practical Examples',
        'No Registration',
      ]}
    >
      <TldrPlatform
        commands={platformData.currentPageCommands}
        currentPage={platformData.currentPage}
        totalPages={platformData.totalPages}
        totalCommands={platformData.totalCommands}
        platform={platformData.platform}
        breadcrumbItems={platformData.breadcrumbItems}
      />
    </BaseLayout>
  ) : null
}
