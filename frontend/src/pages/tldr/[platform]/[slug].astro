---
import { getTldrPage, getTldrPlatformCommandsPaginated } from '../../../../db/tldrs/tldr-utils';
import AdBanner from '../../../components/banner/AdBanner.astro';
import Banner from '../../../components/banner/BannerIndex.astro';
import CreditsButton from '../../../components/buttons/CreditsButton';
import SeeAlsoIndex from '../../../components/seealso/SeeAlsoIndex.astro';
import ToolContainer from '../../../components/tool/ToolContainer';
import ToolHead from '../../../components/tool/ToolHead';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import TldrPlatform from '../_TldrPlatform.astro';

export const prerender = false;

const { platform, slug } = Astro.params;
// console.log(`[TLDR_SLUG_PAGE] Start rendering ${platform}/${slug}`);
const startRender = Date.now();

if (!platform || !slug) {
  return new Response(null, { status: 404 });
}

// Check if slug is a page number (pagination) or a command name
const isNumericPage = /^\d+$/.test(slug);
const pageNumber = isNumericPage ? parseInt(slug, 10) : null;
const command = !isNumericPage ? slug : null;

let pageData: any = null;
let commandData: any = null;
let htmlContent: string = '';

if (pageNumber !== null) {
  // Handle pagination route: /tldr/[platform]/[page]
  if (pageNumber === 1) {
    return Astro.redirect(`/freedevtools/tldr/${platform}/`);
  }

  const result = await getTldrPlatformCommandsPaginated(platform, pageNumber);
  
  if (!result) {
    return Astro.redirect('/404');
  }

  const { commands: currentPageCommands, total: totalCommands, total_pages: totalPages, page: currentPage } = result;

  // Validate page number
  if (currentPage > totalPages || currentPage < 1) {
    return Astro.redirect('/404');
  }

  // Breadcrumb data
  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'TLDR', href: '/freedevtools/tldr/' },
    { label: platform, href: `/freedevtools/tldr/${platform}/` },
    { label: `Page ${currentPage}` },
  ];

  // SEO data
  const seoTitle = `${platform} Commands - Page ${currentPage} | Online Free DevTools by Hexmos`;
  const seoDescription = `Browse page ${currentPage} of ${totalPages} pages in our ${platform} command documentation. Learn ${platform} commands quickly with practical examples.`;
  const canonical = `https://hexmos.com/freedevtools/tldr/${platform}/${currentPage}/`;

  const paginatedPlatformKeywords = [
    `${platform} commands`,
    `${platform} cli`,
    `${platform} documentation`,
    'command line',
    'cli documentation',
    'terminal commands',
    `page ${currentPage}`,
    'pagination',
    'command reference',
  ];

  pageData = {
    currentPage,
    totalPages,
    totalCommands,
    currentPageCommands,
    breadcrumbItems,
    seoTitle,
    seoDescription,
    canonical,
    paginatedPlatformKeywords,
  };
} else if (command) {
  // Handle command route: /tldr/[platform]/[command]
  const startDb = Date.now();
  const page = await getTldrPage(platform, command);
  const duration = Date.now() - startDb;
  // console.log(`[TLDR_SLUG_PAGE] getTldrPage(${platform}, ${command}) finished in ${duration}ms`);
  
  if ((Astro.locals as any).timings) {
    (Astro.locals as any).timings['db fetch'] = duration;
  }

  if (!page) {
    return Astro.redirect('/404');
  }

  htmlContent = page.html_content || '';
  
  const title = page.metadata.title || command;
  const description = page.metadata.description || `Documentation for ${command} command`;

  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'TLDR', href: '/freedevtools/tldr/' },
    { label: platform, href: `/freedevtools/tldr/${platform}/` },
    { label: command },
  ];

  commandData = {
    page,
    title,
    description,
    breadcrumbItems,
  };
} else {
  return Astro.redirect('/404');
}

---

{pageData ? (
  <BaseLayout
    name={`${platform} Commands`}
    path={`/freedevtools/tldr/${platform}/${pageData.currentPage}/`}
    title={pageData.seoTitle}
    description={pageData.seoDescription}
    canonical={pageData.canonical}
    showHeader={true}
    totalItems={pageData.totalCommands}
    itemsPerPage={30}
    currentPage={pageData.currentPage}
    category={`${platform} Commands`}
    partOf="TLDR"
    partOfUrl="https://hexmos.com/freedevtools/tldr/"
    keywords={pageData.paginatedPlatformKeywords}
    features={[
      'Quick Reference',
      'Platform Specific',
      'Practical Examples',
      'No Registration',
    ]}
  >
    <TldrPlatform
      commands={pageData.currentPageCommands}
      currentPage={pageData.currentPage}
      totalPages={pageData.totalPages}
      totalCommands={pageData.totalCommands}
      platform={platform}
      breadcrumbItems={pageData.breadcrumbItems}
    />
  </BaseLayout>
) : commandData ? (
  <BaseLayout
    name={commandData.title}
    path={`/tldr/${platform}/${command}/`}
    title={`${commandData.title} - ${platform} Commands - TLDR | Online Free DevTools by Hexmos`}
    description={commandData.description}
    canonical={`https://hexmos.com/freedevtools/tldr/${platform}/${command}/`}
    showHeader={true}
    keywords={commandData.page.metadata.keywords || ['free devtools', 'tldr', platform, command]}
  >
    <style>
      :global(.prose h1) {
        display: none !important;
      }
      :global(.prose code::before),
      :global(.prose code::after) {
        content: none !important;
      }
      :global(.prose p code::before),
      :global(.prose p code::after),
      :global(.prose li code::before),
      :global(.prose li code::after) {
        content: none !important;
      }
    </style>
    <ToolContainer>
      <div class="mb-16 mt-[74px]">
        <AdBanner />
      </div>
      <ToolHead
        name={commandData.title}
        description={commandData.description}
        breadcrumbItems={commandData.breadcrumbItems}
      />

      <div class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-6 mt-6">
        <div
          class="prose prose-slate dark:prose-invert max-w-none prose-headings:text-slate-900 dark:prose-headings:text-slate-100 prose-p:text-slate-700 dark:prose-p:text-slate-300 prose-code:text-blue-600 dark:prose-code:text-blue-400 prose-code:bg-slate-100 dark:prose-code:bg-slate-700 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-pre:bg-slate-100 dark:prose-pre:bg-slate-800 prose-pre:border prose-pre:border-slate-200 dark:prose-pre:border-slate-600 prose-blockquote:border-l-blue-500 prose-blockquote:bg-slate-100 dark:prose-blockquote:bg-slate-700 prose-blockquote:px-4 prose-blockquote:py-2 prose-blockquote:rounded prose-ul:space-y-1 prose-li:text-slate-700 dark:prose-li:text-slate-300"
          set:html={htmlContent}
        />
      </div>
      
      <div
        class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700"
      >
        <SeeAlsoIndex />
        <div class="mb-8">
          <Banner type="text" />
        </div>
        <div class="flex flex-wrap gap-4">
          <a
            href={`/freedevtools/tldr/${platform}/`}
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
          >
            ‚Üê Back to {platform} commands
          </a>
          <a
            href="/freedevtools/tldr/"
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
          >
            tldr
          </a>
          <CreditsButton href="/freedevtools/tldr/credits/" />
        </div>
      </div>
    </ToolContainer>
  </BaseLayout>
) : null}