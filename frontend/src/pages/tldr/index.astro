---
import { getAllTldrClusters } from '../../../db/tldrs/tldr-utils';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { formatNumber } from '../../lib/utils';
import Tldr from './_Tldr.astro';

// Get page 1 of platforms
const start = Date.now();
const allClusters = await getAllTldrClusters();
// console.log(
//   `[TLDR_PAGE] getAllTldrClusters() finished in ${Date.now() - start}ms`
// );

if (!allClusters) {
  return Astro.redirect('/404');
}

const itemsPerPage = 30;
const totalPlatforms = allClusters.length;
const totalPages = Math.ceil(totalPlatforms / itemsPerPage);
const currentPage = 1;

const platforms = allClusters.slice(0, itemsPerPage).map((c) => ({
  name: c.name,
  count: c.count,
  url: `/freedevtools/tldr/${c.name}/`,
  commands: c.preview_commands,
}));

const totalCommands = allClusters.reduce((acc, c) => acc + c.count, 0);

// Breadcrumb data
const breadcrumbItems = [
  { label: 'Free DevTools', href: '/freedevtools/' },
  { label: 'TLDR' },
];

// SEO data
const seoTitle =
  currentPage === 1
    ? 'TLDR - Command Line Documentation | Online Free DevTools by Hexmos'
    : `TLDR - Page ${currentPage} | Online Free DevTools by Hexmos`;

const seoDescription =
  currentPage === 1
    ? `Comprehensive documentation for ${formatNumber(totalCommands)}+ command-line tools across different platforms. Learn commands quickly with practical examples.`
    : `Browse page ${currentPage} of our TLDR command documentation. Learn command-line tools across different platforms.`;

const canonical =
  currentPage === 1
    ? 'https://hexmos.com/freedevtools/tldr/'
    : `https://hexmos.com/freedevtools/tldr/${currentPage}/`;

// Enhanced keywords for main page
const mainKeywords = [
  'tldr',
  'command line',
  'cli documentation',
  'terminal commands',
  'bash commands',
  'linux commands',
  'unix commands',
  'command reference',
  'cli documentation',
  'terminal reference',
];
---

<BaseLayout
  name="TLDR"
  path={currentPage === 1
    ? '/freedevtools/tldr/'
    : `/freedevtools/tldr/${currentPage}/`}
  title={seoTitle}
  description={seoDescription}
  canonical={canonical}
  showHeader={true}
  totalItems={totalPlatforms}
  itemsPerPage={itemsPerPage}
  currentPage={currentPage}
  category="TLDR"
  partOf="Free DevTools"
  partOfUrl="https://hexmos.com/freedevtools/"
  keywords={mainKeywords}
  features={[
    'Quick Reference',
    'Platform Specific',
    'Practical Examples',
    'No Registration',
  ]}
>
  <Tldr
    platforms={platforms}
    currentPage={currentPage}
    totalPages={totalPages}
    totalPlatforms={totalPlatforms}
    totalCommands={totalCommands}
    breadcrumbItems={breadcrumbItems}
  />
</BaseLayout>
