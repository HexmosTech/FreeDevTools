---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { getAllManpages, getPagesBySubcategory, getMainCategoryDisplayName } from '../../../../lib/manpages';
import AdBanner from '../../../../components/banner/AdBanner';

export async function getStaticPaths() {
  const allManpages = await getAllManpages();
  const paths: Array<{ params: { mainCategory: string; subcategory: string } }> = [];
  
  for (const [mainCategory, subcategories] of Object.entries(allManpages)) {
    for (const subcategory of Object.keys(subcategories)) {
      paths.push({
        params: { mainCategory, subcategory }
      });
    }
  }
  
  return paths;
}

const { mainCategory, subcategory } = Astro.params;
const manpages = await getPagesBySubcategory(mainCategory!, subcategory!);

if (!manpages || manpages.length === 0) {
  return Astro.redirect('/404');
}

const categoryDisplayName = getMainCategoryDisplayName(mainCategory!);
const subcategoryDisplayName = subcategory!.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());

// Group by section for better organization
const manpagesBySection = manpages.reduce((acc, page) => {
  const section = page.section || 'misc';
  if (!acc[section]) {
    acc[section] = [];
  }
  acc[section].push(page);
  return acc;
}, {} as Record<string, typeof manpages>);

const sectionNames = {
  '1': 'User Commands',
  '2': 'System Calls',
  '3': 'Library Functions',
  '4': 'Device Files',
  '5': 'File Formats',
  '6': 'Games',
  '7': 'Miscellaneous',
  '8': 'System Administration',
  '9': 'Kernel Routines',
  'misc': 'Miscellaneous'
};
---

<BaseLayout 
  name={`${subcategoryDisplayName} - ${categoryDisplayName}`}
  path={`/m/${mainCategory}/${subcategory}/`}
  title={`${subcategoryDisplayName} - ${categoryDisplayName} | Online Free DevTools by Hexmos`}
  description={`Browse ${manpages.length} ${subcategoryDisplayName} manual pages in ${categoryDisplayName}.`}
  canonical={`https://hexmos.com/freedevtools/m/${mainCategory}/${subcategory}/`}
  themeColor="#059669"
  showSidebar={false}
  showHeader={true}
  totalItems={manpages.length}
>
  <div class="max-w-6xl mx-auto px-2 md:px-6">
    <div class="mb-16 mt-[74px]">
      <AdBanner />
    </div>
    
    <nav class="text-sm text-slate-600 dark:text-slate-400 mb-6">
      <a href="/freedevtools/" class="hover:text-green-600 dark:hover:text-green-400">Free DevTools</a>
      <span class="mx-2">/</span>
      <a href="/freedevtools/m/" class="hover:text-green-600 dark:hover:text-green-400">Manual Pages</a>
      <span class="mx-2">/</span>
      <a href={`/freedevtools/m/${mainCategory}/`} class="hover:text-green-600 dark:hover:text-green-400">{categoryDisplayName}</a>
      <span class="mx-2">/</span>
      <span>{subcategoryDisplayName}</span>
    </nav>

    <div class="mb-8">
      <h1 class="text-3xl font-bold text-slate-900 dark:text-slate-100 mb-4">
        {subcategoryDisplayName}
      </h1>
      <p class="text-lg text-slate-600 dark:text-slate-400">
        {manpages.length} manual pages in {categoryDisplayName}
      </p>
    </div>

    <div class="space-y-8">
      {Object.entries(manpagesBySection).sort(([a], [b]) => {
        // Sort sections numerically, with 'misc' last
        if (a === 'misc') return 1;
        if (b === 'misc') return -1;
        return parseInt(a) - parseInt(b);
      }).map(([section, pages]) => (
        <div class="bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800 p-6">
          <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100 mb-4">
            Section {section}: {sectionNames[section] || 'Unknown'}
          </h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {pages.map((page) => (
              <a 
                href={`/freedevtools/m/${mainCategory}/${subcategory}/${page.name}/`}
                class="block p-4 rounded-lg border border-slate-200 dark:border-slate-700 hover:border-green-300 dark:hover:border-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 transition-all duration-200"
              >
                <div class="font-mono text-sm text-green-600 dark:text-green-400 font-medium">
                  {page.name}
                </div>
                {page.description && (
                  <div class="text-xs text-slate-600 dark:text-slate-400 mt-1 line-clamp-2">
                    {page.description}
                  </div>
                )}
              </a>
            ))}
          </div>
        </div>
      ))}
    </div>

    <div class="mt-8 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700">
      <div class="flex flex-wrap gap-4">
        <a 
          href={`/freedevtools/m/${mainCategory}/`}
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors"
        >
          ‚Üê Back to {categoryDisplayName}
        </a>
        <a 
          href="/freedevtools/m/"
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
        >
          All manual pages
        </a>
      </div>
    </div>
  </div>
</BaseLayout>