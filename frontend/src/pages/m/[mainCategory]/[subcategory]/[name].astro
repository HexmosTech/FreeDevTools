---
import AdBanner from '../../../../components/banner/AdBanner';
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { getManpage, getMainCategoryDisplayName } from '../../../../lib/manpages';

export async function getStaticPaths() {
  const pageFiles = import.meta.glob('/src/pages/html_pages/manpages/**/*.html', { eager: true });
  const paths: Array<{ params: { mainCategory: string; subcategory: string; name: string } }> = [];
  
  for (const path of Object.keys(pageFiles)) {
    const pathParts = path.split('/');
    if (pathParts.length < 7) continue; // Skip if not proper structure
    
    const mainCategory = pathParts[pathParts.length - 3];
    const subcategory = pathParts[pathParts.length - 2];
    const fileName = pathParts[pathParts.length - 1];
    const name = fileName.replace('.html', '');
    
    paths.push({
      params: { mainCategory, subcategory, name }
    });
  }
  
  return paths;
}

const { mainCategory, subcategory, name } = Astro.params;
const manpageResult = await getManpage(mainCategory!, subcategory!, name!);

if (!manpageResult) {
  return Astro.redirect('/404');
}

const { htmlContent, metatags } = manpageResult;

// Use metatags for title and description, with fallbacks
const title = metatags.title || name;
const description = metatags.description || `Manual page for ${name}`;

// Extract section from name if available
const sectionMatch = name!.match(/\.(\d+)/);
const section = sectionMatch ? sectionMatch[1] : null;

const categoryDisplayName = getMainCategoryDisplayName(mainCategory!);
const subcategoryDisplayName = subcategory!.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
---

<BaseLayout 
  name={title}
  path={`/m/${mainCategory}/${subcategory}/${name}/`}
  title={`${title} - ${subcategoryDisplayName} | Online Free DevTools by Hexmos`}
  description={description}
  canonical={`https://hexmos.com/freedevtools/m/${mainCategory}/${subcategory}/${name}/`}
  themeColor="#059669"
  showSidebar={false}
  showHeader={true}
>
  <div class="max-w-5xl mx-auto px-2 md:px-6">
    <div class="mb-16 mt-[74px]">
      <AdBanner />
    </div>
    
    <nav class="text-sm text-slate-600 dark:text-slate-400 mb-6">
      <a href="/freedevtools/" class="hover:text-green-600 dark:hover:text-green-400">Free DevTools</a>
      <span class="mx-2">/</span>
      <a href="/freedevtools/m/" class="hover:text-green-600 dark:hover:text-green-400">Manual Pages</a>
      <span class="mx-2">/</span>
      <a href={`/freedevtools/m/${mainCategory}/`} class="hover:text-green-600 dark:hover:text-green-400">{categoryDisplayName}</a>
      <span class="mx-2">/</span>
      <a href={`/freedevtools/m/${mainCategory}/${subcategory}/`} class="hover:text-green-600 dark:hover:text-green-400">{subcategoryDisplayName}</a>
      <span class="mx-2">/</span>
      <span class="font-mono">{name}</span>
    </nav>

    <article class="max-w-none">
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-slate-900 dark:text-slate-100 mb-4 font-mono">
          {name} {section && `(${section})`}
        </h1>
        <div class="flex flex-wrap gap-2 mb-4">
          <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 rounded">
            {categoryDisplayName}
          </span>
          <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-300 rounded">
            {subcategoryDisplayName}
          </span>
          {section && (
            <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 rounded">
              Section {section}
            </span>
          )}
        </div>
        <p class="text-lg text-slate-600 dark:text-slate-400 mb-4">
          {description}
        </p>
      </header>

      <div class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-6">
        <div class="manpage-content prose prose-slate dark:prose-invert max-w-none" set:html={htmlContent} />
      </div>
    </article>

    <div class="mt-8 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700">
      <div class="flex flex-wrap gap-4">
        <a 
          href={`/freedevtools/m/${mainCategory}/${subcategory}/`}
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors"
        >
          ‚Üê Back to {subcategoryDisplayName}
        </a>
        <a 
          href={`/freedevtools/m/${mainCategory}/`}
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
        >
          {categoryDisplayName}
        </a>
        <a 
          href="/freedevtools/m/"
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
        >
          All manual pages
        </a>
      </div>
    </div>
  </div>

  <style>
    .manpage-content {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .manpage-content pre {
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .manpage-content a {
      color: #059669;
      text-decoration: underline;
    }
    
    .manpage-content a:hover {
      color: #047857;
    }
    
    .dark .manpage-content a {
      color: #10b981;
    }
    
    .dark .manpage-content a:hover {
      color: #34d399;
    }
    
    .manpage-content h4 {
      font-weight: bold;
      margin-top: 2rem;
      margin-bottom: 1rem;
      color: #374151;
    }
    
    .dark .manpage-content h4 {
      color: #d1d5db;
    }
  </style>
</BaseLayout>