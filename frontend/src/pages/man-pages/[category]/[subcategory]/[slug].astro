---
import AdBanner from '@/components/banner/AdBanner.astro';
import CreditsButton from '@/components/buttons/CreditsButton';
import Pagination from '@/components/PaginationComponent.astro';
import SeeAlsoIndex from '@/components/seealso/SeeAlsoIndex.astro';
import ToolContainer from '@/components/tool/ToolContainer';
import ToolHead from '@/components/tool/ToolHead';
import BaseLayout from '@/layouts/BaseLayout.astro';
import {
  getManPageBySlug,
  getManPagesBySubcategoryPaginated,
  getManPagesCountBySubcategory,
} from 'db/man_pages/man-pages-utils';

export const prerender = false;

const { category, subcategory, slug } = Astro.params;

// Ensure all required params are present
if (!category || !subcategory || !slug) {
  return Astro.redirect('/freedevtools/man-pages/');
}

// Check if slug is numeric (pagination)
const isNumericPage = /^\d+$/.test(slug);

// --- VARIABLES FOR BOTH VIEWS ---
let pageTitle = '';
let pageDescription = '';
let breadcrumbItems: any[] = [];
let currentPage = 1;
let totalPages = 1;
let isPaginationView = false;

// Variables specific to pagination view
let currentPageManPages: any[] = [];
let totalManPagesCount = 0;

// Variables specific to man page view
let manPage: any = null;
let tocSections: any[] = [];

if (isNumericPage) {
  // --- PAGINATION LOGIC (formerly [page].astro) ---
  isPaginationView = true;
  currentPage = parseInt(slug, 10);

  // Get total count of man pages for this subcategory to determine pagination
  totalManPagesCount = getManPagesCountBySubcategory(
    category,
    subcategory
  );
  const itemsPerPage = 20;
  totalPages = Math.ceil(totalManPagesCount / itemsPerPage);

  // Redirect if page is out of range or invalid (optional but good practice)
  if (currentPage < 1 || (totalPages > 0 && currentPage > totalPages)) {
    return Astro.redirect(
      `/freedevtools/man-pages/${category}/${subcategory}/`
    );
  }

  // Calculate pagination
  const offset = (currentPage - 1) * itemsPerPage;

  // Get ONLY the man pages for current page from database (efficient!)
  currentPageManPages = getManPagesBySubcategoryPaginated(
    category,
    subcategory,
    itemsPerPage,
    offset
  );

  const categoryTitle = category.replace('-', ' ').charAt(0).toUpperCase() + category.replace('-', ' ').slice(1);
  const subcategoryTitle = subcategory.replace('-', ' ').charAt(0).toUpperCase() + subcategory.replace('-', ' ').slice(1);

  pageTitle = `${subcategoryTitle} Man Pages - Page ${currentPage}`;
  pageDescription = `Browse ${subcategoryTitle} manual pages - Page ${currentPage} of ${totalPages}. Find detailed documentation and system references.`;

  breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'Man Pages', href: '/freedevtools/man-pages/' },
    { label: categoryTitle, href: `/freedevtools/man-pages/${category}/` },
    { label: subcategoryTitle, href: `/freedevtools/man-pages/${category}/${subcategory}/` },
    { label: `Page ${currentPage}` },
  ];

} else {
  // --- MAN PAGE LOGIC (formerly [slug].astro) ---
  isPaginationView = false;
  
  // Get man page from database by slug
  manPage = getManPageBySlug(category, subcategory, slug);

  if (!manPage) {
    // Redirect to man pages index if not found
    return Astro.redirect('/freedevtools/man-pages/');
  }

  // Generate table of contents from sections
  tocSections = Object.keys(manPage.content).map((section) => ({
    id: section.toLowerCase(),
    label: section,
  }));

  pageTitle = `${manPage.title} - Manual Page`;
  pageDescription = `${manPage.title} manual page. Learn about ${manPage.title.split(' — ')[1] || manPage.title.split(' — ')[0]} in systems.`;

  breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'Man Pages', href: '/freedevtools/man-pages/' },
    {
      label: manPage.main_category.replace('-', ' ').charAt(0).toUpperCase() + manPage.main_category.replace('-', ' ').slice(1),
      href: `/freedevtools/man-pages/${manPage.main_category}/`,
    },
    {
      label: manPage.sub_category.replace('-', ' ').charAt(0).toUpperCase() + manPage.sub_category.replace('-', ' ').slice(1),
      href: `/freedevtools/man-pages/${manPage.main_category}/${manPage.sub_category}/`,
    },
    {
      label: manPage.slug,
      href: `/freedevtools/man-pages/${manPage.main_category}/${manPage.sub_category}/${manPage.slug}/`,
    },
  ];
}

const subcategoryTitle = subcategory.replace('-', ' ').charAt(0).toUpperCase() + subcategory.replace('-', ' ').slice(1);
const categoryTitle = category.replace('-', ' ').charAt(0).toUpperCase() + category.replace('-', ' ').slice(1);
---

<BaseLayout
  name={isPaginationView ? `${subcategoryTitle} Man Pages - Page ${currentPage}` : manPage.title}
  title={isPaginationView ? `${subcategoryTitle} Manual Pages - Page ${currentPage} of ${totalPages} | Free DevTools by Hexmos` : `${manPage.title} - Manual Page | Free DevTools by Hexmos`}
  path={`/freedevtools/man-pages/${category}/${subcategory}/${slug}/`}
  description={pageDescription}
  canonical={`https://hexmos.com/freedevtools/man-pages/${category}/${subcategory}/${slug}/`}
  keywords={isPaginationView 
    ? [subcategory, category, 'man pages', 'manual', 'documentation', `page ${currentPage}`]
    : [manPage.title.split(' — ')[0], category, subcategory, 'man page', 'manual', 'documentation']
  }
  ogImage="https://hexmos.com/freedevtools/tool-banners/man-pages-banner.png"
  twitterImage="https://hexmos.com/freedevtools/tool-banners/man-pages-banner.png"
  datePublished="2025-01-30"
  softwareVersion="1.0.0"
>
  <ToolContainer>
    <div class="mb-16 mt-[74px]">
      <AdBanner />
    </div>
    <ToolHead
      name={isPaginationView ? `${subcategoryTitle} Man Pages` : manPage.title}
      description={isPaginationView ? `Browse ${subcategoryTitle} manual pages with detailed documentation.` : ""}
      breadcrumbItems={breadcrumbItems}
    />

    {isPaginationView ? (
      <>
        <!-- Pagination Info -->
        <div
          id="pagination-info-content"
          class="bg-slate-50 dark:bg-slate-800 rounded-lg p-4 mb-6 mt-8"
        >
          <div class="text-sm text-slate-600 dark:text-slate-400 text-center">
            Showing {currentPageManPages.length} of {totalManPagesCount} man pages (Page {currentPage} of {totalPages})
          </div>
        </div>
    
        <!-- Man Pages Grid -->
        <div class="mt-8">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {currentPageManPages.map((page) => (
              <a
                href={`/freedevtools/man-pages/${category}/${subcategory}/${page.slug}/`}
                class="block bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6 hover:shadow-lg transition-shadow min-h-[120px]"
              >
                <h3
                  class="text-base font-semibold text-gray-900 dark:text-gray-100 leading-relaxed break-words"
                  style="word-break:break-all; overflow:hidden; max-width:100%;"
                  title={page.title}
                >
                  {page.title.length > 60
                    ? page.title.slice(0, 57) + '...'
                    : page.title}
                </h3>
              </a>
            ))}
          </div>
        </div>
    
        <!-- Pagination -->
        <Pagination
          currentPage={currentPage}
          totalPages={totalPages}
          baseUrl={`/freedevtools/man-pages/${category}/${subcategory}/`}
        />
      </>
    ) : (
      <>
        <!-- Table of Contents -->
        <div
          class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-0 rounded-lg p-4 mb-6"
        >
          <h2 class="text-lg font-semibold mb-3">Contents</h2>
          <nav class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
            {tocSections.map((section) => (
              <a
                href={`#${section.id}`}
                class="block px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors"
              >
                {section.label}
              </a>
            ))}
          </nav>
        </div>
    
        <!-- Main Content -->
        <div class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-6">
          <!-- Man Page Content -->
          <div class="space-y-8">
            {Object.entries(manPage.content).map(([section, content]) => (
              <section id={section.toLowerCase()}>
                <h2 class="text-xl font-bold font-mono mb-4 scroll-mt-32">
                  {section}
                </h2>
                <div
                  class="font-mono text-sm leading-relaxed whitespace-pre-wrap bg-white dark:bg-slate-900 p-2 rounded border border-slate-200 dark:border-slate-700 overflow-x-auto"
                  set:html={content}
                />
              </section>
            ))}
          </div>
        </div>
    
        <SeeAlsoIndex />
      </>
    )}

    <!-- Credits Section -->
    <div class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700">
      <div class="flex flex-wrap gap-4">
        <a
          href={`/freedevtools/man-pages/${category}/`}
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
        >
          View {categoryTitle} Category
        </a>
        {isPaginationView ? (
           <a
            href={`/freedevtools/man-pages/${category}/${subcategory}/`}
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
          >
            ← Back to {subcategoryTitle}
          </a>
        ) : (
          <a
            href={`/freedevtools/man-pages/${manPage.main_category}/${manPage.sub_category}/`}
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
          >
            ← Back to {manPage.sub_category.replace('-', ' ').charAt(0).toUpperCase() + manPage.sub_category.replace('-', ' ').slice(1)}
          </a>
        )}
        <CreditsButton href="/freedevtools/man-pages/credits/" />
      </div>
    </div>
  </ToolContainer>
</BaseLayout>

<style>
  /* Custom styles for man page content */
  .font-mono pre {
    font-family: 'Courier New', monospace;
  }

  /* Print styles */
  @media print {
    .sticky {
      position: static !important;
    }
    .lg\:order-2 {
      order: -1 !important;
    }
    .lg\:col-span-3 {
      grid-column: span 4 !important;
    }
  }
</style>
