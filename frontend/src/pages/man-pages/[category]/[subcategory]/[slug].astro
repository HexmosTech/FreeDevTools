---
import AdBanner from '@/components/banner/AdBanner.astro';
import CreditsButton from '@/components/buttons/CreditsButton';
import ToolContainer from '@/components/tool/ToolContainer';
import ToolHead from '@/components/tool/ToolHead';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getManPageBySlug } from '@/lib/man-pages-utils';
import SeeAlsoIndex from '@/components/seealso/SeeAlsoIndex.astro';

export const prerender = false;

const { category, subcategory, slug } = Astro.params;
const urlPath = Astro.url.pathname;

// Ensure all required params are present
if (!category || !subcategory || !slug) {
  return new Response(null, { status: 404 });
}

// Redirect to add trailing slash if missing
if (!urlPath.endsWith('/')) {
  return Astro.redirect(`${urlPath}/`, 301);
}

// Check if slug is numeric (pagination route)
if (/^\d+$/.test(slug)) {
  // This is actually a pagination route
  const currentPage = parseInt(slug, 10);
  
  // Redirect /man-pages/category/subcategory/1 to /man-pages/category/subcategory
  if (currentPage === 1) {
    return Astro.redirect(`/freedevtools/man-pages/${category}/${subcategory}/`);
  }
  
  // Redirect to subcategory pagination route
  return Astro.redirect(`/freedevtools/man-pages/${category}/${subcategory}/${currentPage}/`, 301);
}

// Get man page from database by slug
const manPage = getManPageBySlug(category, subcategory, slug);

if (!manPage) {
  // Return 404 if not found
  return new Response(null, { status: 404 });
}

// Generate table of contents from sections
const tocSections = Object.keys(manPage.content).map(section => ({
  id: section.toLowerCase(),
  label: section,
}));

const breadcrumbItems = [
  { label: 'Free DevTools', href: '/freedevtools/' },
  { label: 'Man Pages', href: '/freedevtools/man-pages/' },
  { label: manPage.main_category.replace('-', ' ').charAt(0).toUpperCase() + manPage.main_category.replace('-', ' ').slice(1), href: `/freedevtools/man-pages/${manPage.main_category}/` },
  { label: manPage.sub_category.replace('-', ' ').charAt(0).toUpperCase() + manPage.sub_category.replace('-', ' ').slice(1), href: `/freedevtools/man-pages/${manPage.main_category}/${manPage.sub_category}/` },
  { label: manPage.slug, href: `/freedevtools/man-pages/${manPage.main_category}/${manPage.sub_category}/${manPage.slug}/` },
];
---

<BaseLayout
  name={`${manPage.title}`}
  title={`${manPage.title} - Manual Page | Free DevTools by Hexmos`}
  path={`/freedevtools/man-pages/${category}/${subcategory}/${slug}/`}
  description={`${manPage.title} manual page. Learn about ${manPage.title.split(' — ')[1] || manPage.title.split(' — ')[0]} in systems.`}
  canonical={`https://hexmos.com/freedevtools/man-pages/${category}/${subcategory}/${slug}/`}
  keywords={[manPage.title.split(' — ')[0], category, subcategory, 'man page', 'manual', 'documentation']}
  ogImage="https://hexmos.com/freedevtools/tool-banners/man-pages-banner.png"
  twitterImage="https://hexmos.com/freedevtools/tool-banners/man-pages-banner.png"
  datePublished="2025-01-30"
  softwareVersion="1.0.0"
>
  <ToolContainer>
    <div class="mb-16 mt-[74px]">
      <AdBanner />
    </div>
    <ToolHead
      name={manPage.title}
      description=""
      breadcrumbItems={breadcrumbItems}
    />

    <!-- Table of Contents -->
    <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-0 rounded-lg p-4 mb-6">
      <h2 class="text-lg font-semibold mb-3">Contents</h2>
      <nav class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
        {tocSections.map((section) => (
          <a
            href={`#${section.id}`}
            class="block px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors"
          >
            {section.label}
          </a>
        ))}
      </nav>
    </div>

    <!-- Main Content -->
    <div class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-6">
      <!-- Man Page Content -->
      <div class="space-y-8">
        {Object.entries(manPage.content).map(([section, content]) => (
          <section id={section.toLowerCase()}>
            <h2 class="text-xl font-bold font-mono mb-4 scroll-mt-32">
              {section}
            </h2>
            <div 
              class="font-mono text-sm leading-relaxed whitespace-pre-wrap bg-white dark:bg-slate-900 p-2 rounded border border-slate-200 dark:border-slate-700 overflow-x-auto"
              set:html={content}
            />
          </section>
        ))}
      </div>
    </div>

    <SeeAlsoIndex />

    <!-- Credits Section -->
    <div class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700">
      <div class="flex flex-wrap gap-4">
        <a
          href={`/freedevtools/man-pages/${manPage.main_category}/`}
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
        >
          View {manPage.main_category.replace('-', ' ').charAt(0).toUpperCase() + manPage.main_category.replace('-', ' ').slice(1)} Category
        </a>
        <a
          href={`/freedevtools/man-pages/${manPage.main_category}/${manPage.sub_category}/`}
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
        >
          ← Back to {manPage.sub_category.replace('-', ' ').charAt(0).toUpperCase() + manPage.sub_category.replace('-', ' ').slice(1)}
        </a>
        <CreditsButton href="/freedevtools/man-pages/credits/" />
      </div>
    </div>
  </ToolContainer>
</BaseLayout>

<style>
  /* Custom styles for man page content */
  .font-mono pre {
    font-family: 'Courier New', monospace;
  }
  
  /* Print styles */
  @media print {
    .sticky { position: static !important; }
    .lg\\:order-2 { order: -1 !important; }
    .lg\\:col-span-3 { grid-column: span 4 !important; }
  }
</style>
