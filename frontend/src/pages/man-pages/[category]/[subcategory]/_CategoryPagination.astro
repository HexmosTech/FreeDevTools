---
import AdBanner from '@/components/banner/AdBanner.astro';
import CreditsButton from '@/components/buttons/CreditsButton';
import Pagination from '@/components/PaginationComponent.astro';
import ToolContainer from '@/components/tool/ToolContainer';
import ToolHead from '@/components/tool/ToolHead';
import BaseLayout from '@/layouts/BaseLayout.astro';
import {
  getTotalSubCategoriesManPagesCount,
  getSubCategoriesByMainCategoryPaginated,
} from 'db/man_pages/man-pages-utils';
import { formatName } from '@/lib/utils';

const { category, page } = Astro.props;


// This handles /man-pages/user-commands/2/ (Page 2 of subcategories list)

const currentPage = parseInt(page, 10);

// Get subcategories count for this category to determine pagination
const {man_pages_count, sub_category_count} = await getTotalSubCategoriesManPagesCount(category);


const itemsPerPage = 12;
const totalPages = Math.ceil(sub_category_count / itemsPerPage);
// Redirect if page is out of range or invalid
if (currentPage < 1 || (totalPages > 0 && currentPage > totalPages)) {
  return Astro.redirect(`/freedevtools/man-pages/${category}/`);
}

// Calculate pagination
const offset = (currentPage - 1) * itemsPerPage;

// Get ONLY the subcategories for current page from database (efficient!)
const subcategories = await getSubCategoriesByMainCategoryPaginated(
  category,
  itemsPerPage,
  offset
);

const categoryTitle = formatName(category);

const pageTitle = `${categoryTitle} Man Pages - Page ${currentPage}`;
const pageDescription = `Browse ${categoryTitle} manual page subcategories - Page ${currentPage} of ${totalPages}. Find detailed documentation and system references.`;

const breadcrumbItems = [
  { label: 'Free DevTools', href: '/freedevtools/' },
  { label: 'Man Pages', href: '/freedevtools/man-pages/' },
  { label: categoryTitle, href: `/freedevtools/man-pages/${category}/` },
  { label: `Page ${currentPage}` },
];
---

<BaseLayout
  name={pageTitle}
  title={`${pageTitle} | Free DevTools by Hexmos`}
  path={`/freedevtools/man-pages/${category}/${page}/`}
  description={pageDescription}
  canonical={`https://hexmos.com/freedevtools/man-pages/${category}/${page}/`}
  keywords={['man pages', 'manual', 'documentation', category]}
  ogImage="https://hexmos.com/freedevtools/tool-banners/man-pages-banner.png"
  twitterImage="https://hexmos.com/freedevtools/tool-banners/man-pages-banner.png"
  datePublished="2025-01-30"
  softwareVersion="1.0.0"
>
  <ToolContainer>
    <div class="mb-16 mt-[74px]">
      <AdBanner />
    </div>
    <ToolHead
      name={`${categoryTitle} Man Pages`}
      description={`Browse ${categoryTitle} manual page subcategories with detailed documentation.`}
      breadcrumbItems={breadcrumbItems}
    />

    <!-- Overview Stats -->
    <div class="text-center">
      <div class="grid grid-cols-2 gap-6 mt-8">
        <div class="text-center">
          <div class="text-3xl font-bold text-blue-600">
            {
              sub_category_count >= 1000
                ? Math.round(sub_category_count / 1000) + 'k'
                : sub_category_count
            }
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">
            Subcategories
          </div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-green-600">
            {man_pages_count >= 1000
              ? Math.round(man_pages_count / 1000) + 'k'
              : man_pages_count}
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400">
            Man Pages
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination Info -->
    <div
      id="pagination-info-content"
      class="bg-slate-50 dark:bg-slate-800 rounded-lg p-4 mb-6 mt-8"
    >
      <div class="text-sm text-slate-600 dark:text-slate-400 text-center">
        Showing {subcategories.length} of {sub_category_count} subcategories (Page {currentPage} of {totalPages})
      </div>
    </div>

    <!-- Grid Content -->
    <div class="mt-8">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {
          subcategories.map((subcategory) => (
            <a
              href={`/freedevtools/man-pages/${category}/${subcategory.name}/`}
              class="block bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6 hover:shadow-lg transition-shadow min-h-[120px]"
            >
              <div class="flex items-start justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 capitalize">
                  {subcategory.name.replace('-', ' ')}
                </h3>
                <span class="text-xs font-mono bg-blue-100 dark:bg-blue-900/20 text-blue-800 dark:text-blue-400 px-2 py-1 rounded">
                  {subcategory.count} pages
                </span>
              </div>
              {subcategory.description && (
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  {subcategory.description}
                </p>
              )}
            </a>
          ))
        }
      </div>
    </div>

    <!-- Show message if no items -->
    {
      sub_category_count === 0 && (
        <div class="mt-8 text-center py-12">
          <p class="text-gray-500 dark:text-gray-400">
            No subcategories found.
          </p>
        </div>
      )
    }

    <!-- Pagination -->
    <Pagination
      currentPage={currentPage}
      totalPages={totalPages}
      baseUrl={`/freedevtools/man-pages/${category}/`}
    />

    <!-- Credits Section -->
    <div
      class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700"
    >
      <div class="flex flex-wrap gap-4">
        <a
          href={`/freedevtools/man-pages/${category}/`}
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
        >
          View {categoryTitle} Category
        </a>
        <CreditsButton href="/freedevtools/man-pages/credits/" />
      </div>
    </div>
  </ToolContainer>
</BaseLayout>
