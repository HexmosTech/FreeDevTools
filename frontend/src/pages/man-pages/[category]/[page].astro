---
import AdBanner from '@/components/banner/AdBanner.astro';
import CreditsButton from '@/components/buttons/CreditsButton';
import Pagination from '@/components/PaginationComponent.astro';
import ToolContainer from '@/components/tool/ToolContainer';
import ToolHead from '@/components/tool/ToolHead';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCategories, getManPagesBySubcategoryPaginated, getManPagesCountBySubcategory, getSubCategoriesByMainCategory, getSubCategoriesByMainCategoryPaginated, getSubCategoriesCountByMainCategory, getTotalManPagesCountByMainCategory } from '@/lib/man-pages-utils';

export const prerender = false;

const { category, page } = Astro.params;
const urlPath = Astro.url.pathname;

if (!category || !page) {
  return new Response(null, { status: 404 });
}

// Redirect to add trailing slash if missing (BEFORE other checks)
if (!urlPath.endsWith('/')) {
  return Astro.redirect(`${urlPath}/`, 301);
}

let subcategoryData: any = null;
let paginationData: any = null;

// Check if page is numeric
if (!/^\d+$/.test(page)) {
  // If not numeric, check if it's a valid subcategory
  const subcategories = getSubCategoriesByMainCategory(category);
  const subcategoryNames = subcategories.map((sc) => sc.name);
  
  if (subcategoryNames.includes(page)) {
    // This is a valid subcategory - render subcategory index content directly
    // This is a workaround for route priority: [category]/[page].astro matches /category/subcategory/ before [category]/[subcategory]/index.astro
    const subcategory = page;
    
    // Efficient pagination for page 1
    const itemsPerPage = 20;
    const currentPage = 1;
    const offset = (currentPage - 1) * itemsPerPage;
    
    // Get ONLY the man pages for page 1 from database
    const currentPageManPages = getManPagesBySubcategoryPaginated(category, subcategory, itemsPerPage, offset);
    const totalManPagesCount = getManPagesCountBySubcategory(category, subcategory);
    const totalPages = Math.ceil(totalManPagesCount / itemsPerPage);
    
    const breadcrumbItems = [
      { label: 'Free DevTools', href: '/freedevtools/' },
      { label: 'Man Pages', href: '/freedevtools/man-pages/' },
      { label: category.replace('-', ' ').charAt(0).toUpperCase() + category.replace('-', ' ').slice(1), href: `/freedevtools/man-pages/${category}/` },
      { label: subcategory.replace('-', ' ').charAt(0).toUpperCase() + subcategory.replace('-', ' ').slice(1) },
    ];
    
    const categoryTitle = category.replace('-', ' ').charAt(0).toUpperCase() + category.replace('-', ' ').slice(1);
    const subcategoryTitle = subcategory.replace('-', ' ').charAt(0).toUpperCase() + subcategory.replace('-', ' ').slice(1);
    
    subcategoryData = {
      category,
      subcategory,
      currentPageManPages,
      totalManPagesCount,
      totalPages,
      breadcrumbItems,
      categoryTitle,
      subcategoryTitle,
    };
  } else {
    // Not a valid subcategory or page number - 404
    return new Response(null, { status: 404 });
  }
} else {
  // Validate category exists
  const allCategories = getCategories();
  const categoryNames = allCategories.map((c) => c.name);
  if (!categoryNames.includes(category)) {
    return new Response(null, { status: 404 });
  }

  const currentPage = parseInt(page, 10);

  // Redirect /man-pages/category/1 to /man-pages/category
  if (currentPage === 1) {
    return Astro.redirect(`/freedevtools/man-pages/${category}/`);
  }

  // Calculate pagination
  const itemsPerPage = 12;
  const offset = (currentPage - 1) * itemsPerPage;

  // Get ONLY the subcategories for current page from database (efficient!)
  const currentPageSubcategories = getSubCategoriesByMainCategoryPaginated(category, itemsPerPage, offset);
  const totalSubcategoriesCount = getSubCategoriesCountByMainCategory(category);
  const totalManPagesInCategory = getTotalManPagesCountByMainCategory(category);
  const totalPages = Math.ceil(totalSubcategoriesCount / itemsPerPage);

  // Validate page number
  if (currentPage > totalPages || currentPage < 1) {
    return new Response(null, { status: 404 });
  }

  const breadcrumbItems = [
    { label: 'Free DevTools', href: '/freedevtools/' },
    { label: 'Man Pages', href: '/freedevtools/man-pages/' },
    { label: category.replace('-', ' ').charAt(0).toUpperCase() + category.replace('-', ' ').slice(1) },
    { label: `Page ${currentPage}` },
  ];

  const categoryTitle = category.replace('-', ' ').charAt(0).toUpperCase() + category.replace('-', ' ').slice(1);

  paginationData = {
    category,
    currentPage,
    currentPageSubcategories,
    totalSubcategoriesCount,
    totalManPagesInCategory,
    totalPages,
    breadcrumbItems,
    categoryTitle,
  };
}
---

{subcategoryData ? (
  <BaseLayout
    name={`${subcategoryData.subcategoryTitle} Man Pages`}
    title={`${subcategoryData.subcategoryTitle} Manual Pages - ${subcategoryData.categoryTitle} | Free DevTools by Hexmos`}
    path={`/freedevtools/man-pages/${subcategoryData.category}/${subcategoryData.subcategory}/`}
    description={`Browse ${subcategoryData.subcategoryTitle} manual pages in ${subcategoryData.categoryTitle}. Find detailed documentation and system references.`}
    canonical={`https://hexmos.com/freedevtools/man-pages/${subcategoryData.category}/${subcategoryData.subcategory}/`}
    keywords={[subcategoryData.subcategory, subcategoryData.category, 'man pages', 'manual', 'documentation']}
    ogImage="https://hexmos.com/freedevtools/tool-banners/man-pages-banner.png"
    twitterImage="https://hexmos.com/freedevtools/tool-banners/man-pages-banner.png"
    datePublished="2025-01-30"
    softwareVersion="1.0.0"
  >
    <ToolContainer>
      <div class="mb-16 mt-[74px]">
        <AdBanner />
      </div>
      <ToolHead
        name={`${subcategoryData.subcategoryTitle} Man Pages`}
        description={`Browse ${subcategoryData.subcategoryTitle} manual pages with detailed documentation.`}
        breadcrumbItems={subcategoryData.breadcrumbItems}
      />

      <!-- Overview Stats -->
      <div class="text-center">
        <div class="grid grid-cols-1 gap-6 mt-8">
          <div class="text-center">
            <div class="text-3xl font-bold text-green-600">{subcategoryData.totalManPagesCount >= 1000 ? Math.round(subcategoryData.totalManPagesCount / 1000) + 'k' : subcategoryData.totalManPagesCount}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Man Pages in {subcategoryData.subcategoryTitle}</div>
          </div>
        </div>
      </div>

      <!-- Pagination Info -->
      <div
        id="pagination-info-content"
        class="bg-slate-50 dark:bg-slate-800 rounded-lg p-4 mb-6 mt-8"
      >
        <div class="text-sm text-slate-600 dark:text-slate-400 text-center">
          Showing {subcategoryData.currentPageManPages.length} of {subcategoryData.totalManPagesCount} man pages (Page 1 of {subcategoryData.totalPages})
        </div>
      </div>

      <!-- Man Pages Grid -->
      <div class="mt-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {subcategoryData.currentPageManPages.map((manPage) => (
            <a
              href={`/freedevtools/man-pages/${subcategoryData.category}/${subcategoryData.subcategory}/${manPage.slug}/`}
              class="block bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6 hover:shadow-lg transition-shadow min-h-[120px]"
            >
              <h3 class="text-base text-gray-900 dark:text-gray-100 leading-relaxed">
                {manPage.title.split(' — ')[0]}
              </h3>
            </a>
          ))}
        </div>
      </div>

      <!-- Show message if no man pages -->
      {subcategoryData.totalManPagesCount === 0 && (
        <div class="mt-8 text-center py-12">
          <p class="text-gray-500 dark:text-gray-400">No man pages found in this subcategory.</p>
        </div>
      )}

      <!-- Pagination -->
      <Pagination
        currentPage={1}
        totalPages={subcategoryData.totalPages}
        baseUrl={`/freedevtools/man-pages/${subcategoryData.category}/${subcategoryData.subcategory}/`}
        alwaysIncludePageNumber={true}
      />

      <!-- Credits Section -->
      <div class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700">
        <div class="flex flex-wrap gap-4">
          <a
            href={`/freedevtools/man-pages/${subcategoryData.category}/`}
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
          >
            View {subcategoryData.categoryTitle} Category
          </a>
          <a
            href={`/freedevtools/man-pages/${subcategoryData.category}/${subcategoryData.subcategory}/`}
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
          >
            ← Back to {subcategoryData.subcategoryTitle}
          </a>
          <CreditsButton href="/freedevtools/man-pages/credits/" />
        </div>
      </div>
    </ToolContainer>
  </BaseLayout>
) : paginationData ? (
  <BaseLayout
    name={`${paginationData.categoryTitle} Man Pages - Page ${paginationData.currentPage}`}
    title={`${paginationData.categoryTitle} Manual Pages - Page ${paginationData.currentPage} of ${paginationData.totalPages} | Free DevTools by Hexmos`}
    path={`/freedevtools/man-pages/${paginationData.category}/${paginationData.currentPage}/`}
    description={`Browse ${paginationData.categoryTitle} manual page subcategories - Page ${paginationData.currentPage} of ${paginationData.totalPages}. Find detailed documentation and system references.`}
    canonical={`https://hexmos.com/freedevtools/man-pages/${paginationData.category}/${paginationData.currentPage}/`}
    keywords={[paginationData.category, 'man pages', 'manual', 'documentation', `page ${paginationData.currentPage}`]}
    ogImage="https://hexmos.com/freedevtools/tool-banners/man-pages-banner.png"
    twitterImage="https://hexmos.com/freedevtools/tool-banners/man-pages-banner.png"
    datePublished="2025-01-30"
    softwareVersion="1.0.0"
  >
    <ToolContainer>
      <div class="mb-16 mt-[74px]">
        <AdBanner />
      </div>
      <ToolHead
        name={`${paginationData.categoryTitle} Man Pages`}
        description={`Browse ${paginationData.categoryTitle} manual page subcategories with detailed documentation.`}
        breadcrumbItems={paginationData.breadcrumbItems}
      />

      <!-- Overview Stats -->
      <div class="text-center">
        <div class="grid grid-cols-2 gap-6 mt-8">
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600">{paginationData.totalSubcategoriesCount >= 1000 ? Math.round(paginationData.totalSubcategoriesCount / 1000) + 'k' : paginationData.totalSubcategoriesCount}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Subcategories</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-600">{paginationData.totalManPagesInCategory >= 1000 ? Math.round(paginationData.totalManPagesInCategory / 1000) + 'k' : paginationData.totalManPagesInCategory}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Man Pages</div>
          </div>
        </div>
      </div>

      <!-- Pagination Info -->
      <div
        id="pagination-info-content"
        class="bg-slate-50 dark:bg-slate-800 rounded-lg p-4 mb-6 mt-8"
      >
        <div class="text-sm text-slate-600 dark:text-slate-400 text-center">
          Showing {paginationData.currentPageSubcategories.length} of {paginationData.totalSubcategoriesCount} subcategories (Page {paginationData.currentPage} of {paginationData.totalPages})
        </div>
      </div>

      <!-- Subcategories Grid -->
      <div class="mt-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {paginationData.currentPageSubcategories.map((subcategory) => (
            <a
              href={`/freedevtools/man-pages/${paginationData.category}/${subcategory.name}/`}
              class="block bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6 hover:shadow-lg transition-shadow"
            >
              <div class="flex items-start justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 capitalize">
                  {subcategory.name.replace('-', ' ')}
                </h3>
                <span class="text-xs font-mono bg-blue-100 dark:bg-blue-900/20 text-blue-800 dark:text-blue-400 px-2 py-1 rounded">
                  {subcategory.count} pages
                </span>
              </div>
              {subcategory.description && (
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  {subcategory.description}
                </p>
              )}
            </a>
          ))}
        </div>
      </div>

      <!-- Pagination -->
      <Pagination
        currentPage={paginationData.currentPage}
        totalPages={paginationData.totalPages}
        baseUrl={`/freedevtools/man-pages/${paginationData.category}/`}
        alwaysIncludePageNumber={true}
      />

      <!-- Credits Section -->
      <div class="mt-10 pt-6 mb-8 border-t border-slate-200 dark:border-slate-700">
        <div class="flex flex-wrap gap-4">
          <a
            href="/freedevtools/man-pages/"
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
          >
            ← Back to Man Pages
          </a>
          <CreditsButton href="/freedevtools/man-pages/credits/" />
        </div>
      </div>
    </ToolContainer>
  </BaseLayout>
) : null}
