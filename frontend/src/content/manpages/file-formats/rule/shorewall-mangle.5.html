<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mangle - Shorewall Packet marking/mangling rules file</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/shorewall">shorewall_5.2.8-6_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       mangle - Shorewall Packet marking/mangling rules file

</pre><h4><b>SYNOPSIS</b></h4><pre>

       <b>/etc/shorewall[6]/mangle</b>

</pre><h4><b>DESCRIPTION</b></h4><pre>
       This file was introduced in Shorewall 4.6.0 and replaces <b><a href="../man5/shorewall-tcrules.5.html">shorewall-tcrules</a>(5)</b>[1]. This file is only
       processed by the compiler if:

       Entries in this file cause packets to be marked as a means of classifying them for traffic control or
       policy routing.

           <b>Important</b>

           Unlike rules in the <b>shorewall-rules</b>[2](5) file, evaluation of rules in this file will continue after
           a match. So the final mark for each packet will be the one assigned by the LAST tcrule that matches.

           If you use multiple internet providers with the 'track' option, in /etc/shorewall/providers be sure
           to read the restrictions at <b>https://shorewall.org/MultiISP.html</b>[3].

       The columns in the file are as follows (where the column name is followed by a different name in
       parentheses, the different name is used in the alternate specification syntax).

       <b>ACTION</b> - <u>command</u>[(<u>parameters</u>)][:<u>chain-designator</u>]
           The <u>chain-designator</u> indicates the Netfilter chain that the entry applies to and may be one of the
           following:

           P
               PREROUTING chain.

           F
               FORWARD chain.

           T
               POSTROUTING chain.

           I
               INPUT chain.

           NP
               PREROUTING chain in the nat table.

           NI
               INPUT chain in the nat table.

           NO
               OUTPUT chain in the nat table.

           NT
               POSTROUTING chain in the nat table.

           The nat table designators were added in Shorewall 5.2.1. When a nat table designator is given, only
           the CONNMARK, MARK, SAVE and RESTORE commands may be used.

           Unless otherwise specified for the particular <u>command</u>, the default chain is PREROUTING when
           MARK_IN_FORWARD_CHAIN=No in <b><a href="../man5/shorewall.conf.5.html">shorewall.conf</a>(5)</b>[4], and FORWARD when MARK_IN_FORWARD_CHAIN=Yes.

           A <u>chain-designator</u> may not be specified if the SOURCE or DEST columns begin with '$FW'. When the
           SOURCE is $FW, the generated rule is always placed in the OUTPUT chain. If DEST is '$FW', then the
           rule is placed in the INPUT chain. Additionally, a <u>chain-designator</u> may not be specified in an action
           body.

           Where a command takes parameters, those parameters are enclosed in parentheses ("(....)") and
           separated by commas.

           The <u>command</u> may be one of the following.

           <u>action</u><b>[([</b><u>param</u><b>[,...])]</b>
               Added in Shorewall 5.0.7.  <u>action</u> must be an action declared with the <b>mangle</b> option in
               <b><a href="../man5/shorewall-actions.5.html">shorewall-actions</a>(5)</b>[5]. If the action accepts parameters, they are specified as a
               comma-separated list within parentheses following the <u>action</u> name.

           <b>ADD(</b><u>ipset</u><b>:</b><u>flags</u><b>)</b>
               Added in Shorewall 4.6.7. Causes addresses and/or port numbers to be added to the named <u>ipset</u>.
               The <u>flags</u> specify the address or tuple to be added to the set and must match the type of ipset
               involved. For example, for an iphash ipset, either the SOURCE or DESTINATION address can be added
               using <u>flags</u> <b>src</b> or <b>dst</b> respectively (see the -A command in ipset (8)).

               ADD is non-terminating. Even if a packet matches the rule, it is passed on to the next rule.

           <b>CHECKSUM</b>
               Compute and fill in the checksum in a packet that lacks a checksum. This is particularly useful
               if you need to work around old applications, such as dhcp clients, that do not work well with
               checksum offloads, but you don't want to disable checksum offload in your device.

               Requires 'Checksum Target' support in your kernel and iptables.

           <b>CLASSIFY(</b><u>classid</u><b>)</b>
               A classification Id (classid) is of the form <u>major</u>:<u>minor</u> where <u>major</u> and <u>minor</u> are integers.
               Corresponds to the 'class' specification in these traffic shaping modules:

                          atm
                          cbq
                          dsmark
                          pfifo_fast
                          htb
                          prio

               Classification occurs in the POSTROUTING chain except when the <b>SOURCE</b> is <b>$FW</b>[:<u>address</u>] in which
               case classification occurs in the OUTPUT chain.

               When using Shorewall's built-in traffic shaping tool, the <u>major</u> class is the device number (the
               first device in <b>shorewall-tcdevices</b>[6](5) is major class 1, the second device is major class 2,
               and so on) and the <u>minor</u> class is the class's MARK value in <b>shorewall-tcclasses</b>[7](5) preceded by
               the number 1 (MARK 1 corresponds to minor class 11, MARK 5 corresponds to minor class 15, MARK 22
               corresponds to minor class 122, etc.).

           <b>?COMMENT</b>
               The rest of the line will be attached as a comment to the Netfilter rule(s) generated by the
               following entries. The comment will appear delimited by "/* ... */" in the output of <b>shorewall</b>
               <b>show</b> <b>mangle</b>

               To stop the comment from being attached to further rules, simply include ?COMMENT on a line by
               itself.

           <b>CONMARK({mark|range})</b>
               Identical to MARK with the exception that the mark is assigned to connection to which the packet
               belongs is marked rather than to the packet itself.

           <b>CONTINUE</b>
               Don't process any more marking rules in the table.

               Currently, CONTINUE may not be used with <u>exclusion</u> (see the SOURCE and DEST columns below); that
               restriction will be removed when iptables/Netfilter provides the necessary support.

           <b>DEL(</b><u>ipset</u><b>:</b><u>flags</u><b>)</b>
               Added in Shorewall 4.6.7. Causes an entry to be deleted from the named <u>ipset</u>. The <u>flags</u> specify
               the address or tuple to be deleted from the set and must match the type of ipset involved. For
               example, for an iphash ipset, either the SOURCE or DESTINATION address can be deleted using <u>flags</u>
               <b>src</b> or <b>dst</b> respectively (see the -D command in ipset (8)).

               DEL is non-terminating. Even if a packet matches the rule, it is passed on to the next rule.

           <b>DIVERT</b>
               Two DIVERT rule should precede the TPROXY rule and should select DEST PORT tcp 80 and SOURCE PORT
               tcp 80 respectively (assuming that tcp port 80 is being proxied). DIVERT avoids sending packets
               to the TPROXY target once a socket connection to Squid3 has been established by TPROXY. DIVERT
               marks the packet with a unique mark and exempts it from any rules that follow.

           <b>DIVERTHA</b>
               Added in Shorewall 5.0.4. To setup the HAProxy configuration described at
               <b><a href="http://www.loadbalancer.org/blog/setting-up-haproxy-with-transparent-mode-on-centos-6-x">http://www.loadbalancer.org/blog/setting-up-haproxy-with-transparent-mode-on-centos-6-x</a></b>, place
               this entry in <b><a href="../man5/shorewall-providers.5.html">shorewall-providers</a>(5)</b>[8]:

                   #NAME    NUMBER   MARK    DUPLICATE  INTERFACE GATEWAY         OPTIONS               COPY
                   TProxy   1        -       -          lo        -               tproxy

               and use this DIVERTHA entry:

                   #ACTION         SOURCE          DEST            PROTO   DPORT   SPORT   USER    TEST    LENGTH  TOS   CONNBYTES         HELPER    PROBABILITY DSCP
                   DIVERTHA        -               -               tcp

           <b>DROP</b>
               Causes matching packets to be discarded.

           <b>DSCP</b>(<u>dscp</u>)
               Sets the Differentiated Services Code Point field in the IP header. The <u>dscp</u> value may be given
               as an even number (hex or decimal) or as the name of a DSCP class. Valid class names and their
               associated hex numeric values are:

                       CS0  =&gt; 0x00
                       CS1  =&gt; 0x08
                       CS2  =&gt; 0x10
                       CS3  =&gt; 0x18
                       CS4  =&gt; 0x20
                       CS5  =&gt; 0x28
                       CS6  =&gt; 0x30
                       CS7  =&gt; 0x38
                       BE   =&gt; 0x00
                       AF11 =&gt; 0x0a
                       AF12 =&gt; 0x0c
                       AF13 =&gt; 0x0e
                       AF21 =&gt; 0x12
                       AF22 =&gt; 0x14
                       AF23 =&gt; 0x16
                       AF31 =&gt; 0x1a
                       AF32 =&gt; 0x1c
                       AF33 =&gt; 0x1e
                       AF41 =&gt; 0x22
                       AF42 =&gt; 0x24
                       AF43 =&gt; 0x26
                       EF   =&gt; 0x2e

               To indicate more than one class, add their hex values together and specify the result. By
               default, DSCP rules are placed in the POSTROUTING chain.

           <b>ECN</b>
               Added in Shorewall 5.0.6 as an alternative to entries in <b><a href="../man5/shorewall-ecn.5.html">shorewall-ecn</a>(5)</b>[9]. If a PROTO is
               specified, it must be 'tcp' (6). If no PROTO is supplied, TCP is assumed. This action causes all
               ECN bits in the TCP header to be cleared.

           <b>IMQ</b>(<u>number</u>)
               Specifies that the packet should be passed to the IMQ identified by <u>number</u>. Requires IMQ Target
               support in your kernel and iptables.

           <b>INLINE</b>[(<u>action</u>)]
               Allows you to place your own ip[6]tables matches at the end of the line following a semicolon
               (";") (deprecated) or two semicolons (";;") (preferred since Shoreall 5.0.0). If an <u>action</u> is
               specified, the compiler proceeds as if that <u>action</u> had been specified in this column. If no
               action is specified, then you may include your own jump ("-j <u>target</u> [<u>option</u>] ...") after any
               matches specified at the end of the rule. If the target is not one known to Shorewall, then it
               must be defined as a builtin action in <b>shorewall-actions</b>[10] (5).

               The following rules are equivalent:

                   2:P                   eth0              -         tcp 22
                   INLINE(<a href="../man2/MARK.2.html">MARK</a>(2)):P     eth0              -         tcp 22
                   INLINE(<a href="../man2/MARK.2.html">MARK</a>(2)):P     eth0              -                 ;; -p tcp
                   INLINE                eth0              -         tcp 22  ;; -j MARK --set-mark 2
                   INLINE                eth0              -                 ;; -p tcp -j MARK --set-mark 2

           <b>IPMARK</b>
               Assigns a mark to each matching packet based on the either the source or destination IP address.
               By default, it assigns a mark value equal to the low-order 8 bits of the source address. Default
               values are:
                   src
                   <u>mask1</u> = 0xFF
                   <u>mask2</u> = 0x00
                   <u>shift</u> = 0
               'src' and 'dst' specify whether the mark is to be based on the source or destination address
               respectively. The selected address is first shifted to the right by <u>shift</u> bits. The result is
               then LANDed with <u>mask1</u> then LORed with <u>mask2</u>.

               In a sense, the IPMARK target is more like an IPCLASSIFY target in that the mark value is later
               interpreted as a class ID. A packet mark is 32 bits wide; so is a class ID. The &lt;major&gt; class
               occupies the high-order 16 bits and the &lt;minor&gt; class occupies the low-order 16 bits. So the
               class ID 1:4ff (remember that class IDs are always in hex) is equivalent to a mark value of
               0x104ff. Remember that Shorewall uses the interface number as the &lt;major&gt; number where the first
               interface in tcdevices has &lt;major&gt; number 1, the second has &lt;major&gt; number 2, and so on.

               The IPMARK target assigns a mark to each matching packet based on the either the source or
               destination IP address. By default, it assigns a mark value equal to the low-order 8 bits of the
               source address. The syntax is as follows: <b>IPMARK</b>[([{<b>src</b>|<b>dst</b>}][,[<u>mask1</u>][,[<u>mask2</u>][,[<u>shift</u>]]]])]
               Default values are:
                   <b>src</b>
                   <u>mask1</u> = 0xFF
                   <u>mask2</u> = 0x00
                   <u>shift</u> = 0
               <b>src</b> and <b>dst</b> specify whether the mark is to be based on the source or destination address
               respectively. The selected address is first shifted right by <u>shift</u>, then LANDed with <u>mask1</u> and
               then LORed with <u>mask2</u>. The <u>shift</u> argument is intended to be used primarily with IPv6 addresses.

               Example: IPMARK(src,0xff,0x10100)
                   Suppose that the source IP address is 192.168.4.3
                                       = 0xc0a80403; then
                   0xc0a80403 &gt;&gt; 0 = 0xc0a80403
                   0xc0a80403 LAND 0xFF = 0x03
                   0x03 LOR 0x10100 = 0x10103 or class ID
                                       1:103
               It is important to realize that, while class IDs are composed of a <u>major</u> and a <u>minor</u> value, the
               set of values must be unique. That is, the same numeric value cannot be used as both a <u>major</u> and
               a <u>minor</u> number for the same interface unless class nesting occurs (which is not currently
               possible with Shorewall). You should keep this in mind when deciding how to map IP addresses to
               class IDs.

               For example, suppose that your internal network is 192.168.1.0/29 (host IP addresses 192.168.1.1
               - 192.168.1.6). Your first notion might be to use IPMARK(src,0xFF,0x10000) so as to produce class
               IDs 1:1 through 1:6. But 1:1 is an invalid class ID since the <u>major</u> and <u>minor</u> classes are equal.
               So you might choose instead to use IPMARK(src,0xFF,0x10100) as in the example above so that all
               of your <u>minor</u> classes will have a value &gt; 256.

           <b>IP6TABLES({</b><u>target</u> <b>[</b><u>option</u> <b>...])</b>
               IPv6 only.

               This action allows you to specify an iptables target with options (e.g., 'IP6TABLES(MARK
               --set-xmark 0x01/0xff)'. If the target is not one recognized by Shorewall, the following error
               message will be issued:
                   ERROR: Unknown target
                                     (<u>target</u>)
               This error message may be eliminated by adding the <u>target</u> as a builtin action in
               <b><a href="../man5/shorewall-actions.5.html">shorewall-actions</a>(5)</b>[10].

           <b>IPTABLES({</b><u>target</u> <b>[</b><u>option</u> <b>...])</b>
               IPv4 only.

               This action allows you to specify an iptables target with options (e.g., 'IPTABLES(MARK
               --set-xmark 0x01/0xff)'. If the target is not one recognized by Shorewall, the following error
               message will be issued:
                   ERROR: Unknown target
                                     (<u>target</u>)
               This error message may be eliminated by adding the <u>target</u> as a builtin action in
               <b><a href="../man5/shorewall-actions.5.html">shorewall-actions</a>(5)</b>[10].

           <b>MARK({</b><u>mark</u><b>|</b><u>range</u><b>})</b>
               where <u>mark</u> is a packet mark value.

               Normally will set the mark value. If preceded by a vertical bar ("|"), the mark value will be
               logically ORed with the current mark value to produce a new mark value. If preceded by an
               ampersand ("&amp;"), will be logically ANDed with the current mark value to produce a new mark value.

               Both "|" and "&amp;" require Extended MARK Target support in your kernel and iptables.

               The mark value may be optionally followed by "/" and a mask value (used to determine those bits
               of the connection mark to actually be set). When a mask is specified, the result of logically
               ANDing the mark value with the mask must be the same as the mark value.

               A mark <u>range</u> is a pair of integers separated by a dash ("-").

               May be optionally followed by a slash ("/") and a mask and requires the Statistics Match
               capability in iptables and kernel. Marks in the specified range are assigned to packets on a
               round-robin fashion.

               When a mask is specified, the result of logically ANDing each mark value with the mask must be
               the same as the mark value. The least significant bit in the mask is used as an increment. For
               example, if '0x200-0x400/0xff00' is specified, then the assigned mark values are 0x200, 0x300 and
               0x400 in equal proportions. If no mask is specified, then ( 2 ** MASK_BITS ) - 1 is assumed
               (MASK_BITS is set in <b>shorewall.conf</b>[4](5)).

           <b>NFLOG</b>[(<u>nflog-parameters</u>)]
               Added in Shorewall 5.0.9. Logs matching packets using NFLOG. The <u>nflog-parameters</u> are a
               comma-separated list of up to 3 numbers:

               •   The first number specifies the netlink group (0-65535). If omitted (e.g., NFLOG(,0,10)) then
                   a value of 0 is assumed.

               •   The second number specifies the maximum number of bytes to copy. If omitted, 0 (no limit) is
                   assumed.

               •   The third number specifies the number of log messages that should be buffered in the kernel
                   before they are sent to user space. The default is 1.

           <b>RESTORE</b>[(<u>mask</u>)]
               Restore the packet's mark from the connection's mark using the supplied mask if any. Your kernel
               and iptables must include CONNMARK support.

           <b>SAME[(</b><u>timeout</u><b>)]</b>
               Some websites run applications that require multiple connections from a client browser. Where
               multiple 'balanced' providers are configured, this can lead to problems when some of the
               connections are routed through one provider and some through another. The SAME target allows you
               to work around that problem. SAME may be used in the PREROUTING and OUTPUT chains. When used in
               PREROUTING, it causes matching connections from an individual local system to all use the same
               provider. For example:

                   #ACTION           SOURCE         DEST         PROTO      DPORT
                   SAME:P            192.168.1.0/24 0.0.0.0/0    tcp        80,443

               If a host in 192.168.1.0/24 attempts a connection on TCP port 80 or 443 and it has sent a packet
               on either of those ports in the last five minutes then the new connection will use the same
               provider as the connection over which that last packet was sent.

               When used in the OUTPUT chain, it causes all matching connections to an individual remote system
               to all use the same provider. For example:

                   #ACTION           SOURCE         DEST         PROTO      DPORT
                   SAME              $FW            0.0.0.0/0    tcp        80,443

               The optional <u>timeout</u> parameter was added in Shorewall 4.6.7 and specifies a number of seconds .
               When not specified, a value of 300 seconds (5 minutes) is assumed. If the firewall attempts a
               connection on TCP port 80 or 443 and it has sent a packet on either of those ports in the last
               <u>timeout</u> seconds to the same remote system then the new connection will use the same provider as
               the connection over which that last packet was sent.

           <b>SAVE[(</b><u>mask)</u><b>]</b>
               Save the packet's mark to the connection's mark using the supplied mask if any. Your kernel and
               iptables must include CONNMARK support.

           <b>TCPMSS</b>([<u>mss</u>[,<u>ipsec</u>]])
               Added in Shorewall 5.1.9. This target only applies to TCP traffic and alters the MSS value in SYN
               packets. It may be used in the FORWARD and POSTROUTING chains; the default is FORWARD.

               The <u>mss</u> parameter may be either <b>pmtu</b> or an integer in the range 500:65533. The value <b>pmtu</b>
               automatically clamps the MSS value to (path_MTU - 40 for IPv4; -60 for IPv6). This may not
               function as desired where asymmetric routes with differing path MTU exist — the kernel uses the
               path MTU which it would use to send packets from itself to the source and destination IP
               addresses. Prior to Linux 2.6.25, only the path MTU to the destination IP address was considered
               by this option; subsequent kernels also consider the path MTU to the source IP address. If an
               integer is given, the MSS option is set to the specified value. If the MSS of the packet is
               already lower than <u>mss</u>, it will not be increased (from Linux 2.6.25 onwards) to avoid more
               problems with hosts relying on a proper MSS. If <u>mss</u> is omitted, <b>pmtu</b> is assumed.

               The <u>ipsec</u> parameter determines whether the rule applies to IPSEC traffic (<b>ipsec</b> is passed),
               non-IPSEC traffic (<b>none</b> is passed) or both (<b>all</b> is passed). If omitted, <b>all</b> is assumed.

           <b>TOS</b>(<u>tos</u>[/<u>mask</u>])
               Sets the Type of Service field in the IP header. The <u>tos</u> value may be given as an number (hex or
               decimal) or as the name of a TOS type. Valid type names and their associated hex numeric values
               are:

                   Minimize-Delay       =&gt; 0x10,
                   Maximize-Throughput  =&gt; 0x08,
                   Maximize-Reliability =&gt; 0x04,
                   Minimize-Cost        =&gt; 0x02,
                   Normal-Service       =&gt; 0x00

               To indicate more than one class, add their hex values together and specify the result.

               When <u>tos</u> is given as a number, it may be optionally followed by '/' and a <u>mask</u>. When no <u>mask</u> is
               given, the value 0xff is assumed. When <u>tos</u> is given as a type name, the <u>mask</u> 0x3f is assumed.

               The action performed is to zero out the bits specified by the <u>mask</u>, then set the bits specified
               by <u>tos</u>.

           <b>TPROXY</b>([<u>port</u>[,<u>address</u>]])
               Transparently redirects a packet without altering the IP header. Requires a tproxy provider to be
               defined in <b>shorewall-providers</b>[8](5).

               There are three parameters to TPROXY - neither is required:

               •   <u>port</u> - the port on which the proxy server is listening. If omitted, the original destination
                   port.

               •   <u>address</u> - a local (to the firewall) IP address on which the proxy server is listening. If
                   omitted, the IP address of the interface on which the request arrives.

           <b>TTL</b>([<b>-</b>|<b>+</b>]<u>number</u>)
               If <b>+</b> is included, packets matching the rule will have their TTL incremented by <u>number</u>. Similarly,
               if <b>-</b> is included, matching packets have their TTL decremented by <u>number</u>. If neither <b>+</b> nor <b>-</b> is
               given, the TTL of matching packets is set to <u>number</u>. The valid range of values for <u>number</u> is
               1-255.

       <b>SOURCE</b> <b>-</b> <b>{-|</b><u>source-spec</u><b>[,...]}</b>
           where <u>source-spec</u> is one of:

           [!]<u>interface</u>
               where <u>interface</u> is the logical name of an <u>interface</u> defined in <b>shorewall-interfaces</b>[11](5).
               Matches packets entering the firewall from the named interface. May not be used in CLASSIFY rules
               or in rules using the :T chain qualifier.

               Beginning with Shorweall 5.2.1, the <u>interface</u> may be preceded with '!' which matches all
               interfaces except the one specified.

           <u>address</u>[,...][<u>exclusion</u>]
               where <u>address</u> is: A host or network IP address.

               The name of an ipset preceded by a plus sign ("+").

               A MAC address in Shorewall format (preceded by a tilde ("~") and using dash ("-") as a separator
               (e.g., ~00-A0-C9-15-39-78).  Matches traffic whose source IP address matches one of the listed
               addresses and that does not match an address listed in the <u>exclusion</u> (see
               <b>shorewall-exclusion</b>[12](5)).

               <b>This</b> <b>form</b> <b>will</b> <b>not</b> <b>match</b> <b>traffic</b> <b>that</b> <b>originates</b> <b>on</b> <b>the</b> <b>firewall</b> <b>itself</b> <b>unless</b> <b>either</b>
               <b>&lt;major&gt;&lt;minor&gt;</b> <b>or</b> <b>the</b> <b>:T</b> <b>chain</b> <b>qualifier</b> <b>is</b> <b>used</b> <b>in</b> <b>the</b> <b>ACTION</b> <b>column.</b>

           [!]<u>interface</u>:<u>address</u>,[...][<u>exclusion</u>]
               This form combines the preceding two forms and matches when both the incoming interface and
               source IP address match.

               Beginning with Shorweall 5.2.1, the <u>interface</u> may be preceded with '!' which matches all
               interfaces except the one specified.

           [!]<u>interface</u>:<u>exclusion</u>
               This form matches packets arriving through the named <u>interface</u> and whose source IP address does
               not match any of the addresses in the <u>exclusion</u>.

               Beginning with Shorweall 5.2.1, the <u>interface</u> may be preceded with '!' which matches all
               interfaces except the one specified.

           $FW
               Matches packets originating on the firewall system. May not be used with a chain qualifier (:P,
               :F, etc.) in the ACTION column.

           $FW:<u>address</u>[,...][<u>exclusion</u>]
               where <u>address</u> is as above (MAC addresses are not permitted). Matches packets originating on the
               firewall and whose source IP address matches one of the listed addresses and does not match any
               address listed in the <u>exclusion</u>. May not be used with a chain qualifier (:P, :F, etc.) in the
               ACTION column.

           $FW:<u>exclusion</u>
               Matches traffic originating on the firewall, provided that the source IP address does not match
               any address listed in the <u>exclusion</u>.

           Beginning with Shorewall 5.1.0, multiple <u>source_spec</u>s, separated by commas, may be given provided
           that the following alternative forms are used: (<u>address</u>[,...][<u>exclusion</u>])

           <u>interface</u>:(<u>address</u>[,...][<u>exclusion</u>])

           <u>interface</u>:(<u>exclusion</u>)

           $FW:(<u>address</u>[,...][<u>exclusion</u>])

           $FW:(<u>exclusion</u>)

       <b>DEST</b> <b>-</b> <b>{-|</b><u>dest-spec</u><b>[,...]}</b>
           where <u>dest-spec</u> is one of:

           <u>interface</u>
               where <u>interface</u> is the logical name of an interface defined in <b>shorewall-interfaces</b>[11](5).
               Matches packets leaving the firewall through the named interface. May not be used in the
               PREROUTING chain (:P in the mark column or no chain qualifier and MARK_IN_FORWARD_CHAIN=No in
               <b>shorewall.conf</b> (5)).

           <u>address</u>[,...][<u>exclusion</u>]
               where <u>address</u> is: A host or network IP address.

               The name of an ipset preceded by a plus sign ("+").

               A MAC address in Shorewall format (preceded by a tilde ("~") and using dash ("-") as a separator
               (e.g., ~00-A0-C9-15-39-78).  Matches traffic whose destination IP address matches one of the
               listed addresses and that does not match an address listed in the <u>exclusion</u> (see
               <b>shorewall-exclusion</b>[12](5)).

           <u>interface</u>:<u>address</u>,[...][<u>exclusion</u>]
               This form combines the preceding two forms and matches when both the outgoing interface and
               destination IP address match. May not be used in the PREROUTING chain (:P in the mark column or
               no chain qualifier and MARK_IN_FORWARD_CHAIN=No in <b>shorewall.conf</b> (5)).

           <u>interface</u>:<u>exclusion</u>
               This form matches packets leaving through the named <u>interface</u> and whose destination IP address
               does not match any of the addresses in the <u>exclusion</u>. May not be used in the PREROUTING chain (:P
               in the mark column or no chain qualifier and MARK_IN_FORWARD_CHAIN=No in <b>shorewall.conf</b> (5)).

           $FW
               Matches packets originating on the firewall system. May not be used with a chain qualifier (:P,
               :F, etc.) in the ACTION column.

           $FW:<u>address</u>[,...][<u>exclusion</u>]
               where <u>address</u> is as above (MAC addresses are not permitted). Matches packets destined for the
               firewall and whose destination IP address matches one of the listed addresses and does not match
               any address listed in the <u>exclusion</u>. May not be used with a chain qualifier (:P, :F, etc.) in the
               ACTION column.

           $FW:<u>exclusion</u>
               Matches traffic destined for the firewall, provided that the destination IP address does not
               match any address listed in the <u>exclusion</u>.

           Beginning with Shorewall 5.1.0, multiple <u>dest_spec</u>s, separated by commas, may be given provided that
           the following alternative forms are used: (<u>address</u>[,...][<u>exclusion</u>])

           <u>interface</u>:(<u>address</u>[,...][<u>exclusion</u>])

           <u>interface</u>:(<u>exclusion</u>)

           $FW:(<u>address</u>[,...][<u>exclusion</u>])

           $FW:(<u>exclusion</u>)

       <b>PROTO</b> - {<b>-</b>|<b>{tcp:[!]syn</b>|<b>ipp2p</b>|<b>ipp2p:udp</b>|<b>ipp2p:all</b>|<u>protocol-number</u>|<u>protocol-name</u>|<b>all}[,...]}</b>
           See <b><a href="../man5/shorewall-rules.5.html">shorewall-rules</a>(5)</b>[2] for details.

           Beginning with Shorewall 4.5.12, this column can accept a comma-separated list of protocols.

       <b>DPORT</b>- {<b>-</b>|<u>port-name-number-or-range</u>[<b>,</b><u>port-name-number-or-range</u>]...|+<u>ipset</u>}
           Optional destination Ports. A comma-separated list of Port names (from <a href="../man5/services.5.html">services</a>(5)), <u>port</u> <u>number</u>s or
           <u>port</u> <u>range</u>s; if the protocol is <b>icmp</b>, this column is interpreted as the destination icmp-type(s).
           ICMP types may be specified as a numeric type, a numeric type and code separated by a slash (e.g.,
           3/4), or a typename. See <b>https://shorewall.org/configuration_file_basics.htm#ICMP</b>[13].

           If the protocol is <b>ipp2p</b>, this column is interpreted as an ipp2p option without the leading "--"
           (example <b>bit</b> for bit-torrent). If no PORT is given, <b>ipp2p</b> is assumed.

           An entry in this field requires that the PROTO column specify icmp (1), tcp (6), udp (17), sctp (132)
           or udplite (136). Use '-' if any of the following field is supplied.

           Beginning with Shorewall 4.6.0, an <u>ipset</u> name can be specified in this column. This is intended to be
           used with bitmap:port ipsets.

           This column was formerly named DEST PORT(S).

       <b>SPORT</b> - {<b>-</b>|<u>port-name-number-or-range</u>[<b>,</b><u>port-name-number-or-range</u>]...|+<u>ipset</u>}
           Optional source port(s). If omitted, any source port is acceptable. Specified as a comma-separated
           list of port names, port numbers or port ranges.

           An entry in this field requires that the PROTO column specify tcp (6), udp (17), sctp (132) or
           udplite (136). Use '-' if any of the following fields is supplied.

           Beginning with Shorewall 4.5.15, you may place '=' in this column, provided that the DPORT column is
           non-empty. This causes the rule to match when either the source port or the destination port in a
           packet matches one of the ports specified in DEST PORTS(S). Use of '=' requires multi-port match in
           your iptables and kernel.

           Beginning with Shorewall 4.6.0, an <u>ipset</u> name can be specified in this column. This is intended to be
           used with bitmap:port ipsets.

           This column was formerly labelled SOURCE PORT(S).

       <b>USER</b> - [<b>!</b>][<u>user-name-or-number</u>][<b>:</b><u>group-name-or-number</u>][<b>+</b><u>program-name</u>]
           This optional column may only be non-empty if the SOURCE is the firewall itself.

           When this column is non-empty, the rule applies only if the program generating the output is running
           under the effective <u>user</u> and/or <u>group</u> specified (or is NOT running under that id if "!" is given).

           Examples:

           joe
               program must be run by joe

           :kids
               program must be run by a member of the 'kids' group

           !:kids
               program must not be run by a member of the 'kids' group

           +upnpd
               #program named upnpd

                   <b>Important</b>
                   The ability to specify a program name was removed from Netfilter in kernel version 2.6.14.

       <b>TEST</b> - [<b>!</b>]<u>value</u>[/<u>mask</u>][<b>:C</b>]
           Optional - Defines a test on the existing packet or connection mark. The rule will match only if the
           test returns true.

           If you don't want to define a test but need to specify anything in the following columns, place a "-"
           in this field.

           !
               Inverts the test (not equal)

           <u>value</u>
               Value of the packet or connection mark.

           <u>mask</u>
               A mask to be applied to the mark before testing.

           <b>:C</b>
               Designates a connection mark. If omitted, the packet mark's value is tested.

       <b>LENGTH</b> - [<u>length</u>|[<u>min</u>]<b>:</b>[<u>max</u>]]
           Optional - packet payload length. This field, if present allow you to match the length of a packet
           payload (Layer 4 data ) against a specific value or range of values. You must have iptables length
           support for this to work. A range is specified in the form <u>min</u>:<u>max</u> where either <u>min</u> or <u>max</u> (but not
           both) may be omitted. If <u>min</u> is omitted, then 0 is assumed; if <u>max</u> is omitted, than any packet that
           is <u>min</u> or longer will match.

       <b>TOS</b> - <u>tos</u>
           Type of service. Either a standard name, or a numeric value to match.

                        <b>Minimize-Delay</b> (16)
                        <b>Maximize-Throughput</b> (8)
                        <b>Maximize-Reliability</b> (4)
                        <b>Minimize-Cost</b> (2)
                        <b>Normal-Service</b> (0)

       <b>CONNBYTES</b> - [!]<u>min</u>:[<u>max</u>[:{<b>O</b>|<b>R</b>|<b>B</b>}[:{<b>B</b>|<b>P</b>|<b>A</b>}]]]
           Optional connection Bytes; defines a byte or packet range that the connection must fall within in
           order for the rule to match.

           A packet matches if the the packet/byte count is within the range defined by <u>min</u> and <u>max</u> (unless ! is
           given in which case, a packet matches if the packet/byte count is not within the range).  <u>min</u> is an
           integer which defines the beginning of the byte/packet range.  <u>max</u> is an integer which defines the
           end of the byte/packet range; if omitted, only the beginning of the range is checked. The first
           letter gives the direction which the range refers to:<b>O</b> - The original direction of the connection.
           .sp - The opposite direction from the original connection. .sp <b>B</b> - The total of both directions.

           If omitted, <b>B</b> is assumed.

           The second letter determines what the range refers to.<b>B</b> - Bytes .sp <b>P</b> - Packets .sp <b>A</b> - Average
           packet size.If omitted, <b>B</b> is assumed.

       <b>HELPER</b> <b>-</b> <u>helper</u>
           Names a Netfilter protocol helper module such as <b>ftp</b>, <b>sip</b>, <b>amanda</b>, etc. A packet will match if it was
           accepted by the named helper module.

           Example: Mark all FTP data connections with mark 4:

               #ACTION   SOURCE    DEST      PROTO   DPORT      SPORT   USER TEST LENGTH TOS CONNBYTES HELPER
               4:T       0.0.0.0/0 0.0.0.0/0 TCP     -          -       -    -    -      -   -         ftp

       <b>PROBABILITY</b> - [<u>probability</u>]
           Added in Shorewall 4.5.0. When non-empty, requires the Statistics Match capability in your kernel and
           ip6tables and causes the rule to match randomly but with the given <u>probability</u>. The <u>probability</u> is a
           number 0 &lt; <u>probability</u> &lt;= 1 and may be expressed at up to 8 decimal points of precision.

       <b>DSCP</b> <b>-</b> [[!]<u>dscp</u>]
           Added in Shorewall 4.5.1. When non-empty, match packets whose Differentiated Service Code Point field
           matches the supplied value (when '!' is given, the rule matches packets whose DSCP field does not
           match the supplied value). The <u>dscp</u> value may be given as an even number (hex or decimal) or as the
           name of a DSCP class. Valid class names and their associated hex numeric values are:

                   CS0  =&gt; 0x00
                   CS1  =&gt; 0x08
                   CS2  =&gt; 0x10
                   CS3  =&gt; 0x18
                   CS4  =&gt; 0x20
                   CS5  =&gt; 0x28
                   CS6  =&gt; 0x30
                   CS7  =&gt; 0x38
                   BE   =&gt; 0x00
                   AF11 =&gt; 0x0a
                   AF12 =&gt; 0x0c
                   AF13 =&gt; 0x0e
                   AF21 =&gt; 0x12
                   AF22 =&gt; 0x14
                   AF23 =&gt; 0x16
                   AF31 =&gt; 0x1a
                   AF32 =&gt; 0x1c
                   AF33 =&gt; 0x1e
                   AF41 =&gt; 0x22
                   AF42 =&gt; 0x24
                   AF43 =&gt; 0x26
                   EF   =&gt; 0x2e

       <b>STATE</b> -- {<b>NEW</b>|<b>RELATED</b>|<b>ESTABLISHED</b>|<b>INVALID</b>} [,...]
           The rule will only match if the packet's connection is in one of the listed states.

       <b>TIME</b> - <u>timeelement</u>[&amp;<u>timeelement</u>...]
           Added in Shorewall 4.6.2.

           May be used to limit the rule to a particular time period each day, to particular days of the week or
           month, or to a range defined by dates and times. Requires time match support in your kernel and
           ip6tables.

           <u>timeelement</u> may be:

           timestart=<u>hh</u>:<u>mm</u>[:<u>ss</u>]
               Defines the starting time of day.

           timestop=<u>hh</u>:<u>mm</u>[:<u>ss</u>]
               Defines the ending time of day.

           contiguous
               Added in Shoreawll 5.0.12. When <b>timestop</b> is smaller than <b>timestart</b> value, match this as a single
               time period instead of distinct intervals.

           utc
               Times are expressed in Greenwich Mean Time.

           localtz
               Deprecated by the Netfilter team in favor of <b>kerneltz</b>. Times are expressed in Local Civil Time
               (default).

           kerneltz
               Added in Shorewall 4.5.2. Times are expressed in Local Kernel Time (requires iptables 1.4.12 or
               later).

           weekdays=ddd[,ddd]...
               where <u>ddd</u> is one of <b>Mon</b>, <b>Tue</b>, <b>Wed</b>, <b>Thu</b>, <b>Fri</b>, <b>Sat</b> or <b>Sun</b>

           monthdays=dd[,dd],...
               where <u>dd</u> is an ordinal day of the month

           datestart=<u>yyyy</u>[-<u>mm</u>[-<u>dd</u>[<b>T</b><u>hh</u>[:<u>mm</u>[:<u>ss</u>]]]]]
               Defines the starting date and time.

           datestop=<u>yyyy</u>[-<u>mm</u>[-<u>dd</u>[<b>T</b><u>hh</u>[:<u>mm</u>[:<u>ss</u>]]]]]
               Defines the ending date and time.

       <b>SWITCH</b> <b>-</b> <b>[!]</b><u>switch-name</u><b>[={0|1}]</b>
           Added in Shorewall 5.1.0 and allows enabling and disabling the rule without requiring <b>shorewall</b>
           <b>reload</b>.

           The rule is enabled if the value stored in /proc/net/nf_condition/<u>switch-name</u> is 1. The rule is
           disabled if that file contains 0 (the default). If '!' is supplied, the test is inverted such that
           the rule is enabled if the file contains 0.

           Within the <u>switch-name</u>, '@0' and '@{0}' are replaced by the name of the chain to which the rule is a
           added. The <u>switch-name</u> (after '@...' expansion) must begin with a letter and be composed of letters,
           decimal digits, underscores or hyphens. Switch names must be 30 characters or less in length.

           Switches are normally <b>off</b>. To turn a switch <b>on</b>:
               <b>echo</b> <b>1</b> <b>&gt;</b>
                           <b>/proc/net/nf_condition/</b><u>switch-name</u>
           To turn it <b>off</b> again:
               <b>echo</b> <b>0</b> <b>&gt;</b>
                           <b>/proc/net/nf_condition/</b><u>switch-name</u>
           Switch settings are retained over <b>shorewall</b> <b>reload</b>.

           When the <u>switch-name</u> is followed by <b>=0</b> or <b>=1</b>, then the switch is initialized to off or on
           respectively by the <b>start</b> command. Other commands do not affect the switch setting.

</pre><h4><b>EXAMPLE</b></h4><pre>
       IPv4 Example 1:
           Mark all ICMP echo traffic with packet mark 1. Mark all peer to peer traffic with packet mark 4.

           This is a little more complex than otherwise expected. Since the ipp2p module is unable to determine
           all packets in a connection are P2P packets, we mark the entire connection as P2P if any of the
           packets are determined to match.

           We assume packet/connection mark 0 means unclassified.

                      #ACTION    SOURCE    DEST         PROTO   DPORT         SPORT   USER    TEST
                      <a href="../man1/MARK.1.html">MARK</a>(1):T  0.0.0.0/0 0.0.0.0/0    icmp    echo-request
                      <a href="../man1/MARK.1.html">MARK</a>(1):T  0.0.0.0/0 0.0.0.0/0    icmp    echo-reply
                      RESTORE:T  0.0.0.0/0 0.0.0.0/0    all     -             -       -       0
                      CONTINUE:T 0.0.0.0/0 0.0.0.0/0    all     -             -       -       !0
                      <a href="../man4/MARK.4.html">MARK</a>(4):T  0.0.0.0/0 0.0.0.0/0   ipp2p:all
                      SAVE:T     0.0.0.0/0 0.0.0.0/0   all     -             -       -       !0

           If a packet hasn't been classified (packet mark is 0), copy the connection mark to the packet mark.
           If the packet mark is set, we're done. If the packet is P2P, set the packet mark to 4. If the packet
           mark has been set, save it to the connection mark.

       IPv4 Example 2:
           SNAT outgoing connections on eth0 from 192.168.1.0/24 in round-robin fashion between addresses
           1.1.1.1, 1.1.1.3, and 1.1.1.9 (Shorewall 4.5.9 and later).

               /etc/shorewall/mangle:

                      #ACTION            SOURCE         DEST         PROTO   DPORT         SPORT   USER    TEST
                      CONNMARK(1-3):F    192.168.1.0/24 eth0 ; state=NEW

               /etc/shorewall/snat:

                      #ACTION          SOURCE              DEST     ...
                      SNAT(1.1.1.1)    eth0:192.168.1.0/24 - { mark=1:C }
                      SNAT(1.1.1.3)    eth0:192.168.1.0/24 - { mark=2:C }
                      SNAT(1.1.1.4)    eth0:192.168.1.0/24 - { mark=3:C }

       IPv6 Example 1:
           Mark all ICMP echo traffic with packet mark 1. Mark all peer to peer traffic with packet mark 4.

           This is a little more complex than otherwise expected. Since the ipp2p module is unable to determine
           all packets in a connection are P2P packets, we mark the entire connection as P2P if any of the
           packets are determined to match.

           We assume packet/connection mark 0 means unclassified.

                      #ACTION    SOURCE    DEST         PROTO   DPORT         SPORT   USER    TEST
                      <a href="../man1/MARK.1.html">MARK</a>(1):T  ::/0      ::/0         icmp    echo-request
                      <a href="../man1/MARK.1.html">MARK</a>(1):T  ::/0      ::/0         icmp    echo-reply
                      RESTORE:T  ::/0      ::/0         all     -             -       -       0
                      CONTINUE:T ::/0      ::/0         all     -             -       -       !0
                      <a href="../man4/MARK.4.html">MARK</a>(4):T  ::/0      ::/0         ipp2p:all
                      SAVE:T     ::/0      ::/0         all     -             -       -       !0

           If a packet hasn't been classified (packet mark is 0), copy the connection mark to the packet mark.
           If the packet mark is set, we're done. If the packet is P2P, set the packet mark to 4. If the packet
           mark has been set, save it to the connection mark.

</pre><h4><b>FILES</b></h4><pre>
       /etc/shorewall/mangle

       /etc/shorewall6/mangle

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <b>https://shorewall.org/traffic_shaping.htm</b>[14]

       <b>https://shorewall.org/MultiISP.html</b>[3]

       <b>https://shorewall.org/PacketMarking.html</b>[15]

       <b>https://shorewall.org/configuration_file_basics.htm#Pairs</b>[16]

       <a href="../man8/shorewall.8.html">shorewall</a>(8)

</pre><h4><b>NOTES</b></h4><pre>
        1. <a href="../man5/shorewall-tcrules.5.html">shorewall-tcrules</a>(5)
           https://shorewall.org/manpages/shorewall-tcrules.html

        2. shorewall-rules
           https://shorewall.org/manpages/shorewall-rules.html

        3. https://shorewall.org/MultiISP.html
           https://shorewall.org/MultiISP.html

        4. <a href="../man5/shorewall.conf.5.html">shorewall.conf</a>(5)
           https://shorewall.org/manpages/shorewall.conf.html

        5. <a href="../man5/shorewall-actions.5.html">shorewall-actions</a>(5)
           https://shorewall.org/manpages/shorewall-actions.html

        6. shorewall-tcdevices
           https://shorewall.org/manpages/shorewall-tcdevices.html

        7. shorewall-tcclasses
           https://shorewall.org/manpages/shorewall-tcclasses.html

        8. <a href="../man5/shorewall-providers.5.html">shorewall-providers</a>(5)
           https://shorewall.org/manpages/shorewall-providers.html

        9. <a href="../man5/shorewall-ecn.5.html">shorewall-ecn</a>(5)
           https://shorewall.org/manpages/shorewall-ecn.html

       10. shorewall-actions
           https://shorewall.org/manpages/shorewall-actions.html

       11. shorewall-interfaces
           https://shorewall.org/manpages/shorewall-interfaces.html

       12. shorewall-exclusion
           https://shorewall.org/manpages/shorewall-exclusion.html

       13. https://shorewall.org/configuration_file_basics.htm#ICMP
           https://shorewall.org/configuration_file_basics.htm#ICMP

       14. https://shorewall.org/traffic_shaping.htm
           https://shorewall.org/traffic_shaping.htm

       15. https://shorewall.org/PacketMarking.html
           https://shorewall.org/PacketMarking.html

       16. https://shorewall.org/configuration_file_basics.htm#Pairs
           https://shorewall.org/configuration_file_basics.htm#Pairs

Configuration Files                                09/24/2020                                <u><a href="../man5/SHOREWALL-MANGLE.5.html">SHOREWALL-MANGLE</a></u>(5)
</pre>
 </div>
</div></section>
</div>
</body>
</html>