<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>strategies.yaml - Traffic Server cache hierarchy configuration file</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/trafficserver">trafficserver_9.2.5+ds-1ubuntu2_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       strategies.yaml - Traffic Server cache hierarchy configuration file

       The  <u>strategies.yaml</u>  file  identifies the next hop proxies used in an cache hierarchy and the algorithms
       used to select the next hop proxy. Use this file to perform the following configuration:

       • Set up next hop cache hierarchies, with multiple parents and parent failover

       Traffic Server uses the <u>strategies.yaml</u> file only when one or more remap lines in remap.config  specifies
       the use of a strategy with the @strategy tag.  remap.config Example:

          map <a href="http://www.foo.com">http://www.foo.com</a> <a href="http://www.bar.com">http://www.bar.com</a> @strategy='mid-tier-north'

       After  you  modify  the  <u>strategies.yaml</u>  file,  run  the <u>traffic_ctl</u> <u>config</u> <u>reload</u> command to apply your
       changes.

</pre><h4><b>FORMAT</b></h4><pre>
       The <u>strategies.yaml</u> is a YAML document with three top level namespaces:  <b>hosts</b>,  <b>groups</b>  and  <b>strategies</b>.
       These  name  spaces  may  be  in  separate  files.   When in separate files, use <b>#include</b> <b>filename</b> in the
       <u>strategies.yaml</u> so that they are concatenated by the strategy factory into a single YAML document in  the
       order, <b>hosts</b>, <b>groups</b>, and the <b>strategies</b>.

       Alternatively  if  the config parameter <u>proxy.config.url_remap.strategies.filename</u> refers to a directory,
       the NextHopStrategyFactory will alphanumerically concatenate all files in  that  directory  that  end  in
       <u>.yaml</u>  by  name  into  a  single  document  stream  for parsing.  The final document must be a valid <u>YAML</u>
       document with single <u>strategies</u> node and optionally  a  single  <u>hosts</u>  and  <u>groups</u>  node.   Any  <b>#include</b>
       <b>filename</b> strings are ignored when reading <u>.yaml</u> files in a directory.

</pre><h4><b>HOSTS</b> <b>DEFINITIONS</b></h4><pre>
       The  <b>hosts</b>  definitions  is a <b>YAML</b> list of hosts.  This list is <b>optional</b> but if not used, the <b>groups</b> list
       <b>must</b> include complete definitions for hosts.  See the <b>group</b> examples below.

       In the example below, <b>hosts</b> is a <b>YAML</b> list of hosts.  Each host entry  uses a <b>YAML</b> anchor,  <b>&amp;p1</b>  and  <b>&amp;p2</b>
       that may be used elsewhere in the <b>YAML</b> document to refer to hosts <b>p1</b> and <b>p2</b>.

       • <b>host</b>: the host value is a Fully Qualified Domain Name string

       • <b>protocol</b>:  a  list  of  schemes,  ports,  and  health  check urls for the host. The <b>scheme</b> is optional;
         strategies with no scheme will match hosts with no scheme. Note the scheme is only used  to  match  the
         strategy,  the  actual  scheme  used  in  the  upstream request will be the scheme of the remap target,
         regardless of the strategy or host scheme.

       • <b>healthcheck</b>: health check information with the <b>url</b> used to check the  hosts  health  by  some  external
         health check agent.

       •

         <b>hash_string</b>: a string to use for this host's entry in the strategy. By default, the <b>host</b> is used
         (notably without a port).

                • This  is  currently  only  used by <b>consistent_hash</b> policy strategies, but may be used by other
                  policies in the future.

                •

                  <b>There's</b> <b>generally</b> <b>no</b> <b>benefit</b> <b>to</b> <b>giving</b> <b>any</b> <b>host</b> <b>any</b> <b>particular</b> <b>hash</b> <b>string,</b> <b>but</b> <b>this</b> <b>may</b> <b>be</b>
                  <b>useful,</b> <b>for</b> <b>example:</b>

                         • If multiple host objects share the same <b>host</b> FQDN, possibly on different ports

                         • If a parent server's FQDN changes, to prevent changing a host's position on the  hash
                           ring, and thus breaking the cache and sending different requests to different parents

                         • To force a change in the order of the hash ring for debugging purposes

       Example:

          hosts:
            - &amp;p1
              host: p1.foo.com
              protocol:
                - scheme: http
                  port: 80
                  health_check_url: <a href="http://192.168.1.1">http://192.168.1.1</a>:80
                - scheme: https
                  port: 443
                  health_check_url: https://192.168.1.1:443
            - &amp;p2
              host: p2.new.foo.com
              hash_string: p2.original.foo.com
              protocol:
                - scheme: http
                  port: 80
                  health_check_url: <a href="http://192.168.1.2">http://192.168.1.2</a>:80

</pre><h4><b>GROUPS</b> <b>DEFINITIONS</b></h4><pre>
       The  <b>groups</b> definitions is a <b>YAML</b> list of host groups.  host groups are used as the primary and secondary
       groups used by nexthop to choose hosts from.  The first group is the <b>primary</b> group next hop chooses hosts
       from.  The remaining groups are used failover.  The <b>strategies</b> <b>policy</b> specifies how the groups are used.

       Below are examples of group definitions.  The first example is using <b>YAML</b> anchors and  references.   When
       using <b>references</b>, the complete <b>YAML</b> document must include the <b>anchors</b> portion of the document first.

       The second example shows a complete <b>groups</b> definition without the use of a <b>hosts</b> name space and it's <b>YAML</b>
       anchors.

       The field definitions in the examples below are defined in the <b>hosts</b> section.

       Example using <b>YAML</b> anchors and references:

          groups:
            - &amp;g1
              - &lt;&lt;: *p1
                weight: 1.5
              - &lt;&lt;: *p2
                weight: 0.5
            - &amp;g2
              - &lt;&lt;: *p3
                weight: 0.5
              - &lt;&lt;: *p4
                weight: 1.5

       Explicitly defined Example, no <b>YAML</b> references:

          groups:
            - &amp;g1
              - host: p1.foo.com
                protocol:
                  - scheme: http
                    port: 80
                    health_check_url: <a href="http://192.168.1.1">http://192.168.1.1</a>:80
                  - scheme: https
                    port: 443
                    health_check_url: https://192.168.1.1:443
                weight: 0.5
              - host: p2.foo.com
                protocol:
                  - scheme: http
                    port: 80
                    health_check_url: <a href="http://192.168.1.2">http://192.168.1.2</a>:80
                  - scheme: https
                    port: 443
                    health_check_url: https://192.168.1.2:443
                weight: 0.5
            - &amp;g2
              - host: p3.foo.com
                protocol:
                  - scheme: http
                    port: 80
                    health_check_url: <a href="http://192.168.1.3">http://192.168.1.3</a>:80
                  - scheme: https
                    port: 443
                    health_check_url: https://192.168.1.3:443
                weight: 0.5
              - host: p4.foo.com
                protocol:
                  - scheme: http
                    port: 80
                    health_check_url: <a href="http://192.168.1.4">http://192.168.1.4</a>:80
                  - scheme: https
                    port: 443
                    health_check_url: https://192.168.1.4:443
                weight: 0.5

</pre><h4><b>STRATEGIES</b> <b>DEFINITIONS</b></h4><pre>
       The <b>strategies</b> namespace defines a <b>YAML</b> list of strategies that may be applied to a <b>remap</b> entry using the
       <b>@strategy</b> tag in remap.config.

       Each <b>strategy</b> in the list may using the following parameters:

       • <b>strategy</b>: The value is the name of the strategy.

       • <b>policy</b>: The algorithm the <b>strategy</b> uses to select hosts. Currently one of the following:

            1. <b>rr_ip</b>: round robin selection using the modulus of the client IP

            2. <b>rr_strict</b>: strict round robin over the list of hosts in the primary group.

            3. <b>first_live</b>:  always  selects  the first host in the primary group.  Other hosts are selected when
               the first host fails.

            4. <b>latched</b>:  Same as <b>first_live</b> but primary selection sticks to whatever host was used by a previous
               transaction.

            5. <b>consistent_hash</b>: hosts are selected using a <b>hash_key</b>.

       • <b>hash_key</b>: The hashing key used by the <b>consistent_hash</b> policy. If not specified, defaults to <b>path</b>  which
         is the same policy used in the <b>parent.config</b> implementation. Use one of:

            1. <b>hostname</b>: Creates a hash using the <b>hostname</b> in the request URL.

            2. <b>path</b>: (<b>default</b>) Creates a hash over the path portion of the request URL.

            3. <b>path+query</b>: Same as <b>path</b> but adds the <b>query</b> <b>string</b> in the request URL.

            4. <b>path+fragment</b>: Same as <b>path</b> but adds the fragment portion of the URL.

            5. <b>cache_key</b>:  Uses  the hash key from the <b>cachekey</b> plugin.  defaults to <b>path</b> if the <b>cachekey</b> plugin
               is not configured on the <b>remap</b>.

            6. <b>url</b>: Creates a hash from the entire request url.

       • <b>go_direct</b>: A boolean value indicating whether a transaction may bypass proxies and  go  direct  to  the
         origin. Defaults to <b>true</b>

       • <b>parent_is_proxy</b>:  A  boolean  value which indicates if the groups of hosts are proxy caches or origins.
         <b>true</b> (default) means all the hosts used in the remap are Traffic Server caches.  <b>false</b> means the  hosts
         are origins that the next hop strategies may use for load balancing and/or failover.

       • <b>cache_peer_result</b>:  A  boolean  value  that  is  only  used  when the <b>policy</b> is 'consistent_hash' and a
         <b>peering_ring</b> mode is used for the strategy. When set to true, the default, all responses from  upstream
         and  peer  endpoints  are  allowed  to be cached.  Setting this to false will disable caching responses
         received from a peer host. Only responses from upstream origins or parents  will  be  cached  for  this
         strategy.

       • <b>scheme</b>:  Indicates  which  scheme the strategy supports, <u>http</u> or <u>https</u>. Note this is only used to match
         hosts to strategies; the actual scheme used  in  the  upstream  request  will  be  the  scheme  of  the
         remap.config  target, regardless of this value. The <b>scheme</b> is optional, and strategies without a scheme
         will match hosts without a scheme. This allows for omitting the scheme if hosts are not shared  between
         strategies, or if all strategies using a given host use the same scheme.

       • <b>failover</b>: A map of <b>failover</b> information.

         • <b>max_simple_retries</b>: Part of the <b>failover</b> map and is an integer value of the maximum number of retries
           for  a  <b>simple</b>  <b>retry</b>  on  the  list  of  indicated response codes.  <b>simple</b> <b>retry</b> is used to retry an
           upstream request using another upstream server if the response received on from the original upstream
           request matches any of the response codes configured for this strategy in the <b>failover</b>  map.   If  no
           failover response codes are configured, no <b>simple</b> <b>retry</b> is attempted.

         • <b>max_unavailable_retries</b>:  Part  of  the <b>failover</b> map and is an integer value of the maximum number of
           retries for a <b>unavailable</b> <b>retry</b> on the list of indicated markdown response codes.  <b>unavailable</b>  <b>retry</b>
           is  used  to retry an upstream request using another upstream server if the response received on from
           the original upstream request matches any of the markdown response codes configured for this strategy
           in the <b>failover</b> map.  If no failover markdown response codes are configured, no <b>unavailable</b> <b>retry</b>  is
           attempted.   <b>unavailable</b> <b>retry</b> differs from <b>simple</b> <b>retry</b> in that if a failover for retry is done, the
           previously retried server is marked down for rety.

         • <b>ring_mode</b>: Part of the <b>failover</b>  map.  The  host  ring  selection  mode.   Use  either  <b>exhaust_ring</b>,
           <b>alternate_ring</b> or <b>peering_ring</b>

            1. <b>exhaust_ring</b>:  when  a  host normally selected by the policy fails, another host is selected from
               the same group.  A new group is not selected until all hosts on  the  previous  group  have  been
               exhausted

            2. <b>alternate_ring</b>: retry hosts are selected from groups in an alternating group fashion.

            3. <b>peering_ring</b>: This mode is only implemented for a policy of <b>consistent_hash</b> and requires that one
               or  two  host  groups  are defined. The first host group is a list of peer caches and "this" host
               itself, the (optional) second group is a list of upstream caches.  Parents  are  always  selected
               from  the  peer  list however, if the selected parent is "this" host itself a new parent from the
               upstream list is chosen. If the second group is omitted, and  <b>go_direct</b>  is  <b>true</b>,  the  upstream
               "list"  has  one  element,  the  host  in  the  remapped  URL.  In  addition, if any peer host is
               unreachable or times out, a host from the upstream list is chosen for retries. Because  the  peer
               hosts  may  at  times  not  have consistent up/down markings for the other peers, requests may be
               looped  sometimes.   So   it's   best   to   use   <u>proxy.config.http.insert_request_via_str</u>   and
               <u>proxy.config.http.max_proxy_cycles</u> to stop looping.

         • <b>response_codes</b>: Part of the <b>failover</b> map.  This is a list of <b>http</b> response codes that may be used for
           <b>simple</b> <b>retry</b>.

         • <b>markdown_codes</b>: Part of the <b>failover</b> map.  This is a list of <b>http</b> response codes that may be used for
           <b>unavailable</b> <b>retry</b> which will cause a parent markdown.

         • <b>health_check</b>:  Part  of  the <b>failover</b> map.  A list of health checks. <b>passive</b> is the default and means
           that the state machine marks down <b>hosts</b> when a transaction timeout or connection error  is  detected.
           <b>passive</b>  is  always  used  by  the  next hop strategies.  <b>active</b> means that some external process may
           actively health check the hosts using  the  defined  <b>health</b>  <b>check</b>  <b>url</b>  and  mark  them  down  using
           <b>traffic_ctl</b>.

         • <b>self</b>:  Part  of the <b>failover</b> map.  This can only be used when <b>ring_mode</b> is <b>peering_ring</b>.  This is the
           hostname of the host in the (first) group of peers that is the local host  Traffic  Server  runs  on.
           (<b>self</b> should only be necessary when the local hostname can only be translated to an IP address with a
           DNS lookup.)

       Example:

          #include unit-tests/hosts.yaml
          #
          strategies:
            - strategy: 'strategy-1'
              policy: consistent_hash
              hash_key: cache_key
              go_direct: false
              groups:
                - *g1
                - *g2
              scheme: http
              failover:
                ring_mode: exhaust_ring
                response_codes:
                  - 404
                markdown_codes:
                  - 503
                health_check:
                  - passive
            - strategy: 'strategy-2'
              policy: rr_strict
              hash_key: cache_key
              go_direct: true
              groups:
                - *g1
                - *g2
              scheme: http
              failover:
                ring_mode: exhaust_ring
                response_codes:
                  - 404
                markdown_codes:
                  - 503
                health_check:
                  - passive

</pre><h4><b>COPYRIGHT</b></h4><pre>
       2025, <a href="mailto:dev@trafficserver.apache.org">dev@trafficserver.apache.org</a>

9.2                                               May 22, 2025                                <u><a href="../man5/STRATEGIES.YAML.5.html">STRATEGIES.YAML</a></u>(5)
</pre>
 </div>
</div></section>
</div>
</body>
</html>