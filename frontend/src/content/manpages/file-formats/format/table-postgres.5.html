<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>table_postgresql — format description for smtpd PostgreSQL tables</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/questing/+package/opensmtpd-table-postgres">opensmtpd-table-postgres_1.1.1-1_amd64</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       table_postgresql — format description for smtpd PostgreSQL tables

</pre><h4><b>DESCRIPTION</b></h4><pre>
       This manual page documents the file format of PostgreSQL tables used by the <u><a href="../man8/smtpd.8.html">smtpd</a></u>(8) mail daemon.

       The format described here applies to tables as defined in <u><a href="../man5/smtpd.conf.5.html">smtpd.conf</a></u>(5).

</pre><h4><b>POSTGRESQL</b> <b>TABLE</b></h4><pre>
       A  postgresql  table allows the storing of usernames, passwords, aliases, and domains in a format that is
       shareable across various machines that support <u><a href="../man1/postgres.1.html">postgres</a></u>(1).

       The table is used by <u><a href="../man8/smtpd.8.html">smtpd</a></u>(8) when authenticating a user, when user information such  as  user-id  and/or
       home  directory is required for a delivery, when a domain lookup may be required, and/or when looking for
       an alias.

       A PostgreSQL table consists of one or more <u><a href="../man1/postgresql.1.html">postgresql</a></u>(1) databases with one or more tables.

       If the table is used for authentication, the password should be encrypted using  the  <u><a href="../man3/crypt.3.html">crypt</a></u>(3)  function.
       Such passwords can be generated using the <u><a href="../man1/encrypt.1.html">encrypt</a></u>(1) utility or <u><a href="../man8/smtpctl.8.html">smtpctl</a></u>(8) encrypt command.

</pre><h4><b>POSTGRESQL</b> <b>TABLE</b> <b>CONFIG</b> <b>FILE</b></h4><pre>
       The following configuration options are available:

       <b>conninfo</b> <b>host</b>=<u>'host'</u> <b>user</b>=<u>'user'</u> <b>password</b>=<u>'password'</u> <b>dbname</b>=<u>'dbname'</u>
               Connection info needed to connect to the PostgreSQL database.  For example:

               conninfo host='db.example.com' user='maildba' password='...' dbname='opensmtpdb'

       <b>query_alias</b> <u>SQL</u> <u>statement</u>
               This  is  used  to  provide  a  query to look up aliases.  The question mark is replaced with the
               appropriate data.  For alias it is the left hand side of the  SMTP  address.   This  expects  one
               VARCHAR to be returned with the user name the alias resolves to.

       <b>query_credentials</b> <u>SQL</u> <u>statement</u>
               This  is  used to provide a query for looking up user credentials.  The question mark is replaced
               with the appropriate data.  For credentials it is the left hand side of the  SMTP  address.   The
               query  expects that there are two VARCHARS returned, one with a user name and one with a password
               in <u><a href="../man3/crypt.3.html">crypt</a></u>(3) format.

       <b>query_domain</b> <u>SQL</u> <u>statement</u>
               This is used to provide a query for looking up a domain.  The question mark is replaced with  the
               appropriate  data.   For  the  domain  it would be the right hand side of the SMTP address.  This
               expects one VARCHAR to be returned with a matching domain name.

       <b>query_mailaddrmap</b> <u>SQL</u> <u>statement</u>
               This is used to provide a query to look up senders.  The  question  mark  is  replaced  with  the
               appropriate data.  This expects one VARCHAR to be returned with the address the sender is allowed
               to send mails from.

       A generic SQL statement would be something like:

             query_ SELECT value FROM table WHERE key=$1;

</pre><h4><b>FILES</b></h4><pre>
       <u>/etc/mail/postgres.conf</u>  Default <u><a href="../man5/table-postgresql.5.html">table-postgresql</a></u>(5) configuration file.

</pre><h4><b>EXAMPLES</b></h4><pre>
   <b>GENERIC</b> <b>EXAMPLE</b>
       Example  based  on  the  OpenSMTPD  FAQ:  Building  a  Mail Server The filtering part is excluded in this
       example.

       The configuration below is for a medium-size mail server which handles  multiple  domains  with  multiple
       virtual  users and is based on several assumptions.  One is that a single system user named vmail is used
       for all virtual users.  This user needs to be created:

             # useradd -g =uid -c "Virtual Mail" -d /var/vmail -s <a href="file:/sbin/nologin">/sbin/nologin</a> vmail
             # mkdir /var/vmail
             # chown vmail:vmail /var/vmail

       PostgreSQL schema:

             CREATE TABLE domains (
               id SERIAL,
               domain <a href="../man255/VARCHAR.255.html">VARCHAR</a>(255) NOT NULL DEFAULT ''
             );
             CREATE TABLE virtuals (
                 id SERIAL,
                 email <a href="../man255/VARCHAR.255.html">VARCHAR</a>(255) NOT NULL DEFAULT '',
                 destination <a href="../man255/VARCHAR.255.html">VARCHAR</a>(255) NOT NULL DEFAULT ''
             );
             CREATE TABLE credentials (
                 id SERIAL,
                 email <a href="../man255/VARCHAR.255.html">VARCHAR</a>(255) NOT NULL DEFAULT '',
                 password <a href="../man255/VARCHAR.255.html">VARCHAR</a>(255) NOT NULL DEFAULT ''
             );

       That can be populated as follows:

             INSERT INTO domains VALUES (1, "example.com");
             INSERT INTO domains VALUES (2, "example.net");
             INSERT INTO domains VALUES (3, "example.org");

             INSERT INTO virtuals VALUES (1, "<a href="mailto:abuse@example.com">abuse@example.com</a>", "<a href="mailto:bob@example.com">bob@example.com</a>");
             INSERT INTO virtuals VALUES (2, "<a href="mailto:postmaster@example.com">postmaster@example.com</a>", "<a href="mailto:bob@example.com">bob@example.com</a>");
             INSERT INTO virtuals VALUES (3, "<a href="mailto:webmaster@example.com">webmaster@example.com</a>", "<a href="mailto:bob@example.com">bob@example.com</a>");
             INSERT INTO virtuals VALUES (4, "<a href="mailto:bob@example.com">bob@example.com</a>", "vmail");
             INSERT INTO virtuals VALUES (5, "<a href="mailto:abuse@example.net">abuse@example.net</a>", "<a href="mailto:alice@example.net">alice@example.net</a>");
             INSERT INTO virtuals VALUES (6, "<a href="mailto:postmaster@example.net">postmaster@example.net</a>", "<a href="mailto:alice@example.net">alice@example.net</a>");
             INSERT INTO virtuals VALUES (7, "<a href="mailto:webmaster@example.net">webmaster@example.net</a>", "<a href="mailto:alice@example.net">alice@example.net</a>");
             INSERT INTO virtuals VALUES (8, "<a href="mailto:alice@example.net">alice@example.net</a>", "vmail");

             INSERT INTO credentials VALUES (1, "<a href="mailto:bob@example.com">bob@example.com</a>", "$2b$08$ANGFKBL.BnDLL0bUl7I6aumTCLRJSQluSQLuueWRG.xceworWrUIu");
             INSERT INTO credentials VALUES (2, "<a href="mailto:alice@example.net">alice@example.net</a>", "$2b$08$AkHdB37kaj2NEoTcISHSYOCEBA5vyW1RcD8H1HG.XX0P/G1KIYwii");

       <u>/etc/mail/postgresql.conf</u>

             conninfo host='db.example.com' user='maildba' password='OpenSMTPDRules!' dbname='opensmtpdb'
             query_alias SELECT destination FROM virtuals WHERE email=$1;
             query_credentials SELECT email, password FROM credentials WHERE email=$1;
             query_domain SELECT domain FROM domains WHERE domain=$1;

       <u>/etc/mail/smtpd.conf</u>

             table domains postgres:/etc/mail/postgres.conf
             table virtuals postgres:/etc/mail/postgres.conf
             table credentials postgres:/etc/mail/postgres.conf
             listen on egress port 25 tls pki mail.example.com
             listen on egress port 587 tls-require pki mail.example.com auth &lt;credentials&gt;
             accept from any for domain &lt;domains&gt; virtual &lt;virtuals&gt; deliver to mbox

   <b>MOVING</b> <b>FROM</b> <b>POSTFIX</b> <b>(&amp;</b> <b>POSTFIXADMIN)</b>
       <u>/etc/mail/postgres.conf</u>

             conninfo host='db.example.com' user='postfix' password='...' dbname='postfix'
             query_alias SELECT destination FROM alias WHERE email=$1;
             query_credentials SELECT username, password FROM mailbox WHERE username=$1;
             query_domain SELECT domain FROM domain WHERE domain=$1;

       The rest of the config remains the same.

</pre><h4><b>TODO</b></h4><pre>
       Documenting the following query options:
             <b>query_netaddr</b>
             <b>query_userinfo</b>
             <b>query_source</b>
             <b>query_mailaddr</b>
             <b>query_addrname</b>

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man1/encrypt.1.html">encrypt</a></u>(1), <u><a href="../man3/crypt.3.html">crypt</a></u>(3), <u><a href="../man5/smtpd.conf.5.html">smtpd.conf</a></u>(5), <u><a href="../man8/smtpctl.8.html">smtpctl</a></u>(8), <u><a href="../man8/smtpd.8.html">smtpd</a></u>(8)

</pre><h4><b>HISTORY</b></h4><pre>
       The first version of <b>table_postgresql</b> was written in 2016.  It was converted to the stdio table  protocol
       in 2024.

</pre><h4><b>AUTHORS</b></h4><pre>
       <b>table_postgresql</b> was initially written by Gilles Chehade &lt;<u><a href="mailto:gilles@poolp.org">gilles@poolp.org</a></u>&gt;.  The conversion to the stdio
       table protocol was done by Omar Polo &lt;<u><a href="mailto:op@openbsd.org">op@openbsd.org</a></u>&gt;.

Debian                                           April 21, 2024                              <u><a href="../man5/TABLE_POSTGRESQL.5.html">TABLE_POSTGRESQL</a></u>(5)
</pre>
 </div>
</div></section>
</div>
</body>
</html>