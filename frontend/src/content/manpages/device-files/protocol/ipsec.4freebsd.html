<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ipsec — Internet Protocol Security protocol</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/freebsd-manpages">freebsd-manpages_12.2-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       ipsec — Internet Protocol Security protocol

</pre><h4><b>SYNOPSIS</b></h4><pre>
       <b>options</b> <b>IPSEC</b>
       <b>options</b> <b>IPSEC_SUPPORT</b>
       <b>device</b> <b>crypto</b>

       <b>#include</b> <b>&lt;sys/types.h&gt;</b>
       <b>#include</b> <b>&lt;<a href="file:/usr/include/netinet/in.h">netinet/in.h</a>&gt;</b>
       <b>#include</b> <b>&lt;netipsec/ipsec.h&gt;</b>
       <b>#include</b> <b>&lt;netipsec/ipsec6.h&gt;</b>

</pre><h4><b>DESCRIPTION</b></h4><pre>
       <b>ipsec</b>  is  a  security  protocol  implemented within the Internet Protocol layer of the networking stack.
       <b>ipsec</b> is defined for both IPv4 and IPv6 (<u><a href="../man4/inet.4.html">inet</a></u>(4) and <u><a href="../man4/inet6.4.html">inet6</a></u>(4)).  <b>ipsec</b> is a set of  protocols,  ESP  (for
       Encapsulating  Security  Payload)  AH (for Authentication Header), and IPComp (for IP Payload Compression
       Protocol) that provide security services for IP datagrams.  AH  both  authenticates  and  guarantees  the
       integrity  of  an  IP packet by attaching a cryptographic checksum computed using one-way hash functions.
       ESP, in addition, prevents unauthorized parties from  reading  the  payload  of  an  IP  packet  by  also
       encrypting  it.   IPComp  tries  to  increase  communication  performance by compressing IP payload, thus
       reducing the amount of data sent.  This will help nodes on slow links but with  enough  computing  power.
       <b>ipsec</b>  operates  in  one  of two modes: transport mode or tunnel mode.  Transport mode is used to protect
       peer-to-peer communication between end nodes.  Tunnel  mode  encapsulates  IP  packets  within  other  IP
       packets and is designed for security gateways such as VPN endpoints.

       System configuration requires the <u><a href="../man4/crypto.4.html">crypto</a></u>(4) subsystem.

       The  packets  can  be  passed  to a virtual <u><a href="../man4/enc.4.html">enc</a></u>(4) interface, to perform packet filtering before outbound
       encryption and after decapsulation inbound.

       To properly filter on the inner packets of an <b>ipsec</b> tunnel with firewalls, you can change the  values  of
       the following sysctls

       <b>Name</b>                             <b>Default</b>    <b>Enable</b>
       net.inet.ipsec.filtertunnel      0          1
       net.inet6.ipsec6.filtertunnel    0          1

   <b>Kernel</b> <b>interface</b>
       <b>ipsec</b>  is  controlled  by a key management and policy engine, that reside in the operating system kernel.
       Key management is the process of associating keys with security associations, also know as  SAs.   Policy
       management dictates when new security associations created or destroyed.

       The  key  management engine can be accessed from userland by using PF_KEY sockets.  The PF_KEY socket API
       is defined in RFC2367.

       The policy engine is controlled by  an  extension  to  the  PF_KEY  API,  <u><a href="../man2/setsockopt.2.html">setsockopt</a></u>(2)  operations,  and
       <u><a href="../man3/sysctl.3.html">sysctl</a></u>(3)  interface.   The  kernel implements an extended version of the PF_KEY interface and allows the
       programmer to define IPsec policies which are similar  to  the  per-packet  filters.   The  <u><a href="../man2/setsockopt.2.html">setsockopt</a></u>(2)
       interface  is  used  to  define  per-socket behavior, and <u><a href="../man3/sysctl.3.html">sysctl</a></u>(3) interface is used to define host-wide
       default behavior.

       The kernel code does not implement a dynamic encryption key exchange protocol such as IKE  (Internet  Key
       Exchange).   Key  exchange protocols are beyond what is necessary in the kernel and should be implemented
       as daemon processes which call the <b>APIs.</b>

   <b>Policy</b> <b>management</b>
       IPsec policies can be managed in one of two ways, either by configuring  per-socket  policies  using  the
       <u><a href="../man2/setsockopt.2.html">setsockopt</a></u>(2)  system calls, or by configuring kernel level packet filter-based policies using the PF_KEY
       interface, via the <u><a href="../man8/setkey.8.html">setkey</a></u>(8) you can define IPsec policies against packets using rules similar to  packet
       filtering rules.  Refer to <u><a href="../man8/setkey.8.html">setkey</a></u>(8) on how to use it.

       Depending  on the socket's address family, IPPROTO_IP or IPPROTO_IPV6 transport level and IP_IPSEC_POLICY
       or IPV6_IPSEC_POLICY socket options may be used to configure per-socket security policies.   A  properly-
       formed IPsec policy specification structure can be created using <u><a href="../man3/ipsec_set_policy.3.html">ipsec_set_policy</a></u>(3) function and used as
       socket option value for the <u><a href="../man2/setsockopt.2.html">setsockopt</a></u>(2) call.

       When  setting  policies using the <u><a href="../man8/setkey.8.html">setkey</a></u>(8) command, the “<b>default</b>” option instructs the system to use its
       default policy, as explained below, for processing packets.  The following sysctl variables are available
       for configuring the system's IPsec behavior.  The variables can have one of two values.  A <b>1</b> means “<b>use</b>”,
       which means that if there is a security association then use it but if there is not then the packets  are
       not  processed  by  IPsec.   The  value  <b>2</b>  is  synonymous with “<b>require</b>”, which requires that a security
       association must exist for the packets to  move,  and  not  be  dropped.   These  terms  are  defined  in
       <u><a href="../man8/ipsec_set_policy.8.html">ipsec_set_policy</a></u>(8).

       <b>Name</b>                                 <b>Type</b>          <b>Changeable</b>
       net.inet.ipsec.esp_trans_deflev      integer       yes
       net.inet.ipsec.esp_net_deflev        integer       yes
       net.inet.ipsec.ah_trans_deflev       integer       yes
       net.inet.ipsec.ah_net_deflev         integer       yes
       net.inet6.ipsec6.esp_trans_deflev    integer       yes
       net.inet6.ipsec6.esp_net_deflev      integer       yes
       net.inet6.ipsec6.ah_trans_deflev     integer       yes
       net.inet6.ipsec6.ah_net_deflev       integer       yes

       If  the  kernel  does  not  find  a matching, system wide, policy then the default value is applied.  The
       system wide default policy is specified by the following <u><a href="../man8/sysctl.8.html">sysctl</a></u>(8) variables.  <b>0</b>  means  “<b>discard</b>”  which
       asks the kernel to drop the packet.  <b>1</b> means “<b>none</b>”.

       <b>Name</b>                           <b>Type</b>          <b>Changeable</b>
       net.inet.ipsec.def_policy      integer       yes
       net.inet6.ipsec6.def_policy    integer       yes

   <b>Miscellaneous</b> <b>sysctl</b> <b>variables</b>
       When  the  <b>ipsec</b>  protocols  are  configured  for  use,  all  protocols  are  included in the system.  To
       selectively enable/disable protocols, use <u><a href="../man8/sysctl.8.html">sysctl</a></u>(8).

       <b>Name</b>                             <b>Default</b>
       net.inet.esp.esp_enable          On
       net.inet.ah.ah_enable            On
       net.inet.ipcomp.ipcomp_enable    On

       In addition the following variables are  accessible  via  <u><a href="../man8/sysctl.8.html">sysctl</a></u>(8),  for  tweaking  the  kernel's  IPsec
       behavior:

       <b>Name</b>                                 <b>Type</b>          <b>Changeable</b>
       net.inet.ipsec.ah_cleartos           integer       yes
       net.inet.ipsec.ah_offsetmask         integer       yes
       net.inet.ipsec.dfbit                 integer       yes
       net.inet.ipsec.ecn                   integer       yes
       net.inet.ipsec.debug                 integer       yes
       net.inet.ipsec.natt_cksum_policy     integer       yes
       net.inet.ipsec.check_policy_history  integer       yes
       net.inet6.ipsec6.ecn                 integer       yes
       net.inet6.ipsec6.debug               integer       yes

       The variables are interpreted as follows:

       <b>ipsec.ah_cleartos</b>
               If  set  to  non-zero,  the  kernel clears the type-of-service field in the IPv4 header during AH
               authentication data computation.  This variable is used to get current systems  to  inter-operate
               with  devices that implement RFC1826 AH.  It should be set to non-zero (clear the type-of-service
               field) for RFC2402 conformance.

       <b>ipsec.ah_offsetmask</b>
               During AH authentication data computation, the kernel will include a 16bit fragment offset  field
               (including  flag  bits)  in  the IPv4 header, after computing logical AND with the variable.  The
               variable is used for inter-operating with devices that implement RFC1826 AH.  It should be set to
               zero (clear the fragment offset field during computation) for RFC2402 conformance.

       <b>ipsec.dfbit</b>
               This variable configures the kernel behavior on IPv4 IPsec tunnel encapsulation.  If  set  to  0,
               the  DF  bit  on the outer IPv4 header will be cleared while 1 means that the outer DF bit is set
               regardless from the inner DF bit and 2 indicates that the DF bit is copied from the inner  header
               to the outer one.  The variable is supplied to conform to RFC2401 chapter 6.1.

       <b>ipsec.ecn</b>
               If  set  to  non-zero, IPv4 IPsec tunnel encapsulation/decapsulation behavior will be friendly to
               ECN (explicit congestion notification), as  documented  in  <b>draft-ietf-ipsec-ecn-02.txt</b>.   <u><a href="../man4/gif.4.html">gif</a></u>(4)
               talks more about the behavior.

       <b>ipsec.debug</b>
               If set to non-zero, debug messages will be generated via <u><a href="../man3/syslog.3.html">syslog</a></u>(3).

       <b>ipsec.natt_cksum_policy</b>
               Controls  how  the kernel handles TCP and UDP checksums when ESP in UDP encapsulation is used for
               IPsec transport mode.  If set to a non-zero value, the  kernel  fully  recomputes  checksums  for
               inbound  TCP  segments  and UDP datagrams after they are decapsulated and decrypted.  If set to 0
               and original addresses were configured for  corresponding  SA  by  the  IKE  daemon,  the  kernel
               incrementally recomputes checksums for inbound TCP segments and UDP datagrams.  If addresses were
               not configured, the checksums are ignored.

       <b>ipsec.check_policy_history</b>
               Enables  strict policy checking for inbound packets.  By default, inbound security policies check
               that packets handled by IPsec have been decrypted and authenticated.  If this variable is set  to
               a  non-zero  value, each packet handled by IPsec is checked against the history of IPsec security
               associations.  The IPsec security protocol, mode, and SA addresses must match.

       Variables under the <b>net.inet6.ipsec6</b> tree have similar meanings to those described above.

</pre><h4><b>PROTOCOLS</b></h4><pre>
       The <b>ipsec</b> protocol acts as a plug-in to the <u><a href="../man4/inet.4.html">inet</a></u>(4) and <u><a href="../man4/inet6.4.html">inet6</a></u>(4) protocols and therefore supports most of
       the protocols defined upon those IP-layer protocols.  The  <u><a href="../man4/icmp.4.html">icmp</a></u>(4)  and  <u><a href="../man4/icmp6.4.html">icmp6</a></u>(4)  protocols  may  behave
       differently  with  <b>ipsec</b>  because <b>ipsec</b> can prevent <u><a href="../man4/icmp.4.html">icmp</a></u>(4) or <u><a href="../man4/icmp6.4.html">icmp6</a></u>(4) routines from looking into the IP
       payload.

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man2/ioctl.2.html">ioctl</a></u>(2), <u><a href="../man2/socket.2.html">socket</a></u>(2), <u><a href="../man3/ipsec_set_policy.3.html">ipsec_set_policy</a></u>(3), <u><a href="../man4/crypto.4.html">crypto</a></u>(4), <u><a href="../man4/enc.4.html">enc</a></u>(4),  <u><a href="../man4/if_ipsec.4.html">if_ipsec</a></u>(4),  <u><a href="../man4/icmp6.4.html">icmp6</a></u>(4),  <u><a href="../man4/intro.4.html">intro</a></u>(4),  <u><a href="../man4/ip6.4.html">ip6</a></u>(4),
       <u><a href="../man8/setkey.8.html">setkey</a></u>(8), <u><a href="../man8/sysctl.8.html">sysctl</a></u>(8)

       S. Kent and R. Atkinson, <u>IP</u> <u>Authentication</u> <u>Header</u>, RFC 2404.

       S. Kent and R. Atkinson, <u>IP</u> <u>Encapsulating</u> <u>Security</u> <u>Payload</u> <u>(ESP)</u>, RFC 2406.

</pre><h4><b>STANDARDS</b></h4><pre>
       Daniel L. McDonald, Craig Metz, and Bao G. Phan, <u>PF_KEY</u> <u>Key</u> <u>Management</u> <u>API,</u> <u>Version</u> <u>2</u>, RFC, 2367.

       D. L. McDonald, <u>A</u> <u>Simple</u> <u>IP</u> <u>Security</u> <u>API</u> <u>Extension</u> <u>to</u> <u>BSD</u> <u>Sockets</u>, internet draft, draft-mcdonald-simple-
       ipsec-api-03.txt, work in progress material.

</pre><h4><b>HISTORY</b></h4><pre>
       The original <b>ipsec</b> implementation appeared in the WIDE/KAME IPv6/IPsec stack.

       For FreeBSD 5.0 a fully locked IPsec implementation called fast_ipsec was brought in.  The protocols drew
       heavily  on  the  OpenBSD  implementation of the IPsec protocols.  The policy management code was derived
       from the KAME implementation found in their IPsec protocols.  The fast_ipsec implementation lacked <u><a href="../man4/ip6.4.html">ip6</a></u>(4)
       support but made use of the <u><a href="../man4/crypto.4.html">crypto</a></u>(4) subsystem.

       For FreeBSD 7.0 <u><a href="../man4/ip6.4.html">ip6</a></u>(4) support was added to fast_ipsec.  After this the old KAME IPsec implementation was
       dropped and fast_ipsec became what now is the only <b>ipsec</b> implementation in FreeBSD.

</pre><h4><b>BUGS</b></h4><pre>
       There is no single standard for the policy engine API, so the policy engine API described herein is  just
       for this implementation.

       AH  and  tunnel  mode encapsulation may not work as you might expect.  If you configure inbound “require”
       policy  with  an  AH  tunnel  or  any  IPsec  encapsulating  policy  with  AH  (like  “<b>esp/tunnel/A-B/use</b>
       <b>ah/transport/A-B/require</b>”),  tunnelled  packets  will  be  rejected.  This is because the policy check is
       enforced on the inner packet on reception, and AH authenticates encapsulating  (outer)  packet,  not  the
       encapsulated  (inner)  packet  (so for the receiving kernel there is no sign of authenticity).  The issue
       will be solved when we revamp our policy engine to keep all the packet decapsulation history.

       When a large database of security associations or policies is present in the  kernel  the  SADB_DUMP  and
       SADB_SPDDUMP  operations  on  PF_KEY sockets may fail due to lack of space.  Increasing the socket buffer
       size may alleviate this problem.

       The IPcomp protocol may occasionally error because of <u><a href="../man3/zlib.3.html">zlib</a></u>(3) problems.

       This documentation needs more review.

Debian                                          February 6, 2017                                        <u><a href="../man4/IPSEC.4.html">IPSEC</a></u>(4)
</pre>
 </div>
</div></section>
</div>
</body>
</html>