<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFSv4 — NFS Version 4 Protocol</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.4; }
        a { color: #0066cc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="main-content">
<section class="p-strip is-bordered">
<div class="row">
<div class="col-3 u-hide--small u-hide" id="toc">
</div>
<div id="tableWrapper">
<p id="distroAndSection"></p>

Provided by: <a href="https://launchpad.net/ubuntu/plucky/+package/freebsd-manpages">freebsd-manpages_12.2-2_all</a> <br><br><pre>
</pre><h4><b>NAME</b></h4><pre>
       NFSv4 — NFS Version 4 Protocol

</pre><h4><b>DESCRIPTION</b></h4><pre>
       The  NFS  client  and  server provides support for the NFSv4 specification; see <u>Network</u> <u>File</u> <u>System</u> <u>(NFS)</u>
       <u>Version</u> <u>4</u> <u>Protocol</u> <u>RFC</u> <u>7530</u> <u>and</u> <u>Network</u> <u>File</u> <u>System</u> <u>(NFS)</u> <u>Version</u> <u>4</u> <u>Minor</u> <u>Version</u> <u>1</u>  <u>Protocol</u>  <u>RFC</u>  <u>5661</u>.
       The  protocol  is  somewhat  similar to NFS Version 3, but differs in significant ways.  It uses a single
       compound RPC that concatenates operations to-gether.  Each of these operations are similar to the RPCs of
       NFS Version 3.  The operations in the compound are performed in order, until one of them  fails  (returns
       an error) and then the RPC terminates at that point.

       It  has  integrated  locking support, which implies that the server is no longer stateless.  As such, the
       <b>NFSv4</b> server remains in recovery mode for a grace period (always greater  than  the  lease  duration  the
       server  uses)  after a reboot.  During this grace period, clients may recover state but not perform other
       open/lock state changing operations.  To provide for correct recovery semantics, a small  file  described
       by  <u><a href="../man5/stablerestart.5.html">stablerestart</a></u>(5)  is used by the server during the recovery phase.  If this file is missing or empty,
       there is a backup copy maintained by <u><a href="../man8/nfsd.8.html">nfsd</a></u>(8) that will be used. If either file is missing, they  will  be
       created  by  the  <u><a href="../man8/nfsd.8.html">nfsd</a></u>(8).   If both the file and the backup copy are empty, it will result in the server
       starting without providing a grace period for recovery.  Note that recovery only occurs when  the  server
       machine is rebooted, not when the <u><a href="../man8/nfsd.8.html">nfsd</a></u>(8) are just restarted.

       It provides several optional features not present in NFS Version 3:

             - NFS Version 4 ACLs
             - Referrals, which redirect subtrees to other servers
               (not yet implemented)
             - Delegations, which allow a client to operate on a file locally
             - pNFS, where I/O operations are separated from Metadata operations

       The  <b>NFSv4</b>  protocol does not use a separate mount protocol and assumes that the server provides a single
       file system tree structure, rooted at the point in the local file system tree specified by one or more

             V4: &lt;rootdir&gt; [-sec=secflavors] [host(s) or net]

       line(s) in the <u><a href="../man5/exports.5.html">exports</a></u>(5) file.  (See <u><a href="../man5/exports.5.html">exports</a></u>(5) for details.)  The <u><a href="../man8/nfsd.8.html">nfsd</a></u>(8) allows a  limited  subset  of
       operations  to  be  performed on non-exported subtrees of the local file system, so that traversal of the
       tree to the exported subtrees is possible.  As such, the ``&lt;rootdir&gt;'' can  be  in  a  non-exported  file
       system.   The  exception  is  ZFS,  which  checks  exports  and,  as such, all ZFS file systems below the
       ``&lt;rootdir&gt;'' must be exported.  However, the entire tree that is rooted at that point must be  in  local
       file  systems  that  are  of  types  that  can be NFS exported.  Since the <b>NFSv4</b> file system is rooted at
       ``&lt;rootdir&gt;'', setting this to anything other than ``/'' will result in clients  being  required  to  use
       different  mount  paths  for  <b>NFSv4</b>  than  for NFS Version 2 or 3.  Unlike NFS Version 2 and 3, Version 4
       allows a client mount to span across multiple server file systems, although not all clients  are  capable
       of doing this.

       <b>NFSv4</b>  uses  strings for users and groups instead of numbers.  On the wire, these strings can either have
       the numbers in the string or take the form:

             &lt;user&gt;@&lt;dns.domain&gt;

       where ``&lt;dns.domain&gt;'' is not the same as the DNS domain used for host name lookups, but is  usually  set
       to  the  same  string.   Most  systems set this ``&lt;dns.domain&gt;'' to the domain name part of the machine's
       <u><a href="../man1/hostname.1.html">hostname</a></u>(1) by default.   However,  this  can  normally  be  overridden  by  a  command  line  option  or
       configuration  file  for  the  daemon  used  to do the name&lt;-&gt;number mapping.  Under FreeBSD, the mapping
       daemon is called <u><a href="../man8/nfsuserd.8.html">nfsuserd</a></u>(8) and has a command line option that overrides the  domain  component  of  the
       machine's  hostname.   For use of this form of string on <b>NFSv4</b>, either client or server, this daemon must
       be running.

       The form where the numbers are in the strings can only be used for AUTH_SYS.  To configure  your  systems
       this  way,  the  <u><a href="../man8/nfsuserd.8.html">nfsuserd</a></u>(8)  daemon does not need to be running on the server, but the following sysctls
       need to be set to 1 on the server.

             vfs.nfs.enable_uidtostring
             vfs.nfsd.enable_stringtouid

       On the client, the sysctl

             vfs.nfs.enable_uidtostring

       must be set to 1 and the <u><a href="../man8/nfsuserd.8.html">nfsuserd</a></u>(8) daemon does not need to be running.

       If these strings are not configured correctly, ``ls -l'' will typically report a lot  of  ``nobody''  and
       ``nogroup'' ownerships.

       Although uid/gid numbers are no longer used in the <b>NFSv4</b> protocol except optionally in the above strings,
       they  will still be in the RPC authentication fields when using AUTH_SYS (sec=sys), which is the default.
       As such, in this case both the user/group name and number spaces must be consistent  between  the  client
       and server.

       However, if you run <b>NFSv4</b> with RPCSEC_GSS (sec=krb5, krb5i, krb5p), only names and KerberosV tickets will
       go on the wire.

</pre><h4><b>SERVER</b> <b>SETUP</b></h4><pre>
       To  set  up  the  NFS  server  that  supports  <b>NFSv4</b>, you will need to set the variables in <u><a href="../man5/rc.conf.5.html">rc.conf</a></u>(5) as
       follows:

             nfs_server_enable="YES"
             nfsv4_server_enable="YES"

       plus

             nfsuserd_enable="YES"

       if the server is using the ``&lt;user&gt;@&lt;domain&gt;'' form of user/group strings  or  is  using  the  ``-manage-
       gids'' option for <u><a href="../man8/nfsuserd.8.html">nfsuserd</a></u>(8).

       You will also need to add at least one ``V4:'' line to the <u><a href="../man5/exports.5.html">exports</a></u>(5) file for <b>NFSv4</b> to work.

       If  the  file systems you are exporting are only being accessed via <b>NFSv4</b> there are a couple of <u><a href="../man8/sysctl.8.html">sysctl</a></u>(8)
       variables that you can change, which might improve performance.

       <b>vfs.nfsd.issue_delegations</b>
               when set non-zero, allows the server to issue Open Delegations  to  clients.   These  delegations
               permit  the  client  to  manipulate the file locally on the client.  Unfortunately, at this time,
               client use of delegations is limited, so performance gains may not be observed.  This can only be
               enabled when the file systems being exported to <b>NFSv4</b> clients are not being accessed  locally  on
               the  server  and, if being accessed via NFS Version 2 or 3 clients, these clients cannot be using
               the NLM.

       <b>vfs.nfsd.enable_locallocks</b>
               can be set to 0 to disable acquisition of local byte range locks.  Disabling  local  locking  can
               only  be  done if neither local accesses to the exported file systems nor the NLM is operating on
               them.

       Note that Samba server access would be considered ``local access'' for the above discussion.

       To build a kernel with the NFS server that supports <b>NFSv4</b> linked into it, the

             options NFSD

       must be specified in the kernel's <u><a href="../man5/config.5.html">config</a></u>(5) file.

</pre><h4><b>CLIENT</b> <b>MOUNTS</b></h4><pre>
       To do an <b>NFSv4</b> mount, specify the ``nfsv4'' option on the <u><a href="../man8/mount_nfs.8.html">mount_nfs</a></u>(8) command line.  This will force use
       of the client that supports <b>NFSv4</b> plus set ``tcp'' and <b>NFSv4</b>.

       The <u><a href="../man8/nfsuserd.8.html">nfsuserd</a></u>(8) must be running if name&lt;-&gt;uid/gid mapping is being used, as above.  Also, since an  <b>NFSv4</b>
       mount  uses  the  host  uuid to identify the client uniquely to the server, you cannot safely do an <b>NFSv4</b>
       mount when

             hostid_enable="NO"

       is set in <u><a href="../man5/rc.conf.5.html">rc.conf</a></u>(5).

       If the <b>NFSv4</b> server that is being mounted on supports delegations, you can start the <u><a href="../man8/nfscbd.8.html">nfscbd</a></u>(8) daemon  to
       handle client side callbacks.  This will occur if

             nfsuserd_enable="YES"   &lt;-- If name&lt;-&gt;uid/gid mapping is being used.
             nfscbd_enable="YES"

       are set in <u><a href="../man5/rc.conf.5.html">rc.conf</a></u>(5).

       Without a functioning callback path, a server will never issue Delegations to a client.

       For NFSv4.0, by default, the callback address will be set to the IP address acquired via rtalloc() in the
       kernel and port# 7745.  To override the default port#, a command line option for <u><a href="../man8/nfscbd.8.html">nfscbd</a></u>(8) can be used.

       To  get  callbacks to work when behind a NAT gateway, a port for the callback service will need to be set
       up on the NAT gateway and then the address of the NAT gateway (host IP plus port#) will need to be set by
       assigning the <u><a href="../man8/sysctl.8.html">sysctl</a></u>(8) variable vfs.nfs.callback_addr to a string of the form:

       N.N.N.N.N.N

       where the first 4 Ns are the host IP address and the last two are the port# in network  byte  order  (all
       decimal #s in the range 0-255).

       For  NFSv4.1, the callback path (called a backchannel) uses the same TCP connection as the mount, so none
       of the above applies and should work through gateways without any issues.

       To build a kernel with the client that supports <b>NFSv4</b> linked into it, the option

             options NFSCL

       must be specified in the kernel's <u><a href="../man5/config.5.html">config</a></u>(5) file.

       Options  can  be  specified  for  the  <u><a href="../man8/nfsuserd.8.html">nfsuserd</a></u>(8)  and  <u><a href="../man8/nfscbd.8.html">nfscbd</a></u>(8)  daemons  at   boot   time   via   the
       ``nfsuserd_flags'' and ``nfscbd_flags'' <u><a href="../man5/rc.conf.5.html">rc.conf</a></u>(5) variables.

       NFSv4  mount(s) against exported volume(s) on the same host are not recommended, since this can result in
       a hung NFS server.  It occurs when an nfsd thread tries to do an NFSv4 VOP_RECLAIM()/Close RPC as part of
       acquiring a new vnode.  If all other nfsd threads are blocked waiting  for  lock(s)  held  by  this  nfsd
       thread, then there isn't an nfsd thread to service the Close RPC.

</pre><h4><b>FILES</b></h4><pre>
       <u>/var/db/nfs-stablerestart</u>      NFS V4 stable restart file
       <u>/var/db/nfs-stablerestart.bak</u>  backup copy of the file

</pre><h4><b>SEE</b> <b>ALSO</b></h4><pre>
       <u><a href="../man5/stablerestart.5.html">stablerestart</a></u>(5), <u><a href="../man8/mountd.8.html">mountd</a></u>(8), <u><a href="../man8/nfscbd.8.html">nfscbd</a></u>(8), <u><a href="../man8/nfsd.8.html">nfsd</a></u>(8), <u><a href="../man8/nfsdumpstate.8.html">nfsdumpstate</a></u>(8), <u><a href="../man8/nfsrevoke.8.html">nfsrevoke</a></u>(8), <u><a href="../man8/nfsuserd.8.html">nfsuserd</a></u>(8)

</pre><h4><b>BUGS</b></h4><pre>
       At  this  time, there is no recall of delegations for local file system operations.  As such, delegations
       should only be enabled for file systems that are being used solely as NFS  export  volumes  and  are  not
       being accessed via local system calls nor services such as Samba.

Debian                                            July 19, 2017                                         <u><a href="../man4/NFSV4.4.html">NFSV4</a></u>(4)
</pre>
 </div>
</div></section>
</div>
</body>
</html>