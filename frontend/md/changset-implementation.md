# Changeset Implementation Details

For Example of db I will be taking `ipm-db-v1.db`, `ipm-db-v2.db` and `ipm-db-v3.db`. 

Any Update in the db should be bumped to new version as default which will be handled by `b2m` cli.

## Structure

This Consist of 5 main parts.
1. `changeset` directory
2. `b2m` cli (Need to do testing)
3. `db.toml` file  (Need to use in all the scripts.)
4. `changeset_script` template Iterations needed
5. `changeset.py` common function Iterations needed

###   Create changeset script

Folder Structure:
```
changeset/
├── scripts/
│   ├── <nanosecond-TimeStamp>_<phrase>.py 
│   └── ...
├── dbs/
|   ├── <nanosecond-TimeStamp>_<phrase>/
|   |   ├── <db_name>_b2.db
|   |   ├── <db_name>_server.db     
|   |   └── ...
|   └── ...
├── logs/
|   ├── <nanosecond-TimeStamp>_<phrase>.log
|   └── ...
├── changeset.py # common functions.
└── README.md
```


1. `<nanosecond-TimeStamp>_<phrase>.py` will be generated by `b2m` cli.
```shell
./b2m --create-changeset <phrase>
```
2. Create a changeset script in `changeset/scripts` directory.
3. It consist of 2 subdirectories.
    1. `scripts`: This will contain changeset script.
    2. `dbs`: (Details Explaination Below)
        1. Temporary dbs until changeset is executed.
        2. This is for safety purpose.
        3. Any Db download, upload should be done in this folder. 
3. `logs`: 
        1. This will contain logs of changeset script.
        2. This is for logging purpose.
4. `changeset.py`: Common functions used in changeset script. 
    1. Such as `b2m upload <db_path>`, `b2m download <db_path>`, `b2m status <db_path>`, etc.


### B2M CLI

1. `b2m` cli will be used to create, execute, and manage changeset script.
2. `b2m` cli will be placed in `frontend` directory.
3. `b2m` cli will be having following commands. There are 2 types of commands.
    1. User specific commands: These commands are used regurly by us. 
        1. `b2m create-changeset <phrase>`: Create a changeset script.
            1. This will create a changeset script in `changeset/scripts` directory. (Added Detailed Description Above)
        2. `b2m execute-changeset <script_name>`: Execute a changeset script.
            1. This will execute the changeset script. It can also be done by `python <script_name>` just adding for making it easy to execute.
    2. Db specific commands: These commands are used and predifned in `changeset.py`. (Added Detailed Descript Above)
        1. `b2m status <db_path>`: Check status of db.
            1. This will check the status of db.
            2. It will check the status of db.
        2. `b2m upload <db_path>`: Upload db to b2.
            1. This will upload the db to b2 form `changeset/dbs/<phrase>/<db_name>_b2.db`. (Added Detailed Description Above)
        3. `b2m download <db_path>`: Download db from b2.
            1. This will download the db from b2 to `changeset/dbs/<phrase>/<db_name>_b2.db`. (Added Detailed Description Above)
        4. `b2m fetch-db-toml`: Fetch db.toml from b2.
            1. This will fetch db.toml from b2 to `db/all_dbs/db.toml`. 

Reasons:

1. We will be using only 2 commands `b2m create-changeset <phrase>` and `b2m execute-changeset <script_name>`.
2. Other commands will defined under `changeset.py`.


### Db.toml

This is added to remove any hardcoded values in `fdt-templ` server.

```toml
[db]
ipmdb = "ipm-db-v2.db"
emojidb = "emoji-db-v2.db"
path = "/frontend/db/all_dbs/"
```

This can also be defined in `fdt-dev.toml`, `fdt-prod.toml`, `fdt-staging.toml` but
for defining I have choosed `db.toml` to avoid confusion of multiple db definition.

There are 2 situation for db version update happen:
1. Team 
2. Server Dialy cron job (ipm db only)



Changeset script will automatically bump the db version and update in `db.toml`.
For tracking this change we have 2 options:
1. git based.
2. b2 bucket based using b2m.

I have choosed option 2.

1. git based: 
    1. This involves `git pull origin main` before checking any db status.
    2. Once updated it should be pushed to git by `git push origin main`.
    
    Pros: 
        1. Easy to track changes.
        2. It will be git native
    Cons:
        1. This will create 2 types of db versioning system. 
        2. b2m uses b2 bucket for full db versioning system. If we use git for `db.toml` it will create confusion. 
        3. If there are any conflicts in pushing to git it will be very hard to resolve.
        4. Need to implement seperate functions to handle it.
2. b2 based
    1. This uses existing b2m db versioning system.
    2. db.toml file will be present in b2 bucket.
    Pros:
        1. Adding on top of existing b2m db versioning system.
        2. Easier to integrate with b2m as b2m already managing db `metadata`,`hash` and `lock` safely.
        3. This will create seperate versioning system for dbs independent with git.
        4. Any db ops done will be done using b2 bucket as source of truth.
        5. Anyone starting server will be depending on b2m for checking db.toml fetched from b2m.
    Cons:
        1. Integrating b2m to `make start-prod` or `make run` command to identify any db changes.




### Changeset Script Template

1. This Include teamplate version
2. This also include Common Functions
```py
# Template Version: v1
# <script_name> : <nanosecond-TimeStamp>_<phrase>
# <phrase> is a short description of the change.

## Predifned Imports and Functions 
import sqlite3
import urllib.parse
import os
import time

## Import Common Functions
from changeset import db_status, db_download, db_upload # Still many more should be added.


def main():
    # Check status of db.
    # If status is outdated_db, then download db from b2.
    # If status is ready_to_upload, then upload db to b2.
    # If status is up_to_date, then do nothing.
    pass

if __name__ == "__main__":
    main()
```


### `changeset.py` common functions

1. Mainly all helper commands will be defined here.
2. This will reduce defining again and again.
3. It consist of `b2m` cli commands. Further I we can add more based on requirements.

```py
# Common Functions
#!/usr/bin/env python3
import subprocess

def db_status(db_name):
    print(f"Executing: {db_name}")
    try:
        subprocess.run(["../b2m", "--status", db_name], check=True)
    except subprocess.CalledProcessError as e:
        print(f"Error checking status for {db_name}: {e}")

def db_upload(db_name):
    print(f"Executing: {db_name}")
    try:
        subprocess.run(["../b2m", "--upload", db_name], check=True)
    except subprocess.CalledProcessError as e:
        print(f"Error uploading {db_name}: {e}")

def db_download(db_name):
    """
    Function description.
    """

    print(f"Executing: {db_name}")
    try:
        subprocess.run(["../b2m", "--download", db_name], check=True)
    except subprocess.CalledProcessError as e:
        print(f"Error downloading {db_name}: {e}")


```



## Working Flow Of Changeset Script

Assume these constraints:

On Changeset Script Trigger From (Team or Cron Job):

1. B2m status will return `ready_to_upload` or `outdated_db` or `up_to_date`.
2. This will be defined in `b2m status` command.
3. New data queries will be present in `ipm-db-v1.sql` in `db/all_dbs` this will be defined rijul/ any other team member.

There will be 3 states:
1. `ready_to_upload`: `ipm-db-v1.db` has new data (NO Version Conflict)
2. `outdated_db`: `ipm-db-v1.db` has new data but Outdated and Need Proper Migration (Version Conflict)
3. `up_to_date`: `ipm-db-v1.db` is Up to Date (NO Version Conflict)

### Case 1: `ready_to_upload`: `ipm-db-v1.db` has new data (NO Version Conflict)
Initials State

| DB Location | version       | New Data |
| ----------- | ------------- | -------- |
| b2          | ipm-db-v1.db  | No       |
| server      | ipm-db-v1.db  | Yes      |

There is new data in `ipm-db-v1.db` in server side, so we will bump the version `ipm-db-v1.db` to `ipm-db-v2.db` and upload it to b2.

Final State
| DB Location | version       | New Data |
| ----------- | ------------- | -------- |
| b2          | ipm-db-v2.db  | No       |
| server      | ipm-db-v2.db  | No       |


### Case 2: `outdated_db`: Server DB is Outdated and Need Proper miragtion (Version Conflict)
Case 2.1: B2 has `ipm-db-v2.db` and server has `ipm-db-v1.db`. 
Initial State
| DB Location | version | New Data |
| ----------- | ------- | -------- |
| b2          | ipm-db-v2.db     | Yes      |
| server      | ipm-db-v1.db    | Yes      |

Ex: 

At 10:00 AM, 

- User installed `ipm i msi-ec`  and selected option.
- This triggered api and via llm + github readme json genereated.
- Once json generated queries generated and executed in `ipm-db-v1.db`.
- On successfull execution, these queries will be stored in `ipm-db-v1.sql` in `/db/all_dbs`. (name of the `ipm-db-v1.sql` should be always fetched from db.toml `ipm-db-v1.db` but in the place of `.db` it should be stored as `.sql`)
```sql
insert into table_name (column1, column2, column3, ...)
```


At 2:00 PM, 

- There was major bump of `ipm-db-v1.db` to `ipm-db-v2.db`. 
- Need to deploy `ipm-db-v2.db` to server.
- b2m should not allow direct download via b2m cli-ui or via b2m cli commands.
- This operation must be done via changeset script.
- Trigger changeset script manualy.

```
./b2m execute-changeset <script_name>
or 
python3 <path_to_script>/<script_name>.py
```

There is new data in `ipm-db-v1.db` in server side and new version `ipm-db-v2.db` in b2 side.

1. Status Check by b2m and it will return `outdated_db`.
2. Download `ipm-db-v2.db` from b2 to `changeset/dbs/<nanosecond-timestamp>_<phrase>/`.
3. Copy `ipm-db-v1.sql` from `/db/all_dbs` to `changeset/dbs/<nanosecond-timestamp>_<phrase>/`.
4. All the new data will be present in `ipm-db-v1.sql` in will be defined by backend on new data insert/update/delete.
5. `ipm-db-v1.sql` will be having `insert`, `update`, `replace` and `delete` queries.

6. Both `insert` and `replace` queries will be executed in `ipm-db-v2.db`. But `delete` query will be done soft-delete in `ipm-db-v2.db`. 
This should be defined in function

7. rename `ipm-db-v2.db` to `ipm-db-v3.db`.
8. Stop FDT Server with `make stop-prod`.
9. copy `ipm-db-v3.db` to `db/all_dbs`.
10. Update `db.toml` with `ipm-db-v3.db`.
11. Start FDT Server with `make start-prod`.    
12. Delete `ipm-db-v1.sql` (as we we will be having 2 backups `ipm-db-v1.sql` in `changeset/dbs/<nanosecond-timestamp>_<phrase>/` and `ipm-db-v1.db` in `db/all_dbs`).
13. Upload `ipm-db-v3.db` from `changeset/dbs/<nanosecond-timestamp>_<phrase>/` to b2.
13. Once Sucessful, Remove `changeset/dbs/<nanosecond-timestamp>_<phrase>/`.(or keep it in `changeset/dbs/<nanosecond-timestamp>_<phrase>/backup/` folder for safety)



Final State
| DB Location | version | New Data |
| ----------- | ------- | -------- |
| b2          | ipm-db-v3.db     | No       |
| server      | ipm-db-v3.db    | No       |


Case 2.2: B2 has `ipm-db-v1.db` and server has `ipm-db-v1.db` but both have new data.


> Note: This case should never and will never happen. 
> I have added how to this case is handled.

We can have discord notification that this type of case has failed due to this.


### Case 3: DB is Up to Date (NO Version Conflict)

Initial State
| DB Location | version | New Data |
| ----------- | ------- | --------------- |
| b2          | v1     | No              |
| server      | v1     | No              |

Final State
| DB Location | version | New Data |
| ----------- | ------- | --------------- |
| b2          | v1     | No              |
| server      | v1     | No              |






### Defining the Changeset Script

1. Create a changeset script using b2m cmd.
```
./b2m create-changeset <phrase>
```

This will create a changeset script in `changeset/scripts` folder with name `<nanosecond-timestamp>_<phrase>.py`.
For example: `phrase` is `ipm-new-data-backup`
```
./b2m create-changeset ipm-new-data-backup
```
A new changeset script will be created in `changeset/scripts` folder with name `1735288266296000000_ipm-new-data-backup.py`.
2. Template will be consist of this.


This is simple example of how the changeset script should look like. 

This Will have some rules on writing the changeset script.

1. Logging should be done in the changeset script and it should be present in `changeset/logs` folder.
2. Use the predifned functions in the changeset script.
3. Use the predifned variables in the changeset script.

```py
# Template Version: v1
# script_name : 1735288266296000000_ipm-new-data-backup
# phrase : ipm-new-data-backup

## Predifned Imports and Functions 
import sqlite3
import urllib.parse
import os
import time

DB_NAME = "ipm-db"

## Import Common Functions
from changeset import db_status, db_download, db_upload # Still many more should be added.

def inserted_queries(db_name):
    """
    This function should insert the new data in the db.
    These will be in ipm-db-v1.sql file. 
    """
    # execute queries from `changeset/dbs/1735288266296000000_ipm-new-data-backup/ipm-db-v1.sql` file to `changeset/dbs/1735288266296000000_ipm-new-data-backup/ipm-db-v2.db` file.
    
    return None


def main():
    # Check status of db.
    status = db_status(DB_NAME)
    # If status is outdated_db, then download db from b2.
    if status == "outdated_db":
        db_download(DB_NAME)
        cp_queries(DB_NAME)
        inserted_queries(DB_NAME)
        rename_db(DB_NAME)
        stop_server()
        copy_db(DB_NAME)
        update_db(DB_NAME)
        start_server()
        upload_db(DB_NAME)
    # If status is ready_to_upload, then upload db to b2.
    if status == "ready_to_upload":
        stop_server()
        copy_db(DB_NAME)
        start_server()
        db_upload(DB_NAME)
    # If status is up_to_date, then do nothing.
    elif status == "up_to_date":
        pass

if __name__ == "__main__":
    main()
```
4. To execute the changeset script, use the following command.

in frontend directory
```
./b2m execute-changeset 1735288266296000000_ipm-new-data-backup
or 
python3 changeset/scripts/1735288266296000000_ipm-new-data-backup.py
```


### Phase 1

Implementing structure of changeset directory and b2m cli.
This Consist of 5 main parts.
1. `changeset` directory
2. `b2m` cli
3. `db.toml` file
4. `changeset_script` template
5. `changeset.py` common function


In Phase 1.1 let's implement the structure of changeset directory

### Phase 1.1: Implementing structure of changeset directory

```
frontend/
├── changeset/
│   ├── dbs/
│   │   ├── <nanosecond-timestamp>_<phrase>/
│   │   │   ├── ipm-db-v1.db
│   │   │   └── ipm-db-v2.db
│   │   └── backup/
│   │       ├── <nanosecond-timestamp>_<phrase>/
│   │       │   ├── ipm-db-v1.db
│   │       │   └── ipm-db-v2.db
│   │       └── ...
│   ├── logs/
│   │   ├── <nanosecond-timestamp>_<phrase>.log
│   │   └── ...
│   ├── scripts/
│   │   ├── <nanosecond-timestamp>_<phrase>.py
│   │   └── ...
│   └── changeset.py
```




1. `<nanosecond-TimeStamp>_<phrase>.py` will be generated by `b2m` cli.
```shell
./b2m --create-changeset <phrase>
```
2. Create a changeset script in `changeset/scripts` directory.
3. It consist of 2 subdirectories.
    1. `scripts`: This will contain changeset script.
    2. `dbs`: (Details Explaination Below)
        1. Temporary dbs until changeset is executed.
        2. This is for safety purpose.
        3. Any Db download, upload should be done in this folder. 
3. `logs`: 
        1. This will contain logs of changeset script.
        2. This is for logging purpose.
4. `changeset.py`: Common functions used in changeset script. 
    1. Such as `b2m upload <db_path>`, `b2m download <db_path>`, `b2m status <db_path>`, etc.

### Phase 1.2: Implementing b2m cli

Currently b2m interative cli is done here

@b2-manager/

refer Docs @b2-manager/docs 

for any integration 

All cli functions should setup and called via @b2-manager/ui/cli.go 

New deps like template and others should be added in @b2-manager/go.mod 
and make sure template stayes under this @b2-manager/templates folder

Still any doubts as in me before implementing this.

**Integration with b2m cli**
1. `b2m` cli will be used to create, execute, and manage changeset script.
2. `b2m` cli will be placed in `frontend` directory.
3. `b2m` cli will be having following commands. There are 2 types of commands.
    1. User specific commands: These commands are used regurly by us. 
        1. `b2m create-changeset <phrase>`: Create a changeset script.
            1. This will create a changeset script in `changeset/scripts` directory. (Added Detailed Description Above)
        2. `b2m execute-changeset <script_name>`: Execute a changeset script.
            1. This will execute the changeset script. It can also be done by `python <script_name>` just adding for making it easy to execute.
    2. Db specific commands: These commands are used and predifned in `changeset.py`. (Added Detailed Descript Above)
        1. `b2m status <db_path>`: Check status of db.
            1. This will check the status of db.
            2. It will check the status of db.
        2. `b2m upload <db_path>`: Upload db to b2.
            1. This will upload the db to b2 form `changeset/dbs/<phrase>/<db_name>_b2.db`. (Added Detailed Description Above)
        3. `b2m download <db_path>`: Download db from b2.
            1. This will download the db from b2 to `changeset/dbs/<phrase>/<db_name>_b2.db`. (Added Detailed Description Above)
        4. `b2m fetch-db-toml`: Fetch db.toml from b2.
            1. This will fetch db.toml from b2 to `db/all_dbs/db.toml`. 


Any New function implemented should be having test cases and should be tested properly merging also make sure take clarification from me to do anything before creating tests




> Note: Not tested yet

### Phase 1.3: Implementing db.toml

`db.toml` file will present in `db/all_dbs/db.toml`.

This file will be used to define the db versions and paths.

```toml
[db]
ipmdb = "ipm-db-v2.db"
emojidb = "emoji-db-v2.db"
path = "/frontend/db/all_dbs/"
```
we use frontend/internal/config/config.go for defining all the other configs. Now i want to define db.toml in frontend/internal/config/config.go and and use the same config data for all db related path location.

I have added in context where all the templ server has deps of db

all db version should defined same as it is present in thec ode