---
import { MagnifyingGlassIcon, Cross2Icon } from '@radix-ui/react-icons';
---

<div id="searchbar-container" class="relative md:flex-1 md:max-w-sm md:mx-4">
  <!-- Mobile: Search Icon Button -->
  <button
    id="mobile-search-button"
    class="md:hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
    aria-label="Open search"
  >
    <MagnifyingGlassIcon
      client:load
      className="w-6 h-6 text-gray-700 dark:text-gray-300"
    />
  </button>

  <!-- Mobile: Full-width Search Input Row (hidden by default, expands header) -->
  <div
    id="mobile-search-expanded"
    class="hidden md:hidden w-full absolute top-0 left-0 right-0 items-center gap-2 px-4 py-2"
  >
    <button
      id="mobile-search-close"
      class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex-shrink-0"
      aria-label="Close search"
    >
      <Cross2Icon
        client:load
        className="w-6 h-6 text-gray-700 dark:text-gray-300"
      />
    </button>
    <input
      type="text"
      id="search-mobile"
      class="flex-1 h-12 text-base bg-white dark:bg-gray-800 placeholder:text-gray-500 dark:placeholder:text-gray-400 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-fdt-yellow border-gray-300 dark:border-gray-600 rounded-md border px-4"
      placeholder="Search icon, emoji, tool, cheatsheet or Github repository"
      aria-label="Search for developer tools and resources"
    />
  </div>

  <!-- Desktop: Full Search Input -->
  <div class="hidden md:block relative">
    <input
      type="text"
      id="search"
      class="w-full pr-10 h-10 text-sm md:text-base bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm placeholder:text-gray-500 dark:placeholder:text-gray-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-fdt-yellow border-gray-300 dark:border-gray-600 hover:bg-white/70 dark:hover:bg-gray-800/70 rounded-md border px-3 py-2"
      placeholder="Search icon, emoji, tool, cheatsheet or Github repository"
      aria-label="Search for developer tools and resources"
    />

    <!-- Keyboard shortcut hint (hidden on mobile) -->
    <div
      class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 hidden sm:flex items-center gap-1"
      id="search-help"
    >
      <kbd
        class="px-1.5 py-0.5 text-xs text-gray-800 bg-gray-100 border border-gray-200 rounded dark:bg-gray-600 dark:text-gray-300 dark:border-gray-500"
      >
        Ctrl
      </kbd>
      <span class="text-xs">/</span>
      <kbd
        class="px-1.5 py-0.5 text-sm text-gray-800 bg-gray-100 border border-gray-200 rounded dark:bg-gray-600 dark:text-gray-300 dark:border-gray-500"
      >
        âŒ˜
      </kbd>
      <span class="text-xs">+</span>
      <kbd
        class="px-1.5 py-0.5 text-xs text-gray-800 bg-gray-100 border border-gray-200 rounded dark:bg-gray-600 dark:text-gray-300 dark:border-gray-500"
      >
        K
      </kbd>
    </div>
  </div>
</div>

<script>
  (function () {
    const searchInput = document.getElementById(
      'search'
    ) as HTMLInputElement | null;
    const searchInputMobile = document.getElementById(
      'search-mobile'
    ) as HTMLInputElement | null;
    const mobileSearchButton = document.getElementById('mobile-search-button');
    const mobileSearchExpanded = document.getElementById(
      'mobile-search-expanded'
    );
    const mobileSearchClose = document.getElementById('mobile-search-close');

    // Get the active search input (desktop or mobile)
    function getActiveSearchInput() {
      if (mobileSearchExpanded?.classList.contains('hidden')) {
        return searchInput;
      } else {
        return searchInputMobile;
      }
    }

    // Get header element to add class for styling
    const header = document.querySelector('header');
    const headerContainer = header?.parentElement;

    // Handle mobile search button click
    if (mobileSearchButton && mobileSearchExpanded && searchInputMobile) {
      const openMobileSearch = () => {
        mobileSearchButton.classList.add('hidden');
        mobileSearchExpanded.classList.remove('hidden');
        mobileSearchExpanded.classList.add('flex');
        if (header) {
          header.classList.add('mobile-search-active');
        }
        if (headerContainer) {
          headerContainer.classList.add('mobile-search-active');
        }
        setTimeout(() => {
          searchInputMobile?.focus();
        }, 100);
      };

      const closeMobileSearch = () => {
        mobileSearchButton.classList.remove('hidden');
        mobileSearchExpanded.classList.add('hidden');
        mobileSearchExpanded.classList.remove('flex');
        if (header) {
          header.classList.remove('mobile-search-active');
        }
        if (headerContainer) {
          headerContainer.classList.remove('mobile-search-active');
        }
        if (searchInputMobile) {
          searchInputMobile.value = '';
        }
        if (window.searchState) {
          window.searchState.setQuery('');
        }
      };

      mobileSearchButton.addEventListener('click', openMobileSearch);

      // Handle mobile search close
      if (mobileSearchClose) {
        mobileSearchClose.addEventListener('click', closeMobileSearch);
      }

      // Close mobile search on Escape
      if (searchInputMobile) {
        searchInputMobile.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            closeMobileSearch();
          }
        });
      }
    }

    // Initialize search for desktop input
    function initializeSearch(input: HTMLInputElement | null) {
      if (!input) return;
      if (window.location.hash.startsWith('#search?q=')) {
        try {
          const hashParams = new URLSearchParams(
            window.location.hash.substring(8)
          );
          const searchParam = hashParams.get('q');
          if (searchParam) {
            input.value = searchParam;
            if (window.searchState) {
              window.searchState.setQuery(searchParam);
            }
          }
        } catch (e) {
          console.error('Error parsing hash params:', e);
        }
      } else if (window.searchState && window.searchState.getQuery()) {
        input.value = window.searchState.getQuery();
      }
    }

    // Handle search input changes
    function handleSearchChange(e: Event, input: HTMLInputElement) {
      const query = input.value;

      if (window.searchState) {
        window.searchState.setQuery(query);
      }

      if (query.trim()) {
        window.location.hash = `search?q=${encodeURIComponent(query)}`;
      } else {
        if (window.location.hash.startsWith('#search')) {
          history.pushState(
            '',
            document.title,
            window.location.pathname + window.location.search
          );
        }
      }
    }

    // Handle keyboard events
    function handleKeyDown(e: KeyboardEvent, input: HTMLInputElement) {
      if (e.key === 'Enter' && input.value.trim()) {
        if (window.searchState) {
          window.searchState.setQuery(input.value);
        }
        window.location.hash = `search?q=${encodeURIComponent(input.value)}`;
        // Don't close mobile search after submitting - let user continue searching
      } else if (
        e.key === 'Escape' &&
        mobileSearchExpanded &&
        !mobileSearchExpanded.classList.contains('hidden')
      ) {
        mobileSearchExpanded.classList.add('hidden');
        input.value = '';
        if (window.searchState) {
          window.searchState.setQuery('');
        }
      }
    }

    // Handle focus - make border yellow (fdt-yellow)
    function handleFocus(input: HTMLInputElement) {
      input.classList.remove('border-gray-300', 'dark:border-gray-600');
      input.classList.add('border-fdt-yellow', 'dark:border-fdt-yellow');
    }

    // Handle blur - restore default border
    function handleBlur(input: HTMLInputElement) {
      input.classList.remove('border-fdt-yellow', 'dark:border-fdt-yellow');
      input.classList.add('border-gray-300', 'dark:border-gray-600');
    }

    // Listen for global search state changes
    function handleSearchQueryChange(event: CustomEvent) {
      const activeInput = getActiveSearchInput();
      if (activeInput && event?.detail && event.detail.query !== undefined) {
        activeInput.value = event.detail.query;
      }
    }

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initializeSearch(searchInput);
        initializeSearch(searchInputMobile);
      });
    } else {
      initializeSearch(searchInput);
      initializeSearch(searchInputMobile);
    }

    // Handle Ctrl+K / Cmd+K to focus search
    function handleGlobalKeyDown(e: KeyboardEvent) {
      if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        const activeInput = getActiveSearchInput();
        if (activeInput) {
          // If on mobile, trigger the mobile search button click
          if (window.innerWidth < 768 && mobileSearchButton) {
            const clickEvent = new MouseEvent('click', {
              bubbles: true,
              cancelable: true,
            });
            mobileSearchButton.dispatchEvent(clickEvent);
          } else if (activeInput) {
            activeInput.focus();
          }
        }
      }
    }

    // Event listeners for desktop input
    if (searchInput) {
      searchInput.addEventListener('input', (e) =>
        handleSearchChange(e, searchInput)
      );
      searchInput.addEventListener('keydown', (e) =>
        handleKeyDown(e, searchInput)
      );
      searchInput.addEventListener('focus', () => handleFocus(searchInput));
      searchInput.addEventListener('blur', () => handleBlur(searchInput));
    }

    // Event listeners for mobile input
    if (searchInputMobile) {
      searchInputMobile.addEventListener('input', (e) =>
        handleSearchChange(e, searchInputMobile)
      );
      searchInputMobile.addEventListener('keydown', (e) =>
        handleKeyDown(e, searchInputMobile)
      );
      searchInputMobile.addEventListener('focus', () =>
        handleFocus(searchInputMobile)
      );
      searchInputMobile.addEventListener('blur', () =>
        handleBlur(searchInputMobile)
      );
    }

    window.addEventListener(
      'searchQueryChanged',
      handleSearchQueryChange as EventListener
    );
    document.addEventListener('keydown', handleGlobalKeyDown);
  })();
</script>
