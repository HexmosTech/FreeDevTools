<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone CI LocalStack Terraform - CI Pipeline Automation</title>
    <meta name="description" content="Automate CI/CD pipelines with Drone CI and LocalStack for Terraform. Learn how to integrate LocalStack as a service in your Drone CI pipeline for efficient testing.">
    <meta name="keywords" content="drone ci, localstack, terraform, ci/cd, pipeline automation, docker, aws cli, dynamodb, kinesis, infrastructure as code, testing, development">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://example.com/drone-ci/localstack-service-terraform-drone.html">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://example.com/drone-ci/localstack-service-terraform-drone.html">
    <meta property="og:title" content="Drone CI LocalStack Terraform - CI Pipeline Automation">
    <meta property="og:description" content="Automate CI/CD pipelines with Drone CI and LocalStack for Terraform. Learn how to integrate LocalStack as a service in your Drone CI pipeline for efficient testing.">
    <meta property="og:image" content="https://example.com/path/to/your/og-image.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://example.com/drone-ci/localstack-service-terraform-drone.html">
    <meta name="twitter:title" content="Drone CI LocalStack Terraform - CI Pipeline Automation">
    <meta name="twitter:description" content="Automate CI/CD pipelines with Drone CI and LocalStack for Terraform. Learn how to integrate LocalStack as a service in your Drone CI pipeline for efficient testing.">
    <meta name="twitter:image" content="https://example.com/path/to/your/twitter-image.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Drone CI LocalStack Terraform Integration</h1>
        </div>
        <div class="content">
            <div class="markdown-content">
                <h2>Drone CI Pipeline Configuration for LocalStack and Terraform</h2>
                <p>This document outlines a Drone CI pipeline configuration that leverages LocalStack to simulate AWS services for Terraform deployments. This setup is ideal for local development and testing of infrastructure as code.</p>

                <h3>Pipeline Definition</h3>
                <p>The pipeline is defined using a YAML configuration file. It includes steps for environment variable dumping, waiting for LocalStack to become available, pre-deployment checks, Terraform execution, and post-deployment verification.</p>

                <pre><code class="language-yaml">---
kind: pipeline
type: docker
name: default
trigger:
  event:
    - pull_request
steps:
- name: dumps-env
  image: alpine
  commands:
  - env
  
- name: wait-for-localstack
  image: ruanbekker/awscli
  environment:
    AWS_ACCESS_KEY_ID: 123
    AWS_SECRET_ACCESS_KEY: xyz
    AWS_DEFAULT_REGION: eu-west-1
  commands:
  - while ! aws --endpoint-url=http://localstack:4566 kinesis list-streams; do sleep 1; done
  
- name: pre-list-tables
  image: ruanbekker/awscli
  environment:
    AWS_ACCESS_KEY_ID: 123
    AWS_SECRET_ACCESS_KEY: xyz
    AWS_DEFAULT_REGION: eu-west-1
  commands:
  - aws --endpoint-url=http://localstack:4566 dynamodb list-tables
  
- name: terraform-step
  image: hashicorp/terraform:light
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_ACCESS_KEY_ID 
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_SECRET_ACCESS_KEY
    AWS_DEFAULT_REGION: us-east-1
  commands:
  - sh init.sh
  - terraform plan
  - terraform apply -auto-approve
  volumes:
  - name: cache
    path: /tmp
    
- name: post-list-tables
  image: ruanbekker/awscli
  environment:
    AWS_ACCESS_KEY_ID: 123
    AWS_SECRET_ACCESS_KEY: xyz
    AWS_DEFAULT_REGION: eu-west-1
  commands:
  - aws --endpoint-url=http://localstack:4566 dynamodb list-tables
  
volumes:
- name: cache
  temp: {}
- name: localstack-vol
  host:
    path: /tmp/localstack-vol

services:
  - name: localstack
    image: localstack/localstack:0.12.17
    environment:
      DOCKER_HOST: unix:///var/run/docker.sock
      EDGE_PORT: 4566
    volumes:
      - name: docker-socket
        path: /var/run/docker.sock
      - name: localstack-vol
        path: /tmp/localstack
</code></pre>

                <h3>Key Components and Configuration</h3>
                <h4>LocalStack Service</h4>
                <p>The <code>localstack</code> service is defined to run alongside the pipeline steps. It uses the <code>localstack/localstack</code> Docker image and exposes the necessary ports. The <code>DOCKER_HOST</code> environment variable is crucial for LocalStack to interact with the Docker daemon.</p>

                <h4>AWS CLI Steps</h4>
                <p>Several steps utilize the <code>ruanbekker/awscli</code> image to interact with LocalStack. These steps include:</p>
                <ul>
                    <li><code>wait-for-localstack</code>: Polls LocalStack to ensure it's ready before proceeding.</li>
                    <li><code>pre-list-tables</code>: Lists DynamoDB tables before Terraform applies changes.</li>
                    <li><code>post-list-tables</code>: Lists DynamoDB tables after Terraform applies changes to verify the deployment.</li>
                </ul>
                <p>These steps use dummy AWS credentials and specify the <code>AWS_DEFAULT_REGION</code>, pointing the AWS CLI to the LocalStack endpoint via <code>--endpoint-url=http://localstack:4566</code>.</p>

                <h4>Terraform Execution</h4>
                <p>The <code>terraform-step</code> uses the official <code>hashicorp/terraform:light</code> image. It executes <code>init.sh</code> (assumed to contain initialization scripts), runs <code>terraform plan</code>, and then <code>terraform apply -auto-approve</code>. The AWS credentials are sourced from secrets, and the default region is set to <code>us-east-1</code>. A volume named <code>cache</code> is mounted at <code>/tmp</code> for Terraform's state and cache management.</p>

                <h3>Volumes and Secrets</h3>
                <p>The pipeline utilizes several volumes:</p>
                <ul>
                    <li><code>cache</code>: A temporary volume for Terraform operations.</li>
                    <li><code>localstack-vol</code>: A host-mounted volume for persistent LocalStack data (though in this example, it's mounted to <code>/tmp/localstack</code> within the service).</li>
                    <li><code>docker-socket</code>: A volume to provide access to the Docker socket for the LocalStack service.</li>
                </ul>
                <p>AWS credentials (<code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code>) are expected to be provided as secrets in the Drone CI environment.</p>

                <h3>Benefits of this Setup</h3>
                <ul>
                    <li><strong>Local Development & Testing:</strong> Run Terraform against a local, mocked AWS environment, reducing costs and improving speed.</li>
                    <li><strong>CI/CD Integration:</strong> Seamlessly integrate infrastructure provisioning into your CI/CD workflows.</li>
                    <li><strong>Reproducibility:</strong> Ensure consistent infrastructure deployments across different environments.</li>
                </ul>

                <h3>Further Enhancements</h3>
                <p>Consider adding more comprehensive checks, such as verifying specific AWS resources created by Terraform, or integrating with other AWS services supported by LocalStack.</p>
                <p>For more information on Drone CI, refer to the <a href="https://docs.drone.io/pipeline/docker/syntax/" target="_blank">Drone CI Docker Pipeline Syntax</a>. For LocalStack documentation, visit <a href="https://docs.localstack.cloud/" target="_blank">LocalStack Documentation</a>.</p>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>