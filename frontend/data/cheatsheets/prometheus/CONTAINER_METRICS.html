<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container Metrics - Prometheus & cAdvisor Examples</title>
    <meta name="description" content="Explore Prometheus queries and Grafana variables for container metrics, leveraging cAdvisor data for ECS clusters. Monitor CPU, memory, and network usage effectively.">
    <meta name="keywords" content="Prometheus, cAdvisor, container metrics, ECS, Grafana, CPU usage, memory usage, network traffic, monitoring, observability, Docker metrics, Kubernetes metrics">
    <link rel="canonical" href="https://your-domain.com/prometheus/CONTAINER_METRICS.html">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Container Metrics - Prometheus & cAdvisor Examples">
    <meta property="og:description" content="Explore Prometheus queries and Grafana variables for container metrics, leveraging cAdvisor data for ECS clusters. Monitor CPU, memory, and network usage effectively.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-domain.com/prometheus/CONTAINER_METRICS.html">
    <meta property="og:image" content="https://your-domain.com/path/to/your/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Container Metrics - Prometheus & cAdvisor Examples">
    <meta name="twitter:description" content="Explore Prometheus queries and Grafana variables for container metrics, leveraging cAdvisor data for ECS clusters. Monitor CPU, memory, and network usage effectively.">
    <meta name="twitter:image" content="https://your-domain.com/path/to/your/twitter-image.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Container Metrics</h1>
        </div>
        <div class="content">
            <div class="markdown-content">
                <h2>Prometheus Container Metrics with cAdvisor</h2>
                <p>This guide provides examples for Prometheus focused on Container Level Metrics, scraped from cAdvisor. It details the setup requirements, Grafana variables, and example Prometheus queries for monitoring container performance within an ECS Cluster.</p>

                <h2>Setup Requirements</h2>
                <p>To effectively monitor container metrics using Prometheus and cAdvisor, ensure your ECS Cluster is configured with the following:</p>
                <ol>
                    <li><strong>cAdvisor Deployment:</strong> cAdvisor should be running on the cluster. Refer to this <a href="https://github.com/ruanbekker/cheatsheets/blob/master/ecs/task-definitions/cadvisor_taskdef.json">cadvisor_taskdef.json</a> for task definition examples.</li>
                    <li><strong>Prometheus Scrape Configuration:</strong> Configure your Prometheus scrape job to collect metrics from cAdvisor. An example configuration is provided below:</li>
                </ol>
                <pre><code class="language-yaml">
  # cadvisor
  - job_name: container-metrics
    scrape_interval: 15s
    ec2_sd_configs:
    - region: eu-west-1
      role_arn: 'arn:aws:iam::xxxxxxxxxxxx:role/prometheus-ec2-role'
      port: 9100
      filters:
        - name: tag:PrometheusContainerScrape
          values:
            - Enabled
    relabel_configs:
    - source_labels: [__meta_ec2_private_ip]
      replacement: '${1}:8080'
      target_label: __address__
    - source_labels: [__meta_ec2_tag_Name]
      target_label: instance
    - source_labels: [__meta_ec2_tag_ECSClusterName]
      target_label: cluster_name
                </code></pre>

                <h2>Grafana Variables for Dynamic Dashboards</h2>
                <p>Enhance your Grafana dashboards with dynamic variables for easier data exploration and filtering.</p>
                <h3>Interval Variable</h3>
                <p>Allows users to select the time interval for graphs and queries.</p>
                <pre><code class="language-json">
Name: interval
Label: Interval
Type: interval
Values: 1m,10m,30m,1h,6h,12h,1d,7d,14d,30d
                </code></pre>

                <h3>ECS Cluster Name Variable</h3>
                <p>Filter metrics by a specific ECS cluster.</p>
                <pre><code class="language-json">
Name: cluster_name
Label: ECS Cluster
Type: Query
Values: label_values(cadvisor_version_info,  cluster_name)
                </code></pre>

                <h3>Service Name Variable</h3>
                <p>Filter metrics by a specific service name within an ECS cluster.</p>
                <pre><code class="language-json">
Name: service_name
Label: Service Name
Type: Query
Values: label_values(container_cpu_load_average_10s{cluster_name=~&quot;$cluster_name&quot;}, container_label_com_amazonaws_ecs_container_name)
                </code></pre>

                <h2>Example Prometheus Queries for Container Monitoring</h2>
                <p>These queries are designed for use in Grafana panels to visualize and analyze container performance.</p>

                <h3>CPU Metrics</h3>
                <h4>Container CPU Utilization (Graph)</h4>
                <p>Displays the rate of CPU time consumed by each container.</p>
                <pre><code class="language-promql">
sum(rate(container_cpu_usage_seconds_total{name=~&quot;.+&quot;, cluster_name=~&quot;$cluster_name&quot;, container_label_com_amazonaws_ecs_container_name=~&quot;$service_name&quot;}[$interval])) by (name, container_label_com_amazonaws_ecs_container_name, container_label_com_amazonaws_ecs_cluster) * 100
                </code></pre>

                <h4>Aggregated CPU Utilization by Service (Gauge)</h4>
                <p>Shows the total CPU utilization for each service.</p>
                <pre><code class="language-promql">
sum(sum(rate(container_cpu_usage_seconds_total{name=~&quot;.+&quot;, cluster_name=~&quot;$cluster_name&quot;, container_label_com_amazonaws_ecs_container_name=~&quot;$service_name&quot;}[$interval])) by ( container_label_com_amazonaws_ecs_container_name) * 100)
                </code></pre>

                <h3>Memory Metrics</h3>
                <h4>Container Memory Usage (RSS) (Graph)</h4>
                <p>Visualizes the Resident Set Size (RSS) memory used by each container.</p>
                <pre><code class="language-promql">
sum(container_memory_rss{cluster_name=~&quot;$cluster_name&quot;, container_label_com_amazonaws_ecs_container_name=~&quot;$service_name&quot;}) by (name, container_label_com_amazonaws_ecs_container_name, container_label_com_amazonaws_ecs_cluster)
                </code></pre>

                <h4>Aggregated Memory Usage by Service (Gauge)</h4>
                <p>Displays the total memory usage for each service.</p>
                <pre><code class="language-promql">
sum(sum(container_memory_rss{name=~&quot;.+&quot;, cluster_name=~&quot;$cluster_name&quot;, container_label_com_amazonaws_ecs_container_name=~&quot;$service_name&quot;}) by (name, container_label_com_amazonaws_ecs_container_name, container_label_com_amazonaws_ecs_cluster))
                </code></pre>

                <h4>Memory Utilization Percentage</h4>
                <p>Calculates the percentage of memory used relative to the container's limit.</p>
                <pre><code class="language-promql">
avg((avg (container_memory_working_set_bytes{name=~&quot;.+&quot;}) by (name, instance ))/ on (name, instance)(avg (container_spec_memory_limit_bytes&gt;0 ) by (name, instance))*100)
                </code></pre>

                <h4>Memory Limits</h4>
                <p>Shows the configured memory limits for containers.</p>
                <pre><code class="language-promql">
container_spec_memory_limit_bytes{container_label_com_docker_compose_service=~&quot;$service_name&quot;, instance=~&quot;$host&quot;}
                </code></pre>

                <h3>Network Metrics</h3>
                <h4>Incoming Network Traffic per Container (Graph)</h4>
                <p>Monitors the rate of incoming network data for each container.</p>
                <pre><code class="language-promql">
sum(rate(container_network_receive_bytes_total{cluster_name=~&quot;$cluster_name&quot;, container_label_com_amazonaws_ecs_container_name=~&quot;$service_name&quot;}[$interval])) by (name, container_label_com_amazonaws_ecs_container_name, container_label_com_amazonaws_ecs_cluster)
                </code></pre>

                <h4>Outgoing Network Traffic per Container (Graph)</h4>
                <p>Monitors the rate of outgoing network data for each container.</p>
                <pre><code class="language-promql">
sum(rate(container_network_transmit_bytes_total{cluster_name=~&quot;$cluster_name&quot;, container_label_com_amazonaws_ecs_container_name=~&quot;$service_name&quot;}[$interval])) by (name, container_label_com_amazonaws_ecs_container_name, container_label_com_amazonaws_ecs_cluster)
                </code></pre>

                <h4>Combined Network Traffic with Direction Inversion</h4>
                <p>A common Grafana panel configuration to display both incoming and outgoing traffic, with outgoing traffic inverted for clarity.</p>
                <p><strong>Incoming:</strong></p>
                <pre><code class="language-text">
Legend =&gt; down: {{name}}
                </code></pre>
                <p><strong>Outgoing:</strong></p>
                <pre><code class="language-text">
Legend =&gt; up: {{name}}
                </code></pre>
                <p><strong>Series Overrides:</strong></p>
                <pre><code class="language-text">
Alias or regex =&gt; /.*up.*/
Transform =&gt; negative-y
                </code></pre>

                <h4>Aggregated Incoming Network Traffic by Service (Gauge)</h4>
                <p>Shows the total incoming network traffic for each service.</p>
                <pre><code class="language-promql">
sum(sum(rate(container_network_receive_bytes_total{cluster_name=~&quot;$cluster_name&quot;, container_label_com_amazonaws_ecs_container_name=~&quot;$service_name&quot;}[$interval])) by (name, container_label_com_amazonaws_ecs_container_name, container_label_com_amazonaws_ecs_cluster))
                </code></pre>

                <h4>Aggregated Outgoing Network Traffic by Service (Gauge)</h4>
                <p>Shows the total outgoing network traffic for each service.</p>
                <pre><code class="language-promql">
sum(sum(rate(container_network_transmit_bytes_total{cluster_name=~&quot;$cluster_name&quot;, container_label_com_amazonaws_ecs_container_name=~&quot;$service_name&quot;}[$interval])) by (name, container_label_com_amazonaws_ecs_container_name, container_label_com_amazonaws_ecs_cluster))
                </code></pre>

                <h2>External Resources</h2>
                <ul>
                    <li><a href="https://prometheus.io/docs/guides/ec2-sd/">Prometheus EC2 Service Discovery</a></li>
                    <li><a href="https://github.com/google/cadvisor">cAdvisor GitHub Repository</a></li>
                    <li><a href="https://grafana.com/docs/grafana/latest/variables/">Grafana Variables Documentation</a></li>
                    <li><a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#rate">Prometheus Rate Function</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>