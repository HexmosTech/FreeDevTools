<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promtail Drop Loglines - Filter Logs with Promtail</title>
    <meta name="description" content="Learn how to drop loglines in Promtail using various configurations. Filter out old, long, or specific noisy logs to optimize your Loki logging.">
    <meta name="keywords" content="promtail, loki, log filtering, drop logs, loglines, log management, pipeline stages, log configuration, nginx logs, health check logs">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://yourdomain.com/loki/drop-loglines-promtail.html">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourdomain.com/loki/drop-loglines-promtail.html">
    <meta property="og:title" content="Promtail Drop Loglines - Filter Logs with Promtail">
    <meta property="og:description" content="Learn how to drop loglines in Promtail using various configurations. Filter out old, long, or specific noisy logs to optimize your Loki logging.">
    <meta property="og:image" content="https://yourdomain.com/path/to/your/og-image.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://yourdomain.com/loki/drop-loglines-promtail.html">
    <meta name="twitter:title" content="Promtail Drop Loglines - Filter Logs with Promtail">
    <meta name="twitter:description" content="Learn how to drop loglines in Promtail using various configurations. Filter out old, long, or specific noisy logs to optimize your Loki logging.">
    <meta name="twitter:image" content="https://yourdomain.com/path/to/your/twitter-image.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Promtail Drop Loglines Configuration</h1>
        </div>
        <div class="content">
            <div class="markdown-content">
                <p>This document provides a configuration example for Promtail, focusing on how to drop specific loglines to optimize data ingestion into Loki. By strategically filtering logs, you can reduce noise, save storage, and improve query performance.</p>

                <h2>Promtail Configuration for Dropping Loglines</h2>
                <p>The following YAML configuration demonstrates various methods to drop log entries based on different criteria. This includes dropping logs based on their content, age, and length, as well as specific patterns like health checks or noisy error messages.</p>

                <pre><code class="language-yaml">server:
  http_listen_port: 9080
  grpc_listen_port: 0
positions:
  filename: /var/lib/promtail/positions.yaml
clients:
  - url: https://&lt;LOKI_USERNAME&gt;:&lt;LOKI_PASSWORD&gt;@&lt;LOKI_FQDN&gt;/loki/api/v1/push

scrape_configs:
  - job_name: nginx-info
    static_configs:
    - targets:
        - localhost
      labels:
        job: prod/nginx
        environment: production
        host: demo-app-prod
        level: info
        service_name: demo-app-prod
        __path__: /var/log/nginx/access.log

    pipeline_stages:
    # Drop loglines matching specific URL patterns (e.g., health checks)
    # https://grafana.com/docs/loki/latest/clients/promtail/stages/drop/
    - drop:
        expression: "(.*/health-check.*)|(.*/health.*)"
    # Drop loglines older than 24 hours to reduce historical data ingestion
    - drop:
        older_than: 24h
        drop_counter_reason: "line_too_old"
    # Drop loglines that exceed a certain length to prevent oversized entries
    - drop:
        longer_than: 8kb
        drop_counter_reason: "line_too_long"
    # Drop logs containing specific "noisy" keywords using a match stage
    # https://grafana.com/docs/loki/latest/clients/promtail/stages/match/
    - match:
        selector: '{app="promtail"} |~ ".*noisy error.*"'
        action: drop
        drop_counter_reason: promtail_noisy_error
    # Drop logs from specific Loki components or applications
    - match:
        selector: '{app="loki", component="gateway"}'
        action: drop
        drop_counter_reason: loki_gateway_logs
    # Drop informational logs from Loki queriers to reduce verbosity
    - match:
        selector: '{app="loki", component="querier"} |= "level=info"'
        action: drop
        drop_counter_reason: loki_querier_info_logs
    # Example: Drop ELB health checker logs specifically for the nginx job
    # https://github.com/cyriltovena/loki/blob/master/docs/clients/promtail/stages/match.md#example
    - match:
        pipeline_name: 'drop_elb_healthchecks'
        selector: '{job="prod/nginx"} |= "ELB-HealthChecker"'
        action: drop
</code></pre>

                <h2>Understanding Promtail Drop Stages</h2>
                <p>Promtail's pipeline stages offer powerful ways to process logs before they are sent to Loki. The <code>drop</code> stage allows you to remove log lines based on regular expressions, age, or length. The <code>match</code> stage, when used with the <code>action: drop</code>, provides more granular control by allowing you to drop logs based on label selectors and content matching.</p>

                <h3>Key Drop Configurations Explained:</h3>
                <ul>
                    <li><strong>Dropping by Expression:</strong> Use regular expressions to filter out logs with specific patterns, such as health check endpoints.</li>
                    <li><strong>Dropping by Age:</strong> The <code>older_than</code> parameter helps discard logs that are no longer relevant, saving storage space.</li>
                    <li><strong>Dropping by Length:</strong> The <code>longer_than</code> parameter prevents excessively large log entries from being ingested.</li>
                    <li><strong>Dropping by Content Match:</strong> The <code>match</code> stage with a content selector (e.g., <code>|~ ".*noisy error.*"</code>) is effective for removing specific, unwanted messages.</li>
                    <li><strong>Dropping by Labels:</strong> Filter logs based on their associated labels, useful for excluding logs from certain components or environments.</li>
                </ul>

                <h2>Optimizing Log Ingestion with Promtail</h2>
                <p>Implementing effective log dropping strategies is crucial for maintaining an efficient and cost-effective logging infrastructure with Loki. By carefully configuring Promtail, you can ensure that only valuable log data is stored and analyzed, leading to faster insights and reduced operational overhead.</p>

                <p>For more advanced filtering and processing, explore other Promtail pipeline stages such as <code>regex</code>, <code>template</code>, and <code>labels</code>.</p>

                <h3>Further Resources:</h3>
                <ul>
                    <li><a href="https://grafana.com/docs/loki/latest/clients/promtail/configuration/" target="_blank" rel="noopener noreferrer">Promtail Official Documentation</a></li>
                    <li><a href="https://grafana.com/docs/loki/latest/configuration/" target="_blank" rel="noopener noreferrer">Loki Configuration Guide</a></li>
                    <li><a href="https://grafana.com/docs/loki/latest/clients/promtail/stages/" target="_blank" rel="noopener noreferrer">Promtail Pipeline Stages</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>