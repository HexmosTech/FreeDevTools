<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promtail Configuration Examples & Pipelines - Loki Documentation</title>
    <meta name="description" content="Explore Promtail configuration examples and pipeline stages for Loki. Learn how to transform, drop, and parse logs effectively with Promtail.">
    <meta name="keywords" content="promtail, loki, log aggregation, log pipelines, log transformation, log parsing, grafana, log management, configuration examples, drop logs, json parsing, docker logs">
    <link rel="canonical" href="https://your-website.com/loki/promtail.html">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-website.com/loki/promtail.html">
    <meta property="og:title" content="Promtail Configuration Examples & Pipelines - Loki Documentation">
    <meta property="og:description" content="Explore Promtail configuration examples and pipeline stages for Loki. Learn how to transform, drop, and parse logs effectively with Promtail.">
    <meta property="og:image" content="https://your-website.com/path/to/your/og-image.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://your-website.com/loki/promtail.html">
    <meta name="twitter:title" content="Promtail Configuration Examples & Pipelines - Loki Documentation">
    <meta name="twitter:description" content="Explore Promtail configuration examples and pipeline stages for Loki. Learn how to transform, drop, and parse logs effectively with Promtail.">
    <meta name="twitter:image" content="https://your-website.com/path/to/your/twitter-image.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .content {
            padding: 20px;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
        }
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .markdown-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            overflow-x: auto;
        }
        .markdown-content code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Promtail Configuration Examples & Pipelines</h1>
        </div>
        <div class="content">
            <div class="markdown-content">
                <p>This page provides examples and explanations for configuring Promtail, a log collection agent for Loki. It covers various scenarios including log parsing, transformation, and filtering.</p>

                <h2>Promtail Configuration Examples</h2>
                <p>Here are some useful examples and resources for setting up and configuring Promtail:</p>
                <ul>
                    <li><a href="https://gist.github.com/ruanbekker/c6fa9bc6882e6f324b4319c5e3622460" target="_blank" rel="noopener noreferrer">Promtail Gist Examples</a></li>
                    <li><a href="https://sbcode.net/grafana/install-promtail-service/" target="_blank" rel="noopener noreferrer">Install Promtail as a Service</a></li>
                    <li><a href="https://www.bookstack.cn/read/loki/clients-promtail-pipelines.md" target="_blank" rel="noopener noreferrer">Promtail Pipelines Documentation</a></li>
                    <li><a href="https://github.com/grafana/loki/issues/333#issuecomment-570651075" target="_blank" rel="noopener noreferrer">Parsing Labels from Log Tag</a></li>
                    <li><a href="https://docs.docker.com/config/containers/logging/configure/" target="_blank" rel="noopener noreferrer">Docker Logging Configuration</a></li>
                    <li><a href="https://github.com/grafana/loki/issues/775#issuecomment-568814165" target="_blank" rel="noopener noreferrer">Create Labels from Filename</a></li>
                    <li><a href="https://www.gitmemory.com/issue/grafana/loki/748/534945463" target="_blank" rel="noopener noreferrer">Drop Logs Based on Content</a></li>
                    <li><a href="https://github.com/cyriltovena/loki/blob/master/docs/clients/promtail/stages/match.md#example" target="_blank" rel="noopener noreferrer">Drop Logs with Match Stage</a></li>
                    <li><a href="https://www.youtube.com/watch?v=bIAC0uQee0k" target="_blank" rel="noopener noreferrer">Using Promtail with Loki (YouTube)</a></li>
                    <li><a href="https://grafana.com/docs/loki/latest/clients/promtail/scraping/" target="_blank" rel="noopener noreferrer">Promtail Scraping Documentation</a></li>
                    <li><a href="https://grafana.com/blog/2020/07/13/loki-tutorial-how-to-set-up-promtail-on-aws-ec2-to-find-and-analyze-your-logs/" target="_blank" rel="noopener noreferrer">Promtail Setup on AWS EC2</a></li>
                    <li><a href="https://gist.github.com/cspinetta/41db2cc7f03a5af49e1b1cfe68d1fea4" target="_blank" rel="noopener noreferrer">Promtail Pipeline Templating</a></li>
                </ul>

                <h2>Current Promtail Issues</h2>
                <p>Stay updated with ongoing development and known issues:</p>
                <ul>
                    <li><a href="https://github.com/grafana/loki/issues/74" target="_blank" rel="noopener noreferrer">Multi-line Log Handling</a></li>
                    <li><a href="https://github.com/grafana/loki/issues/1880" target="_blank" rel="noopener noreferrer">Malformed Logs with Slashes</a></li>
                </ul>

                <h2>LogQL Query Language</h2>
                <p>Learn how to query your logs effectively using LogQL:</p>
                <ul>
                    <li><a href="https://github.com/grafana/loki/blob/master/docs/logql.md" target="_blank" rel="noopener noreferrer">LogQL Documentation</a></li>
                </ul>

                <h2>Promtail Pipelines Explained</h2>
                <p>Promtail pipelines allow you to process logs before they are sent to Loki. This includes stages for parsing, transforming, and dropping logs.</p>
                <p>More Info:</p>
                <ul>
                    <li><a href="https://github.com/grafana/loki/blob/master/docs/clients/promtail/pipelines.md" target="_blank" rel="noopener noreferrer">Promtail Pipelines Overview</a></li>
                    <li><a href="https://github.com/grafana/loki/blob/master/docs/clients/promtail/stages/template.md" target="_blank" rel="noopener noreferrer">Promtail Template Stage</a></li>
                </ul>

                <h3>Log Transformation with Promtail</h3>
                <blockquote>
                    <p>The pipeline example below takes the current value of <code>level</code> from the extracted map and converts its value to be all lowercase. For example, if the extracted map contained <code>level</code> with a value of <code>INFO</code>, this pipeline would change its value to <code>info</code>.</p>
                </blockquote>
                <p><strong>Pipeline Transform example:</strong> Change uppercase log levels to lowercase (e.g., INFO to info):</p>
                <pre><code class="language-yaml">scrape_configs:
  - job_name: app1
    static_configs:
    - targets:
        - localhost
      labels:
        job: app1
        environment: production
        host: app1.mydomain.com
        service: app1
        __path__: /var/log/app1_*.log
    pipeline_stages:
    - match:
        selector: '{service=&quot;app1&quot;}'
        stages:
        - regex:
            expression: &quot;(?P&lt;level&gt;(INFO|WARNING|ERROR))(.*)&quot;
        - template:
            source: level
            template: '{{ ToLower .Value }}'
        - labels:
            level:
</code></pre>

                <p><strong>Convert stdout to info, stderr to error:</strong></p>
                <pre><code class="language-yaml">  pipeline_stages:
  - regex:
      expression: '(?P&lt;level&gt;(stdout|stderr))'

  - template:
      source: level
      template: '{{ if eq .Value &quot;stdout&quot; }}{{ Replace .Value &quot;stdout&quot; &quot;info&quot; -1 }}{{ else if eq .Value &quot;stderr&quot; }}{{ Replace .Value &quot;stderr&quot; &quot;error&quot; -1 }}{{ .Value }}{{ end }}'
</code></pre>

                <h3>Dropping Logs with Promtail</h3>
                <p>In this scenario, we want to drop specific logs to prevent them from appearing in Loki.</p>
                <p>Reference: <a href="https://github.com/cyriltovena/loki/blob/master/docs/clients/promtail/stages/match.md#example" target="_blank" rel="noopener noreferrer">Drop Logs with Match Stage</a></p>
                <pre><code class="language-yaml">- job_name: qa/docker
  entry_parser: raw
  static_configs:
  - targets:
      - localhost
    labels:
      job: preprod/docker
      service: app1
      __path__: /var/lib/docker/containers/*/*-json.log

scrape_configs:
  pipeline_stages:
  - match:
      pipeline_name: 'drop_elb_healthchecks'
      selector: '{service=&quot;app1&quot;} |= &quot;ELB-HealthChecker&quot;'
      action: drop

  - match:
      pipeline_name: 'drop_ecs_agent_logs'
      selector: '{service=&quot;app1&quot;} |~ &quot;.*(Managed task|Task engine).*&quot; |~ &quot;arn:aws:ecs:eu-west-1:000000000000:task&quot;'
      #selector: '{service=&quot;app1&quot;} |~ &quot;.*Managed task.*&quot; |= &quot;eu-west-1:000000000000:task&quot;'
      action: drop

  - match:
      pipeline_name: 'drop_blackbox_exporter_checks'
      selector: '{service=&quot;app1&quot;} |~ &quot;.*Go-http-client.*&quot; |= &quot;GET /login&quot;'
      action: drop
</code></pre>

                <h3>Docker Log Opt Tag Parsing</h3>
                <p>This configuration demonstrates how to parse the Docker log <code>--log-opt tag</code> to extract container and image information.</p>
                <pre><code class="language-yaml">scrape_configs:

- job_name: system
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs
      __path__: /var/log/*log

- job_name: containers
  entry_parser: raw

  static_configs:
  - targets:
      - localhost
    labels:
      job: containerlogs
      __path__: /var/lib/docker/containers/*/*log

  # --log-opt tag=&quot;{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}&quot;
  pipeline_stages:

  - json:
      expressions:
        stream: stream
        attrs: attrs
        tag: attrs.tag

  - regex:
      expression: (?P&lt;image_name&gt;(?:[^|]*[^|])).(?P&lt;container_name&gt;(?:[^|]*[^|])).(?P&lt;image_id&gt;(?:[^|]*[^|])).(?P&lt;container_id&gt;(?:[^|]*[^|]))
      source: &quot;tag&quot;

  - labels:
      tag:
      stream:
      image_name:
      container_name:
      image_id:
      container_id:
</code></pre>

                <h3>Containers with File Service Discovery Workaround</h3>
                <p>This workaround uses file-based service discovery to manage Promtail targets for Docker containers.</p>
                <p>Generated target file example (run via `docker ps --format`):</p>
                <pre><code class="language-bash">docker ps --format '- targets: [&quot;{{.ID}}&quot;]
  labels:
    container_name: &quot;{{.Names}}&quot;' &gt; /etc/promtail/promtail-targets.yaml
</code></pre>

                <p>Promtail configuration using <code>file_sd_configs</code>:</p>
                <pre><code class="language-yaml">scrape_configs:
- job_name: containers
  entry_parser: docker
  file_sd_configs:
  - files:
    - /etc/promtail/promtail-targets.yaml
  relabel_configs:
  - source_labels: [__address__]
    target_label: container_id
  - source_labels: [container_id]
    target_label: __path__
    replacement: /var/lib/docker/containers/$1*/*.log
</code></pre>

                <h3>JSON Nested Pipeline for Log Extraction</h3>
                <p>This section demonstrates how to extract nested JSON data, specifically the <code>level</code> key from a log line.</p>
                <p>Example log line:</p>
                <pre><code class="language-json">{"log": {"level": "info", "timestamp":"2023-02-26 21:55:24.702"}}
</code></pre>

                <p>The Promtail configuration to extract the nested <code>level</code>:</p>
                <pre><code class="language-yaml">    pipeline_stages:
      - cri: {}
      - multiline:
          firstline: ^\d{4}-\d{2}-\d{2} \d{1,2}:\d{2}:\d{2},\d{3}
          max_wait_time: 3s
      - json:
          expressions:
            log:
      - json:
          expressions:
            level:
          source: log
      - labels:
          level:
</code></pre>

                <p>Referenced from:</p>
                <ul>
                    <li><a href="https://grafana.com/docs/loki/latest/clients/promtail/stages/json/#using-extracted-data" target="_blank" rel="noopener noreferrer">Promtail JSON Stage Documentation</a></li>
                    <li><a href="https://stackoverflow.com/a/62228397" target="_blank" rel="noopener noreferrer">Remap JSON values and set output source (Stack Overflow)</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
    </script>
</body>
</html>